/*****************************************************************************
** Copyright DATASUL S.A. (1994)
** Todos os Direitos Reservados.
** 
** Este fonte e de propriedade exclusiva da DATASUL, sua reproducao
** parcial ou total por qualquer meio, so' podera ser feita mediante
** autorizacao expressa.
**
** Programa..............: fnc_bem_pat_desmembramento
** Descricao.............: Desmembramento de Bens
** Versao................:  1.00.02.139
** Procedimento..........: tar_desmembramento_bem_pat
** Nome Externo..........: prgfin/fas/fas703za.p
** Data Geracao..........: 16/08/2019 - 12:55:05
** Criado por............: Muller
** Criado em.............: // 
** Alterado por..........: fut41422
** Alterado em...........: 16/08/2019 10:07:47
** Gerado por............: fut41422
*****************************************************************************/

/*-- Filtro Multi-idioma Aplicado --*/


{include/i_dbinst.i}
{include/i_dbtype.i}

{include/i_fcldef.i}
{include/i_trddef.i}

{include/i-license-manager.i fnc_bem_pat_desmembramento FAS}


/********************* Temporary Table Definition Begin *********************/

def temp-table tt_acerto_val_bem_pis_cofins no-undo
    field tta_cod_empresa                  as character format "x(3)" label "Empresa" column-label "Empresa"
    field tta_cod_cta_pat                  as character format "x(18)" label "Conta Patrimonial" column-label "Conta Patrimonial"
    field tta_num_bem_pat                  as integer format ">>>>>>>>9" initial 0 label "Bem Patrimonial" column-label "Bem"
    field tta_num_seq_bem_pat              as integer format ">>>>9" initial 0 label "Sequància Bem" column-label "Sequància"
    field tta_num_id_bem_pat               as integer format ">>,>>>,>>9" initial 0 label "Identificaá∆o Bem" column-label "Identificaá∆o Bem"
    field tta_val_cr_pis                   as decimal format ">>>,>>>,>>9.99" decimals 2 initial 0 label "Valor Cred PIS/PASEP" column-label "Vl Cred PIS/PASEP"
    field tta_val_cr_cofins                as decimal format ">>>,>>>,>>9.99" decimals 2 initial 0 label "Valor CrÇdito COFINS" column-label "Credito COFINS"
    field ttv_val_calc_parc_pis            as decimal format "->>,>>>,>>>,>>9.99" decimals 2
    field ttv_val_calc_parc_cofins         as decimal format "->>,>>>,>>>,>>9.99" decimals 2
    field ttv_val_calc_parc_cofins_bxa     as decimal format "->>,>>>,>>>,>>9.99" decimals 2
    field ttv_val_calc_parc_pis_bxa        as decimal format "->>,>>>,>>>,>>9.99" decimals 2
    field ttv_num_order                    as integer format ">>>>,>>9" label "Ordem" column-label "Ordem"
    field ttv_num_percent_desmbrto         as integer format ">>>>,>>9"
    .

def temp-table tt_acerto_val_pis_cofins_incorp no-undo
    field tta_cod_empresa                  as character format "x(3)" label "Empresa" column-label "Empresa"
    field tta_cod_cta_pat                  as character format "x(18)" label "Conta Patrimonial" column-label "Conta Patrimonial"
    field tta_num_bem_pat                  as integer format ">>>>>>>>9" initial 0 label "Bem Patrimonial" column-label "Bem"
    field tta_num_seq_bem_pat              as integer format ">>>>9" initial 0 label "Sequància Bem" column-label "Sequància"
    field tta_num_id_bem_pat               as integer format ">>,>>>,>>9" initial 0 label "Identificaá∆o Bem" column-label "Identificaá∆o Bem"
    field tta_num_seq_incorp_bem_pat       as integer format ">>,>>>>,>>9" initial 0 label "Sequància Incorp" column-label "Sequància Incorp"
    field tta_val_cr_pis                   as decimal format ">>>,>>>,>>9.99" decimals 2 initial 0 label "Valor Cred PIS/PASEP" column-label "Vl Cred PIS/PASEP"
    field tta_val_cr_cofins                as decimal format ">>>,>>>,>>9.99" decimals 2 initial 0 label "Valor CrÇdito COFINS" column-label "Credito COFINS"
    field ttv_val_calc_parc_pis            as decimal format "->>,>>>,>>>,>>9.99" decimals 2
    field ttv_val_calc_parc_cofins         as decimal format "->>,>>>,>>>,>>9.99" decimals 2
    field ttv_val_calc_parc_cofins_bxa     as decimal format "->>,>>>,>>>,>>9.99" decimals 2
    field ttv_val_calc_parc_pis_bxa        as decimal format "->>,>>>,>>>,>>9.99" decimals 2
    field ttv_num_order                    as integer format ">>>>,>>9" label "Ordem" column-label "Ordem"
    field ttv_num_percent_desmbrto         as integer format ">>>>,>>9"
    .

def temp-table tt_acum_calc_parc_pis_cofins no-undo
    field tta_num_id_bem_pat               as integer format ">>,>>>,>>9" initial 0 label "Identificaá∆o Bem" column-label "Identificaá∆o Bem"
    field tta_num_seq_incorp_bem_pat       as integer format ">>,>>>>,>>9" initial 0 label "Sequància Incorp" column-label "Sequància Incorp"
    field ttv_val_tot_parc_gerad_cofins    as decimal format "->>,>>>,>>>,>>9.99" decimals 2
    field ttv_val_tot_parc_gerad_pis       as decimal format "->>,>>>,>>>,>>9.99" decimals 2
    field ttv_val_tot_parc_cofins_incorp   as decimal format "->>,>>>,>>>,>>9.99" decimals 2
    field ttv_val_tot_parc_pis_incorp      as decimal format "->>,>>>,>>>,>>9.99" decimals 2
    field ttv_val_sdo_cr_cofins            as decimal format "->>,>>>,>>>,>>9.99" decimals 2 initial 0
    field ttv_val_sdo_cr_pis               as decimal format "->>,>>>,>>>,>>9.99" decimals 2 initial 0
    field ttv_val_sdo_cr_cofins_incorp     as decimal format "->>,>>>,>>>,>>9.99" decimals 2 initial 0
    field ttv_val_sdo_cr_pis_incorp        as decimal format "->>,>>>,>>>,>>9.99" decimals 2 initial 0
    index tt_id                            is primary unique
          tta_num_id_bem_pat               ascending
          tta_num_seq_incorp_bem_pat       ascending
    .

def temp-table tt_acum_val_pis_cofins_incorp no-undo
    field tta_num_seq_incorp_bem_pat       as integer format ">>,>>>>,>>9" initial 0 label "Sequància Incorp" column-label "Sequància Incorp"
    field ttv_val_tot_calc_parc_pis        as decimal format "->>,>>>,>>>,>>9.99" decimals 2
    field ttv_val_tot_calc_parc_cofins     as decimal format "->>,>>>,>>>,>>9.99" decimals 2
    field ttv_val_tot_grav_pis             as decimal format "->>,>>>,>>>,>>9.99" decimals 2
    field ttv_val_tot_grav_cofins          as decimal format "->>,>>>,>>>,>>9.99" decimals 2
    field ttv_val_tot_pis_aux              as decimal format "->>,>>>,>>>,>>9.99" decimals 2
    field ttv_val_tot_cofins_aux           as decimal format "->>,>>>,>>>,>>9.99" decimals 2
    field ttv_val_tot_bxa_real_pis         as decimal format "->>,>>>,>>>,>>9.99" decimals 2
    field ttv_val_tot_bxa_real_cofins      as decimal format "->>,>>>,>>>,>>9.99" decimals 2
    .

def temp-table tt_bem_pat_cong no-undo
    field tta_num_id_bem_pat               as integer format ">>,>>>,>>9" initial 0 label "Identificaá∆o Bem" column-label "Identificaá∆o Bem"
    field tta_cod_grp_calc                 as character format "x(6)" label "Grupo C†lculo" column-label "Grupo C†lculo"
    field tta_num_lote_ctbl                as integer format ">>>,>>>,>>9" initial 1 label "Lote Cont†bil" column-label "Lote Cont†bil"
    field tta_cod_cta_pat                  as character format "x(18)" label "Conta Patrimonial" column-label "Conta Patrimonial"
    field ttv_dat_movto                    as date format "99/99/9999" label "Data Movimento" column-label "Data Movimento"
    field tta_cod_cenar_ctbl               as character format "x(8)" label "Cen†rio Cont†bil" column-label "Cen†rio Cont†bil"
    field ttv_ind_tip_param                as character format "X(08)"
    .

def temp-table tt_calc_parc_pis_cofins no-undo
    field tta_num_id_calc_parc             as integer format "9999999999" initial 0 label "Id Calculo Parcela" column-label "Id Calculo Parcela"
    index tt_id                            is primary unique
          tta_num_id_calc_parc             ascending
    .

def temp-table tt_converter_finalid_econ no-undo
    field tta_cod_finalid_econ             as character format "x(10)" label "Finalidade" column-label "Finalidade"
    field tta_cod_indic_econ               as character format "x(8)" label "Moeda" column-label "Moeda"
    field tta_dat_cotac_indic_econ         as date format "99/99/9999" initial ? label "Data Cotaá∆o" column-label "Data Cotaá∆o"
    field tta_val_cotac_indic_econ         as decimal format ">>>>,>>9.9999999999" decimals 10 initial 0 label "Cotaá∆o" column-label "Cotaá∆o"
    field tta_val_cotac_tax_juros          as decimal format ">>>>,>>9.9999999999" decimals 10 initial 0 label "Cotac Taxa Juros" column-label "Cotac Taxa Juros"
    field tta_val_prev_cotac_fasb          as decimal format ">>>>,>>9.9999999999" decimals 10 initial 0 label "Cotac Previs Fasb" column-label "Cotac Previs Fasb"
    field tta_val_cotac_cm_emis            as decimal format ">>>>,>>9.9999999999" decimals 10 initial 0 label "Cotac Cm Emiss" column-label "Cotac Cm Emiss"
    field tta_val_cotac_cm_vencto          as decimal format ">>>>,>>9.9999999999" decimals 10 initial 0 label "Cotac Cm Vencto" column-label "Cotac Cm Vencto"
    field tta_val_cotac_cm_pagto           as decimal format ">>>>,>>9.9999999999" decimals 10 initial 0 label "Cotac Cm Pagto" column-label "Cotac CM Pagto"
    field tta_val_transacao                as decimal format "->>,>>>,>>>,>>9.99" decimals 2 initial 0 label "Transaá∆o" column-label "Transaá∆o"
    field tta_val_variac_cambial           as decimal format "->>>,>>>,>>9.99" decimals 2 initial 0 label "Vl Varic Cambial" column-label "Variac Cambial"
    field tta_val_acerto_cmcac             as decimal format "->>>,>>>,>>9.99" decimals 2 initial 0 label "Vl Acerto CMCAC" column-label "Vl Acerto CMCAC"
    field tta_val_fatorf                   as decimal format "->999.9999999999" decimals 10 initial 0 label "Fator F" column-label "Fator F"
    field tta_val_fatorx                   as decimal format "->999.9999999999" decimals 10 initial 0 label "Fator X" column-label "Fator X"
    field tta_val_fatory                   as decimal format "->999.9999999999" decimals 10 initial 0 label "Fator Y" column-label "Fator Y"
    field tta_val_ganho_perda_cm           as decimal format "->>>,>>>,>>9.99" decimals 2 initial 0 label "G/P CM" column-label "G/P CM"
    field tta_val_ganho_perda_projec       as decimal format "->>>,>>>,>>9.99" decimals 2 initial 0 label "G/P Projeá∆o" column-label "G/P Projeá∆o"
    field tta_ind_forma_conver             as character format "X(10)" initial "Direta" label "Forma Convers∆o" column-label "Forma Convers∆o"
    field ttv_val_multa                    as decimal format "->>>,>>>,>>9.99" decimals 2 label "Vl Multa" column-label "Vl Multa"
    field ttv_val_desc                     as decimal format "->>>,>>>,>>9.99" decimals 2 label "Vl Desc" column-label "Vl Desc"
    field ttv_val_juros                    as decimal format "->>>,>>>,>>9.99" decimals 2 label "Valor Juros" column-label "Valor Juros"
    field ttv_val_abat                     as decimal format "->>>,>>>,>>9.99" decimals 2 initial 0 label "Valor Abatimento" column-label "Valor Abatimento"
    field ttv_val_cm                       as decimal format "->>>>>,>>>,>>9.99" decimals 4 initial 0 label "Correá∆o Monet†ria" column-label "Correá∆o Monet†ria"
    field tta_val_despes_bcia              as decimal format "->>>,>>>,>>9.99" decimals 2 initial 0 label "Vl Desp Banc" column-label "Vl Desp Banc"
    .

def new global shared temp-table tt_desmembramento no-undo
    field tta_num_seq_incorp_bem_pat       as integer format ">>,>>>>,>>9" initial 0 label "Sequància Incorp" column-label "Sequància Incorp"
    field ttv_val_custo                    as decimal format "->>>>>,>>>,>>9.99" decimals 2
    field ttv_val_dpr_cust_atrib           as decimal format "->>,>>>,>>>,>>9.99" decimals 2
    field ttv_val_perc_bxado               as decimal format "->>,>>>,>>>,>>9.9999999" decimals 7
    index tt_id                           
          tta_num_seq_incorp_bem_pat       ascending
    .

def new shared temp-table tt_desmembrto_bem_pat        
    field tta_num_id_bem_pat               as integer format ">>,>>>,>>9" initial 0 label "Identificaá∆o Bem" column-label "Identificaá∆o Bem"
    field tta_cod_empresa                  as character format "x(3)" label "Empresa" column-label "Empresa"
    field tta_cod_cta_pat                  as character format "x(18)" label "Conta Patrimonial" column-label "Conta Patrimonial"
    field tta_num_bem_pat                  as integer format ">>>>>>>>9" initial 0 label "Bem Patrimonial" column-label "Bem"
    field tta_num_seq_bem_pat              as integer format ">>>>9" initial 0 label "Sequància Bem" column-label "Sequància"
    field tta_des_bem_pat                  as character format "x(40)" label "Descriá∆o Bem Pat" column-label "Descriá∆o Bem Pat"
    field tta_val_original                 as decimal format "->>>>>,>>>,>>9.99" decimals 4 initial 0 label "Valor Original" column-label "Valor Original"
    field tta_val_perc_movto_bem_pat       as decimal format "->>>>,>>>,>>9.9999999" decimals 7 initial 0 label "Percentual Movimento" column-label "Percentual Movimento"
    field tta_qtd_bem_pat_represen         as decimal format ">>>>>>>>9" initial 1 label "Quantidade Bens Representados" column-label "Bem Represen"
    field tta_cod_estab                    as character format "x(5)" label "Estabelecimento" column-label "Estab"
    field tta_cod_plano_ccusto             as character format "x(8)" label "Plano Centros Custo" column-label "Plano Centros Custo"
    field tta_cod_ccusto_respons           as Character format "x(20)" label "CCusto Responsab" column-label "CCusto Responsab"
    field tta_cod_unid_negoc               as character format "x(3)" label "Unid Neg¢cio" column-label "Un Neg"
    field ttv_log_busca_orig               as logical format "Sim/N∆o" initial no label "Busca da Origem" column-label "Busca da Origem"
    index tt_desmembrto_bem_pat_id         is primary unique
          tta_cod_empresa                  ascending
          tta_cod_cta_pat                  ascending
          tta_num_bem_pat                  ascending
          tta_num_seq_bem_pat              ascending
    .

def temp-table tt_erros_cenario no-undo
    field tta_cod_modul_dtsul              as character format "x(3)" label "M¢dulo" column-label "M¢dulo"
    field tta_cod_empresa                  as character format "x(3)" label "Empresa" column-label "Empresa"
    field tta_cod_cenar_ctbl               as character format "x(8)" label "Cen†rio Cont†bil" column-label "Cen†rio Cont†bil"
    field ttv_dat_refer_sit                as date format "99/99/9999"
    index tt_id1                           is primary unique
          tta_cod_modul_dtsul              ascending
          tta_cod_empresa                  ascending
          tta_cod_cenar_ctbl               ascending
          ttv_dat_refer_sit                ascending
    .

def temp-table tt_erros_conexao no-undo
    field ttv_cdn_erro                     as Integer format ">>>,>>9"
    field ttv_des_erro                     as character format "x(50)" label "Inconsistància" column-label "Inconsistància"
    .

def temp-table tt_finalid_bem_pat_calculo no-undo
    field ttv_rec_bem_pat                  as recid format ">>>>>>9" initial ?
    field tta_cod_finalid_econ             as character format "x(10)" label "Finalidade" column-label "Finalidade"
    index tt_recid                         is primary unique
          ttv_rec_bem_pat                  ascending
          tta_cod_finalid_econ             ascending
    .

def temp-table tt_incorp_bem_pat_calc_parc no-undo
    field tta_num_id_bem_pat               as integer format ">>,>>>,>>9" initial 0 label "Identificaá∆o Bem" column-label "Identificaá∆o Bem"
    field tta_num_seq_incorp_bem_pat       as integer format ">>,>>>>,>>9" initial 0 label "Sequància Incorp" column-label "Sequància Incorp"
    field tta_num_parc_pis_cofins          as integer format "999" initial 0 label "Nr Parcelas" column-label "Nr Parcelas"
    index tt_id                            is primary
          tta_num_id_bem_pat               ascending
          tta_num_seq_incorp_bem_pat       ascending
    .

def temp-table tt_log_erros no-undo
    field ttv_num_seq                      as integer format ">>>,>>9" label "SeqÅància" column-label "Seq"
    field ttv_num_cod_erro                 as integer format ">>>>,>>9" label "N£mero" column-label "N£mero"
    field ttv_des_erro                     as character format "x(50)" label "Inconsistància" column-label "Inconsistància"
    field ttv_des_ajuda                    as character format "x(50)" label "Ajuda" column-label "Ajuda"
    index tt_id                           
          ttv_num_seq                      ascending
          ttv_num_cod_erro                 ascending
    .

def temp-table tt_log_inconsist no-undo
    field ttv_num_id_bem_pat               as integer format ">>,>>>,>>9" initial 0 label "Ident Bem" column-label "Ident Bem"
    field ttv_cod_cenar_ctbl               as character format "x(8)" label "Cen†rio Cont†bil" column-label "Cen†rio Cont†bil"
    field ttv_cod_finalid_econ             as character format "x(10)" label "Finalidade Econìmica" column-label "Finalidade Econìmica"
    field ttv_cod_cta_pat                  as character format "x(18)" label "Conta Patrimonial" column-label "Conta Patrimonial"
    field ttv_num_bem_pat                  as integer format ">>>>>>>>9" initial 0 label "Bem Patrimonial" column-label "Bem Pat"
    field ttv_num_seq_bem_pat              as integer format ">>>>9" initial 0 label "Sequància Bem" column-label "Sequància"
    field ttv_num_seq_incorp_bem_pat       as integer format ">>>>,>>9" initial 0 label "Seq Incorp Bem" column-label "Seq Incorp Bem"
    field ttv_num_erro                     as integer format ">>>>,>>9"
    field ttv_num_seq                      as integer format ">>>,>>9" label "SeqÅància" column-label "Seq"
    field ttv_des_erro_bem_pat             as character format "x(200)"
    index tt_id                            is primary unique
          ttv_num_id_bem_pat               ascending
          ttv_num_seq_incorp_bem_pat       ascending
          ttv_cod_cenar_ctbl               ascending
          ttv_cod_finalid_econ             ascending
          ttv_num_erro                     ascending
          ttv_num_seq                      ascending
    index tt_num                          
          ttv_cod_cenar_ctbl               ascending
          ttv_cod_finalid_econ             ascending
          ttv_cod_cta_pat                  ascending
          ttv_num_bem_pat                  ascending
          ttv_num_seq_bem_pat              ascending
          ttv_num_seq_incorp_bem_pat       ascending
    .

def temp-table tt_row_errors no-undo
    field ttv_num_seq_erro                 as integer format ">>>>,>>9" initial 0
    field ttv_num_erro                     as integer format ">>>>,>>9"
    field ttv_des_erro                     as character format "x(50)" label "Inconsistància" column-label "Inconsistància"
    field ttv_des_param                    as character format "x(50)" label "Param" column-label "Param"
    field ttv_des_type                     as character format "x(10)"
    field ttv_des_help                     as character format "x(40)" label "Ajuda" column-label "Ajuda"
    field ttv_des_sub_type                 as character format "x(40)"
    index tt_indice_errors                
          ttv_num_seq_erro                 ascending
    .

def temp-table tt_rpt_consist_bem_pat no-undo like bem_pat
    field ttv_rec_id_bem_pat               as recid format ">>>>>>9"
    .

def temp-table tt_verifica_diferenca_desmem no-undo
    field tta_cod_cenar_ctbl               as character format "x(8)" label "Cen†rio Cont†bil" column-label "Cen†rio Cont†bil"
    field tta_cod_finalid_econ             as character format "x(10)" label "Finalidade" column-label "Finalidade"
    field tta_val_original                 as decimal format "->>>>>,>>>,>>9.99" decimals 4 initial 0 label "Valor Original" column-label "Valor Original"
    field tta_val_dpr_val_origin           as decimal format "->>>>>,>>>,>>9.99" decimals 4 initial 0 label "Dpr Valor Original" column-label "Dpr Valor Original"
    field tta_val_dpr_cm                   as decimal format "->>>>>,>>>,>>9.99" decimals 4 initial 0 label "Dpr Correá∆o Monet" column-label "Dpr Correá∆o Monet"
    field tta_val_dpr_incevda_val_origin   as decimal format "->>>>>,>>>,>>9.99" decimals 4 initial 0 label "Depreciaá∆o Incentiv" column-label "Depreciaá∆o Incentiv"
    field tta_val_dpr_incevda_cm           as decimal format "->>>>>,>>>,>>9.99" decimals 4 initial 0 label "Dpr Incentiv CM" column-label "Dpr Incentiv CM"
    field tta_val_cm_dpr                   as decimal format "->>>>>,>>>,>>9.99" decimals 4 initial 0 label "Correá∆o Monet Dpr" column-label "Correá∆o Monet Dpr"
    field tta_val_cm                       as decimal format "->>>>>,>>>,>>9.99" decimals 4 initial 0 label "Correá∆o Monet†ria" column-label "Correá∆o Monet†ria"
    field tta_val_cm_dpr_incevda           as decimal format "->>>>>,>>>,>>9.99" decimals 4 initial 0 label "CM Dpr Incentivada" column-label "CM Dpr Incentivada"
    field tta_val_dpr_val_origin_amort     as decimal format "->>>>>,>>>,>>9.99" decimals 4 initial 0 label "Amortizaá∆o VO" column-label "Amortizaá∆o VO"
    field tta_val_dpr_cm_amort             as decimal format "->>>>>,>>>,>>9.99" decimals 4 initial 0 label "Amortizaá∆o CM" column-label "Amortizaá∆o CM"
    field tta_val_amort_incevda_origin     as decimal format "->>>>>,>>>,>>9.99" decimals 4 initial 0 label "Amortizacao Incentiv" column-label "Amortizacao Incentiv"
    field tta_cod_tip_calc                 as character format "x(7)" label "Tipo C†lculo" column-label "Tipo C†lculo"
    field tta_ind_tip_calc                 as character format "X(20)" initial "Depreciaá∆o" label "Tipo" column-label "Tipo"
    .

def temp-table tt_xml_input_output no-undo
    field ttv_cod_label                    as character format "x(8)" label "Label" column-label "Label"
    field ttv_des_conteudo                 as character format "x(40)" label "Texto" column-label "Texto"
    field ttv_des_conteudo_aux             as character format "x(40)"
    field ttv_num_seq_1                    as integer format ">>>,>>9"
    .



/********************** Temporary Table Definition End **********************/

/************************** Buffer Definition Begin *************************/

def buffer b_aloc_bem
    for aloc_bem.
def buffer b_bem_pat
    for bem_pat.
def buffer b_bem_pat_parc
    for bem_pat.
def buffer b_bem_pat_proximo
    for bem_pat.
def buffer b_calc_parc_pis_cofins
    for calc_parc_pis_cofins.
def buffer b_calc_parc_pis_cofins_aux
    for calc_parc_pis_cofins.
def buffer b_cronog_calc_pat
    for cronog_calc_pat.
def buffer b_incorp_bem_pat
    for incorp_bem_pat.
def buffer b_incorp_bem_pat_parc
    for incorp_bem_pat.
def buffer b_movto_bem_pat
    for movto_bem_pat.
def buffer b_movto_bem_pat_desmbrto
    for movto_bem_pat.
def buffer b_movto_bem_pat_implant
    for movto_bem_pat.
def buffer b_movto_bem_pat_incorp
    for movto_bem_pat.
def buffer b_param_calc_bem_pat
    for param_calc_bem_pat.
def buffer b_param_calc_bem_pat_aux
    for param_calc_bem_pat.
def buffer b_param_calc_cta_aux
    for param_calc_cta.
def buffer b_param_calc_incorp_pat
    for param_calc_incorp_pat.
def buffer b_quant_produz
    for quant_produz.
def buffer b_val_origin_bem_pat
    for val_origin_bem_pat.


/*************************** Buffer Definition End **************************/


/************************* Variable Definition Begin ************************/



/************************** Variable Definition End *************************/


/************************** Report Definition Begin *************************/

    run pi_bt_ok_bem_pat_desmembr.
/************************ User Interface Trigger End ************************/

/************************** Function Trigger Begin **************************/



empty temp-table tt_desmembramento.


/* Begin_Include: i_tt_trans_bem_aux */
def temp-table tt_trans_bem_aux no-undo
    field ttv_num_empresa                  as char    format 'x(3)' label 'Empresa' column-label 'Empresa'
    field ttv_cod_cta_pat                  as character format 'x(18)' label 'Conta Patrimonial' column-label 'Conta Patrimonial'
    field ttv_num_bem_pat                  as integer format '>>>>>>>>9' initial 0 label 'Bem Patrimonial' column-label 'Bem Pat'
    field ttv_num_seq_bem_pat              as integer format '>>>>9' initial 0 label 'Sequància Bem' column-label 'Sequància'
    field tta_cod_unid_negoc               as character format "x(3)" label "Unid Neg¢cio" column-label "Un Neg"
    field ttv_dat_trans                    as date format '99/99/9999' initial ?
    field ttv_ind_orig_calc_bem_pat        as character format 'X(20)' initial 'Aquisiá∆o' label 'Origem' column-label 'Origem'
    index tt_indice_trans_bem              is primary unique
          ttv_num_empresa                  ascending
          ttv_cod_cta_pat                  ascending
          ttv_num_bem_pat                  ascending
          ttv_num_seq_bem_pat              ascending
    .
/* End_Include: i_tt_trans_bem_aux */


/* Begin_Include: i_declara_GetDefinedFunction */
FUNCTION GetDefinedFunction RETURNS LOGICAL (INPUT SPP AS CHARACTER):

    DEF VAR v_log_retorno AS LOGICAL INITIAL NO NO-UNDO.

    IF CAN-FIND (FIRST histor_exec_especial NO-LOCK
         WHERE histor_exec_especial.cod_modul_dtsul = "UFN" /* l_ufn*/ 
           AND histor_exec_especial.cod_prog_dtsul  = SPP) THEN
        ASSIGN v_log_retorno = YES.



    RETURN v_log_retorno.
END FUNCTION.
/* End_Include: i_declara_GetDefinedFunction */

assign v_dat_inic_period   = &IF "{&ems_dbtype}":U = "MSS":U &THEN 01/01/1800 &ELSE 01/01/0001 &ENDIF
       v_dat_fim_period    = 12/31/9999
       v_dat_execution     = today
       v_hra_execution     = replace(string(time, "hh:mm:ss" /*l_hh:mm:ss*/  ), ':', '').


/* Begin_Include: i_fnc_param_calc_incorp */
assign v_log_param_calc_incorp = no.

/* Begin_Include: i_declara_Verifica_Program_Name */
FUNCTION Verifica_Program_Name RETURN LOG (INPUT Programa AS CHAR, INPUT Repeticoes AS INT):
    DEF VAR v_num_cont  AS INTEGER NO-UNDO.
    DEF VAR v_log_achou AS LOGICAL NO-UNDO.


    /* Begin_Include: i_verifica_program_name */
    /* include feita para n∆o ocorrer problemas na utilizaá∆o do comando program-name */
    assign  v_num_cont  = 1
            v_log_achou = no.
    bloco:
    repeat:
        if index(program-name(v_num_cont),Programa) = ? then 
            leave bloco.
        if index(program-name(v_num_cont),Programa) <> 0 then do:
            assign v_log_achou = yes.
            leave bloco.
        end.
        if v_num_cont = Repeticoes then
            leave bloco.
        assign v_num_cont = v_num_cont + 1.
    end.
    /* End_Include: i_verifica_program_name */


    RETURN v_log_achou.
END FUNCTION.
/* End_Include: i_declara_Verifica_Program_Name */





/* Begin_Include: i_declara_SetEntryField */
FUNCTION SetEntryField RETURNS CHARACTER (input p_num_posicao     AS INTEGER,
                                          input p_cod_campo       AS CHARACTER,
                                          input p_cod_separador   AS CHARACTER,
                                          input p_cod_valor       AS CHARACTER):

/* ************* Parametros da FUNÄ«O *******************************
** Funá∆o para tratamento dos Entries dos c¢digos livres
** 
**  p_num_posicao     - N£mero do Entry / Posiá∆o que ser† atualizado
**  p_cod_campo       - Campo / Vari†vel que ser† atualizada
**  p_cod_separador   - Separador que ser† utilizado
**  p_cod_valor       - Valor que ser† atualizado no Entry passado 
*******************************************************************/

    def var v_num_cont        as integer initial 0 no-undo.
    def var v_num_entries_ini as integer initial 0 no-undo.

    /* ** No progress a menor Entry Ç 1 ***/
    if p_num_posicao <= 0 then 
       assign p_num_posicao = 1.       

    /* ** Caso o Campo contenha um valor inv†lido, este valor ser† convertido para Branco
         para possibilitar os c†lculo ***/
    if p_cod_campo = ? then do:
       assign p_cod_campo = "" /* l_*/ .
    end.

    assign v_num_entries_ini = num-entries(p_cod_campo,p_cod_separador) + 1 .    
    if p_cod_campo = "" /* l_*/  then do:
       assign v_num_entries_ini = 2.
    end.

    do v_num_cont =  v_num_entries_ini to p_num_posicao :
       assign p_cod_campo = p_cod_campo + p_cod_separador.
    end.

    assign entry(p_num_posicao,p_cod_campo,p_cod_separador) = p_cod_valor.

    RETURN p_cod_campo.

END FUNCTION.


/* End_Include: i_declara_SetEntryField */


/* Begin_Include: i_declara_GetEntryField */
FUNCTION GetEntryField RETURNS CHARACTER (input p_num_posicao     AS INTEGER,
                                          INPUT p_cod_campo       AS CHARACTER,
                                          input p_cod_separador   AS CHARACTER):

/* ************* Parametros da FUNÄ«O *******************************
** Funá∆o para tratamento dos Entries dos c¢digos livres
** 
**  p_num_posicao     - N£mero do Entry que ser† atualizado
**  p_cod_campo       - Campo / Vari†vel que ser† atualizada
**  p_cod_separador   - Separador que ser† utilizado
*******************************************************************/

    if  p_num_posicao <= 0  then do:
        assign p_num_posicao  = 1.
    end.
    if num-entries(p_cod_campo,p_cod_separador) >= p_num_posicao  then do:
       return entry(p_num_posicao,p_cod_campo,p_cod_separador).
    end.
    return "" /*l_*/ .

END FUNCTION.

/* End_Include: i_declara_GetEntryField */


/* Begin_Include: i_vrf_funcao_cong_cenar_ctbl */
assign v_log_funcao_congel_cenar_ctbl = no.


run pi_bem_pat_desmembramento.

/*****************************************************************************
** Procedure Interna.....: pi_implantar_bem_pat_desmbrto
** Descricao.............: pi_implantar_bem_pat_desmbrto
** Criado por............: Puccini
** Criado em.............: // 
** Alterado por..........: fut42625_2
** Alterado em...........: 19/04/2011 11:10:33
*****************************************************************************/
PROCEDURE pi_implantar_bem_pat_desmbrto:

    implanta_block:
    do on error undo implanta_block, leave implanta_block on endkey undo implanta_block, leave implanta_block transaction:
        assign v_val_perc_desmembr    = 0
               v_val_origin_desmembr  = 0
               v_qtd_bem_pat_desmembr = 0.
               
        acumular_tt_desmembrto_bem_pat_block:
        for each tt_desmembrto_bem_pat no-lock:
            assign v_val_perc_desmembr    = v_val_perc_desmembr + tt_desmembrto_bem_pat.tta_val_perc_movto_bem_pat
                   v_val_origin_desmembr  = v_val_origin_desmembr + tt_desmembrto_bem_pat.tta_val_original
                   v_qtd_bem_pat_desmembr = v_qtd_bem_pat_desmembr + tt_desmembrto_bem_pat.tta_qtd_bem_pat_represen.
        end /* for acumular_tt_desmembrto_bem_pat_block */.
        if  v_val_perc_desmembr >= 100
        then do:
            /* Bem informado esta totalmente desmembrado ! */
            run pi_messages (input "show",
                             input 855,
                             input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_855*/.
            undo implanta_block, leave implanta_block.
        end /* if */.
        create tt_desmembrto_bem_pat.
        if  avail b_bem_pat
        then do:
             assign tt_desmembrto_bem_pat.tta_cod_empresa        = b_bem_pat.cod_empresa
                    tt_desmembrto_bem_pat.tta_cod_estab          = b_bem_pat.cod_estab
                    tt_desmembrto_bem_pat.tta_cod_plano_ccusto   = b_bem_pat.cod_plano_ccusto
                    tt_desmembrto_bem_pat.tta_cod_ccusto_respons = b_bem_pat.cod_ccusto_respons
                    tt_desmembrto_bem_pat.tta_cod_unid_negoc     = b_bem_pat.cod_unid_negoc.
        end /* if */.
        assign v_rec_table = recid(tt_desmembrto_bem_pat).


    end /* do implanta_block */.

END PROCEDURE. /* pi_implantar_bem_pat_desmbrto */

/*****************************************************************************
** Procedure Interna.....: pi_desmembrar_bem_pat
** Descricao.............: pi_desmembrar_bem_pat
** Criado por............: Puccini
** Criado em.............: // 
** Alterado por..........: fut41422
** Alterado em...........: 16/08/2019 10:03:51
*****************************************************************************/
PROCEDURE pi_desmembrar_bem_pat:

    /************************** Buffer Definition Begin *************************/

    def buffer b_sdo_bem_pat
        for sdo_bem_pat.
    def buffer b_val_origin_bem_pat
        for val_origin_bem_pat.


    /*************************** Buffer Definition End **************************/

    /************************* Variable Definition Begin ************************/

    def var v_hdl_program
        as Handle
        format ">>>>>>9":U
        no-undo.
    def var v_log_erro
        as logical
        format "Sim/N∆o"
        initial yes
        no-undo.
    def var v_log_answer                     as logical         no-undo. /*local*/
    def var v_log_finalid                    as logical         no-undo. /*local*/


    /************************** Variable Definition End *************************/

    assign v_log_erro = no.

    if  b_bem_pat.val_perc_bxa = 100
    then do:
        find last b_movto_bem_pat_implant no-lock
            where b_movto_bem_pat_implant.num_id_bem_pat = b_bem_pat.num_id_bem_pat
              and b_movto_bem_pat_implant.ind_trans_calc_bem_pat = "Baixa" /*l_baixa*/  no-error.
        if  avail b_movto_bem_pat_implant
        then do:
            /* Bem totalmente baixado n∆o pode ser desmembrado ! */
            run pi_messages (input "show",
                             input 13696,
                             input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                               b_bem_pat.num_bem_pat,b_bem_pat.num_seq_bem_pat,b_bem_pat.cod_cta_pat,b_movto_bem_pat_implant.ind_orig_calc_bem_pat)) /*msg_13696*/.
            return "NOK" /*l_nok*/ .
        end /* if */.
    end /* if */.

    if b_bem_pat.ind_sit_bem_pat = "Penhorado" /*l_penhorado*/  then do:
        run pi_messages (input "show",
                         input 22802,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                           b_bem_pat.num_bem_pat,b_bem_pat.num_seq_bem_pat,b_bem_pat.cod_cta_pat,"Desmembramento" /*l_desmembramento*/)).
        assign v_log_answer = (if   return-value = "yes" then yes
                               else if return-value = "no" then no
                               else ?) /*msg_22802*/.
        if v_log_answer <> yes then
            return "NOK" /*l_nok*/ .
    end.

    if can-find (first variac_cambial_fas no-lock
                 where variac_cambial_fas.cod_empresa              = b_bem_pat.cod_empresa
                   and variac_cambial_fas.cod_cta_pat              = b_bem_pat.cod_cta_pat
                   and variac_cambial_fas.num_bem_pat              = b_bem_pat.num_bem_pat
                   and variac_cambial_fas.num_seq_bem_pat          = b_bem_pat.num_seq_bem_pat
                   and variac_cambial_fas.dat_calc_variac_cambial >= v_dat_desmbrto) then do:
        /* Variaá∆o Cambial j† calculada para o bem &1 / &2 ! */
        run pi_messages (input "show",
                         input 22590,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                           b_bem_pat.num_bem_pat,b_bem_pat.num_seq_bem_pat,b_bem_pat.cod_cta_pat, v_dat_desmbrto)) /*msg_22590*/.           
        return "NOK" /*l_nok*/ .
    end.
    if  not can-find(first compos_grp_calc
            where compos_grp_calc.cod_grp_calc = b_bem_pat.cod_grp_calc
              and compos_grp_calc.cod_tip_calc = " " /*cl_tip_calc_branco of compos_grp_calc*/)
            then do:
        /* N∆o existe Composiá∆o  com Tipo de C†lculo em  branco ! */
        run pi_messages (input "show",
                         input 2650,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_2650*/.
        return "NOK" /*l_nok*/ .
    end /* if */.
    blk_desmembrar:
    do transaction on error undo blk_desmembrar, leave blk_desmembrar on endkey undo blk_desmembrar, leave blk_desmembrar:

       assign v_val_perc_desmembr    = 0  v_val_origin_desmembr  = 0  v_qtd_bem_pat_desmembr = 0.
       if  b_bem_pat.cod_arrendador <> "" and b_bem_pat.cod_contrat_leas <> ""
       then do:
           find contrat_leas no-lock
                where contrat_leas.cod_arrendador = b_bem_pat.cod_arrendador
                  and contrat_leas.cod_contrat_leas = b_bem_pat.cod_contrat_leas
                 no-error.
           if  (contrat_leas.dat_term_contrat_leas <> ? and   contrat_leas.dat_term_contrat_leas > contrat_leas.dat_fim_valid and  v_dat_desmbrto < contrat_leas.dat_term_contrat_leas) or
               (v_dat_desmbrto < contrat_leas.dat_fim_valid)
           then do:
               /* N∆o Ç permitido desmobilizar bens em leasing ! */
               run pi_messages (input "show",
                                input 2264,
                                input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_2264*/.
               return "NOK" /*l_nok*/ .
           end /* if */.
       end /* if */.
       find first tt_desmembrto_bem_pat exclusive-lock no-error.
       if  avail tt_desmembrto_bem_pat
       then do:
           tt_desmembrto_bem_pat_block:
           for each tt_desmembrto_bem_pat no-lock:
               assign v_val_perc_desmembr    = v_val_perc_desmembr + tt_desmembrto_bem_pat.tta_val_perc_movto_bem_pat
                      v_val_origin_desmembr  = round(v_val_origin_desmembr + tt_desmembrto_bem_pat.tta_val_original,2)
                      v_qtd_bem_pat_desmembr = v_qtd_bem_pat_desmembr + tt_desmembrto_bem_pat.tta_qtd_bem_pat_represen.
           end /* for tt_desmembrto_bem_pat_block */.
               assign v_val_perc_desmembr = 100.
           /* ======================================================================
             BLOQUEIO DO ATIVO FIXO - VERIFICA DESMEMBRAMENTO
             ======================================================================*/
           assign v_log_consist = yes.
                   run prgfin/fas/fas912za.py persistent set v_hdl_program (Input 2) /*prg_api_bem_pat_consist*/.

               empty temp-table tt_rpt_consist_bem_pat.
               empty temp-table tt_log_inconsist.
               create tt_rpt_consist_bem_pat.
               buffer-copy b_bem_pat to tt_rpt_consist_bem_pat.

               assign v_dat_inic_validac = v_dat_desmbrto.
               run pi_main_api_bem_pat_consist in v_hdl_program (Input table tt_rpt_consist_bem_pat,
                                                Input v_dat_inic_validac,
                                                output table tt_log_inconsist) /*pi_main_api_bem_pat_consist*/.

               if can-find(first tt_log_inconsist) then do:
                   /* Somente mostrarˇ bloqueio para bens que estiverem consistentes antes da baixa e ficarem
                      inconsistentes apΩs a baixa, por isso foi inserido o controle na variˇvel v_log_consist
                   */
                   assign v_log_consist = no.
               end.
           end.
           /* retirado chamada da pi run pi_verificar_valores_originais_origem(input no). */       
           create b_movto_bem_pat_desmbrto.
           assign b_movto_bem_pat_desmbrto.num_id_bem_pat         = b_bem_pat.num_id_bem_pat
                  b_movto_bem_pat_desmbrto.num_seq_incorp_bem_pat = 0
                  b_movto_bem_pat_desmbrto.num_seq_movto_bem_pat  = next-value(seq_movto_bem_pat)
                  b_movto_bem_pat_desmbrto.dat_movto_bem_pat      = v_dat_desmbrto
                  b_movto_bem_pat_desmbrto.ind_trans_calc_bem_pat = "Baixa" /*l_baixa*/ 
                  b_movto_bem_pat_desmbrto.ind_orig_calc_bem_pat  = "Desmembramento" /*l_desmembramento*/ 
                  b_movto_bem_pat_desmbrto.cod_empresa            = b_bem_pat.cod_empresa
                  b_movto_bem_pat_desmbrto.cod_plano_ccusto       = b_bem_pat.cod_plano_ccusto
                  b_movto_bem_pat_desmbrto.cod_ccusto_respons     = b_bem_pat.cod_ccusto_respons
                  b_movto_bem_pat_desmbrto.cod_unid_negoc         = b_bem_pat.cod_unid_negoc
                  b_movto_bem_pat_desmbrto.cod_estab              = b_bem_pat.cod_estab.
           then do:
               assign v_num_seq_incorp_bem_pat = 0.
               find last b_val_origin_bem_pat no-lock
                   where b_val_origin_bem_pat.num_id_bem_pat = b_bem_pat.num_id_bem_pat
                     and b_val_origin_bem_pat.num_seq_incorp_bem_pat = v_num_seq_incorp_bem_pat
                     and b_val_origin_bem_pat.cod_cenar_ctbl = cenar_ctbl.cod_cenar_ctbl
                     and b_val_origin_bem_pat.cod_finalid_econ = v_cod_finalid_aux no-error.
               assign v_val_origin_moed_bem_pat = round(b_val_origin_bem_pat.val_original,2)
                      b_movto_bem_pat_desmbrto.cod_cenar_ctbl           = cenar_ctbl.cod_cenar_ctbl
                      b_movto_bem_pat_desmbrto.cod_indic_econ           = indic_econ.cod_indic_econ
                      b_movto_bem_pat_desmbrto.val_origin_movto_bem_pat = v_val_origin_desmembr
                      b_movto_bem_pat_desmbrto.val_perc_movto_bem_pat   = v_val_perc_desmembr.           
           end /* if */.

           if  v_cod_pais_empres_usuar = "BRA" /*l_bra*/  then do:
               /* Os valores cr_pis e cr_cofins ser∆o armazenados no movimento de baixa para que seja possivel recuperar
                * o valor de credito PIS / COFINS da incorporaá∆o, quando estiver sendo excluido um movimento de baixa com 100% */
                   assign b_movto_bem_pat_desmbrto.val_cr_pis    = b_bem_pat.val_cr_pis
                          b_movto_bem_pat_desmbrto.val_cr_cofins = b_bem_pat.val_cr_cofins.
           end.
           validate b_movto_bem_pat_desmbrto.
           run pi_desmembrar_bem_pat_incorp.

           blk_param_calc:
           for each param_calc_bem_pat exclusive-lock
            where param_calc_bem_pat.num_id_bem_pat = b_bem_pat.num_id_bem_pat /*cl_dlg_03_bem_pat_desmembramento of param_calc_bem_pat*/:
               assign v_val_maximum = v_val_maximum + 1.
           end /* for blk_param_calc */.
           run pi_percent_update (Input v_val_maximum,
                                  Input 0,
                                  Input getStrTrans("Efetuando o desmembramento do bem informado", "FAS") /*l_efetuando_desmembramento*/) /*pi_percent_update*/.
           assign v_val_current_value = 0.

           run pi_desmembrar_bem_pat_more /*pi_desmembrar_bem_pat_more*/.

           run pi_verificar_valores_originais_origem(input no). 

           assign b_bem_pat.val_perc_bxa = b_bem_pat.val_perc_bxa + ((100 - b_bem_pat.val_perc_bxa) * b_movto_bem_pat_desmbrto.val_perc_movto_bem_pat / 100).
           if  b_bem_pat.val_perc_bxa > 100
           then do:
               assign b_bem_pat.val_perc_bxa = 100.
           end /* if */.
               if b_bem_pat.val_perc_bxa = 100 then
                   run pi_rotina_integr_manuf(input bem_pat.cod_empresa,
                                              input bem_pat.cod_cta_pat,
                                              input bem_pat.num_bem_pat,
                                              input bem_pat.num_seq_bem_pat,
                                              input b_movto_bem_pat_desmbrto.dat_movto_bem_pat,
                                              input b_movto_bem_pat_desmbrto.ind_orig_calc_bem_pat).                

               run prgfin/fas/fas903zb.py (buffer b_bem_pat,
                                       Input " ",
                                       Input b_movto_bem_pat_desmbrto.dat_movto_bem_pat) /*prg_fnc_bem_pat_calc_movimento*/.


           for each param_calc_bem_pat exclusive-lock
               where param_calc_bem_pat.num_id_bem_pat = b_bem_pat.num_id_bem_pat:
               if  param_calc_bem_pat.val_resid_min > 0
               then do:
                   assign param_calc_bem_pat.val_resid_min = param_calc_bem_pat.val_resid_min * (1 - (v_val_perc_desmembr / 100)).
               end /* if */.  /* ** Deixa no residual somente o quanto ainda existe no bem baixado apΩs o desmembramento ***/
           end.
           if v_log_param_calc_incorp = yes then do:
               for each param_calc_incorp_pat exclusive-lock
                   where param_calc_incorp_pat.num_id_bem_pat = b_bem_pat.num_id_bem_pat:
                   if  param_calc_incorp_pat.val_resid_min > 0
                   then do:
                       assign param_calc_incorp_pat.val_resid_min = param_calc_incorp_pat.val_resid_min * (1 - (v_val_perc_desmembr / 100)).
                   end.
               end.
           end.
           else do:
                   for each tab_livre_emsfin exclusive-lock
                       where tab_livre_emsfin.cod_modul_dtsul      = "FAS" /*l_fas*/  
                       and   tab_livre_emsfin.cod_tab_dic_dtsul    = 'val_resid_incorp'
                       and   tab_livre_emsfin.cod_compon_1_idx_tab begins string(b_bem_pat.num_id_bem_pat):    
                       if  tab_livre_emsfin.val_livre_1 > 0
                       then do:
                           assign tab_livre_emsfin.val_livre_1 = tab_livre_emsfin.val_livre_1 * (1 - (v_val_perc_desmembr / 100)).
                       end /* if */.
                   end.
           end. 
           blk_calculo_implant:
           for each movto_bem_pat no-lock
               where movto_bem_pat.num_id_bem_pat_orig = b_movto_bem_pat_desmbrto.num_id_bem_pat
               and   movto_bem_pat.num_seq_movto_bem_pat_orig = b_movto_bem_pat_desmbrto.num_seq_movto_bem_pat:
               find bem_pat no-lock
                   where bem_pat.num_id_bem_pat = movto_bem_pat.num_id_bem_pat
                   no-error.
                   run prgfin/fas/fas903zb.py (buffer bem_pat,
                                           Input " ",
                                           Input movto_bem_pat.dat_movto_bem_pat) /*prg_fnc_bem_pat_calc_movimento*/.
               if  return-value = "NOK" /*l_nok*/ 
               then do:
                   undo blk_desmembrar, leave blk_desmembrar.
                   return "NOK" /*l_nok*/ .
               end /* if */.
           end /* for blk_calculo_implant */.
       end /* if */.
       run pi_verificar_valores_originais_origem(input yes).
       /* Verifica se existe diferenáa entre o bem baixado por desmembramento e o implantado por desmembramento */
           run prgfin/fas/fas703zc.p (Input v_dat_desmbrto,
                                  buffer b_bem_pat,
                                  Input table tt_verifica_diferenca_desmem) /*prg_fnc_bem_pat*/.

       /* ======================================================================
          BLOQUEIO DO ATIVO FIXO - VERIFICA DESMEMBRAMENTO
         ======================================================================*/
       if v_log_consist then do:
                   run prgfin/fas/fas912za.py persistent set v_hdl_program (Input 2) /*prg_api_bem_pat_consist*/.
           end.

           if  valid-handle(v_hdl_program) then do:
               empty temp-table tt_rpt_consist_bem_pat.
               /* ----- BENS IMPLANTADOS POR DESMEMBRAMENTO------*/
               for each tt_desmembrto_bem_pat,
                 first bem_pat no-lock
                 where bem_pat.cod_empresa     = v_cod_empres_usuar
                   and   bem_pat.cod_cta_pat     = tt_desmembrto_bem_pat.tta_cod_cta_pat
                   and   bem_pat.num_bem_pat     = tt_desmembrto_bem_pat.tta_num_bem_pat
                   and   bem_pat.num_seq_bem_pat = tt_desmembrto_bem_pat.tta_num_seq_bem_pat:
                   create tt_rpt_consist_bem_pat.
                   buffer-copy bem_pat to tt_rpt_consist_bem_pat.
               end.
               /* -------BEM BAIXADO POR DESMEMBRAMENTO------*/
               create tt_rpt_consist_bem_pat.
               buffer-copy b_bem_pat to tt_rpt_consist_bem_pat.

               empty temp-table tt_log_inconsist.

               assign v_dat_inic_validac = v_dat_desmbrto.
               run pi_main_api_bem_pat_consist in v_hdl_program (Input table tt_rpt_consist_bem_pat,
                                                Input v_dat_inic_validac,
                                                output table tt_log_inconsist) /*pi_main_api_bem_pat_consist*/.

               if  can-find(first tt_log_inconsist) then do:
                   assign v_log_erro = yes.
                   delete procedure v_hdl_program.
                   run pi_listar_inconsist_bem_pat /*pi_listar_inconsist_bem_pat*/.
                   /* Ocorreu o erro &1 no processo executado ! */
                   run pi_messages (input "show",
                                    input 15800,
                                    input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                      15800,replace(v_nom_arq_log,'~~','-'))) /*msg_15800*/.
                   undo blk_desmembrar, leave blk_desmembrar.
               end.
           end.
       end.    
    end /* do blk_desmembrar */.

END PROCEDURE. /* pi_desmembrar_bem_pat */
/*****************************************************************************
** Procedure Interna.....: pi_desmembrar_bem_pat_more
** Descricao.............: pi_desmembrar_bem_pat_more
** Criado por............: Puccini
** Criado em.............: 15/10/1998 15:35:00
** Alterado por..........: 009394
** Alterado em...........: 11/07/2019 14:32:58
*****************************************************************************/
PROCEDURE pi_desmembrar_bem_pat_more:

    /************************** Buffer Definition Begin *************************/

    def buffer b_incorp_bem_pat
        for incorp_bem_pat.
    def buffer b_movto_bem_pat_incorp_aux
        for movto_bem_pat.


    /*************************** Buffer Definition End **************************/

    /************************* Variable Definition Begin ************************/

    def var v_rec_val_origin_bem_pat
        as recid
        format ">>>>>>9":U
        initial ?
        no-undo.
    def var v_val_maior
        as decimal
        format "->>,>>>,>>>,>>9.99":U
        decimals 2
        no-undo.
    def var v_cod_return                     as character       no-undo. /*local*/


    /************************** Variable Definition End *************************/

    blk_param_calc:
    for each param_calc_bem_pat exclusive-lock
        where param_calc_bem_pat.num_id_bem_pat = b_bem_pat.num_id_bem_pat 
        break by param_calc_bem_pat.cod_cenar_ctbl  
              by param_calc_bem_pat.cod_finalid_econ:
        if  not last-of(param_calc_bem_pat.cod_finalid_econ)
        then do:
            assign v_val_current_value = v_val_current_value + 1.
            run pi_percent_update (Input v_val_maximum,
                                   Input v_val_current_value,
                                   Input "") /*pi_percent_update*/.
            next blk_param_calc.
        end /* if */.
        tt_finalid_bem_pat_calculo:
        for each tt_finalid_bem_pat_calculo no-lock:
            delete tt_finalid_bem_pat_calculo.
        end /* for tt_finalid_bem_pat_calculo */.
        create tt_finalid_bem_pat_calculo.
        assign tt_finalid_bem_pat_calculo.ttv_rec_bem_pat      = recid(bem_pat)
               tt_finalid_bem_pat_calculo.tta_cod_finalid_econ = param_calc_bem_pat.cod_finalid_econ.
        tt_finalid_bem_pat_calculo:
        for each tt_finalid_bem_pat_calculo no-lock:
            run pi_tt_desmembrto.
            if return-value = 'next' then next tt_finalid_bem_pat_calculo.
            if return-value = 'NOK' then
               return 'NOK'.
        end /* for tt_finalid_bem_pat_calculo */.

        find movto_cenar_bem_pat no-lock
             where movto_cenar_bem_pat.num_id_bem_pat = b_movto_bem_pat_desmbrto.num_id_bem_pat
               and movto_cenar_bem_pat.num_seq_incorp_bem_pat = b_movto_bem_pat_desmbrto.num_seq_incorp_bem_pat
               and movto_cenar_bem_pat.num_seq_movto_bem_pat = b_movto_bem_pat_desmbrto.num_seq_movto_bem_pat
               and movto_cenar_bem_pat.cod_cenar_ctbl = param_calc_bem_pat.cod_cenar_ctbl
              no-error.
        if  not avail movto_cenar_bem_pat
        then do:
            create movto_cenar_bem_pat.
            assign movto_cenar_bem_pat.num_id_bem_pat         = b_movto_bem_pat_desmbrto.num_id_bem_pat
                   movto_cenar_bem_pat.num_seq_incorp_bem_pat = b_movto_bem_pat_desmbrto.num_seq_incorp_bem_pat
                   movto_cenar_bem_pat.num_seq_movto_bem_pat  = b_movto_bem_pat_desmbrto.num_seq_movto_bem_pat
                   movto_cenar_bem_pat.cod_cenar_ctbl         = param_calc_bem_pat.cod_cenar_ctbl.
            validate movto_cenar_bem_pat.
        end /* if */.
        blk_incorp:
        for each incorp_bem_pat no-lock
            where incorp_bem_pat.num_id_bem_pat = b_movto_bem_pat_desmbrto.num_id_bem_pat
            and   incorp_bem_pat.dat_incorp_bem_pat <= b_movto_bem_pat_desmbrto.dat_movto_bem_pat:
            if  incorp_bem_pat.cod_cenar_ctbl <> " " and  incorp_bem_pat.cod_cenar_ctbl <> param_calc_bem_pat.cod_cenar_ctbl
            then do:
                next blk_incorp.
            end /* if */.
            find first b_movto_bem_pat_incorp no-lock
                where b_movto_bem_pat_incorp.num_id_bem_pat = b_movto_bem_pat_desmbrto.num_id_bem_pat
                  and b_movto_bem_pat_incorp.num_seq_incorp_bem_pat = incorp_bem_pat.num_seq_incorp_bem_pat
                  and b_movto_bem_pat_incorp.num_seq_movto_bem_pat = b_movto_bem_pat_desmbrto.num_seq_movto_bem_pat.
            find movto_cenar_bem_pat no-lock
                 where movto_cenar_bem_pat.num_id_bem_pat = b_movto_bem_pat_incorp.num_id_bem_pat
                   and movto_cenar_bem_pat.num_seq_incorp_bem_pat = b_movto_bem_pat_incorp.num_seq_incorp_bem_pat
                   and movto_cenar_bem_pat.num_seq_movto_bem_pat = b_movto_bem_pat_incorp.num_seq_movto_bem_pat
                   and movto_cenar_bem_pat.cod_cenar_ctbl = param_calc_bem_pat.cod_cenar_ctbl
                  no-error.
            if  not avail movto_cenar_bem_pat
            then do:
                create movto_cenar_bem_pat.
                assign movto_cenar_bem_pat.num_id_bem_pat         = b_movto_bem_pat_incorp.num_id_bem_pat
                       movto_cenar_bem_pat.num_seq_incorp_bem_pat = b_movto_bem_pat_incorp.num_seq_incorp_bem_pat
                       movto_cenar_bem_pat.num_seq_movto_bem_pat  = b_movto_bem_pat_incorp.num_seq_movto_bem_pat
                       movto_cenar_bem_pat.cod_cenar_ctbl = param_calc_bem_pat.cod_cenar_ctbl.
                validate movto_cenar_bem_pat.
            end /* if */.
        end /* for blk_incorp */.
        blk_movto_implant:
        for each movto_bem_pat no-lock
            where movto_bem_pat.num_id_bem_pat_orig = b_movto_bem_pat_desmbrto.num_id_bem_pat
              and movto_bem_pat.num_seq_movto_bem_pat_orig = b_movto_bem_pat_desmbrto.num_seq_movto_bem_pat:
            find movto_cenar_bem_pat no-lock
                 where movto_cenar_bem_pat.num_id_bem_pat = movto_bem_pat.num_id_bem_pat
                   and movto_cenar_bem_pat.num_seq_incorp_bem_pat = movto_bem_pat.num_seq_incorp_bem_pat
                   and movto_cenar_bem_pat.num_seq_movto_bem_pat = movto_bem_pat.num_seq_movto_bem_pat
                   and movto_cenar_bem_pat.cod_cenar_ctbl = param_calc_bem_pat.cod_cenar_ctbl
                 use-index mvtcnrbm_id
                  /*cl_consiste_criacao_movto_cenar of movto_cenar_bem_pat*/ no-error.
            if  not avail movto_cenar_bem_pat
            then do:
                create movto_cenar_bem_pat.
                assign movto_cenar_bem_pat.num_id_bem_pat         = movto_bem_pat.num_id_bem_pat
                       movto_cenar_bem_pat.num_seq_incorp_bem_pat = movto_bem_pat.num_seq_incorp_bem_pat
                       movto_cenar_bem_pat.num_seq_movto_bem_pat  = movto_bem_pat.num_seq_movto_bem_pat.
                assign movto_cenar_bem_pat.cod_cenar_ctbl = param_calc_bem_pat.cod_cenar_ctbl.
                validate movto_cenar_bem_pat.
            end /* if */.
            blk_incorp_imp:
            for each incorp_bem_pat no-lock
                where incorp_bem_pat.num_id_bem_pat = movto_bem_pat.num_id_bem_pat
                and   incorp_bem_pat.dat_incorp_bem_pat <= b_movto_bem_pat_desmbrto.dat_movto_bem_pat:
                if  incorp_bem_pat.cod_cenar_ctbl <> " " and  incorp_bem_pat.cod_cenar_ctbl <> param_calc_bem_pat.cod_cenar_ctbl
                then do:
                    next blk_incorp_imp.
                end /* if */.
                find first b_movto_bem_pat_incorp_aux exclusive-lock
                    where b_movto_bem_pat_incorp_aux.num_id_bem_pat = movto_bem_pat.num_id_bem_pat
                      and b_movto_bem_pat_incorp_aux.num_seq_incorp_bem_pat = incorp_bem_pat.num_seq_incorp_bem_pat 
                      and b_movto_bem_pat_incorp_aux.ind_trans_calc_bem_pat = "Implantaá∆o" /*l_implantacao*/  no-error.
                assign b_movto_bem_pat_incorp_aux.num_seq_movto_bem_pat_orig = b_movto_bem_pat_desmbrto.num_seq_movto_bem_pat.
                find movto_cenar_bem_pat no-lock
                     where movto_cenar_bem_pat.num_id_bem_pat = b_movto_bem_pat_incorp_aux.num_id_bem_pat
                       and movto_cenar_bem_pat.num_seq_incorp_bem_pat = b_movto_bem_pat_incorp_aux.num_seq_incorp_bem_pat
                       and movto_cenar_bem_pat.num_seq_movto_bem_pat = b_movto_bem_pat_incorp_aux.num_seq_movto_bem_pat
                       and movto_cenar_bem_pat.cod_cenar_ctbl = param_calc_bem_pat.cod_cenar_ctbl
                      no-error.
                if  not avail movto_cenar_bem_pat
                then do:
                    create movto_cenar_bem_pat.
                    assign movto_cenar_bem_pat.num_id_bem_pat         = b_movto_bem_pat_incorp_aux.num_id_bem_pat
                           movto_cenar_bem_pat.num_seq_incorp_bem_pat = b_movto_bem_pat_incorp_aux.num_seq_incorp_bem_pat
                           movto_cenar_bem_pat.num_seq_movto_bem_pat  = b_movto_bem_pat_incorp_aux.num_seq_movto_bem_pat
                           movto_cenar_bem_pat.cod_cenar_ctbl         = param_calc_bem_pat.cod_cenar_ctbl.
                    validate movto_cenar_bem_pat.
                end /* if */.
            end /* for blk_incorp_imp */.
        end /* for blk_movto_implant */.
        assign v_val_current_value = v_val_current_value + 1.
        run pi_percent_update (Input v_val_maximum,
                               Input v_val_current_value,
                               Input "") /*pi_percent_update*/.
    end /* for blk_param_calc */.

    return "OK" /*l_ok*/ .
END PROCEDURE. /* pi_desmembrar_bem_pat_more */
/*****************************************************************************
** Procedure Interna.....: pi_sit_movimen_pat
** Descricao.............: pi_sit_movimen_pat
** Criado por............: marcelo
** Criado em.............: // 
** Alterado por..........: src12337
** Alterado em...........: 01/07/2003 09:02:43
*****************************************************************************/
PROCEDURE pi_sit_movimen_pat:

    /************************ Parameter Definition Begin ************************/

    def Input param p_rec_param_calc_bem_pat
        as recid
        format ">>>>>>9"
        no-undo.
    def Input param p_dat_inic_parada
        as date
        format "99/99/9999"
        no-undo.
    def output param p_log_return
        as logical
        format "Sim/N∆o"
        no-undo.
    def output param p_dat_return
        as date
        format "99/99/9999"
        no-undo.


    /************************* Parameter Definition End *************************/


    /* N∆o podem existir para um bem patrimonial dois movimentos em um mesmo dia */
    find first sdo_bem_pat no-lock
        where sdo_bem_pat.num_id_bem_pat  = param_calc_bem_pat.num_id_bem_pat 
        and   sdo_bem_pat.dat_sdo_bem_pat > p_dat_inic_parada no-error.
    if  avail sdo_bem_pat then do:
        assign p_log_return = no
               p_dat_return = ?.
        return.
    end.

    find param_calc_bem_pat 
        where recid(param_calc_bem_pat) = p_rec_param_calc_bem_pat 
        no-lock no-error.  
    find last reg_calc_bem_pat no-lock
        where reg_calc_bem_pat.num_id_bem_pat         = param_calc_bem_pat.num_id_bem_pat
        and   reg_calc_bem_pat.num_seq_incorp_bem_pat = 0
        and   reg_calc_bem_pat.cod_tip_calc           = param_calc_bem_pat.cod_tip_calc
        and   reg_calc_bem_pat.cod_cenar_ctbl         = param_calc_bem_pat.cod_cenar_ctbl 
        no-error.
    assign p_log_return = yes
           p_dat_return = today.
    if  not avail reg_calc_bem_pat or
       (avail reg_calc_bem_pat and
        reg_calc_bem_pat.dat_calc_pat < p_dat_inic_parada)
    then do:
        find last movto_bem_pat no-lock
             where movto_bem_pat.num_id_bem_pat = param_calc_bem_pat.num_id_bem_pat
               and movto_bem_pat.log_estorn_movto_bem_pat = no
             use-index mvtbmpt_estorn no-error.
        if  avail movto_bem_pat and
            movto_bem_pat.dat_movto_bem_pat < p_dat_inic_parada
        then do:
            if  avail reg_calc_bem_pat
            then do:
                assign p_dat_return = reg_calc_bem_pat.dat_calc_pat.
            end /* if */.
            else do:
                assign p_dat_return = movto_bem_pat.dat_movto_bem_pat.
            end /* else */.
        end /* if */.
        else do:
            assign p_log_return = no
                   p_dat_return = ?.
        end /* else */.
    end /* if */.
    else do:
        assign p_log_return = no
               p_dat_return = ?.
    end /* else */.

    IF p_log_return THEN DO:
        FIND FIRST reg_calc_bem_pat no-lock
            where reg_calc_bem_pat.num_id_bem_pat         = param_calc_bem_pat.num_id_bem_pat
            and   reg_calc_bem_pat.num_seq_incorp_bem_pat <> 0
            and   reg_calc_bem_pat.cod_tip_calc           = param_calc_bem_pat.cod_tip_calc
            and   reg_calc_bem_pat.cod_cenar_ctbl         = param_calc_bem_pat.cod_cenar_ctbl 
            AND   reg_calc_bem_pat.dat_calc_pat           = p_dat_inic_parada
            NO-ERROR.
        assign p_log_return = yes
               p_dat_return = today.
        if  not avail reg_calc_bem_pat or
           (avail reg_calc_bem_pat and
            reg_calc_bem_pat.dat_calc_pat < p_dat_inic_parada)
        then do:
            find last movto_bem_pat no-lock
                 where movto_bem_pat.num_id_bem_pat = param_calc_bem_pat.num_id_bem_pat
                   and movto_bem_pat.log_estorn_movto_bem_pat = no
                 use-index mvtbmpt_estorn no-error.
            if  avail movto_bem_pat and
                movto_bem_pat.dat_movto_bem_pat < p_dat_inic_parada
            then do:
                if  avail reg_calc_bem_pat
                then do:
                    assign p_dat_return = reg_calc_bem_pat.dat_calc_pat.
                end /* if */.
                else do:
                    assign p_dat_return = movto_bem_pat.dat_movto_bem_pat.
                end /* else */.
            end /* if */.
            else do:
                assign p_log_return = no
                       p_dat_return = ?.
            end /* else */.
        end /* if */.
        else do:
            assign p_log_return = no
                   p_dat_return = ?.
        end /* else */.
    END.

    find first contrat_leas where 
        contrat_leas.cod_contrat_leas = bem_pat.cod_contrat_leas and
        contrat_leas.cod_arrendador = bem_pat.cod_arrendador no-lock no-error.
    if  avail contrat_leas
    then do: 
        if  contrat_leas.dat_fim_valid <= p_dat_inic_parada
        then do:
            /* validaá∆o de data de in°cio de calculo para tipo de calculo  " " */
            if  param_calc_bem_pat.cod_tip_calc = "" and
                param_calc_bem_pat.dat_inic_calc > p_dat_inic_parada
            then do:
                assign p_log_return = no
                       p_dat_return = ?.
            end /* if */.
        end /* if */.        
    end /* if */.
    else do:     
       /* validaá∆o de data de in°cio de calculo para tipo de calculo  " " */
        if  param_calc_bem_pat.cod_tip_calc = "" and
            param_calc_bem_pat.dat_inic_calc > p_dat_inic_parada
        then do:
            assign p_log_return = no
                   p_dat_return = ?.
        end /* if */.
    end /* if */.
END PROCEDURE. /* pi_sit_movimen_pat */
/*****************************************************************************
** Procedure Interna.....: pi_implantar_bem_pat_desmbrto_more
** Descricao.............: pi_implantar_bem_pat_desmbrto_more
** Criado por............: SARDI
** Criado em.............: 15/07/1996 08:59:45
** Alterado por..........: fut41422
** Alterado em...........: 24/10/2017 16:08:20
*****************************************************************************/
PROCEDURE pi_implantar_bem_pat_desmbrto_more:

    /************************** Buffer Definition Begin *************************/

    def buffer b_movto_bem_pat
        for movto_bem_pat.
    def buffer b_movto_bem_pat_baixa
        for movto_bem_pat.
    def buffer b_param_calc_bem_pat_orig
        for param_calc_bem_pat.
    def buffer b_val_origin_bem_pat
        for val_origin_bem_pat.


    /*************************** Buffer Definition End **************************/

    /************************* Variable Definition Begin ************************/

    def var v_qtd_dias_vida_util
        as decimal
        format ">>>,>>>,>>9":U
        decimals 0
        no-undo.
    def var v_val_original
        as decimal
        format "->>>>>,>>>,>>9.99":U
        decimals 4
        initial 0
        label "Valor Original"
        column-label "Valor Original"
        no-undo.
    def var v_cod_finalid_econ_incorp        as character       no-undo. /*local*/


    /************************** Variable Definition End *************************/


    find cta_pat no-lock where cta_pat.cod_empresa = v_cod_empres_usuar and
        cta_pat.cod_cta_pat = tt_desmembrto_bem_pat.tta_cod_cta no-error.
    if avail cta_pat then do:
        create bem_pat.
        assign bem_pat.cod_empresa     = v_cod_empres_usuar
               bem_pat.cod_cta_pat     = tt_desmembrto_bem_pat.tta_cod_cta_pat
               bem_pat.num_bem_pat     = tt_desmembrto_bem_pat.tta_num_bem_pat
               bem_pat.num_seq_bem_pat = tt_desmembrto_bem_pat.tta_num_seq_bem_pat
               bem_pat.des_bem_pat     = tt_desmembrto_bem_pat.tta_des_bem_pat
               bem_pat.cod_ident_cop   = ""
               bem_pat.ind_orig_bem    = "Desmembramento" /*l_desmembramento*/ .

            assign bem_pat.qtd_bem_pat_represen = v_qtd_bem_pat_represen.

        assign bem_pat.ind_period_invent          = b_bem_pat.ind_period_invent
               bem_pat.qtd_interv_invent          = b_bem_pat.qtd_interv_invent
               bem_pat.cb3_ident_visual           = ?
               bem_pat.dat_aquis_bem_pat          = b_bem_pat.dat_aquis_bem_pat
               bem_pat.cod_estab                  = tt_desmembrto_bem_pat.tta_cod_estab
               bem_pat.cod_grp_calc               = cta_pat.cod_grp_calc 
               bem_pat.ind_periodic_invent        = b_bem_pat.ind_periodic_invent
               bem_pat.val_perc_bxa               = 0
               bem_pat.cod_espec_bem              = b_bem_pat.cod_espec_bem
               bem_pat.cod_marca                  = b_bem_pat.cod_marca
               bem_pat.cod_modelo                 = b_bem_pat.cod_modelo
               bem_pat.cod_licenc_uso             = b_bem_pat.cod_licenc_uso
               bem_pat.cod_especif_tec            = b_bem_pat.cod_especif_tec
               bem_pat.cod_arrendador             = b_bem_pat.cod_arrendador
               bem_pat.cod_contrat_leas           = b_bem_pat.cod_contrat_leas
               bem_pat.cod_estado_fisic_bem_pat   = b_bem_pat.cod_estado_fisic_bem_pat
               bem_pat.cdn_fornecedor             = b_bem_pat.cdn_fornecedor
               bem_pat.cod_localiz                = b_bem_pat.cod_localiz
               bem_pat.cod_usuario                = b_bem_pat.cod_usuario
               bem_pat.cod_plano_ccusto           = tt_desmembrto_bem_pat.tta_cod_plano_ccusto
               bem_pat.cod_ccusto_respons         = tt_desmembrto_bem_pat.tta_cod_ccusto_respons
               bem_pat.des_anot_tab               = b_bem_pat.des_anot_tab
               bem_pat.cod_unid_negoc             = tt_desmembrto_bem_pat.tta_cod_unid_negoc
               bem_pat.cod_imagem                 = b_bem_pat.cod_imagem
               bem_pat.dat_calc_pat               = v_dat_desmbrto
               bem_pat.cod_indic_econ             = v_cod_indic_econ
               bem_pat.val_original               = round(v_val_origin_bem_pat * (v_val_perc_aplic_desmbrto / 100),2)
               bem_pat.val_despes_financ          = v_val_despes_financ * (v_val_perc_aplic_desmbrto / 100)
               bem_pat.dat_refer                  = v_dat_desmbrto
               bem_pat.cod_indic_econ_avaliac     = b_bem_pat.cod_indic_econ_avaliac
               bem_pat.val_avaliac_apol_seguro    = b_bem_pat.val_avaliac_apol_seguro
               bem_pat.dat_avaliac_apol_seguro    = b_bem_pat.dat_avaliac_apol_seguro
               bem_pat.des_narrat_bem_pat         = b_bem_pat.des_narrat_bem_pat.


        /* ------------- MP 66 --------------*/ 
        if  v_cod_pais_empres_usuar = "BRA" /*l_bra*/  then do:

                assign bem_pat.log_bem_imptdo      = b_bem_pat.log_bem_imptdo
                       bem_pat.log_cr_pis          = b_bem_pat.log_cr_pis
                       bem_pat.log_cr_cofins       = b_bem_pat.log_cr_cofins
                       bem_pat.num_parc_pis_cofins = b_bem_pat.num_parc_pis_cofins.

               /* Salva valores de base de PIS/COFINS do bem original para os novos bens*/
                    assign bem_pat.cod_livre_1 = SetEntryField(10,bem_pat.cod_livre_1,";",GetEntryField(10,b_bem_pat.cod_livre_1,";"))
                           bem_pat.cod_livre_1 = SetEntryField(11,bem_pat.cod_livre_1,";",GetEntryField(11,b_bem_pat.cod_livre_1,";")). 

            /* --------------- MP219 -------------------*/

            assign bem_pat.log_cr_csll       = b_bem_pat.log_cr_csll
                   bem_pat.num_exerc_cr_csll = b_bem_pat.num_exerc_cr_csll.

        end.

        /* ---------------------------------------------*/

            assign bem_pat.val_original = tt_desmembrto_bem_pat.tta_val_original.


        param_calc_cta:
        for each param_calc_cta no-lock
            where param_calc_cta.cod_empresa = bem_pat.cod_empresa
            and   param_calc_cta.cod_cta_pat = bem_pat.cod_cta_pat:
            create param_calc_bem_pat.
            assign param_calc_bem_pat.cod_tip_calc               = param_calc_cta.cod_tip_calc
                   param_calc_bem_pat.cod_cenar_ctbl             = param_calc_cta.cod_cenar_ctbl
                   param_calc_bem_pat.cod_finalid_econ           = param_calc_cta.cod_finalid_econ
                   param_calc_bem_pat.num_id_bem_pat             = bem_pat.num_id_bem_pat
                   param_calc_bem_pat.dat_inic_calc              = v_dat_desmbrto
                   param_calc_bem_pat.cod_grp_calc               = param_calc_cta.cod_grp_calc
                   param_calc_bem_pat.qtd_anos_vida_util         = param_calc_cta.qtd_anos_vida_util
                   param_calc_bem_pat.qtd_unid_vida_util         = param_calc_cta.qtd_unid_vida_util
                   param_calc_bem_pat.val_perc_anual_dpr         = param_calc_cta.val_perc_anual_dpr
                   param_calc_bem_pat.val_perc_anual_dpr_incevda = param_calc_cta.val_perc_anual_dpr_incevda.

            find first b_param_calc_bem_pat_orig no-lock
                 where b_param_calc_bem_pat_orig.num_id_bem_pat   = b_bem_pat.num_id_bem_pat
                   and b_param_calc_bem_pat_orig.cod_tip_calc     = param_calc_bem_pat.cod_tip_calc
                   and b_param_calc_bem_pat_orig.cod_cenar_ctbl   = param_calc_bem_pat.cod_cenar_ctbl
                   and b_param_calc_bem_pat_orig.cod_finalid_econ = param_calc_bem_pat.cod_finalid_econ no-error.
            if avail b_param_calc_bem_pat_orig then do:

                assign param_calc_bem_pat.val_resid_min = b_param_calc_bem_pat_orig.val_resid_min - (b_param_calc_bem_pat_orig.val_resid_min * (1 - (tt_desmembrto_bem_pat.tta_val_perc_movto_bem_pat / 100))).

            end. 


        if tt_desmembrto_bem_pat.ttv_log_busca_orig then do:
            for each param_calc_bem_pat no-lock
                where param_calc_bem_pat.num_id_bem_pat   = b_bem_pat.num_id_bem_pat:

                find first b_param_calc_bem_pat exclusive-lock
                    where b_param_calc_bem_pat.num_id_bem_pat   = bem_pat.num_id_bem_pat
                      and b_param_calc_bem_pat.cod_tip_calc     = param_calc_bem_pat.cod_tip_calc
                      and b_param_calc_bem_pat.cod_cenar_ctbl   = param_calc_bem_pat.cod_cenar_ctbl
                      and b_param_calc_bem_pat.cod_finalid_econ = param_calc_bem_pat.cod_finalid_econ no-error.
                if avail b_param_calc_bem_pat then do:
                    assign b_param_calc_bem_pat.qtd_anos_vida_util         = param_calc_bem_pat.qtd_anos_vida_util
                           b_param_calc_bem_pat.qtd_unid_vida_util         = param_calc_bem_pat.qtd_unid_vida_util
                           b_param_calc_bem_pat.val_perc_anual_dpr         = param_calc_bem_pat.val_perc_anual_dpr
                           b_param_calc_bem_pat.val_perc_anual_dpr_incevda =param_calc_bem_pat.val_perc_anual_dpr_incevda.
                    if v_log_funcao_reduc_sdo = yes then
                        assign b_param_calc_bem_pat.val_perc_anual_reduc_sdo = param_calc_bem_pat.val_perc_anual_reduc_sdo.
                end.
            end.
        end.

        aloc_bem_block:
        for each b_aloc_bem no-lock
            where b_aloc_bem.num_id_bem_pat = b_bem_pat.num_id_bem_pat
              and b_aloc_bem.dat_inic_valid >= v_dat_desmbrto :
            create aloc_bem.
            assign aloc_bem.num_id_bem_pat   = bem_pat.num_id_bem_pat
                   aloc_bem.cod_empresa      = b_aloc_bem.cod_empresa
                   aloc_bem.cod_plano_ccusto = b_aloc_bem.cod_plano_ccusto
                   aloc_bem.cod_ccusto       = b_aloc_bem.cod_ccusto
                   aloc_bem.cod_unid_negoc   = b_aloc_bem.cod_unid_negoc
                   aloc_bem.val_perc_aprop   = b_aloc_bem.val_perc_aprop
                   aloc_bem.dat_fim_valid    = b_aloc_bem.dat_fim_valid
                   aloc_bem.dat_inic_valid   = b_aloc_bem.dat_inic_valid.
            validate aloc_bem.
        end /* for aloc_bem_block */.

        cronog_calc_pat_block:
        for each b_cronog_calc_pat no-lock
            where b_cronog_calc_pat.num_id_bem_pat = b_bem_pat.num_id_bem_pat
              and b_cronog_calc_pat.dat_fim_parada >= v_dat_desmbrto :
            create cronog_calc_pat.
            assign cronog_calc_pat.num_id_bem_pat  = bem_pat.num_id_bem_pat
                   cronog_calc_pat.cod_tip_calc    = b_cronog_calc_pat.cod_tip_calc
                   cronog_calc_pat.cod_cenar_ctbl  = b_cronog_calc_pat.cod_cenar_ctbl
                   cronog_calc_pat.dat_inic_parada = b_cronog_calc_pat.dat_inic_parada
                   cronog_calc_pat.dat_fim_parada  = b_cronog_calc_pat.dat_fim_parada
                   cronog_calc_pat.cod_grp_calc    = b_cronog_calc_pat.cod_grp_calc
                   cronog_calc_pat.des_anot_tab    = b_cronog_calc_pat.des_anot_tab.
            validate cronog_calc_pat.
        end /* for cronog_calc_pat_block */.

        quant_produz_block:
        for each b_quant_produz no-lock
            where b_quant_produz.num_id_bem_pat = b_bem_pat.num_id_bem_pat
             and b_quant_produz.dat_refer >= v_dat_desmbrto :
            create quant_produz.
            assign quant_produz.num_id_bem_pat   = bem_pat.num_id_bem_pat
                   quant_produz.cod_unid_negoc   = b_quant_produz.cod_unid_negoc
                   quant_produz.cod_empresa      = b_quant_produz.cod_empresa
                   quant_produz.cod_plano_ccusto = b_quant_produz.cod_plano_ccusto
                   quant_produz.cod_ccusto       = b_quant_produz.cod_ccusto
                   quant_produz.dat_refer        = b_quant_produz.dat_refer
                   quant_produz.qtd_unid_produz  = b_quant_produz.qtd_unid_produz.
            validate quant_produz.
        end /* for quant_produz_block */.

        run pi_implantar_bem_pat_desmbrto_more_1.
    end.
END PROCEDURE. /* pi_implantar_bem_pat_desmbrto_more */
/*****************************************************************************
** Procedure Interna.....: pi_incrementa_bem_pat
** Descricao.............: pi_incrementa_bem_pat
** Criado por............: 
** Criado em.............: // 
** Alterado por..........: fut41422
** Alterado em...........: 08/01/2018 11:06:52
*****************************************************************************/
PROCEDURE pi_incrementa_bem_pat:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_empresa
        as character
        format "x(3)"
        no-undo.
    def Input param p_cod_cta_pat
        as character
        format "x(18)"
        no-undo.
    def Input param p_cod_estab
        as character
        format "x(5)"
        no-undo.
    def output param p_num_bem_pat
        as integer
        format ">>>>>>>>9"
        no-undo.
    def input-output param p_num_seq_bem_pat
        as integer
        format ">>>>9"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_log_return
        as logical
        format "Sim/N∆o"
        initial no
        no-undo.


    /************************** Variable Definition End *************************/

    find last param_geral_pat no-lock no-error.
    if  param_geral_pat.ind_numer_niv = "Global" /*l_global*/ 
    then do:
       find last b_bem_pat_proximo no-lock

    &if "{&emsfin_version}" >= "5.01" &then
            use-index bempat_bem
    &endif
             /*cl_ultimo_bem_global of b_bem_pat_proximo*/ no-error.
    end /* if */.
    else do:
       if  param_geral_pat.ind_numer_niv = "Por Empresa" /*l_por_empresa*/ 
       then do:
          find last b_bem_pat_proximo no-lock
               where b_bem_pat_proximo.cod_empresa = p_cod_empresa
    &if "{&emsfin_version}" >= "5.01" &then
               use-index bempat_emp
    &endif
                /*cl_ultimo_bem_empresa of b_bem_pat_proximo*/ no-error.
       end /* if */.
       else do:
          if  param_geral_pat.ind_numer_niv = "Por Conta" /*l_por_conta*/ 
          then do:
             find last b_bem_pat_proximo no-lock
                  where b_bem_pat_proximo.cod_empresa = p_cod_empresa
                    and b_bem_pat_proximo.cod_cta_pat = p_cod_cta_pat
    &if "{&emsfin_version}" >= "5.01" &then
                  use-index bempat_id
    &endif
                   /*cl_ultimo_bem_conta of b_bem_pat_proximo*/ no-error.
          end /* if */.
          else do:
             if  param_geral_pat.ind_numer_niv = "Por Estabelecimento" /*l_por_estabelecimento*/ 
             then do:
                find last b_bem_pat_proximo no-lock
                     where b_bem_pat_proximo.cod_estab = p_cod_estab
    &if "{&emsfin_version}" >= "5.01" &then
                     use-index bempat_estab
    &endif
                      /*cl_ultimo_bem_estab of b_bem_pat_proximo*/ no-error.
             end /* if */.
          end /* else */.
       end /* else */.
    end /* else */.




    if  avail param_geral_pat  and param_geral_pat.log_numer_autom
    then do:
        if  available b_bem_pat_proximo
        then do:
            assign p_num_bem_pat = b_bem_pat_proximo.num_bem_pat + 1
                   p_num_seq_bem_pat = b_bem_pat_proximo.num_seq_bem_pat.
            if  p_num_bem_pat > 999999999 then
                run pi_incrementa_primeiro_num_bem_pat_livre (Input p_cod_empresa,
                                                              Input p_cod_cta_pat,
                                                              Input p_cod_estab,
                                                              output p_num_bem_pat,
                                                              input-output p_num_seq_bem_pat) /*pi_incrementa_primeiro_num_bem_pat_livre*/.
        end /* if */.
        else
           assign p_num_bem_pat = 1.
    end /* if */.
    else do:
          assign p_num_bem_pat = 1.
          run pi_verifica_bem_existente (Input p_cod_empresa,
                                         Input p_cod_cta_pat,
                                         Input p_cod_estab,
                                         input p_num_bem_pat,
                                         input p_num_seq_bem_pat,
                                         output v_log_return) /*pi_verifica_bem_existente*/.
          if  v_log_return
          then do: 
              run pi_incrementa_primeiro_num_bem_pat_livre (Input p_cod_empresa,
                                                            Input p_cod_cta_pat,
                                                            Input p_cod_estab,
                                                            output p_num_bem_pat,
                                                            input-output p_num_seq_bem_pat) /*pi_incrementa_primeiro_num_bem_pat_livre*/.
          end /* if */.
    end /* else */.


END PROCEDURE. /* pi_incrementa_bem_pat */
/*****************************************************************************
** Procedure Interna.....: pi_incrementa_primeiro_num_bem_pat_livre
** Descricao.............: pi_incrementa_primeiro_num_bem_pat_livre
** Criado por............: fut1228
** Criado em.............: 18/04/2005 14:43:09
** Alterado por..........: danielidk
** Alterado em...........: 13/05/2015 17:33:55
*****************************************************************************/
PROCEDURE pi_incrementa_primeiro_num_bem_pat_livre:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_empresa
        as character
        format "x(3)"
        no-undo.
    def Input param p_cod_cta_pat
        as character
        format "x(18)"
        no-undo.
    def Input param p_cod_estab
        as character
        format "x(5)"
        no-undo.
    def output param p_num_bem_pat
        as integer
        format ">>>>>>>>9"
        no-undo.
    def input-output param p_num_seq_bem_pat
        as integer
        format ">>>>9"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_num_bem_pat_fim
        as integer
        format ">>>>>>>>9":U
        initial 999999999
        label "Bem Final"
        column-label "Bem"
        no-undo.
    def var v_num_bem_pat_inic
        as integer
        format ">>>>>>>>9":U
        label "Bem Inicial"
        no-undo.
    def var v_num_bem_pat_novo
        as integer
        format ">>>>>>>>9":U
        label "Novo N£mero Bem"
        column-label "Novo N£mero Bem"
        no-undo.
    def var v_num_seq_bem_pat
        as integer
        format ">>>>9":U
        initial 0
        label "Sequància Bem"
        column-label "Sequància"
        no-undo.


    /************************** Variable Definition End *************************/

    find last param_geral_pat no-lock no-error.
    Assign v_num_seq_bem_pat = p_num_seq_bem_pat
           v_num_bem_pat_inic = 0.
    if avail param_geral_pat and param_geral_pat.log_numer_autom then 
        assign v_num_bem_pat_novo = 0.
    else
        assign v_num_bem_pat_novo = 1.
    do v_num_bem_pat_inic = v_num_bem_pat_novo to v_num_bem_pat_fim:
        if  param_geral_pat.ind_numer_niv = "Global" /*l_global*/ 
        then do:
            find first b_bem_pat_proximo no-lock
                where b_bem_pat_proximo.num_bem_pat = v_num_bem_pat_inic
                and   b_bem_pat_proximo.num_seq_bem_pat = v_num_seq_bem_pat

                use-index bempat_bem
            no-error.
        end /* if */.
        else do:
            if  param_geral_pat.ind_numer_niv = "Por Empresa" /*l_por_empresa*/ 
            then do: 
                find first b_bem_pat_proximo no-lock
                     where b_bem_pat_proximo.cod_empresa = p_cod_empresa
                       and b_bem_pat_proximo.num_bem_pat = v_num_bem_pat_inic
                       and b_bem_pat_proximo.num_seq_bem_pat = v_num_seq_bem_pat
                       use-index bempat_emp
                no-error.
            end /* if */.
            else do:
                if  param_geral_pat.ind_numer_niv = "Por Conta" /*l_por_conta*/ 
                then do: 
                    find first b_bem_pat_proximo no-lock
                         where b_bem_pat_proximo.cod_empresa = p_cod_empresa 
                           and b_bem_pat_proximo.cod_cta_pat = p_cod_cta_pat
                           and b_bem_pat_proximo.num_bem_pat = v_num_bem_pat_inic
                           and b_bem_pat_proximo.num_seq_bem_pat = v_num_seq_bem_pat
                           use-index bempat_id
                    no-error.
                end /* if */.
                else do:
                    if  param_geral_pat.ind_numer_niv = "Por Estabelecimento" /*l_por_estabelecimento*/ 
                    then do:
                        find first b_bem_pat_proximo no-lock
                             where b_bem_pat_proximo.cod_estab = p_cod_estab
                               and b_bem_pat_proximo.num_bem_pat = v_num_bem_pat_inic
                               and b_bem_pat_proximo.num_seq_bem_pat = v_num_seq_bem_pat
                             use-index bempat_estab
                        no-error.
                    end /* if */.
                end /* else */.
            end /* else */.
        end /* else */.

        if not avail b_bem_pat_proximo
        then do:
          assign p_num_bem_pat = v_num_bem_pat_inic
                 p_num_seq_bem_pat = v_num_seq_bem_pat. 
          leave. 
        end /* if */.

        if  v_num_bem_pat_inic = 999999999 then
            assign v_num_bem_pat_inic = 0
                   v_num_seq_bem_pat = v_num_seq_bem_pat + 1.

        if  v_num_seq_bem_pat > 99999 then
            assign v_num_seq_bem_pat = 0.      
    End.
END PROCEDURE. /* pi_incrementa_primeiro_num_bem_pat_livre */
/*****************************************************************************
** Procedure Interna.....: pi_add_bem_pat_desmembramento
** Descricao.............: pi_add_bem_pat_desmembramento
** Criado por............: Puccini
** Criado em.............: 21/08/1998 10:49:05
** Alterado por..........: fut41422
** Alterado em...........: 07/06/2017 15:29:07
*****************************************************************************/
PROCEDURE pi_add_bem_pat_desmembramento:

    inclui_block:
    do on error undo inclui_block, leave inclui_block on endkey undo inclui_block, leave inclui_block:
        find first tt_desmembrto_bem_pat no-lock no-error.
        if  not avail tt_desmembrto_bem_pat
        then do:
            find bem_pat no-lock
                 where bem_pat.cod_empresa = v_cod_empres_usuar
                   and bem_pat.cod_cta_pat = input frame f_dlg_03_bem_pat_desmembramento b_bem_pat.cod_cta_pat
                   and bem_pat.num_bem_pat = input frame f_dlg_03_bem_pat_desmembramento b_bem_pat.num_bem_pat
                   and bem_pat.num_seq_bem_pat = input frame f_dlg_03_bem_pat_desmembramento b_bem_pat.num_seq_bem_pat no-error. 

            if avail bem_pat then do:
                if  v_log_funcao_congel_cenar_ctbl = yes
                then do:
                    &IF INTEGER(ENTRY(1,PROVERSION,".")) >= 9 &THEN
                        EMPTY TEMP-TABLE tt_bem_pat_cong NO-ERROR.
                    &ELSE
                        FOR EACH tt_bem_pat_cong:
                            DELETE tt_bem_pat_cong.
                        END.
                    &ENDIF

                    CREATE tt_bem_pat_cong.
                    ASSIGN tt_bem_pat_cong.tta_num_id_bem_pat = bem_pat.num_id_bem_pat
                           tt_bem_pat_cong.ttv_dat_movto = input frame f_dlg_03_bem_pat_desmembramento v_dat_desmbrto
                           tt_bem_pat_cong.ttv_ind_tip_param = "B" /*l_b*/ .
                end /* if */.

                    run prgfin/fgl/fgl721za.py (Input table tt_bem_pat_cong,
                                            Input v_cod_empres_usuar,
                                            Input "FAS" /*l_fas*/,
                                            Input input frame f_dlg_03_bem_pat_desmembramento v_dat_desmbrto,
                                            output v_cod_return_sit,
                                            output table tt_erros_cenario) /*prg_fnc_consiste_cenar_ctbl*/.

                if  v_cod_return_sit <> "" and not can-do(v_cod_return_sit,"Habilitado" /*l_habilitado*/ )
                then do:
                    /* Data &1 est† em per°odo desabilitado ! */
                    run pi_messages (input "show",
                                     input 872,
                                     input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                        input frame f_dlg_03_bem_pat_desmembramento v_dat_desmbrto)) /*msg_872*/.
                    apply "entry" to v_dat_desmbrto in frame f_dlg_03_bem_pat_desmembramento.
                    undo inclui_block, leave inclui_block.
                end /* if */.
                else do:
                    if  can-find(first tt_erros_cenario)
                    then do:
                        run prgint/utb/utb912zj.py (Input 1,
                                                    Input table tt_erros_cenario) /*prg_api_mostra_erros_atualiz_cenarios*/.
                        apply "entry" to v_dat_desmbrto in frame f_dlg_03_bem_pat_desmembramento.
                        undo inclui_block, leave inclui_block.
                    end /* if */.
                end /* else */.

                assign v_qtd_bem_pat_represen = bem_pat.qtd_bem_pat_represen.
            end.

            param_calc_bem_pat_block:
            for each param_calc_bem_pat no-lock
             where param_calc_bem_pat.num_id_bem_pat = b_bem_pat.num_id_bem_pat /*cl_dlg_03_bem_pat_desmembramento of param_calc_bem_pat*/:
                run pi_sit_movimen_pat (Input recid(param_calc_bem_pat),
                                        Input input frame f_dlg_03_bem_pat_desmembramento v_dat_desmbrto,
                                        output v_log_return,
                                        output v_dat_return) /*pi_sit_movimen_pat*/.
                if  v_log_return = no
                then do:
                    /* Data &1 est† fora do per°odo de movimentaá∆o patrimonial ! */
                    run pi_messages (input "show",
                                     input 394,
                                     input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                        input frame f_dlg_03_bem_pat_desmembramento v_dat_desmbrto)) /*msg_394*/.
                    apply "entry" to v_dat_desmbrto in frame f_dlg_03_bem_pat_desmembramento.
                    undo inclui_block, leave inclui_block.
                end /* if */.
            end /* for param_calc_bem_pat_block */.
            if  input frame f_dlg_03_bem_pat_desmembramento cb_desmembramento_bem_pat = "Por Valor" /*l_por_valor*/ 
            then do:
                run pi_add_bem_pat_desmembramento_1.
                if return-value = 'NOK' then undo inclui_block, leave inclui_block.
            end /* if */.
            else do:
                run pi_retornar_finalid_econ_corren_estab (Input b_bem_pat.cod_estab,
                                                           output v_cod_finalid_econ) /*pi_retornar_finalid_econ_corren_estab*/.

                find last val_origin_bem_pat no-lock
                     where val_origin_bem_pat.num_id_bem_pat = b_bem_pat.num_id_bem_pat
                       and val_origin_bem_pat.num_seq_incorp_bem_pat = 0
                       and val_origin_bem_pat.cod_finalid_econ = v_cod_finalid_econ
                      no-error.

                if  not avail val_origin_bem_pat
                then do:
                    /* Valor Original inexistente para o bem nesta moeda e cen†rio ! */
                    run pi_messages (input "show",
                                     input 769,
                                     input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_769*/.
                    apply "entry" to b_bem_pat.cod_cta_pat in frame f_dlg_03_bem_pat_desmembramento.
                    undo inclui_block, leave inclui_block.
                end /* if */.
                /* valida se o bem tem contrato de leasing, e se o fim desse contrato Ç menor que a data do movimento,
                   se for, ir† se validado se o bem tem registro de c†lculo de implantaá∆o por aquisiá∆o, caso n∆o
                   tenha ir† apresentar uma messagem, avisando que o usu†rio tem que gerar os calculos de apropriaá∆o
                   de leasing antes de fazer a movimentaá∆o */
                find first contrat_leas where 
                    contrat_leas.cod_contrat_leas = b_bem_pat.cod_contrat_leas and
                    contrat_leas.cod_arrendador = b_bem_pat.cod_arrendador no-lock no-error.
                if  avail contrat_leas
                then do: 
                    if  contrat_leas.dat_fim_valid <= input frame f_dlg_03_bem_pat_desmembramento v_dat_desmbrto
                    then do: 
                        if  not(can-find(first reg_calc_bem_pat where 
                                reg_calc_bem_pat.num_id_bem_pat = b_bem_pat.num_id_bem_pat and
                                reg_calc_bem_pat.ind_trans_calc_bem_pat = "Implantaá∆o" /*l_implantacao*/ ))
                        then do:
                            /* Bem com contrato de leasing sem apropriaá∆o. */
                            run pi_messages (input "show",
                                             input 9160,
                                             input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_9160*/.
                            assign v_wgh_focus = v_dat_desmbrto:handle in frame f_dlg_03_bem_pat_desmembramento.
                            undo inclui_block, leave inclui_block.
                        end /* if */.        
                    end /* if */.        
                end /* if */.
                assign v_val_origin_bem_pat = val_origin_bem_pat.val_original
                       v_val_original_cal  = val_origin_bem_pat.val_original
                       v_val_despes_financ = val_origin_bem_pat.val_despes_financ.

                acumula_incorp_bem_pa_block:
                for each incorp_bem_pat no-lock
                 where incorp_bem_pat.num_id_bem_pat = b_bem_pat.num_id_bem_pat /*cl_dlg_03_bem_pat_desmembramento of incorp_bem_pat*/:
                    find last val_origin_bem_pat no-lock
                         where val_origin_bem_pat.num_id_bem_pat = b_bem_pat.num_id_bem_pat
                           and val_origin_bem_pat.num_seq_incorp_bem_pat = incorp_bem_pat.num_seq_incorp_bem_pat
                           and val_origin_bem_pat.cod_finalid_econ = v_cod_finalid_econ /* cl_dlg_03_bem_pat_desmembr_finalid of val_origin_bem_pat*/
                          no-error.
                    if  avail val_origin_bem_pat
                    then do:
                        assign v_val_original_cal  = v_val_original_cal  + val_origin_bem_pat.val_original
                               v_val_despes_financ = v_val_despes_financ + val_origin_bem_pat.val_despes_financ.
                    end /* if */.
                end /* for acumula_incorp_bem_pa_block */.
            end /* else */.
        end /* if */.

        run pi_implantar_bem_pat_desmbrto /*pi_implantar_bem_pat_desmbrto*/.
        if not can-find(first tt_desmembrto_bem_pat
                        where tt_desmembrto_bem_pat.tta_cod_cta_pat <> "") then do:
            empty temp-table tt_desmembrto_bem_pat.
        end.
END PROCEDURE. /* pi_add_bem_pat_desmembramento */
/*****************************************************************************
** Procedure Interna.....: pi_validar_param_ctbz_cta_pat
** Descricao.............: pi_validar_param_ctbz_cta_pat
** Criado por............: Puccini
** Criado em.............: 29/12/1998 08:55:28
** Alterado por..........: src12337
** Alterado em...........: 28/02/2002 16:37:08
*****************************************************************************/
PROCEDURE pi_validar_param_ctbz_cta_pat:

    /************************ Parameter Definition Begin ************************/

    def param buffer p_bem_pat
        for bem_pat.
    def Input param p_dat_movto_bem_pat
        as date
        format "99/99/9999"
        no-undo.
    def output param p_cod_return
        as character
        format "x(40)"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_cod_ccusto
        as Character
        format "x(20)":U
        label "Centro Custo"
        column-label "Centro Custo"
        no-undo.
    def var v_cod_cta_ctbl
        as character
        format "x(20)":U
        label "Conta Cont†bil"
        column-label "Conta Cont†bil"
        no-undo.
    def var v_cod_plano_ccusto
        as character
        format "x(8)":U
        label "Plano CCusto"
        column-label "Plano CCusto"
        no-undo.
    def var v_cod_plano_cta_ctbl
        as character
        format "x(8)":U
        label "Plano Contas"
        column-label "Plano Contas"
        no-undo.
    def var v_cod_unid_negoc
        as character
        format "x(3)":U
        label "Unid Neg¢cio"
        column-label "Un Neg"
        no-undo.
    def var v_ind_finalid_ctbl
        as character
        format "X(30)":U
        label "Finalidade Cont†bil"
        column-label "Finalidade Cont†bil"
        no-undo.
    def var v_log_return
        as logical
        format "Sim/N∆o"
        initial no
        no-undo.
    def var v_num_mensagem
        as integer
        format ">>>>,>>9":U
        label "N£mero"
        column-label "N£mero Mensagem"
        no-undo.


    /************************** Variable Definition End *************************/

    blk_param:
    for each param_calc_bem_pat
        where param_calc_bem_pat.num_id_bem_pat = p_bem_pat.num_id_bem_pat
        and   param_calc_bem_pat.cod_tip_calc  <> ""
        no-lock:

        find finalid_econ
            where finalid_econ.cod_finalid_econ = param_calc_bem_pat.cod_finalid_econ
            no-lock no-error.
        if  avail finalid_econ and
            finalid_econ.ind_armaz_val = "Ativo Fixo" /*l_ativo_fixo*/ 
        then do:
            next blk_param.
        end /* if */.

        find tip_calc
            where tip_calc.cod_tip_calc = param_calc_bem_pat.cod_tip_calc
            no-lock no-error.
        if  not avail tip_calc
        then do:
            next blk_param.
        end /* if */.

        find first param_ctbz_cta_pat no-lock
            where param_ctbz_cta_pat.cod_empresa      = p_bem_pat.cod_empresa
            and   param_ctbz_cta_pat.cod_cta_pat      = p_bem_pat.cod_cta_pat
            and   param_ctbz_cta_pat.cod_cenar_ctbl   = param_calc_bem_pat.cod_cenar_ctbl
            and   param_ctbz_cta_pat.cod_finalid_econ = param_calc_bem_pat.cod_finalid_econ
            and   param_ctbz_cta_pat.ind_finalid_ctbl = tip_calc.ind_tip_calc
            and   param_ctbz_cta_pat.dat_inic_valid  <= p_dat_movto_bem_pat
            and   param_ctbz_cta_pat.dat_fim_valid   >= p_dat_movto_bem_pat
            no-error.

        if  not avail param_ctbz_cta_pat
        then do:
            assign p_cod_return = "1111" + chr(10) + p_bem_pat.cod_cta_pat + chr(10) + tip_calc.ind_tip_calc + chr(10) +
                                  param_calc_bem_pat.cod_finalid_econ + chr(10) + param_calc_bem_pat.cod_cenar_ctbl.
            return "NOK" /*l_nok*/ .
        end /* if */.

        if  tip_calc.ind_tip_calc = "Depreciaá∆o" /*l_depreciacao*/  or
            tip_calc.ind_tip_calc = "Amortizaá∆o" /*l_amortizacao*/ 
        then do:

            if  not can-find(first aloc_bem where aloc_bem.num_id_bem_pat = p_bem_pat.num_id_bem_pat)
            then do:
                run pi_validar_cta_ctbl_distrib_ccusto_1 (Input p_bem_pat.cod_empresa,
                                                          Input p_bem_pat.cod_estab,
                                                          Input param_ctbz_cta_pat.cod_plano_cta_ctbl,
                                                          Input param_ctbz_cta_pat.cod_cta_ctbl_db,
                                                          Input p_bem_pat.cod_plano_ccusto,
                                                          Input p_bem_pat.cod_ccusto_respons,
                                                          Input p_dat_movto_bem_pat,
                                                          output v_log_return,
                                                          output v_cod_return) /*pi_validar_cta_ctbl_distrib_ccusto_1*/.
                if  v_log_return <> yes
                then do:
                    assign p_cod_return = "3347" + chr(10) + param_ctbz_cta_pat.cod_cta_ctbl_db + chr(10) +
                                          p_bem_pat.cod_ccusto_respons.
                    return "NOK" /*l_nok*/ .
                end /* if */.
                run pi_validar_ccusto_unid_negoc_estab (Input p_bem_pat.cod_empresa,
                                                        Input p_bem_pat.cod_plano_ccusto,
                                                        Input p_bem_pat.cod_ccusto_respons,
                                                        Input p_bem_pat.cod_unid_negoc,
                                                        Input p_bem_pat.cod_estab,
                                                        output v_num_mensagem) /*pi_validar_ccusto_unid_negoc_estab*/.
                /* error_block: */
                case v_num_mensagem:
                    when 950 then
                        erro_950:
                        do:
                            assign p_cod_return = "950" + chr(10) + p_bem_pat.cod_unid_negoc + chr(10) + p_bem_pat.cod_estab.
                            return "NOK" /*l_nok*/ .
                        end /* do erro_950 */.
                    when 1253 then
                        erro_1253:
                        do:
                            assign p_cod_return = "1253" + chr(10) + p_bem_pat.cod_ccusto_respons + chr(10) + p_bem_pat.cod_unid_negoc.
                            return "NOK" /*l_nok*/ .
                        end /* do erro_1253 */.
                    when 1388 then
                        erro_1388:
                        do:
                            assign p_cod_return = "5729" + chr(10) + p_bem_pat.cod_ccusto_respons + chr(10) + p_bem_pat.cod_estab.
                            return "NOK" /*l_nok*/ .
                        end /* do erro_1388 */.
                end /* case error_block */.
            end /* if */.
            else do:
                blk_aloc:
                for each aloc_bem no-lock
                    where aloc_bem.num_id_bem_pat = p_bem_pat.num_id_bem_pat:
                    if  aloc_bem.dat_inic_valid <= p_dat_movto_bem_pat and
                         aloc_bem.dat_fim_valid  >= p_dat_movto_bem_pat
                    then do:

                        run pi_validar_cta_ctbl_distrib_ccusto_1 (Input p_bem_pat.cod_empresa,
                                                                  Input p_bem_pat.cod_estab,
                                                                  Input param_ctbz_cta_pat.cod_plano_cta_ctbl,
                                                                  Input param_ctbz_cta_pat.cod_cta_ctbl_db,
                                                                  Input aloc_bem.cod_plano_ccusto,
                                                                  Input aloc_bem.cod_ccusto,
                                                                  Input p_dat_movto_bem_pat,
                                                                  output v_log_return,
                                                                  output v_cod_return) /*pi_validar_cta_ctbl_distrib_ccusto_1*/.
                        if  v_log_return <> yes
                        then do:
                            assign p_cod_return = "3347" + chr(10) + param_ctbz_cta_pat.cod_cta_ctbl_db + chr(10) +
                                                  aloc_bem.cod_ccusto.
                            return "NOK" /*l_nok*/ .
                        end /* if */.
                        run pi_validar_ccusto_unid_negoc_estab (Input p_bem_pat.cod_empresa,
                                                                Input aloc_bem.cod_plano_ccusto,
                                                                Input aloc_bem.cod_ccusto,
                                                                Input aloc_bem.cod_unid_negoc,
                                                                Input p_bem_pat.cod_estab,
                                                                output v_num_mensagem) /*pi_validar_ccusto_unid_negoc_estab*/.
                        /* error_block: */
                        case v_num_mensagem:
                            when 950 then
                                erro_950:
                                do:
                                    assign p_cod_return = "950" + chr(10) + aloc_bem.cod_unid_negoc + chr(10) + p_bem_pat.cod_estab.
                                    return "NOK" /*l_nok*/ .
                                end /* do erro_950 */.
                            when 1253 then
                                erro_1253:
                                do:
                                    assign p_cod_return = "1253" + chr(10) + aloc_bem.cod_ccusto + chr(10) + aloc_bem.cod_unid_negoc.
                                    return "NOK" /*l_nok*/ .
                                end /* do erro_1253 */.
                            when 1388 then
                                erro_1388:
                                do:
                                    assign p_cod_return = "5729" + chr(10) + aloc_bem.cod_ccusto + chr(10) + p_bem_pat.cod_estab.
                                    return "NOK" /*l_nok*/ .
                                end /* do erro_1388 */.
                        end /* case error_block */.
                    end /* if */.                
                end /* for blk_aloc */.
            end /* if */.

            if  tip_calc.cod_tip_calc_cm_dpr <> ""
            then do:        
                assign v_ind_finalid_ctbl = if tip_calc.ind_tip_calc = "Depreciaá∆o" /*l_depreciacao*/  then "CM Depreciaá∆o" /*l_cm_depreciacao*/  else "CM Amortizaá∆o" /*l_cm_amortizacao*/ .
                find first param_ctbz_cta_pat no-lock
                    where param_ctbz_cta_pat.cod_empresa      = p_bem_pat.cod_empresa
                    and   param_ctbz_cta_pat.cod_cta_pat      = p_bem_pat.cod_cta_pat
                    and   param_ctbz_cta_pat.cod_cenar_ctbl   = param_calc_bem_pat.cod_cenar_ctbl
                    and   param_ctbz_cta_pat.cod_finalid_econ = param_calc_bem_pat.cod_finalid_econ
                    and   param_ctbz_cta_pat.ind_finalid_ctbl = v_ind_finalid_ctbl
                    and   param_ctbz_cta_pat.dat_inic_valid  <= p_dat_movto_bem_pat
                    and   param_ctbz_cta_pat.dat_fim_valid   >= p_dat_movto_bem_pat
                    no-error.

                if  not avail param_ctbz_cta_pat
                then do:
                    assign p_cod_return = "1111" + chr(10) + p_bem_pat.cod_cta_pat + chr(10) + v_ind_finalid_ctbl + chr(10) +
                                          param_calc_bem_pat.cod_finalid_econ + chr(10) + param_calc_bem_pat.cod_cenar_ctbl.
                    return "NOK" /*l_nok*/ .
                end /* if */.
            end /* if */.
        end /* if */.
    end /* for blk_param */.
    return "OK" /*l_ok*/ .
END PROCEDURE. /* pi_validar_param_ctbz_cta_pat */
/*****************************************************************************
** Procedure Interna.....: pi_validar_cta_ctbl_distrib_ccusto
** Descricao.............: pi_validar_cta_ctbl_distrib_ccusto
** Criado por............: Henke
** Criado em.............: // 
** Alterado por..........: Puccini
** Alterado em...........: 02/02/1999 16:19:58
*****************************************************************************/
PROCEDURE pi_validar_cta_ctbl_distrib_ccusto:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_empresa
        as character
        format "x(3)"
        no-undo.
    def Input param p_cod_estab
        as character
        format "x(5)"
        no-undo.
    def Input param p_cod_plano_cta_ctbl
        as character
        format "x(8)"
        no-undo.
    def Input param p_cod_cta_ctbl
        as character
        format "x(20)"
        no-undo.
    def Input param p_cod_plano_ccusto
        as character
        format "x(8)"
        no-undo.
    def Input param p_cod_ccusto
        as Character
        format "x(20)"
        no-undo.
    def Input param p_dat_refer_ent
        as date
        format "99/99/9999"
        no-undo.
    def output param p_log_return
        as logical
        format "Sim/N∆o"
        no-undo.


    /************************* Parameter Definition End *************************/


    assign p_log_return = no.
    if  p_dat_refer_ent = ?
    then do:
        find last criter_distrib_cta_ctbl no-lock
             where criter_distrib_cta_ctbl.cod_plano_cta_ctbl = p_cod_plano_cta_ctbl
               and criter_distrib_cta_ctbl.cod_cta_ctbl = p_cod_cta_ctbl
               and criter_distrib_cta_ctbl.cod_estab = p_cod_estab /*cl_verificar_cta_ctbl_utiliz_ccusto of criter_distrib_cta_ctbl*/ no-error.
    end /* if */.
    else do:
        find first criter_distrib_cta_ctbl no-lock
             where criter_distrib_cta_ctbl.cod_plano_cta_ctbl = p_cod_plano_cta_ctbl
               and criter_distrib_cta_ctbl.cod_cta_ctbl = p_cod_cta_ctbl
               and criter_distrib_cta_ctbl.cod_estab = p_cod_estab
               and criter_distrib_cta_ctbl.dat_inic_valid <= p_dat_refer_ent
               and criter_distrib_cta_ctbl.dat_fim_valid > p_dat_refer_ent /*cl_verificar_cta_ctbl_utiliz_ccusto_dat of criter_distrib_cta_ctbl*/ no-error.
    end /* else */.

    if  not avail criter_distrib_cta_ctbl
    then do:
       return.
    end /* if */.
    if  (avail plano_ccusto) and
         plano_ccusto.cod_empresa = p_cod_empresa and
         plano_ccusto.cod_plano_ccusto = p_cod_plano_ccusto
    then do:
       run pi_retornar_ccusto_inic (Input plano_ccusto.cod_format_ccusto,
                                    output v_cod_ccusto_000) /*pi_retornar_ccusto_inic*/.
    end /* if */.
    else do:
      find plano_ccusto no-lock
           where plano_ccusto.cod_empresa = p_cod_empresa
             and plano_ccusto.cod_plano_ccusto = p_cod_plano_ccusto /*cl_valida_plano of plano_ccusto*/ no-error.
      if  avail plano_ccusto
      then do:
         run pi_retornar_ccusto_inic (Input plano_ccusto.cod_format_ccusto,
                                      output v_cod_ccusto_000) /*pi_retornar_ccusto_inic*/.
      end /* if */.
      else do:
         return.
      end /* else */.
    end /* else */.
    if  criter_distrib_cta_ctbl.ind_criter_distrib_ccusto = "N∆o Utiliza" /*l_nao_utiliza*/ 
    or  criter_distrib_cta_ctbl.ind_criter_distrib_ccusto = "Autom†tica" /*l_automatica*/ 
    then do:
        if  (p_cod_plano_ccusto <> ?
        and   p_cod_plano_ccusto <> "")
        or  (p_cod_ccusto <> v_cod_ccusto_000)
        then do:
            return.
        end /* if */.
        else do:
            assign p_log_return = yes.
            return.
        end /* else */.
    end /* if */.
    if  criter_distrib_cta_ctbl.ind_criter_distrib_ccusto = "Utiliza Todos" /*l_utiliza_todos*/ 
    then do:
        if  (p_cod_plano_ccusto <> ?
        and   p_cod_plano_ccusto <> "")
        /* and  (p_cod_ccusto <> v_cod_ccusto_000) */
        then do:
            assign p_log_return = yes.
            return.
        end /* if */.
        else do:
            return.
        end /* else */.
    end /* if */.
    if  criter_distrib_cta_ctbl.ind_criter_distrib_ccusto = "Definidos" /*l_definidos*/ 
    then do:
        if  (p_cod_plano_ccusto = ?
        or    p_cod_plano_ccusto = "")
        /* or   (p_cod_ccusto = v_cod_ccusto_000) */
        then do:
            return.
        end /* if */.
        find mapa_distrib_ccusto no-lock
             where mapa_distrib_ccusto.cod_estab = criter_distrib_cta_ctbl.cod_estab
               and mapa_distrib_ccusto.cod_mapa_distrib_ccusto = criter_distrib_cta_ctbl.cod_mapa_distrib_ccusto
              no-error.
        if  p_dat_refer_ent <> ? and
           (p_dat_refer_ent <  mapa_distrib_ccusto.dat_inic_valid   or
            p_dat_refer_ent >= mapa_distrib_ccusto.dat_fim_valid)
        then do:
            return.
        end /* if */.
        find item_lista_ccusto no-lock
             where item_lista_ccusto.cod_estab = p_cod_estab
               and item_lista_ccusto.cod_mapa_distrib_ccusto = mapa_distrib_ccusto.cod_mapa_distrib_ccusto
               and item_lista_ccusto.cod_empresa = p_cod_empresa
               and item_lista_ccusto.cod_plano_ccusto = p_cod_plano_ccusto
               and item_lista_ccusto.cod_ccusto = p_cod_ccusto /*cl_validar_cta_ctbl_distrib_ccusto of item_lista_ccusto*/ no-error.
        if  not avail item_lista_ccusto
        then do:
            return.
        end /* if */.
        else do:
            assign p_log_return = yes.
        end /* else */.
    end /* if */.

END PROCEDURE. /* pi_validar_cta_ctbl_distrib_ccusto */
/*****************************************************************************
** Procedure Interna.....: pi_validar_ccusto_unid_negoc_estab
** Descricao.............: pi_validar_ccusto_unid_negoc_estab
** Criado por............: Henke
** Criado em.............: // 
** Alterado por..........: Rafael
** Alterado em...........: 21/08/1997 15:17:43
*****************************************************************************/
PROCEDURE pi_validar_ccusto_unid_negoc_estab:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_empresa
        as character
        format "x(3)"
        no-undo.
    def Input param p_cod_plano_ccusto
        as character
        format "x(8)"
        no-undo.
    def Input param p_cod_ccusto
        as Character
        format "x(20)"
        no-undo.
    def Input param p_cod_unid_negoc
        as character
        format "x(3)"
        no-undo.
    def Input param p_cod_estab
        as character
        format "x(5)"
        no-undo.
    def output param p_num_mensagem
        as integer
        format ">>>>,>>9"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_cod_ccusto_000
        as Character
        format "x(20)":U
        label "Centro Custo"
        column-label "Centro Custo"
        no-undo.


    /************************** Variable Definition End *************************/

    if  p_cod_estab <> "" and
        p_cod_unid_negoc <> ""
    then do:
        find estab_unid_negoc no-lock
             where estab_unid_negoc.cod_estab = p_cod_estab
               and estab_unid_negoc.cod_unid_negoc = p_cod_unid_negoc /*cl_valida_unid_negoc of estab_unid_negoc*/ no-error.
        if  not avail estab_unid_negoc
        then do:
            assign p_num_mensagem = 950.
            return.
        end /* if */.
    end /* if */.
    if  avail plano_ccusto and
        plano_ccusto.cod_plano_ccusto = p_cod_plano_ccusto and
        plano_ccusto.cod_empresa = p_cod_empresa
    then do:
        run pi_retornar_ccusto_inic (Input plano_ccusto.cod_format_ccusto,
                                     output v_cod_ccusto_000) /*pi_retornar_ccusto_inic*/.
    end /* if */.
    else do:
        if  p_cod_plano_ccusto <> ""
        then do:
           find plano_ccusto no-lock
                where plano_ccusto.cod_empresa = p_cod_empresa
                  and plano_ccusto.cod_plano_ccusto = p_cod_plano_ccusto /*cl_valida_plano of plano_ccusto*/ no-error.
           if  avail plano_ccusto
           then do:
              run pi_retornar_ccusto_inic (Input plano_ccusto.cod_format_ccusto,
                                           output v_cod_ccusto_000) /*pi_retornar_ccusto_inic*/.
           end /* if */.
           else do:
              assign v_cod_ccusto_000 = "".
           end /* else */.
        end /* if */.
        else do:
           assign v_cod_ccusto_000 = "".
        end /* else */.
    end /* else */.
    if  p_cod_plano_ccusto <> "" and
        p_cod_ccusto       <> v_cod_ccusto_000 and
        p_cod_unid_negoc   <> ""
    then do:
        find ccusto_unid_negoc no-lock
             where ccusto_unid_negoc.cod_empresa = p_cod_empresa
               and ccusto_unid_negoc.cod_plano_ccusto = p_cod_plano_ccusto
               and ccusto_unid_negoc.cod_ccusto = p_cod_ccusto
               and ccusto_unid_negoc.cod_unid_negoc = p_cod_unid_negoc /*cl_validar_ccusto_unid_negoc_estab of ccusto_unid_negoc*/ no-error.
        if  not avail ccusto_unid_negoc
        then do:
            assign p_num_mensagem = 1253.
            return.
        end /* if */.
    end /* if */.
    if  p_cod_plano_ccusto <> "" and
        p_cod_ccusto       <> v_cod_ccusto_000 and
        p_cod_estab        <> ""
    then do:
        find restric_ccusto no-lock
             where restric_ccusto.cod_empresa = p_cod_empresa
               and restric_ccusto.cod_plano_ccusto = p_cod_plano_ccusto
               and restric_ccusto.cod_ccusto = p_cod_ccusto
               and restric_ccusto.cod_estab = p_cod_estab /*cl_validar_ccusto_unid_negoc_estab of restric_ccusto*/ no-error.
        if  avail restric_ccusto
        then do:
            assign p_num_mensagem = 1388.
            return.
        end /* if */.
    end /* if */.
    assign p_num_mensagem = 0.
END PROCEDURE. /* pi_validar_ccusto_unid_negoc_estab */
/*****************************************************************************
** Procedure Interna.....: pi_bt_ok_bem_pat_desmembr
** Descricao.............: pi_bt_ok_bem_pat_desmembr
** Criado por............: bre17892
** Criado em.............: 17/11/1999 15:33:27
** Alterado por..........: log32668
** Alterado em...........: 02/03/2011 20:38:02
*****************************************************************************/
PROCEDURE pi_bt_ok_bem_pat_desmembr:

    /************************** Buffer Definition Begin *************************/

    def buffer b_aprop_parc_pis_cofins
        for aprop_parc_pis_cofins.
    def buffer b_bem_pat_aux
        for bem_pat.
    def buffer b_val_origin_bem_pat
        for val_origin_bem_pat.


    /*************************** Buffer Definition End **************************/

    /************************* Variable Definition Begin ************************/

    def var v_cb1_calc_dat_term_carenc
        as Integer
        format ">>>>>>>9":U
        no-undo.
    def var v_cod_cenar_ctbl
        as character
        format "x(8)":U
        label "Cen†rio Cont†bil"
        column-label "Cen†rio Cont†bil"
        no-undo.
    def var v_cod_finalid
        as character
        format "x(20)":U
        label "Finalidade"
        column-label "Finalidade"
        no-undo.
    def var v_rec_val_origin_bem_pat
        as recid
        format ">>>>>>9":U
        initial ?
        no-undo.
    def var v_val_original
        as decimal
        format "->>>>>,>>>,>>9.99":U
        decimals 4
        initial 0
        label "Valor Original"
        column-label "Valor Original"
        no-undo.


    /************************** Variable Definition End *************************/

    if not avail b_bem_pat then do:
        /* Bem deve ser informado ! */
        run pi_messages (input "show",
                         input 10446,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_10446*/.
        return "NOK" /*l_nok*/ .
    end.

    assign v_cod_cenar_ctbl   = ''
           v_cod_finalid_econ = ''
           v_val_original     = 0.

    run pi_validar_param_ctbz_cta_pat_desm(buffer b_bem_pat,
                                           Input v_dat_desmbrto,
                                           output v_cod_return).
    if  return-value <> "OK" /*l_ok*/  then do:
        /* ParÉmetro Contabilizaá∆o da Conta Patrimonial n∆o cadastrado ! */
        run pi_messages (input "show",
                         input 1111,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                           entry(2, v_cod_return, chr(10)), entry(3, v_cod_return, chr(10)), entry(4, v_cod_return, chr(10))                    , entry(5, v_cod_return, chr(10)))) /*msg_1111*/.
        return "NOK" /*l_nok*/ . 
    end. 

    /* --- Valida situaá∆o do m¢dulo ---*/
    RUN pi_retornar_sit_movimen_modul  (INPUT  'FAS' /* l_fas*/ ,
                                        INPUT  v_cod_empres_usuar,
                                        INPUT  v_dat_desmbrto,
                                        INPUT  'Habilitado' /* l_habilitado*/ ,
                                        OUTPUT v_cod_return).
    if not can-do(v_cod_return,'Habilitado' /* l_habilitado*/  ) then do:
        if  v_ind_message_output = 'Na Tela' /* l_on_screen*/ 
        then do:
            /* M¢dulo &1 n∆o habilitado para movimentaá∆o em &2 ! */
            run pi_messages (input 'show',
                             input 4153,
                             input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                               'FAS' /* l_fas*/ , v_dat_desmbrto)) /* msg_4153*/.
            return 'NOK' /* l_nok*/ . 
        END /* if */ .
    END /* END.*/ .

    for each tt_desmembrto_bem_pat.
        blk_param:
        for each param_calc_cta
            where param_calc_cta.cod_empresa = tt_desmembrto_bem_pat.tta_cod_empresa
            and   param_calc_cta.cod_cta_pat = tt_desmembrto_bem_pat.tta_cod_cta_pat
            and   param_calc_cta.cod_tip_calc  <> '' no-lock:

            find finalid_econ
                where finalid_econ.cod_finalid_econ = param_calc_cta.cod_finalid_econ no-lock no-error.
            if  avail finalid_econ 
            and finalid_econ.ind_armaz_val = "Ativo Fixo" /*l_ativo_fixo*/  then
                next blk_param.

            find first param_ctbz_cta_pat no-lock
                where param_ctbz_cta_pat.cod_empresa      = param_calc_cta.cod_empresa
                and   param_ctbz_cta_pat.cod_cta_pat      = param_calc_cta.cod_cta_pat
                and   param_ctbz_cta_pat.cod_cenar_ctbl   = param_calc_cta.cod_cenar_ctbl
                and   param_ctbz_cta_pat.cod_finalid_econ = param_calc_cta.cod_finalid_econ
                and   param_ctbz_cta_pat.ind_finalid_ctbl = "Desmembramento" /*l_desmembramento*/ 
                and   param_ctbz_cta_pat.dat_inic_valid  <= v_dat_desmbrto
                and   param_ctbz_cta_pat.dat_fim_valid   >= v_dat_desmbrto no-error.
            if  not avail param_ctbz_cta_pat then do:
                assign v_cod_return = "1111" + chr(10) + param_calc_cta.cod_cta_pat + chr(10) + "Desmembramento" /*l_desmembramento*/  + chr(10) +
                                      param_calc_cta.cod_finalid_econ + chr(10) + param_calc_cta.cod_cenar_ctbl.
                /* ParÉmetro Contabilizaá∆o da Conta Patrimonial n∆o cadastrado ! */
                run pi_messages (input "show",
                                 input 1111,
                                 input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                   entry(2, v_cod_return, chr(10)), entry(3, v_cod_return, chr(10)), entry(4, v_cod_return, chr(10))                             , entry(5, v_cod_return, chr(10)))) /*msg_1111*/.
                return "NOK" /*l_nok*/ .
            end.
        end.
    end.

    find utiliz_cenar_ctbl no-lock
         where utiliz_cenar_ctbl.cod_empresa    = b_bem_pat.cod_empresa
           and utiliz_cenar_ctbl.log_cenar_fisc = yes no-error.

    if avail utiliz_cenar_ctbl
       then assign v_cod_cenar_ctbl = utiliz_cenar_ctbl.cod_cenar_ctbl.

    find first histor_finalid_econ no-lock
         where histor_finalid_econ.cod_indic_econ          = b_bem_pat.cod_indic_econ
           and histor_finalid_econ.dat_inic_valid_finalid <= input frame f_dlg_03_bem_pat_desmembramento v_dat_desmbrto
           and histor_finalid_econ.dat_fim_valid_finalid   > input frame f_dlg_03_bem_pat_desmembramento v_dat_desmbrto no-error.
    if avail histor_finalid_econ
       then assign v_cod_finalid_econ = histor_finalid_econ.cod_finalid_econ.

    find last b_val_origin_bem_pat no-lock
         where b_val_origin_bem_pat.num_id_bem_pat         = b_bem_pat.num_id_bem_pat
           and b_val_origin_bem_pat.num_seq_incorp_bem_pat = 0
           and b_val_origin_bem_pat.cod_cenar_ctbl         = v_cod_cenar_ctbl
           and b_val_origin_bem_pat.cod_finalid_econ       = v_cod_finalid_econ no-error.

    if avail b_val_origin_bem_pat 
       then assign v_val_original = b_val_origin_bem_pat.val_original.
       else assign v_val_original = b_bem_pat.val_original.

    run pi_tratar_pis_cofins_desmembramento (input v_val_original) /*pi_tratar_pis_cofins_desmembramento*/.
    if return-value = "NOK" /*l_nok*/  then return "NOK" /*l_nok*/ .

    return 'OK'.
END PROCEDURE. /* pi_bt_ok_bem_pat_desmembr */
/*****************************************************************************
** Procedure Interna.....: pi_implantar_bem_pat_desmbrto_more_1
** Descricao.............: pi_implantar_bem_pat_desmbrto_more_1
** Criado por............: src12337
** Criado em.............: 31/08/2001 14:54:42
** Alterado por..........: corp45760
** Alterado em...........: 30/07/2019 09:52:05
*****************************************************************************/
PROCEDURE pi_implantar_bem_pat_desmbrto_more_1:

    /************************** Buffer Definition Begin *************************/

    def buffer b_movto_bem_pat
        for movto_bem_pat.


    /*************************** Buffer Definition End **************************/

    /************************* Variable Definition Begin ************************/

    def var v_qtd_dias_vida_util
        as decimal
        format ">>>,>>>,>>9":U
        decimals 0
        no-undo.


    /************************** Variable Definition End *************************/

    create movto_bem_pat.
    assign movto_bem_pat.num_id_bem_pat         = bem_pat.num_id_bem_pat
           movto_bem_pat.num_seq_movto_bem_pat  = next-value(seq_movto_bem_pat)
           movto_bem_pat.num_seq_incorp_bem_pat = 0
           movto_bem_pat.dat_movto_bem_pat      = v_dat_desmbrto
           movto_bem_pat.ind_trans_calc_bem_pat = "Implantaá∆o" /*l_implantacao*/ 
           movto_bem_pat.ind_orig_calc_bem_pat  = "Desmembramento" /*l_desmembramento*/ 
           movto_bem_pat.num_id_bem_pat_orig    = b_bem_pat.num_id_bem_pat
           movto_bem_pat.qtd_movto_bem_pat      = v_qtd_bem_pat_represen.

        assign movto_bem_pat.cod_cenar_ctbl           = input frame f_dlg_03_bem_pat_desmembramento cenar_ctbl.cod_cenar_ctbl
               movto_bem_pat.cod_indic_econ           = input frame f_dlg_03_bem_pat_desmembramento indic_econ.cod_indic_econ
               movto_bem_pat.val_origin_movto_bem_pat = round(v_val_origin_bem_pat * (v_val_perc_aplic_desmbrto / 100),2)
               movto_bem_pat.val_perc_movto_bem_pat   = (input frame f_dlg_01_bem_pat_desmbrto_val tt_desmembrto_bem_pat.tta_val_original *
                                                         100) / v_val_original_cal.

    assign movto_bem_pat.cod_empresa            = bem_pat.cod_empresa
           movto_bem_pat.cod_plano_ccusto       = bem_pat.cod_plano_ccusto
           movto_bem_pat.cod_ccusto_respons     = bem_pat.cod_ccusto_respons
           movto_bem_pat.cod_unid_negoc         = bem_pat.cod_unid_negoc
           movto_bem_pat.cod_estab              = bem_pat.cod_estab.
    validate movto_bem_pat.

    assign v_log_param_difer = no.
    verifica_block:
    for each tt_desmembrto_bem_pat:
        /* verifica se os param de calc sao diferentes entre as ctas */
       find cta_pat no-lock
           where cta_pat.cod_empresa = tt_desmembrto_bem_pat.tta_cod_empresa
           and   cta_pat.cod_cta_pat = tt_desmembrto_bem_pat.tta_cod_cta_pat no-error.
       if avail cta_pat then do:
           for each b_param_calc_cta_aux no-lock
               where b_param_calc_cta_aux.cod_empresa = cta_pat.cod_empresa
               and   b_param_calc_cta_aux.cod_cta_pat = cta_pat.cod_cta_pat:
               find b_param_calc_bem_pat_aux no-lock 
                   where b_param_calc_bem_pat_aux.num_id_bem_pat   = b_bem_pat.num_id_bem_pat
                   and   b_param_calc_bem_pat_aux.cod_tip_calc     = b_param_calc_cta_aux.cod_tip_calc
                   and   b_param_calc_bem_pat_aux.cod_cenar_ctbl   = b_param_calc_cta_aux.cod_cenar_ctbl
                   and   b_param_calc_bem_pat_aux.cod_finalid_econ = b_param_calc_cta_aux.cod_finalid_econ no-error.
               if not avail b_param_calc_bem_pat_aux then do:
                   assign v_log_param_difer = yes.
                   leave verifica_block.
               end.
           end.
           for each b_param_calc_bem_pat_aux no-lock
               where b_param_calc_bem_pat_aux.num_id_bem_pat = b_bem_pat.num_id_bem_pat:
               find b_param_calc_cta_aux no-lock
                   where b_param_calc_cta_aux.cod_empresa      = cta_pat.cod_empresa
                   and   b_param_calc_cta_aux.cod_cta_pat      = cta_pat.cod_cta_pat
                   and   b_param_calc_cta_aux.cod_tip_calc     = b_param_calc_bem_pat_aux.cod_tip_calc
                   and   b_param_calc_cta_aux.cod_cenar_ctbl   = b_param_calc_bem_pat_aux.cod_cenar_ctbl
                   and   b_param_calc_cta_aux.cod_finalid_econ = b_param_calc_bem_pat_aux.cod_finalid_econ no-error.
               if not avail b_param_calc_cta_aux then do:
                   assign v_log_param_difer = yes.
                   leave verifica_block.
               end.
           end.
       end.
    end.

    if v_log_param_difer then do:

        for each param_calc_bem_pat no-lock
          where param_calc_bem_pat.num_id_bem_pat = bem_pat.num_id_bem_pat
            and param_calc_bem_pat.cod_tip_calc = "":

            find last b_val_origin_bem_pat no-lock
              where b_val_origin_bem_pat.num_id_bem_pat         = b_bem_pat.num_id_bem_pat
                and b_val_origin_bem_pat.num_seq_incorp_bem_pat = 0
                and b_val_origin_bem_pat.cod_cenar_ctbl         = param_calc_bem_pat.cod_cenar_ctbl
                and b_val_origin_bem_pat.cod_finalid_econ       = param_calc_bem_pat.cod_finalid_econ no-error.
            if avail b_val_origin_bem_pat then
                assign v_val_origin_aux = round((b_val_origin_bem_pat.val_original * movto_bem_pat.val_perc_movto_bem_pat) / 100 ,2).
            else do:
                run pi_converter_finalid_econ_finalid (Input v_cod_finalid_aux,
                                                       Input v_cod_empres_usuar,
                                                       Input v_dat_desmbrto,
                                                       Input movto_bem_pat.val_origin_movto_bem_pat,
                                                       Input param_calc_bem_pat.cod_finalid_econ,
                                                       output v_cod_return) /*pi_converter_finalid_econ_finalid*/.
                if v_cod_return <> "OK" /*l_ok*/  then do:
                    run pi_testar_retorno_converter_finalid /*pi_testar_retorno_converter_finalid*/.
                    if v_cod_return = "NOK" /*l_nok*/  then
                        return "NOK" /*l_nok*/ .
                end.            
            end.
            create val_origin_bem_pat.
            assign val_origin_bem_pat.num_id_bem_pat = bem_pat.num_id_bem_pat
                   val_origin_bem_pat.num_seq_incorp_bem_pat = 0
                   val_origin_bem_pat.cod_cenar_ctbl = param_calc_bem_pat.cod_cenar_ctbl
                   val_origin_bem_pat.cod_finalid_econ = param_calc_bem_pat.cod_finalid_econ
                   val_origin_bem_pat.dat_calc_pat = movto_bem_pat.dat_movto_bem_pat
                   val_origin_bem_pat.num_seq_movto_bem_pat = movto_bem_pat.num_seq_movto_bem_pat
                   val_origin_bem_pat.dat_cotac_indic_econ  = if avail tt_converter_finalid_econ then tt_converter_finalid_econ.tta_dat_cotac_indic_econ else v_dat_desmbrto.

            if avail tt_converter_finalid_econ and tt_converter_finalid_econ.tta_cod_finalid_econ = param_calc_bem_pat.cod_finalid_econ then
                assign val_origin_bem_pat.val_original = if avail tt_converter_finalid_econ then round(tt_converter_finalid_econ.tta_val_transacao,2) else v_val_origin_aux
                       val_origin_bem_pat.val_cotac_indic_econ  = if avail tt_converter_finalid_econ then tt_converter_finalid_econ.tta_val_cotac_indic_econ else 0.
            else              
                assign val_origin_bem_pat.val_original = v_val_origin_aux
                       val_origin_bem_pat.val_cotac_indic_econ  = 1.

            validate val_origin_bem_pat.
        end.
    end.

    cria_incorp_block:
    for each incorp_bem_pat no-lock
        where incorp_bem_pat.num_id_bem_pat = b_bem_pat.num_id_bem_pat:
        find last b_val_origin_bem_pat no-lock
            where b_val_origin_bem_pat.num_id_bem_pat = b_bem_pat.num_id_bem_pat
              and b_val_origin_bem_pat.num_seq_incorp_bem_pat = incorp_bem_pat.num_seq_incorp_bem_pat
              and b_val_origin_bem_pat.cod_finalid_econ = v_cod_finalid_econ no-error.
        if avail b_val_origin_bem_pat then do:
            create b_incorp_bem_pat.
            assign b_incorp_bem_pat.num_id_bem_pat = bem_pat.num_id_bem_pat
                   b_incorp_bem_pat.num_seq_incorp_bem_pat = incorp_bem_pat.num_seq_incorp_bem_pat
                   b_incorp_bem_pat.cod_cenar_ctbl = incorp_bem_pat.cod_cenar_ctbl
                   b_incorp_bem_pat.dat_incorp_bem_pat = incorp_bem_pat.dat_incorp_bem_pat
                   b_incorp_bem_pat.ind_incorp_bem_pat = incorp_bem_pat.ind_incorp_bem_pat
                   b_incorp_bem_pat.des_incorp_bem_pat = incorp_bem_pat.des_incorp_bem_pat
                   b_incorp_bem_pat.cod_incent_fisc = incorp_bem_pat.cod_incent_fisc
                   b_incorp_bem_pat.cod_empresa = incorp_bem_pat.cod_empresa
                   b_incorp_bem_pat.cdn_fornecedor = incorp_bem_pat.cdn_fornecedor
                   b_incorp_bem_pat.cod_indic_econ = incorp_bem_pat.cod_indic_econ
                   b_incorp_bem_pat.cod_tip_calc_reaval = incorp_bem_pat.cod_tip_calc_reaval
                   b_incorp_bem_pat.cod_estab = incorp_bem_pat.cod_estab
                   b_incorp_bem_pat.dat_cotac_outras_moed = incorp_bem_pat.dat_cotac_outras_moed
                   b_incorp_bem_pat.cod_imagem = incorp_bem_pat.cod_imagem
                   b_incorp_bem_pat.des_laudo_reaval_bem_pat = incorp_bem_pat.des_laudo_reaval_bem_pat.           

            if v_log_param_calc_incorp = yes then do:
                for each param_calc_incorp_pat no-lock
                  where param_calc_incorp_pat.num_id_bem_pat         = incorp_bem_pat.num_id_bem_pat
                    and param_calc_incorp_pat.num_seq_incorp_bem_pat = incorp_bem_pat.num_seq_incorp_bem_pat:

                    find first b_param_calc_incorp_pat exclusive-lock
                      where b_param_calc_incorp_pat.num_id_bem_pat         = bem_pat.num_id_bem_pat
                        and b_param_calc_incorp_pat.num_seq_incorp_bem_pat = incorp_bem_pat.num_seq_incorp_bem_pat
                        and b_param_calc_incorp_pat.cod_tip_calc           = param_calc_incorp_pat.cod_tip_calc
                        and b_param_calc_incorp_pat.cod_cenar_ctbl         = param_calc_incorp_pat.cod_cenar_ctbl
                        and b_param_calc_incorp_pat.cod_finalid_econ       = param_calc_incorp_pat.cod_finalid_econ no-error.

                    if not avail b_param_calc_incorp_pat then do:
                        create b_param_calc_incorp_pat.
                        assign b_param_calc_incorp_pat.num_id_bem_pat             = bem_pat.num_id_bem_pat
                               b_param_calc_incorp_pat.num_seq_incorp_bem_pat     = incorp_bem_pat.num_seq_incorp_bem_pat
                               b_param_calc_incorp_pat.cod_tip_calc               = param_calc_incorp_pat.cod_tip_calc
                               b_param_calc_incorp_pat.cod_cenar_ctbl             = param_calc_incorp_pat.cod_cenar_ctbl            
                               b_param_calc_incorp_pat.cod_finalid_econ           = param_calc_incorp_pat.cod_finalid_econ.
                    end.
                    assign b_param_calc_incorp_pat.num_seq_tip_calc           = param_calc_incorp_pat.num_seq_tip_calc 
                           b_param_calc_incorp_pat.dat_inic_calc              = param_calc_incorp_pat.dat_inic_calc 
                           b_param_calc_incorp_pat.cod_grp_calc               = param_calc_incorp_pat.cod_grp_calc                                     
                           b_param_calc_incorp_pat.val_perc_anual_dpr         = param_calc_incorp_pat.val_perc_anual_dpr        
                           b_param_calc_incorp_pat.val_perc_anual_dpr_incevda = param_calc_incorp_pat.val_perc_anual_dpr_incevda
                           b_param_calc_incorp_pat.val_perc_anual_reduc_sdo   = param_calc_incorp_pat.val_perc_anual_reduc_sdo
                           b_param_calc_incorp_pat.qtd_unid_vida_util         = param_calc_incorp_pat.qtd_unid_vida_util
                           b_param_calc_incorp_pat.qtd_anos_vida_util         = param_calc_incorp_pat.qtd_anos_vida_util. 
                end.           
            end.
            else do:
                assign b_incorp_bem_pat.val_perc_anual_dpr         = incorp_bem_pat.val_perc_anual_dpr
                       b_incorp_bem_pat.val_perc_anual_dpr_incevda = incorp_bem_pat.val_perc_anual_dpr_incevda
                       b_incorp_bem_pat.qtd_unid_vida_util         = incorp_bem_pat.qtd_unid_vida_util.
            end.


            if avail b_val_origin_bem_pat then
                assign b_incorp_bem_pat.val_incorp_bem_pat = round(b_val_origin_bem_pat.val_original * (v_val_perc_aplic_desmbrto / 100),2).

                assign b_incorp_bem_pat.cod_cta_pat = incorp_bem_pat.cod_cta_pat.

               assign b_incorp_bem_pat.val_cr_pis          = incorp_bem_pat.val_cr_pis
                      b_incorp_bem_pat.val_cr_cofins       = incorp_bem_pat.val_cr_cofins
                      b_incorp_bem_pat.log_cr_pis          = incorp_bem_pat.log_cr_pis
                      b_incorp_bem_pat.log_cr_cofins       = incorp_bem_pat.log_cr_cofins
                      b_incorp_bem_pat.num_parc_pis_cofins = incorp_bem_pat.num_parc_pis_cofins
                      b_incorp_bem_pat.log_bem_imptdo      = incorp_bem_pat.log_bem_imptdo
                      b_incorp_bem_pat.log_cr_csll         = incorp_bem_pat.log_cr_csll
                      b_incorp_bem_pat.num_exerc_cr_csll   = incorp_bem_pat.num_exerc_cr_csll.

               assign b_incorp_bem_pat.cod_livre_1 = SetEntryField(10,b_incorp_bem_pat.cod_livre_1,";",GetEntryField(10,incorp_bem_pat.cod_livre_1,";")) 
                      b_incorp_bem_pat.cod_livre_1 = SetEntryField(11,b_incorp_bem_pat.cod_livre_1,";",GetEntryField(11,incorp_bem_pat.cod_livre_1,";")). 

            validate b_incorp_bem_pat.

            create b_movto_bem_pat.
            assign b_movto_bem_pat.num_id_bem_pat         = bem_pat.num_id_bem_pat
                   b_movto_bem_pat.num_seq_movto_bem_pat  = next-value(seq_movto_bem_pat)
                   b_movto_bem_pat.num_seq_incorp_bem_pat = b_incorp_bem_pat.num_seq_incorp_bem_pat
                   b_movto_bem_pat.dat_movto_bem_pat      = movto_bem_pat.dat_movto_bem_pat
                   b_movto_bem_pat.ind_trans_calc_bem_pat = "Implantaá∆o" /*l_implantacao*/ 
                   b_movto_bem_pat.ind_orig_calc_bem_pat  = "Desmembramento" /*l_desmembramento*/ 
                   b_movto_bem_pat.num_id_bem_pat_orig    = b_bem_pat.num_id_bem_pat.

                assign b_movto_bem_pat.cod_cenar_ctbl           = input frame f_dlg_03_bem_pat_desmembramento cenar_ctbl.cod_cenar_ctbl
                       b_movto_bem_pat.cod_indic_econ           = input frame f_dlg_03_bem_pat_desmembramento indic_econ.cod_indic_econ
                       b_movto_bem_pat.val_origin_movto_bem_pat = round(b_val_origin_bem_pat.val_original * (v_val_perc_aplic_desmbrto / 100),2)
                       b_movto_bem_pat.val_perc_movto_bem_pat   = (input frame f_dlg_01_bem_pat_desmbrto_val tt_desmembrto_bem_pat.tta_val_original *
                                                               100) / v_val_original_cal.
            assign b_movto_bem_pat.cod_empresa            = bem_pat.cod_empresa
                   b_movto_bem_pat.cod_plano_ccusto       = bem_pat.cod_plano_ccusto
                   b_movto_bem_pat.cod_ccusto_respons     = bem_pat.cod_ccusto_respons
                   b_movto_bem_pat.cod_unid_negoc         = bem_pat.cod_unid_negoc
                   b_movto_bem_pat.cod_estab              = bem_pat.cod_estab.
            validate b_movto_bem_pat.

            param_block:
            for each param_calc_bem_pat no-lock
                where param_calc_bem_pat.num_id_bem_pat = bem_pat.num_id_bem_pat
                  and param_calc_bem_pat.cod_tip_calc = "":
                if  b_incorp_bem_pat.cod_cenar_ctbl <> "" and
                     param_calc_bem_pat.cod_cenar_ctbl <> b_incorp_bem_pat.cod_cenar_ctbl
                then do:
                    next param_block.
                end /* if */.
                find last b_val_origin_bem_pat no-lock
                    where b_val_origin_bem_pat.num_id_bem_pat         = b_bem_pat.num_id_bem_pat
                      and b_val_origin_bem_pat.num_seq_incorp_bem_pat = incorp_bem_pat.num_seq_incorp_bem_pat
                      and b_val_origin_bem_pat.cod_cenar_ctbl         = param_calc_bem_pat.cod_cenar_ctbl
                      and b_val_origin_bem_pat.cod_finalid_econ       = param_calc_bem_pat.cod_finalid_econ no-error.
                if  avail b_val_origin_bem_pat
                then do:
                    assign v_val_origin_aux = round((b_val_origin_bem_pat.val_original * b_movto_bem_pat.val_perc_movto_bem_pat) / 100 ,2).
                end /* if */.
                else do:
                    find last b_val_origin_bem_pat no-lock
                        where b_val_origin_bem_pat.num_id_bem_pat = b_bem_pat.num_id_bem_pat
                          and b_val_origin_bem_pat.num_seq_incorp_bem_pat = incorp_bem_pat.num_seq_incorp_bem_pat
                          and b_val_origin_bem_pat.cod_finalid_econ = v_cod_finalid_econ no-error.
                    run pi_converter_finalid_econ_finalid (Input v_cod_finalid_econ,
                                                           Input v_cod_empres_usuar,
                                                           Input b_val_origin_bem_pat.dat_calc_pat,
                                                           Input b_val_origin_bem_pat.val_original,
                                                           Input param_calc_bem_pat.cod_finalid_econ,
                                                           output v_cod_return) /*pi_converter_finalid_econ_finalid*/.
                    if  v_cod_return <> "OK" /*l_ok*/ 
                    then do:
                        run pi_testar_retorno_converter_finalid /*pi_testar_retorno_converter_finalid*/.
                        if  return-value = "NOK" /*l_nok*/ 
                        then do:
                            return "NOK" /*l_nok*/ .
                        end /* if */.
                    end /* if */.
                    find first tt_converter_finalid_econ no-error.
                    assign v_val_origin_aux = round((tt_converter_finalid_econ.tta_val_transacao * b_movto_bem_pat.val_perc_movto_bem_pat) / 100 ,2).
                end /* else */.
                create val_origin_bem_pat.
                assign val_origin_bem_pat.num_id_bem_pat = bem_pat.num_id_bem_pat
                       val_origin_bem_pat.num_seq_incorp_bem_pat = b_incorp_bem_pat.num_seq_incorp_bem_pat
                       val_origin_bem_pat.cod_cenar_ctbl = param_calc_bem_pat.cod_cenar_ctbl
                       val_origin_bem_pat.cod_finalid_econ = param_calc_bem_pat.cod_finalid_econ
                       val_origin_bem_pat.dat_calc_pat = b_movto_bem_pat.dat_movto_bem_pat
                       val_origin_bem_pat.val_original = v_val_origin_aux
                       val_origin_bem_pat.num_seq_movto_bem_pat = b_movto_bem_pat.num_seq_movto_bem_pat.
                validate val_origin_bem_pat.
                if  cb_desmembramento_bem_pat:screen-value in frame f_dlg_03_bem_pat_desmembramento = "Por Valor" /*l_por_valor*/ 
                and input frame f_dlg_03_bem_pat_desmembramento cenar_ctbl.cod_cenar_ctbl = val_origin_bem_pat.cod_cenar_ctbl
                and v_cod_finalid_aux = val_origin_bem_pat.cod_finalid_econ then
                    assign v_val_acum_origin = v_val_acum_origin + val_origin_bem_pat.val_original.
            end /* for param_block */.
        end. /* if avail b_val_origin_bem_pat*/
    end /* for cria_incorp_block */.
END PROCEDURE. /* pi_implantar_bem_pat_desmbrto_more_1 */
/*****************************************************************************
** Procedure Interna.....: pi_add_bem_pat_desmembramento_1
** Descricao.............: pi_add_bem_pat_desmembramento_1
** Criado por............: src12337
** Criado em.............: 31/08/2001 15:08:51
** Alterado por..........: log348825_1
** Alterado em...........: 03/09/2010 16:00:24
*****************************************************************************/
PROCEDURE pi_add_bem_pat_desmembramento_1:

    find indic_econ no-lock
        where indic_econ.cod_indic_econ = input frame f_dlg_03_bem_pat_desmembramento indic_econ.cod_indic_econ
        no-error.
    if  not avail indic_econ
    then do:
        /* Indicador Econìmico Inexistente ! */
        run pi_messages (input "show",
                         input 241,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_241*/.
        apply "entry" to indic_econ.cod_indic_econ in frame f_dlg_03_bem_pat_desmembramento.
        return 'NOK'.
    end /* if */.

    run pi_retornar_finalid_indic_econ (Input input frame f_dlg_03_bem_pat_desmembramento indic_econ.cod_indic_econ,
                                        Input input frame f_dlg_03_bem_pat_desmembramento v_dat_desmbrto,
                                        output v_cod_finalid_econ) /*pi_retornar_finalid_indic_econ*/.
    if  v_cod_finalid_econ = ""
    then do:
        /* N∆o existe finalidade para indicador econìmico e data ! */
        run pi_messages (input "show",
                         input 698,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_698*/.
        apply "entry" to indic_econ.cod_indic_econ in frame f_dlg_03_bem_pat_desmembramento.
        return 'NOK'.
    end /* if */.
    run pi_retornar_dat_inic_valid_unid_organ (Input v_cod_empres_usuar,
                                               Input input frame f_dlg_03_bem_pat_desmembramento v_dat_desmbrto,
                                               output v_dat_inic_valid_unid_organ) /*pi_retornar_dat_inic_valid_unid_organ*/.
    run pi_validar_finalid_unid_organ (Input v_cod_finalid_econ,
                                       Input b_bem_pat.cod_empresa,
                                       Input v_dat_inic_valid_unid_organ,
                                       output v_cod_return) /*pi_validar_finalid_unid_organ*/.
    if  v_cod_return = "338"
    then do:
        /* Finalidade n∆o liberada para a Unidade Organizacional ! */
        run pi_messages (input "show",
                         input 338,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_338*/.
        apply "entry" to indic_econ.cod_indic_econ in frame f_dlg_03_bem_pat_desmembramento.
        return 'NOK'.
    end /* if */.

    run pi_validar_finalid_utiliz_cenar (Input input frame f_dlg_03_bem_pat_desmembramento cenar_ctbl.cod_cenar_ctbl,
                                         Input b_bem_pat.cod_empresa,
                                         Input v_cod_finalid_econ,
                                         Input input frame f_dlg_03_bem_pat_desmembramento v_dat_desmbrto,
                                         output v_cod_return) /*pi_validar_finalid_utiliz_cenar*/.
    /* case_block: */
    case entry(1, v_cod_return):
        when "1915" then
        code_block:
        do:
            /* Expirou Validade da Finalidade para o Cen†rio ! */
            run pi_messages (input "show",
                             input 1915,
                             input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                entry(2, v_cod_return), entry(3, v_cod_return))) /*msg_1915*/.
            apply "entry" to indic_econ.cod_indic_econ in frame f_dlg_03_bem_pat_desmembramento.
            return 'NOK'.
        end /* do code_block */.
        when "1916" then
        code_block:
        do:
            /* Rodrigo - Inicio - ATV230951 */
            if  cb_desmembramento_bem_pat:screen-value in frame f_dlg_03_bem_pat_desmembramento = "Por Valor" /*l_por_valor*/  then do:
                if cenar_ctbl.cod_cenar_ctbl:screen-value in frame f_dlg_03_bem_pat_desmembramento = '' then do:
                    /* Cen†rio Cont†bil n∆o poder† ser branco ! */
                    run pi_messages (input "show",
                                     input 20253,
                                     input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_20253*/.            
                end.
                else do:
                    /* Cen†rio Cont†bil n∆o utiliza a Finalidade Econìmica ! */
                    run pi_messages (input "show",
                                     input 1916,
                                     input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                        entry(2, v_cod_return), entry(3, v_cod_return))) /*msg_1916*/.
                end.            
            end.
            else do:
                /* Cen†rio Cont†bil n∆o utiliza a Finalidade Econìmica ! */
                run pi_messages (input "show",
                                 input 1916,
                                 input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                    entry(2, v_cod_return), entry(3, v_cod_return))) /*msg_1916*/.
            end.
            apply "entry" to indic_econ.cod_indic_econ in frame f_dlg_03_bem_pat_desmembramento.
            return 'NOK'.
            /* Rodrigo - Fim - ATV230951 */        
        end /* do code_block */.
    end /* case case_block */.

    run pi_validar_cenar_ctbl (Input input frame f_dlg_03_bem_pat_desmembramento cenar_ctbl.cod_cenar_ctbl,
                               Input v_cod_empres_usuar,
                               Input input frame f_dlg_03_bem_pat_desmembramento v_dat_desmbrto,
                               output v_num_mensagem) /*pi_validar_cenar_ctbl*/.
    if  v_num_mensagem <> 0
    then do:
        run pi_messages (input "show",
                         input v_num_mensagem,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")).
        /* msg_2568*/ /* msg_2557*/ /* msg_1494*/ /* msg_1495*/
        apply "entry" to cenar_ctbl.cod_cenar_ctbl in frame f_dlg_03_bem_pat_desmembramento.
        return 'NOK'.
    end /* if */.

    /* valida se o bem tem contrato de leasing, e se o fim desse contrato Ç menor que a data do movimento,
       se for, ir† se validado se o bem tem registro de c†lculo de implantaá∆o por aquisiá∆o, caso n∆o
       tenha ir† apresentar uma messagem, avisando que o usu†rio tem que gerar os calculos de apropriaá∆o
       de leasing antes de fazer a movimentaá∆o */
    find first contrat_leas where 
        contrat_leas.cod_contrat_leas = b_bem_pat.cod_contrat_leas and
        contrat_leas.cod_arrendador = b_bem_pat.cod_arrendador no-lock no-error.
    if  avail contrat_leas
    then do: 
        if  contrat_leas.dat_fim_valid <= input frame f_dlg_03_bem_pat_desmembramento v_dat_desmbrto
        then do: 
            if  not(can-find(first reg_calc_bem_pat where 
                    reg_calc_bem_pat.num_id_bem_pat = b_bem_pat.num_id_bem_pat and
                    reg_calc_bem_pat.ind_trans_calc_bem_pat = "Implantaá∆o" /*l_implantacao*/ ))
            then do:
                /* Bem com contrato de leasing sem apropriaá∆o. */
                run pi_messages (input "show",
                                 input 9160,
                                 input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_9160*/.
                assign v_wgh_focus = v_dat_desmbrto:handle in frame f_dlg_03_bem_pat_desmembramento.
                return 'NOK'.
            end /* if */.        
        end /* if */.        
    end /* if */.
    assign v_cod_indic_econ         = input frame f_dlg_03_bem_pat_desmembramento indic_econ.cod_indic_econ.
    find last val_origin_bem_pat no-lock
         where val_origin_bem_pat.num_id_bem_pat = b_bem_pat.num_id_bem_pat
           and val_origin_bem_pat.num_seq_incorp_bem_pat = 0
           and val_origin_bem_pat.cod_cenar_ctbl = input frame f_dlg_03_bem_pat_desmembramento cenar_ctbl.cod_cenar_ctbl
           and val_origin_bem_pat.cod_finalid_econ = v_cod_finalid_econ
          no-error.
    if  not avail val_origin_bem_pat
    then do:
        /* Valor Original inexistente para o bem nesta moeda e cen†rio ! */
        run pi_messages (input "show",
                         input 769,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_769*/.
        apply "entry" to b_bem_pat.cod_cta_pat in frame f_dlg_03_bem_pat_desmembramento.
        return 'NOK'.
    end /* if */.
    assign v_val_origin_bem_pat = val_origin_bem_pat.val_original
           v_val_original_cal   = val_origin_bem_pat.val_original
           v_val_despes_financ  = val_origin_bem_pat.val_despes_financ.


    /* Begin_Include: i_valida_impl_incorp */
    find first b_movto_bem_pat no-lock
    where b_movto_bem_pat.num_id_bem_pat  = b_bem_pat.num_id_bem_pat
      and b_movto_bem_pat.num_seq_incorp_bem_pat <> 0 
      and b_movto_bem_pat.cod_cenar_ctbl <> ""
      and b_movto_bem_pat.ind_trans_calc_bem_pat = "Implantaá∆o" /*l_implantaá∆o*/   no-error.

    /* End_Include: i_valida_impl_incorp */

    if avail b_movto_bem_pat then do: 
       /* Bem possui  Incorporaá∆o &1 implantada por Cen†rio Cont†bil ! */
       run pi_messages (input "show",
                        input 18673,
                        input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                          b_movto_bem_pat.num_seq_incorp_bem_pat,"o desmembramento" /*l_compl_msg_18673b*/ ,"")) /*msg_18673*/. 
        apply "entry" to cb_desmembramento_bem_pat in frame f_dlg_03_bem_pat_desmembramento.
        return 'NOK'.
    end.

    acumula_incorp_bem_pat_block:
    for each incorp_bem_pat no-lock
        where incorp_bem_pat.num_id_bem_pat = b_bem_pat.num_id_bem_pat:
        find last val_origin_bem_pat no-lock
             where val_origin_bem_pat.num_id_bem_pat = b_bem_pat.num_id_bem_pat
               and val_origin_bem_pat.num_seq_incorp_bem_pat = incorp_bem_pat.num_seq_incorp_bem_pat
               and val_origin_bem_pat.cod_cenar_ctbl = input frame f_dlg_03_bem_pat_desmembramento cenar_ctbl.cod_cenar_ctbl
               and val_origin_bem_pat.cod_finalid_econ = v_cod_finalid_econ
              no-error.
        if  avail val_origin_bem_pat
        then do:
            assign v_val_original_cal  = v_val_original_cal  + val_origin_bem_pat.val_original
                   v_val_despes_financ = v_val_despes_financ + val_origin_bem_pat.val_despes_financ.
        end /* if */.
    end /* for acumula_incorp_bem_pat_block */.
    return 'OK'.
END PROCEDURE. /* pi_add_bem_pat_desmembramento_1 */
/*****************************************************************************
** Procedure Interna.....: pi_tt_desmembrto
** Descricao.............: pi_tt_desmembrto
** Criado por............: src12337
** Criado em.............: 31/08/2001 15:16:08
** Alterado por..........: corp45760
** Alterado em...........: 27/12/2018 15:52:37
*****************************************************************************/
PROCEDURE pi_tt_desmembrto:

    run pi_retornar_finalid_indic_econ(input frame f_dlg_03_bem_pat_desmembramento indic_econ.cod_indic_econ,
                                       input frame f_dlg_03_bem_pat_desmembramento v_dat_desmbrto, 
                                       output v_cod_finalid_aux).
    find last b_val_origin_bem_pat no-lock
    where b_val_origin_bem_pat.num_id_bem_pat = b_bem_pat.num_id_bem_pat
      and b_val_origin_bem_pat.num_seq_incorp_bem_pat = 0
      and b_val_origin_bem_pat.cod_cenar_ctbl = param_calc_bem_pat.cod_cenar_ctbl
      and b_val_origin_bem_pat.cod_finalid_econ = tt_finalid_bem_pat_calculo.tta_cod_finalid_econ no-error.
    if  not avail b_val_origin_bem_pat
    then do:
        return 'next'.
    end /* if */.
    assign v_val_original_cal  = b_val_origin_bem_pat.val_original
           v_val_despes_financ = b_val_origin_bem_pat.val_despes_financ.
    find first val_origin_bem_pat exclusive-lock
         where val_origin_bem_pat.num_id_bem_pat = b_bem_pat.num_id_bem_pat
           and val_origin_bem_pat.num_seq_incorp_bem_pat = 0
           and val_origin_bem_pat.num_seq_movto_bem_pat = b_movto_bem_pat_desmbrto.num_seq_movto_bem_pat
           and val_origin_bem_pat.cod_cenar_ctbl = param_calc_bem_pat.cod_cenar_ctbl
           and val_origin_bem_pat.cod_finalid_econ = tt_finalid_bem_pat_calculo.tta_cod_finalid_econ
           and val_origin_bem_pat.dat_calc_pat = b_movto_bem_pat_desmbrto.dat_movto_bem_pat no-error.
    if  not avail val_origin_bem_pat
    then do:
        run pi_converter_finalid_econ_finalid (Input b_val_origin_bem_pat.cod_finalid_econ,
                                               Input v_cod_empres_usuar,
                                               Input b_val_origin_bem_pat.dat_calc_pat,
                                               Input b_val_origin_bem_pat.val_original,
                                               Input param_calc_bem_pat.cod_finalid_econ,
                                               output v_cod_return) .
        if  v_cod_return <> "OK" /*l_ok*/ 
        then do:
            run pi_testar_retorno_converter_finalid .
            if  return-value = "NOK" /*l_nok*/ 
            then do:
                    return "NOK" /*l_nok*/ .
            end /* if */.
        end /* if */.
        find first tt_converter_finalid_econ no-error.

        create val_origin_bem_pat.
        assign val_origin_bem_pat.num_id_bem_pat         = b_bem_pat.num_id_bem_pat
               val_origin_bem_pat.num_seq_incorp_bem_pat = 0
               val_origin_bem_pat.cod_cenar_ctbl         = b_val_origin_bem_pat.cod_cenar_ctbl
               val_origin_bem_pat.cod_finalid_econ       = b_val_origin_bem_pat.cod_finalid_econ
               val_origin_bem_pat.num_seq_movto_bem_pat  = b_movto_bem_pat_desmbrto.num_seq_movto_bem_pat
               val_origin_bem_pat.dat_calc_pat           = b_movto_bem_pat_desmbrto.dat_movto_bem_pat
               val_origin_bem_pat.val_despes_financ      = b_val_origin_bem_pat.val_despes_financ * ((100 - v_val_perc_desmembr) / 100)
               val_origin_bem_pat.val_dif_val_origin     = round((round(b_val_origin_bem_pat.val_original,2) * (v_val_perc_desmembr / 100)),2)
               val_origin_bem_pat.val_original           = round(b_val_origin_bem_pat.val_original,2) - round(val_origin_bem_pat.val_dif_val_origin,2)
               v_rec_b_val_origin_bem_pat                = recid(val_origin_bem_pat)
               val_origin_bem_pat.dat_cotac_indic_econ   = if avail tt_converter_finalid_econ then tt_converter_finalid_econ.tta_dat_cotac_indic_econ else ?
               val_origin_bem_pat.val_cotac_indic_econ   = if avail tt_converter_finalid_econ then tt_converter_finalid_econ.tta_val_cotac_indic_econ else 0.

        if  cb_desmembramento_bem_pat:screen-value in frame f_dlg_03_bem_pat_desmembramento = "Por Valor" /*l_por_valor*/ 
        and tt_finalid_bem_pat_calculo.tta_cod_finalid_econ = v_cod_finalid_econ then
            assign val_origin_bem_pat.val_original       = b_val_origin_bem_pat.val_original - round(b_val_origin_bem_pat.val_original * (b_movto_bem_pat_desmbrto.val_perc_movto_bem_pat / 100),2)
                   val_origin_bem_pat.val_dif_val_origin = round(b_val_origin_bem_pat.val_original * (b_movto_bem_pat_desmbrto.val_perc_movto_bem_pat / 100),2).

       validate val_origin_bem_pat.
    end /* if */.
    blk_acumula_incorp:
    for each incorp_bem_pat no-lock
        where incorp_bem_pat.num_id_bem_pat = b_bem_pat.num_id_bem_pat
        and   incorp_bem_pat.dat_incorp_bem_pat <= v_dat_desmbrto:
        if  incorp_bem_pat.cod_cenar_ctbl <> " " and
            incorp_bem_pat.cod_cenar_ctbl <> param_calc_bem_pat.cod_cenar_ctbl
        then do:
            next blk_acumula_incorp.
        end /* if */.
        find last b_val_origin_bem_pat no-lock
        where b_val_origin_bem_pat.num_id_bem_pat = b_bem_pat.num_id_bem_pat
        and b_val_origin_bem_pat.num_seq_incorp_bem_pat = incorp_bem_pat.num_seq_incorp_bem_pat
        and b_val_origin_bem_pat.cod_cenar_ctbl = param_calc_bem_pat.cod_cenar_ctbl
        and b_val_origin_bem_pat.cod_finalid_econ = tt_finalid_bem_pat_calculo.tta_cod_finalid_econ
        no-error.
        if  not avail b_val_origin_bem_pat
        then do:
            next blk_acumula_incorp.
        end /* if */.
        assign v_val_original_cal  = v_val_original_cal  + b_val_origin_bem_pat.val_original
               v_val_despes_financ = v_val_despes_financ + b_val_origin_bem_pat.val_despes_financ.
        find first val_origin_bem_pat exclusive-lock
        where val_origin_bem_pat.num_id_bem_pat = b_bem_pat.num_id_bem_pat
        and val_origin_bem_pat.num_seq_incorp_bem_pat = incorp_bem_pat.num_seq_incorp_bem_pat
        and val_origin_bem_pat.num_seq_movto_bem_pat = b_movto_bem_pat_incorp.num_seq_movto_bem_pat
        and val_origin_bem_pat.cod_cenar_ctbl = param_calc_bem_pat.cod_cenar_ctbl
        and val_origin_bem_pat.cod_finalid_econ = tt_finalid_bem_pat_calculo.tta_cod_finalid_econ
        and val_origin_bem_pat.dat_calc_pat = v_dat_desmbrto
        no-error.
        if  not avail val_origin_bem_pat
        then do:
            create val_origin_bem_pat.
            assign val_origin_bem_pat.num_id_bem_pat         = b_bem_pat.num_id_bem_pat
                   val_origin_bem_pat.num_seq_incorp_bem_pat = incorp_bem_pat.num_seq_incorp_bem_pat
                   val_origin_bem_pat.num_seq_movto_bem_pat  = b_movto_bem_pat_incorp.num_seq_movto_bem_pat
                   val_origin_bem_pat.cod_cenar_ctbl         = param_calc_bem_pat.cod_cenar_ctbl
                   val_origin_bem_pat.cod_finalid_econ       = tt_finalid_bem_pat_calculo.tta_cod_finalid_econ
                   val_origin_bem_pat.dat_calc_pat           = v_dat_desmbrto
                   val_origin_bem_pat.val_despes_financ      = b_val_origin_bem_pat.val_despes_financ * ((100 - v_val_perc_desmembr) / 100)
                   val_origin_bem_pat.val_dif_val_origin     = round(b_val_origin_bem_pat.val_original * (v_val_perc_desmembr / 100),2)
                   val_origin_bem_pat.val_original           = round(b_val_origin_bem_pat.val_original,2) - round(val_origin_bem_pat.val_dif_val_origin,2).


           validate val_origin_bem_pat.
        end /* if */.
    end /* for blk_acumula_incorp */.
    tt_desmembrto_bem_pat_block:
    for each tt_desmembrto_bem_pat no-lock:
        find bem_pat exclusive-lock
             where bem_pat.cod_empresa = v_cod_empres_usuar
               and bem_pat.cod_cta_pat = tt_desmembrto_bem_pat.tta_cod_cta_pat
               and bem_pat.num_bem_pat = tt_desmembrto_bem_pat.tta_num_bem_pat
               and bem_pat.num_seq_bem_pat = tt_desmembrto_bem_pat.tta_num_seq_bem_pat /*cl_dlg_03_bem_pat_desmembramento of bem_pat*/ no-error.
        if  not avail bem_pat
        then do:
            /* Bem Patrimonial implantado por desmembramento n∆o existe ! */
            run pi_messages (input "show",
                             input 873,
                             input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_873*/.
            return 'NOK'.
        end /* if */.
        assign tt_desmembrto_bem_pat.tta_num_id_bem_pat = bem_pat.num_id_bem_pat.
        find first movto_bem_pat exclusive-lock
             where movto_bem_pat.num_id_bem_pat = bem_pat.num_id_bem_pat
              no-error.
        assign movto_bem_pat.num_id_bem_pat_orig = b_movto_bem_pat_desmbrto.num_id_bem_pat
               movto_bem_pat.num_seq_movto_bem_pat_orig = b_movto_bem_pat_desmbrto.num_seq_movto_bem_pat.

        find last b_val_origin_bem_pat no-lock
            where b_val_origin_bem_pat.num_id_bem_pat = b_bem_pat.num_id_bem_pat
            and b_val_origin_bem_pat.num_seq_incorp_bem_pat = 0
            and b_val_origin_bem_pat.cod_cenar_ctbl = param_calc_bem_pat.cod_cenar_ctbl
            and b_val_origin_bem_pat.cod_finalid_econ = tt_finalid_bem_pat_calculo.tta_cod_finalid_econ 
            and recid(b_val_origin_bem_pat)          <> v_rec_b_val_origin_bem_pat no-error.
        if  not avail b_val_origin_bem_pat
        then do:
            return 'next'.
        end /* if */.
        assign v_val_original_cal  = round(b_val_origin_bem_pat.val_original, 2)
               v_val_despes_financ = b_val_origin_bem_pat.val_despes_financ.

        find first b_param_calc_bem_pat NO-LOCK 
            where b_param_calc_bem_pat.num_id_bem_pat   = bem_pat.num_id_bem_pat
            and b_param_calc_bem_pat.cod_tip_calc     = param_calc_bem_pat.cod_tip_calc
            and b_param_calc_bem_pat.cod_cenar_ctbl   = param_calc_bem_pat.cod_cenar_ctbl
            and b_param_calc_bem_pat.cod_finalid_econ = param_calc_bem_pat.cod_finalid_econ no-error.
        IF AVAIL  b_param_calc_bem_pat THEN DO:

            find first val_origin_bem_pat exclusive-lock
                where val_origin_bem_pat.num_id_bem_pat = b_param_calc_bem_pat.num_id_bem_pat
                and val_origin_bem_pat.num_seq_incorp_bem_pat = 0
                and val_origin_bem_pat.cod_cenar_ctbl = b_param_calc_bem_pat.cod_cenar_ctbl
                and val_origin_bem_pat.cod_finalid_econ = b_val_origin_bem_pat.cod_finalid_econ
                and val_origin_bem_pat.num_seq_movto_bem_pat = movto_bem_pat.num_seq_movto_bem_pat
                and val_origin_bem_pat.dat_calc_pat = movto_bem_pat.dat_movto_bem_pat /* cl_dlg_03_val_origin_bem_pat of val_origin_bem_pat*/
               no-error.
            if  not avail val_origin_bem_pat
            then do:
                run pi_converter_finalid_econ_finalid (Input b_val_origin_bem_pat.cod_finalid_econ,
                                                       Input v_cod_empres_usuar,
                                                       Input b_val_origin_bem_pat.dat_calc_pat,
                                                       Input b_val_origin_bem_pat.val_original,
                                                       Input param_calc_bem_pat.cod_finalid_econ,
                                                       output v_cod_return) .
                if  v_cod_return <> "OK" /*l_ok*/ 
                then do:
                    run pi_testar_retorno_converter_finalid .
                    if  return-value = "NOK" /*l_nok*/ 
                    then do:
                        return "NOK" /*l_nok*/ .
                    end /* if */.
                end /* if */.
                find first tt_converter_finalid_econ no-error.
                create val_origin_bem_pat.
                assign val_origin_bem_pat.num_id_bem_pat          = bem_pat.num_id_bem_pat
                       val_origin_bem_pat.num_seq_incorp_bem_pat  = 0
                       val_origin_bem_pat.cod_cenar_ctbl          = b_val_origin_bem_pat.cod_cenar_ctbl
                       val_origin_bem_pat.cod_finalid_econ        = b_val_origin_bem_pat.cod_finalid_econ
                       val_origin_bem_pat.num_seq_movto_bem_pat   = movto_bem_pat.num_seq_movto_bem_pat
                       val_origin_bem_pat.dat_calc_pat            = movto_bem_pat.dat_movto_bem_pat
                       val_origin_bem_pat.val_original            = round(b_val_origin_bem_pat.val_original * (tt_desmembrto_bem_pat.tta_val_perc_movto_bem_pat / 100),2)
                       val_origin_bem_pat.val_despes_financ       = v_val_despes_financ * (tt_desmembrto_bem_pat.tta_val_perc_movto_bem_pat / 100)
                       val_origin_bem_pat.val_dif_val_origin      = 0               
                       val_origin_bem_pat.dat_cotac_indic_econ   = if avail tt_converter_finalid_econ then tt_converter_finalid_econ.tta_dat_cotac_indic_econ else ?
                       val_origin_bem_pat.val_cotac_indic_econ   = if avail tt_converter_finalid_econ then tt_converter_finalid_econ.tta_val_cotac_indic_econ else 0.

                run pi_retornar_finalid_indic_econ (Input input frame f_dlg_03_bem_pat_desmembramento indic_econ.cod_indic_econ,
                                                    Input input frame f_dlg_03_bem_pat_desmembramento v_dat_desmbrto,
                                                    output v_cod_finalid_econ) /* pi_retornar_finalid_indic_econ*/.
                validate val_origin_bem_pat.
                if  b_val_origin_bem_pat.cod_finalid_econ = v_cod_finalid_econ_bem_orig and
                    b_val_origin_bem_pat.cod_cenar_ctbl = v_cod_cenar_ctbl_fisc
                then do:
                    assign bem_pat.dat_calc_pat = val_origin_bem_pat.dat_calc_pat
                           bem_pat.cod_indic_econ = v_cod_indic_econ_bem_orig
                           bem_pat.val_original = val_origin_bem_pat.val_original
                           bem_pat.cod_indic_econ_avaliac = v_cod_indic_econ_bem_orig
                           bem_pat.val_avaliac_apol_seguro = val_origin_bem_pat.val_original
                           bem_pat.dat_avaliac_apol_seguro = val_origin_bem_pat.dat_calc_pat.
                end /* if */.
            end /* if */.
        end.    
    end /* for tt_desmembrto_bem_pat_block */.
END PROCEDURE. /* pi_tt_desmembrto */
/*****************************************************************************
** Procedure Interna.....: pi_validar_param_ctbz_cta_pat_desm
** Descricao.............: pi_validar_param_ctbz_cta_pat_desm
** Criado por............: src12337
** Criado em.............: 16/10/2001 13:36:14
** Alterado por..........: Menna
** Alterado em...........: 30/10/2002 17:03:18
*****************************************************************************/
PROCEDURE pi_validar_param_ctbz_cta_pat_desm:

    /************************ Parameter Definition Begin ************************/

    def param buffer p_bem_pat
        for bem_pat.
    def Input param p_dat_movto_bem_pat
        as date
        format "99/99/9999"
        no-undo.
    def output param p_cod_return
        as character
        format "x(40)"
        no-undo.


    /************************* Parameter Definition End *************************/

    blk_param:
    for each param_calc_bem_pat
        where param_calc_bem_pat.num_id_bem_pat = p_bem_pat.num_id_bem_pat
        and   param_calc_bem_pat.cod_tip_calc  <> ''
        no-lock:
        find finalid_econ
            where finalid_econ.cod_finalid_econ = param_calc_bem_pat.cod_finalid_econ
            no-lock no-error.
        if  avail finalid_econ and
            finalid_econ.ind_armaz_val = "Ativo Fixo" /*l_ativo_fixo*/ 
        then do:
            next blk_param.
        end /* if */.
        find first param_ctbz_cta_pat no-lock
            where param_ctbz_cta_pat.cod_empresa      = p_bem_pat.cod_empresa
            and   param_ctbz_cta_pat.cod_cta_pat      = p_bem_pat.cod_cta_pat
            and   param_ctbz_cta_pat.cod_cenar_ctbl   = param_calc_bem_pat.cod_cenar_ctbl
            and   param_ctbz_cta_pat.cod_finalid_econ = param_calc_bem_pat.cod_finalid_econ
            and   param_ctbz_cta_pat.ind_finalid_ctbl = "Desmembramento" /*l_desmembramento*/ 
            and   param_ctbz_cta_pat.dat_inic_valid  <= p_dat_movto_bem_pat
            and   param_ctbz_cta_pat.dat_fim_valid   >= p_dat_movto_bem_pat
            no-error.
        if  not avail param_ctbz_cta_pat
        then do:
            assign p_cod_return = "1111" + chr(10) + p_bem_pat.cod_cta_pat + chr(10) + "Desmembramento" /*l_desmembramento*/  + chr(10) +
                                  param_calc_bem_pat.cod_finalid_econ + chr(10) + param_calc_bem_pat.cod_cenar_ctbl.
            return "NOK" /*l_nok*/ .
        end /* if */.
    end.
    return "OK" /*l_ok*/ .

END PROCEDURE. /* pi_validar_param_ctbz_cta_pat_desm */
/*****************************************************************************
** Procedure Interna.....: pi_verificar_valores_originais_origem
** Descricao.............: pi_verificar_valores_originais_origem
** Criado por............: src12337
** Criado em.............: 20/11/2001 15:27:27
** Alterado por..........: corp45760
** Alterado em...........: 28/09/2015 11:26:08
*****************************************************************************/
PROCEDURE pi_verificar_valores_originais_origem:

    /************************ Parameter Definition Begin ************************/

    def Input param p_log_verific
        as logical
        format "Sim/N∆o"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************** Buffer Definition Begin *************************/

    def buffer b_val_origin_bem_pat
        for val_origin_bem_pat.


    /*************************** Buffer Definition End **************************/

    /************************* Variable Definition Begin ************************/

    def var v_rec_obj
        as recid
        format ">>>>>>9":U
        no-undo.
    def var v_val_aux
        as decimal
        format "->>,>>>,>>>,>>9.99":U
        decimals 2
        initial 0
        no-undo.
    def var v_val_maior
        as decimal
        format "->>,>>>,>>>,>>9.99":U
        decimals 2
        no-undo.
    def var v_val_perc_tot_bxa
        as decimal
        format "->>,>>>,>>>,>>9.9999999999":U
        decimals 10
        initial 0
        label "Perc Tot Baixa"
        column-label "Perc Tot Baixa"
        no-undo.


    /************************** Variable Definition End *************************/

    for each tt_desmembrto_bem_pat:
        assign v_val_perc_tot_bxa = v_val_perc_tot_bxa + tt_desmembrto_bem_pat.tta_val_perc_movto_bem_pat.
    end.
    if  not p_log_verific then do:
        for each tt_verifica_diferenca_desmem.
            delete tt_verifica_diferenca_desmem.
        end.
        /* Essa pi vai fazer a verificaá∆o da val_origin_bem_pat, se os valores baixados correspondem ao valor desmembrado
        primeiro grava-se os valores originais que deveriam ser baixados*/
        assign v_val_aux = 0.

        for each val_origin_bem_pat no-lock
            where val_origin_bem_pat.num_id_bem_pat = b_bem_pat.num_id_bem_pat
            and   val_origin_bem_pat.dat_calc_pat   = v_dat_desmbrto
            break by val_origin_bem_pat.cod_cenar_ctbl
                  by val_origin_bem_pat.cod_finalid_econ.
            find last b_val_origin_bem_pat
                where b_val_origin_bem_pat.num_id_bem_pat = b_bem_pat.num_id_bem_pat
                and   b_val_origin_bem_pat.cod_cenar_ctbl = val_origin_bem_pat.cod_cenar_ctbl
                and   b_val_origin_bem_pat.cod_finalid_econ = val_origin_bem_pat.cod_finalid_econ
                and   b_val_origin_bem_pat.num_seq_incorp_bem_pat = val_origin_bem_pat.num_seq_incorp_bem_pat
                AND   b_val_origin_bem_pat.dat_calc_pat < v_dat_desmbrto
                no-lock.

            assign v_val_aux = v_val_aux + round(b_val_origin_bem_pat.val_original,2).
            if  last-of(val_origin_bem_pat.cod_finalid_econ) then do:
                create tt_verifica_diferenca_desmem.
                assign tt_verifica_diferenca_desmem.tta_cod_cenar_ctbl = val_origin_bem_pat.cod_cenar_ctbl
                       tt_verifica_diferenca_desmem.tta_cod_finalid_econ = val_origin_bem_pat.cod_finalid_econ.

                if  v_val_perc_tot_bxa = 100 then
                    assign tt_verifica_diferenca_desmem.tta_val_original = v_val_aux.
                else do:
                    for each tt_desmembrto_bem_pat:
                        assign tt_verifica_diferenca_desmem.tta_val_original = tt_verifica_diferenca_desmem.tta_val_original + round(v_val_aux * tt_desmembrto_bem_pat.tta_val_perc_movto_bem_pat / 100,2).
                    end.
                    if  ((if tt_verifica_diferenca_desmem.tta_val_original >= 0 then tt_verifica_diferenca_desmem.tta_val_original else (tt_verifica_diferenca_desmem.tta_val_original * - 1)) > (if v_val_aux >= 0 then v_val_aux else (v_val_aux * -1))) then
                        assign tt_verifica_diferenca_desmem.tta_val_original = v_val_aux.
                end.
                assign v_val_aux = 0.
            end.
        end.
    end.
    else do:
        /* Nesse ponto Ç verificado se os valores baixados correspondem ao desmembrado */
        for each val_origin_bem_pat
            where val_origin_bem_pat.num_id_bem_pat = b_bem_pat.num_id_bem_pat
            and   val_origin_bem_pat.num_seq_incorp_bem_pat = 0
            and   val_origin_bem_pat.dat_calc_pat = input frame f_dlg_03_bem_pat_desmembramento v_dat_desmbrto
            no-lock.
            assign v_val_aux = 0 v_val_maior = 0 v_rec_obj = ?.
            for each b_val_origin_bem_pat no-lock
                where b_val_origin_bem_pat.num_id_bem_pat = b_bem_pat.num_id_bem_pat
                and   b_val_origin_bem_pat.cod_cenar_ctbl = val_origin_bem_pat.cod_cenar_ctbl
                and   b_val_origin_bem_pat.cod_finalid_econ = val_origin_bem_pat.cod_finalid_econ
                and   b_val_origin_bem_pat.dat_calc_pat = input frame f_dlg_03_bem_pat_desmembramento v_dat_desmbrto
                break by b_val_origin_bem_pat.num_seq_incorp_bem_pat:
                assign v_val_aux = v_val_aux + round(b_val_origin_bem_pat.val_dif_val_origin,2).
                if abs(v_val_maior) < abs(b_val_origin_bem_pat.val_original) then
                    assign v_val_maior = b_val_origin_bem_pat.val_original
                           v_rec_obj = recid(b_val_origin_bem_pat).
                else
                    if  v_rec_obj = ? then
                        assign v_val_maior = b_val_origin_bem_pat.val_original
                               v_rec_obj = recid(b_val_origin_bem_pat).
            end.
            find first tt_verifica_diferenca_desmem
                where tt_verifica_diferenca_desmem.tta_cod_cenar_ctbl = val_origin_bem_pat.cod_cenar_ctbl
                and   tt_verifica_diferenca_desmem.tta_cod_finalid_econ = val_origin_bem_pat.cod_finalid_econ
                no-error.
            if avail tt_verifica_diferenca_desmem and tt_verifica_diferenca_desmem.tta_val_original <> v_val_aux then do:
                find b_val_origin_bem_pat
                    where recid(b_val_origin_bem_pat) = v_rec_obj exclusive-lock no-error.
                if avail b_val_origin_bem_pat then do:
                    if  ((if tt_verifica_diferenca_desmem.tta_val_original >= 0 then tt_verifica_diferenca_desmem.tta_val_original else (tt_verifica_diferenca_desmem.tta_val_original * - 1)) > (if v_val_aux >= 0 then v_val_aux else (v_val_aux * -1))) then
                        assign b_val_origin_bem_pat.val_dif_val_origin = b_val_origin_bem_pat.val_dif_val_origin + (tt_verifica_diferenca_desmem.tta_val_original - v_val_aux)
                               b_val_origin_bem_pat.val_original       = b_val_origin_bem_pat.val_original - (tt_verifica_diferenca_desmem.tta_val_original - v_val_aux).
                    else
                        if round(v_val_perc_tot_bxa,0) <> 100 then
                            assign b_val_origin_bem_pat.val_dif_val_origin = b_val_origin_bem_pat.val_dif_val_origin - (v_val_aux - tt_verifica_diferenca_desmem.tta_val_original)
                                   b_val_origin_bem_pat.val_original       = b_val_origin_bem_pat.val_original + (v_val_aux - tt_verifica_diferenca_desmem.tta_val_original).
                        else
                            assign tt_verifica_diferenca_desmem.tta_val_original = v_val_aux.
                end.
            end.
        end.        
    end.
END PROCEDURE. /* pi_verificar_valores_originais_origem */
/*****************************************************************************
** Procedure Interna.....: pi_bt_ok_bem_pat_desmembr_calc_parc
** Descricao.............: pi_bt_ok_bem_pat_desmembr_calc_parc
** Criado por............: its0042
** Criado em.............: 20/08/2004 17:13:16
** Alterado por..........: fut41422
** Alterado em...........: 27/09/2011 11:01:28
*****************************************************************************/
PROCEDURE pi_bt_ok_bem_pat_desmembr_calc_parc:

    /************************ Parameter Definition Begin ************************/

    def Input param p_num_seq_incorp_bem_pat
        as integer
        format ">>,>>>>,>>9"
        no-undo.
    def Input param p_num_parc_pis_cofins
        as integer
        format "999"
        no-undo.


    /************************* Parameter Definition End *************************/

    find last calc_parc_pis_cofins no-lock
        where calc_parc_pis_cofins.cod_empresa            = b_bem_pat_parc.cod_empresa
        and   calc_parc_pis_cofins.cod_cta_pat            = b_bem_pat_parc.cod_cta_pat
        and   calc_parc_pis_cofins.num_bem_pat            = b_bem_pat_parc.num_bem_pat
        and   calc_parc_pis_cofins.num_seq_bem_pat        = b_bem_pat_parc.num_seq_bem_pat
        and   calc_parc_pis_cofins.num_seq_incorp_bem_pat = p_num_seq_incorp_bem_pat no-error.
    if  avail calc_parc_pis_cofins then do:
        if (calc_parc_pis_cofins.cod_exerc_ctbl  < period_ctbl.cod_exerc_ctbl
        or  calc_parc_pis_cofins.num_period_ctbl < period_ctbl.num_period_ctbl)
        and calc_parc_pis_cofins.num_parcela_cr <> p_num_parc_pis_cofins then do:
            /* Desmembramento n∆o permitido ! */
            run pi_messages (input "show",
                             input 13403,
                             input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_13403*/.
            return "NOK" /*l_nok*/ .
        end.
        /* Rodrigo - TDRSUJ*/
        if  calc_parc_pis_cofins.cod_exerc_ctbl  >= period_ctbl.cod_exerc_ctbl
        and calc_parc_pis_cofins.num_period_ctbl >  period_ctbl.num_period_ctbl then do:
            /* Desmembramento n∆o permitido ! */
            run pi_messages (input "show",
                             input 13404,
                             input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_13404*/.
            return "NOK" /*l_nok*/ .
        end.
        /* Rodrigo - TDRSUJ*/

        /* Cria temp-table com as informaá‰es do calc_parc_pis_cofins. */
        find tt_calc_parc_pis_cofins no-lock
            where tt_calc_parc_pis_cofins.tta_num_id_calc_parc = calc_parc_pis_cofins.num_id_calc_parc no-error.
        if  not avail tt_calc_parc_pis_cofins then do:
            create tt_calc_parc_pis_cofins.
            assign tt_calc_parc_pis_cofins.tta_num_id_calc_parc = calc_parc_pis_cofins.num_id_calc_parc.
        end.
    end.
    else do:
        /* Caso seja incorporaá∆o e a data da incorp seja maior que data final do periodo
         * n∆o apresenta mensagem de erro abaixo e verifica se existe outro registro de incorporaá∆o para o bem. */
        if  p_num_seq_incorp_bem_pat <> 0
        and (avail incorp_bem_pat and incorp_bem_pat.dat_incorp_bem_pat > period_ctbl.dat_fim_period_ctbl) then
            return 'next_incorp':U.

        /* Desmembramento n∆o permitido ! */
        run pi_messages (input "show",
                         input 13403,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_13403*/.
        return "NOK" /*l_nok*/ .
    end.

    return "OK" /*l_ok*/ .
END PROCEDURE. /* pi_bt_ok_bem_pat_desmembr_calc_parc */
/*****************************************************************************
** Procedure Interna.....: pi_implantar_bem_par_desmbrto_calc_parc
** Descricao.............: pi_implantar_bem_par_desmbrto_calc_parc
** Criado por............: its0042
** Criado em.............: 20/08/2004 17:45:13
** Alterado por..........: danielidk
** Alterado em...........: 01/09/2017 11:39:20
*****************************************************************************/
PROCEDURE pi_implantar_bem_par_desmbrto_calc_parc:

    /************************ Parameter Definition Begin ************************/

    def Input param p_num_seq_incorp_bem_pat
        as integer
        format ">>,>>>>,>>9"
        no-undo.


    /************************* Parameter Definition End *************************/

    for each tt_calc_parc_pis_cofins no-lock:
        find b_calc_parc_pis_cofins no-lock
            where b_calc_parc_pis_cofins.num_id_calc_parc = tt_calc_parc_pis_cofins.tta_num_id_calc_parc no-error.
        if  avail b_calc_parc_pis_cofins 
        and b_calc_parc_pis_cofins.num_seq_incorp_bem_pat = p_num_seq_incorp_bem_pat then do:
            create calc_parc_pis_cofins.
            assign calc_parc_pis_cofins.cod_empresa            = bem_pat.cod_empresa
                   calc_parc_pis_cofins.cod_cta_pat            = bem_pat.cod_cta_pat
                   calc_parc_pis_cofins.num_bem_pat            = bem_pat.num_bem_pat
                   calc_parc_pis_cofins.num_seq_bem_pat        = bem_pat.num_seq_bem_pat
                   calc_parc_pis_cofins.num_seq_incorp_bem_pat = b_calc_parc_pis_cofins.num_seq_incorp_bem_pat
                   calc_parc_pis_cofins.cod_exerc_ctbl         = period_ctbl.cod_exerc_ctbl
                   calc_parc_pis_cofins.num_period_ctbl        = period_ctbl.num_period_ctbl
                   calc_parc_pis_cofins.num_parcela_cr         = b_calc_parc_pis_cofins.num_parcela_cr
                   calc_parc_pis_cofins.log_ctbz_aprop_ctbl    = no
                   calc_parc_pis_cofins.num_id_calc_parc       = next-value(seq_calc_parc_pis_cofins)           
                   calc_parc_pis_cofins.log_nao_elimina_parc   = yes.

            find tt_acum_calc_parc_pis_cofins
                where tt_acum_calc_parc_pis_cofins.tta_num_id_bem_pat         = b_bem_pat_parc.num_id_bem_pat
                and   tt_acum_calc_parc_pis_cofins.tta_num_seq_incorp_bem_pat = b_calc_parc_pis_cofins.num_seq_incorp_bem_pat no-error.
            if  avail tt_acum_calc_parc_pis_cofins then do:

                    if  b_calc_parc_pis_cofins.num_seq_incorp_bem_pat = 0 then
                        assign calc_parc_pis_cofins.val_cr_pis    = calc_parc_pis_cofins.val_cr_pis
                                                                  + ((tt_acum_calc_parc_pis_cofins.ttv_val_sdo_cr_pis - tt_acum_calc_parc_pis_cofins.ttv_val_tot_parc_gerad_pis - b_calc_parc_pis_cofins.val_cr_pis_bxa) * (tt_desmembrto_bem_pat.tta_val_perc_movto_bem_pat / 100))
                               calc_parc_pis_cofins.val_cr_cofins = calc_parc_pis_cofins.val_cr_cofins
                                                                  + ((tt_acum_calc_parc_pis_cofins.ttv_val_sdo_cr_cofins - tt_acum_calc_parc_pis_cofins.ttv_val_tot_parc_gerad_cofins - b_calc_parc_pis_cofins.val_cr_cofins_bxa) * (tt_desmembrto_bem_pat.tta_val_perc_movto_bem_pat / 100)).
                    else
                        assign calc_parc_pis_cofins.val_cr_pis    = calc_parc_pis_cofins.val_cr_pis
                                                                  + ((tt_acum_calc_parc_pis_cofins.ttv_val_sdo_cr_pis_incorp - tt_acum_calc_parc_pis_cofins.ttv_val_tot_parc_pis_incorp - b_calc_parc_pis_cofins.val_cr_pis_bxa) * (tt_desmembrto_bem_pat.tta_val_perc_movto_bem_pat / 100))
                               calc_parc_pis_cofins.val_cr_cofins = calc_parc_pis_cofins.val_cr_cofins
                                                                  + ((tt_acum_calc_parc_pis_cofins.ttv_val_sdo_cr_cofins_incorp - tt_acum_calc_parc_pis_cofins.ttv_val_tot_parc_cofins_incorp - b_calc_parc_pis_cofins.val_cr_cofins_bxa) * (tt_desmembrto_bem_pat.tta_val_perc_movto_bem_pat / 100)).

            end.
        end.
    end.
END PROCEDURE. /* pi_implantar_bem_par_desmbrto_calc_parc */
/*****************************************************************************
** Procedure Interna.....: pi_atualiz_val_cr_pis_cofins_bxa
** Descricao.............: pi_atualiz_val_cr_pis_cofins_bxa
** Criado por............: fut1074
** Criado em.............: 11/03/2005 19:23:15
** Alterado por..........: danielidk
** Alterado em...........: 01/09/2017 11:02:16
*****************************************************************************/
PROCEDURE pi_atualiz_val_cr_pis_cofins_bxa:

    /************************ Parameter Definition Begin ************************/

    def Input param p_num_seq_incorp_bem_pat
        as integer
        format ">>,>>>>,>>9"
        no-undo.
    def Input param p_val_tot_parc_gerad_pis
        as decimal
        format "->>,>>>,>>>,>>9.99"
        decimals 2
        no-undo.
    def Input param p_val_tot_parc_gerad_cofins
        as decimal
        format "->>,>>>,>>>,>>9.99"
        decimals 2
        no-undo.
    def Input param p_val_sdo_cr_pis
        as decimal
        format "->>,>>>,>>>,>>9.99"
        decimals 2
        no-undo.
    def Input param p_val_sdo_cr_cofins
        as decimal
        format "->>,>>>,>>>,>>9.99"
        decimals 2
        no-undo.
    def Input param p_val_perc_bxa
        as decimal
        format ">>9.99"
        decimals 10
        no-undo.
    def param buffer p_bem_pat
        for bem_pat.
    def output param p_log_valid_calc_parc
        as logical
        format "Sim/N∆o"
        no-undo.
    def Input param p_num_parc_pis_cofins
        as integer
        format "999"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_val_cr_cofins_bxa
        as decimal
        format ">>>,>>>,>>9.99":U
        decimals 2
        no-undo.
    def var v_val_cr_pis_bxa
        as decimal
        format ">>>,>>>,>>9.99":U
        decimals 2
        no-undo.


    /************************** Variable Definition End *************************/


    assign p_log_valid_calc_parc = no.

    if Verifica_Program_Name('fas703za':U, 15) then
        assign  v_val_cr_pis_bxa_ant    = 0
                v_val_cr_cofins_bxa_ant = 0.

    /* Localiza ultimo regsitro calc_parc_pis_cofins referente ao bem que est† sendo baixado */
    find last calc_parc_pis_cofins exclusive-lock
        where calc_parc_pis_cofins.cod_empresa     = p_bem_pat.cod_empresa
        and   calc_parc_pis_cofins.cod_cta_pat     = p_bem_pat.cod_cta_pat
        and   calc_parc_pis_cofins.num_bem_pat     = p_bem_pat.num_bem_pat
        and   calc_parc_pis_cofins.num_seq_bem_pat = p_bem_pat.num_seq_bem_pat
        and   calc_parc_pis_cofins.num_seq_incorp_bem_pat = p_num_seq_incorp_bem_pat no-error.
    if  avail calc_parc_pis_cofins
    and calc_parc_pis_cofins.num_parcela_cr < p_num_parc_pis_cofins then do:
        assign p_log_valid_calc_parc = yes.

        /* Verifica valor para bens implantados por desmembramento ou reclassificaá∆o
         * e que nao tenha nenhuma parcela gerada (Apropriaá∆o de Implantaá∆o, Parcelas e Baixa) */
        if  not avail tt_acum_calc_parc_pis_cofins then do:
            if  p_val_sdo_cr_pis = 0 then do:
                assign p_val_sdo_cr_pis = p_val_sdo_cr_pis - calc_parc_pis_cofins.val_cr_pis_bxa.            
            end.
            if  p_val_sdo_cr_cofins = 0 then do:
                assign p_val_sdo_cr_cofins = p_val_sdo_cr_cofins - calc_parc_pis_cofins.val_cr_cofins_bxa.            
            end.
        end.

        assign v_val_cr_pis_bxa = calc_parc_pis_cofins.val_cr_pis_bxa
               v_val_cr_cofins_bxa = calc_parc_pis_cofins.val_cr_cofins_bxa.

        if Verifica_Program_Name('fas703za':U, 15) then
            assign v_val_cr_pis_bxa_ant    = v_val_cr_pis_bxa
                   v_val_cr_cofins_bxa_ant = v_val_cr_cofins_bxa.

        assign calc_parc_pis_cofins.val_cr_pis_bxa    = (((p_val_sdo_cr_pis - p_val_tot_parc_gerad_pis) - v_val_cr_pis_bxa ) * (p_val_perc_bxa / 100))
               calc_parc_pis_cofins.val_cr_cofins_bxa = (((p_val_sdo_cr_cofins - p_val_tot_parc_gerad_cofins) - v_val_cr_cofins_bxa) * (p_val_perc_bxa / 100)).

        assign calc_parc_pis_cofins.val_cr_pis_bxa = calc_parc_pis_cofins.val_cr_pis_bxa + v_val_cr_pis_bxa
               calc_parc_pis_cofins.val_cr_cofins_bxa = calc_parc_pis_cofins.val_cr_cofins_bxa + v_val_cr_cofins_bxa.

    end.
END PROCEDURE. /* pi_atualiz_val_cr_pis_cofins_bxa */
/*****************************************************************************
** Procedure Interna.....: pi_vrf_valor_tot_parc_gerada
** Descricao.............: pi_vrf_valor_tot_parc_gerada
** Criado por............: fut1074
** Criado em.............: 14/03/2005 15:31:45
** Alterado por..........: danielidk
** Alterado em...........: 21/09/2017 16:05:31
*****************************************************************************/
PROCEDURE pi_vrf_valor_tot_parc_gerada:

    /************************ Parameter Definition Begin ************************/

    def param buffer p_bem_pat
        for bem_pat.
    def Input param p_num_seq_incorp_bem_pat
        as integer
        format ">>,>>>>,>>9"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************** Buffer Definition Begin *************************/

    def buffer b_movto_bem_pat_aux
        for movto_bem_pat.


    /*************************** Buffer Definition End **************************/

    /************************* Variable Definition Begin ************************/

    def var v_log_imobilizado
        as logical
        format "Sim/N∆o"
        initial no
        no-undo.
    def var v_log_imob_incorp
        as logical
        format "Sim/N∆o"
        initial no
        no-undo.
    def var v_log_parc_desc
        as logical
        format "Sim/N∆o"
        initial no
        no-undo.
    def var v_num_parc_pis_cofins_aux
        as integer
        format "999":U
        no-undo.
    def var v_val_acum_bxa_cofins
        as decimal
        format "->>,>>>,>>>,>>9.99":U
        decimals 2
        no-undo.
    def var v_val_acum_bxa_cofins_incorp
        as decimal
        format "->>,>>>,>>>,>>9.99":U
        decimals 2
        no-undo.
    def var v_val_acum_bxa_pis
        as decimal
        format "->>,>>>,>>>,>>9.99":U
        decimals 2
        no-undo.
    def var v_val_acum_bxa_pis_incorp
        as decimal
        format "->>,>>>,>>>,>>9.99":U
        decimals 2
        no-undo.
    def var v_val_acum_parc_cofins
        as decimal
        format "->>,>>>,>>>,>>9.99":U
        decimals 2
        no-undo.
    def var v_val_acum_parc_cofins_incorp
        as decimal
        format "->>,>>>,>>>,>>9.99":U
        decimals 2
        no-undo.
    def var v_val_acum_parc_pis
        as decimal
        format "->>,>>>,>>>,>>9.99":U
        decimals 2
        no-undo.
    def var v_val_acum_parc_pis_incorp
        as decimal
        format "->>,>>>,>>>,>>9.99":U
        decimals 2
        no-undo.
    def var v_val_cr_cofins
        as decimal
        format ">>>,>>>,>>9.99":U
        decimals 2
        label "Valor CrÇdito COFINS"
        column-label "Credito COFINS"
        no-undo.
    def var v_val_cr_cofins_desc
        as decimal
        format "->>,>>>,>>>,>>9.99":U
        decimals 2
        no-undo.
    def var v_val_cr_pis
        as decimal
        format ">>>,>>>,>>9.99":U
        decimals 2
        label "Valor CrÇdito PIS"
        column-label "Vl Cred PIS/PASEP"
        no-undo.
    def var v_val_cr_pis_desc
        as decimal
        format "->>,>>>,>>>,>>9.99":U
        decimals 2
        no-undo.
    def var v_val_tot_parc_cofins_incorp
        as decimal
        format "->>,>>>,>>>,>>9.99":U
        decimals 2
        no-undo.
    def var v_val_tot_parc_gerad_cofins
        as decimal
        format "->>,>>>,>>>,>>9.99":U
        decimals 2
        no-undo.
    def var v_val_tot_parc_gerad_pis
        as decimal
        format "->>,>>>,>>>,>>9.99":U
        decimals 2
        no-undo.
    def var v_val_tot_parc_pis_incorp
        as decimal
        format "->>,>>>,>>>,>>9.99":U
        decimals 2
        no-undo.


    /************************** Variable Definition End *************************/

    find pais no-lock
        where pais.cod_pais = "BRA" /*l_bra*/  no-error.
    if  avail pais then
        assign v_cod_finalid_econ_pais = pais.cod_finalid_econ_pais.

    FOR EACH tt_acum_calc_parc_pis_cofins   
    where tt_acum_calc_parc_pis_cofins.tta_num_id_bem_pat         = p_bem_pat.num_id_bem_pat
    and   tt_acum_calc_parc_pis_cofins.tta_num_seq_incorp_bem_pat = p_num_seq_incorp_bem_pat:
        DELETE tt_acum_calc_parc_pis_cofins. 
    END.

    assign v_val_parc_pag_pis            = 0
           v_val_parc_pag_cofins         = 0
           v_val_acum_parc_pis           = 0
           v_val_acum_parc_cofins        = 0
           v_val_acum_bxa_cofins         = 0
           v_val_acum_bxa_pis            = 0
           v_val_acum_parc_pis_incorp    = 0
           v_val_acum_parc_cofins_incorp = 0
           v_val_acum_bxa_cofins_incorp  = 0
           v_val_acum_bxa_pis_incorp     = 0
           v_log_imobilizado             = no
           v_log_imob_incorp             = no
           v_log_parc_desc               = no.

    /* Verifica valor total de parcelas geradas */
    calc_block:
    for each calc_parc_pis_cofins no-lock
        where calc_parc_pis_cofins.cod_empresa            = p_bem_pat.cod_empresa
        and   calc_parc_pis_cofins.cod_cta_pat            = p_bem_pat.cod_cta_pat
        and   calc_parc_pis_cofins.num_bem_pat            = p_bem_pat.num_bem_pat
        and   calc_parc_pis_cofins.num_seq_bem_pat        = p_bem_pat.num_seq_bem_pat
        and   calc_parc_pis_cofins.num_seq_incorp_bem_pat = p_num_seq_incorp_bem_pat
        break by calc_parc_pis_cofins.num_parcela_cr:

        if first(calc_parc_pis_cofins.num_parcela_cr) then do:
            if calc_parc_pis_cofins.num_parcela_cr <> 1 then
                assign v_log_parc_desc = yes.
        end.

        find tt_acum_calc_parc_pis_cofins
            where tt_acum_calc_parc_pis_cofins.tta_num_id_bem_pat         = p_bem_pat.num_id_bem_pat
            and   tt_acum_calc_parc_pis_cofins.tta_num_seq_incorp_bem_pat = calc_parc_pis_cofins.num_seq_incorp_bem_pat no-error.
        if  not avail tt_acum_calc_parc_pis_cofins then do:
            create tt_acum_calc_parc_pis_cofins.
            assign tt_acum_calc_parc_pis_cofins.tta_num_id_bem_pat         = p_bem_pat.num_id_bem_pat
                   tt_acum_calc_parc_pis_cofins.tta_num_seq_incorp_bem_pat = calc_parc_pis_cofins.num_seq_incorp_bem_pat.
        end.    

        for each aprop_parc_pis_cofins no-lock
            where aprop_parc_pis_cofins.num_id_calc_parc = calc_parc_pis_cofins.num_id_calc_parc
            and   aprop_parc_pis_cofins.cod_cenar_ctbl   = utiliz_cenar_ctbl.cod_cenar_ctbl
            and   aprop_parc_pis_cofins.cod_finalid_econ = v_cod_finalid_econ_pais:

            if  calc_parc_pis_cofins.num_seq_incorp_bem_pat = 0 then do:
                case aprop_parc_pis_cofins.ind_finalid_ctbl:
                    when "Implantaá∆o PIS" /*l_implantacao_pis*/  then do:
                        assign tt_acum_calc_parc_pis_cofins.ttv_val_sdo_cr_pis = aprop_parc_pis_cofins.val_aprop_ctbl
                               v_log_imobilizado = yes.
                    end.
                    when "Implantaá∆o COFINS" /*l_implantacao_cofins*/  then do:
                        assign tt_acum_calc_parc_pis_cofins.ttv_val_sdo_cr_cofins = aprop_parc_pis_cofins.val_aprop_ctbl
                               v_log_imobilizado = yes.
                    end.                
                    when "Parcela PIS" /*l_parcela_pis*/  then
                        assign v_val_acum_parc_pis = v_val_acum_parc_pis + aprop_parc_pis_cofins.val_aprop_ctbl.
                    when "Parcela COFINS" /*l_parcela_cofins*/  then
                        assign v_val_acum_parc_cofins = v_val_acum_parc_cofins + aprop_parc_pis_cofins.val_aprop_ctbl.
                    when "Baixa PIS" /*l_baixa_pis*/  then
                        assign v_val_acum_bxa_pis = v_val_acum_bxa_pis + aprop_parc_pis_cofins.val_aprop_ctbl.
                    when "Baixa COFINS" /*l_baixa_cofins*/  then
                        assign v_val_acum_bxa_cofins = v_val_acum_bxa_cofins + aprop_parc_pis_cofins.val_aprop_ctbl.
                end case.
            end.
            else do:
                case aprop_parc_pis_cofins.ind_finalid_ctbl:
                    when "Implantaá∆o PIS" /*l_implantacao_pis*/  then do:
                        assign tt_acum_calc_parc_pis_cofins.ttv_val_sdo_cr_pis_incorp = aprop_parc_pis_cofins.val_aprop_ctbl
                               v_log_imob_incorp = yes.
                    end.
                    when "Implantaá∆o COFINS" /*l_implantacao_cofins*/  then do:
                        assign tt_acum_calc_parc_pis_cofins.ttv_val_sdo_cr_cofins_incorp = aprop_parc_pis_cofins.val_aprop_ctbl
                               v_log_imob_incorp = yes.
                    end.                
                    when "Parcela PIS" /*l_parcela_pis*/  then
                        assign v_val_acum_parc_pis_incorp = v_val_acum_parc_pis_incorp + aprop_parc_pis_cofins.val_aprop_ctbl.
                    when "Parcela COFINS" /*l_parcela_cofins*/  then
                        assign v_val_acum_parc_cofins_incorp = v_val_acum_parc_cofins_incorp + aprop_parc_pis_cofins.val_aprop_ctbl.
                    when "Baixa PIS" /*l_baixa_pis*/  then
                        assign v_val_acum_bxa_pis_incorp = v_val_acum_bxa_pis_incorp + aprop_parc_pis_cofins.val_aprop_ctbl.
                    when "Baixa COFINS" /*l_baixa_cofins*/  then
                        assign v_val_acum_bxa_cofins_incorp = v_val_acum_bxa_cofins_incorp + aprop_parc_pis_cofins.val_aprop_ctbl.
                end case.
            end.
        end.


        if (p_bem_pat.val_cr_pis <> 0 and p_bem_pat.num_parc_pis_cofins <> 0) or (p_bem_pat.val_cr_cofins <> 0 and p_bem_pat.num_parc_pis_cofins <> 0) then
            assign v_val_cr_pis_desc    = ((p_bem_pat.val_cr_pis    / p_bem_pat.num_parc_pis_cofins) * calc_parc_pis_cofins.num_parcela_cr)
                   v_val_cr_cofins_desc = ((p_bem_pat.val_cr_cofins / p_bem_pat.num_parc_pis_cofins) * calc_parc_pis_cofins.num_parcela_cr).
        else do:
            if avail incorp_bem_pat then
                assign v_val_cr_pis_desc    = ((incorp_bem_pat.val_cr_pis    / incorp_bem_pat.num_parc_pis_cofins) * calc_parc_pis_cofins.num_parcela_cr)
                       v_val_cr_cofins_desc = ((incorp_bem_pat.val_cr_cofins / incorp_bem_pat.num_parc_pis_cofins) * calc_parc_pis_cofins.num_parcela_cr).
        end.

        if calc_parc_pis_cofins.num_seq_incorp_bem_pat = 0 then
            assign v_val_tot_parc_gerad_pis    = v_val_cr_pis_desc
                   v_val_tot_parc_gerad_cofins = v_val_cr_cofins_desc.
        else
            assign v_val_tot_parc_pis_incorp    = v_val_cr_pis_desc
                   v_val_tot_parc_cofins_incorp = v_val_cr_cofins_desc.

        if calc_parc_pis_cofins.num_seq_incorp_bem_pat <> 0 then do:
            assign v_val_parc_pag_pis = v_val_parc_pag_pis + (incorp_bem_pat.val_cr_pis / incorp_bem_pat.num_parc_pis_cofins)
                   v_val_parc_pag_cofins = v_val_parc_pag_cofins + (incorp_bem_pat.val_cr_cofins / incorp_bem_pat.num_parc_pis_cofins).            
        end.


        if v_val_cr_pis = ? then
            assign v_val_cr_pis = 0.
        if v_val_cr_cofins = ? then
            assign v_val_cr_cofins = 0.
        if v_val_cr_pis_desc = ? then
            assign v_val_cr_pis_desc = 0.
        if v_val_cr_cofins_desc = ? then
            assign v_val_cr_cofins_desc = 0.
        if v_val_tot_parc_pis_incorp = ? then
            assign v_val_tot_parc_pis_incorp = 0.
        if v_val_tot_parc_cofins_incorp = ? then
            assign v_val_tot_parc_cofins_incorp = 0.
        if v_val_parc_pag_pis = ? then
            assign v_val_parc_pag_pis = 0.
        if v_val_parc_pag_cofins = ? then
            assign v_val_parc_pag_cofins = 0.    

        if calc_parc_pis_cofins.num_seq_incorp_bem_pat = 0 then do:
            assign tt_acum_calc_parc_pis_cofins.ttv_val_tot_parc_gerad_pis     = v_val_tot_parc_gerad_pis   
                   tt_acum_calc_parc_pis_cofins.ttv_val_tot_parc_gerad_cofins  = v_val_tot_parc_gerad_cofins
                   tt_acum_calc_parc_pis_cofins.ttv_val_tot_parc_pis_incorp    = v_val_tot_parc_pis_incorp
                   tt_acum_calc_parc_pis_cofins.ttv_val_tot_parc_cofins_incorp = v_val_tot_parc_cofins_incorp.

            find first b_movto_bem_pat_aux no-lock
                where b_movto_bem_pat_aux.num_id_bem_pat         = p_bem_pat.num_id_bem_pat
                and   b_movto_bem_pat_aux.num_seq_incorp_bem_pat = 0
                and   b_movto_bem_pat_aux.ind_trans_calc_bem_pat = "Implantaá∆o" /*l_implant*/  no-error.
            if avail b_movto_bem_pat_aux then do:

                if b_movto_bem_pat_aux.ind_orig_calc_bem_pat = "Reclassificaá∆o" /*l_reclassificacao*/  then
                    assign tt_acum_calc_parc_pis_cofins.ttv_val_tot_parc_gerad_pis     = v_val_acum_parc_pis + v_val_acum_bxa_pis
                           tt_acum_calc_parc_pis_cofins.ttv_val_tot_parc_gerad_cofins  = v_val_acum_parc_cofins + v_val_acum_bxa_cofins.
            end.

        end.
        else do:
            assign tt_acum_calc_parc_pis_cofins.ttv_val_tot_parc_gerad_pis     = v_val_tot_parc_gerad_pis
                   tt_acum_calc_parc_pis_cofins.ttv_val_tot_parc_gerad_cofins  = v_val_tot_parc_gerad_cofins
                   tt_acum_calc_parc_pis_cofins.ttv_val_tot_parc_pis_incorp    = v_val_acum_parc_pis_incorp
                   tt_acum_calc_parc_pis_cofins.ttv_val_tot_parc_cofins_incorp = v_val_acum_parc_cofins_incorp.

            find first b_movto_bem_pat_aux no-lock
                where b_movto_bem_pat_aux.num_id_bem_pat         = p_bem_pat.num_id_bem_pat
                and   b_movto_bem_pat_aux.num_seq_incorp_bem_pat = calc_parc_pis_cofins.num_seq_incorp_bem_pat
                and   b_movto_bem_pat_aux.ind_trans_calc_bem_pat = "Implantaá∆o" /*l_implant*/  no-error.
            if avail b_movto_bem_pat_aux then do:

                if b_movto_bem_pat_aux.ind_orig_calc_bem_pat = "Reclassificaá∆o" /*l_reclassificacao*/  then
                    assign tt_acum_calc_parc_pis_cofins.ttv_val_tot_parc_gerad_pis     = v_val_acum_parc_pis_incorp + v_val_acum_bxa_pis_incorp
                           tt_acum_calc_parc_pis_cofins.ttv_val_tot_parc_gerad_cofins  = v_val_acum_parc_cofins_incorp + v_val_acum_bxa_cofins_incorp.
            end.

        end.

        if  avail tt_acum_calc_parc_pis_cofins then do:
            if  calc_parc_pis_cofins.num_seq_incorp_bem_pat = 0 then do:
                if  calc_parc_pis_cofins.val_cr_pis_bxa <> 0 and tt_acum_calc_parc_pis_cofins.ttv_val_sdo_cr_pis = 0 then
                    assign tt_acum_calc_parc_pis_cofins.ttv_val_sdo_cr_pis = tt_acum_calc_parc_pis_cofins.ttv_val_sdo_cr_pis - calc_parc_pis_cofins.val_cr_pis_bxa.

                if  calc_parc_pis_cofins.val_cr_cofins_bxa <> 0 and tt_acum_calc_parc_pis_cofins.ttv_val_sdo_cr_cofins = 0 then
                    assign tt_acum_calc_parc_pis_cofins.ttv_val_sdo_cr_cofins = tt_acum_calc_parc_pis_cofins.ttv_val_sdo_cr_cofins - calc_parc_pis_cofins.val_cr_cofins_bxa.            
            end.
            else do:
                if  calc_parc_pis_cofins.val_cr_pis_bxa <> 0 and tt_acum_calc_parc_pis_cofins.ttv_val_sdo_cr_pis_incorp = 0 then
                    assign tt_acum_calc_parc_pis_cofins.ttv_val_sdo_cr_pis_incorp = tt_acum_calc_parc_pis_cofins.ttv_val_sdo_cr_pis_incorp - calc_parc_pis_cofins.val_cr_pis_bxa.

                if  calc_parc_pis_cofins.val_cr_cofins_bxa <> 0 and tt_acum_calc_parc_pis_cofins.ttv_val_sdo_cr_cofins_incorp = 0 then
                    assign tt_acum_calc_parc_pis_cofins.ttv_val_sdo_cr_cofins_incorp = tt_acum_calc_parc_pis_cofins.ttv_val_sdo_cr_cofins_incorp - calc_parc_pis_cofins.val_cr_cofins_bxa.            
            end.
        end.
    end.

    if v_log_imobilizado then do:
        if v_log_parc_desc = no then
            assign tt_acum_calc_parc_pis_cofins.ttv_val_tot_parc_gerad_pis     = v_val_acum_parc_pis + v_val_acum_bxa_pis
                   tt_acum_calc_parc_pis_cofins.ttv_val_tot_parc_gerad_cofins  = v_val_acum_parc_cofins + v_val_acum_bxa_cofins.
    end.
    if v_log_imob_incorp then do:
        if v_log_parc_desc = no then
            assign tt_acum_calc_parc_pis_cofins.ttv_val_tot_parc_gerad_pis     = v_val_acum_parc_pis_incorp + v_val_acum_bxa_pis_incorp
                   tt_acum_calc_parc_pis_cofins.ttv_val_tot_parc_gerad_cofins  = v_val_acum_parc_cofins_incorp + v_val_acum_bxa_cofins_incorp.
    end.
END PROCEDURE. /* pi_vrf_valor_tot_parc_gerada */
/*****************************************************************************
** Procedure Interna.....: pi_retornar_sit_movimen_modul
** Descricao.............: pi_retornar_sit_movimen_modul
** Criado por............: Rovina
** Criado em.............: // 
** Alterado por..........: 
** Alterado em...........: 28/09/1995 13:58:38
*****************************************************************************/
PROCEDURE pi_retornar_sit_movimen_modul:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_modul_dtsul
        as character
        format "x(3)"
        no-undo.
    def Input param p_cod_unid_organ
        as character
        format "x(5)"
        no-undo.
    def Input param p_dat_refer_sit
        as date
        format "99/99/9999"
        no-undo.
    def Input param p_des_sit_movimen_ent
        as character
        format "x(40)"
        no-undo.
    def output param p_des_sit_movimen_mod
        as character
        format "x(40)"
        no-undo.


    /************************* Parameter Definition End *************************/

    assign p_des_sit_movimen_mod = "".
    situacao:
    for each sit_movimen_modul no-lock
     where sit_movimen_modul.cod_modul_dtsul = p_cod_modul_dtsul
       and sit_movimen_modul.cod_unid_organ = p_cod_unid_organ
       and sit_movimen_modul.dat_inic_sit_movimen <= p_dat_refer_sit
       and sit_movimen_modul.dat_fim_sit_movimen >= p_dat_refer_sit /*cl_retornar_sit_movimen_modul of sit_movimen_modul*/:
        if  p_des_sit_movimen_mod = ""
        then do:
            assign p_des_sit_movimen_mod = sit_movimen_modul.ind_sit_movimen.
        end /* if */.
        else do:
            assign p_des_sit_movimen_mod = p_des_sit_movimen_mod + "," + sit_movimen_modul.ind_sit_movimen.
        end /* else */.
    end /* for situacao */.

END PROCEDURE. /* pi_retornar_sit_movimen_modul */
/*****************************************************************************
** Procedure Interna.....: pi_verifica_bem_existente
** Descricao.............: pi_verifica_bem_existente
** Criado por............: fut40088
** Criado em.............: 09/03/2006 11:40:22
** Alterado por..........: fut40088
** Alterado em...........: 10/03/2006 10:42:53
*****************************************************************************/
PROCEDURE pi_verifica_bem_existente:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_empresa
        as character
        format "x(3)"
        no-undo.
    def Input param p_cod_cta_pat
        as character
        format "x(18)"
        no-undo.
    def Input param p_cod_estab
        as character
        format "x(5)"
        no-undo.
    def input param p_num_bem_pat
        as integer
        format ">>>>>>>>9"
        no-undo.
    def input param p_num_seq_bem_pat
        as integer
        format ">>>>9"
        no-undo.
    def output param p_log_return
        as logical
        format "Sim/N∆o"
        no-undo.


    /************************* Parameter Definition End *************************/

    if  param_geral_pat.ind_numer_niv = "Global" /*l_global*/ 
    then do:  
        find first b_bem_pat_proximo no-lock
            where b_bem_pat_proximo.num_bem_pat = p_num_bem_pat
            and   b_bem_pat_proximo.num_seq_bem_pat = p_num_seq_bem_pat

             use-index bempat_bem
            no-error.
    end /* if */.
    else do:
        if  param_geral_pat.ind_numer_niv = "Por Empresa" /*l_por_empresa*/ 
        then do:
            find first b_bem_pat_proximo no-lock
                where b_bem_pat_proximo.cod_empresa = p_cod_empresa
                    and b_bem_pat_proximo.num_bem_pat = p_num_bem_pat
                    and b_bem_pat_proximo.num_seq_bem_pat = p_num_seq_bem_pat
                 use-index bempat_bem
            no-error.
        end /* if */.
        else do:
             if  param_geral_pat.ind_numer_niv = "Por Conta" /*l_por_conta*/ 
             then do:
                 find first b_bem_pat_proximo no-lock
                     where b_bem_pat_proximo.cod_empresa = p_cod_empresa 
                         and b_bem_pat_proximo.cod_cta_pat = p_cod_cta_pat
                         and b_bem_pat_proximo.num_bem_pat = p_num_bem_pat
                         and b_bem_pat_proximo.num_seq_bem_pat = p_num_seq_bem_pat
                     use-index bempat_bem
                 no-error.
             end /* if */.
             else do:
                 if  param_geral_pat.ind_numer_niv = "Por Estabelecimento" /*l_por_estabelecimento*/ 
                 then do: 
                     find first b_bem_pat_proximo no-lock
                          where b_bem_pat_proximo.cod_estab = p_cod_estab
                              and b_bem_pat_proximo.num_bem_pat = p_num_bem_pat
                              and b_bem_pat_proximo.num_seq_bem_pat = p_num_seq_bem_pat
                         use-index bempat_bem
                     no-error.
                 end /* if */.
             end /* else */.
        end /* else */.
    end /* else */.
    if avail b_bem_pat_proximo then
       assign p_log_return = yes.
    else
       assign p_log_return = no.

END PROCEDURE. /* pi_verifica_bem_existente */
/*****************************************************************************
** Procedure Interna.....: pi_tratar_pis_cofins_desmembramento
** Descricao.............: pi_tratar_pis_cofins_desmembramento
** Criado por............: fut35059
** Criado em.............: 07/06/2006 16:30:25
** Alterado por..........: danielidk
** Alterado em...........: 01/09/2017 11:42:32
*****************************************************************************/
PROCEDURE pi_tratar_pis_cofins_desmembramento:

    /************************ Parameter Definition Begin ************************/

    def input param p_val_original
        as decimal
        format "->>>>>,>>>,>>9.99"
        decimals 4
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************** Buffer Definition Begin *************************/

    def buffer b_incorp_bem_pat_aux
        for incorp_bem_pat.


    /*************************** Buffer Definition End **************************/

    /************************* Variable Definition Begin ************************/

    def var v_num_parc_pis_cofins_incorp_aux
        as integer
        format ">>>>,>>9":U
        initial 0
        no-undo.


    /************************** Variable Definition End *************************/

    /* ============================================================================================================
      = Detalhes dos 'entrys' das tabelas bem_pat, incorp_bem_pat, calc_parc_pis_cofins para PIS/COFINS EMS 5.05 =
      = -------------------------------------------------------------------------------------------------------- =
      = bem_pat                                                                                                  = 
      = -------                                                                                                  =
      = cod_livre_1 - entry 2 - Credita PIS                                                                      =
      = cod_livre_1 - entry 3 - Credita COFINS                                                                   =
      = cod_livre_1 - entry 4 - N£mero de parcelas PIS/COFINS do bem                                             =
      = cod_livre_1 - entry 5 - Valor de CrÇdito PIS definido na implantaá∆o do bem                              =
      = cod_livre_1 - entry 6 - Valor de CrÇdito COFINS definido na implantaá∆o do bem                           =
      =                                                                                                          =
      = incorp_bem_pat                                                                                           =
      = --------------                                                                                           =
      = cod_livre_1' - entry 2 - Valor de CrÇdito PIS definido na implantaá∆o da incorporaá∆o                    =
      = cod_livre_1' - entry 3 - Valor de CrÇdito COFINS definido na implantaá∆o da incorporaá∆o                 =
      = cod_livre_1' - entry 6 - Referente ao n£mero de parcelas PIS/COFINS cadastradas na incorporaá∆o          =
      =                                                                                                          =
      = calc_parc_pis_cofins                                                                                     =
      = --------------------                                                                                     =
      = val_livre_1 - Valor do Saldo de PIS (Implantaá∆o - Parecals j† geradas - Baixas)                         =
      = val_livre_2 - Valor do Saldo de COFINS (Implantaá∆o - Parecals j† geradas - Baixas)                      =
      = cod_livre_1 - entry 1 - Valores de Baixa PIS                                                             =
      = cod_livre_1 - entry 2 - Valores de Baixa COFINS                                                          =
      ============================================================================================================*/

    assign v_val_tot_grav_pis         = 0
           v_val_tot_grav_cofins      = 0
           v_val_tot_pis_aux          = 0
           v_val_tot_cofins_aux       = 0
           v_val_tot_calc_parc_pis    = 0
           v_val_tot_calc_parc_cofins = 0
           v_val_calc_parc_pis_bxa    = 0
           v_val_calc_parc_cofins_bxa = 0
           v_val_tot_perc_aux         = 0
           v_val_tot_bxa_real_pis     = 0
           v_val_tot_bxa_real_cofins  = 0.

    if  v_cod_pais_empres_usuar = "BRA" /*l_bra*/  then do:
        empty temp-table tt_calc_parc_pis_cofins         no-error.
        empty temp-table tt_incorp_bem_pat_calc_parc     no-error.
        empty temp-table tt_acerto_val_bem_pis_cofins    no-error.
        empty temp-table tt_acerto_val_pis_cofins_incorp no-error.
        empty temp-table tt_acum_val_pis_cofins_incorp   no-error.

        /* ================================
          Busca o bem desmembrado (origem) 
          ================================*/
        find b_bem_pat_parc no-lock
            where b_bem_pat_parc.cod_empresa     = v_cod_empres_usuar
            and   b_bem_pat_parc.cod_cta_pat     = input frame f_dlg_03_bem_pat_desmembramento b_bem_pat.cod_cta_pat
            and   b_bem_pat_parc.num_bem_pat     = input frame f_dlg_03_bem_pat_desmembramento b_bem_pat.num_bem_pat
            and   b_bem_pat_parc.num_seq_bem_pat = input frame f_dlg_03_bem_pat_desmembramento b_bem_pat.num_seq_bem_pat no-error.
        if  avail b_bem_pat_parc then do:

            /* ====================================
              Verifica o n£mero de parcelas do bem
              ====================================*/
            assign v_num_parc_pis_cofins = b_bem_pat_parc.num_parc_pis_cofins.                                       
            if  v_num_parc_pis_cofins > 0 then do:


                /* Begin_Include: i_valid_utiliz_cenar_bem_pat_pis_cofins */
                /* ======================================================
                  Verifica se a empresa do bem utiliza um cen†rio fiscal
                  ======================================================*/
                find first utiliz_cenar_ctbl no-lock
                    where utiliz_cenar_ctbl.cod_empresa    = b_bem_pat_parc.cod_empresa
                    and   utiliz_cenar_ctbl.log_cenar_fisc = yes no-error.
                if  not avail utiliz_cenar_ctbl then do:
                    /* Cen†rio Fiscal n∆o encontrado para a Empresa &1 ! */
                    run pi_messages (input "show",
                                     input 10624,
                                     input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                        v_cod_empres_usuar)) /*msg_10624*/.
                    return "NOK" /*l_nok*/ .
                end.

                /* ================================================
                  Verifica se existe per°odo v†lido para o cen†rio
                  ================================================*/
                find period_ctbl no-lock
                    where period_ctbl.cod_cenar_ctbl        = utiliz_cenar_ctbl.cod_cenar_ctbl
                    and   period_ctbl.dat_inic_period_ctbl <= v_dat_desmbrto
                    and   period_ctbl.dat_fim_period_ctbl  >= v_dat_desmbrto no-error.
                if  not avail period_ctbl then do:
                    /* N∆o existe per°odo cont†bil em &1 no cen†rio cont†bil &2 ! */
                    run pi_messages (input "show",
                                     input 4929,
                                     input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                        v_dat_desmbrto, utiliz_cenar_ctbl.cod_cenar_ctbl)) /*msg_4929*/.
                    return "NOK" /*l_nok*/ .
                end.
                /* End_Include: i_valid_utiliz_cenar_bem_pat_pis_cofins */


                /* ==========================================================================
                  Verifica informaá‰es das parcelas do bem que est† sendo desmembrado,
                  Ç nesta pi que Ç verificado se houveram geraá∆o de parcela para o per°odo, 
                  ou se existem parcelas geradas para per°odos posteriores, etc
                  ==========================================================================*/
                run pi_bt_ok_bem_pat_desmembr_calc_parc (Input 0,
                                                         Input v_num_parc_pis_cofins) /*pi_bt_ok_bem_pat_desmembr_calc_parc*/.
                if  return-value = "NOK" /*l_nok*/  then
                    return "NOK" /*l_nok*/ .

                /* =====================================================================================================
                  Verifica os valores contabilizados, como exemplo as parcelas j† geradas e os valores de Implantaá∆o, 
                  acumulando os mesmos na tamp-table tt_acum_calc_parc_pis_cofins para ser usado posteriormente
                  (Acumula o saldo de Implantaá∆o e retira os valores de baixa. Acumula os valores de parcelas geradas)
                  =====================================================================================================*/
                run pi_vrf_valor_tot_parc_gerada (buffer b_bem_pat_parc,
                                                  Input 0) /*pi_vrf_valor_tot_parc_gerada*/.
            end.
            /* ==================================================
              Busca as incorporaá‰es do bem desmembrado (origem)
              ==================================================*/   
            incorp_block:
            for each incorp_bem_pat no-lock
                where incorp_bem_pat.num_id_bem_pat = b_bem_pat_parc.num_id_bem_pat:

                /* =============================================
                  Verifica o n£mero de parcelas da incorporaá∆o
                  =============================================*/
                assign v_num_parc_pis_cofins_incorp = incorp_bem_pat.num_parc_pis_cofins.    

                if  v_num_parc_pis_cofins_incorp > 0
                then do:


                    /* Begin_Include: i_valid_utiliz_cenar_bem_pat_pis_cofins */
                    /* ======================================================
                      Verifica se a empresa do bem utiliza um cen†rio fiscal
                      ======================================================*/
                    find first utiliz_cenar_ctbl no-lock
                        where utiliz_cenar_ctbl.cod_empresa    = b_bem_pat_parc.cod_empresa
                        and   utiliz_cenar_ctbl.log_cenar_fisc = yes no-error.
                    if  not avail utiliz_cenar_ctbl then do:
                        /* Cen†rio Fiscal n∆o encontrado para a Empresa &1 ! */
                        run pi_messages (input "show",
                                         input 10624,
                                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                            v_cod_empres_usuar)) /*msg_10624*/.
                        return "NOK" /*l_nok*/ .
                    end.

                    /* ================================================
                      Verifica se existe per°odo v†lido para o cen†rio
                      ================================================*/
                    find period_ctbl no-lock
                        where period_ctbl.cod_cenar_ctbl        = utiliz_cenar_ctbl.cod_cenar_ctbl
                        and   period_ctbl.dat_inic_period_ctbl <= v_dat_desmbrto
                        and   period_ctbl.dat_fim_period_ctbl  >= v_dat_desmbrto no-error.
                    if  not avail period_ctbl then do:
                        /* N∆o existe per°odo cont†bil em &1 no cen†rio cont†bil &2 ! */
                        run pi_messages (input "show",
                                         input 4929,
                                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                            v_dat_desmbrto, utiliz_cenar_ctbl.cod_cenar_ctbl)) /*msg_4929*/.
                        return "NOK" /*l_nok*/ .
                    end.
                    /* End_Include: i_valid_utiliz_cenar_bem_pat_pis_cofins */


                    /* ==========================================================================
                      Verifica informaá‰es das parcelas do bem que est† sendo desmembrado,
                      Ç nesta pi que Ç verificado se houveram geraá∆o de parcela para o per°odo, 
                      ou se existem parcelas geradas para per°odos posteriores, etc
                      ==========================================================================*/    
                    run pi_bt_ok_bem_pat_desmembr_calc_parc (Input incorp_bem_pat.num_seq_incorp_bem_pat,
                                                             Input v_num_parc_pis_cofins_incorp) /*pi_bt_ok_bem_pat_desmembr_calc_parc*/.

                    case return-value:
                        when "NOK" /*l_nok*/   then
                            return "NOK" /*l_nok*/ .
                        when 'next_incorp':U then
                            next incorp_block.
                    end case.

                    /* ====================================================================================================
                      Cria registro com a sequencia da incorporaá∆o para atualizaá∆o dos valores para calc_parc_pis_cofins 
                      e para ser usado posteriormente para atualizar o valor de PIS/COFINS ,
                      (para n∆o haver a necessidade de fazer uma nova busca)
                      ====================================================================================================*/
                    create tt_incorp_bem_pat_calc_parc.
                    assign tt_incorp_bem_pat_calc_parc.tta_num_id_bem_pat         = incorp_bem_pat.num_id_bem_pat
                           tt_incorp_bem_pat_calc_parc.tta_num_seq_incorp_bem_pat = incorp_bem_pat.num_seq_incorp_bem_pat
                           tt_incorp_bem_pat_calc_parc.tta_num_parc_pis_cofins    = v_num_parc_pis_cofins_incorp.

                    /* =====================================================================================================
                      Verifica os valores contabilizados, como exemplo as parcelas j† geradas e os valores de Implantaá∆o; 
                      acumulando os mesmos na tamp-table tt_acum_calc_parc_pis_cofins para ser usado posteriormente, neste 
                      caso Ç verificado para as incorporaá‰es.
                      (Acumula o saldo de Implantaá∆o e retira os valores de baixa. Acumula os valores de parcelas geradas)
                      =====================================================================================================*/       
                    run pi_vrf_valor_tot_parc_gerada (buffer b_bem_pat_parc,
                                                      Input tt_incorp_bem_pat_calc_parc.tta_num_seq_incorp_bem_pat) /*pi_vrf_valor_tot_parc_gerada*/.                         
                end /* if */.
            end.    
        end.
    end.

    /* ===================================================
      Busca os bens criados pelo desmembramento (destino)
      ===================================================*/
    tt_block:
    for each tt_desmembrto_bem_pat no-lock:

        if  cb_desmembramento_bem_pat:screen-value in frame f_dlg_03_bem_pat_desmembramento = "Por Percentual" /*l_por_percentual*/  or
            cb_desmembramento_bem_pat:screen-value in frame f_dlg_03_bem_pat_desmembramento = "Por Quantidade" /*l_por_quantidade*/  then do:
            assign tt_desmembrto_bem_pat.tta_val_original = round(((p_val_original * tt_desmembrto_bem_pat.tta_val_perc_movto_bem_pat) / 100),2)
                   v_val_tot_perc_dest                    = v_val_tot_perc_dest + tt_desmembrto_bem_pat.tta_val_perc_movto_bem_pat
                   v_val_tot_perc_aux                     = v_val_tot_perc_aux + tt_desmembrto_bem_pat.tta_val_perc_movto_bem_pat.

            if  abs(v_val_maior) < abs(tt_desmembrto_bem_pat.tta_val_original) then
                assign v_val_maior   = tt_desmembrto_bem_pat.tta_val_original
                       v_num_bem_pat = tt_desmembrto_bem_pat.tta_num_bem_pat
                       v_num_seq_bem = tt_desmembrto_bem_pat.tta_num_seq_bem_pat.
        end.

        /* ====================================================================================
          Grava vari†vel de percentual desmembrado mesmo quando o desmembramento for por valor 
          para ser usado no c†lculo de PIS/COFINS
          ====================================================================================*/
        if  v_cod_pais_empres_usuar = "BRA" /*l_bra*/ 
        and cb_desmembramento_bem_pat:screen-value in frame f_dlg_03_bem_pat_desmembramento = "Por Valor" /*l_por_valor*/  then
            assign v_val_tot_perc_dest     = v_val_tot_perc_dest     + tt_desmembrto_bem_pat.tta_val_perc_movto_bem_pat
                   v_val_tot_perc_aux = v_val_tot_perc_aux + tt_desmembrto_bem_pat.tta_val_perc_movto_bem_pat.    

        /* ==========================================
          Verifica se o bem foi criado anteriormente
          ==========================================*/
        find bem_pat no-lock
             where bem_pat.cod_empresa = v_cod_empres_usuar
               and bem_pat.cod_cta_pat = tt_desmembrto_bem_pat.tta_cod_cta_pat
               and bem_pat.num_bem_pat = tt_desmembrto_bem_pat.tta_num_bem_pat
               and bem_pat.num_seq_bem_pat = tt_desmembrto_bem_pat.tta_num_seq_bem_pat /*cl_dlg_03_bem_pat_desmembramento of bem_pat*/ no-error.
        if  not avail bem_pat
        then do:
            /* Bem Patrimonial implantado por desmembramento n∆o existe ! */
            run pi_messages (input "show",
                             input 873,
                             input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_873*/.
            return 'NOK'.
        end /* if */.

        /* ================================== 
          Valida parÉmetro de contabilizaá∆o
          ==================================*/
        run pi_validar_param_ctbz_cta_pat (buffer bem_pat,
                                           Input v_dat_desmbrto,
                                           output v_cod_return) /*pi_validar_param_ctbz_cta_pat*/.
        if  return-value <> "OK" /*l_ok*/ 
        then do:
            /* blk_case: */
            case entry(1, v_cod_return, chr(10)):
                when "1111" then 
                    do:
                        /* ParÉmetro Contabilizaá∆o da Conta Patrimonial n∆o cadastrado ! */
                        run pi_messages (input "show",
                                         input 1111,
                                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                            entry(2, v_cod_return, chr(10)), entry(3, v_cod_return, chr(10)), entry(4, v_cod_return, chr(10))                                     , entry(5, v_cod_return, chr(10)))) /*msg_1111*/.
                    end.
                when "3347" then 
                    do:
                        /* Conta Cont†bil &1 n∆o utiliza o Centro de Custo &2 ! */
                        run pi_messages (input "show",
                                         input 3347,
                                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                            entry(2, v_cod_return, chr(10)), entry(3, v_cod_return, chr(10)))) /*msg_3347*/.
                    end.
                when "950" then 
                    do:
                        /* Unidade Neg¢cio &1 n∆o encontrada para Estabelecimento &2 ! */
                        run pi_messages (input "show",
                                         input 950,
                                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                            entry(2, v_cod_return, chr(10)), entry(3, v_cod_return, chr(10)))) /*msg_950*/.
                    end.
                when "1253" then 
                    do:
                        /* Centro Custo &1 Inv†lido para a Unidade Neg¢cio &2 ! */
                        run pi_messages (input "show",
                                         input 1253,
                                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                            entry(2, v_cod_return, chr(10)), entry(3, v_cod_return, chr(10)))) /*msg_1253*/.
                    end.
                when "5729" then 
                    do:
                        /* Existe restriá∆o do ccusto &1 no estabelecimento: &2 ! */
                        run pi_messages (input "show",
                                         input 5729,
                                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                            entry(2, v_cod_return, chr(10)), entry(3, v_cod_return, chr(10)))) /*msg_5729*/.
                    end.
            end /* case blk_case */.                        
            return 'NOK'.
        end /* if */.

        /* ==============================================================
          Verifica se o buffer b_bem_pat_parc (bem desmembrado - origem) 
          est† avail e se o n£mero de parcelas deste bem Ç maior que 0 
          ==============================================================*/
        if  v_cod_pais_empres_usuar = "BRA" /*l_bra*/ 
            and avail b_bem_pat_parc
        then do:
            if  v_num_parc_pis_cofins > 0
            then do:

                /* ================================================================================================================
                  Gera o registro de Implantaá∆o (calc_parc_pis_cofins) para os bens gerados pelo desmembramento - (destino)
                  A f¢rmula Ç: Valor do Saldo do Bem Origem - Parcelas j† geradas para o Bem Origem * Percentual de desmembramento 
                  referente ao bem gerado (destino) / 100
                  ================================================================================================================*/    
                run pi_implantar_bem_par_desmbrto_calc_parc (Input 0) /*pi_implantar_bem_par_desmbrto_calc_parc*/.

                find current bem_pat exclusive-lock no-error.

                /* ===================================================================================
                  Atualiza valores de credito PIS COFINS para os novos bens criados no desmembramento
                  Grava valores na tabela bem_pat referente ao valor do bem origem de PIS/COFINS 
                  proporcional ao percentual desmembrado.
                  ===================================================================================*/    
                if  avail bem_pat then do:


                    /* Begin_Include: i_cria_tt_acerto_bem_destino */
                    create tt_acerto_val_bem_pis_cofins.
                    assign tt_acerto_val_bem_pis_cofins.tta_cod_empresa          = bem_pat.cod_empresa 
                           tt_acerto_val_bem_pis_cofins.tta_cod_cta_pat          = bem_pat.cod_cta_pat
                           tt_acerto_val_bem_pis_cofins.tta_num_bem_pat          = bem_pat.num_bem_pat
                           tt_acerto_val_bem_pis_cofins.tta_num_seq_bem_pat      = bem_pat.num_seq_bem_pat
                           tt_acerto_val_bem_pis_cofins.tta_num_id_bem_pat       = bem_pat.num_id_bem_pat
                           tt_acerto_val_bem_pis_cofins.ttv_num_percent_desmbrto = tt_desmembrto_bem_pat.tta_val_perc_movto_bem_pat.

                    find last calc_parc_pis_cofins no-lock
                        where calc_parc_pis_cofins.cod_empresa            = bem_pat.cod_empresa
                        and   calc_parc_pis_cofins.cod_cta_pat            = bem_pat.cod_cta_pat
                        and   calc_parc_pis_cofins.num_bem_pat            = bem_pat.num_bem_pat
                        and   calc_parc_pis_cofins.num_seq_bem_pat        = bem_pat.num_seq_bem_pat
                        and   calc_parc_pis_cofins.num_seq_incorp_bem_pat = 0 no-error.

                    if avail calc_parc_pis_cofins then do:
                       &if '{&emsuni_version}' >= '5.06' &then
                           assign v_val_tot_calc_parc_pis = v_val_tot_calc_parc_pis + calc_parc_pis_cofins.val_cr_pis
                                  v_val_tot_calc_parc_cofins = v_val_tot_calc_parc_cofins + calc_parc_pis_cofins.val_cr_cofins
                                  tt_acerto_val_bem_pis_cofins.ttv_val_calc_parc_pis = calc_parc_pis_cofins.val_cr_pis
                                  tt_acerto_val_bem_pis_cofins.ttv_val_calc_parc_cofins = calc_parc_pis_cofins.val_cr_cofins.
                       &else
                           assign v_val_tot_calc_parc_pis = v_val_tot_calc_parc_pis + calc_parc_pis_cofins.val_livre_1
                                  v_val_tot_calc_parc_cofins = v_val_tot_calc_parc_cofins + calc_parc_pis_cofins.val_livre_2
                                  tt_acerto_val_bem_pis_cofins.ttv_val_calc_parc_pis = calc_parc_pis_cofins.val_livre_1
                                  tt_acerto_val_bem_pis_cofins.ttv_val_calc_parc_cofins = calc_parc_pis_cofins.val_livre_2.
                       &endif
                    end.
                    /* End_Include: i_cria_tt_acerto_bem_destino */

                    assign bem_pat.val_cr_pis    = b_bem_pat_parc.val_cr_pis * (tt_desmembrto_bem_pat.tta_val_perc_movto_bem_pat / 100)
                           bem_pat.val_cr_cofins = b_bem_pat_parc.val_cr_cofins * (tt_desmembrto_bem_pat.tta_val_perc_movto_bem_pat / 100).           

                    assign v_val_tot_grav_pis    = v_val_tot_grav_pis    + bem_pat.val_cr_pis
                           v_val_tot_grav_cofins = v_val_tot_grav_cofins + bem_pat.val_cr_cofins
                           tt_acerto_val_bem_pis_cofins.tta_val_cr_pis      = bem_pat.val_cr_pis
                           tt_acerto_val_bem_pis_cofins.tta_val_cr_cofins   = bem_pat.val_cr_cofins.

                    /* Valor bruto da base de PIS e COFINS nío ≤ proporcional ao percentual desmembrado. Grava o valor inteiro.*/
                    &if '{&emsuni_version}' >= '5.09' &then
                        ASSIGN bem_pat.val_base_pis    = b_bem_pat_parc.val_base_pis
                               bem_pat.val_base_cofins = b_bem_pat_parc.val_base_cofins.
                    &else
                        assign bem_pat.cod_livre_1 = SetEntryField(10,bem_pat.cod_livre_1,";",GetEntryField(10,b_bem_pat_parc.cod_livre_1,";"))
                               bem_pat.cod_livre_1 = SetEntryField(11,bem_pat.cod_livre_1,";",GetEntryField(11,b_bem_pat_parc.cod_livre_1,";")). 
                    &endif

                end.
            end /* if */.


            /* Begin_Include: i_tratar_pis_cofins_desmemb_incorp_dest */
            /* ==================================================================
              Gera os registros de Implantaá∆o de PIS/COFINS para a incorporaá∆o 
              e grava o valor de PIS/COFINS nas incorporaá‰es destinos 
              ==================================================================*/ 
            for each b_incorp_bem_pat no-lock
               where b_incorp_bem_pat.num_id_bem_pat = b_bem_pat_parc.num_id_bem_pat:

                /* =========================================================================================
                 Para cada incorporaá∆o do bem origem (b_incorp_bem_pat) cria-se o registro de Implantaá∆o 
                 de PIS/COFINS para a incorporaá∆o do bem destino
                 =========================================================================================*/

               &if '{&emsuni_version}' >= '5.06' &then
                if  b_incorp_bem_pat.num_parc_pis_cofins > 0
                then do:
               &else
                if  int(GetEntryField(6,b_incorp_bem_pat.cod_livre_1,";")) > 0
                then do:
               &endif

                    run pi_implantar_bem_par_desmbrto_calc_parc (Input b_incorp_bem_pat.num_seq_incorp_bem_pat) /*pi_implantar_bem_par_desmbrto_calc_parc*/.

                    /* ============================================================================
                      Cria tamp-table de acerto, nela Ç gravado os valores individuais de cada bem
                      ============================================================================*/
                    create tt_acerto_val_pis_cofins_incorp.
                    assign tt_acerto_val_pis_cofins_incorp.tta_cod_empresa             = bem_pat.cod_empresa 
                           tt_acerto_val_pis_cofins_incorp.tta_cod_cta_pat             = bem_pat.cod_cta_pat
                           tt_acerto_val_pis_cofins_incorp.tta_num_bem_pat             = bem_pat.num_bem_pat
                           tt_acerto_val_pis_cofins_incorp.tta_num_seq_bem_pat         = bem_pat.num_seq_bem_pat
                           tt_acerto_val_pis_cofins_incorp.tta_num_id_bem_pat          = bem_pat.num_id_bem_pat
                           tt_acerto_val_pis_cofins_incorp.tta_num_seq_incorp_bem_pat  = b_incorp_bem_pat.num_seq_incorp_bem_pat
                           tt_acerto_val_pis_cofins_incorp.ttv_num_percent_desmbrto    = tt_desmembrto_bem_pat.tta_val_perc_movto_bem_pat.

                    /* ========================================================================
                      Cria temp-table de acerto, nela Ç gravado os valores acumulados dos bens
                      ========================================================================*/       
                    find first tt_acum_val_pis_cofins_incorp
                         where tt_acum_val_pis_cofins_incorp.tta_num_seq_incorp_bem_pat = b_incorp_bem_pat.num_seq_incorp_bem_pat no-error.
                    if  not avail tt_acum_val_pis_cofins_incorp
                    then do:
                        create tt_acum_val_pis_cofins_incorp.
                        assign tt_acum_val_pis_cofins_incorp.tta_num_seq_incorp_bem_pat = b_incorp_bem_pat.num_seq_incorp_bem_pat.
                    end /* if */.        

                    find last calc_parc_pis_cofins no-lock
                        where calc_parc_pis_cofins.cod_empresa            = bem_pat.cod_empresa
                        and   calc_parc_pis_cofins.cod_cta_pat            = bem_pat.cod_cta_pat
                        and   calc_parc_pis_cofins.num_bem_pat            = bem_pat.num_bem_pat
                        and   calc_parc_pis_cofins.num_seq_bem_pat        = bem_pat.num_seq_bem_pat
                        and   calc_parc_pis_cofins.num_seq_incorp_bem_pat = b_incorp_bem_pat.num_seq_incorp_bem_pat no-error.

                    if avail calc_parc_pis_cofins then do:    

                       &if '{&emsuni_version}' >= '5.06' &then
                           assign tt_acum_val_pis_cofins_incorp.ttv_val_tot_calc_parc_pis = tt_acum_val_pis_cofins_incorp.ttv_val_tot_calc_parc_pis + calc_parc_pis_cofins.val_cr_pis
                                  tt_acum_val_pis_cofins_incorp.ttv_val_tot_calc_parc_cofins = tt_acum_val_pis_cofins_incorp.ttv_val_tot_calc_parc_cofins + calc_parc_pis_cofins.val_cr_cofins
                                  tt_acerto_val_pis_cofins_incorp.ttv_val_calc_parc_pis = calc_parc_pis_cofins.val_cr_pis
                                  tt_acerto_val_pis_cofins_incorp.ttv_val_calc_parc_cofins = calc_parc_pis_cofins.val_cr_cofins.
                       &else
                           assign tt_acum_val_pis_cofins_incorp.ttv_val_tot_calc_parc_pis = tt_acum_val_pis_cofins_incorp.ttv_val_tot_calc_parc_pis + calc_parc_pis_cofins.val_livre_1
                                  tt_acum_val_pis_cofins_incorp.ttv_val_tot_calc_parc_cofins = tt_acum_val_pis_cofins_incorp.ttv_val_tot_calc_parc_cofins + calc_parc_pis_cofins.val_livre_2
                                  tt_acerto_val_pis_cofins_incorp.ttv_val_calc_parc_pis = calc_parc_pis_cofins.val_livre_1
                                  tt_acerto_val_pis_cofins_incorp.ttv_val_calc_parc_cofins = calc_parc_pis_cofins.val_livre_2.
                       &endif
                    end.


                    /* =====================================================================
                      Busca as incorpora‰es dos bens destinos e grava o valor de PIS/COFINS 
                      atualizado conforme percentual de desmembramento
                      =====================================================================*/
                    find first b_incorp_bem_pat_aux exclusive-lock
                         where b_incorp_bem_pat_aux.num_id_bem_pat = bem_pat.num_id_bem_pat
                           and b_incorp_bem_pat_aux.num_seq_incorp_bem_pat = b_incorp_bem_pat.num_seq_incorp_bem_pat no-error.

                    if  avail b_incorp_bem_pat_aux
                    then do:  
                        &if '{&emsuni_version}' >= '5.06' &then
                            assign b_incorp_bem_pat_aux.val_cr_pis                       = b_incorp_bem_pat.val_cr_pis * (tt_desmembrto_bem_pat.tta_val_perc_movto_bem_pat / 100)
                                   b_incorp_bem_pat_aux.val_cr_cofins                    = b_incorp_bem_pat.val_cr_cofins * (tt_desmembrto_bem_pat.tta_val_perc_movto_bem_pat / 100)
                                   tt_acum_val_pis_cofins_incorp.ttv_val_tot_grav_pis    = tt_acum_val_pis_cofins_incorp.ttv_val_tot_grav_pis    + b_incorp_bem_pat_aux.val_cr_pis
                                   tt_acum_val_pis_cofins_incorp.ttv_val_tot_grav_cofins = tt_acum_val_pis_cofins_incorp.ttv_val_tot_grav_cofins + b_incorp_bem_pat_aux.val_cr_cofins
                                   tt_acerto_val_pis_cofins_incorp.tta_val_cr_pis        = b_incorp_bem_pat_aux.val_cr_pis
                                   tt_acerto_val_pis_cofins_incorp.tta_val_cr_cofins     = b_incorp_bem_pat_aux.val_cr_cofins.
                        &else
                            if  num-entries(b_incorp_bem_pat.cod_livre_1, ';') > 1 then 
                                assign v_val_cr_pis = dec(entry(2,b_incorp_bem_pat.cod_livre_1, ';')).
                            else
                                assign v_val_cr_pis = 0.

                            if  num-entries(b_incorp_bem_pat.cod_livre_1, ';') > 2 then 
                                assign v_val_cr_cofins = dec(entry(3,b_incorp_bem_pat.cod_livre_1, ';')).
                            else
                                assign v_val_cr_cofins = 0.

                            assign entry(2, b_incorp_bem_pat_aux.cod_livre_1, ';')       = string(v_val_cr_pis * (tt_desmembrto_bem_pat.tta_val_perc_movto_bem_pat / 100))
                                   entry(3, b_incorp_bem_pat_aux.cod_livre_1, ';')       = string(v_val_cr_cofins * (tt_desmembrto_bem_pat.tta_val_perc_movto_bem_pat / 100))      
                                   tt_acum_val_pis_cofins_incorp.ttv_val_tot_grav_pis    = tt_acum_val_pis_cofins_incorp.ttv_val_tot_grav_pis + dec(GetEntryField(2, b_incorp_bem_pat_aux.cod_livre_1, ';'))
                                   tt_acum_val_pis_cofins_incorp.ttv_val_tot_grav_cofins = tt_acum_val_pis_cofins_incorp.ttv_val_tot_grav_cofins + dec(GetEntryField(3, b_incorp_bem_pat_aux.cod_livre_1, ';'))
                                   tt_acerto_val_pis_cofins_incorp.tta_val_cr_pis        = dec(GetEntryField(2, b_incorp_bem_pat_aux.cod_livre_1, ';'))
                                   tt_acerto_val_pis_cofins_incorp.tta_val_cr_cofins     = dec(GetEntryField(3, b_incorp_bem_pat_aux.cod_livre_1, ';')).       
                        &endif
                    end /* if */.
                end /* if */.    
            end.
            /* End_Include: i_tratar_pis_cofins_desmemb_incorp_dest */


        end /* if */.        
    end /* for tt_block */.


    /* ======================================================================= 
      Atualiza Informaá‰es Credito Parcelado PIS COFINS - Bens Desmembrado
      Gera valores de Baixa e grava no bem os valores restantes de PIS/COFINS
      =======================================================================*/
    if  v_cod_pais_empres_usuar = "BRA" /*l_bra*/ 
        and avail b_bem_pat_parc
    then do:

        if  v_num_parc_pis_cofins > 0
        then do:

            /* ======================================================== 
              Atualiza valores de credito PIS COFINS - Bem Desmembrado
              Atualiza valores da baixa
              ========================================================*/

            find last calc_parc_pis_cofins exclusive-lock
                where calc_parc_pis_cofins.cod_empresa     = b_bem_pat_parc.cod_empresa
                and   calc_parc_pis_cofins.cod_cta_pat     = b_bem_pat_parc.cod_cta_pat
                and   calc_parc_pis_cofins.num_bem_pat     = b_bem_pat_parc.num_bem_pat
                and   calc_parc_pis_cofins.num_seq_bem_pat = b_bem_pat_parc.num_seq_bem_pat
                and   calc_parc_pis_cofins.num_seq_incorp_bem_pat = 0 no-error.
            if  avail calc_parc_pis_cofins
                  and calc_parc_pis_cofins.num_parcela_cr < v_num_parc_pis_cofins
            then do:

                create tt_acerto_val_bem_pis_cofins.
                assign tt_acerto_val_bem_pis_cofins.tta_cod_empresa          = b_bem_pat_parc.cod_empresa 
                       tt_acerto_val_bem_pis_cofins.tta_cod_cta_pat          = b_bem_pat_parc.cod_cta_pat
                       tt_acerto_val_bem_pis_cofins.tta_num_bem_pat          = b_bem_pat_parc.num_bem_pat
                       tt_acerto_val_bem_pis_cofins.tta_num_seq_bem_pat      = b_bem_pat_parc.num_seq_bem_pat
                       tt_acerto_val_bem_pis_cofins.tta_num_id_bem_pat       = b_bem_pat_parc.num_id_bem_pat
                       tt_acerto_val_bem_pis_cofins.ttv_num_order            = 1
                       tt_acerto_val_bem_pis_cofins.ttv_num_percent_desmbrto = 0.

                /* ======================================================= 
                  Atualiza informacoes Credito PIS COFINS Bem Desmembrado 
                  Grava valores restantes do crÇdito PIS/COFINS
                  =======================================================*/
                assign v_val_tot_pis_aux    = b_bem_pat_parc.val_cr_pis 
                       v_val_tot_cofins_aux = b_bem_pat_parc.val_cr_cofins .

                if  v_val_tot_perc_aux >= 100
                then do:       
                    assign b_bem_pat_parc.val_cr_pis    = 0
                           b_bem_pat_parc.val_cr_cofins = 0.
                end /* if */.
                else do:   
                    assign b_bem_pat_parc.val_cr_pis    = b_bem_pat_parc.val_cr_pis - (b_bem_pat_parc.val_cr_pis  * (v_val_tot_perc_aux / 100))
                           b_bem_pat_parc.val_cr_cofins = b_bem_pat_parc.val_cr_cofins - (b_bem_pat_parc.val_cr_cofins * (v_val_tot_perc_aux / 100)).
                end /* else */.                    

                assign tt_acerto_val_bem_pis_cofins.tta_val_cr_pis      = b_bem_pat_parc.val_cr_pis
                       tt_acerto_val_bem_pis_cofins.tta_val_cr_cofins   = b_bem_pat_parc.val_cr_cofins.

                run pi_acerto_valores_pis_cofins_bem_pat /*pi_acerto_valores_pis_cofins_bem_pat*/.

                find first tt_acum_calc_parc_pis_cofins
                     where tt_acum_calc_parc_pis_cofins.tta_num_id_bem_pat         = b_bem_pat_parc.num_id_bem_pat
                     and   tt_acum_calc_parc_pis_cofins.tta_num_seq_incorp_bem_pat = 0 no-error.
                if avail tt_acum_calc_parc_pis_cofins then
                    run pi_atualiz_val_cr_pis_cofins_bxa (Input 0,
                                                          Input tt_acum_calc_parc_pis_cofins.ttv_val_tot_parc_gerad_pis,
                                                          Input tt_acum_calc_parc_pis_cofins.ttv_val_tot_parc_gerad_cofins,
                                                          Input tt_acum_calc_parc_pis_cofins.ttv_val_sdo_cr_pis,
                                                          Input tt_acum_calc_parc_pis_cofins.ttv_val_sdo_cr_cofins,
                                                          Input v_val_tot_perc_dest,
                                                          buffer b_bem_pat_parc,
                                                          output v_log_valid_calc_parc_bem,
                                                          Input v_num_parc_pis_cofins) /*pi_atualiz_val_cr_pis_cofins_bxa*/.   
                else
                    run pi_atualiz_val_cr_pis_cofins_bxa (Input 0,
                                                          Input 0,
                                                          Input 0,
                                                          Input 0,
                                                          Input 0,
                                                          Input v_val_tot_perc_dest,
                                                          buffer b_bem_pat_parc,
                                                          output v_log_valid_calc_parc_bem,
                                                          Input v_num_parc_pis_cofins) /*pi_atualiz_val_cr_pis_cofins_bxa*/.

                run pi_atualiz_val_cr_pis_cofins_bxa_acerto (Input 0,
                                                             buffer b_bem_pat_parc,
                                                             Input v_num_parc_pis_cofins,
                                                             Input v_val_tot_bxa_real_pis,
                                                             Input v_val_tot_bxa_real_cofins) /*pi_atualiz_val_cr_pis_cofins_bxa_acerto*/.        


                /* Begin_Include: i_cria_tt_acerto_bem_desmembrado */
                find last calc_parc_pis_cofins no-lock
                    where calc_parc_pis_cofins.cod_empresa            = b_bem_pat_parc.cod_empresa
                    and   calc_parc_pis_cofins.cod_cta_pat            = b_bem_pat_parc.cod_cta_pat
                    and   calc_parc_pis_cofins.num_bem_pat            = b_bem_pat_parc.num_bem_pat
                    and   calc_parc_pis_cofins.num_seq_bem_pat        = b_bem_pat_parc.num_seq_bem_pat
                    and   calc_parc_pis_cofins.num_seq_incorp_bem_pat = 0 no-error.

                if avail calc_parc_pis_cofins then do:
                    find first tt_acerto_val_bem_pis_cofins
                         where tt_acerto_val_bem_pis_cofins.tta_cod_empresa = b_bem_pat_parc.cod_empresa         and
                               tt_acerto_val_bem_pis_cofins.tta_cod_cta_pat = b_bem_pat_parc.cod_cta_pat         and
                               tt_acerto_val_bem_pis_cofins.tta_num_bem_pat = b_bem_pat_parc.num_bem_pat         and
                               tt_acerto_val_bem_pis_cofins.tta_num_seq_bem_pat = b_bem_pat_parc.num_seq_bem_pat and
                               tt_acerto_val_bem_pis_cofins.tta_num_id_bem_pat  = b_bem_pat_parc.num_id_bem_pat  no-error. 

                    &if '{&emsuni_version}' >= '5.06' &then
                         assign tt_acerto_val_bem_pis_cofins.ttv_val_calc_parc_pis_bxa = calc_parc_pis_cofins.val_cr_pis_bxa
                                tt_acerto_val_bem_pis_cofins.ttv_val_calc_parc_cofins_bxa = calc_parc_pis_cofins.val_cr_cofins_bxa.
                    &else
                         assign tt_acerto_val_bem_pis_cofins.ttv_val_calc_parc_pis_bxa = dec(GetEntryField(1, calc_parc_pis_cofins.cod_livre_1, ';'))
                                tt_acerto_val_bem_pis_cofins.ttv_val_calc_parc_cofins_bxa = dec(GetEntryField(2, calc_parc_pis_cofins.cod_livre_1, ';')).
                    &endif
                end.
                /* End_Include: i_cria_tt_acerto_bem_desmembrado */


                run pi_acerto_valores_pis_cofins_calc_parc /*pi_acerto_valores_pis_cofins_calc_parc*/.

            end /* if */.
        end /* if */.


        /* Begin_Include: i_tratar_pis_cofins_desmemb_incorp_orig */
        /* =============================================================================================
          Gera valores de Baixa e grava no bem os valores restantes de PIS/COFINS para as incorporaá‰es
          =============================================================================================*/
        for each tt_incorp_bem_pat_calc_parc
            where tt_incorp_bem_pat_calc_parc.tta_num_id_bem_pat = b_bem_pat_parc.num_id_bem_pat:

            /* ================================================================== 
              Atualiza valores de credito PIS COFINS - Incorp do Bem Desmembrado
              Atualiza valores da baixa
              ==================================================================*/
            find last calc_parc_pis_cofins exclusive-lock
                where calc_parc_pis_cofins.cod_empresa     = b_bem_pat_parc.cod_empresa
                and   calc_parc_pis_cofins.cod_cta_pat     = b_bem_pat_parc.cod_cta_pat
                and   calc_parc_pis_cofins.num_bem_pat     = b_bem_pat_parc.num_bem_pat
                and   calc_parc_pis_cofins.num_seq_bem_pat = b_bem_pat_parc.num_seq_bem_pat
                and   calc_parc_pis_cofins.num_seq_incorp_bem_pat = tt_incorp_bem_pat_calc_parc.tta_num_seq_incorp_bem_pat no-error.
            if  avail calc_parc_pis_cofins
                  and calc_parc_pis_cofins.num_parcela_cr < tt_incorp_bem_pat_calc_parc.tta_num_parc_pis_cofins
            then do:  

                /* ============================================================================
                  Cria tamp-table de acerto, nela Ç gravado os valores individuais de cada bem
                  ============================================================================*/
                create tt_acerto_val_pis_cofins_incorp.
                assign tt_acerto_val_pis_cofins_incorp.tta_cod_empresa             = b_bem_pat_parc.cod_empresa 
                       tt_acerto_val_pis_cofins_incorp.tta_cod_cta_pat             = b_bem_pat_parc.cod_cta_pat
                       tt_acerto_val_pis_cofins_incorp.tta_num_bem_pat             = b_bem_pat_parc.num_bem_pat
                       tt_acerto_val_pis_cofins_incorp.tta_num_seq_bem_pat         = b_bem_pat_parc.num_seq_bem_pat
                       tt_acerto_val_pis_cofins_incorp.tta_num_id_bem_pat          = b_bem_pat_parc.num_id_bem_pat
                       tt_acerto_val_pis_cofins_incorp.tta_num_seq_incorp_bem_pat  = tt_incorp_bem_pat_calc_parc.tta_num_seq_incorp_bem_pat
                       tt_acerto_val_pis_cofins_incorp.ttv_num_order               = 1
                       tt_acerto_val_pis_cofins_incorp.ttv_num_percent_desmbrto    = 0.

                /* ========================================================================
                  Cria temp-table de acerto, nela Ç gravado os valores acumulados dos bens
                  ========================================================================*/       
                find first tt_acum_val_pis_cofins_incorp
                     where tt_acum_val_pis_cofins_incorp.tta_num_seq_incorp_bem_pat = tt_incorp_bem_pat_calc_parc.tta_num_seq_incorp_bem_pat no-error.
                if  not avail tt_acum_val_pis_cofins_incorp
                then do:
                    create tt_acum_val_pis_cofins_incorp.
                    assign tt_acum_val_pis_cofins_incorp.tta_num_seq_incorp_bem_pat = tt_incorp_bem_pat_calc_parc.tta_num_seq_incorp_bem_pat.
                end /* if */.

                /* =======================================================================
                  Atualiza informaá‰es CrÇdito PIS COFINS Incorporaá∆o do Bem Desmembrado 
                  Grava valores restantes do crÇdito PIS/COFINS
                  =======================================================================*/
                find first incorp_bem_pat exclusive-lock
                     where incorp_bem_pat.num_id_bem_pat         = tt_incorp_bem_pat_calc_parc.tta_num_id_bem_pat
                       and incorp_bem_pat.num_seq_incorp_bem_pat = tt_incorp_bem_pat_calc_parc.tta_num_seq_incorp_bem_pat no-error.
                if  avail incorp_bem_pat
                then do:
                    assign tt_acum_val_pis_cofins_incorp.ttv_val_tot_pis_aux    = incorp_bem_pat.val_cr_pis * (v_val_tot_perc_dest / 100)
                           tt_acum_val_pis_cofins_incorp.ttv_val_tot_cofins_aux = incorp_bem_pat.val_cr_cofins * (v_val_tot_perc_dest / 100) .

                    if  v_val_tot_perc_aux >= 100
                    then do:
                        assign incorp_bem_pat.val_cr_pis    = 0
                               incorp_bem_pat.val_cr_cofins = 0.
                    end /* if */.
                    else do:
                        assign incorp_bem_pat.val_cr_pis    = incorp_bem_pat.val_cr_pis - (incorp_bem_pat.val_cr_pis * (v_val_tot_perc_dest / 100))
                               incorp_bem_pat.val_cr_cofins = incorp_bem_pat.val_cr_cofins - (incorp_bem_pat.val_cr_cofins * (v_val_tot_perc_dest / 100)).
                    end /* else */.  

                    assign tt_acum_val_pis_cofins_incorp.ttv_val_tot_grav_pis    = tt_acum_val_pis_cofins_incorp.ttv_val_tot_grav_pis    
                           tt_acum_val_pis_cofins_incorp.ttv_val_tot_grav_cofins = tt_acum_val_pis_cofins_incorp.ttv_val_tot_grav_cofins
                           tt_acerto_val_pis_cofins_incorp.tta_val_cr_pis        = incorp_bem_pat.val_cr_pis
                           tt_acerto_val_pis_cofins_incorp.tta_val_cr_cofins     = incorp_bem_pat.val_cr_cofins.

                    run pi_acerto_valores_pis_cofins_bem_pat_incorp /*pi_acerto_valores_pis_cofins_bem_pat_incorp*/.

                end /* if */.

                find first tt_acum_calc_parc_pis_cofins
                     where tt_acum_calc_parc_pis_cofins.tta_num_id_bem_pat         = b_bem_pat_parc.num_id_bem_pat
                     and   tt_acum_calc_parc_pis_cofins.tta_num_seq_incorp_bem_pat = tt_incorp_bem_pat_calc_parc.tta_num_seq_incorp_bem_pat no-error.
                if avail tt_acum_calc_parc_pis_cofins then
                    run pi_atualiz_val_cr_pis_cofins_bxa (Input tt_incorp_bem_pat_calc_parc.tta_num_seq_incorp_bem_pat,
                                                          Input tt_acum_calc_parc_pis_cofins.ttv_val_tot_parc_pis_incorp,
                                                          Input tt_acum_calc_parc_pis_cofins.ttv_val_tot_parc_cofins_incorp,
                                                          Input tt_acum_calc_parc_pis_cofins.ttv_val_sdo_cr_pis_incorp,
                                                          Input tt_acum_calc_parc_pis_cofins.ttv_val_sdo_cr_cofins_incorp,
                                                          Input v_val_tot_perc_dest,
                                                          buffer b_bem_pat_parc,
                                                          output v_log_valid_calc_parc_bem,
                                                          Input tt_incorp_bem_pat_calc_parc.tta_num_parc_pis_cofins) /*pi_atualiz_val_cr_pis_cofins_bxa*/.                                                                                  
                else
                    run pi_atualiz_val_cr_pis_cofins_bxa (Input tt_incorp_bem_pat_calc_parc.tta_num_seq_incorp_bem_pat,
                                                          Input 0,
                                                          Input 0,
                                                          Input 0,
                                                          Input 0,
                                                          Input v_val_tot_perc_dest,
                                                          buffer b_bem_pat_parc,
                                                          output v_log_valid_calc_parc_bem,
                                                          Input tt_incorp_bem_pat_calc_parc.tta_num_parc_pis_cofins) /*pi_atualiz_val_cr_pis_cofins_bxa*/.                                         
                run pi_atualiz_val_cr_pis_cofins_bxa_acerto (Input tt_incorp_bem_pat_calc_parc.tta_num_seq_incorp_bem_pat,
                                                             buffer b_bem_pat_parc,
                                                             Input tt_incorp_bem_pat_calc_parc.tta_num_parc_pis_cofins,
                                                             Input tt_acum_val_pis_cofins_incorp.ttv_val_tot_bxa_real_pis,
                                                             Input tt_acum_val_pis_cofins_incorp.ttv_val_tot_bxa_real_cofins) /*pi_atualiz_val_cr_pis_cofins_bxa_acerto*/.                                                                                      

                find last calc_parc_pis_cofins no-lock
                    where calc_parc_pis_cofins.cod_empresa            = b_bem_pat_parc.cod_empresa
                    and   calc_parc_pis_cofins.cod_cta_pat            = b_bem_pat_parc.cod_cta_pat
                    and   calc_parc_pis_cofins.num_bem_pat            = b_bem_pat_parc.num_bem_pat
                    and   calc_parc_pis_cofins.num_seq_bem_pat        = b_bem_pat_parc.num_seq_bem_pat
                    and   calc_parc_pis_cofins.num_seq_incorp_bem_pat = tt_incorp_bem_pat_calc_parc.tta_num_seq_incorp_bem_pat no-error.

                if avail calc_parc_pis_cofins then do:
                    find first tt_acerto_val_pis_cofins_incorp
                         where tt_acerto_val_pis_cofins_incorp.tta_cod_empresa = b_bem_pat_parc.cod_empresa         and
                               tt_acerto_val_pis_cofins_incorp.tta_cod_cta_pat = b_bem_pat_parc.cod_cta_pat         and
                               tt_acerto_val_pis_cofins_incorp.tta_num_bem_pat = b_bem_pat_parc.num_bem_pat         and
                               tt_acerto_val_pis_cofins_incorp.tta_num_seq_bem_pat = b_bem_pat_parc.num_seq_bem_pat and
                               tt_acerto_val_pis_cofins_incorp.tta_num_id_bem_pat  = b_bem_pat_parc.num_id_bem_pat  and
                               tt_acerto_val_pis_cofins_incorp.tta_num_seq_incorp_bem_pat = tt_incorp_bem_pat_calc_parc.tta_num_seq_incorp_bem_pat no-error. 

                    assign tt_acerto_val_pis_cofins_incorp.ttv_val_calc_parc_pis_bxa    = calc_parc_pis_cofins.val_cr_pis_bxa
                           tt_acerto_val_pis_cofins_incorp.ttv_val_calc_parc_cofins_bxa = calc_parc_pis_cofins.val_cr_cofins_bxa.

                end.

                run pi_acerto_valores_pis_cofins_calc_parc_incorp /*pi_acerto_valores_pis_cofins_calc_parc_incorp*/.

            end /* if */.
        end.
        /* End_Include: i_tratar_pis_cofins_desmemb_incorp_orig */


    end.

    return "OK" /*l_ok*/ .
END PROCEDURE. /* pi_tratar_pis_cofins_desmembramento */
/*****************************************************************************
** Procedure Interna.....: pi_acerto_valores_pis_cofins_bem_pat
** Descricao.............: pi_acerto_valores_pis_cofins_bem_pat
** Criado por............: fut35059
** Criado em.............: 13/06/2006 09:10:51
** Alterado por..........: danielidk
** Alterado em...........: 04/09/2017 08:33:07
*****************************************************************************/
PROCEDURE pi_acerto_valores_pis_cofins_bem_pat:

    /************************** Buffer Definition Begin *************************/

    def buffer b_bem_pat_aux
        for bem_pat.


    /*************************** Buffer Definition End **************************/

    if  v_val_tot_pis_aux <> v_val_tot_grav_pis
    then do: 

       for each tt_acerto_val_bem_pis_cofins by tt_acerto_val_bem_pis_cofins.ttv_num_order /* **Achar por £ltimo o bem origem - o bem origem Ç o £nico que tem o valor v_num_order = 1 ***/
                                             by tt_acerto_val_bem_pis_cofins.tta_val_cr_pis desc
                                             by tt_acerto_val_bem_pis_cofins.ttv_num_percent_desmbrto desc:

           find first b_bem_pat_aux exclusive-lock 
                where b_bem_pat_aux.cod_empresa     = tt_acerto_val_bem_pis_cofins.tta_cod_empresa     and
                      b_bem_pat_aux.cod_cta_pat     = tt_acerto_val_bem_pis_cofins.tta_cod_cta_pat     and
                      b_bem_pat_aux.num_bem_pat     = tt_acerto_val_bem_pis_cofins.tta_num_bem_pat     and
                      b_bem_pat_aux.num_seq_bem_pat = tt_acerto_val_bem_pis_cofins.tta_num_seq_bem_pat and
                      b_bem_pat_aux.num_id_bem_pat  = tt_acerto_val_bem_pis_cofins.tta_num_id_bem_pat no-error.
           if  avail b_bem_pat_aux
           then do:

               if (b_bem_pat_aux.val_cr_pis + (v_val_tot_pis_aux - v_val_tot_grav_pis)) < 0 then do:

                   assign v_val_tot_grav_pis       = v_val_tot_grav_pis - round(b_bem_pat_aux.val_cr_pis,2)
                          b_bem_pat_aux.val_cr_pis = 0.


                   /* Begin_Include: i_atualiza_calc_parc_506_pis */
                   /* ==========================================================
                     Se o valor na bem_pat for zerado, dever† zerar a calc_parc
                     ==========================================================*/        
                   if  b_bem_pat_aux.val_cr_pis = 0
                   then do:

                       find last calc_parc_pis_cofins exclusive-lock
                           where calc_parc_pis_cofins.cod_empresa            = tt_acerto_val_bem_pis_cofins.tta_cod_empresa
                           and   calc_parc_pis_cofins.cod_cta_pat            = tt_acerto_val_bem_pis_cofins.tta_cod_cta_pat
                           and   calc_parc_pis_cofins.num_bem_pat            = tt_acerto_val_bem_pis_cofins.tta_num_bem_pat
                           and   calc_parc_pis_cofins.num_seq_bem_pat        = tt_acerto_val_bem_pis_cofins.tta_num_seq_bem_pat
                           and   calc_parc_pis_cofins.num_seq_incorp_bem_pat = 0 no-error.
                       if  avail calc_parc_pis_cofins
                       then do:

                           if  calc_parc_pis_cofins.cod_empresa     = b_bem_pat_parc.cod_empresa  and 
                               calc_parc_pis_cofins.cod_cta_pat     = b_bem_pat_parc.cod_cta_pat  and 
                               calc_parc_pis_cofins.num_bem_pat     = b_bem_pat_parc.num_bem_pat  and 
                               calc_parc_pis_cofins.num_seq_bem_pat = b_bem_pat_parc.num_seq_bem_pat and 
                               tt_acerto_val_bem_pis_cofins.tta_num_id_bem_pat = b_bem_pat_parc.num_id_bem_pat
                           then do:

                               assign calc_parc_pis_cofins.val_cr_pis_bxa = 0.

                           end /* if */. 
                           else do:    
                               assign v_val_tot_calc_parc_pis = v_val_tot_calc_parc_pis - round(calc_parc_pis_cofins.val_cr_pis,2)
                                      calc_parc_pis_cofins.val_cr_pis = 0
                                      tt_acerto_val_bem_pis_cofins.ttv_val_calc_parc_pis = 0.                             
                           end /* else */.  
                       end /* if */.  
                   end /* if */.
                   /* End_Include: i_atualiza_calc_parc_506_pis */


                   if v_val_tot_pis_aux - v_val_tot_grav_pis = 0 then 
                       leave.
                   else   
                       next.
               end.   
               assign b_bem_pat_aux.val_cr_pis = b_bem_pat_aux.val_cr_pis + (v_val_tot_pis_aux - v_val_tot_grav_pis)
                      v_val_tot_grav_pis       = v_val_tot_grav_pis + (v_val_tot_pis_aux - v_val_tot_grav_pis).


               /* Begin_Include: i_atualiza_calc_parc_506_pis */
               /* ==========================================================
                 Se o valor na bem_pat for zerado, dever† zerar a calc_parc
                 ==========================================================*/        
               if  b_bem_pat_aux.val_cr_pis = 0
               then do:

                   find last calc_parc_pis_cofins exclusive-lock
                       where calc_parc_pis_cofins.cod_empresa            = tt_acerto_val_bem_pis_cofins.tta_cod_empresa
                       and   calc_parc_pis_cofins.cod_cta_pat            = tt_acerto_val_bem_pis_cofins.tta_cod_cta_pat
                       and   calc_parc_pis_cofins.num_bem_pat            = tt_acerto_val_bem_pis_cofins.tta_num_bem_pat
                       and   calc_parc_pis_cofins.num_seq_bem_pat        = tt_acerto_val_bem_pis_cofins.tta_num_seq_bem_pat
                       and   calc_parc_pis_cofins.num_seq_incorp_bem_pat = 0 no-error.
                   if  avail calc_parc_pis_cofins
                   then do:

                       if  calc_parc_pis_cofins.cod_empresa     = b_bem_pat_parc.cod_empresa  and 
                           calc_parc_pis_cofins.cod_cta_pat     = b_bem_pat_parc.cod_cta_pat  and 
                           calc_parc_pis_cofins.num_bem_pat     = b_bem_pat_parc.num_bem_pat  and 
                           calc_parc_pis_cofins.num_seq_bem_pat = b_bem_pat_parc.num_seq_bem_pat and 
                           tt_acerto_val_bem_pis_cofins.tta_num_id_bem_pat = b_bem_pat_parc.num_id_bem_pat
                       then do:

                           assign calc_parc_pis_cofins.val_cr_pis_bxa = 0.

                       end /* if */. 
                       else do:    
                           assign v_val_tot_calc_parc_pis = v_val_tot_calc_parc_pis - round(calc_parc_pis_cofins.val_cr_pis,2)
                                  calc_parc_pis_cofins.val_cr_pis = 0
                                  tt_acerto_val_bem_pis_cofins.ttv_val_calc_parc_pis = 0.                             
                       end /* else */.  
                   end /* if */.  
               end /* if */.
               /* End_Include: i_atualiza_calc_parc_506_pis */


           end /* if */.
           leave.             
       end.   
    end /* if */.

    if  v_val_tot_cofins_aux <> v_val_tot_grav_cofins
    then do:

       for each tt_acerto_val_bem_pis_cofins by tt_acerto_val_bem_pis_cofins.ttv_num_order /* **Achar por £ltimo o bem origem - o bem origem Ç o £nico que tem o valor v_num_order = 1 ***/
                                             by tt_acerto_val_bem_pis_cofins.tta_val_cr_cofins desc
                                             by tt_acerto_val_bem_pis_cofins.ttv_num_percent_desmbrto desc:

           find first b_bem_pat_aux exclusive-lock 
                where b_bem_pat_aux.cod_empresa     = tt_acerto_val_bem_pis_cofins.tta_cod_empresa     and
                      b_bem_pat_aux.cod_cta_pat     = tt_acerto_val_bem_pis_cofins.tta_cod_cta_pat     and
                      b_bem_pat_aux.num_bem_pat     = tt_acerto_val_bem_pis_cofins.tta_num_bem_pat     and
                      b_bem_pat_aux.num_seq_bem_pat = tt_acerto_val_bem_pis_cofins.tta_num_seq_bem_pat and
                      b_bem_pat_aux.num_id_bem_pat  = tt_acerto_val_bem_pis_cofins.tta_num_id_bem_pat no-error.
           if  avail b_bem_pat_aux
           then do:

               if (b_bem_pat_aux.val_cr_cofins + (v_val_tot_cofins_aux - v_val_tot_grav_cofins)) < 0 then do:

                   assign v_val_tot_grav_cofins       = v_val_tot_grav_cofins - round(b_bem_pat_aux.val_cr_cofins,2)
                          b_bem_pat_aux.val_cr_cofins = 0.


                   /* Begin_Include: i_atualiza_calc_parc_506_cofins */
                   /* ==========================================================
                     Se o valor na bem_pat for zerado, dever† zerar a calc_parc
                     ==========================================================*/        
                   if  b_bem_pat_aux.val_cr_cofins = 0
                   then do:

                       find last calc_parc_pis_cofins exclusive-lock
                           where calc_parc_pis_cofins.cod_empresa            = tt_acerto_val_bem_pis_cofins.tta_cod_empresa
                           and   calc_parc_pis_cofins.cod_cta_pat            = tt_acerto_val_bem_pis_cofins.tta_cod_cta_pat
                           and   calc_parc_pis_cofins.num_bem_pat            = tt_acerto_val_bem_pis_cofins.tta_num_bem_pat
                           and   calc_parc_pis_cofins.num_seq_bem_pat        = tt_acerto_val_bem_pis_cofins.tta_num_seq_bem_pat
                           and   calc_parc_pis_cofins.num_seq_incorp_bem_pat = 0 no-error.
                       if  avail calc_parc_pis_cofins
                       then do:

                           if  calc_parc_pis_cofins.cod_empresa     = b_bem_pat_parc.cod_empresa  and 
                               calc_parc_pis_cofins.cod_cta_pat     = b_bem_pat_parc.cod_cta_pat  and 
                               calc_parc_pis_cofins.num_bem_pat     = b_bem_pat_parc.num_bem_pat  and 
                               calc_parc_pis_cofins.num_seq_bem_pat = b_bem_pat_parc.num_seq_bem_pat and 
                               tt_acerto_val_bem_pis_cofins.tta_num_id_bem_pat = b_bem_pat_parc.num_id_bem_pat
                           then do:

                               assign calc_parc_pis_cofins.val_cr_cofins_bxa = 0.

                           end /* if */. 
                           else do:    
                               assign v_val_tot_calc_parc_cofins = v_val_tot_calc_parc_cofins - round(calc_parc_pis_cofins.val_cr_cofins,2)
                                      calc_parc_pis_cofins.val_cr_cofins = 0
                                      tt_acerto_val_bem_pis_cofins.ttv_val_calc_parc_cofins = 0.                             
                           end /* else */.  
                       end /* if */.  
                   end /* if */.
                   /* End_Include: i_atualiza_calc_parc_506_cofins */


                   if v_val_tot_cofins_aux - v_val_tot_grav_cofins = 0 then 
                       leave.
                   else   
                       next.
               end.   
               assign b_bem_pat_aux.val_cr_cofins  = b_bem_pat_aux.val_cr_cofins + (v_val_tot_cofins_aux - v_val_tot_grav_cofins)
                      v_val_tot_grav_cofins        = v_val_tot_grav_cofins       + (v_val_tot_cofins_aux - v_val_tot_grav_cofins).


               /* Begin_Include: i_atualiza_calc_parc_506_cofins */
               /* ==========================================================
                 Se o valor na bem_pat for zerado, dever† zerar a calc_parc
                 ==========================================================*/        
               if  b_bem_pat_aux.val_cr_cofins = 0
               then do:

                   find last calc_parc_pis_cofins exclusive-lock
                       where calc_parc_pis_cofins.cod_empresa            = tt_acerto_val_bem_pis_cofins.tta_cod_empresa
                       and   calc_parc_pis_cofins.cod_cta_pat            = tt_acerto_val_bem_pis_cofins.tta_cod_cta_pat
                       and   calc_parc_pis_cofins.num_bem_pat            = tt_acerto_val_bem_pis_cofins.tta_num_bem_pat
                       and   calc_parc_pis_cofins.num_seq_bem_pat        = tt_acerto_val_bem_pis_cofins.tta_num_seq_bem_pat
                       and   calc_parc_pis_cofins.num_seq_incorp_bem_pat = 0 no-error.
                   if  avail calc_parc_pis_cofins
                   then do:

                       if  calc_parc_pis_cofins.cod_empresa     = b_bem_pat_parc.cod_empresa  and 
                           calc_parc_pis_cofins.cod_cta_pat     = b_bem_pat_parc.cod_cta_pat  and 
                           calc_parc_pis_cofins.num_bem_pat     = b_bem_pat_parc.num_bem_pat  and 
                           calc_parc_pis_cofins.num_seq_bem_pat = b_bem_pat_parc.num_seq_bem_pat and 
                           tt_acerto_val_bem_pis_cofins.tta_num_id_bem_pat = b_bem_pat_parc.num_id_bem_pat
                       then do:

                           assign calc_parc_pis_cofins.val_cr_cofins_bxa = 0.

                       end /* if */. 
                       else do:    
                           assign v_val_tot_calc_parc_cofins = v_val_tot_calc_parc_cofins - round(calc_parc_pis_cofins.val_cr_cofins,2)
                                  calc_parc_pis_cofins.val_cr_cofins = 0
                                  tt_acerto_val_bem_pis_cofins.ttv_val_calc_parc_cofins = 0.                             
                       end /* else */.  
                   end /* if */.  
               end /* if */.
               /* End_Include: i_atualiza_calc_parc_506_cofins */



           end /* if */.
           leave.             
       end. 
    end /* if */. 

    /* ===========================================================================
      Valor Real da baixa de PIS/COFINS sem o desconto de parcelas,
      este valor nunca pode ser menor que o valor de baixa gravado  na calc_parc.
      ===========================================================================*/ 
    find first tt_acerto_val_bem_pis_cofins
         where tt_acerto_val_bem_pis_cofins.tta_cod_empresa = b_bem_pat_parc.cod_empresa         and
               tt_acerto_val_bem_pis_cofins.tta_cod_cta_pat = b_bem_pat_parc.cod_cta_pat         and
               tt_acerto_val_bem_pis_cofins.tta_num_bem_pat = b_bem_pat_parc.num_bem_pat         and
               tt_acerto_val_bem_pis_cofins.tta_num_seq_bem_pat = b_bem_pat_parc.num_seq_bem_pat and
               tt_acerto_val_bem_pis_cofins.tta_num_id_bem_pat  = b_bem_pat_parc.num_id_bem_pat no-error.
    if  avail tt_acerto_val_bem_pis_cofins
    then do:  
         assign v_val_tot_bxa_real_pis    = v_val_tot_grav_pis    
                v_val_tot_bxa_real_cofins = v_val_tot_grav_cofins.
    end /* if */.
END PROCEDURE. /* pi_acerto_valores_pis_cofins_bem_pat */
/*****************************************************************************
** Procedure Interna.....: pi_acerto_valores_pis_cofins_calc_parc
** Descricao.............: pi_acerto_valores_pis_cofins_calc_parc
** Criado por............: fut35059
** Criado em.............: 13/06/2006 09:11:17
** Alterado por..........: danielidk
** Alterado em...........: 01/09/2017 11:49:43
*****************************************************************************/
PROCEDURE pi_acerto_valores_pis_cofins_calc_parc:

    find first tt_acerto_val_bem_pis_cofins 
         where tt_acerto_val_bem_pis_cofins.tta_cod_empresa     = b_bem_pat_parc.cod_empresa     and
               tt_acerto_val_bem_pis_cofins.tta_cod_cta_pat     = b_bem_pat_parc.cod_cta_pat     and
               tt_acerto_val_bem_pis_cofins.tta_num_bem_pat     = b_bem_pat_parc.num_bem_pat     and
               tt_acerto_val_bem_pis_cofins.tta_num_seq_bem_pat = b_bem_pat_parc.num_seq_bem_pat and
               tt_acerto_val_bem_pis_cofins.tta_num_id_bem_pat  = b_bem_pat_parc.num_id_bem_pat no-error.
    if  avail  tt_acerto_val_bem_pis_cofins
    then do:

         assign v_val_calc_parc_pis_bxa    = tt_acerto_val_bem_pis_cofins.ttv_val_calc_parc_pis_bxa - v_val_cr_pis_bxa_ant 
                v_val_calc_parc_cofins_bxa = tt_acerto_val_bem_pis_cofins.ttv_val_calc_parc_cofins_bxa  - v_val_cr_cofins_bxa_ant .

         if v_val_calc_parc_pis_bxa <> v_val_tot_calc_parc_pis then do:

             for each tt_acerto_val_bem_pis_cofins 
                      by tt_acerto_val_bem_pis_cofins.ttv_num_order /* **Achar por £ltimo o bem origem - o bem origem Ç o £nico que tem o valor v_num_order = 1 ***/  
                      by tt_acerto_val_bem_pis_cofins.tta_val_cr_pis desc
                      by tt_acerto_val_bem_pis_cofins.ttv_num_percent_desmbrto desc:

                 find last calc_parc_pis_cofins exclusive-lock
                     where calc_parc_pis_cofins.cod_empresa            = tt_acerto_val_bem_pis_cofins.tta_cod_empresa
                     and   calc_parc_pis_cofins.cod_cta_pat            = tt_acerto_val_bem_pis_cofins.tta_cod_cta_pat
                     and   calc_parc_pis_cofins.num_bem_pat            = tt_acerto_val_bem_pis_cofins.tta_num_bem_pat
                     and   calc_parc_pis_cofins.num_seq_bem_pat        = tt_acerto_val_bem_pis_cofins.tta_num_seq_bem_pat
                     and   calc_parc_pis_cofins.num_seq_incorp_bem_pat = 0 no-error.
                 if avail calc_parc_pis_cofins then do:

                     if  calc_parc_pis_cofins.cod_empresa     = b_bem_pat_parc.cod_empresa  and 
                         calc_parc_pis_cofins.cod_cta_pat     = b_bem_pat_parc.cod_cta_pat  and 
                         calc_parc_pis_cofins.num_bem_pat     = b_bem_pat_parc.num_bem_pat  and 
                         calc_parc_pis_cofins.num_seq_bem_pat = b_bem_pat_parc.num_seq_bem_pat and 
                         tt_acerto_val_bem_pis_cofins.tta_num_id_bem_pat = b_bem_pat_parc.num_id_bem_pat
                     then do:                    

                         if  (calc_parc_pis_cofins.val_cr_pis_bxa + (v_val_tot_calc_parc_pis - tt_acerto_val_bem_pis_cofins.ttv_val_calc_parc_pis_bxa)) < 0
                         then do:
                             assign calc_parc_pis_cofins.val_cr_pis_bxa = 0.
                             leave.
                         end /* if */.

                         assign calc_parc_pis_cofins.val_cr_pis_bxa = calc_parc_pis_cofins.val_cr_pis_bxa + (v_val_tot_calc_parc_pis - tt_acerto_val_bem_pis_cofins.ttv_val_calc_parc_pis_bxa).

                     end /* if */. 
                     else do:   
                         if  (calc_parc_pis_cofins.val_cr_pis + (v_val_calc_parc_pis_bxa - v_val_tot_calc_parc_pis)) < 0
                         then do:

                             assign v_val_tot_calc_parc_pis = v_val_tot_calc_parc_pis - round(calc_parc_pis_cofins.val_cr_pis,2)
                                    calc_parc_pis_cofins.val_cr_pis = 0.

                             if v_val_calc_parc_pis_bxa - v_val_tot_calc_parc_pis = 0 then 
                                 leave.
                             else   
                                 next.    

                         end /* if */.              
                         assign calc_parc_pis_cofins.val_cr_pis = calc_parc_pis_cofins.val_cr_pis + (v_val_calc_parc_pis_bxa - v_val_tot_calc_parc_pis).

                     end /* else */.   
                 end.                                      
                 leave. 
             end. 
         end.
         if v_val_calc_parc_cofins_bxa <> v_val_tot_calc_parc_cofins then do:

             for each tt_acerto_val_bem_pis_cofins 
                      by tt_acerto_val_bem_pis_cofins.ttv_num_order /* **Achar por £ltimo o bem origem - o bem origem Ç o £nico que tem o valor v_num_order = 1 ***/
                      by tt_acerto_val_bem_pis_cofins.tta_val_cr_cofins desc
                      by tt_acerto_val_bem_pis_cofins.ttv_num_percent_desmbrto desc:

                 find last calc_parc_pis_cofins exclusive-lock
                     where calc_parc_pis_cofins.cod_empresa            = tt_acerto_val_bem_pis_cofins.tta_cod_empresa
                     and   calc_parc_pis_cofins.cod_cta_pat            = tt_acerto_val_bem_pis_cofins.tta_cod_cta_pat
                     and   calc_parc_pis_cofins.num_bem_pat            = tt_acerto_val_bem_pis_cofins.tta_num_bem_pat
                     and   calc_parc_pis_cofins.num_seq_bem_pat        = tt_acerto_val_bem_pis_cofins.tta_num_seq_bem_pat
                     and   calc_parc_pis_cofins.num_seq_incorp_bem_pat = 0 no-error.
                 if avail calc_parc_pis_cofins then do:

                     if  calc_parc_pis_cofins.cod_empresa     = b_bem_pat_parc.cod_empresa  and 
                         calc_parc_pis_cofins.cod_cta_pat     = b_bem_pat_parc.cod_cta_pat  and 
                         calc_parc_pis_cofins.num_bem_pat     = b_bem_pat_parc.num_bem_pat  and 
                         calc_parc_pis_cofins.num_seq_bem_pat = b_bem_pat_parc.num_seq_bem_pat and 
                         tt_acerto_val_bem_pis_cofins.tta_num_id_bem_pat = b_bem_pat_parc.num_id_bem_pat
                     then do:

                         if  (calc_parc_pis_cofins.val_cr_cofins_bxa  + (v_val_tot_calc_parc_cofins - tt_acerto_val_bem_pis_cofins.ttv_val_calc_parc_cofins_bxa)) < 0
                         then do:    
                             assign calc_parc_pis_cofins.val_cr_pis_bxa = 0.
                             leave.
                         end /* if */.

                         assign calc_parc_pis_cofins.val_cr_cofins_bxa   = calc_parc_pis_cofins.val_cr_cofins_bxa  + (v_val_tot_calc_parc_cofins - tt_acerto_val_bem_pis_cofins.ttv_val_calc_parc_cofins_bxa).   

                     end /* if */. 
                     else do:   

                         if  (calc_parc_pis_cofins.val_cr_cofins + (v_val_calc_parc_cofins_bxa - v_val_tot_calc_parc_cofins)) < 0
                         then do:

                            assign v_val_tot_calc_parc_cofins = v_val_tot_calc_parc_cofins - round(calc_parc_pis_cofins.val_cr_cofins,2)
                                   calc_parc_pis_cofins.val_cr_cofins = 0.

                            if v_val_calc_parc_cofins_bxa - v_val_tot_calc_parc_cofins = 0 then 
                                leave.
                            else   
                                next.    

                         end /* if */.            
                         assign calc_parc_pis_cofins.val_cr_cofins = calc_parc_pis_cofins.val_cr_cofins + (v_val_calc_parc_cofins_bxa - v_val_tot_calc_parc_cofins).

                     end /* else */.   
                 end.                                      
                 leave. 
             end. 
         end.       
    end /* if */.  
END PROCEDURE. /* pi_acerto_valores_pis_cofins_calc_parc */
/*****************************************************************************
** Procedure Interna.....: pi_atualiz_val_cr_pis_cofins_bxa_acerto
** Descricao.............: pi_atualiz_val_cr_pis_cofins_bxa_acerto
** Criado por............: fut35059
** Criado em.............: 14/06/2006 09:50:40
** Alterado por..........: danielidk
** Alterado em...........: 13/10/2017 09:23:25
*****************************************************************************/
PROCEDURE pi_atualiz_val_cr_pis_cofins_bxa_acerto:

    /************************ Parameter Definition Begin ************************/

    def Input param p_num_seq_incorp_bem_pat
        as integer
        format ">>,>>>>,>>9"
        no-undo.
    def param buffer p_bem_pat
        for bem_pat.
    def Input param p_num_parc_pis_cofins
        as integer
        format "999"
        no-undo.
    def Input param p_val_tot_bxa_real_pis
        as decimal
        format "->>,>>>,>>>,>>9.99"
        decimals 2
        no-undo.
    def Input param p_val_tot_bxa_real_cofins
        as decimal
        format "->>,>>>,>>>,>>9.99"
        decimals 2
        no-undo.


    /************************* Parameter Definition End *************************/

    /* Localiza ultimo regsitro calc_parc_pis_cofins referente ao bem que est† sendo baixado */
    find last calc_parc_pis_cofins exclusive-lock
        where calc_parc_pis_cofins.cod_empresa     = p_bem_pat.cod_empresa
        and   calc_parc_pis_cofins.cod_cta_pat     = p_bem_pat.cod_cta_pat
        and   calc_parc_pis_cofins.num_bem_pat     = p_bem_pat.num_bem_pat
        and   calc_parc_pis_cofins.num_seq_bem_pat = p_bem_pat.num_seq_bem_pat
        and   calc_parc_pis_cofins.num_seq_incorp_bem_pat = p_num_seq_incorp_bem_pat no-error.
    if  avail calc_parc_pis_cofins
    and calc_parc_pis_cofins.num_parcela_cr < p_num_parc_pis_cofins then do:

        /* =========================================================================================
          Se o valor da baixa for maior que o valor da baixa real(baixa sem o desconto de parcelas)
          dever† igualar os valores
        =========================================================================================*/                                              
        if  calc_parc_pis_cofins.val_cr_pis_bxa > p_val_tot_bxa_real_pis
            AND v_val_cr_pis_bxa_ant = 0
        then do:
            assign calc_parc_pis_cofins.val_cr_pis_bxa = p_val_tot_bxa_real_pis.
        end /* if */.

        if  calc_parc_pis_cofins.val_cr_cofins_bxa > p_val_tot_bxa_real_cofins
            AND v_val_cr_cofins_bxa_ant = 0
        then do:
            assign calc_parc_pis_cofins.val_cr_cofins_bxa = p_val_tot_bxa_real_cofins.
        end /* if */.

    end.
END PROCEDURE. /* pi_atualiz_val_cr_pis_cofins_bxa_acerto */

/*************************************  *************************************/
/*****************************************************************************
**  Procedure Interna: pi_messages
**  Descricao........: Mostra Mensagem com Ajuda
*****************************************************************************/
PROCEDURE pi_messages:

    def input param c_action    as char    no-undo.
    def input param i_msg       as integer no-undo.
    def input param c_param     as char    no-undo.

    def var c_prg_msg           as char    no-undo.

    assign c_prg_msg = "messages/":U
                     + string(trunc(i_msg / 1000,0),"99":U)
                     + "/msg":U
                     + string(i_msg, "99999":U).

    if search(c_prg_msg + ".r":U) = ? and search(c_prg_msg + ".p":U) = ? then do:
        message getStrTrans("Mensagem nr. ", "FAS") i_msg "!!!":U skip
                getStrTrans("Programa Mensagem", "FAS") c_prg_msg getStrTrans("n∆o encontrado.", "FAS")
                view-as alert-box error.
        return error.
    end.

    run value(c_prg_msg + ".p":U) (input c_action, input c_param).
    return return-value.
END PROCEDURE.  /* pi_messages */
/********************  End of fnc_bem_pat_desmembramento ********************/
