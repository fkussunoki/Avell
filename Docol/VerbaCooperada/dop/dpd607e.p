/*****************************************************************************
** Copyright DATASUL S.A. (1994)
** Todos os Direitos Reservados.
** 
** Este fonte e de propriedade exclusiva da DATASUL, sua reproducao
** parcial ou total por qualquer meio, so' podera ser feita mediante
** autorizacao expressa.
**
** Programa..............: add_antecip_pef_pend
** Descricao.............: Inclui Antecipaá∆o e PEF Pendent
** Versao................:  1.00.01.147
** Procedimento..........: tar_implantar_antecip_apb
** Nome Externo..........: prgfin/apb/apb701ca.p
** Data Geracao..........: 01/08/2019 - 15:34:41
** Criado por............: rafael
** Criado em.............: // 
** Alterado por..........: 002565
** Alterado em...........: 19/07/2019 16:49:43
** Gerado por............: 002565
*****************************************************************************/

/*-- Filtro Multi-idioma Aplicado --*/

def var c-versao-prg as char initial " 1.00.01.147":U no-undo.
def var c-versao-rcode as char initial "[[[1.00.01.147[[[":U no-undo. /* Controle de Versao R-CODE - Nao retirar do Fonte */

{include/i_dbinst.i}
{include/i_dbtype.i}

{include/i_fcldef.i}
{include/i_trddef.i}

&IF "{&EMSFND_VERSION}" >= "1.00" &THEN
{include/i-license-manager.i add_antecip_pef_pend APB}
&ENDIF

/******************************* Private-Data *******************************/
assign this-procedure:private-data = "HLP=5":U.
/*************************************  *************************************/

&if "{&emsfin_dbinst}" <> "yes" &then
run pi_messages (input "show",
                 input 5884,
                 input substitute ("&1~&2~&3~&4~&5~&6~&7~&8~&9", 
                                    "EMSFIN")) /*msg_5884*/.
&elseif "{&emsfin_version}" < "5.01" &then
run pi_messages (input "show",
                 input 5009,
                 input substitute ("&1~&2~&3~&4~&5~&6~&7~&8~&9", 
                                    "ADD_ANTECIP_PEF_PEND","~~EMSFIN", "~~{~&emsfin_version}", "~~5.01")) /*msg_5009*/.
&else

/********************* Temporary Table Definition Begin *********************/

def temp-table tt_acerto_aprop_bxa_ap no-undo
    field tta_cod_finalid_econ             as character format "x(10)" label "Finalidade" column-label "Finalidade"
    field ttv_val_tot_cr                   as decimal format "->>>>,>>>,>>9.99" decimals 2 label "Total CrÇditos" column-label "Total CrÇditos"
    field ttv_val_tot_db                   as decimal format "->>>>,>>>,>>9.99" decimals 2 label "Total DÇbitos" column-label "Total DÇbitos"
    field ttv_rec_val_aprop_ctbl_ap_db     as recid format ">>>>>>9"
    field ttv_rec_val_aprop_ctbl_ap_cr     as recid format ">>>>>>9"
    field ttv_val_maior_val_db             as decimal format "->>,>>>,>>>,>>9.99" decimals 2
    field ttv_val_maior_val_cr             as decimal format "->>,>>>,>>>,>>9.99" decimals 2
    index tt_fe                           
          tta_cod_finalid_econ             ascending
    .

def new shared temp-table tt_compl_histor_padr_valor        
    field tta_cod_compl_padr               as character format "x(8)" label "Complemento Padr∆o" column-label "Comp Pad"
    field tta_cod_format_compl_padr        as character format "x(20)" label "Formato Complemento" column-label "Formato Complemento"
    field ttv_des_val_compl_padr           as character format "x(20)"
    index tt_id                            is primary unique
          tta_cod_compl_padr               ascending
    .

def new shared temp-table tt_converter_finalid_econ no-undo
    field tta_cod_finalid_econ             as character format "x(10)" label "Finalidade" column-label "Finalidade"
    field tta_cod_indic_econ               as character format "x(8)" label "Moeda" column-label "Moeda"
    field tta_dat_cotac_indic_econ         as date format "99/99/9999" initial ? label "Data Cotaá∆o" column-label "Data Cotaá∆o"
    field tta_val_cotac_indic_econ         as decimal format ">>>>,>>9.9999999999" decimals 10 initial 0 label "Cotaá∆o" column-label "Cotaá∆o"
    field tta_val_cotac_tax_juros          as decimal format ">>>>,>>9.9999999999" decimals 10 initial 0 label "Cotac Taxa Juros" column-label "Cotac Taxa Juros"
    field tta_val_prev_cotac_fasb          as decimal format ">>>>,>>9.9999999999" decimals 10 initial 0 label "Cotac Previs Fasb" column-label "Cotac Previs Fasb"
    field tta_val_cotac_cm_emis            as decimal format ">>>>,>>9.9999999999" decimals 10 initial 0 label "Cotac Cm Emiss" column-label "Cotac Cm Emiss"
    field tta_val_cotac_cm_vencto          as decimal format ">>>>,>>9.9999999999" decimals 10 initial 0 label "Cotac Cm Vencto" column-label "Cotac Cm Vencto"
    field tta_val_cotac_cm_pagto           as decimal format ">>>>,>>9.9999999999" decimals 10 initial 0 label "Cotac Cm Pagto" column-label "Cotac CM Pagto"
    field tta_val_transacao                as decimal format "->>,>>>,>>>,>>9.99" decimals 2 initial 0 label "Transaá∆o" column-label "Transaá∆o"
    field tta_val_variac_cambial           as decimal format "->>>,>>>,>>9.99" decimals 2 initial 0 label "Vl Varic Cambial" column-label "Variac Cambial"
    field tta_val_acerto_cmcac             as decimal format "->>>,>>>,>>9.99" decimals 2 initial 0 label "Vl Acerto CMCAC" column-label "Vl Acerto CMCAC"
    field tta_val_fatorf                   as decimal format "->999.9999999999" decimals 10 initial 0 label "Fator F" column-label "Fator F"
    field tta_val_fatorx                   as decimal format "->999.9999999999" decimals 10 initial 0 label "Fator X" column-label "Fator X"
    field tta_val_fatory                   as decimal format "->999.9999999999" decimals 10 initial 0 label "Fator Y" column-label "Fator Y"
    field tta_val_ganho_perda_cm           as decimal format "->>>,>>>,>>9.99" decimals 2 initial 0 label "G/P CM" column-label "G/P CM"
    field tta_val_ganho_perda_projec       as decimal format "->>>,>>>,>>9.99" decimals 2 initial 0 label "G/P Projeá∆o" column-label "G/P Projeá∆o"
    field tta_ind_forma_conver             as character format "X(10)" initial "Direta" label "Forma Convers∆o" column-label "Forma Convers∆o"
    field ttv_val_multa                    as decimal format "->>>,>>>,>>9.99" decimals 2 label "Vl Multa" column-label "Vl Multa"
    field ttv_val_desc                     as decimal format "->>>,>>>,>>9.99" decimals 2 label "Vl Desc" column-label "Vl Desc"
    field ttv_val_juros                    as decimal format "->>>,>>>,>>9.99" decimals 2 label "Valor Juros" column-label "Valor Juros"
    field ttv_val_abat                     as decimal format "->>>,>>>,>>9.99" decimals 2 initial 0 label "Valor Abatimento" column-label "Valor Abatimento"
    field ttv_val_cm                       as decimal format "->>>>>,>>>,>>9.99" decimals 4 initial 0 label "Correá∆o Monet†ria" column-label "Correá∆o Monet†ria"
    field tta_val_despes_bcia              as decimal format "->>>,>>>,>>9.99" decimals 2 initial 0 label "Vl Desp Banc" column-label "Vl Desp Banc"
    .

def new shared temp-table tt_dat_correc no-undo
    field ttv_dat_correc                   as date format "99/99/9999" initial today label "Data Correá∆o" column-label "Data Correá∆o"
    .

def temp-table tt_emitente no-undo
    field tta_cdn_emit                     as Integer format ">>,>>9" initial 0 label "C¢digo Emitente" column-label "C¢digo Emitente"
    .

def temp-table tt_erros_conexao no-undo
    field ttv_cdn_erro                     as Integer format ">>>,>>9"
    field ttv_des_erro                     as character format "x(50)" label "Inconsistància" column-label "Inconsistància"
    .

def new shared temp-table tt_erros_cotac_cta_cmcmm no-undo
    field ttv_num_msg_erro                 as integer format ">>>>>>9" label "Mensagem" column-label "Mensagem"
    field ttv_des_msg_erro                 as character format "x(60)" label "Mensagem Erro" column-label "Inconsistància"
    field ttv_des_msg_ajuda                as character format "x(40)" label "Mensagem Ajuda" column-label "Mensagem Ajuda"
    field ttv_cod_indic_econ_base          as character format "x(8)" label "Moeda Base" column-label "Moeda Base"
    field ttv_cod_indic_econ_idx           as character format "x(8)" label "Moeda ÷ndice" column-label "Moeda ÷ndice"
    field ttv_dat_cotac_indic_econ         as date format "99/99/9999" initial today label "Data Cotaá∆o" column-label "Data Cotaá∆o"
    field ttv_cod_plano_cta_ctbl           as character format "x(8)" label "Plano Contas" column-label "Plano Contas"
    field ttv_cod_cta_ctbl                 as character format "x(20)" label "Conta Cont†bil" column-label "Conta Cont†bil"
    .

def new shared temp-table tt_erros_cotac_parid no-undo
    field tta_cod_indic_econ_base          as character format "x(8)" label "Moeda Base" column-label "Moeda Base"
    field tta_cod_indic_econ_idx           as character format "x(8)" label "Moeda ÷ndice" column-label "Moeda ÷ndice"
    field tta_dat_cotac_indic_econ         as date format "99/99/9999" initial ? label "Data Cotaá∆o" column-label "Data Cotaá∆o"
    field tta_ind_tip_cotac_parid          as character format "X(09)" label "Tipo Cotaá∆o" column-label "Tipo  Cotaá∆o"
    index tt_id_erros                      is primary unique
          tta_cod_indic_econ_base          ascending
          tta_cod_indic_econ_idx           ascending
          tta_dat_cotac_indic_econ         ascending
          tta_ind_tip_cotac_parid          ascending
    .

def new shared temp-table tt_item_bord_lote_mensagem no-undo
    field tta_cod_empresa                  as character format "x(3)" label "Empresa" column-label "Empresa"
    field tta_num_seq_bord                 as integer format ">>>9" initial 0 label "Sequància" column-label "Seq"
    field tta_cod_estab                    as character format "x(3)" label "Estabelecimento" column-label "Estab"
    field tta_cod_refer_antecip_pef        as character format "x(10)" label "Ref Antec PEF Pend" column-label "Ref Antec PEF Pend"
    field tta_cod_espec_docto              as character format "x(3)" label "EspÇcie Documento" column-label "EspÇcie"
    field tta_cod_ser_docto                as character format "x(3)" label "SÇrie Documento" column-label "SÇrie"
    field tta_cdn_fornecedor               as Integer format ">>>,>>>,>>9" initial 0 label "Fornecedor" column-label "Fornecedor"
    field tta_cod_tit_ap                   as character format "x(10)" label "T°tulo" column-label "T°tulo"
    field tta_cod_parcela                  as character format "x(02)" label "Parcela" column-label "Parc"
    field tta_val_pagto                    as decimal format "->>>,>>>,>>9.99" decimals 2 initial 0 label "Valor Pagamento" column-label "Valor Pagto"
    .

def temp-table tt_log_erro no-undo
    field ttv_num_cod_erro                 as integer format ">>>>,>>9" label "N£mero" column-label "N£mero"
    field ttv_des_msg_ajuda                as character format "x(40)" label "Mensagem Ajuda" column-label "Mensagem Ajuda"
    field ttv_des_msg_erro                 as character format "x(60)" label "Mensagem Erro" column-label "Inconsistància"
    .

def new shared temp-table tt_log_erros_atualiz no-undo
    field tta_cod_estab                    as character format "x(3)" label "Estabelecimento" column-label "Estab"
    field tta_cod_refer                    as character format "x(10)" label "Referància" column-label "Referància"
    field tta_num_seq_refer                as integer format ">>>9" initial 0 label "Sequància" column-label "Seq"
    field ttv_num_mensagem                 as integer format ">>>>,>>9" label "N£mero" column-label "N£mero Mensagem"
    field ttv_des_msg_erro                 as character format "x(60)" label "Mensagem Erro" column-label "Inconsistància"
    field ttv_des_msg_ajuda                as character format "x(40)" label "Mensagem Ajuda" column-label "Mensagem Ajuda"
    field ttv_ind_tip_relacto              as character format "X(15)" label "Tipo Relacionamento" column-label "Tipo Relac"
    field ttv_num_relacto                  as integer format ">>>>,>>9" label "Relacionamento" column-label "Relacionamento"
    .

def new shared temp-table tt_log_erros_tit_antecip no-undo
    field tta_cod_estab                    as character format "x(3)" label "Estabelecimento" column-label "Estab"
    field tta_cod_espec_docto              as character format "x(3)" label "EspÇcie Documento" column-label "EspÇcie"
    field tta_cod_ser_docto                as character format "x(3)" label "SÇrie Documento" column-label "SÇrie"
    field tta_cdn_fornecedor               as Integer format ">>>,>>>,>>9" initial 0 label "Fornecedor" column-label "Fornecedor"
    field tta_cod_tit_ap                   as character format "x(10)" label "T°tulo" column-label "T°tulo"
    field tta_cod_parcela                  as character format "x(02)" label "Parcela" column-label "Parc"
    field tta_cod_refer                    as character format "x(10)" label "Referància" column-label "Referància"
    field ttv_des_msg_erro                 as character format "x(60)" label "Mensagem Erro" column-label "Inconsistància"
    field tta_cod_banco                    as character format "x(8)" label "Banco" column-label "Banco"
    field tta_cod_agenc_bcia               as character format "x(10)" label "Agància Banc†ria" column-label "Agància Banc†ria"
    field tta_cod_cta_corren               as character format "x(10)" label "Conta Corrente" column-label "Cta Corrente"
    field tta_num_talon_cheq               as integer format ">>>,>>>,>>9" initial 0 label "Talon†rio Cheques" column-label "Talon†rio Cheques"
    field tta_num_cheque                   as integer format ">>>>,>>>,>>9" initial ? label "Num Cheque" column-label "Num Cheque"
    field ttv_log_atlzdo                   as logical format "Sim/N∆o" initial yes
    field tta_nom_favorec_cheq             as character format "x(40)" label "Nome Favorecido" column-label "Nome Favorecido"
    field tta_dat_emis_cheq                as date format "99/99/9999" initial ? label "Data Emiss∆o" column-label "Dt Emiss"
    field tta_cod_portador                 as character format "x(5)" label "Portador" column-label "Portador"
    field tta_cod_finalid_econ             as character format "x(10)" label "Finalidade" column-label "Finalidade"
    field tta_cod_estab_refer              as character format "x(3)" initial ? label "Estabelecimento" column-label "Estab"
    field tta_num_seq_refer                as integer format ">>>9" initial 0 label "Sequància" column-label "Seq"
    field ttv_des_msg_erro_1               as character format "x(80)" label "Mensagem de Erro" column-label "Mensagem de Erro"
    field ttv_cod_bord_ap                  as character format "x(6)" label "Borderì" column-label "Borderì"
    field ttv_cod_seq_cheq                 as character format "x(2)" label "Sequància" column-label "Sequància"
    .

def new shared temp-table tt_param_correc_val no-undo
    field tta_cod_finalid_econ             as character format "x(10)" label "Finalidade" column-label "Finalidade"
    field ttv_val_cotac_fasb_emis          as decimal format ">>>>,>>9.9999999999" decimals 10
    field tta_val_prev_cotac_fasb          as decimal format ">>>>,>>9.9999999999" decimals 10 initial 0 label "Cotac Previs Fasb" column-label "Cotac Previs Fasb"
    field tta_val_cotac_cm_emis            as decimal format ">>>>,>>9.9999999999" decimals 10 initial 0 label "Cotac Cm Emiss" column-label "Cotac Cm Emiss"
    field ttv_val_cotac_fasb_emis_antecip  as decimal format ">>>>,>>9.9999999999" decimals 10
    field ttv_val_cotac_cm_emis_antecip    as decimal format ">>>>,>>9.9999999999" decimals 10
    field ttv_val_movto                    as decimal format "->,>>>,>>>,>>9.99" decimals 2 label "Movimento" column-label "Valor Movto"
    field ttv_val_movto_antecip            as decimal format ">>>>>,>>>,>>9.99" decimals 2
    field ttv_val_sdo_base                 as decimal format "->>>>,>>>,>>>,>>9.99" decimals 2 label "Saldo Base"
    .

def temp-table tt_procedure no-undo
    field ttv_des_nome                     as character format "x(60)" label "Nome" column-label "Nome"
    field ttv_hdl_prog                     as Handle format ">>>>>>9"
    .

def temp-table tt_titulo_apb_esocial no-undo
    field tta_cod_estab                    as Character format "x(5)" label "Estabelecimento" column-label "Estab"
    field tta_cod_tit_ap                   as character format "x(10)" label "T°tulo" column-label "T°tulo"
    field ttv_cod_fornecedor               as character format "x(10)" label "Fornecedor" column-label "Fornecedor"
    field tta_cod_ser_docto                as character format "x(3)" label "SÇrie Documento" column-label "SÇrie"
    field tta_cod_espec_docto              as character format "x(3)" label "EspÇcie Documento" column-label "EspÇcie"
    field tta_cod_parcela                  as character format "x(02)" label "Parcela" column-label "Parc"
    field tta_val_tit_ap                   as decimal format "->>>,>>>,>>9.99" decimals 2 initial 0 label "Valor T°tulo" column-label "Valor T°tulo"
    field ttv_row_id                       as Rowid
    field tta_log_cooperat                 as logical format "Sim/N∆o" initial no label "Cooperativa" column-label "Cooperativa"
    field tta_log_assoc_desport            as logical format "Sim/N∆o" initial no label "Assoc Desportiva" column-label "Desportiva"
    field tta_dat_emis_docto               as date format "99/99/9999" initial today label "Data  Emiss∆o" column-label "Dt Emiss∆o"
    .

def temp-table tt_unid_negoc_abatido no-undo
    field tta_cod_unid_negoc               as character format "x(3)" label "Unid Neg¢cio" column-label "Un Neg"
    field tta_val_sdo_tit_ap               as decimal format "->>>,>>>,>>9.99" decimals 2 initial 0 label "Valor Saldo" column-label "Valor Saldo"
    field tta_val_comprtdo_tit_ap          as decimal format "->>>,>>>,>>9.99" decimals 2 initial 0 label "Valor Comprometido d" column-label "Valor Comprometido d"
    field tta_val_sdo_tit_acr              as decimal format ">>>,>>>,>>9.99" decimals 2 initial 0 label "Saldo T°tulo" column-label "Saldo T°tulo"
    field tta_val_comprtdo_tit_acr         as decimal format "->>>,>>>,>>9.99" decimals 2 initial 0 label "Valor Comprtdo" column-label "Valor Comprtdo"
    .

def new shared temp-table tt_vl_sdo_un_origem no-undo
    field ttv_cod_unid_negoc_orig          as character format "x(3)" label "Unid Negoc" column-label "Unid Negoc"
    field ttv_val_sdo_unid_negoc           as decimal format "->>>,>>>,>>9.99" decimals 2 label "Saldo UN" column-label "Saldo UN"
    field ttv_val_tot_transfdo             as decimal format "->>>,>>>,>>9.99" decimals 2 label "Total Transferido" column-label "Total Transferido"
    .

def new shared temp-table tt_vl_transfdo_un no-undo
    field ttv_cod_unid_negoc_orig          as character format "x(3)" label "Unid Negoc" column-label "Unid Negoc"
    field ttv_cod_unid_negoc_dest          as character format "x(3)" label "UN Destino" column-label "UN Destino"
    field ttv_val_transfdo                 as decimal format "->>>,>>>,>>9.99" decimals 2 label "Valor Transferido" column-label "Valor Transferido"
    field ttv_val_perc_transf              as decimal format ">>9.9999999999" decimals 10
    index tt_un_orig_dest                  is primary unique
          ttv_cod_unid_negoc_orig          ascending
          ttv_cod_unid_negoc_dest          ascending
    .

DEFINE var  p-emitente AS INTEGER NO-UNDO.
DEFINE var  p-nom-abrev AS CHAR NO-UNDO.
DEFINE var  p-numero    AS INTEGER NO-UNDO.
DEFINE var  p-vlr       AS DECIMAL FORMAT "->>>,>>>,>>9.99" NO-UNDO.

/********************** Temporary Table Definition End **********************/

/************************** Buffer Definition Begin *************************/

&if "{&emsfin_version}" >= "5.01" &then
def buffer b_antecip_pef_pend
    for antecip_pef_pend.
&endif
&if "{&emsfin_version}" >= "5.01" &then
def buffer b_antecip_pef_pend_add
    for antecip_pef_pend.
&endif
&if "{&emsfin_version}" >= "5.01" &then
def buffer b_antecip_pef_pend_copy
    for antecip_pef_pend.
&endif
&if "{&emsfin_version}" >= "5.01" &then
def buffer b_histor_tit_movto_ap
    for histor_tit_movto_ap.
&endif
&if "{&emsfin_version}" >= "5.01" &then
def buffer b_movto_tit_ap_abat
    for movto_tit_ap.
&endif
&if "{&emsfin_version}" >= "5.01" &then
def buffer b_tab_livre_emsfin
    for tab_livre_emsfin.
&endif
&if "{&emsfin_version}" >= "5.01" &then
def buffer b_tit_ap_abat
    for tit_ap.
&endif


/*************************** Buffer Definition End **************************/

/************************* Variable Definition Begin ************************/

def var v_cdd_num_docto_esoc
    as Decimal
    format ">>>,>>>,>>9":U
    decimals 0
    no-undo.
def var v_cdd_num_docto_esoc_aux
    as Decimal
    format ">>>,>>>,>>9":U
    decimals 0
    no-undo.
def var v_cdn_fornecedor
    as Integer
    format ">>>,>>>,>>9":U
    label "Fornecedor"
    column-label "Fornecedor"
    no-undo.
def var v_cdn_fornecedor_mat
    as Integer
    format ">>>,>>>,>>9":U
    label "Fornec Matriz"
    column-label "Fornec Matriz"
    no-undo.
def var v_cod_acao
    as character
    format "x(8)":U
    no-undo.
def new global shared var v_cod_aplicat_dtsul_corren
    as character
    format "x(3)":U
    no-undo.
def var v_cod_barra
    as character
    format "x(44)":U
    label "C¢d. Barras"
    no-undo.
def var v_cod_cart_bcia
    as character
    format "x(3)":U
    label "Carteira"
    column-label "Carteira"
    no-undo.
def new global shared var v_cod_ccusto_corren
    as character
    format "x(11)":U
    label "Centro Custo"
    column-label "Centro Custo"
    no-undo.
def var v_cod_contrat_graos
    as character
    format "x(20)":U
    label "Contrato Gr∆os"
    column-label "Contr Gr∆os"
    no-undo.
def var v_cod_cta_corren
    as character
    format "x(10)":U
    label "Conta Corrente"
    column-label "Conta Corrente"
    no-undo.
def new global shared var v_cod_dwb_user
    as character
    format "x(21)":U
    label "Usu†rio"
    column-label "Usu†rio"
    no-undo.
def var v_cod_empresa_aux
    as character
    format "x(3)":U
    label "Empresa"
    column-label "Empresa"
    no-undo.
def var v_cod_empres_ems_2
    as character
    format "x(3)":U
    label "Empresa EMS2"
    column-label "Emp EMS2"
    no-undo.
def new global shared var v_cod_empres_usuar
    as character
    format "x(3)":U
    label "Empresa"
    column-label "Empresa"
    no-undo.
def var v_cod_empres_usuar_2
    as character
    format "x(30)":U
    no-undo.
def new global shared var v_cod_empres_usuar_aux
    as character
    format "x(3)":U
    label "Empresa"
    no-undo.
def var v_cod_espec_docto
    as character
    format "x(3)":U
    label "EspÇcie Documento"
    column-label "EspÇcie"
    no-undo.
def new global shared var v_cod_estab_usuar
    as character
    format "x(3)":U
    label "Estabelecimento"
    column-label "Estab"
    no-undo.
def var v_cod_finalid_econ
    as character
    format "x(10)":U
    label "Finalidade Econìmica"
    column-label "Finalidade Econìmica"
    no-undo.
def var v_cod_finalid_econ_antecip
    as character
    format "x(8)":U
    no-undo.
def var v_cod_forma_pagto_equador
    as character
    format "x(18)":U
    view-as combo-box
    &if "{&FNC_MULTI_IDIOMA}" = "YES" &then
    list-item-pairs "01-Sem sist fin","01-Sem sist fin","02-Cheque pr¢p","02-Cheque pr¢p","03-Cheque adm","03-Cheque adm","04-Cheq geren","04-Cheq geren","05-Cheq do ext","05-Cheq do ext","06-DÇbito em cta","06-DÇbito em cta","07-Trf msm bco","07-Trf msm bco","08-Trf outro bco","08-Trf outro bco","09-Trf bco ext","09-Trf bco ext","10-Cart crÇd nac","10-Cart crÇd nac","11-Cart crÇd int","11-Cart crÇd int","12-Cheque bcio","12-Cheque bcio","13-Dep¢sito","13-Dep¢sito","14-Endosso Invest","14-Endosso Invest","15-Compens d°vida","15-Compens d°vida"
    &else
    list-items "01-Sem sist fin","02-Cheque pr¢p","03-Cheque adm","04-Cheq geren","05-Cheq do ext","06-DÇbito em cta","07-Trf msm bco","08-Trf outro bco","09-Trf bco ext","10-Cart crÇd nac","11-Cart crÇd int","12-Cheque bcio","13-Dep¢sito","14-Endosso Invest","15-Compens d°vida"
    &endif
     /*l_01sem_sist_fin*/ /*l_02cheque_prop*/ /*l_03cheque_adm*/ /*l_04cheq_geren*/ /*l_05cheq_do_ext*/ /*l_06debito_em_cta*/ /*l_07trf_msm_bco*/ /*l_08trf_outro_bco*/ /*l_09trf_bco_ext*/ /*l_10cart_cred_nac*/ /*l_11cart_cred_int*/ /*l_12cheque_bcio*/ /*l_13deposito*/ /*l_14endosso_invest*/ /*l_15compens_divida*/
    inner-lines 14
    bgcolor 15 font 2
    label "FP ATS"
    column-label "FP ATS"
    no-undo.
def new global shared var v_cod_fornec_infor
    as character
    format "x(20)":U
    label "Fornecedor"
    column-label "Fornecedor"
    no-undo.
def var v_cod_fornec_infor_ant
    as character
    format "x(20)":U
    no-undo.
def new global shared var v_cod_funcao_negoc_empres
    as character
    format "x(50)":U
    no-undo.
def new global shared var v_cod_grp_usuar_lst
    as character
    format "x(3)":U
    label "Grupo Usu†rios"
    column-label "Grupo"
    no-undo.
def new global shared var v_cod_idiom_usuar
    as character
    format "x(8)":U
    label "Idioma"
    column-label "Idioma"
    no-undo.
def new global shared var v_cod_id_feder
    as character
    format "x(20)":U
    label "Fornecedor"
    column-label "ID Federal"
    no-undo.
def var v_cod_indic_econ
    as character
    format "x(8)":U
    label "Moeda"
    column-label "Moeda"
    no-undo.
def var v_cod_indic_econ_ant
    as character
    format "x(8)":U
    label "Moeda Anterior"
    column-label "Moeda Anterior"
    no-undo.
def var v_cod_indic_econ_antecip
    as character
    format "x(8)":U
    no-undo.
def var v_cod_mod
    as character
    format "x(3)":U
    no-undo.
def new global shared var v_cod_modul_dtsul_corren
    as character
    format "x(3)":U
    label "M¢dulo Corrente"
    column-label "M¢dulo Corrente"
    no-undo.
def new global shared var v_cod_modul_dtsul_empres
    as character
    format "x(100)":U
    no-undo.
def var v_cod_num_bcio
    as character
    format "x(20)":U
    label "N£mero Banc†rio"
    column-label "N£mero Banc†rio"
    no-undo.
def new global shared var v_cod_pais
    as character
    format "x(3)":U
    label "Pa°s"
    column-label "Pa°s"
    no-undo.
def new global shared var v_cod_pais_empres_usuar
    as character
    format "x(3)":U
    label "Pa°s Empresa Usu†rio"
    column-label "Pa°s"
    no-undo.
def var v_cod_pais_empres_usuar_ant
    as character
    format "x(3)":U
    label "Pais Empresa Usuario"
    column-label "Pais"
    no-undo.
def var v_cod_pais_fornec_clien
    as character
    format "x(8)":U
    no-undo.
def var v_cod_parameters
    as character
    format "x(256)":U
    no-undo.
def new global shared var v_cod_param_msg_erro_valid
    as character
    format "x(100)":U
    no-undo.
def var v_cod_parcela
    as character
    format "x(02)":U
    label "Parcela"
    column-label "Parc"
    no-undo.
def new global shared var v_cod_plano_ccusto_corren
    as character
    format "x(8)":U
    label "Plano CCusto"
    column-label "Plano CCusto"
    no-undo.
def var v_cod_portador_aux
    as character
    format "x(5)":U
    label "Portador"
    column-label "Portador"
    no-undo.
def var v_cod_portador_old
    as character
    format "x(5)":U
    label "Portador"
    column-label "Portador"
    no-undo.
def var v_cod_refer
    as character
    format "x(10)":U
    label "Referància"
    column-label "Referància"
    no-undo.
def var v_cod_return
    as character
    format "x(40)":U
    no-undo.
def var v_cod_return_liber_pagto
    as character
    format "x(8)":U
    no-undo.
def var v_cod_return_pagto
    as character
    format "x(8)":U
    no-undo.
def var v_cod_safra_graos
    as character
    format "9999/9999":U
    label "Safra"
    column-label "Safra"
    no-undo.
def var v_cod_ser_docto
    as character
    format "x(3)":U
    label "SÇrie Docto"
    column-label "SÇrie"
    no-undo.
def var v_cod_tip_fornecto
    as character
    format "x(12)":U
    label "Fornecimento"
    column-label "Fornecimento"
    no-undo.
def var v_cod_tip_valid
    as character
    format "x(8)":U
    no-undo.
def var v_cod_tit_ap
    as character
    format "x(10)":U
    label "T°tulo Ap"
    column-label "T°tulo Ap"
    no-undo.
def new global shared var v_cod_unid_negoc_usuar
    as character
    format "x(3)":U
    view-as combo-box
    &if "{&FNC_MULTI_IDIOMA}" = "YES" &then
    list-item-pairs "",""
    &else
    list-items ""
    &endif
    inner-lines 5
    bgcolor 15 font 2
    label "Unidade Neg¢cio"
    column-label "Unid Neg¢cio"
    no-undo.
def new global shared var v_cod_usuar_corren
    as character
    format "x(12)":U
    label "Usu†rio Corrente"
    column-label "Usu†rio Corrente"
    no-undo.
def var v_cod_usuar_corren_aux
    as character
    format "x(12)":U
    label "Usu†rio"
    no-undo.
def new global shared var v_cod_usuar_corren_criptog
    as character
    format "x(16)":U
    no-undo.
def var v_dat_confir_bxa_tit_ap
    as date
    format "99/99/9999":U
    label "Data Baixa"
    column-label "Data Baixa"
    no-undo.
def var v_dat_cotac_indic_econ
    as date
    format "99/99/9999":U
    initial today
    label "Data Cotaá∆o"
    column-label "Data Cotaá∆o"
    no-undo.
def new global shared var v_dat_impto_pagto
    as date
    format "99/99/9999":U
    initial ?
    no-undo.
def var v_dat_pagto_fasb
    as date
    format "99/99/9999":U
    initial today
    no-undo.
def var v_des_erro_aux
    as character
    format "x(200)":U
    label "Erro RPC AUX"
    column-label "Erro"
    no-undo.
def var v_des_erro_rpc
    as character
    format "x(200)":U
    label "Erro RPC"
    column-label "Erro RPC"
    no-undo.
def var v_des_movimento
    as character
    format "x(40)":U
    no-undo.
def var v_des_msg_erro_1
    as character
    format "x(80)":U
    label "Mensagem de Erro"
    column-label "Mensagem de Erro"
    no-undo.
def var v_des_param
    as character
    format "x(50)":U
    label "Param"
    column-label "Param"
    no-undo.
def var v_des_sit_movimen_ent
    as character
    format "x(40)":U
    no-undo.
def new global shared var v_hdl_api_centraliz_apb_apf
    as Handle
    format ">>>>>>9":U
    no-undo.
def var v_hdl_api_graos
    as Handle
    format ">>>>>>9":U
    no-undo.
def var v_hdl_aux
    as Handle
    format ">>>>>>9":U
    no-undo.
def var v_hdl_funcao_mex
    as Handle
    format ">>>>>>9":U
    no-undo.
def var v_hdl_localiz_impto_acum
    as Handle
    format ">>>>>>9":U
    no-undo.
def var v_hdl_prog
    as Handle
    format ">>>>>>9":U
    no-undo.
def var v_ind_calc_fasb
    as character
    format "X(10)":U
    no-undo.
def var v_ind_finalid_ctbl_err
    as character
    format "X(30)":U
    label "Finalidade Cont†bil"
    column-label "Finalidade Cont†bil"
    no-undo.
def var v_ind_modo_impl
    as character
    format "X(08)":U
    no-undo.
def var v_ind_modo_pagto
    as character
    format "X(10)":U
    view-as combo-box
    &if "{&FNC_MULTI_IDIOMA}" = "YES" &then
    list-item-pairs "Cheque","Cheque","Borderì","Borderì","Escritural","Escritural","Dinheiro","Dinheiro","",""
    &else
    list-items "Cheque","Borderì","Escritural","Dinheiro",""
    &endif
     /*l_cheque*/ /*l_bordero*/ /*l_escritural*/ /*l_dinheiro*/ /*l_null*/
    inner-lines 6
    bgcolor 15 font 2
    label "Modo Pagto"
    column-label "Modo Pagto"
    no-undo.
def var v_ind_param_aprov_docto
    as character
    format "X(12)":U
    initial "Geral" /*l_geral*/
    view-as radio-set Horizontal
    radio-buttons "Geral", "Geral", "Por EspÇcie", "Por EspÇcie"
     /*l_geral*/ /*l_geral*/ /*l_por_especie*/ /*l_por_especie*/
    bgcolor 8 
    label "ParÉmetro"
    column-label "ParÉmetro"
    no-undo.
def var v_ind_tip_conver
    as character
    format "X(08)":U
    label "Tipo Convers∆o"
    column-label "Tipo Convers∆o"
    no-undo.
def var v_log_achou
    as logical
    format "Sim/N∆o"
    initial no
    no-undo.
def var v_log_acum_matriz
    as logical
    format "Sim/N∆o"
    initial no
    label "Acumula Por Matriz"
    column-label "Acumula Por Matriz"
    no-undo.
def var v_log_agrup_cheq_cod_fornec
    as logical
    format "Sim/N∆o"
    initial no
    no-undo.
def var v_log_apf_portad
    as logical
    format "Sim/N∆o"
    initial no
    no-undo.
def var v_log_aprov_impl_apf
    as logical
    format "Sim/N∆o"
    initial no
    view-as toggle-box
    label "Implantaá∆o"
    no-undo.
def var v_log_aprov_pagto_apf
    as logical
    format "Sim/N∆o"
    initial no
    view-as toggle-box
    label "Pagamento"
    no-undo.
def var v_log_assoc_despr
    as logical
    format "Sim/N∆o"
    initial no
    view-as toggle-box
    label "Assoc. Desportiva"
    column-label "Assoc. Desportiva"
    no-undo.
def var v_log_atualiz_hora_liber
    as logical
    format "Sim/N∆o"
    initial no
    no-undo.
def var v_log_calc_val_pres
    as logical
    format "Sim/N∆o"
    initial yes
    label "Calc Valor Presente"
    column-label "Calc Valor Presente"
    no-undo.
def var v_log_calc_variac
    as logical
    format "Sim/N∆o"
    initial no
    label "Calcula Variaá∆o"
    column-label "Calcula Variaá∆o"
    no-undo.
def var v_log_calc_variac_fasb
    as logical
    format "Sim/N∆o"
    initial no
    label "Calc Variaá∆o FASB"
    column-label "Calc Variaá∆o FASB"
    no-undo.
def var v_log_control_invest
    as logical
    format "Sim/N∆o"
    initial no
    no-undo.
def var v_log_cop_aux
    as logical
    format "Sim/N∆o"
    initial no
    view-as toggle-box
    label "Cooperativa"
    column-label "Cooperativa"
    no-undo.
def var v_log_dat_vencto_impto
    as logical
    format "Sim/N∆o"
    initial no
    no-undo.
def new global shared var v_log_eai_habilit
    as logical
    format "Sim/N∆o"
    initial no
    no-undo.
def var v_log_envia_xml
    as logical
    format "Sim/N∆o"
    initial no
    view-as toggle-box
    column-label "Envia XML APB"
    no-undo.
def new shared var v_log_erro_epc
    as logical
    format "Sim/N∆o"
    initial no
    no-undo.
def var v_log_erro_lote
    as logical
    format "Sim/N∆o"
    initial no
    no-undo.
def var v_log_erro_valid
    as logical
    format "Sim/N∆o"
    initial yes
    no-undo.
def var v_log_funcao_agro_negoc
    as logical
    format "Sim/N∆o"
    initial no
    no-undo.
def var v_log_funcao_cod_barra
    as logical
    format "Sim/N∆o"
    initial no
    no-undo.
def var v_log_funcao_mutuo
    as logical
    format "Sim/N∆o"
    initial no
    no-undo.
def var v_log_habilit_portad
    as logical
    format "Sim/N∆o"
    initial no
    no-undo.
def var v_log_impto_taxado
    as logical
    format "Sim/N∆o"
    initial yes
    view-as toggle-box
    label "Imposto Taxado"
    column-label "Imposto Taxado"
    no-undo.
def var v_log_impto_val_agreg
    as logical
    format "Sim/N∆o"
    initial no
    view-as toggle-box
    no-undo.
def var v_log_impto_vincul_fornec
    as logical
    format "Sim/N∆o"
    initial yes
    no-undo.
def var v_log_integr_graos
    as logical
    format "Sim/N∆o"
    initial no
    view-as toggle-box
    label "Integr Orig.Gr∆os"
    no-undo.
def var v_log_integr_safra_graos
    as logical
    format "Sim/N∆o"
    initial no
    no-undo.
def var v_log_legal_sem_integr
    as logical
    format "Sim/N∆o"
    initial no
    label "Legado sem Integraca"
    column-label "Legado"
    no-undo.
def var v_log_liberd_antecip_cr
    as logical
    format "Sim/N∆o"
    initial no
    no-undo.
def var v_log_ligac_integr
    as logical
    format "Sim/N∆o"
    initial no
    label "Integraá∆o EMS2"
    column-label "Integraá∆o EMS2"
    no-undo.
def var v_log_localiz_arg
    as logical
    format "Sim/N∆o"
    initial no
    no-undo.
def var v_log_localiz_equador
    as logical
    format "Sim/N∆o"
    initial no
    no-undo.
def var v_log_localiz_mex
    as logical
    format "Sim/N∆o"
    initial no
    no-undo.
def var v_log_method
    as logical
    format "Sim/N∆o"
    initial yes
    no-undo.
def var v_log_mod_apf
    as logical
    format "Sim/N∆o"
    initial no
    no-undo.
def var v_log_pagto_ant_outras_moed
    as logical
    format "Sim/N∆o"
    initial no
    no-undo.
def var v_log_param_apb_apf
    as logical
    format "Sim/N∆o"
    initial no
    label "Param APF x APB"
    no-undo.
def var v_log_portador
    as logical
    format "Sim/N∆o"
    initial yes
    view-as toggle-box
    label "Portador"
    column-label "Portador"
    no-undo.
def var v_log_refer_uni
    as logical
    format "Sim/N∆o"
    initial yes
    no-undo.
def var v_log_reg_corporat
    as logical
    format "Sim/N∆o"
    initial no
    view-as toggle-box
    label "Registro Corporativo"
    column-label "Registro Corporativo"
    no-undo.
def var v_log_repeat
    as logical
    format "Sim/N∆o"
    initial yes
    view-as toggle-box
    no-undo.
def var v_log_retenc_impto_pagto
    as logical
    format "Sim/N∆o"
    initial NO
    view-as toggle-box
    no-undo.
def var v_log_retenc_impto_pagto_1
    as logical
    format "Sim/N∆o"
    initial no
    view-as toggle-box
    no-undo.
def var v_log_return_epc
    as logical
    format "Sim/N∆o"
    initial ?
    no-undo.
def var v_log_rpc
    as logical
    format "Sim/N∆o"
    initial no
    label "RPC"
    column-label "RPC"
    no-undo.
def var v_log_save_ok
    as logical
    format "Sim/N∆o"
    initial no
    no-undo.
def var v_log_sucesso
    as logical
    format "Sim/N∆o"
    initial no
    no-undo.
def var v_log_sul_america
    as logical
    format "Sim/N∆o"
    initial no
    no-undo.
def var v_log_tit_ap_unico
    as logical
    format "Sim/N∆o"
    initial yes
    label "T°tulo Ènico"
    column-label "T°tulo Ènico"
    no-undo.
def var v_log_tit_vincul
    as logical
    format "Sim/N∆o"
    initial No
    no-undo.
def var v_log_utiliza_mbh
    as logical
    format "Sim/N∆o"
    initial no
    no-undo.
def var v_nom_favorec
    as character
    format "x(30)":U
    no-undo.
def var v_nom_prog_appc
    as character
    format "x(50)":U
    label "Programa APPC"
    column-label "Programa APPC"
    no-undo.
def var v_nom_prog_dpc
    as character
    format "x(50)":U
    label "Programa Dpc"
    column-label "Programa Dpc"
    no-undo.
def var v_nom_prog_upc
    as character
    format "X(50)":U
    label "Programa UPC"
    column-label "Programa UPC"
    no-undo.
def var v_nom_table_epc
    as character
    format "x(30)":U
    no-undo.
def var v_nom_title_aux
    as character
    format "x(60)":U
    no-undo.
def var v_num_cheq
    as integer
    format ">>>>,>>>,>>9":U
    label "N£mero Cheque"
    column-label "N£mero Cheque"
    no-undo.
def var v_num_cont
    as integer
    format ">,>>9":U
    initial 0
    no-undo.
def var v_num_event
    as integer
    format ">>>9":U
    initial 0
    label "Evento"
    column-label "Evento"
    no-undo.
def var v_num_mensagem
    as integer
    format ">>>>,>>9":U
    label "N£mero"
    column-label "N£mero Mensagem"
    no-undo.
def var v_num_ord_compra
    as integer
    format ">>>>>>,>9":U
    initial 0
    label "Ordem Compra"
    column-label "Ordem Compra"
    no-undo.
def var v_num_ord_invest
    as integer
    format ">>>>>,>>9":U
    initial 0
    label "Ordem Investimento"
    column-label "Ordem Invest"
    no-undo.
def var v_num_ped_compra
    as integer
    format ">>>>>,>>9":U
    initial 0
    label "Ped Compra"
    column-label "Ped Compra"
    no-undo.
def new global shared var v_num_ped_exec_corren
    as integer
    format ">>>>9":U
    no-undo.
def var v_num_pessoa
    as integer
    format ">>>,>>>,>>9":U
    label "Pessoa"
    column-label "Pessoa"
    no-undo.
def var v_num_talon_cheq
    as integer
    format ">>>,>>>,>>9":U
    label "Talon†rio Cheques"
    column-label "Talon†rio Cheques"
    no-undo.
def new global shared var v_rec_antecip_pef_pend
    as recid
    format ">>>>>>9":U
    no-undo.
def var v_rec_cheq_ap
    as recid
    format ">>>>>>9":U
    initial ?
    no-undo.
def new global shared var v_rec_espec_docto
    as recid
    format ">>>>>>9":U
    initial ?
    no-undo.
def new global shared var v_rec_estabelecimento
    as recid
    format ">>>>>>9":U
    no-undo.
def new global shared var v_rec_forma_pagto
    as recid
    format ">>>>>>9":U
    initial ?
    no-undo.
def new global shared var v_rec_fornecedor
    as recid
    format ">>>>>>9":U
    no-undo.
def new global shared var v_rec_fornec_financ
    as recid
    format ">>>>>>9":U
    initial ?
    no-undo.
def new global shared var v_rec_indic_econ
    as recid
    format ">>>>>>9":U
    no-undo.
def var v_rec_log
    as recid
    format ">>>>>>9":U
    no-undo.
def new global shared var v_rec_pais
    as recid
    format ">>>>>>9":U
    initial ?
    no-undo.
def new global shared var v_rec_portador
    as recid
    format ">>>>>>9":U
    initial ?
    no-undo.
def var v_rec_proces_pagto
    as recid
    format ">>>>>>9":U
    initial ?
    no-undo.
def var v_rec_table
    as recid
    format ">>>>>>9":U
    initial ?
    no-undo.
def var v_rec_table_epc
    as recid
    format ">>>>>>9":U
    no-undo.
def var v_rec_table_sav
    as recid
    format ">>>>>>9":U
    no-undo.
def new global shared var v_rec_talon_cheq
    as recid
    format ">>>>>>9":U
    initial ?
    no-undo.
def new global shared var v_rec_usuar_financ_estab_apb
    as recid
    format ">>>>>>9":U
    initial ?
    no-undo.
def var v_row_id
    as Rowid
    no-undo.
def var v_val_cotac_indic_econ
    as decimal
    format "->>,>>>,>>>,>>9.9999999999":U
    decimals 10
    label "Cotaá∆o"
    column-label "Cotaá∆o"
    no-undo.
def var v_val_cotac_indic_econ_inv
    as decimal
    format ">>>>,>>9.9999999999":U
    decimals 10
    label "Cotaá∆o Inversa"
    column-label "Cotaá∆o Inversa"
    no-undo.
def var v_val_limit_credito_safra
    as decimal
    format "->>,>>>,>>>,>>9.99":U
    decimals 2
    label "Limite CrÇdito"
    column-label "Limite CrÇdito"
    no-undo.
def var v_val_lim_liber_usuar_mes
    as decimal
    format "->>,>>>,>>>,>>9.99":U
    decimals 2
    label "Limite Màs"
    column-label "Limite Màs"
    no-undo.
def var v_val_lim_liber_usuar_movto
    as decimal
    format "->>>,>>>,>>9.99":U
    decimals 2
    label "Limite Movimento"
    column-label "Limite Movimento"
    no-undo.
def var v_val_lim_pagto_usuar_mes
    as decimal
    format "->>,>>>,>>>,>>9.99":U
    decimals 2
    label "Limite Màs"
    column-label "Limite Màs"
    no-undo.
def var v_val_lim_pagto_usuar_movto
    as decimal
    format "->>>,>>>,>>9.99":U
    decimals 2
    label "Limite Movimento"
    column-label "Limite Movimento"
    no-undo.
def var v_val_orig_tit_ap
    as decimal
    format "->>,>>>,>>>,>>9.99":U
    decimals 2
    no-undo.
def var v_val_pagto
    as decimal
    format "->>,>>>,>>>,>>9.99":U
    decimals 2
    label "Valor Pagamento"
    column-label "Valor Pagamento"
    no-undo.
def var v_val_sdo
    as decimal
    format "->>,>>>,>>>,>>9.99":U
    decimals 2
    label "Valor Saldo"
    column-label "Valor Saldo"
    no-undo.
def var v_val_sdo_orig_ult_correc_val
    as decimal
    format "->>,>>>,>>>,>>9.99":U
    decimals 2
    no-undo.
def var v_wgh_aux
    as widget-handle
    format ">>>>>>9":U
    no-undo.
def var v_wgh_current_button
    as widget-handle
    format ">>>>>>9":U
    no-undo.
def var v_wgh_focus
    as widget-handle
    format ">>>>>>9":U
    no-undo.
def var v_wgh_frame
    as widget-handle
    format ">>>>>>9":U
    no-undo.
def var v_wgh_frame_epc
    as widget-handle
    format ">>>>>>9":U
    no-undo.
def var v_wgh_servid_rpc
    as widget-handle
    format ">>>>>>9":U
    label "Handle RPC"
    column-label "Handle RPC"
    no-undo.
def var v_hdl_ems2                       as handle          no-undo. /*local*/
def var v_hdl_ems2_ant                   as handle          no-undo. /*local*/
def var v_log_connect_ems2_ok            as logical         no-undo. /*local*/
def var v_log_erro_apf                   as logical         no-undo. /*local*/
def var v_log_existe                     as logical         no-undo. /*local*/
def var v_log_oc_antecip                 as logical         no-undo. /*local*/
def var v_log_portad_cx                  as logical         no-undo. /*local*/
def var v_log_return                     as logical         no-undo. /*local*/
def var v_log_valid                      as logical         no-undo. /*local*/


/************************** Variable Definition End *************************/

/*************************** Menu Definition Begin **************************/

.

def menu      m_help                menubar
    menu-item mi_conteudo           label "&Conte£do"
    menu-item mi_sobre              label "&Sobre".



/**************************** Menu Definition End ***************************/

/************************** Query Definition Begin **************************/

def query qr_fornecedor_id_feder
    for fornecedor
    scrolling.


/*************************** Query Definition End ***************************/

/************************** Browse Definition Begin *************************/

def browse br_fornecedor_id_feder query qr_fornecedor_id_feder display 
    fornecedor.cdn_fornecedor
    width-chars 09.00
        column-label "Fornec"
    fornecedor.nom_pessoa
    width-chars 40.00
        column-label "Nome"
    fornecedor.nom_abrev
    width-chars 15.00
        column-label "Nome Abreviado"
    with no-box separators single 
         size 52.29 by 04.54
         font 4
         bgcolor 15.


/*************************** Browse Definition End **************************/

/************************ Rectangle Definition Begin ************************/

def rectangle rt_004
    size 1 by 1
    edge-pixels 2.
def rectangle rt_005
    size 1 by 1
    edge-pixels 2.
def rectangle rt_cxcf
    size 1 by 1
    fgcolor 1 edge-pixels 2.
def rectangle rt_key
    size 1 by 1
    edge-pixels 2.
def rectangle rt_mold
    size 1 by 1
    edge-pixels 2.


/************************* Rectangle Definition End *************************/

/************************** Image Definition Begin **************************/

&if "{&window-system}" <> "TTY" &then
def image im_cta_corren
    file "image/im-cmg.bmp":U
    size 08.00 by 02.00.
&endif


/*************************** Image Definition End ***************************/

/************************** Button Definition Begin *************************/

def button bt_abat_prev
    label "Previs∆o"
    tooltip "Abatimento Previs∆o"
    size 1 by 1.
def button bt_can
    label "Cancela"
    tooltip "Cancela"
    size 1 by 1
    auto-endkey.
def button bt_cod_barra
    label "Cod Barras"
    tooltip "Informa C¢digo de Barras"
    size 1 by 1.
def button bt_cop
    label "Cop"
    tooltip "Copia"
&if "{&window-system}" <> "TTY" &then
    image-up file "image/im-cop"
    image-insensitive file "image/ii-cop"
&endif
    size 1 by 1.
def button bt_hel2
    label "Ajuda"
    tooltip "Ajuda"
    size 1 by 1.
def button bt_histor_padr
    label "Hist¢rico"
    tooltip "Hist¢rico Padr∆o"
    size 1 by 1.
def button bt_impto_retido2
    label "I.Retido"
    tooltip "Imposto Retido"
    size 1 by 1.
def button bt_impto_taxado
    label "Impto Taxado"
    tooltip "Impostos Taxados"
    size 1 by 1.
def button bt_impto_val_agreg
    label "IVA"
    tooltip "Imposto Valor Agregado"
    size 1 by 1.
def button bt_ok
    label "OK"
    tooltip "OK"
    size 1 by 1
    auto-go.
def button bt_ordem_compra
    label "Ordem Compra"
    tooltip "Vincula ordens de compra"
    size 1 by 1.
def button bt_rat_val
    label "Rateio Valor"
    tooltip "Rateio Valor"
    size 1 by 1.
def button bt_sav
    label "Salva"
    tooltip "Salva"
    size 1 by 1
    auto-go.
def button bt_segur_leas
    label "Segur/Leas"
    tooltip "Seguro/Leasing"
    size 1 by 1.
def button bt_vinc_imp_fornec2
    label "Impto/Fornec"
    tooltip ""
&if "{&window-system}" <> "TTY" &then
    image-up file "image/im-forma.bmp"
    image-insensitive file "image/ii-forma.bmp"
&endif
    size 1 by 1.
def button bt_zoo
    label "Zoom"
    tooltip "Zoom"
&if "{&window-system}" <> "TTY" &then
    image-up file "image/im-zoo"
    image-insensitive file "image/ii-zoo"
&endif
    size 1 by 1.
def button bt_zoo19
    label "Zoom"
    tooltip "Zoom"
&if "{&window-system}" <> "TTY" &then
    image-up file "image/im-zoo"
    image-insensitive file "image/ii-zoo"
&endif
    size 1 by 1.
def button bt_zoo2
    label "Zoom"
    tooltip "Zoom"
&if "{&window-system}" <> "TTY" &then
    image-up file "image/im-zoo"
    image-insensitive file "image/ii-zoo"
&endif
    size 1 by 1.
def button bt_zoo3
    label "Zoom"
    tooltip "Zoom"
&if "{&window-system}" <> "TTY" &then
    image-up file "image/im-zoo"
    image-insensitive file "image/ii-zoo"
&endif
    size 1 by 1.
def button bt_zoo_fornec
    label "Zoom"
    tooltip "Zoom"
&if "{&window-system}" <> "TTY" &then
    image-up file "image/im-zoo"
    image-insensitive file "image/ii-zoo"
&endif
    size 1 by 1.
/****************************** Function Button *****************************/
def button bt_zoo_66395
    label "Zoom"
    tooltip "Zoom"
&if "{&window-system}" <> "TTY" &then
    image-up file "image/im-zoo"
    image-insensitive file "image/ii-zoo"
&endif
    size 4 by .88.
def button bt_zoo_66402
    label "Zoom"
    tooltip "Zoom"
&if "{&window-system}" <> "TTY" &then
    image-up file "image/im-zoo"
    image-insensitive file "image/ii-zoo"
&endif
    size 4 by .88.
def button bt_zoo_66405
    label "Zoom"
    tooltip "Zoom"
&if "{&window-system}" <> "TTY" &then
    image-up file "image/im-zoo"
    image-insensitive file "image/ii-zoo"
&endif
    size 4 by .88.
def button bt_zoo_66406
    label "Zoom"
    tooltip "Zoom"
&if "{&window-system}" <> "TTY" &then
    image-up file "image/im-zoo"
    image-insensitive file "image/ii-zoo"
&endif
    size 4 by .88.
def button bt_zoo_178527
    label "Zoom"
    tooltip "Zoom"
&if "{&window-system}" <> "TTY" &then
    image-up file "image/im-zoo"
    image-insensitive file "image/ii-zoo"
&endif
    size 4 by .88.
def button bt_zoo_228185
    label "Zoom"
    tooltip "Zoom"
&if "{&window-system}" <> "TTY" &then
    image-up file "image/im-zoo"
    image-insensitive file "image/ii-zoo"
&endif
    size 4 by .88.


/*************************** Button Definition End **************************/

/************************** Frame Definition Begin **************************/

def frame f_adp_02_antecip_pef_pend
    rt_mold
         at row 04.75 col 02.00
    rt_005
         at row 05.13 col 64.00 bgcolor 8 
    rt_key
         at row 01.21 col 02.00
    rt_004
         at row 11.21 col 03.00 bgcolor 8 
    rt_cxcf
         at row 16.71 col 02.00 bgcolor 7 
&IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
    antecip_pef_pend.cod_estab
         at row 01.46 col 14.14 colon-aligned label "Estab"
         view-as fill-in
         size-chars 4.14 by .88
         fgcolor ? bgcolor 15 font 2
    bt_zoo_66395
         at row 01.46 col 20.28
&ENDIF
&IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
    antecip_pef_pend.cod_estab
         at row 01.46 col 14.14 colon-aligned label "Estab"
         view-as fill-in
         size-chars 6.14 by .88
         fgcolor ? bgcolor 15 font 2
    bt_zoo_66395
         at row 01.46 col 22.28
&ENDIF
    estabelecimento.nom_pessoa
         at row 01.46 col 26.72 no-label
         view-as fill-in
         size-chars 41.14 by .88
         fgcolor ? bgcolor 15 font 2
    v_cod_fornec_infor
         at row 02.46 col 14.14 colon-aligned label "Fornecedor"
         help "Codigo, Nome Abreviado ou ID Federal do Fornecedor"
         view-as fill-in
         size-chars 21.14 by .88
         fgcolor ? bgcolor 15 font 2
    bt_zoo_fornec
         at row 02.46 col 36.14 font ?
         help "Zoom"
    fornecedor.nom_abrev
         at row 02.46 col 40.43 no-label
         view-as fill-in
         size-chars 16.14 by .88
         fgcolor ? bgcolor 15 font 2
    fornecedor.cod_pais
         at row 02.46 col 61.14 colon-aligned label "Pa°s"
         view-as fill-in
         size-chars 4.14 by .88
         fgcolor ? bgcolor 15 font 2
    bt_zoo_66402
         at row 02.46 col 67.28
    antecip_pef_pend.cod_espec_docto
         at row 03.46 col 14.14 colon-aligned label "EspÇcie"
         view-as fill-in
         size-chars 4.14 by .88
         fgcolor ? bgcolor 15 font 2
    bt_zoo_66405
         at row 03.46 col 20.28
    antecip_pef_pend.cod_ser_docto
         at row 03.46 col 38.43 colon-aligned label "SÇrie"
         view-as fill-in
         size-chars 4.14 by .88
         fgcolor ? bgcolor 15 font 2
    antecip_pef_pend.cod_tit_ap
         at row 03.46 col 61.14 colon-aligned label "T°tulo"
         view-as fill-in
         size-chars 11.14 by .88
         fgcolor ? bgcolor 15 font 2
    antecip_pef_pend.cod_parcela
         at row 03.46 col 80.86 no-label
         view-as fill-in
         size-chars 3.14 by .88
         fgcolor ? bgcolor 15 font 2
    antecip_pef_pend.cod_refer
         at row 05.13 col 14.14 colon-aligned label "Referància"
         view-as fill-in
         size-chars 11.14 by .88
         fgcolor ? bgcolor 15 font 2
    antecip_pef_pend.cod_portador
         at row 06.13 col 14.14 colon-aligned label "Portador"
         view-as fill-in
         size-chars 6.14 by .88
         fgcolor ? bgcolor 15 font 2
    bt_zoo_66406
         at row 06.13 col 22.28
    antecip_pef_pend.dat_emis_docto
         at row 07.13 col 14.14 colon-aligned label "Emiss∆o"
         view-as fill-in
         size-chars 11.14 by .88
         fgcolor ? bgcolor 15 font 2
    antecip_pef_pend.dat_vencto_tit_ap
         at row 08.13 col 14.14 colon-aligned label "Data Vencimento"
         view-as fill-in
         size-chars 11.14 by .88
         fgcolor ? bgcolor 15 font 2
    antecip_pef_pend.cod_indic_econ
         at row 05.13 col 38.43 colon-aligned label "Moeda"
         view-as fill-in
         size-chars 9.14 by .88
         fgcolor ? bgcolor 15 font 2
    bt_zoo19
         at row 05.13 col 49.86 font ?
         help "Zoom"
    antecip_pef_pend.val_cotac_indic_econ
         at row 06.13 col 38.43 colon-aligned label "Cotaá∆o"
         view-as fill-in
         size-chars 20.14 by .88
         fgcolor ? bgcolor 15 font 2
    v_val_cotac_indic_econ_inv
         at row 07.13 col 38.43 colon-aligned label "Cotaá. Inv."
         help "Valor Cotaá∆o Indic Econìmico"
         view-as fill-in
         size-chars 20.14 by .88
         fgcolor ? bgcolor 15 font 2
    antecip_pef_pend.val_tit_ap
         at row 08.13 col 38.43 colon-aligned label "Valor T°tulo"
         view-as fill-in
         size-chars 16.14 by .88
         fgcolor ? bgcolor 15 font 2
    v_ind_modo_pagto
         at row 09.13 col 38.43 colon-aligned label "Modo Pagto"
         help "Modo de Pagamento"
         view-as combo-box
         &if "{&FNC_MULTI_IDIOMA}" = "YES" &then
         list-item-pairs "Cheque","Cheque","Borderì","Borderì","Escritural","Escritural","Dinheiro","Dinheiro","",""
         &else
         list-items "Cheque","Borderì","Escritural","Dinheiro",""
         &endif
          /*l_cheque*/ /*l_bordero*/ /*l_escritural*/ /*l_dinheiro*/ /*l_null*/
         inner-lines 6
         bgcolor 15 font 2
    antecip_pef_pend.cod_forma_pagto
         at row 10.13 col 38.43 colon-aligned label "Forma Pagamento"
         view-as fill-in
         size-chars 4.14 by .88
         fgcolor ? bgcolor 15 font 2
    bt_zoo_228185
         at row 10.13 col 44.57
    v_num_ped_compra
         at row 05.50 col 70.57 colon-aligned label "Pedido"
         help "N£mero do Pedido de Compra"
         view-as fill-in
         size-chars 10.14 by .88
         fgcolor ? bgcolor 15 font 2
    bt_zoo
         at row 05.50 col 83.00 font ?
         help "Zoom"
    v_num_ord_compra
         at row 06.50 col 70.57 colon-aligned label "Ordem"
         help "Ordem Compra de Integraá∆o com EMS2"
         view-as fill-in
         size-chars 10.14 by .88
         fgcolor ? bgcolor 15 font 2
    bt_zoo2
         at row 06.50 col 83.00 font ?
         help "Zoom"
    v_num_event
         at row 07.50 col 70.57 colon-aligned label "Evento"
         help "N£mero Evento de Integraá∆o EMS2"
         view-as fill-in
         size-chars 5.14 by .88
         fgcolor ? bgcolor 15 font 2
    bt_zoo3
         at row 07.50 col 78.00 font ?
         help "Zoom"
    v_cod_safra_graos
         at row 09.13 col 64.00 colon-aligned label "Safra"
         help "Safra"
         view-as fill-in
         size-chars 10.14 by .88
         fgcolor ? bgcolor 15 font 2
    v_cod_contrat_graos
         at row 10.13 col 64.00 colon-aligned label "Contrato Gr∆os"
         help "C¢digo do Contrato de Gr∆os"
         view-as fill-in
         size-chars 21.14 by .88
         fgcolor ? bgcolor 15 font 2
    antecip_pef_pend.num_talon_cheq
         at row 12.46 col 14.00 colon-aligned label "Talon†rio"
         view-as fill-in
         size-chars 12.14 by .88
         fgcolor ? bgcolor 15 font 2
    bt_zoo_178527
         at row 12.46 col 28.14
    antecip_pef_pend.num_cheque
         at row 11.46 col 14.00 colon-aligned label "Num Cheque"
         view-as fill-in
         size-chars 13.14 by .88
         fgcolor ? bgcolor 15 font 2
    antecip_pef_pend.ind_favorec_cheq
         at row 11.46 col 38.29 colon-aligned label "Favorecido"
         view-as combo-box
         &if "{&FNC_MULTI_IDIOMA}" = "YES" &then
         list-item-pairs "","","Portador","Portador","Fornecedor","Fornecedor","Transferància","Transferància","Outros","Outros","Cod Fornecedor","Cod Fornecedor"
         &else
         list-items "","Portador","Fornecedor","Transferància","Outros","Cod Fornecedor"
         &endif
          /*l_null*/ /*l_portador*/ /*l_fornecedor*/ /*l_transferencia*/ /*l_outros*/ /*l_cod_fornec*/
         inner-lines 6
         bgcolor 15 font 2
    antecip_pef_pend.nom_favorec_cheq
         at row 12.46 col 40.29 no-label
         view-as fill-in
         size-chars 41.14 by .88
         fgcolor ? bgcolor 15 font 2
    bt_rat_val
         at row 14.25 col 01.86 font ?
         help "Rateio Valor"
    bt_abat_prev
         at row 14.25 col 13.86 font ?
         help "Abatimento Previs∆o"
    bt_histor_padr
         at row 14.25 col 25.86 font ?
         help "Hist¢rico Padr∆o"
    bt_impto_retido2
         at row 14.25 col 38.00 font ?
         help "Imposto Retido"
    bt_vinc_imp_fornec2
         at row 14.25 col 46.86 font ?
    bt_impto_taxado
         at row 14.25 col 50.86 font ?
         help "Impostos Taxados"
    bt_segur_leas
         at row 14.25 col 64.00 font ?
         help "Seguro/Leasing"
    bt_ordem_compra
         at row 14.25 col 77.14 font ?
         help "Vincula ordens de compra"
    bt_cod_barra
         at row 15.54 col 01.86 font ?
         help "Informa C¢digo de Barras"
    bt_impto_val_agreg
         at row 15.54 col 14.00 font ?
         help "Imposto Valor Agregado"
    bt_ok
         at row 16.92 col 03.00 font ?
         help "OK"
    bt_sav
         at row 16.92 col 14.00 font ?
         help "Salva"
    bt_can
         at row 16.92 col 25.00 font ?
         help "Cancela"
    bt_cop
         at row 16.92 col 38.00 font ?
         help "Copia"
    bt_hel2
         at row 16.92 col 77.57 font ?
         help "Ajuda"
&if "{&window-system}" <> "TTY" &then
    im_cta_corren
         at row 09.08 col 78.57
&endif
    v_cod_forma_pagto_equador
         at row 09.13 col 63.00 colon-aligned label "FP ATS"
         view-as combo-box
         &if "{&FNC_MULTI_IDIOMA}" = "YES" &then
         list-item-pairs "01-Sem sist fin","01-Sem sist fin","02-Cheque pr¢p","02-Cheque pr¢p","03-Cheque adm","03-Cheque adm","04-Cheq geren","04-Cheq geren","05-Cheq do ext","05-Cheq do ext","06-DÇbito em cta","06-DÇbito em cta","07-Trf msm bco","07-Trf msm bco","08-Trf outro bco","08-Trf outro bco","09-Trf bco ext","09-Trf bco ext","10-Cart crÇd nac","10-Cart crÇd nac","11-Cart crÇd int","11-Cart crÇd int","12-Cheque bcio","12-Cheque bcio","13-Dep¢sito","13-Dep¢sito","14-Endosso Invest","14-Endosso Invest","15-Compens d°vida","15-Compens d°vida"
         &else
         list-items "01-Sem sist fin","02-Cheque pr¢p","03-Cheque adm","04-Cheq geren","05-Cheq do ext","06-DÇbito em cta","07-Trf msm bco","08-Trf outro bco","09-Trf bco ext","10-Cart crÇd nac","11-Cart crÇd int","12-Cheque bcio","13-Dep¢sito","14-Endosso Invest","15-Compens d°vida"
         &endif
          /*l_01sem_sist_fin*/ /*l_02cheque_prop*/ /*l_03cheque_adm*/ /*l_04cheq_geren*/ /*l_05cheq_do_ext*/ /*l_06debito_em_cta*/ /*l_07trf_msm_bco*/ /*l_08trf_outro_bco*/ /*l_09trf_bco_ext*/ /*l_10cart_cred_nac*/ /*l_11cart_cred_int*/ /*l_12cheque_bcio*/ /*l_13deposito*/ /*l_14endosso_invest*/ /*l_15compens_divida*/
         inner-lines 14
         bgcolor 15 font 2
    with 1 down side-labels no-validate keep-tab-order three-d
         size-char 90.00 by 18.54 default-button bt_sav
         view-as dialog-box
         font 1 fgcolor ? bgcolor 8
         title "Inclui Antecipaá∆o Pendente - Base".
    /* adjust size of objects in this frame */
    assign bt_abat_prev:width-chars         in frame f_adp_02_antecip_pef_pend = 12.00
           bt_abat_prev:height-chars        in frame f_adp_02_antecip_pef_pend = 01.00
           bt_can:width-chars               in frame f_adp_02_antecip_pef_pend = 10.00
           bt_can:height-chars              in frame f_adp_02_antecip_pef_pend = 01.00
           bt_cod_barra:width-chars         in frame f_adp_02_antecip_pef_pend = 12.00
           bt_cod_barra:height-chars        in frame f_adp_02_antecip_pef_pend = 01.00
           bt_cop:width-chars               in frame f_adp_02_antecip_pef_pend = 04.00
           bt_cop:height-chars              in frame f_adp_02_antecip_pef_pend = 01.00
           bt_hel2:width-chars              in frame f_adp_02_antecip_pef_pend = 10.00
           bt_hel2:height-chars             in frame f_adp_02_antecip_pef_pend = 01.00
           bt_histor_padr:width-chars       in frame f_adp_02_antecip_pef_pend = 12.00
           bt_histor_padr:height-chars      in frame f_adp_02_antecip_pef_pend = 01.00
           bt_impto_retido2:width-chars     in frame f_adp_02_antecip_pef_pend = 09.00
           bt_impto_retido2:height-chars    in frame f_adp_02_antecip_pef_pend = 01.00
           bt_impto_taxado:width-chars      in frame f_adp_02_antecip_pef_pend = 13.00
           bt_impto_taxado:height-chars     in frame f_adp_02_antecip_pef_pend = 01.00
           bt_impto_val_agreg:width-chars   in frame f_adp_02_antecip_pef_pend = 12.00
           bt_impto_val_agreg:height-chars  in frame f_adp_02_antecip_pef_pend = 01.00
           bt_ok:width-chars                in frame f_adp_02_antecip_pef_pend = 10.00
           bt_ok:height-chars               in frame f_adp_02_antecip_pef_pend = 01.00
           bt_ordem_compra:width-chars      in frame f_adp_02_antecip_pef_pend = 11.57
           bt_ordem_compra:height-chars     in frame f_adp_02_antecip_pef_pend = 01.00
           bt_rat_val:width-chars           in frame f_adp_02_antecip_pef_pend = 12.00
           bt_rat_val:height-chars          in frame f_adp_02_antecip_pef_pend = 01.00
           bt_sav:width-chars               in frame f_adp_02_antecip_pef_pend = 10.00
           bt_sav:height-chars              in frame f_adp_02_antecip_pef_pend = 01.00
           bt_segur_leas:width-chars        in frame f_adp_02_antecip_pef_pend = 13.00
           bt_segur_leas:height-chars       in frame f_adp_02_antecip_pef_pend = 01.00
           bt_vinc_imp_fornec2:width-chars  in frame f_adp_02_antecip_pef_pend = 04.00
           bt_vinc_imp_fornec2:height-chars in frame f_adp_02_antecip_pef_pend = 01.00
           bt_zoo:width-chars               in frame f_adp_02_antecip_pef_pend = 04.00
           bt_zoo:height-chars              in frame f_adp_02_antecip_pef_pend = 00.88
           bt_zoo19:width-chars             in frame f_adp_02_antecip_pef_pend = 04.00
           bt_zoo19:height-chars            in frame f_adp_02_antecip_pef_pend = 00.88
           bt_zoo2:width-chars              in frame f_adp_02_antecip_pef_pend = 04.00
           bt_zoo2:height-chars             in frame f_adp_02_antecip_pef_pend = 00.88
           bt_zoo3:width-chars              in frame f_adp_02_antecip_pef_pend = 04.00
           bt_zoo3:height-chars             in frame f_adp_02_antecip_pef_pend = 00.88
           bt_zoo_fornec:width-chars        in frame f_adp_02_antecip_pef_pend = 04.00
           bt_zoo_fornec:height-chars       in frame f_adp_02_antecip_pef_pend = 00.88
&if "{&window-system}" <> "TTY" &then
           im_cta_corren:width-chars        in frame f_adp_02_antecip_pef_pend = 08.00
           im_cta_corren:height-chars       in frame f_adp_02_antecip_pef_pend = 02.00
&endif
           rt_004:width-chars               in frame f_adp_02_antecip_pef_pend = 84.86
           rt_004:height-chars              in frame f_adp_02_antecip_pef_pend = 02.46
           rt_005:width-chars               in frame f_adp_02_antecip_pef_pend = 23.72
           rt_005:height-chars              in frame f_adp_02_antecip_pef_pend = 03.58
           rt_cxcf:width-chars              in frame f_adp_02_antecip_pef_pend = 86.57
           rt_cxcf:height-chars             in frame f_adp_02_antecip_pef_pend = 01.42
           rt_key:width-chars               in frame f_adp_02_antecip_pef_pend = 86.57
           rt_key:height-chars              in frame f_adp_02_antecip_pef_pend = 03.42
           rt_mold:width-chars              in frame f_adp_02_antecip_pef_pend = 86.57
           rt_mold:height-chars             in frame f_adp_02_antecip_pef_pend = 09.21.
    /* set private-data for the help system */
    assign bt_zoo_66395:private-data                          in frame f_adp_02_antecip_pef_pend = "HLP=000009431":U
           bt_zoo_66395:private-data                          in frame f_adp_02_antecip_pef_pend = "HLP=000009431":U
           antecip_pef_pend.cod_estab:private-data            in frame f_adp_02_antecip_pef_pend = "HLP=000025561":U
           estabelecimento.nom_pessoa:private-data            in frame f_adp_02_antecip_pef_pend = "HLP=000025116":U
           v_cod_fornec_infor:private-data                    in frame f_adp_02_antecip_pef_pend = "HLP=000025562":U
           bt_zoo_fornec:private-data                         in frame f_adp_02_antecip_pef_pend = "HLP=000013138":U
           fornecedor.nom_abrev:private-data                  in frame f_adp_02_antecip_pef_pend = "HLP=000012616":U
           bt_zoo_66402:private-data                          in frame f_adp_02_antecip_pef_pend = "HLP=000009431":U
           fornecedor.cod_pais:private-data                   in frame f_adp_02_antecip_pef_pend = "HLP=000014281":U
           bt_zoo_66405:private-data                          in frame f_adp_02_antecip_pef_pend = "HLP=000009431":U
           antecip_pef_pend.cod_espec_docto:private-data      in frame f_adp_02_antecip_pef_pend = "HLP=000010729":U
           antecip_pef_pend.cod_ser_docto:private-data        in frame f_adp_02_antecip_pef_pend = "HLP=000010734":U
           antecip_pef_pend.cod_tit_ap:private-data           in frame f_adp_02_antecip_pef_pend = "HLP=000010735":U
           antecip_pef_pend.cod_parcela:private-data          in frame f_adp_02_antecip_pef_pend = "HLP=000010741":U
           antecip_pef_pend.cod_refer:private-data            in frame f_adp_02_antecip_pef_pend = "HLP=000025560":U
           bt_zoo_66406:private-data                          in frame f_adp_02_antecip_pef_pend = "HLP=000009431":U
           antecip_pef_pend.cod_portador:private-data         in frame f_adp_02_antecip_pef_pend = "HLP=000010732":U
           antecip_pef_pend.dat_emis_docto:private-data       in frame f_adp_02_antecip_pef_pend = "HLP=000025563":U
           antecip_pef_pend.dat_vencto_tit_ap:private-data    in frame f_adp_02_antecip_pef_pend = "HLP=000022749":U
           antecip_pef_pend.cod_indic_econ:private-data       in frame f_adp_02_antecip_pef_pend = "HLP=000025565":U
           bt_zoo19:private-data                              in frame f_adp_02_antecip_pef_pend = "HLP=000022162":U
           antecip_pef_pend.val_cotac_indic_econ:private-data in frame f_adp_02_antecip_pef_pend = "HLP=000022841":U
           v_val_cotac_indic_econ_inv:private-data            in frame f_adp_02_antecip_pef_pend = "HLP=000010728":U
           antecip_pef_pend.val_tit_ap:private-data           in frame f_adp_02_antecip_pef_pend = "HLP=000025566":U
           v_ind_modo_pagto:private-data                      in frame f_adp_02_antecip_pef_pend = "HLP=000013373":U
           bt_zoo_228185:private-data                         in frame f_adp_02_antecip_pef_pend = "HLP=000009431":U
           antecip_pef_pend.cod_forma_pagto:private-data      in frame f_adp_02_antecip_pef_pend = "HLP=000012531":U
           v_num_ped_compra:private-data                      in frame f_adp_02_antecip_pef_pend = "HLP=000010728":U
           bt_zoo:private-data                                in frame f_adp_02_antecip_pef_pend = "HLP=000009431":U
           v_num_ord_compra:private-data                      in frame f_adp_02_antecip_pef_pend = "HLP=000010728":U
           bt_zoo2:private-data                               in frame f_adp_02_antecip_pef_pend = "HLP=000009432":U
           v_num_event:private-data                           in frame f_adp_02_antecip_pef_pend = "HLP=000010728":U
           bt_zoo3:private-data                               in frame f_adp_02_antecip_pef_pend = "HLP=000009433":U
           v_cod_safra_graos:private-data                     in frame f_adp_02_antecip_pef_pend = "HLP=000010728":U
           bt_zoo_178527:private-data                         in frame f_adp_02_antecip_pef_pend = "HLP=000009431":U
           antecip_pef_pend.num_talon_cheq:private-data       in frame f_adp_02_antecip_pef_pend = "HLP=000018398":U
           antecip_pef_pend.num_cheque:private-data           in frame f_adp_02_antecip_pef_pend = "HLP=000010740":U
           antecip_pef_pend.ind_favorec_cheq:private-data     in frame f_adp_02_antecip_pef_pend = "HLP=000010737":U
           antecip_pef_pend.nom_favorec_cheq:private-data     in frame f_adp_02_antecip_pef_pend = "HLP=000010739":U
           bt_rat_val:private-data                            in frame f_adp_02_antecip_pef_pend = "HLP=000010592":U
           bt_abat_prev:private-data                          in frame f_adp_02_antecip_pef_pend = "HLP=000010585":U
           bt_histor_padr:private-data                        in frame f_adp_02_antecip_pef_pend = "HLP=000010586":U
           bt_impto_retido2:private-data                      in frame f_adp_02_antecip_pef_pend = "HLP=000010728":U
           bt_vinc_imp_fornec2:private-data                   in frame f_adp_02_antecip_pef_pend = "HLP=000010728":U
           bt_impto_taxado:private-data                       in frame f_adp_02_antecip_pef_pend = "HLP=000011264":U
           bt_segur_leas:private-data                         in frame f_adp_02_antecip_pef_pend = "HLP=000010593":U
           bt_ordem_compra:private-data                       in frame f_adp_02_antecip_pef_pend = "HLP=000010728":U
           bt_cod_barra:private-data                          in frame f_adp_02_antecip_pef_pend = "HLP=000021528":U
           bt_impto_val_agreg:private-data                    in frame f_adp_02_antecip_pef_pend = "HLP=000015556":U
           bt_ok:private-data                                 in frame f_adp_02_antecip_pef_pend = "HLP=000010721":U
           bt_sav:private-data                                in frame f_adp_02_antecip_pef_pend = "HLP=000011048":U
           bt_can:private-data                                in frame f_adp_02_antecip_pef_pend = "HLP=000011050":U
           bt_cop:private-data                                in frame f_adp_02_antecip_pef_pend = "HLP=000010834":U
           bt_hel2:private-data                               in frame f_adp_02_antecip_pef_pend = "HLP=000011326":U
&if "{&window-system}" <> "TTY" &then
           im_cta_corren:private-data                         in frame f_adp_02_antecip_pef_pend = "HLP=000010728":U
&endif
           v_cod_forma_pagto_equador:private-data             in frame f_adp_02_antecip_pef_pend = "HLP=000010728":U
           frame f_adp_02_antecip_pef_pend:private-data                                          = "HLP=000010728".
    /* enable function buttons */
    assign bt_zoo_66395:sensitive  in frame f_adp_02_antecip_pef_pend = yes
           bt_zoo_66395:sensitive  in frame f_adp_02_antecip_pef_pend = yes
           bt_zoo_66402:sensitive  in frame f_adp_02_antecip_pef_pend = yes
           bt_zoo_66405:sensitive  in frame f_adp_02_antecip_pef_pend = yes
           bt_zoo_66406:sensitive  in frame f_adp_02_antecip_pef_pend = yes
           bt_zoo_228185:sensitive in frame f_adp_02_antecip_pef_pend = yes
           bt_zoo_178527:sensitive in frame f_adp_02_antecip_pef_pend = yes.
    /* move buttons to top */
    bt_zoo_66395:move-to-top().
    bt_zoo_66395:move-to-top().
    bt_zoo_66402:move-to-top().
    bt_zoo_66405:move-to-top().
    bt_zoo_66406:move-to-top().
    bt_zoo_228185:move-to-top().
    bt_zoo_178527:move-to-top().

def frame f_dlg_01_fornecedor_id_feder
    rt_mold
         at row 01.21 col 02.00
    rt_cxcf
         at row 06.08 col 02.00 bgcolor 7 
    br_fornecedor_id_feder
         at row 01.21 col 02.00
    bt_ok
         at row 06.29 col 03.00 font ?
         help "OK"
    bt_can
         at row 06.29 col 14.00 font ?
         help "Cancela"
    bt_hel2
         at row 06.29 col 43.29 font ?
         help "Ajuda"
    with 1 down side-labels no-validate keep-tab-order three-d
         size-char 55.72 by 07.92 default-button bt_ok
         view-as dialog-box
         font 1 fgcolor ? bgcolor 8
         title "Fornecedor".
    /* adjust size of objects in this frame */
    assign bt_can:width-chars   in frame f_dlg_01_fornecedor_id_feder = 10.00
           bt_can:height-chars  in frame f_dlg_01_fornecedor_id_feder = 01.00
           bt_hel2:width-chars  in frame f_dlg_01_fornecedor_id_feder = 10.00
           bt_hel2:height-chars in frame f_dlg_01_fornecedor_id_feder = 01.00
           bt_ok:width-chars    in frame f_dlg_01_fornecedor_id_feder = 10.00
           bt_ok:height-chars   in frame f_dlg_01_fornecedor_id_feder = 01.00
           rt_cxcf:width-chars  in frame f_dlg_01_fornecedor_id_feder = 52.29
           rt_cxcf:height-chars in frame f_dlg_01_fornecedor_id_feder = 01.42
           rt_mold:width-chars  in frame f_dlg_01_fornecedor_id_feder = 52.29
           rt_mold:height-chars in frame f_dlg_01_fornecedor_id_feder = 04.50.
&if '{&emsbas_version}' >= '5.06' &then
if OPSYS = 'WIN32':U then do:
assign br_fornecedor_id_feder:ALLOW-COLUMN-SEARCHING in frame f_dlg_01_fornecedor_id_feder = no
       br_fornecedor_id_feder:COLUMN-MOVABLE in frame f_dlg_01_fornecedor_id_feder = no.
end.
&endif
    /* set private-data for the help system */
    assign br_fornecedor_id_feder:private-data in frame f_dlg_01_fornecedor_id_feder = "HLP=000023469":U
           bt_ok:private-data                  in frame f_dlg_01_fornecedor_id_feder = "HLP=000010721":U
           bt_can:private-data                 in frame f_dlg_01_fornecedor_id_feder = "HLP=000011050":U
           bt_hel2:private-data                in frame f_dlg_01_fornecedor_id_feder = "HLP=000011326":U
           frame f_dlg_01_fornecedor_id_feder:private-data                           = "HLP=000023469".



{include/i_fclfrm.i f_adp_02_antecip_pef_pend f_dlg_01_fornecedor_id_feder }
/*************************** Frame Definition End ***************************/

/*********************** User Interface Trigger Begin ***********************/


ON CHOOSE OF bt_abat_prev IN FRAME f_adp_02_antecip_pef_pend
DO:

    run pi_save_key /*pi_save_key*/.
    abatimento:
    do on error undo abatimento, return no-apply:
        run pi_executar_abat_prev_provis_apb_antecip (Input "Previs∆o" /*l_previsao*/) /*pi_executar_abat_prev_provis_apb_antecip*/.
        run pi_verifica_relacoes_antecip_pef_pend.
    end.
END. /* ON CHOOSE OF bt_abat_prev IN FRAME f_adp_02_antecip_pef_pend */

ON CHOOSE OF bt_can IN FRAME f_adp_02_antecip_pef_pend
DO:

    IF VALID-HANDLE(v_hdl_funcao_mex) THEN
       DELETE PROCEDURE v_hdl_funcao_mex.

    if  v_cod_pais_empres_usuar = "BRA" /*l_bra*/  then
        run pi_elimina_docum_est_esoc_impl_antecip.

    apply "end-error" to self.
END. /* ON CHOOSE OF bt_can IN FRAME f_adp_02_antecip_pef_pend */

ON CHOOSE OF bt_cod_barra IN FRAME f_adp_02_antecip_pef_pend
DO:

    run pi_choose_bt_cod_barra_antecip /*pi_choose_bt_cod_barra_antecip*/.
END. /* ON CHOOSE OF bt_cod_barra IN FRAME f_adp_02_antecip_pef_pend */

ON CHOOSE OF bt_cop IN FRAME f_adp_02_antecip_pef_pend
DO:

    run pi_bt_cop_add_antecip_pef_pend /*pi_bt_cop_add_antecip_pef_pend*/.
END. /* ON CHOOSE OF bt_cop IN FRAME f_adp_02_antecip_pef_pend */

ON CHOOSE OF bt_hel2 IN FRAME f_adp_02_antecip_pef_pend
DO:


    /* Begin_Include: i_context_help_frame */
    run prgtec/men/men900za.py (Input self:frame,
                                Input this-procedure:handle) /*prg_fnc_chamar_help_context*/.


    /* End_Include: i_context_help_frame */

END. /* ON CHOOSE OF bt_hel2 IN FRAME f_adp_02_antecip_pef_pend */

ON CHOOSE OF bt_histor_padr IN FRAME f_adp_02_antecip_pef_pend
DO:

    run pi_executa_histor_padr_antecip_apb.
END. /* ON CHOOSE OF bt_histor_padr IN FRAME f_adp_02_antecip_pef_pend */

ON CHOOSE OF bt_impto_retido2 IN FRAME f_adp_02_antecip_pef_pend
DO:

    do on error undo, return no-apply:
        run pi_antecip_pef_pend_impto_retido_taxado (Input "Retido" /*l_retido*/) /*pi_antecip_pef_pend_impto_retido_taxado*/.
    end.
END. /* ON CHOOSE OF bt_impto_retido2 IN FRAME f_adp_02_antecip_pef_pend */

ON CHOOSE OF bt_impto_taxado IN FRAME f_adp_02_antecip_pef_pend
DO:

    do on error undo, return no-apply:
        run pi_antecip_pef_pend_impto_retido_taxado (Input "Taxado" /*l_taxado*/) /*pi_antecip_pef_pend_impto_retido_taxado*/.
    end.
END. /* ON CHOOSE OF bt_impto_taxado IN FRAME f_adp_02_antecip_pef_pend */

ON CHOOSE OF bt_impto_val_agreg IN FRAME f_adp_02_antecip_pef_pend
DO:

    do on error undo, return no-apply:
        run pi_antecip_pef_pend_impto_retido_taxado (Input "IVA" /*l_iva*/) /*pi_antecip_pef_pend_impto_retido_taxado*/.
    end.

END. /* ON CHOOSE OF bt_impto_val_agreg IN FRAME f_adp_02_antecip_pef_pend */

ON CHOOSE OF bt_ok IN FRAME f_adp_02_antecip_pef_pend
DO:

    find b_antecip_pef_pend_add no-lock
        where b_antecip_pef_pend_add.cod_estab = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab
          and b_antecip_pef_pend_add.cod_refer = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_refer no-error.

    if  avail b_antecip_pef_pend_add
        then do:

        if  recid(b_antecip_pef_pend_add) <> recid(antecip_pef_pend)
            then do:


             /* &1 j† existente ! */
             run pi_messages (input "show" /*l_show*/ ,
                              input 18164,
                              input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                 "Antecipaá∆o e PEF Pendente" /*l_antecipaá∆oepefpendente*/ ,
                                                 input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab ,            
                                                 input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_refer)) /* msg_1*/.
             return NO-APPLY.                    
        end /* if */.
    END.

    assign v_log_repeat = no.

    find estabelecimento no-lock
        where estabelecimento.cod_estab = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab no-error.

    if avail estabelecimento 
    and estabelecimento.cod_empresa <> v_cod_empres_usuar then do:

        run pi_messages (input "show" /*l_show*/  ,
                         input 18305,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                            input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab ,
                                            estabelecimento.cod_empresa ,            
                                            v_cod_empres_usuar)) /* msg_18305*/.
         enable antecip_pef_pend.cod_estab
                bt_zoo_66395
                with frame f_adp_02_antecip_pef_pend.

         apply 'entry' TO antecip_pef_pend.cod_estab in frame f_adp_02_antecip_pef_pend.

         return no-apply.
    end.

    /* ix_g20_add_antecip_pef_pend */
END. /* ON CHOOSE OF bt_ok IN FRAME f_adp_02_antecip_pef_pend */

ON CHOOSE OF bt_ordem_compra IN FRAME f_adp_02_antecip_pef_pend
DO:

    run pi_on_choose_bt_ordem_compra_antecip /*pi_on_choose_bt_ordem_compra_antecip*/.
    if return-value = "NOK" /*l_nok*/  then
        return no-apply.
END. /* ON CHOOSE OF bt_ordem_compra IN FRAME f_adp_02_antecip_pef_pend */

ON CHOOSE OF bt_rat_val IN FRAME f_adp_02_antecip_pef_pend
DO:

    bloco:
    do on error undo, return no-apply:
       run pi_bt_rat_val_antecip_pef_pend /*pi_bt_rat_val_antecip_pef_pend*/.   
    end.

    /* Begin_Include: i_executa_pi_epc_fin */
    run pi_exec_program_epc_FIN (Input 'VALIDA_FORMA_PAGTO',
                                 Input 'yes',
                                 output v_log_return_epc) /*pi_exec_program_epc_FIN*/.
    if v_log_return_epc then /* epc retornou erro*/
        undo, retry.
    /* End_Include: i_executa_pi_epc_fin */


    /* eSocial - Iteraá∆o 01*/
    if  v_cod_pais_empres_usuar = "BRA" /*l_bra*/  then
        run pi_desabilita_campos_antecip_esocial_add.
END. /* ON CHOOSE OF bt_rat_val IN FRAME f_adp_02_antecip_pef_pend */

ON CHOOSE OF bt_sav IN FRAME f_adp_02_antecip_pef_pend
DO:

    find b_antecip_pef_pend_add no-lock
        where b_antecip_pef_pend_add.cod_estab = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab
          and b_antecip_pef_pend_add.cod_refer = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_refer no-error.

    if  avail b_antecip_pef_pend_add
        then do:

        if  recid(b_antecip_pef_pend_add) <> recid(antecip_pef_pend)
            then do:


             /* &1 j† existente ! */
             run pi_messages (input "show" /*l_show*/ ,
                              input 18164,
                              input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                 "Antecipaá∆o e PEF Pendente" /*l_antecipaá∆oepefpendente*/ ,
                                                 input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab ,            
                                                 input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_refer)) /* msg_1*/.
             return NO-APPLY.                    
        end /* if */.
    END.

    assign v_log_repeat = yes.
    /* ix_g30_add_antecip_pef_pend */

    find estabelecimento no-lock
           where estabelecimento.cod_estab = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab no-error.
    if avail estabelecimento
    and estabelecimento.cod_empresa <> v_cod_empres_usuar then do:

        run pi_messages (input "show" /*l_show*/  ,
                         input 18305,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                         input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab ,
                               estabelecimento.cod_empresa ,            
                               v_cod_empres_usuar)) /* msg_18305*/.
        enable antecip_pef_pend.cod_estab
               bt_zoo_66395
               with frame f_adp_02_antecip_pef_pend.

        apply 'entry' to antecip_pef_pend.cod_estab in frame f_adp_02_antecip_pef_pend.
        return no-apply.

    end.
    assign v_log_repeat = yes.


END. /* ON CHOOSE OF bt_sav IN FRAME f_adp_02_antecip_pef_pend */

ON CHOOSE OF bt_segur_leas IN FRAME f_adp_02_antecip_pef_pend
DO:

    ASSIGN v_wgh_current_button = bt_segur_leas:HANDLE IN FRAME f_adp_02_antecip_pef_pend.
    run pi_choose_antecip_pef_pend /*pi_choose_antecip_pef_pend*/.
END. /* ON CHOOSE OF bt_segur_leas IN FRAME f_adp_02_antecip_pef_pend */

ON CHOOSE OF bt_vinc_imp_fornec2 IN FRAME f_adp_02_antecip_pef_pend
DO:

    run pi_bt_vinc_imp_fornec2_adp_antecip_pef_pend /*pi_bt_vinc_imp_fornec2_adp_antecip_pef_pend*/.

END. /* ON CHOOSE OF bt_vinc_imp_fornec2 IN FRAME f_adp_02_antecip_pef_pend */

ON CHOOSE OF bt_zoo IN FRAME f_adp_02_antecip_pef_pend
DO:

    /* Zoom de Atributo sem referencia para o usuario */
    run pi_bt_zoo_ord_compra_ped_fornec (Input antecip_pef_pend.cod_estab:screen-value in frame f_adp_02_antecip_pef_pend) /*pi_bt_zoo_ord_compra_ped_fornec*/.
END. /* ON CHOOSE OF bt_zoo IN FRAME f_adp_02_antecip_pef_pend */

ON CHOOSE OF bt_zoo19 IN FRAME f_adp_02_antecip_pef_pend
DO:

    if  search('prgint/utb/utb013ne.r') = ? and search('prgint/utb/utb013ne.p') = ? then do:
        if  v_cod_dwb_user begins 'es_' then
            return 'Programa execut†vel n∆o foi encontrado:' /* l_programa_nao_encontrado*/  + 'prgint/utb/utb013ne.p'.
        else do:
            message getStrTrans("Programa execut†vel n∆o foi encontrado:", "APB") /* l_programa_nao_encontrado*/  "prgint/utb/utb013ne.p"
                   view-as alert-box error buttons ok.
            return.
        end.
    end.
    else
        run prgint/utb/utb013ne.p /* prg_see_indic_econ_fasb*/.
    if  v_rec_indic_econ <> ?
    then do:
        find indic_econ where recid(indic_econ) = v_rec_indic_econ no-lock no-error.
        assign antecip_pef_pend.cod_indic_econ:screen-value in frame f_adp_02_antecip_pef_pend =
                string(indic_econ.cod_indic_econ).
        apply 'leave' to antecip_pef_pend.cod_indic_econ in frame f_adp_02_antecip_pef_pend.
    end /* if */.

END. /* ON CHOOSE OF bt_zoo19 IN FRAME f_adp_02_antecip_pef_pend */

ON CHOOSE OF bt_zoo2 IN FRAME f_adp_02_antecip_pef_pend
DO:

    /* Zoom de Atributo sem referencia para o usuario */
    run pi_bt_zoo_ord_compra_ped_fornec (Input antecip_pef_pend.cod_estab:screen-value in frame f_adp_02_antecip_pef_pend) /*pi_bt_zoo_ord_compra_ped_fornec*/.
END. /* ON CHOOSE OF bt_zoo2 IN FRAME f_adp_02_antecip_pef_pend */

ON CHOOSE OF bt_zoo3 IN FRAME f_adp_02_antecip_pef_pend
DO:

    /* Zoom de Atributo sem referencia para o usuario */
    run pi_bt_zoo3_add_antecip_pef_pend /*pi_bt_zoo3_add_antecip_pef_pend*/.
END. /* ON CHOOSE OF bt_zoo3 IN FRAME f_adp_02_antecip_pef_pend */

ON CHOOSE OF bt_zoo_fornec IN FRAME f_adp_02_antecip_pef_pend
DO:


    /* Begin_Include: i_zoom_fornecedor */
    assign v_rec_fornecedor = ?.
    if  search("prgint/ufn/ufn003nb.r") = ? and search("prgint/ufn/ufn003nb.p") = ? then do:
        if  v_cod_dwb_user begins 'es_' then
            return "Programa execut†vel n∆o foi encontrado:" /*l_programa_nao_encontrado*/  + "prgint/ufn/ufn003nb.p".
        else do:
            message getStrTrans("Programa execut†vel n∆o foi encontrado:", "APB") /*l_programa_nao_encontrado*/  "prgint/ufn/ufn003nb.p"
                   view-as alert-box error buttons ok.
            return.
        end.
    end.
    else
        run prgint/ufn/ufn003nb.p (Input v_cod_empres_usuar_2) /*prg_see_fornecedor_financ_empresa*/.

    if  v_rec_fornecedor <> ?
    then do:
        find fornecedor where recid(fornecedor) = v_rec_fornecedor no-lock no-error.
        if  avail fornecedor
        then do:
            assign v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend = string(fornecedor.cdn_fornecedor).
            display fornecedor.nom_abrev
                    fornecedor.cod_pais
                    with frame f_adp_02_antecip_pef_pend.
        end /* if */.
    end /* if */.

    /* End_Include: i_zoom_fornecedor */

    apply "leave" to v_cod_fornec_infor in frame f_adp_02_antecip_pef_pend.

END. /* ON CHOOSE OF bt_zoo_fornec IN FRAME f_adp_02_antecip_pef_pend */

&if "{&window-system}" <> "TTY" &then
&endif

ON LEAVE OF v_cod_fornec_infor IN FRAME f_adp_02_antecip_pef_pend
DO:

    run pi_leave_v_cod_fornec_infor_antecip_pef_pend_add /*pi_leave_v_cod_fornec_infor_antecip_pef_pend_add*/.


    /* Begin_Include: i_executa_pi_epc_fin */
    run pi_exec_program_epc_FIN (Input 'CRIA_APROPRIAC',
                                 Input 'no',
                                 output v_log_return_epc) /*pi_exec_program_epc_FIN*/.
    if v_log_return_epc then /* epc retornou erro*/
        undo, retry.
    /* End_Include: i_executa_pi_epc_fin */

END. /* ON LEAVE OF v_cod_fornec_infor IN FRAME f_adp_02_antecip_pef_pend */

ON ENTRY OF v_cod_safra_graos IN FRAME f_adp_02_antecip_pef_pend
DO:

    if v_cod_safra_graos:screen-value in frame f_adp_02_antecip_pef_pend = "" then
        assign v_cod_safra_graos:format in frame f_adp_02_antecip_pef_pend = "9999/9999".
END. /* ON ENTRY OF v_cod_safra_graos IN FRAME f_adp_02_antecip_pef_pend */

ON LEAVE OF v_cod_safra_graos IN FRAME f_adp_02_antecip_pef_pend
DO:

    assign v_cod_safra_graos:modified in frame f_adp_02_antecip_pef_pend = false.
END. /* ON LEAVE OF v_cod_safra_graos IN FRAME f_adp_02_antecip_pef_pend */

ON VALUE-CHANGED OF v_ind_modo_pagto IN FRAME f_adp_02_antecip_pef_pend
DO:

    run pi_value_changed_ind_modo_pagto_antecip /*pi_value_changed_ind_modo_pagto_antecip*/.
END. /* ON VALUE-CHANGED OF v_ind_modo_pagto IN FRAME f_adp_02_antecip_pef_pend */

ON LEAVE OF v_num_ord_compra IN FRAME f_adp_02_antecip_pef_pend
DO:

    assign input frame f_adp_02_antecip_pef_pend v_num_ord_compra.
    /* Atv 91935
    if v_num_ord_compra > 0 then
        @enable(@&(frame),bt_zoo3,v_num_event).
    else
        @disable(@&(frame),bt_zoo3,v_num_event).
    */
END. /* ON LEAVE OF v_num_ord_compra IN FRAME f_adp_02_antecip_pef_pend */

ON LEAVE OF v_val_cotac_indic_econ_inv IN FRAME f_adp_02_antecip_pef_pend
DO:


    if input frame f_adp_02_antecip_pef_pend v_val_cotac_indic_econ_inv > 0 then
        assign antecip_pef_pend.val_cotac_indic_econ:screen-value in frame f_adp_02_antecip_pef_pend = 
            string(1 / input frame f_adp_02_antecip_pef_pend v_val_cotac_indic_econ_inv).
    else         
        assign antecip_pef_pend.val_cotac_indic_econ:screen-value in frame f_adp_02_antecip_pef_pend = '0'.


END. /* ON LEAVE OF v_val_cotac_indic_econ_inv IN FRAME f_adp_02_antecip_pef_pend */

ON LEAVE OF antecip_pef_pend.cod_espec_docto IN FRAME f_adp_02_antecip_pef_pend
DO:

    find espec_docto_financ no-lock
         where espec_docto_financ.cod_espec_docto = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_espec_docto /*cl_frame of espec_docto_financ*/ no-error.
    if  avail espec_docto_financ
    and espec_docto_financ.log_usa_prev = yes then
        enable bt_abat_prev
               with frame f_adp_02_antecip_pef_pend.
    else
        disable bt_abat_prev
                with frame f_adp_02_antecip_pef_pend.

END. /* ON LEAVE OF antecip_pef_pend.cod_espec_docto IN FRAME f_adp_02_antecip_pef_pend */

ON ENTRY OF antecip_pef_pend.cod_estab IN FRAME f_adp_02_antecip_pef_pend
DO:

    if v_log_portador = yes then do:
        assign antecip_pef_pend.cod_portador:sensitive in frame f_adp_02_antecip_pef_pend = yes.
        enable bt_zoo_66406
               with frame f_adp_02_antecip_pef_pend.
    end.           
END. /* ON ENTRY OF antecip_pef_pend.cod_estab IN FRAME f_adp_02_antecip_pef_pend */

ON LEAVE OF antecip_pef_pend.cod_estab IN FRAME f_adp_02_antecip_pef_pend
DO:

    run pi_on_leave_cod_estab_antecip_pef_pend /*pi_on_leave_cod_estab_antecip_pef_pend*/.
END. /* ON LEAVE OF antecip_pef_pend.cod_estab IN FRAME f_adp_02_antecip_pef_pend */

ON ENTRY OF antecip_pef_pend.cod_indic_econ IN FRAME f_adp_02_antecip_pef_pend
DO:

    assign v_cod_indic_econ_ant = antecip_pef_pend.cod_indic_econ:screen-value in frame f_adp_02_antecip_pef_pend.
END. /* ON ENTRY OF antecip_pef_pend.cod_indic_econ IN FRAME f_adp_02_antecip_pef_pend */

ON LEAVE OF antecip_pef_pend.cod_indic_econ IN FRAME f_adp_02_antecip_pef_pend
DO:

    run pi_leave_cod_indic_econ_antecip_pef_pend_add /*pi_leave_cod_indic_econ_antecip_pef_pend_add*/.

    assign v_val_cotac_indic_econ_inv:sensitive in frame f_adp_02_antecip_pef_pend = 
           antecip_pef_pend.val_cotac_indic_econ:sensitive in frame f_adp_02_antecip_pef_pend.   


    apply 'leave' to antecip_pef_pend.val_cotac_indic_econ in frame f_adp_02_antecip_pef_pend.


    /* Begin_Include: i_executa_pi_epc_fin */
    run pi_exec_program_epc_FIN (Input 'VALIDA_FORMA_PAGTO',
                                 Input 'yes',
                                 output v_log_return_epc) /*pi_exec_program_epc_FIN*/.
    if v_log_return_epc then /* epc retornou erro*/
        undo, retry.
    /* End_Include: i_executa_pi_epc_fin */

END. /* ON LEAVE OF antecip_pef_pend.cod_indic_econ IN FRAME f_adp_02_antecip_pef_pend */

ON LEAVE OF antecip_pef_pend.cod_portador IN FRAME f_adp_02_antecip_pef_pend
DO:

    run pi_leave_cod_portador_antecip_pef_pend_add /*pi_leave_cod_portador_antecip_pef_pend_add*/.

    /* ****************************************************************************************
     * UPC para o Banrisul FO 1433.885 - Ao cadastrar a antecipaªío o programa verifica se o * 
     * portador ≤ caixa.* Se for, jˇ preenche automaticamente a forma de pagamento.          *
     *****************************************************************************************/

    /* Begin_Include: i_executa_pi_epc_fin */
    run pi_exec_program_epc_FIN (Input 'VALIDA_FORMA_PAGTO',
                                 Input 'no',
                                 output v_log_return_epc) /*pi_exec_program_epc_FIN*/.
    if v_log_return_epc then /* epc retornou erro*/
        undo, retry.
    /* End_Include: i_executa_pi_epc_fin */


END. /* ON LEAVE OF antecip_pef_pend.cod_portador IN FRAME f_adp_02_antecip_pef_pend */

ON LEAVE OF antecip_pef_pend.dat_emis_docto IN FRAME f_adp_02_antecip_pef_pend
DO:

    /* Tratamenteo para Bases SQL */
    if  dbtype('emsfin') = 'MSS' then do:
        if  input frame f_adp_02_antecip_pef_pend antecip_pef_pend.dat_emis_docto < 01/01/1800 then do:
            /* Data Inv†lida ! */
            run pi_messages (input "show",
                             input 12705,
                             input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_12705*/.
            return no-apply.
        end.
    end.
    run pi_leave_dat_emis_docto_antecip_pef_pend_add /*pi_leave_dat_emis_docto_antecip_pef_pend_add*/.

    /* Chamada EPC */

    /* Begin_Include: i_exec_program_epc */
    &if '{&emsbas_version}' > '1.00' &then
    if  v_nom_prog_upc <> '' then
    do:
        assign v_rec_table_epc = recid(antecip_pef_pend).    
        run value(v_nom_prog_upc) (input 'DISPLAY',
                                   input 'viewer',
                                   input this-procedure,
                                   input v_wgh_frame_epc,
                                   input v_nom_table_epc,
                                   input v_rec_table_epc).
        if  'no' = 'yes'
        and return-value = 'NOK' then
            undo, retry.
    end.

    if  v_nom_prog_appc <> '' then
    do:
        assign v_rec_table_epc = recid(antecip_pef_pend).    
        run value(v_nom_prog_appc) (input 'DISPLAY',
                                    input 'viewer',
                                    input this-procedure,
                                    input v_wgh_frame_epc,
                                    input v_nom_table_epc,
                                    input v_rec_table_epc).
        if  'no' = 'yes'
        and return-value = 'NOK' then
            undo, retry.
    end.

    &if '{&emsbas_version}' > '5.00' &then
    if  v_nom_prog_dpc <> '' then
    do:
        assign v_rec_table_epc = recid(antecip_pef_pend).    
        run value(v_nom_prog_dpc) (input 'DISPLAY',
                                    input 'viewer',
                                    input this-procedure,
                                    input v_wgh_frame_epc,
                                    input v_nom_table_epc,
                                    input v_rec_table_epc).
        if  'no' = 'yes'
        and return-value = 'NOK' then
            undo, retry.
    end.
    &endif
    &endif
    /* End_Include: i_exec_program_epc */



    /* Begin_Include: i_executa_pi_epc_fin */
    run pi_exec_program_epc_FIN (Input 'VALIDA_FORMA_PAGTO',
                                 Input 'yes',
                                 output v_log_return_epc) /*pi_exec_program_epc_FIN*/.
    if v_log_return_epc then /* epc retornou erro*/
        undo, retry.
    /* End_Include: i_executa_pi_epc_fin */

END. /* ON LEAVE OF antecip_pef_pend.dat_emis_docto IN FRAME f_adp_02_antecip_pef_pend */

ON VALUE-CHANGED OF antecip_pef_pend.ind_favorec_cheq IN FRAME f_adp_02_antecip_pef_pend
DO:

    run pi_vl_changed_ind_favorec_cheq_antecip_pef_pend_add /*pi_vl_changed_ind_favorec_cheq_antecip_pef_pend_add*/.
END. /* ON VALUE-CHANGED OF antecip_pef_pend.ind_favorec_cheq IN FRAME f_adp_02_antecip_pef_pend */

ON LEAVE OF antecip_pef_pend.nom_favorec_cheq IN FRAME f_adp_02_antecip_pef_pend
DO:

    if  input frame f_adp_02_antecip_pef_pend antecip_pef_pend.ind_favorec_cheq = "Outros" /*l_outros*/  THEN
        assign v_nom_favorec = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.nom_favorec_cheq.


END. /* ON LEAVE OF antecip_pef_pend.nom_favorec_cheq IN FRAME f_adp_02_antecip_pef_pend */

ON LEAVE OF antecip_pef_pend.num_cheque IN FRAME f_adp_02_antecip_pef_pend
DO:

    run pi_leave_num_cheque_antecip_pef_pend_add /*pi_leave_num_cheque_antecip_pef_pend_add*/.
END. /* ON LEAVE OF antecip_pef_pend.num_cheque IN FRAME f_adp_02_antecip_pef_pend */

ON LEAVE OF antecip_pef_pend.num_talon_cheq IN FRAME f_adp_02_antecip_pef_pend
DO:

    assign v_num_talon_cheq = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.num_talon_cheq.


    if  input frame f_adp_02_antecip_pef_pend antecip_pef_pend.num_talon_cheq <> 0 then
        enable antecip_pef_pend.num_cheque
               with frame f_adp_02_antecip_pef_pend.
    else do:
        assign antecip_pef_pend.num_cheque:screen-value in frame f_adp_02_antecip_pef_pend = "".
        apply "leave" to antecip_pef_pend.num_cheque in frame f_adp_02_antecip_pef_pend.
        disable antecip_pef_pend.num_cheque
                with frame f_adp_02_antecip_pef_pend.
    end.
END. /* ON LEAVE OF antecip_pef_pend.num_talon_cheq IN FRAME f_adp_02_antecip_pef_pend */

ON LEAVE OF antecip_pef_pend.val_cotac_indic_econ IN FRAME f_adp_02_antecip_pef_pend
DO:

    if input frame f_adp_02_antecip_pef_pend antecip_pef_pend.val_cotac_indic_econ = 0 then
       assign antecip_pef_pend.val_cotac_indic_econ:screen-value in frame f_adp_02_antecip_pef_pend = string(v_val_cotac_indic_econ).

    if input frame f_adp_02_antecip_pef_pend antecip_pef_pend.val_cotac_indic_econ > 0 then
        assign v_val_cotac_indic_econ_inv:screen-value in frame f_adp_02_antecip_pef_pend = 
            string( 1 / input frame f_adp_02_antecip_pef_pend antecip_pef_pend.val_cotac_indic_econ) .
    else         
        assign v_val_cotac_indic_econ_inv:screen-value in frame f_adp_02_antecip_pef_pend = '0'.



END. /* ON LEAVE OF antecip_pef_pend.val_cotac_indic_econ IN FRAME f_adp_02_antecip_pef_pend */

ON LEAVE OF antecip_pef_pend.val_tit_ap IN FRAME f_adp_02_antecip_pef_pend
DO:

    run pi_verificar_cheque_antecipacao /*pi_verificar_cheque_antecipacao*/.
    assign v_val_sdo = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.val_tit_ap.
    if v_val_sdo = 0 then 
        disable bt_impto_retido2
                bt_impto_taxado
                with frame f_adp_02_antecip_pef_pend.
    else
        enable bt_impto_retido2
               bt_impto_taxado
               with frame f_adp_02_antecip_pef_pend.

    /* Chamada EPC */

    /* Begin_Include: i_exec_program_epc */
    &if '{&emsbas_version}' > '1.00' &then
    if  v_nom_prog_upc <> '' then
    do:
        assign v_rec_table_epc = recid(antecip_pef_pend).    
        run value(v_nom_prog_upc) (input 'ALT_APROPRIAC':U,
                                   input 'viewer',
                                   input this-procedure,
                                   input v_wgh_frame_epc,
                                   input v_nom_table_epc,
                                   input v_rec_table_epc).
        if  'no' = 'yes'
        and return-value = 'NOK' then
            undo, retry.
    end.

    if  v_nom_prog_appc <> '' then
    do:
        assign v_rec_table_epc = recid(antecip_pef_pend).    
        run value(v_nom_prog_appc) (input 'ALT_APROPRIAC':U,
                                    input 'viewer',
                                    input this-procedure,
                                    input v_wgh_frame_epc,
                                    input v_nom_table_epc,
                                    input v_rec_table_epc).
        if  'no' = 'yes'
        and return-value = 'NOK' then
            undo, retry.
    end.

    &if '{&emsbas_version}' > '5.00' &then
    if  v_nom_prog_dpc <> '' then
    do:
        assign v_rec_table_epc = recid(antecip_pef_pend).    
        run value(v_nom_prog_dpc) (input 'ALT_APROPRIAC':U,
                                    input 'viewer',
                                    input this-procedure,
                                    input v_wgh_frame_epc,
                                    input v_nom_table_epc,
                                    input v_rec_table_epc).
        if  'no' = 'yes'
        and return-value = 'NOK' then
            undo, retry.
    end.
    &endif
    &endif
    /* End_Include: i_exec_program_epc */



    /* Begin_Include: i_executa_pi_epc_fin */
    run pi_exec_program_epc_FIN (Input 'VALIDA_FORMA_PAGTO',
                                 Input 'yes',
                                 output v_log_return_epc) /*pi_exec_program_epc_FIN*/.
    if v_log_return_epc then /* epc retornou erro*/
        undo, retry.
    /* End_Include: i_executa_pi_epc_fin */

END. /* ON LEAVE OF antecip_pef_pend.val_tit_ap IN FRAME f_adp_02_antecip_pef_pend */

ON LEAVE OF fornecedor.cod_pais IN FRAME f_adp_02_antecip_pef_pend
DO:

    apply "leave" to v_cod_fornec_infor in frame f_adp_02_antecip_pef_pend.
END. /* ON LEAVE OF fornecedor.cod_pais IN FRAME f_adp_02_antecip_pef_pend */

ON CHOOSE OF bt_hel2 IN FRAME f_dlg_01_fornecedor_id_feder
DO:


    /* Begin_Include: i_context_help_frame */
    run prgtec/men/men900za.py (Input self:frame,
                                Input this-procedure:handle) /*prg_fnc_chamar_help_context*/.


    /* End_Include: i_context_help_frame */

END. /* ON CHOOSE OF bt_hel2 IN FRAME f_dlg_01_fornecedor_id_feder */

ON CHOOSE OF bt_ok IN FRAME f_dlg_01_fornecedor_id_feder
DO:


END. /* ON CHOOSE OF bt_ok IN FRAME f_dlg_01_fornecedor_id_feder */


/************************ User Interface Trigger End ************************/

/************************** Function Trigger Begin **************************/


ON  CHOOSE OF bt_zoo_66395 IN FRAME f_adp_02_antecip_pef_pend
OR F5 OF antecip_pef_pend.cod_estab IN FRAME f_adp_02_antecip_pef_pend DO:

    /* fn_generic_zoom */
    if  search("prgint/utb/utb071kb.r") = ? and search("prgint/utb/utb071kb.p") = ? then do:
        if  v_cod_dwb_user begins 'es_' then
            return "Programa execut†vel n∆o foi encontrado:" /*l_programa_nao_encontrado*/  + "prgint/utb/utb071kb.p".
        else do:
            message getStrTrans("Programa execut†vel n∆o foi encontrado:", "APB") /*l_programa_nao_encontrado*/  "prgint/utb/utb071kb.p"
                   view-as alert-box error buttons ok.
            return.
        end.
    end.
    else
        run prgint/utb/utb071kb.p /*prg_sea_estabelecimento_habilit*/.
    if  v_rec_estabelecimento <> ?
    then do:
        find estabelecimento where recid(estabelecimento) = v_rec_estabelecimento no-lock no-error.
        assign antecip_pef_pend.cod_estab:screen-value in frame f_adp_02_antecip_pef_pend =
               string(estabelecimento.cod_estab).

        display estabelecimento.nom_pessoa
                with frame f_adp_02_antecip_pef_pend.

    end /* if */.
    apply "entry" to antecip_pef_pend.cod_estab in frame f_adp_02_antecip_pef_pend.
end. /* ON  CHOOSE OF bt_zoo_66395 IN FRAME f_adp_02_antecip_pef_pend */

ON  CHOOSE OF bt_zoo_66402 IN FRAME f_adp_02_antecip_pef_pend
OR F5 OF fornecedor.cod_pais IN FRAME f_adp_02_antecip_pef_pend DO:

    /* fn_generic_zoom */
    if  search("prgint/utb/utb000ka.r") = ? and search("prgint/utb/utb000ka.p") = ? then do:
        if  v_cod_dwb_user begins 'es_' then
            return "Programa execut†vel n∆o foi encontrado:" /*l_programa_nao_encontrado*/  + "prgint/utb/utb000ka.p".
        else do:
            message getStrTrans("Programa execut†vel n∆o foi encontrado:", "APB") /*l_programa_nao_encontrado*/  "prgint/utb/utb000ka.p"
                   view-as alert-box error buttons ok.
            return.
        end.
    end.
    else
        run prgint/utb/utb000ka.p /*prg_sea_pais*/.
    if  v_rec_pais <> ?
    then do:
        find pais where recid(pais) = v_rec_pais no-lock no-error.
        assign fornecedor.cod_pais:screen-value in frame f_adp_02_antecip_pef_pend =
               string(pais.cod_pais).

    end /* if */.
    apply "entry" to fornecedor.cod_pais in frame f_adp_02_antecip_pef_pend.
end. /* ON  CHOOSE OF bt_zoo_66402 IN FRAME f_adp_02_antecip_pef_pend */

ON  CHOOSE OF bt_zoo_66405 IN FRAME f_adp_02_antecip_pef_pend
OR F5 OF antecip_pef_pend.cod_espec_docto IN FRAME f_adp_02_antecip_pef_pend DO:

    if  search("prgint/ufn/ufn010na.r") = ? and search("prgint/ufn/ufn010na.p") = ? then do:
        if  v_cod_dwb_user begins 'es_' then
            return "Programa execut†vel n∆o foi encontrado:" /*l_programa_nao_encontrado*/  + "prgint/ufn/ufn010na.p".
        else do:
            message getStrTrans("Programa execut†vel n∆o foi encontrado:", "APB") /*l_programa_nao_encontrado*/  "prgint/ufn/ufn010na.p"
                   view-as alert-box error buttons ok.
            return.
        end.
    end.
    else
        run prgint/ufn/ufn010na.p (Input no,
                               Input yes,
                               Input no,
                               Input no,
                               Input no,
                               Input no,
                               Input no,
                               Input no,
                               Input no,
                               Input no,
                               Input yes,
                               Input yes,
                               Input yes,
                               Input yes,
                               Input yes,
                               Input yes,
                               Input yes,
                               Input yes,
                               Input yes,
                               Input yes,
                               Input yes,
                               Input yes) /*prg_see_espec_docto_financ_param*/.
    if  v_rec_espec_docto <> ?
    then do:
        find espec_docto where recid(espec_docto) = v_rec_espec_docto no-lock no-error.
        assign antecip_pef_pend.cod_espec_docto:screen-value in frame f_adp_02_antecip_pef_pend =
               string(espec_docto.cod_espec_docto).
        apply "entry" to antecip_pef_pend.cod_espec_docto in frame f_adp_02_antecip_pef_pend.
    end /* if */.

end. /* ON  CHOOSE OF bt_zoo_66405 IN FRAME f_adp_02_antecip_pef_pend */

ON  CHOOSE OF bt_zoo_66406 IN FRAME f_adp_02_antecip_pef_pend
OR F5 OF antecip_pef_pend.cod_portador IN FRAME f_adp_02_antecip_pef_pend DO:

    if  search("prgint/ufn/ufn008na.r") = ? and search("prgint/ufn/ufn008na.p") = ? then do:
        if  v_cod_dwb_user begins 'es_' then
            return "Programa execut†vel n∆o foi encontrado:" /*l_programa_nao_encontrado*/  + "prgint/ufn/ufn008na.p".
        else do:
            message getStrTrans("Programa execut†vel n∆o foi encontrado:", "APB") /*l_programa_nao_encontrado*/  "prgint/ufn/ufn008na.p"
                   view-as alert-box error buttons ok.
            return.
        end.
    end.
    else
        run prgint/ufn/ufn008na.p (Input antecip_pef_pend.cod_estab:screen-value in frame f_adp_02_antecip_pef_pend) /*prg_see_portad_estab_estab*/.
    if  v_rec_portador <> ?
    then do:
        find portador where recid(portador) = v_rec_portador no-lock no-error.
        assign antecip_pef_pend.cod_portador:screen-value in frame f_adp_02_antecip_pef_pend =
               string(portador.cod_portador).
        apply "entry" to antecip_pef_pend.cod_portador in frame f_adp_02_antecip_pef_pend.
    end /* if */.

end. /* ON  CHOOSE OF bt_zoo_66406 IN FRAME f_adp_02_antecip_pef_pend */

ON  CHOOSE OF bt_zoo_178527 IN FRAME f_adp_02_antecip_pef_pend
OR F5 OF antecip_pef_pend.num_talon_cheq IN FRAME f_adp_02_antecip_pef_pend DO:

    /* fn_generic_zoom */
    if  search("prgint/utb/utb021na.r") = ? and search("prgint/utb/utb021na.p") = ? then do:
        if  v_cod_dwb_user begins 'es_' then
            return "Programa execut†vel n∆o foi encontrado:" /*l_programa_nao_encontrado*/  + "prgint/utb/utb021na.p".
        else do:
            message getStrTrans("Programa execut†vel n∆o foi encontrado:", "APB") /*l_programa_nao_encontrado*/  "prgint/utb/utb021na.p"
                   view-as alert-box error buttons ok.
            return.
        end.
    end.
    else
        run prgint/utb/utb021na.p (Input v_cod_cta_corren) /*prg_see_talon_cheq*/.
    if  v_rec_talon_cheq <> ?
    then do:
        find talon_cheq where recid(talon_cheq) = v_rec_talon_cheq no-lock no-error.
        assign antecip_pef_pend.num_talon_cheq:screen-value in frame f_adp_02_antecip_pef_pend =
               string(talon_cheq.num_talon_cheq).

    end /* if */.
    apply "entry" to antecip_pef_pend.num_talon_cheq in frame f_adp_02_antecip_pef_pend.
end. /* ON  CHOOSE OF bt_zoo_178527 IN FRAME f_adp_02_antecip_pef_pend */

ON  CHOOSE OF bt_zoo_228185 IN FRAME f_adp_02_antecip_pef_pend
OR F5 OF antecip_pef_pend.cod_forma_pagto IN FRAME f_adp_02_antecip_pef_pend DO:

    /* fn_generic_zoom */
    if  search("prgfin/apb/apb005ka.r") = ? and search("prgfin/apb/apb005ka.p") = ? then do:
        if  v_cod_dwb_user begins 'es_' then
            return "Programa execut†vel n∆o foi encontrado:" /*l_programa_nao_encontrado*/  + "prgfin/apb/apb005ka.p".
        else do:
            message getStrTrans("Programa execut†vel n∆o foi encontrado:", "APB") /*l_programa_nao_encontrado*/  "prgfin/apb/apb005ka.p"
                   view-as alert-box error buttons ok.
            return.
        end.
    end.
    else
        run prgfin/apb/apb005ka.p /*prg_sea_forma_pagto*/.
    if  v_rec_forma_pagto <> ?
    then do:
        find forma_pagto where recid(forma_pagto) = v_rec_forma_pagto no-lock no-error.
        assign antecip_pef_pend.cod_forma_pagto:screen-value in frame f_adp_02_antecip_pef_pend =
               string(forma_pagto.cod_forma_pagto).

    end /* if */.
    apply "entry" to antecip_pef_pend.cod_forma_pagto in frame f_adp_02_antecip_pef_pend.
end. /* ON  CHOOSE OF bt_zoo_228185 IN FRAME f_adp_02_antecip_pef_pend */


/*************************** Function Trigger End ***************************/

/**************************** Frame Trigger Begin ***************************/


ON ENDKEY OF FRAME f_adp_02_antecip_pef_pend
DO:

    IF VALID-HANDLE(v_hdl_funcao_mex) THEN
       DELETE PROCEDURE v_hdl_funcao_mex.


    /* Begin_Include: i_exec_program_epc */
    &if '{&emsbas_version}' > '1.00' &then
    if  v_nom_prog_upc <> '' then
    do:
        assign v_rec_table_epc = recid(antecip_pef_pend).    
        run value(v_nom_prog_upc) (input 'CANCEL',
                                   input 'viewer',
                                   input this-procedure,
                                   input v_wgh_frame_epc,
                                   input v_nom_table_epc,
                                   input v_rec_table_epc).
        if  'no' = 'yes'
        and return-value = 'NOK' then
            undo, retry.
    end.

    if  v_nom_prog_appc <> '' then
    do:
        assign v_rec_table_epc = recid(antecip_pef_pend).    
        run value(v_nom_prog_appc) (input 'CANCEL',
                                    input 'viewer',
                                    input this-procedure,
                                    input v_wgh_frame_epc,
                                    input v_nom_table_epc,
                                    input v_rec_table_epc).
        if  'no' = 'yes'
        and return-value = 'NOK' then
            undo, retry.
    end.

    &if '{&emsbas_version}' > '5.00' &then
    if  v_nom_prog_dpc <> '' then
    do:
        assign v_rec_table_epc = recid(antecip_pef_pend).    
        run value(v_nom_prog_dpc) (input 'CANCEL',
                                    input 'viewer',
                                    input this-procedure,
                                    input v_wgh_frame_epc,
                                    input v_nom_table_epc,
                                    input v_rec_table_epc).
        if  'no' = 'yes'
        and return-value = 'NOK' then
            undo, retry.
    end.
    &endif
    &endif
    /* End_Include: i_exec_program_epc */

END. /* ON ENDKEY OF FRAME f_adp_02_antecip_pef_pend */

ON END-ERROR OF FRAME f_adp_02_antecip_pef_pend
DO:

    IF VALID-HANDLE(v_hdl_funcao_mex) THEN
       DELETE PROCEDURE v_hdl_funcao_mex.

    assign v_rec_antecip_pef_pend = v_rec_table_sav.

END. /* ON END-ERROR OF FRAME f_adp_02_antecip_pef_pend */

ON RIGHT-MOUSE-DOWN OF FRAME f_adp_02_antecip_pef_pend ANYWHERE
DO:

    run pi_right_mouse_down_dialog_box /*pi_right_mouse_down_dialog_box*/.
END. /* ON RIGHT-MOUSE-DOWN OF FRAME f_adp_02_antecip_pef_pend */

ON RIGHT-MOUSE-UP OF FRAME f_adp_02_antecip_pef_pend
DO:

    run pi_right_mouse_up_dialog_box /*pi_right_mouse_up_dialog_box*/.
END. /* ON RIGHT-MOUSE-UP OF FRAME f_adp_02_antecip_pef_pend */

ON HELP OF FRAME f_adp_02_antecip_pef_pend ANYWHERE
DO:


    /* Begin_Include: i_context_help */
    run prgtec/men/men900za.py (Input self:handle,
                                Input this-procedure:handle) /*prg_fnc_chamar_help_context*/.
    /* End_Include: i_context_help */

END. /* ON HELP OF FRAME f_adp_02_antecip_pef_pend */

ON WINDOW-CLOSE OF FRAME f_adp_02_antecip_pef_pend
DO:

    apply "end-error" to self.
END. /* ON WINDOW-CLOSE OF FRAME f_adp_02_antecip_pef_pend */

ON RIGHT-MOUSE-DOWN OF FRAME f_dlg_01_fornecedor_id_feder
DO:

    run pi_right_mouse_down_02.

END. /* ON RIGHT-MOUSE-DOWN OF FRAME f_dlg_01_fornecedor_id_feder */

ON RIGHT-MOUSE-UP OF FRAME f_dlg_01_fornecedor_id_feder
DO:

    run pi_right_mouse_up_02.

END. /* ON RIGHT-MOUSE-UP OF FRAME f_dlg_01_fornecedor_id_feder */

ON WINDOW-CLOSE OF FRAME f_dlg_01_fornecedor_id_feder
DO:


    apply "end-error" to self.
END. /* ON WINDOW-CLOSE OF FRAME f_dlg_01_fornecedor_id_feder */

ON HELP OF FRAME f_dlg_01_fornecedor_id_feder ANYWHERE
DO:


    /* Begin_Include: i_context_help */
    run prgtec/men/men900za.py (Input self:handle,
                                Input this-procedure:handle) /*prg_fnc_chamar_help_context*/.
    /* End_Include: i_context_help */

END. /* ON HELP OF FRAME f_dlg_01_fornecedor_id_feder */


/***************************** Frame Trigger End ****************************/

/**************************** Menu Trigger Begin ****************************/


ON CHOOSE OF MENU-ITEM mi_conteudo IN MENU m_help
DO:


        apply "choose" to bt_hel2 in frame f_adp_02_antecip_pef_pend.





END. /* ON CHOOSE OF MENU-ITEM mi_conteudo IN MENU m_help */

ON CHOOSE OF MENU-ITEM mi_sobre IN MENU m_help
DO:

    /************************* Variable Definition Begin ************************/

    def var v_cod_release
        as character
        format "x(12)":U
        no-undo.
    def var v_nom_prog
        as character
        format "x(8)":U
        no-undo.
    def var v_nom_prog_ext
        as character
        format "x(8)":U
        label "Nome Externo"
        no-undo.


    /************************** Variable Definition End *************************/


        assign v_nom_prog     = substring(frame f_adp_02_antecip_pef_pend:title, 1, max(1, length(frame f_adp_02_antecip_pef_pend:title) - 10)).
        if  v_nom_prog = ? then
            assign v_nom_prog = "".

        assign v_nom_prog     = v_nom_prog
                              + chr(10)
                              + "add_antecip_pef_pend":U.




    assign v_nom_prog_ext = "prgfin/apb/apb701ca.p":U
           v_cod_release  = trim(" 1.00.01.147":U).
/*    run prgtec/btb/btb901zb.p (Input v_nom_prog,
                               Input v_nom_prog_ext,
                               Input v_cod_release) /*prg_fnc_about*/. */
{include/sobre5.i}
END. /* ON CHOOSE OF MENU-ITEM mi_sobre IN MENU m_help */


/***************************** Menu Trigger End *****************************/


/****************************** Main Code Begin *****************************/


/* Begin_Include: i_version_extract */
{include/i-ctrlrp5.i add_antecip_pef_pend}


def new global shared var v_cod_arq
    as char  
    format 'x(60)'
    no-undo.
def new global shared var v_cod_tip_prog
    as character
    format 'x(8)'
    no-undo.

def stream s-arq.

if  v_cod_arq <> '' and v_cod_arq <> ?
then do:
    run pi_version_extract ('add_antecip_pef_pend':U, 'prgfin/apb/apb701ca.p':U, '1.00.01.147':U, 'pro':U).
end /* if */.


&IF DEFINED(BF_FIN_APF_PORTAD_CXA) &THEN
    assign v_log_apf_portad = yes.
&ELSE
    assign v_log_apf_portad = no.
&ENDIF.

/* End_Include: i_version_extract */

if  search("prgtec/btb/btb906za.r") = ? and search("prgtec/btb/btb906za.py") = ? then do:
    if  v_cod_dwb_user begins 'es_' then
        return "Programa execut†vel n∆o foi encontrado:" /*l_programa_nao_encontrado*/  + "prgtec/btb/btb906za.py".
    else do:
        message getStrTrans("Programa execut†vel n∆o foi encontrado:", "APB") /*l_programa_nao_encontrado*/  "prgtec/btb/btb906za.py"
               view-as alert-box error buttons ok.
        stop.
    end.
end.
else
    run prgtec/btb/btb906za.py /*prg_fnc_verify_controls*/.

/* Begin_Include: i_verify_security */
if  search("prgtec/men/men901za.r") = ? and search("prgtec/men/men901za.py") = ? then do:
    if  v_cod_dwb_user begins 'es_' then
        return "Programa execut†vel n∆o foi encontrado:" /*l_programa_nao_encontrado*/  + "prgtec/men/men901za.py".
    else do:
        message getStrTrans("Programa execut†vel n∆o foi encontrado:", "APB") /*l_programa_nao_encontrado*/  "prgtec/men/men901za.py"
               view-as alert-box error buttons ok.
        return.
    end.
end.
else
    run prgtec/men/men901za.py (Input 'add_antecip_pef_pend') /*prg_fnc_verify_security*/.
if  return-value = "2014"
then do:
    /* Programa a ser executado n∆o Ç um programa v†lido Datasul ! */
    run pi_messages (input "show",
                     input 2014,
                     input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                       'add_antecip_pef_pend')) /*msg_2014*/.
    return.
end /* if */.
if  return-value = "2012"
then do:
    /* Usu†rio sem permiss∆o para acessar o programa. */
    run pi_messages (input "show",
                     input 2012,
                     input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                       'add_antecip_pef_pend')) /*msg_2012*/.
    return.
end /* if */.
/* End_Include: i_verify_security */



/* Begin_Include: i_log_exec_prog_dtsul_ini */
assign v_rec_log = ?.

if can-find(prog_dtsul
       where prog_dtsul.cod_prog_dtsul = 'add_antecip_pef_pend' 
         and prog_dtsul.log_gera_log_exec = yes) then do transaction:
    create log_exec_prog_dtsul.
    assign log_exec_prog_dtsul.cod_prog_dtsul           = 'add_antecip_pef_pend'
           log_exec_prog_dtsul.cod_usuario              = v_cod_usuar_corren
           log_exec_prog_dtsul.dat_inic_exec_prog_dtsul = today
           log_exec_prog_dtsul.hra_inic_exec_prog_dtsul = replace(string(time,"hh:mm:ss" /*l_hh:mm:ss*/ ),":":U,"":U).
    assign v_rec_log = recid(log_exec_prog_dtsul).
    release log_exec_prog_dtsul no-error.
end.


/* End_Include: i_log_exec_prog_dtsul_ini */


/* Begin_Include: i_verify_program_epc */
&if '{&emsbas_version}' > '1.00' &then
assign v_rec_table_epc = ?
       v_wgh_frame_epc = ?.

find prog_dtsul
    where prog_dtsul.cod_prog_dtsul = "add_antecip_pef_pend":U
    no-lock no-error.
if  avail prog_dtsul then do:
    if  prog_dtsul.nom_prog_upc <> ''
    and prog_dtsul.nom_prog_upc <> ? then
        assign v_nom_prog_upc = prog_dtsul.nom_prog_upc.
    if  prog_dtsul.nom_prog_appc <> ''
    and prog_dtsul.nom_prog_appc <> ? then
        assign v_nom_prog_appc = prog_dtsul.nom_prog_appc.
&if '{&emsbas_version}' > '5.00' &then
    if  prog_dtsul.nom_prog_dpc <> ''
    and prog_dtsul.nom_prog_dpc <> ? then
        assign v_nom_prog_dpc = prog_dtsul.nom_prog_dpc.
&endif
end.


assign v_wgh_frame_epc = frame f_adp_02_antecip_pef_pend:handle.



assign v_nom_table_epc = 'antecip_pef_pend':U
       v_rec_table_epc = recid(antecip_pef_pend).

&endif

/* End_Include: i_verify_program_epc */



/* Begin_Include: ix_p00_add_antecip_pef_pend */
if  v_cod_pais_empres_usuar = "BRA" /*l_bra*/  then
    /* * Procedure chamada para verificar se Ç apenas Legado (5.06) **/
    run pi_verifica_integracao_legado (output v_log_legal_sem_integr).

/* Definiá‰es eSocial*/
def var rDocumEstEsoc       as rowid  no-undo.
def var h-boad00463         as handle  no-undo.
def var v-nro-docto-esoc    as integer no-undo.
def var h-cdapi114          as handle  no-undo.

/* temp-table usada por GRAOS no ESocial */
if v_log_legal_sem_integr = yes then do:
    define temp-table tt-inf-esocial-aquisicao-506 no-undo 
        field serie-docto       as character 
        field nro-docto         as character 
        field cod-emitente      as integer
        field nat-operacao      as character
        field cod-estabel       as character 
        field cod-espec-docto   as character
        field cod-tit-ap        as character
        field cod-parcela       as character
        field ep-codigo         as character
        field num-romaneio      as integer 
        field num-seq           as integer 
        field dt-trans          as date
        field tp-origem         as integer   /* 1 - Recebimento 2 - Contas a Pagar 3 - Romaneio */ 
        field cod-layout        as character /* 1350 */
        field l-campos-hab      as logical init yes
        field rowid-esoc        as rowid
        field tp-aquis          as integer     
        field vl-bruto          as decimal	 /* Obrigatorio */
        field vl-contrib-financ as decimal   /* Opcional */ 
        field vl-contrib-prev   as decimal   /* opcional */
        field vl-contrib-senar  as decimal   /* opcional */
        field nr-proc-jud       as character /* opcional */ 
        .
end.
else do:
    define temp-table tt-inf-esocial-aquisicao no-undo 
        field serie-docto       as character 
        field nro-docto         as character 
        field cod-emitente      as integer
        field nat-operacao      as character
        field cod-estabel       as character 
        field cod-espec-docto   as character
        field cod-tit-ap        as character
        field cod-parcela       as character
      &IF '{&emsfin_version}' >= '5.07A' &THEN
        field ep-codigo         as character
      &ELSE
        field ep-codigo         as integer
      &ENDIF
        field num-romaneio      as integer 
        field num-seq           as integer 
        field dt-trans          as date
        field tp-origem         as integer   /* 1 - Recebimento 2 - Contas a Pagar 3 - Romaneio */ 
        field cod-layout        as character /* 1350 */
        field l-campos-hab      as logical init yes
        field rowid-esoc        as rowid
        field tp-aquis          as integer     
        field vl-bruto          as decimal	 /* Obrigatorio */
        field vl-contrib-financ as decimal   /* Opcional */ 
        field vl-contrib-prev   as decimal   /* opcional */
        field vl-contrib-senar  as decimal   /* opcional */
        field nr-proc-jud       as character /* opcional */ 
        .
end.


/* Begin_Include: i_tt_integra_movto_apr */
def temp-table tt_integra_movto_apr no-undo
    field ttv_num_tip_movto                as integer format '9'
    field ttv_cod_tip_docto                as character format 'x(3)'
    field ttv_num_trans                    as integer format '>9'
    field ttv_num_consist                  as integer format '>9'
    &IF '{&emsfin_version}' < '5.07A' &THEN
    field ttv_num_empres_integr            as integer format '>>9' label 'Empresa' column-label 'Empresa'
    &ELSE
    field ttv_num_empres_integr            as char format 'x(3)' label 'Empresa' column-label 'Empresa'
    &ENDIF
    field ttv_num_ord_invest_integr        as integer format '>>>>>,>>>' label 'Ordem Investimento' column-label 'Ordem Investimento'
    field ttv_dat_emis                     as date format '99/99/9999' initial today label 'Data Emiss∆o' column-label 'Data Emiss∆o'
    field ttv_dat_trans                    as date format '99/99/9999' initial ?
    field ttv_dat_vencto                   as date format '99/99/9999' initial today label 'Data Vencimento' column-label 'Data Vencimento'
    field ttv_num_emit_ems                 as integer format '>>>>>>>>9' column-label 'Emitente'
    field ttv_cod_estab                    as character format 'x(3)' label 'Estabelecimento' column-label 'Estabelecimento'
    field ttv_cod_espec_docto              as character format 'x(3)' label 'EspÇcie Documento' column-label 'EspÇcie'
    field ttv_cod_ser_docto                as character format 'x(3)' label 'SÇrie Docto' column-label 'SÇrie'
    field ttv_cod_docto_integr             as character format 'x(16)'
    field ttv_cod_parcela                  as character format 'x(02)' label 'Parcela' column-label 'Parc'
    field ttv_num_ped_integr               as integer format '>>>>>,>>9' label 'Pedido Compra' column-label 'Pedido Compra'
    field ttv_num_ord_compra_integr        as integer format '>>>>>>,>>'
    field ttv_num_event_integr             as integer format '>>>9' label 'Seq Evento' column-label 'Seq Evento'
    field ttv_cdn_moed_integr              as Integer format '>9'
    field ttv_val_docto_integr             as decimal format '>>>>>,>>>,>>>,>>9.99' decimals 2
    field ttv_des_obs_integr               as character format 'x(76)'
    field ttv_cod_usuar                    as character format 'x(12)' label "Usu†rio" /*l_usuario*/  column-label "Usu†rio" /*l_usuario*/ 
    field ttv_cod_refer                    as character format 'x(10)' label 'Referància' column-label 'Referància'
    .
/* End_Include: i_tt_integra_movto_apr */


/* Begin_Include: i_tt_ordem_compra */
def temp-table tt_ordem_compra no-undo
    &IF '{&emsfin_version}' < '5.07A' &THEN
    field ttv_num_empres_integr            as integer format '>>9' label 'Empresa' column-label 'Empresa'
    &ELSE
    field ttv_num_empres_integr            as char format 'x(3)' label 'Empresa' column-label 'Empresa'
    &ENDIF  
    field ttv_num_oc_integr                as integer format 'zzzzz9,99' label 'Ordem Compra' column-label 'Ordem Compra'
    field ttv_num_ped_integr               as integer format '>>>>>,>>9' label 'Pedido Compra' column-label 'Pedido Compra'
    field ttv_cod_item_integr              as character format 'x(16)' label 'CΩdigo Item' column-label 'CΩdigo Item'
    field ttv_des_item_integr              as character format 'x(40)' label 'Descriªío' column-label 'Descriªío'
    field ttv_num_ord_invest_integr        as integer format '>>>>>,>>>' label 'Ordem Investimento' column-label 'Ordem Investimento'
    field ttv_cod_estab_execut_integr      as character format 'x(3)' label 'Estab Execut' column-label 'Estab Execut'
    field ttv_des_estab_integr             as character format 'x(40)' label 'Descriªío Estab' column-label 'Descriªío Estab'
    field ttv_num_proj_integr              as integer format '>>>>9' label 'Num Projeto' column-label 'Num Projeto'
    field ttv_des_proj_integr              as character format 'x(40)' label 'Descriªío Projeto' column-label 'Descriªío Projeto'
    field ttv_num_ord_integr               as integer format '>>9' label 'Num Ordem Invest' column-label 'Num Ordem Invest'
    field ttv_des_ord_invest_integr        as character format 'x(40)' label 'Descriªío Ord Invest' column-label 'Descriªío Ord Invest'
    field ttv_num_secao_integr             as integer format '9' label 'Num Seªío' column-label 'Num Seªío'
    field ttv_des_secao_integr             as character format 'x(40)' label 'Descriªío Seªío' column-label 'Descriªío Seªío'
    field ttv_num_especialid_integr        as integer format '>>>>9' label 'Cod Especialidade' column-label 'Cod Especialidade'
    field ttv_des_especialid_integr        as character format 'x(40)' label 'Descriªío Especialid' column-label 'Descriªío Especialid'
    field ttv_num_sub_espec_integr         as integer format '>>>>9' label 'Cod Sub Especialid' column-label 'Cod Sub Especialid'
    field ttv_des_sub_espec_integr         as character format 'x(40)' label 'Descriªío Sub Espec' column-label 'Descriªío Sub Espec'
    field ttv_num_orig_integr              as integer format '>>9' label 'Cod Origem' column-label 'Cod Origem'
    field ttv_des_orig_integr              as character format 'x(40)' label 'Descriªío Origem' column-label 'Descriªío Origem'
    .

/* End_Include: i_tt_ordem_compra */


/* Begin_Include: i_tt_ordem_eve */
def temp-table tt_ordem_eve no-undo
    &IF '{&emsfin_version}' < '5.07A' &THEN
    field ttv_num_empres_integr            as integer format '>>9' label 'Empresa' column-label 'Empresa'
    &ELSE
    field ttv_num_empres_integr            as char format 'x(3)' label 'Empresa' column-label 'Empresa'
    &ENDIF
    field ttv_num_event_integr             as integer format '>>>9' label 'Seq Evento' column-label 'Seq Evento'
    field ttv_des_event_integr             as character format 'x(40)' label 'Descriªío Evento' column-label 'Descriªío Evento'
    field ttv_num_oc_integr                as integer format 'zzzzz9,99' label 'Ordem Compra' column-label 'Ordem Compra'
    field ttv_num_ped_integr               as integer format '>>>>>,>>9' label 'Pedido Compra' column-label 'Pedido Compra'
    field ttv_cod_item_integr              as character format 'x(16)' label 'CΩdigo Item' column-label 'CΩdigo Item'
    field ttv_des_item_integr              as character format 'x(40)' label 'Descriªío' column-label 'Descriªío'
    field ttv_num_ord_invest_integr        as integer format '>>>>>,>>>' label 'Ordem Investimento' column-label 'Ordem Investimento'
    field ttv_cod_estab_execut_integr      as character format 'x(3)' label 'Estab Execut' column-label 'Estab Execut'
    field ttv_des_estab_integr             as character format 'x(40)' label 'Descriªío Estab' column-label 'Descriªío Estab'
    field ttv_num_proj_integr              as integer format '>>>>9' label 'Num Projeto' column-label 'Num Projeto'
    field ttv_des_proj_integr              as character format 'x(40)' label 'Descriªío Projeto' column-label 'Descriªío Projeto'
    field ttv_num_ord_integr               as integer format '>>9' label 'Num Ordem Invest' column-label 'Num Ordem Invest'
    field ttv_des_ord_invest_integr        as character format 'x(40)' label 'Descriªío Ord Invest' column-label 'Descriªío Ord Invest'
    field ttv_num_secao_integr             as integer format '9' label 'Num Seªío' column-label 'Num Seªío'
    field ttv_des_secao_integr             as character format 'x(40)' label 'Descriªío Seªío' column-label 'Descriªío Seªío'
    field ttv_num_especialid_integr        as integer format '>>>>9' label 'Cod Especialidade' column-label 'Cod Especialidade'
    field ttv_des_especialid_integr        as character format 'x(40)' label 'Descriªío Especialid' column-label 'Descriªío Especialid'
    field ttv_num_sub_espec_integr         as integer format '>>>>9' label 'Cod Sub Especialid' column-label 'Cod Sub Especialid'
    field ttv_des_sub_espec_integr         as character format 'x(40)' label 'Descriªío Sub Espec' column-label 'Descriªío Sub Espec'
    field ttv_num_orig_integr              as integer format '>>9' label 'Cod Origem' column-label 'Cod Origem'
    field ttv_des_orig_integr              as character format 'x(40)' label 'Descriªío Origem' column-label 'Descriªío Origem'
    .

/* End_Include: i_tt_ordem_eve */



/* Begin_Include: i_declara_GetEntryField */
FUNCTION GetEntryField RETURNS CHARACTER (input p_num_posicao     AS INTEGER,
                                          INPUT p_cod_campo       AS CHARACTER,
                                          input p_cod_separador   AS CHARACTER):

/* ************* Parametros da FUNÄ«O *******************************
** Funá∆o para tratamento dos Entries dos c¢digos livres
** 
**  p_num_posicao     - N£mero do Entry que ser† atualizado
**  p_cod_campo       - Campo / Vari†vel que ser† atualizada
**  p_cod_separador   - Separador que ser† utilizado
*******************************************************************/

    if  p_num_posicao <= 0  then do:
        assign p_num_posicao  = 1.
    end.
    if num-entries(p_cod_campo,p_cod_separador) >= p_num_posicao  then do:
       return entry(p_num_posicao,p_cod_campo,p_cod_separador).
    end.
    return "" /*l_*/ .

END FUNCTION.

/* End_Include: i_declara_GetEntryField */


/* Begin_Include: i_declara_SetEntryField */
FUNCTION SetEntryField RETURNS CHARACTER (input p_num_posicao     AS INTEGER,
                                          input p_cod_campo       AS CHARACTER,
                                          input p_cod_separador   AS CHARACTER,
                                          input p_cod_valor       AS CHARACTER):

/* ************* Parametros da FUNÄ«O *******************************
** Funá∆o para tratamento dos Entries dos c¢digos livres
** 
**  p_num_posicao     - N£mero do Entry / Posiá∆o que ser† atualizado
**  p_cod_campo       - Campo / Vari†vel que ser† atualizada
**  p_cod_separador   - Separador que ser† utilizado
**  p_cod_valor       - Valor que ser† atualizado no Entry passado 
*******************************************************************/

    def var v_num_cont        as integer initial 0 no-undo.
    def var v_num_entries_ini as integer initial 0 no-undo.

    /* ** No progress a menor Entry Ç 1 ***/
    if p_num_posicao <= 0 then 
       assign p_num_posicao = 1.       

    /* ** Caso o Campo contenha um valor inv†lido, este valor ser† convertido para Branco
         para possibilitar os c†lculo ***/
    if p_cod_campo = ? then do:
       assign p_cod_campo = "" /* l_*/ .
    end.

    assign v_num_entries_ini = num-entries(p_cod_campo,p_cod_separador) + 1 .    
    if p_cod_campo = "" /* l_*/  then do:
       assign v_num_entries_ini = 2.
    end.

    do v_num_cont =  v_num_entries_ini to p_num_posicao :
       assign p_cod_campo = p_cod_campo + p_cod_separador.
    end.

    assign entry(p_num_posicao,p_cod_campo,p_cod_separador) = p_cod_valor.

    RETURN p_cod_campo.

END FUNCTION.


/* End_Include: i_declara_SetEntryField */


define temp-table tt_epc no-undo
    field cod_event        as character
    field cod_parameter    as character
    field val_parameter    as character
    index id is primary cod_parameter cod_event ascending.


find cart_bcia no-lock
     where cart_bcia.ind_tip_cart_bcia = "Contas a Pagar"
&if "{&emsfin_version}" >= "5.01" &then
     use-index cartbcia_tip_cart_bcia
&endif
      /*cl_contas_a_pagar of cart_bcia*/ no-error.
if  avail cart_bcia
then do:
    assign v_cod_cart_bcia = cart_bcia.cod_cart_bcia.
end /* if */.

/* ## Foi inicializado est† frame_aux com a tela, para as pi's de validaá∆o
     serem usadas pelos programas inclus∆o/alteraá∆o e pela api. ##*/

&glob frame_aux f_adp_02_antecip_pef_pend

/* **
 Controla se o erro deve ser enviado ao monitor ou a uma Temp Table.
 Os testes em tela da pi_vld s∆o feitos agora num vari†vel hadle.
***/
assign v_ind_modo_impl      = "On-Line" /*l_online*/ 
       v_wgh_frame          = frame f_adp_02_antecip_pef_pend:handle
       v_log_habilit_portad = no.

&if '{&emsbas_version}' > '5.00' &then
    find prog_dtsul where prog_dtsul.cod_prog_dtsul = "add_antecip_pef_pend":U no-lock no-error.
    if  avail prog_dtsul then
        assign v_nom_prog_dpc = prog_dtsul.nom_prog_dpc.
&endif

hide v_num_event in frame f_adp_02_antecip_pef_pend
     v_num_ord_compra in frame f_adp_02_antecip_pef_pend
     v_num_ped_compra in frame f_adp_02_antecip_pef_pend.
assign rt_005:visible  in frame f_adp_02_antecip_pef_pend = no
       bt_zoo:visible  in frame f_adp_02_antecip_pef_pend = no
       bt_zoo2:visible in frame f_adp_02_antecip_pef_pend = no
       bt_zoo3:visible in frame f_adp_02_antecip_pef_pend = no
       v_log_control_invest = no.

/* ** Atualizaá∆o das Funá∆o Especiais ***/

/* Begin_Include: i_declara_GetDefinedFunction */
FUNCTION GetDefinedFunction RETURNS LOGICAL (INPUT SPP AS CHARACTER):

    DEF VAR v_log_retorno AS LOGICAL INITIAL NO NO-UNDO.

    IF CAN-FIND (FIRST histor_exec_especial NO-LOCK
         WHERE histor_exec_especial.cod_modul_dtsul = "UFN" /* l_ufn*/ 
           AND histor_exec_especial.cod_prog_dtsul  = SPP) THEN
        ASSIGN v_log_retorno = YES.


    /* Begin_Include: i_funcao_extract */
    if  v_cod_arq <> '' and v_cod_arq <> ?
    then do:

        output stream s-arq to value(v_cod_arq) append.

        put stream s-arq unformatted
            SPP      at 1 
            v_log_retorno  at 43 skip.

        output stream s-arq close.

    end /* if */.
    /* End_Include: i_funcao_extract */
    .

    RETURN v_log_retorno.
END FUNCTION.
/* End_Include: i_declara_GetDefinedFunction */

assign  v_log_dat_vencto_impto = &IF DEFINED(BF_FIN_DT_VENCTO_IR) &THEN YES &ELSE GetDefinedFunction('SPP_DT_VENCTO_IR':U) &ENDIF
        v_log_oc_antecip       = &IF DEFINED(BF_FIN_ORDEM_COMPRA_ANTECIP) &THEN YES &ELSE GetDefinedFunction('SPP_ORDEM_COMPRA_ANTECIP':U) &ENDIF
        v_log_acum_matriz      = &IF DEFINED(BF_FIN_ACUM_POR_MATRIZ) &THEN YES &ELSE GetDefinedFunction('SPP_ACUM_POR_MATRIZ':U) &ENDIF
        v_log_sul_america      = &IF DEFINED(BF_LOCALIZ_SUL_AMERICA) &THEN yes &ELSE GetDefinedFunction('SPP_LOCALIZ_SUL_AMERICA':U) &ENDIF
        v_log_funcao_agro_negoc = &IF DEFINED(BF_FIN_XML_MOV_APB) &THEN YES &ELSE GetDefinedFunction('SPP_XML_MOV_APB':U) &ENDIF.

assign v_log_localiz_mex = GetDefinedFunction('SPP_LOCALIZ_MEXICO')

       v_log_localiz_arg = GetDefinedFunction('SPP_LOCALIZ_ARGENTINA':U)

       v_log_localiz_equador = GetDefinedFunction('SPP_LOCALIZ_EQUADOR':U).

IF NOT v_log_localiz_equador THEN
    HIDE v_cod_forma_pagto_equador IN FRAME f_adp_02_antecip_pef_pend.

&if '{&emsbas_version}' >= '5.05' &then
    assign v_log_funcao_cod_barra = &if defined(BF_FIN_COD_BAR_AN_APB) &then yes &else GetDefinedFunction('SPP_COD_BAR_AN_APB':U) &endif.
&endif
/* AGRONEGOCIO - PROXIMA */
IF v_log_funcao_agro_negoc THEN DO:
    find first param_integr_ems
        where param_integr_ems.ind_param_integr_ems = "Informaá‰es T°tulos XML" /*l_inform_tit_xml*/   no-lock no-error.
    if not avail param_integr_ems then
        assign v_log_funcao_agro_negoc = no.
END.

/* verifica funá∆o para informar Safra Graos*/
assign v_log_integr_safra_graos = no.
&if '{&emsfin_version}' >= "5.06" &then
    &if defined(BF_FIN_SAFRA_GRAOS) &then
        find param_integr_ems no-lock
            where param_integr_ems.ind_param_integr_ems = "Gr∆os 2.00" /*l_graos_2.00*/  no-error.
        if  avail param_integr_ems then
            assign v_log_integr_safra_graos = yes.
    &endif

    assign v_log_integr_graos = no.
    &if defined(BF_FIN_MELHORIAS_INTEGR_GRAOS) &then
        find param_integr_ems no-lock
            where param_integr_ems.ind_param_integr_ems = "Originaá∆o De Gr∆os" /* l_originacao_graos*/  no-error.
        if  avail param_integr_ems then do:
            assign v_log_integr_graos = yes.
            if v_log_integr_safra_graos then
                assign v_log_integr_safra_graos = no.
        end.
    &endif
&endif

/* ==> *********************************************************************************************** 
****** O Objetivo dessa funá∆o Ç pemitir Agrupar Cheques pelo C¢digo do Fornecedor, 
****** tratanto assim casos onde os diferente fornecedores tem mesmo Nome.
****** Para isso ser† habilitado a opá∆o de COD FORNECEDOR para o atributo IND_FAVOREC_CHEQ.
****** Quando este estiver setado o nome do ser† igual a "FORNECEDOR:" codigo do fornecedor.
****** Na impress∆o de cheques ser† impresso a raz∆o social do Fornecedor.
****** Desenvolvimento : Anderson Nass
*********************************************************************************************** <== */
assign v_log_agrup_cheq_cod_fornec = &IF DEFINED(BF_FIN_AGRUPA_PELO_CODIGO_FORNEC) &THEN YES &ELSE GetDefinedFunction('SPP_AGRUPA_PELO_CODIGO_FORNEC':U) &ENDIF.


/* Begin_Include: i_verifica_funcao_mutuo */
assign v_log_funcao_mutuo = no.
&if defined(BF_FIN_MUTUO) &then
    assign v_log_funcao_mutuo = yes.
&else
    find first histor_exec_especial no-lock
        where histor_exec_especial.cod_modul_dtsul = "UFN" /*l_ufn*/ 
        and histor_exec_especial.cod_prog_dtsul  = "spp_" /*l_spp*/  + 'BF_FIN_MUTUO_SPP'  no-error.
    if  avail histor_exec_especial then
        assign v_log_funcao_mutuo = yes.

  /* Begin_Include: i_funcao_extract */
  if  v_cod_arq <> '' and v_cod_arq <> ?
  then do:

      output stream s-arq to value(v_cod_arq) append.

      put stream s-arq unformatted
          'SPP_BF_FIN_MUTUO_SPP'      at 1 
          v_log_funcao_mutuo  at 43 skip.

      output stream s-arq close.

  end /* if */.
  /* End_Include: i_funcao_extract */
  .                 
&endif 


/* End_Include: i_funcao_extract */



/* Begin_Include: i_exec_mbh900za */
/* ** Samuel - FUT35209 
     Manter o c¢digo abaixo no fonte - Alteraá∆o por Demanda - MBH ***/

&if defined(BF_FIN_BCOS_HISTORICOS) &then
assign v_log_utiliza_mbh = no.
if can-find(first param_utiliz_produt
            where param_utiliz_produt.cod_empresa = v_cod_empres_usuar
            and   param_utiliz_produt.cod_modul_dtsul = "MBH" no-lock) then do:
   assign v_log_utiliza_mbh = yes.
end.
&endif
/* End_Include: i_exec_mbh900za */


/* Aumento D°gitos NF */
assign antecip_pef_pend.cod_ser_docto:format in frame f_adp_02_antecip_pef_pend = 'x(5)'
       antecip_pef_pend.cod_ser_docto:width in frame f_adp_02_antecip_pef_pend  = (antecip_pef_pend.cod_ser_docto:width in frame f_adp_02_antecip_pef_pend) + 2
       antecip_pef_pend.cod_tit_ap:format in frame f_adp_02_antecip_pef_pend    = 'x(16)'
       antecip_pef_pend.cod_tit_ap:width in frame f_adp_02_antecip_pef_pend     = (antecip_pef_pend.cod_tit_ap:width in frame f_adp_02_antecip_pef_pend) + 6.

assign antecip_pef_pend.nom_favorec_cheq:format in frame f_adp_02_antecip_pef_pend = 'x(80)':U
       antecip_pef_pend.nom_favorec_cheq:read-only in frame f_adp_02_antecip_pef_pend = yes. 
/* End_Include: i_exec_mbh900za */


/* redefiniá‰es do frame */

/* Begin_Include: i_std_dialog_box */
/* tratamento do titulo e vers∆o */
assign frame f_adp_02_antecip_pef_pend:title = frame f_adp_02_antecip_pef_pend:title
                            + chr(32)
                            + chr(40)
                            + trim(" 1.00.01.147":U)
                            + chr(41).
/* menu pop-up de ajuda e sobre */
assign menu m_help:popup-only = yes
       bt_hel2:popup-menu in frame f_adp_02_antecip_pef_pend = menu m_help:handle.


/* End_Include: i_std_dialog_box */
{include/title5.i f_adp_02_antecip_pef_pend FRAME}


pause 0 before-hide.
view frame f_adp_02_antecip_pef_pend.

/* Begin_Include: ix_p07_add_antecip_pef_pend */

/* End_Include: ix_p07_add_antecip_pef_pend */


/* Begin_Include: i_exec_program_epc */
&if '{&emsbas_version}' > '1.00' &then
if  v_nom_prog_upc <> '' then
do:
    assign v_rec_table_epc = recid(antecip_pef_pend).    
    run value(v_nom_prog_upc) (input 'INITIALIZE',
                               input 'viewer',
                               input this-procedure,
                               input v_wgh_frame_epc,
                               input v_nom_table_epc,
                               input v_rec_table_epc).
    if  'no' = 'yes'
    and return-value = 'NOK' then
        undo, retry.
end.

if  v_nom_prog_appc <> '' then
do:
    assign v_rec_table_epc = recid(antecip_pef_pend).    
    run value(v_nom_prog_appc) (input 'INITIALIZE',
                                input 'viewer',
                                input this-procedure,
                                input v_wgh_frame_epc,
                                input v_nom_table_epc,
                                input v_rec_table_epc).
    if  'no' = 'yes'
    and return-value = 'NOK' then
        undo, retry.
end.

&if '{&emsbas_version}' > '5.00' &then
if  v_nom_prog_dpc <> '' then
do:
    assign v_rec_table_epc = recid(antecip_pef_pend).    
    run value(v_nom_prog_dpc) (input 'INITIALIZE',
                                input 'viewer',
                                input this-procedure,
                                input v_wgh_frame_epc,
                                input v_nom_table_epc,
                                input v_rec_table_epc).
    if  'no' = 'yes'
    and return-value = 'NOK' then
        undo, retry.
end.
&endif
&endif
/* End_Include: i_exec_program_epc */


/* ix_p08_add_antecip_pef_pend */

assign v_log_repeat   = yes
       v_rec_table    = v_rec_antecip_pef_pend.

/* ix_p09_add_antecip_pef_pend */

main_block:
repeat while v_log_repeat:

    /* Begin_Include: ix_p10_add_antecip_pef_pend */
    enable bt_zoo19
           with frame f_adp_02_antecip_pef_pend.
    assign v_cod_usuar_corren_aux = v_cod_usuar_corren.

    IF v_log_localiz_mex THEN
        run prgfin/lmx/lmx800za.py /*prg_fnc_bord_ap_pagto_max_lmx*/ persistent set v_hdl_funcao_mex.


    /* Begin_Include: i_verifica_param_apf */
    find first param_integr_ems
        where param_integr_ems.ind_param_integr_ems = "Aprovaá∆o Financeira Docto" /*l_aprov_financ_docto*/  no-lock no-error.
    if avail param_integr_ems then 
        assign v_cod_mod = "APF" /*l_apf*/ 
               v_log_mod_apf = yes.
    else
        assign v_cod_mod = "" /*l_null*/ 
               v_log_mod_apf = no.
    /* End_Include: i_verifica_param_apf */


    /* Begin_Include: i_instanciar_api_centraliza_apb_apf */
    if  v_log_mod_apf and v_cod_mod <> "" /*l_*/ 
    then do:
        if  not valid-handle(v_hdl_api_centraliz_apb_apf)
        then do:
            run prgfin/apf/apf900za.py persistent set v_hdl_api_centraliz_apb_apf (Input 1) /*prg_api_centraliza_apb_apf*/.
        end.
    end.
    /* End_Include: i_instanciar_api_centraliza_apb_apf */


    if  v_log_mod_apf and v_cod_mod <> "" /*l_*/ 
    then do:
        if  valid-handle(v_hdl_api_centraliz_apb_apf)
        then do:
            run pi_elimina_tt_aprop_apf in v_hdl_api_centraliz_apb_apf /*pi_elimina_tt_aprop_apf*/.
        end /* if */.
    end /* if */.
    /* End_Include: i_instanciar_api_centraliza_apb_apf */

    assign v_log_repeat  = no
           v_log_save_ok = no.

    /* ix_p12_add_antecip_pef_pend */

    create antecip_pef_pend.
    if  not retry
    then do:
        assign v_rec_table_sav = v_rec_table.
        assign estabelecimento.nom_pessoa:screen-value in frame f_adp_02_antecip_pef_pend = ""
               fornecedor.cod_pais:screen-value        in frame f_adp_02_antecip_pef_pend = "BRA"
               antecip_pef_pend.cod_tit_ap:SCREEN-VALUE IN FRAME f_adp_02_antecip_pef_pend = FILL('0', 7 - LENGTH(STRING(p-numero))) + string(p-numero)
               fornecedor.nom_abrev:screen-value       in frame f_adp_02_antecip_pef_pend = p-nom-abrev
               v_cod_fornec_infor:SCREEN-VALUE IN FRAME f_adp_02_antecip_pef_pend = STRING(p-emitente)
               v_cod_fornec_infor:SENSITIVE IN FRAME f_adp_02_antecip_pef_pend = NO


               antecip_pef_pend.cod_espec_docto:SCREEN-VALUE IN FRAME f_adp_02_antecip_pef_pend = "VC".

        display antecip_pef_pend.cod_estab
                antecip_pef_pend.cod_refer
                antecip_pef_pend.dat_emis_docto
                antecip_pef_pend.cod_ser_docto
                antecip_pef_pend.cod_portador
                antecip_pef_pend.cod_indic_econ
                antecip_pef_pend.cod_parcela
                antecip_pef_pend.val_tit_ap
                v_ind_modo_pagto
                antecip_pef_pend.ind_favorec_cheq
                antecip_pef_pend.num_cheque
                antecip_pef_pend.num_talon_cheq
                antecip_pef_pend.nom_favorec_cheq
                antecip_pef_pend.cod_forma_pagto
                antecip_pef_pend.dat_vencto_tit_ap
                antecip_pef_pend.val_cotac_indic_econ
                with frame f_adp_02_antecip_pef_pend.

        /* Begin_Include: i_exec_program_epc */
        &if '{&emsbas_version}' > '1.00' &then
        if  v_nom_prog_upc <> '' then
        do:
            assign v_rec_table_epc = recid(antecip_pef_pend).    
            run value(v_nom_prog_upc) (input 'DISPLAY',
                                       input 'viewer',
                                       input this-procedure,
                                       input v_wgh_frame_epc,
                                       input v_nom_table_epc,
                                       input v_rec_table_epc).
            if  'no' = 'yes'
            and return-value = 'NOK' then
                undo, retry.
        end.

        if  v_nom_prog_appc <> '' then
        do:
            assign v_rec_table_epc = recid(antecip_pef_pend).    
            run value(v_nom_prog_appc) (input 'DISPLAY',
                                        input 'viewer',
                                        input this-procedure,
                                        input v_wgh_frame_epc,
                                        input v_nom_table_epc,
                                        input v_rec_table_epc).
            if  'no' = 'yes'
            and return-value = 'NOK' then
                undo, retry.
        end.

        &if '{&emsbas_version}' > '5.00' &then
        if  v_nom_prog_dpc <> '' then
        do:
            assign v_rec_table_epc = recid(antecip_pef_pend).    
            run value(v_nom_prog_dpc) (input 'DISPLAY',
                                        input 'viewer',
                                        input this-procedure,
                                        input v_wgh_frame_epc,
                                        input v_nom_table_epc,
                                        input v_rec_table_epc).
            if  'no' = 'yes'
            and return-value = 'NOK' then
                undo, retry.
        end.
        &endif
        &endif
        /* End_Include: i_exec_program_epc */

    end /* if */.

    /* ix_p18_add_antecip_pef_pend */

    enable antecip_pef_pend.cod_estab
           antecip_pef_pend.cod_refer
           bt_zoo_66395
           antecip_pef_pend.cod_espec_docto
           antecip_pef_pend.dat_emis_docto
           antecip_pef_pend.cod_ser_docto
           antecip_pef_pend.cod_portador
           antecip_pef_pend.cod_tit_ap
           antecip_pef_pend.cod_indic_econ
           antecip_pef_pend.cod_parcela
           antecip_pef_pend.val_tit_ap
           v_ind_modo_pagto
           antecip_pef_pend.ind_favorec_cheq
           antecip_pef_pend.num_cheque
           antecip_pef_pend.num_talon_cheq
           antecip_pef_pend.nom_favorec_cheq
           antecip_pef_pend.cod_forma_pagto
           antecip_pef_pend.dat_vencto_tit_ap
           antecip_pef_pend.val_cotac_indic_econ
           bt_segur_leas
           bt_ok
           bt_sav
           bt_can
           bt_cop
           bt_hel2
           v_cod_fornec_infor
           fornecedor.cod_pais
           bt_abat_prev
           bt_rat_val
           bt_histor_padr
           bt_zoo_fornec
           bt_vinc_imp_fornec2
           v_cod_safra_graos
           with frame f_adp_02_antecip_pef_pend.

    /* Begin_Include: i_exec_program_epc */
    &if '{&emsbas_version}' > '1.00' &then
    if  v_nom_prog_upc <> '' then
    do:
        assign v_rec_table_epc = recid(antecip_pef_pend).    
        run value(v_nom_prog_upc) (input 'ENABLE',
                                   input 'viewer',
                                   input this-procedure,
                                   input v_wgh_frame_epc,
                                   input v_nom_table_epc,
                                   input v_rec_table_epc).
        if  'no' = 'yes'
        and return-value = 'NOK' then
            undo, retry.
    end.

    if  v_nom_prog_appc <> '' then
    do:
        assign v_rec_table_epc = recid(antecip_pef_pend).    
        run value(v_nom_prog_appc) (input 'ENABLE',
                                    input 'viewer',
                                    input this-procedure,
                                    input v_wgh_frame_epc,
                                    input v_nom_table_epc,
                                    input v_rec_table_epc).
        if  'no' = 'yes'
        and return-value = 'NOK' then
            undo, retry.
    end.

    &if '{&emsbas_version}' > '5.00' &then
    if  v_nom_prog_dpc <> '' then
    do:
        assign v_rec_table_epc = recid(antecip_pef_pend).    
        run value(v_nom_prog_dpc) (input 'ENABLE',
                                    input 'viewer',
                                    input this-procedure,
                                    input v_wgh_frame_epc,
                                    input v_nom_table_epc,
                                    input v_rec_table_epc).
        if  'no' = 'yes'
        and return-value = 'NOK' then
            undo, retry.
    end.
    &endif
    &endif
    /* End_Include: i_exec_program_epc */


    /* Begin_Include: ix_p20_add_antecip_pef_pend */
    IF v_log_localiz_equador THEN DO:
        ASSIGN v_cod_forma_pagto_equador:VISIBLE IN FRAME f_adp_02_antecip_pef_pend = YES
               v_cod_forma_pagto_equador:screen-value = entry(1, getLstItUndoTrans(yes, v_cod_forma_pagto_equador:{&UI_LIST_ITEM_PAIRS}) ).

        display v_cod_forma_pagto_equador
            with frame f_adp_02_antecip_pef_pend.
        enable v_cod_forma_pagto_equador
            with frame f_adp_02_antecip_pef_pend.
    END.

    if v_log_integr_safra_graos then do:
        view v_cod_safra_graos in frame f_adp_02_antecip_pef_pend.
    end.
    else do:
        hide v_cod_safra_graos in frame f_adp_02_antecip_pef_pend.
    end.

    if v_log_integr_graos then do:
        enable v_cod_safra_graos
               v_cod_contrat_graos with frame f_adp_02_antecip_pef_pend.
        view v_cod_safra_graos 
             v_cod_contrat_graos in frame f_adp_02_antecip_pef_pend.
    end.
    else do:
        hide v_cod_safra_graos 
             v_cod_contrat_graos in frame f_adp_02_antecip_pef_pend.
    end.

    if  v_cod_pais_empres_usuar = "BRA" /*l_bra*/  then do:
        /* eSocial - Iteraá∆o 01*/
        assign v_cod_tip_fornecto = "".
        find first fornec_financ
            where fornec_financ.cod_empresa    = v_cod_empres_usuar
            and   fornec_financ.cdn_fornecedor = integer(v_cod_fornec_infor) no-lock no-error.
        if avail fornec_financ then do:
            if fornec_financ.ind_tip_fornecto = "Prod/Ser" /*l_prod_ser*/ 
            or fornec_financ.ind_tip_fornecto = "Serviáos" /*l_servicos*/ 
            or fornec_financ.ind_tip_fornecto = "Ambos" /*l_ambos*/ 
            or fornec_financ.ind_tip_fornecto = "PR Rural" /*l_pr_rural*/  then do:
                assign v_cod_tip_fornecto = fornec_financ.ind_tip_fornecto.
                &if defined(BF_FIN_ESOCIAL) &then
                    assign v_log_cop_aux     = fornec_financ.log_cooperat
                           v_log_assoc_despr = fornec_financ.log_assoc_desport.
                &else
                    assign v_log_cop_aux     = fornec_financ.log_livre_1
                           v_log_assoc_despr = fornec_financ.log_livre_2.
                &endif
            end.
        end.
        /* eSocial - Iteraá∆o 01*/
    end.


    /* Begin_Include: i_controlar_estab_apb */
    find last param_geral_apb no-lock no-error.
    if  avail param_geral_apb
    then do:
        assign antecip_pef_pend.cod_estab:screen-value in frame f_adp_02_antecip_pef_pend = v_cod_estab_usuar.
        apply "leave" to antecip_pef_pend.cod_estab in frame f_adp_02_antecip_pef_pend.
        if  param_geral_apb.ind_control_estab = "Assumido Direto" /*l_assumido_direto*/ 
        then do:
            disable antecip_pef_pend.cod_estab
                    bt_zoo_66395
                    with frame f_adp_02_antecip_pef_pend.
        end /* if */.
        else do:
            enable antecip_pef_pend.cod_estab
                   bt_zoo_66395
                   with frame f_adp_02_antecip_pef_pend.
        end /* else */.
    end /* if */.
    else do:
        /* ParÉmetro Geral do Contas a Pagar Inexistente ! */
        run pi_messages (input "show",
                         input 700,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_700*/.
        enable antecip_pef_pend.cod_estab
               bt_zoo_66395
               with frame f_adp_02_antecip_pef_pend.
    end /* else */.
    /* End_Include: i_controlar_estab_apb */


    disable bt_abat_prev
            with frame f_adp_02_antecip_pef_pend.
    assign fornecedor.cod_pais:screen-value in frame f_adp_02_antecip_pef_pend = v_cod_pais_empres_usuar
           antecip_pef_pend.ind_favorec_cheq:{&UI_LIST_ITEM_PAIRS} in frame f_adp_02_antecip_pef_pend    = getLstItTrans(yes, "" + ","
                                                               + "Portador" /*l_portador*/    + ","
                                                               + "Fornecedor" /*l_fornecedor*/  + ","
                                                               + "Outros" /*l_outros*/, "APB").
    if  v_log_agrup_cheq_cod_fornec then
        assign antecip_pef_pend.ind_favorec_cheq:{&UI_LIST_ITEM_PAIRS} in frame f_adp_02_antecip_pef_pend = getLstItTrans(yes, getLstItUndoTrans(yes, antecip_pef_pend.ind_favorec_cheq:{&UI_LIST_ITEM_PAIRS} in frame f_adp_02_antecip_pef_pend)
                                                                               + "," + "Cod Fornecedor" /*l_cod_fornec*/, "APB").

    &if '{&emsfin_dbtype}' = 'progress' &then
        run pi_retorna_sugestao_referencia (Input "a" /*l_A*/ ,
                                            Input today,
                                            output v_cod_refer).

        assign v_log_existe = yes.
        do while v_log_existe = yes:    
            if not can-find(first antecip_pef_pend no-lock
                            where antecip_pef_pend.cod_estab = antecip_pef_pend.cod_estab:screen-value in frame f_adp_02_antecip_pef_pend
                              and antecip_pef_pend.cod_refer = v_cod_refer) then
                assign v_log_existe = no.
            else
                run pi_retorna_sugestao_referencia (Input "a" /*l_A*/ ,
                                                    Input today,
                                                    output v_cod_refer).
        end.


        /* Begin_Include: i_executa_pi_epc_fin_refer */
        if  v_nom_prog_upc  <> ''    
        or  v_nom_prog_appc <> ''
        or  v_nom_prog_dpc  <> '' then do:

            run pi_limpa_retorno /*pi_limpa_retorno*/.


            /* Begin_Include: i_executa_pi_epc_fin */
            run pi_exec_program_epc_FIN (Input 'retorna_sugestao_referencia',
                                         Input 'no',
                                         output v_log_return_epc) /*pi_exec_program_epc_FIN*/.
            if v_log_return_epc then /* epc retornou erro*/
                undo, retry.
            /* End_Include: i_executa_pi_epc_fin */


            /* Somente vai entrar se for o banrisul */
            if return-value = 'BRSL' then do:
                run pi_retorna_sugestao_referencia_epc (Input "a" /*l_A*/ ,
                                                        Input today,
                                                        output v_cod_refer).
            end.

            run pi_limpa_retorno /*pi_limpa_retorno*/.
        end.

        /* End_Include: i_executa_pi_epc_fin */

    assign antecip_pef_pend.cod_refer:screen-value in frame f_adp_02_antecip_pef_pend = v_cod_refer.
    &endif
    assign v_log_portador = yes.

    disable fornecedor.cod_pais
            bt_zoo_66402
            with frame f_adp_02_antecip_pef_pend.

    find first param_integr_ems no-lock
         where param_integr_ems.ind_param_integr_ems = "Controle Investimentos 2.00" /*l_controle_invest*/  no-error.
    if avail param_integr_ems then do:
        assign v_log_control_invest = yes.
        enable v_num_ord_compra
               v_num_ped_compra
               bt_zoo
               bt_zoo2
               with frame f_adp_02_antecip_pef_pend.
        display v_num_ord_compra
                v_num_ped_compra
                with frame f_adp_02_antecip_pef_pend. /* v_num_event */
        assign rt_005:visible  = yes
               bt_zoo:visible  = yes
               bt_zoo2:visible = yes. /* bt_zoo3:visible = yes*/

        create text v_wgh_aux
          assign frame        = frame f_adp_02_antecip_pef_pend:handle
                 font         = frame f_adp_02_antecip_pef_pend:font
                 row          = 04.90
                 col          = 66.57
                 format       = "x(13)" /*l_x(13)*/ 
                 screen-value = " " + "Investimento" /*l_investimento*/ 
                 width        = 10
                 visible      = yes.
{include/i_fcldin.i v_wgh_aux }
    end.

    if  v_log_oc_antecip then
        assign bt_ordem_compra:sensitive in frame f_adp_02_antecip_pef_pend = yes.
    else
        assign bt_ordem_compra:visible   in frame f_adp_02_antecip_pef_pend = no
               bt_ordem_compra:sensitive in frame f_adp_02_antecip_pef_pend = no.

    if  v_log_funcao_cod_barra then
        assign bt_cod_barra:sensitive in frame f_adp_02_antecip_pef_pend = yes.
    else    
        assign bt_cod_barra:visible in frame f_adp_02_antecip_pef_pend = no.    

    /* End_Include: i_executa_pi_epc_fin */

    wait_block:
    repeat on endkey undo main_block, leave main_block while v_log_save_ok = no:
        if  valid-handle(v_wgh_focus)
        then do:
            wait-for go of frame f_adp_02_antecip_pef_pend focus v_wgh_focus.
        end /* if */.
        else do:
            wait-for go of frame f_adp_02_antecip_pef_pend.
        end /* else */.
        save_block:
        do on error undo save_block, leave save_block:

            /* Begin_Include: ix_p25_add_antecip_pef_pend */
            assign v_cdn_fornecedor = int(input frame f_adp_02_antecip_pef_pend v_cod_fornec_infor) no-error.

            assign antecip_pef_pend.cod_empresa = v_cod_empres_usuar_2
                   antecip_pef_pend.cod_estab = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab
                   antecip_pef_pend.cod_refer = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_refer
                   antecip_pef_pend.cdn_fornecedor = v_cdn_fornecedor.

            run pi_ix_p25_add_antecip_pef_pend /*pi_ix_p25_add_antecip_pef_pend*/.

            assign v_log_atualiz_hora_liber = no.
            &if defined(BF_ATUALIZ_HORA_PROCES_PAGTO) &then
                assign v_log_atualiz_hora_liber = yes.
            &elseif '{&emsfin_version}' >= '5.03'&then
                find histor_exec_especial no-lock
                   where histor_exec_especial.cod_modul_dtsul = "UFN" /* l_ufn*/ 
                   and   histor_exec_especial.cod_prog_dtsul = "SPP_ATUALIZ_HORA_PROCES_PAGTO":U no-error.
                if avail histor_exec_especial then
                    assign v_log_atualiz_hora_liber = yes.
            &endif

            run pi_verifica_indic_favorec_cheque.
            if return-value = "NOK" /*l_nok*/  then do:
                apply "Entry" /*l_entry*/  to antecip_pef_pend.ind_favorec_cheq in frame f_adp_02_antecip_pef_pend.
                undo, leave.
            end.

            if v_log_integr_safra_graos then do:
                if v_cod_safra_graos:screen-value in frame f_adp_02_antecip_pef_pend = ""
                    or trim(v_cod_safra_graos:screen-value in frame f_adp_02_antecip_pef_pend) = "/" then do:
                    assign v_cod_safra_graos:format in frame f_adp_02_antecip_pef_pend = "x(09)" /*l_x09*/ .
                    assign v_cod_safra_graos:screen-value in frame f_adp_02_antecip_pef_pend = "".
                end.
                else if length(v_cod_safra_graos:screen-value in frame f_adp_02_antecip_pef_pend) <> 9 then do:
                    /* Formato &2 Inv†lido ! */
                    run pi_messages (input "show",
                                     input 4488,
                                     input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                       v_cod_safra_graos:format in frame f_adp_02_antecip_pef_pend,"do Campo Safra" /*l_do_campo_safra*/)) /*msg_4488*/.
                    assign v_wgh_focus = v_cod_safra_graos:handle.
                    apply "error" /*l_error*/ .
                end.
            end.

            if v_log_integr_safra_graos then do:
                &IF '{&emsfin_version}' >= '5.06' AND '{&emsfin_version}' < '5.09' &THEN
                assign input frame f_adp_02_antecip_pef_pend v_cod_safra_graos
                       antecip_pef_pend.cod_livre_2 = v_cod_safra_graos.
                &ENDIF
                &IF '{&emsfin_version}' >= '5.09' &THEN
                assign input frame f_adp_02_antecip_pef_pend v_cod_safra_graos
                       antecip_pef_pend.cod_safra = v_cod_safra_graos.
                &ENDIF
            end.
            if v_log_integr_safra_graos then do:
                assign input frame f_adp_02_antecip_pef_pend v_cod_safra_graos.
            end.

            &if defined(BF_FIN_MELHORIAS_INTEGR_GRAOS) &then
                if v_log_integr_graos then do:
                    if v_cod_safra_graos:screen-value in frame f_adp_02_antecip_pef_pend = ""
                        or trim(v_cod_safra_graos:screen-value in frame f_adp_02_antecip_pef_pend) = "/" then do:
                        assign v_cod_safra_graos:format in frame f_adp_02_antecip_pef_pend = "x(09)" /*l_x09*/ .
                        assign v_cod_safra_graos:screen-value in frame f_adp_02_antecip_pef_pend = "".
                    end.
                    else if length(v_cod_safra_graos:screen-value in frame f_adp_02_antecip_pef_pend) <> 9 then do:
                        /* Formato &2 Inv†lido ! */
                        run pi_messages (input "show",
                                         input 4488,
                                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                           v_cod_safra_graos:format in frame f_adp_02_antecip_pef_pend,"do Campo Safra" /*l_do_campo_safra*/)) /*msg_4488*/.
                        assign v_wgh_focus = v_cod_safra_graos:handle.
                        apply "error" /*l_error*/ .
                    end.

                    assign input frame f_adp_02_antecip_pef_pend v_cod_safra_graos
                           input frame f_adp_02_antecip_pef_pend v_cod_contrat_graos.
                    assign antecip_pef_pend.cod_safra         = v_cod_safra_graos
                           antecip_pef_pend.cod_contrat_graos = v_cod_contrat_graos.

                    assign input frame f_adp_02_antecip_pef_pend v_cod_safra_graos
                           input frame f_adp_02_antecip_pef_pend v_cod_contrat_graos.
                end.
            &endif
            /* End_Include: ix_p25_add_antecip_pef_pend */

            run pi_save_key /*pi_save_key*/.
            run pi_save_fields /*pi_save_fields*/.

            /* Begin_Include: ix_p27_add_antecip_pef_pend */
            if  v_log_mod_apf and v_cod_mod <> "" /*l_*/ 
            then do:
                if  valid-handle(v_hdl_api_centraliz_apb_apf)
                then do:
                    run pi_gera_informacoes_apf in v_hdl_api_centraliz_apb_apf (Input recid(antecip_pef_pend)) /*pi_gera_informacoes_apf*/.
                    if return-value <> "OK" /*l_ok*/  then
                        undo, leave.
                end /* if */.
            end /* if */.
            /* End_Include: ix_p27_add_antecip_pef_pend */


            /* Begin_Include: i_exec_program_epc */
            &if '{&emsbas_version}' > '1.00' &then
            if  v_nom_prog_upc <> '' then
            do:
                assign v_rec_table_epc = recid(antecip_pef_pend).    
                run value(v_nom_prog_upc) (input 'ASSIGN',
                                           input 'viewer',
                                           input this-procedure,
                                           input v_wgh_frame_epc,
                                           input v_nom_table_epc,
                                           input v_rec_table_epc).
                if  'yes' = 'yes'
                and return-value = 'NOK' then
                    undo, retry.
            end.

            if  v_nom_prog_appc <> '' then
            do:
                assign v_rec_table_epc = recid(antecip_pef_pend).    
                run value(v_nom_prog_appc) (input 'ASSIGN',
                                            input 'viewer',
                                            input this-procedure,
                                            input v_wgh_frame_epc,
                                            input v_nom_table_epc,
                                            input v_rec_table_epc).
                if  'yes' = 'yes'
                and return-value = 'NOK' then
                    undo, retry.
            end.

            &if '{&emsbas_version}' > '5.00' &then
            if  v_nom_prog_dpc <> '' then
            do:
                assign v_rec_table_epc = recid(antecip_pef_pend).    
                run value(v_nom_prog_dpc) (input 'ASSIGN',
                                            input 'viewer',
                                            input this-procedure,
                                            input v_wgh_frame_epc,
                                            input v_nom_table_epc,
                                            input v_rec_table_epc).
                if  'yes' = 'yes'
                and return-value = 'NOK' then
                    undo, retry.
            end.
            &endif
            &endif
            /* End_Include: i_exec_program_epc */

            run pi_vld_antecip_pef_pend /*pi_vld_antecip_pef_pend*/.

            /* Begin_Include: i_exec_program_epc */
            &if '{&emsbas_version}' > '1.00' &then
            if  v_nom_prog_upc <> '' then
            do:
                assign v_rec_table_epc = recid(antecip_pef_pend).    
                run value(v_nom_prog_upc) (input 'VALIDATE',
                                           input 'viewer',
                                           input this-procedure,
                                           input v_wgh_frame_epc,
                                           input v_nom_table_epc,
                                           input v_rec_table_epc).
                if  'yes' = 'yes'
                and return-value = 'NOK' then
                    undo, retry.
            end.

            if  v_nom_prog_appc <> '' then
            do:
                assign v_rec_table_epc = recid(antecip_pef_pend).    
                run value(v_nom_prog_appc) (input 'VALIDATE',
                                            input 'viewer',
                                            input this-procedure,
                                            input v_wgh_frame_epc,
                                            input v_nom_table_epc,
                                            input v_rec_table_epc).
                if  'yes' = 'yes'
                and return-value = 'NOK' then
                    undo, retry.
            end.

            &if '{&emsbas_version}' > '5.00' &then
            if  v_nom_prog_dpc <> '' then
            do:
                assign v_rec_table_epc = recid(antecip_pef_pend).    
                run value(v_nom_prog_dpc) (input 'VALIDATE',
                                            input 'viewer',
                                            input this-procedure,
                                            input v_wgh_frame_epc,
                                            input v_nom_table_epc,
                                            input v_rec_table_epc).
                if  'yes' = 'yes'
                and return-value = 'NOK' then
                    undo, retry.
            end.
            &endif
            &endif
            /* End_Include: i_exec_program_epc */


            /* Begin_Include: ix_p30_add_antecip_pef_pend */
            IF v_log_localiz_equador THEN DO:
                CASE v_cod_forma_pagto_equador:SCREEN-VALUE:                                 
                    WHEN "01-Sem sist fin" /*l_01sem_sist_fin*/    THEN ASSIGN antecip_pef_pend.cod_livre_1 = SetEntryField(8,antecip_pef_pend.cod_livre_1,CHR(10),"01").                     
                    WHEN "02-Cheque pr¢p" /*l_02cheque_prop*/     THEN ASSIGN antecip_pef_pend.cod_livre_1 = SetEntryField(8,antecip_pef_pend.cod_livre_1,CHR(10),"02").                         
                    WHEN "03-Cheque adm" /*l_03cheque_adm*/      THEN ASSIGN antecip_pef_pend.cod_livre_1 = SetEntryField(8,antecip_pef_pend.cod_livre_1,CHR(10),"03").                       
                    WHEN "04-Cheq geren" /*l_04cheq_geren*/      THEN ASSIGN antecip_pef_pend.cod_livre_1 = SetEntryField(8,antecip_pef_pend.cod_livre_1,CHR(10),"04").                      
                    WHEN "05-Cheq do ext" /*l_05cheq_do_ext*/     THEN ASSIGN antecip_pef_pend.cod_livre_1 = SetEntryField(8,antecip_pef_pend.cod_livre_1,CHR(10),"05").                    
                    WHEN "06-DÇbito em cta" /*l_06debito_em_cta*/   THEN ASSIGN antecip_pef_pend.cod_livre_1 = SetEntryField(8,antecip_pef_pend.cod_livre_1,CHR(10),"06").                   
                    WHEN "07-Trf msm bco" /*l_07trf_msm_bco*/     THEN ASSIGN antecip_pef_pend.cod_livre_1 = SetEntryField(8,antecip_pef_pend.cod_livre_1,CHR(10),"07").                  
                    WHEN "08-Trf outro bco" /*l_08trf_outro_bco*/   THEN ASSIGN antecip_pef_pend.cod_livre_1 = SetEntryField(8,antecip_pef_pend.cod_livre_1,CHR(10),"08").                 
                    WHEN "09-Trf bco ext" /*l_09trf_bco_ext*/     THEN ASSIGN antecip_pef_pend.cod_livre_1 = SetEntryField(8,antecip_pef_pend.cod_livre_1,CHR(10),"09").                 
                    WHEN "10-Cart crÇd nac" /*l_10cart_cred_nac*/   THEN ASSIGN antecip_pef_pend.cod_livre_1 = SetEntryField(8,antecip_pef_pend.cod_livre_1,CHR(10),"10").                
                    WHEN "11-Cart crÇd int" /*l_11cart_cred_int*/   THEN ASSIGN antecip_pef_pend.cod_livre_1 = SetEntryField(8,antecip_pef_pend.cod_livre_1,CHR(10),"11").                 
                    WHEN "12-Cheque bcio" /*l_12cheque_bcio*/     THEN ASSIGN antecip_pef_pend.cod_livre_1 = SetEntryField(8,antecip_pef_pend.cod_livre_1,CHR(10),"12").               
                    WHEN "13-Dep¢sito" /*l_13deposito*/        THEN ASSIGN antecip_pef_pend.cod_livre_1 = SetEntryField(8,antecip_pef_pend.cod_livre_1,CHR(10),"13").               
                    WHEN "14-Endosso Invest" /*l_14endosso_invest*/  THEN ASSIGN antecip_pef_pend.cod_livre_1 = SetEntryField(8,antecip_pef_pend.cod_livre_1,CHR(10),"14").
                    WHEN "15-Compens d°vida" /*l_15compens_divida*/  THEN ASSIGN antecip_pef_pend.cod_livre_1 = SetEntryField(8,antecip_pef_pend.cod_livre_1,CHR(10),"15").                
                END CASE. 
            END.  

            if (v_log_mod_apf and v_cod_mod <> "" /*l_*/ ) then do:
                assign v_log_portad_cx = no.

                &IF DEFINED(BF_FIN_CONSIST_APF) &THEN
                    run pi_verifica_param_aprov_apf (input  v_cod_empres_usuar,
                                                     input  antecip_pef_pend.cod_espec_docto,
                                                     input  no,
                                                     output v_log_param_apb_apf,
                                                     output v_ind_param_aprov_docto,
                                                     output v_log_aprov_impl_apf,
                                                     output v_log_aprov_pagto_apf).
                    if v_log_param_apb_apf and v_log_aprov_impl_apf then do:
                        find first portador no-lock
                             where portador.cod_portador = antecip_pef_pend.cod_portador no-error.
                        if avail portador and portador.ind_tip_portad = "Caixa" /*l_caixa*/  then
                            assign v_log_portad_cx = yes.
                    end.
                &ENDIF        

                if v_log_portad_cx = no then do:
                    if  valid-handle(v_hdl_api_centraliz_apb_apf)
                    then do:
                        run pi_valida_informacoes_apf in v_hdl_api_centraliz_apb_apf (Input recid(antecip_pef_pend)) /*pi_valida_informacoes_apf*/.
                        if return-value <> "OK" /*l_ok*/   then
                            undo save_block,leave save_block.
                    end /* if */.
                end.
            end.

            if  v_log_erro_epc then do:                                                            
                apply "entry" to antecip_pef_pend.cod_tit_ap in frame f_adp_02_antecip_pef_pend.
                undo save_block,leave save_block.                                                 
            end.

            assign input frame f_adp_02_antecip_pef_pend v_num_ord_compra
                   input frame f_adp_02_antecip_pef_pend v_num_ped_compra. /* v_num_event*/

            run pi_ix_p30_add_antecip_pef_pend (buffer antecip_pef_pend) /*pi_ix_p30_add_antecip_pef_pend*/.
            if return-value = "NOK" /*l_nok*/  then leave save_block.

            assign v_cod_portador_aux = antecip_pef_pend.cod_portador.

            run pi_ix_p30_add_antecip_pef_pend_aux /*pi_ix_p30_add_antecip_pef_pend_aux*/.

            &IF DEFINED(BF_FIN_CONSIST_APF) &THEN
                /* Verifica se deu alguma validaá∆o, se der n∆o pode gerar a pendencia no MLA. */
                if v_cod_portador_aux <> "" then do:
                    run pi_ix_p30_add_antecip_pef_gera_apf /*pi_ix_p30_add_antecip_pef_gera_apf*/.
                    if return-value <> "OK" /*l_ok*/  then
                        undo save_block,leave save_block.
                end.

                /* Begin_Include: i_eliminar_api_centraliza_apb_apf */
                /* Retira o API da Mem¢ria */
                if  valid-handle(v_hdl_api_centraliz_apb_apf)
                then do:
                    delete procedure v_hdl_api_centraliz_apb_apf.
                    assign v_hdl_api_centraliz_apb_apf = ?.
                end.
                /* End_Include: i_eliminar_api_centraliza_apb_apf */

            &ENDIF
            /* End_Include: ix_p30_add_antecip_pef_pend */

            assign v_log_save_ok = yes.
        end /* do save_block */.
    end /* repeat wait_block */.
    if avail antecip_pef_pend then
        assign v_rec_table    = recid(antecip_pef_pend).
               v_rec_antecip_pef_pend = recid(antecip_pef_pend).
end /* repeat main_block */.

/* ix_p35_add_antecip_pef_pend */

hide frame f_adp_02_antecip_pef_pend.

/* Begin_Include: ix_p40_add_antecip_pef_pend */
IF VALID-HANDLE(v_hdl_funcao_mex) THEN
    DELETE PROCEDURE v_hdl_funcao_mex.
/* End_Include: ix_p40_add_antecip_pef_pend */


/* Begin_Include: i_log_exec_prog_dtsul_fim */
if v_rec_log <> ? then do transaction:
    find log_exec_prog_dtsul where recid(log_exec_prog_dtsul) = v_rec_log exclusive-lock no-error.
    if  avail log_exec_prog_dtsul
    then do:
        assign log_exec_prog_dtsul.dat_fim_exec_prog_dtsul = today
               log_exec_prog_dtsul.hra_fim_exec_prog_dtsul = replace(string(time,"hh:mm:ss" /*l_hh:mm:ss*/ ),":":U,"":U).
    end /* if */.
    release log_exec_prog_dtsul.
end.

/* End_Include: i_log_exec_prog_dtsul_fim */



/******************************* Main Code End ******************************/

/************************* Internal Procedure Begin *************************/

/*****************************************************************************
** Procedure Interna.....: pi_save_key
** Descricao.............: pi_save_key
** Criado por............: 
** Criado em.............: // 
** Alterado por..........: tech493
** Alterado em...........: 23/01/2003 10:24:43
*****************************************************************************/
PROCEDURE pi_save_key:

    /************************* Variable Definition Begin ************************/

    def var v_log_msg
        as logical
        format "Sim/N∆o"
        initial no
        no-undo.
    def var v_rec_table_aux
        as recid
        format ">>>>>>9":U
        no-undo.


    /************************** Variable Definition End *************************/

    assign_block:
    do on error undo assign_block, return error:
        find b_antecip_pef_pend_add no-lock
             where b_antecip_pef_pend_add.cod_estab = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab
               and b_antecip_pef_pend_add.cod_refer = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_refer
    &if "{&emsfin_version}" >= "5.01" &then
             use-index antcppfp_id
    &endif
              /*cl_key_add of b_antecip_pef_pend_add*/ no-error.
        if  avail b_antecip_pef_pend_add
        then do:
    &if '{&ems_dbtype}' <> 'progress' &then
            do with frame f_adp_02_antecip_pef_pend:
            end.
            assign input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab
                   input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_refer no-error.
            assign v_rec_table_aux = recid(antecip_pef_pend) no-error.
            if  v_rec_table_aux = 0
            then do:
               assign v_log_msg = yes.
            end /* if */.
            else do:
               if  recid(b_antecip_pef_pend_add) <> recid(antecip_pef_pend)
               then do:
                  assign v_log_msg = yes.
               end /* if */.
            end /* else */.
            if  v_log_msg
            then do:
    &else
            if  recid(b_antecip_pef_pend_add) <> recid(antecip_pef_pend)
            then do:
    &endif
                /* &1 j† existente ! */
                run pi_messages (input "show",
                                 input 1,
                                 input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                    "Antecipaá∆o e PEF Pendente")) /*msg_1*/.
                undo assign_block, return error.
            end /* if */.
        end /* if */.
        else do:
            do with frame f_adp_02_antecip_pef_pend:
            end.
            assign input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab
                   input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_refer no-error.
    	  &if '{&ems_dbtype}' <> 'progress' &then
          	       assign v_rec_table_aux = recid(antecip_pef_pend) no-error.
    			if v_rec_table_aux = 0 
                     or  v_rec_table_aux = ?  then do:
                           /* &1 j† existente ! */
                           run pi_messages (input "show",
                                            input 1,
                                            input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                               "Antecipaá∆o e PEF Pendente")) /*msg_1*/.
                 undo assign_block, return error.
    			end.
            &endif.
        end /* else */.
    end /* do assign_block */.

END PROCEDURE. /* pi_save_key */
/*****************************************************************************
** Procedure Interna.....: pi_save_fields
** Descricao.............: pi_save_fields
** Criado por............: 
** Criado em.............: // 
** Alterado por..........: bre18856
** Alterado em...........: 18/04/2001 14:10:53
*****************************************************************************/
PROCEDURE pi_save_fields:

    assign_block:
    do on error undo assign_block, return error:
        do with frame f_adp_02_antecip_pef_pend:
            if  antecip_pef_pend.ind_favorec_cheq:visible      
            and antecip_pef_pend.ind_favorec_cheq:sensitive    
            and not (can-do("Portador,Fornecedor,Transferància,Outros,Cod Fornecedor", input antecip_pef_pend.ind_favorec_cheq)) then do:
                run pi_messages (input "show", input 616, input "Favorecido"). /*msg_616*/
                assign v_wgh_focus = antecip_pef_pend.ind_favorec_cheq:handle.
                apply "error".
            end.
        end.
        assign input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_espec_docto
               input frame f_adp_02_antecip_pef_pend antecip_pef_pend.dat_emis_docto
               input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_ser_docto
               input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_portador
               input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_tit_ap
               input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_indic_econ
               input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_parcela
               input frame f_adp_02_antecip_pef_pend antecip_pef_pend.val_tit_ap
               input frame f_adp_02_antecip_pef_pend v_ind_modo_pagto
               input frame f_adp_02_antecip_pef_pend antecip_pef_pend.ind_favorec_cheq
               input frame f_adp_02_antecip_pef_pend antecip_pef_pend.num_cheque
               input frame f_adp_02_antecip_pef_pend antecip_pef_pend.num_talon_cheq
               input frame f_adp_02_antecip_pef_pend antecip_pef_pend.nom_favorec_cheq
               input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_forma_pagto
               input frame f_adp_02_antecip_pef_pend antecip_pef_pend.dat_vencto_tit_ap
               input frame f_adp_02_antecip_pef_pend antecip_pef_pend.val_cotac_indic_econ.
        assign v_wgh_focus = ?.
    end /* do assign_block */.

    /* Foráar a criaá∆o do registro com bases Oracle */    if recid(antecip_pef_pend) <> ?  then.
END PROCEDURE. /* pi_save_fields */
/*****************************************************************************
** Procedure Interna.....: pi_copy_disp_fields
** Descricao.............: pi_copy_disp_fields
** Criado por............: 
** Criado em.............: // 
** Alterado por..........: gilsinei
** Alterado em...........: 07/11/1996 17:14:10
*****************************************************************************/
PROCEDURE pi_copy_disp_fields:

    find b_antecip_pef_pend_copy where recid(b_antecip_pef_pend_copy) = v_rec_table no-lock no-error.
    assign antecip_pef_pend.cod_empresa              = b_antecip_pef_pend_copy.cod_empresa
           antecip_pef_pend.cod_estab                = b_antecip_pef_pend_copy.cod_estab
    &if '{&emsfin_version}' >= "5.07" &then
           antecip_pef_pend.cod_estab                = b_antecip_pef_pend_copy.cod_estab
    &endif
           antecip_pef_pend.cod_espec_docto          = b_antecip_pef_pend_copy.cod_espec_docto
           antecip_pef_pend.cod_ser_docto            = b_antecip_pef_pend_copy.cod_ser_docto
           antecip_pef_pend.cdn_fornecedor           = b_antecip_pef_pend_copy.cdn_fornecedor
           antecip_pef_pend.cod_tit_ap               = b_antecip_pef_pend_copy.cod_tit_ap
           antecip_pef_pend.cod_parcela              = b_antecip_pef_pend_copy.cod_parcela
           antecip_pef_pend.cod_portador             = b_antecip_pef_pend_copy.cod_portador
           antecip_pef_pend.cod_indic_econ           = b_antecip_pef_pend_copy.cod_indic_econ
           antecip_pef_pend.cod_finalid_econ         = b_antecip_pef_pend_copy.cod_finalid_econ
           antecip_pef_pend.num_talon_cheq           = b_antecip_pef_pend_copy.num_talon_cheq
           antecip_pef_pend.num_cheque               = b_antecip_pef_pend_copy.num_cheque
           antecip_pef_pend.ind_favorec_cheq         = b_antecip_pef_pend_copy.ind_favorec_cheq
           antecip_pef_pend.nom_favorec_cheq         = b_antecip_pef_pend_copy.nom_favorec_cheq
           antecip_pef_pend.val_tit_ap               = b_antecip_pef_pend_copy.val_tit_ap
           antecip_pef_pend.val_cotac_indic_econ     = b_antecip_pef_pend_copy.val_cotac_indic_econ
           antecip_pef_pend.dat_emis_docto           = b_antecip_pef_pend_copy.dat_emis_docto
           antecip_pef_pend.dat_vencto_tit_ap        = b_antecip_pef_pend_copy.dat_vencto_tit_ap
           antecip_pef_pend.ind_tip_refer            = b_antecip_pef_pend_copy.ind_tip_refer
           antecip_pef_pend.cod_seguradora           = b_antecip_pef_pend_copy.cod_seguradora
           antecip_pef_pend.cod_apol_seguro          = b_antecip_pef_pend_copy.cod_apol_seguro
           antecip_pef_pend.cod_arrendador           = b_antecip_pef_pend_copy.cod_arrendador
           antecip_pef_pend.cod_contrat_leas         = b_antecip_pef_pend_copy.cod_contrat_leas
           antecip_pef_pend.cod_histor_padr          = b_antecip_pef_pend_copy.cod_histor_padr
           antecip_pef_pend.des_text_histor          = b_antecip_pef_pend_copy.des_text_histor
           antecip_pef_pend.ind_natur_cta_ctbl       = b_antecip_pef_pend_copy.ind_natur_cta_ctbl
           antecip_pef_pend.ind_sit_pef_antecip      = b_antecip_pef_pend_copy.ind_sit_pef_antecip
           antecip_pef_pend.num_pessoa               = b_antecip_pef_pend_copy.num_pessoa
           antecip_pef_pend.cod_usuar_gerac_movto    = b_antecip_pef_pend_copy.cod_usuar_gerac_movto
           antecip_pef_pend.dat_prev_pagto           = b_antecip_pef_pend_copy.dat_prev_pagto
           antecip_pef_pend.dat_desconto             = b_antecip_pef_pend_copy.dat_desconto
           antecip_pef_pend.cod_cart_bcia            = b_antecip_pef_pend_copy.cod_cart_bcia
           antecip_pef_pend.cod_forma_pagto          = b_antecip_pef_pend_copy.cod_forma_pagto
           antecip_pef_pend.cod_estab_portad_mutuo   = b_antecip_pef_pend_copy.cod_estab_portad_mutuo
    &if '{&emsfin_version}' >= "5.07" &then
           antecip_pef_pend.cod_estab_portad_mutuo   = b_antecip_pef_pend_copy.cod_estab_portad_mutuo
    &endif
           antecip_pef_pend.cod_portad_mutuo         = b_antecip_pef_pend_copy.cod_portad_mutuo
           antecip_pef_pend.log_incid_despes_bcia    = b_antecip_pef_pend_copy.log_incid_despes_bcia
    &if '{&emsfin_version}' >= "5.02" &then
           antecip_pef_pend.dsl_obs_tit_ap           = b_antecip_pef_pend_copy.dsl_obs_tit_ap
    &endif
    &if '{&emsfin_version}' >= "5.03" &then
           antecip_pef_pend.ind_origin_tit_ap        = b_antecip_pef_pend_copy.ind_origin_tit_ap
    &endif
    &if '{&emsfin_version}' >= "5.03" &then
           antecip_pef_pend.cod_usuar_pagto          = b_antecip_pef_pend_copy.cod_usuar_pagto
    &endif
    &if '{&emsfin_version}' >= "5.05" &then
           antecip_pef_pend.cb4_tit_ap_bco_cobdor    = b_antecip_pef_pend_copy.cb4_tit_ap_bco_cobdor
    &endif
    &if '{&emsfin_version}' >= "5.05" &then
           antecip_pef_pend.cod_tit_ap_bco_cobdor    = b_antecip_pef_pend_copy.cod_tit_ap_bco_cobdor
    &endif
    &if '{&emsfin_version}' >= "5.05" &then
           antecip_pef_pend.cod_sist_nac_bcio_cobdor = b_antecip_pef_pend_copy.cod_sist_nac_bcio_cobdor
    &endif
    &if '{&emsfin_version}' >= "5.06" &then
           antecip_pef_pend.cod_indic_econ_desemb    = b_antecip_pef_pend_copy.cod_indic_econ_desemb
    &endif
    &if '{&emsfin_version}' >= "5.06" &then
           antecip_pef_pend.cod_finalid_econ_desemb  = b_antecip_pef_pend_copy.cod_finalid_econ_desemb
    &endif
    &if '{&emsfin_version}' >= "5.06" &then
           antecip_pef_pend.num_ord_invest           = b_antecip_pef_pend_copy.num_ord_invest
    &endif
    &if '{&emsfin_version}' >= "5.06" &then
           antecip_pef_pend.num_ped_compra           = b_antecip_pef_pend_copy.num_ped_compra
    &endif
    &if '{&emsfin_version}' >= "5.06" &then
           antecip_pef_pend.num_ord_compra           = b_antecip_pef_pend_copy.num_ord_compra
    &endif
    &if '{&emsfin_version}' >= "5.06" &then
           antecip_pef_pend.num_event_invest         = b_antecip_pef_pend_copy.num_event_invest
    &endif
    &if '{&emsfin_version}' >= "5.06" &then
           antecip_pef_pend.cod_cta_corren_mutuo     = b_antecip_pef_pend_copy.cod_cta_corren_mutuo
    &endif
    &if '{&emsfin_version}' >= "5.08" &then
           antecip_pef_pend.log_zera_sdo_prev_provis = b_antecip_pef_pend_copy.log_zera_sdo_prev_provis
    &endif
    &if '{&emsfin_version}' >= "5.09" &then
           antecip_pef_pend.cod_safra                = b_antecip_pef_pend_copy.cod_safra
    &endif.


    /* Begin_Include: i_ref_antecip_pef_pend */
    find estabelecimento no-lock
         where estabelecimento.cod_estab = antecip_pef_pend.cod_estab
          no-error.
    find fornecedor no-lock
         where fornecedor.cdn_fornecedor = antecip_pef_pend.cdn_fornecedor
           and fornecedor.cod_empresa = antecip_pef_pend.cod_empresa
          no-error.
    find espec_docto no-lock
         where espec_docto.cod_espec_docto = antecip_pef_pend.cod_espec_docto
          no-error.

    /* **
     Mostra imagem Cta Corrente
    ***/
    run pi_mostra_imagem_cta_corren (Input "",
                                     Input antecip_pef_pend.cod_estab,
                                     Input antecip_pef_pend.cod_portador,
                                     Input antecip_pef_pend.cod_cart_bcia,
                                     Input antecip_pef_pend.cod_finalid_econ) /*pi_mostra_imagem_cta_corren*/.
    /* End_Include: i_ref_antecip_pef_pend */



    /* Begin_Include: ix_i15_add_antecip_pef_pend */
    if v_log_integr_safra_graos then do:
        &IF '{&emsfin_version}' >= '5.06' AND '{&emsfin_version}' < '5.09' &THEN
        assign v_cod_safra_graos = b_antecip_pef_pend_copy.cod_livre_2.
        &ENDIF
        &IF '{&emsfin_version}' >= '5.09' &THEN
        assign v_cod_safra_graos = b_antecip_pef_pend_copy.cod_safra.
        &ENDIF
        display v_cod_safra_graos with frame f_adp_02_antecip_pef_pend.
    end.

    &if defined(BF_FIN_MELHORIAS_INTEGR_GRAOS) &then
        if v_log_integr_graos then do:
            assign v_cod_safra_graos   = b_antecip_pef_pend_copy.cod_safra
                   v_cod_contrat_graos = b_antecip_pef_pend_copy.cod_contrat_graos.

            display v_cod_safra_graos
                    v_cod_contrat_graos with frame f_adp_02_antecip_pef_pend.
        end.
    &endif
    /* End_Include: ix_i15_add_antecip_pef_pend */

    display antecip_pef_pend.cod_espec_docto
            antecip_pef_pend.dat_emis_docto
            antecip_pef_pend.cod_ser_docto
            antecip_pef_pend.cod_portador
            antecip_pef_pend.cod_tit_ap
            antecip_pef_pend.cod_indic_econ
            antecip_pef_pend.cod_parcela
            antecip_pef_pend.val_tit_ap
            v_ind_modo_pagto
            antecip_pef_pend.ind_favorec_cheq
            antecip_pef_pend.num_cheque
            antecip_pef_pend.num_talon_cheq
            antecip_pef_pend.nom_favorec_cheq
            antecip_pef_pend.cod_forma_pagto
            antecip_pef_pend.dat_vencto_tit_ap
            antecip_pef_pend.val_cotac_indic_econ
            with frame f_adp_02_antecip_pef_pend.
    display estabelecimento.nom_pessoa when avail estabelecimento
            "" when not avail estabelecimento @ estabelecimento.nom_pessoa
            fornecedor.cod_pais when avail fornecedor
            "" when not avail fornecedor @ fornecedor.cod_pais
            fornecedor.nom_abrev when avail fornecedor
            "" when not avail fornecedor @ fornecedor.nom_abrev
            with frame f_adp_02_antecip_pef_pend.
    /* ix_i20_add_antecip_pef_pend */
END PROCEDURE. /* pi_copy_disp_fields */
/*****************************************************************************
** Procedure Interna.....: pi_vld_antecip_pef_pend
** Descricao.............: pi_vld_antecip_pef_pend
** Criado por............: rafael
** Criado em.............: // 
** Alterado por..........: jeffersonsil
** Alterado em...........: 03/05/2017 17:12:49
*****************************************************************************/
PROCEDURE pi_vld_antecip_pef_pend:

    /************************* Variable Definition Begin ************************/

    def var v_cod_erro_param
        as character
        format "x(50)":U
        no-undo.
    def var v_cod_finalid_econ
        as character
        format "x(10)":U
        label "Finalidade Econìmica"
        column-label "Finalidade Econìmica"
        no-undo.
    def var v_cod_parameters
        as character
        format "x(256)":U
        no-undo.
    def var v_cod_return
        as character
        format "x(40)":U
        no-undo.
    def var v_des_param
        as character
        format "x(50)":U
        label "Param"
        column-label "Param"
        no-undo.
    def var v_ind_finalid_ctbl_err
        as character
        format "X(30)":U
        label "Finalidade Cont†bil"
        column-label "Finalidade Cont†bil"
        no-undo.
    def var v_log_answer
        as logical
        format "Sim/N∆o"
        initial yes
        view-as toggle-box
        no-undo.
    def var v_log_bloq_pagto
        as logical
        format "Sim/N∆o"
        initial no
        view-as toggle-box
        label "Bloqueia Pagamento"
        no-undo.
    def var v_log_fornec_aux
        as logical
        format "Sim/N∆o"
        initial no
        view-as toggle-box
        no-undo.
    def var v_log_impto_vincul_refer
        as logical
        format "Sim/N∆o"
        initial yes
        no-undo.
    def var v_log_refer_uni
        as logical
        format "Sim/N∆o"
        initial yes
        no-undo.
    def var v_log_retorno
        as logical
        format "Sim/N∆o"
        initial no
        no-undo.
    def var v_log_tit_ap_unico
        as logical
        format "Sim/N∆o"
        initial yes
        label "T°tulo Ènico"
        column-label "T°tulo Ènico"
        no-undo.
    def var v_nom_favorec_cheq
        as character
        format "x(40)":U
        label "Favorecido"
        column-label "Nome Favorecido"
        no-undo.
    def var v_num_erro
        as integer
        format ">>>>,>>9":U
        no-undo.
    def var v_val_aux
        as decimal
        format "->>,>>>,>>>,>>9.99":U
        decimals 2
        initial 0
        no-undo.
    def var v_val_lim_liber_usuar_mes
        as decimal
        format "->>,>>>,>>>,>>9.99":U
        decimals 2
        label "Limite Màs"
        column-label "Limite Màs"
        no-undo.
    def var v_val_lim_liber_usuar_movto
        as decimal
        format "->>>,>>>,>>9.99":U
        decimals 2
        label "Limite Movimento"
        column-label "Limite Movimento"
        no-undo.
    def var v_val_lim_pagto_usuar_mes
        as decimal
        format "->>,>>>,>>>,>>9.99":U
        decimals 2
        label "Limite Màs"
        column-label "Limite Màs"
        no-undo.
    def var v_val_lim_pagto_usuar_movto
        as decimal
        format "->>>,>>>,>>9.99":U
        decimals 2
        label "Limite Movimento"
        column-label "Limite Movimento"
        no-undo.
    def var v_val_sdo_rat_tit_ap
        as decimal
        format "->>>,>>>,>>9.99":U
        decimals 2
        label "Saldo a Ratear"
        column-label "Saldo a Ratear"
        no-undo.
    def var v_val_tot_impto
        as decimal
        format "->>>,>>>,>>9.99":U
        decimals 2
        label "Total a Ratear"
        column-label "Valor Total a Ratear"
        no-undo.
    def var v_val_tot_liq
        as decimal
        format "->>>,>>>,>>>,>>9.99":U
        decimals 2
        label "Total L°quido"
        column-label "Total L°quido"
        no-undo.


    /************************** Variable Definition End *************************/

    /* ** Elimina registros de erros anteriores. ***/
    for each tt_log_erros_tit_antecip exclusive-lock:
        delete tt_log_erros_tit_antecip.
    end.

    bloco1:
    do on error undo bloco1, return error:
        &if '{&frame_aux}' = "" &then
            &if '{&emsfin_version}' >= '5.03' &then
                find modul_dtsul
                     where modul_dtsul.cod_modul_dtsul = antecip_pef_pend.ind_origin_tit_ap
                     no-lock no-error.
                if not avail modul_dtsul then do:
                    assign v_num_mensagem   = 8433
                           v_cod_parameters = "M¢dulo" + "," + "M¢dulos" + "," + antecip_pef_pend.ind_origin_tit_ap.     
                    run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + &IF '{&emsfin_version}' >= '5.01' AND '{&emsfin_version}' <= '5.07' &THEN "cod_estab" &ELSE "cod_estab" &ENDIF,
                                                     Input antecip_pef_pend.cod_estab,
                                                     Input antecip_pef_pend.cod_refer,
                                                     Input 0,
                                                     Input "",
                                                     Input 0,
                                                     Input v_num_mensagem,
                                                     Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.
                end.
            &endif
        &endif
        if  antecip_pef_pend.val_tit_ap = 0 then do:
            assign v_num_mensagem   = 6862
                   v_cod_parameters = ''.
            run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + "val_tit_ap",
                                             Input antecip_pef_pend.cod_estab,
                                             Input antecip_pef_pend.cod_refer,
                                             Input 0,
                                             Input "",
                                             Input 0,
                                             Input v_num_mensagem,
                                             Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.
        end.

        find first histor_finalid_econ no-lock 
             where histor_finalid_econ.cod_indic_econ          = antecip_pef_pend.cod_indic_econ
             and   histor_finalid_econ.dat_inic_valid_finalid <= today 
             and   histor_finalid_econ.dat_fim_valid_finalid  >= today no-error. 
        if  not avail histor_finalid_econ then do:
            assign v_num_mensagem   = 9509 /* msg_9509 */
                   v_cod_parameters = antecip_pef_pend.cod_indic_econ + "," + string(today).
            run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + "cod_indic_econ",
                                             Input antecip_pef_pend.cod_estab,
                                             Input antecip_pef_pend.cod_refer,
                                             Input 0,
                                             Input "",
                                             Input 0,
                                             Input v_num_mensagem,
                                             Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.
        end.

        assign antecip_pef_pend.dat_prev_pagto = antecip_pef_pend.dat_vencto_tit_ap.
        run pi_retornar_finalid_indic_econ (Input antecip_pef_pend.cod_indic_econ,
                                            Input antecip_pef_pend.dat_emis_docto,
                                            output v_cod_finalid_econ) /*pi_retornar_finalid_indic_econ*/.
        assign antecip_pef_pend.cod_finalid_econ = v_cod_finalid_econ.

        if  antecip_pef_pend.val_cotac_indic_econ = 0
         or antecip_pef_pend.val_cotac_indic_econ = ? then do:
            assign v_num_mensagem   = 14306 /* msg_14306 */
                   v_cod_parameters = "".
            run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + "cod_indic_econ",
                                             Input antecip_pef_pend.cod_estab,
                                             Input antecip_pef_pend.cod_refer,
                                             Input 0,
                                             Input "",
                                             Input 0,
                                             Input v_num_mensagem,
                                             Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/. 
        end.

    /* **    
        @run (pi_retornar_sit_movimen_modul(@%(l_apb),
                                          antecip_pef_pend.cod_empresa,
                                          antecip_pef_pend.dat_emis_docto,
                                          @%(l_habilitado),
                                          v_cod_return)).
        @if(not can-do(v_cod_return, @%(l_habilitado)))
            assign v_num_mensagem   = 1628
                   v_cod_parameters = antecip_pef_pend.cod_estab + "," + @%(l_apb) + "," + string(antecip_pef_pend.dat_emis_docto).
            @run(pi_integr_apb_cria_msg_erro(@fx_tabpro( antecip_pef_pend, name ) + "." + @fx_objpro( cod_estab,name),
                                             antecip_pef_pend.cod_estab,
                                             antecip_pef_pend.cod_refer,
                                             0, "", 0,
                                             v_num_mensagem, v_cod_parameters)).        

        @end_if().    
     Retirado por gilmar em 30/03/99 **/    

        /* VALIDAÄ«O REFER“NCIA*/
        if  antecip_pef_pend.cod_refer = "" then do:
            assign v_num_mensagem   = 7168.
            run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + "cod_refer",
                                             Input antecip_pef_pend.cod_estab,
                                             Input antecip_pef_pend.cod_refer,
                                             Input 0,
                                             Input "",
                                             Input 0,
                                             Input v_num_mensagem,
                                             Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.
            /* @apply(entry) @&(table).cod_refer in frame @&(frame). */
        end.


        /* --- Valida ParÉmetros do Estabelecimento do Usu†rio ---*/
        find last param_estab_apb no-lock
            where param_estab_apb.cod_estab = antecip_pef_pend.cod_estab
            no-error.
        if  not avail param_estab_apb
        then do:
            assign v_num_mensagem   = 2075
                   v_cod_parameters = antecip_pef_pend.cod_estab.
            run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + &IF '{&emsfin_version}' >= '5.01' AND '{&emsfin_version}' <= '5.07' &THEN "cod_estab" &ELSE "cod_estab" &ENDIF,
                                             Input antecip_pef_pend.cod_estab,
                                             Input antecip_pef_pend.cod_refer,
                                             Input 0,
                                             Input "",
                                             Input 0,
                                             Input v_num_mensagem,
                                             Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.        
        end /* if */.

        if  avail param_estab_apb
        then do:
          if   antecip_pef_pend.dat_emis_docto < param_estab_apb.dat_inic_movimen then do:
            assign v_num_mensagem   = 8810
                   v_cod_parameters = string(antecip_pef_pend.dat_emis_docto) + "," + string(param_estab_apb.dat_inic_movimen).
            run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + "dat_emis_docto",
                                             Input antecip_pef_pend.cod_estab,
                                             Input antecip_pef_pend.cod_refer,
                                             Input 0,
                                             Input "",
                                             Input 0,
                                             Input v_num_mensagem,
                                             Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.        
          end.
        end /* if */.


        if  antecip_pef_pend.dat_emis_docto > antecip_pef_pend.dat_vencto_tit_ap then do:
            assign v_num_mensagem   = 761.
            run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + "dat_vencto_tit_ap",
                                             Input antecip_pef_pend.cod_estab,
                                             Input antecip_pef_pend.cod_refer,
                                             Input 0,
                                             Input "",
                                             Input 0,
                                             Input v_num_mensagem,
                                             Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.
        end.

        if   v_cod_tip_valid = "Inclus∆o" /*l_inclusao*/  then do:
            find estabelecimento
                where estabelecimento.cod_estab = antecip_pef_pend.cod_estab
                no-lock no-error.
            if  not avail estabelecimento then do:
                assign v_num_mensagem   = 1284
                       v_cod_parameters = "Estabelecimento" /*l_estabelecimento*/  + "," + "Estabelecimentos" /*l_estabelecimentos*/ .
                run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + &IF '{&emsfin_version}' >= '5.01' AND '{&emsfin_version}' <= '5.07' &THEN "cod_estab" &ELSE "cod_estab" &ENDIF,
                                                 Input antecip_pef_pend.cod_estab,
                                                 Input antecip_pef_pend.cod_refer,
                                                 Input 0,
                                                 Input "",
                                                 Input 0,
                                                 Input v_num_mensagem,
                                                 Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.
            end.

            run pi_validar_estab (Input antecip_pef_pend.cod_empresa,
                                  Input antecip_pef_pend.cod_estab,
                                  Input antecip_pef_pend.dat_emis_docto,
                                  output v_cod_return) /* pi_validar_estab*/.

            if  v_cod_return = "Unidade Organizacional" /*l_unid_organ*/  then do:
                assign v_num_mensagem   = 347.
                run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + &IF '{&emsfin_version}' >= '5.01' AND '{&emsfin_version}' <= '5.07' &THEN "cod_estab" &ELSE "cod_estab" &ENDIF,
                                                 Input antecip_pef_pend.cod_estab,
                                                 Input antecip_pef_pend.cod_refer,
                                                 Input 0,
                                                 Input "",
                                                 Input 0,
                                                 Input v_num_mensagem,
                                                 Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.
                &if '{&frame_aux}' <> "" &then
                    if  antecip_pef_pend.cod_estab:sensitive in frame f_adp_02_antecip_pef_pend = no then
                        assign v_wgh_focus = ?.
                &endif                                   
            end.
            if  v_cod_return = "Empresa" /*l_empresa*/  then do:
                assign v_num_mensagem   = 512.
                run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + &IF '{&emsfin_version}' >= '5.01' AND '{&emsfin_version}' <= '5.07' &THEN "cod_estab" &ELSE "cod_estab" &ENDIF,
                                                 Input antecip_pef_pend.cod_estab,
                                                 Input antecip_pef_pend.cod_refer,
                                                 Input 0,
                                                 Input "",
                                                 Input 0,
                                                 Input v_num_mensagem,
                                                 Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.
                &if '{&frame_aux}' <> "" &then
                    if  antecip_pef_pend.cod_estab:sensitive in frame f_adp_02_antecip_pef_pend = no then
                        assign v_wgh_focus = ?.
                &endif                                   
            end.
            if  v_cod_return = "Usu†rio" /*l_usuario*/  then do:
                assign v_num_mensagem   = 348.
                run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + &IF '{&emsfin_version}' >= '5.01' AND '{&emsfin_version}' <= '5.07' &THEN "cod_estab" &ELSE "cod_estab" &ENDIF,
                                                 Input antecip_pef_pend.cod_estab,
                                                 Input antecip_pef_pend.cod_refer,
                                                 Input 0,
                                                 Input "",
                                                 Input 0,
                                                 Input v_num_mensagem,
                                                 Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.
                &if '{&frame_aux}' <> "" &then
                    if  antecip_pef_pend.cod_estab:sensitive in frame f_adp_02_antecip_pef_pend = no then
                        assign v_wgh_focus = ?.
                &endif                                   
            end.

            /* case_block: */
            case v_cod_return:
                when "no" /*l_no*/ then
                    no_block:
                    do:
                        assign v_num_mensagem   = 701
                        v_cod_parameters = v_cod_usuar_corren + "," + "Implantar" /*l_implantar*/ .
            /* * Na API s¢ valida se usu†rio tem permiss∆o para implantar, quando a origem do t°tulo for "APB" **/
                        &if '{&frame_aux}' = "" &then            
                            &if '{&emsfin_version}' >= '5.03' &then
                                if antecip_pef_pend.ind_origin_tit_ap = "APB" /*l_apb*/  then
                                    run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + &IF '{&emsfin_version}' >= '5.01' AND '{&emsfin_version}' <= '5.07' &THEN "cod_estab" &ELSE "cod_estab" &ENDIF,
                                                                     Input antecip_pef_pend.cod_estab,
                                                                     Input antecip_pef_pend.cod_refer,
                                                                     Input 0,
                                                                     Input "",
                                                                     Input 0,
                                                                     Input v_num_mensagem,
                                                                     Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.                
                            &endif                                                                             
                        &else
                            run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + &IF '{&emsfin_version}' >= '5.01' AND '{&emsfin_version}' <= '5.07' &THEN "cod_estab" &ELSE "cod_estab" &ENDIF,
                                                             Input antecip_pef_pend.cod_estab,
                                                             Input antecip_pef_pend.cod_refer,
                                                             Input 0,
                                                             Input "",
                                                             Input 0,
                                                             Input v_num_mensagem,
                                                             Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.                                                                    
                        &endif

                        &if '{&frame_aux}' <> "" &then
                            if  antecip_pef_pend.cod_estab:sensitive in frame f_adp_02_antecip_pef_pend = no then
                                assign v_wgh_focus = ?.
                        &endif                                   
                    end /* do no_block */.
                when "602" then
                    602_block:
                    do:
                        assign v_num_mensagem   = 602.
                        run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + &IF '{&emsfin_version}' >= '5.01' AND '{&emsfin_version}' <= '5.07' &THEN "cod_estab" &ELSE "cod_estab" &ENDIF,
                                                         Input antecip_pef_pend.cod_estab,
                                                         Input antecip_pef_pend.cod_refer,
                                                         Input 0,
                                                         Input "",
                                                         Input 0,
                                                         Input v_num_mensagem,
                                                         Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.        
                        &if '{&frame_aux}' <> "" &then
                            if  antecip_pef_pend.cod_estab:sensitive in frame f_adp_02_antecip_pef_pend = no then
                                assign v_wgh_focus = ?.
                        &endif                                   
                    end /* do 602_block */.
            end /* case case_block */.

            run pi_verifica_refer_unica_apb 

            (Input antecip_pef_pend.cod_estab,
             Input antecip_pef_pend.cod_refer,
             Input "antecip_pef_pend" /*l_antecip_pef_pend*/ ,
             Input ?,
             output v_log_refer_uni) /* pi_verifica_refer_unica_apb*/.

            if  v_log_refer_uni = no then do:
                assign v_num_mensagem   = 742.
                run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + "cod_refer",
                                                 Input antecip_pef_pend.cod_estab,
                                                 Input antecip_pef_pend.cod_refer,
                                                 Input 0,
                                                 Input "",
                                                 Input 0,
                                                 Input v_num_mensagem,
                                                 Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.                                
                &if '{&frame_aux}' <> "" &then
                    run pi_retorna_sugestao_referencia (Input "a" /*l_A*/ ,
                                                        Input today,
                                                        output v_cod_refer).

                    assign v_log_existe = yes.
                    do while v_log_existe = yes:
                        if not can-find(first antecip_pef_pend no-lock
                                        where antecip_pef_pend.cod_estab = antecip_pef_pend.cod_estab
                                          and antecip_pef_pend.cod_refer = v_cod_refer) then
                            assign v_log_existe = no.
                        else
                            run pi_retorna_sugestao_referencia (Input "a" /*l_A*/ ,
                                                                Input today,
                                                                output v_cod_refer).
                    end.



                    /* Begin_Include: i_executa_pi_epc_fin_refer */
                    if  v_nom_prog_upc  <> ''    
                    or  v_nom_prog_appc <> ''
                    or  v_nom_prog_dpc  <> '' then do:

                        run pi_limpa_retorno /*pi_limpa_retorno*/.


                        /* Begin_Include: i_executa_pi_epc_fin */
                        run pi_exec_program_epc_FIN (Input 'retorna_sugestao_referencia',
                                                     Input 'no',
                                                     output v_log_return_epc) /*pi_exec_program_epc_FIN*/.
                        if v_log_return_epc then /* epc retornou erro*/
                            undo, retry.
                        /* End_Include: i_executa_pi_epc_fin */


                        /* Somente vai entrar se for o banrisul */
                        if return-value = 'BRSL' then do:
                            run pi_retorna_sugestao_referencia_epc (Input "a" /*l_A*/ ,
                                                                    Input today,
                                                                    output v_cod_refer).
                        end.

                        run pi_limpa_retorno /*pi_limpa_retorno*/.
                    end.

                    /* End_Include: i_executa_pi_epc_fin */


                    assign antecip_pef_pend.cod_refer:screen-value in frame f_adp_02_antecip_pef_pend = v_cod_refer.
                &endif                                
            end.
        end.


        /* Begin_Include: i_pi_vld_antecip_pef_pend */
        find espec_docto no-lock
             where espec_docto.cod_espec_docto = antecip_pef_pend.cod_espec_docto no-error.
        if  not avail espec_docto then do:
            assign v_num_mensagem   = 1284
                   v_cod_parameters = "EspÇcie Docto" /*l_especie_docto*/  + "," + "Antecipaá∆o" /*l_antecipacao*/ .
            run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + "cod_espec_docto",
                                             Input antecip_pef_pend.cod_estab,
                                             Input antecip_pef_pend.cod_refer,
                                             Input 0,
                                             Input "",
                                             Input 0,
                                             Input v_num_mensagem,
                                             Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.    
        end.
        else do:
            if  espec_docto.ind_tip_espec_docto <> "Antecipaá∆o" /*l_antecipacao*/  then do:
                assign v_num_mensagem   = 985.
                run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + "ind_tip_espec_docto",
                                                 Input antecip_pef_pend.cod_estab,
                                                 Input antecip_pef_pend.cod_refer,
                                                 Input 0,
                                                 Input "",
                                                 Input 0,
                                                 Input v_num_mensagem,
                                                 Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.
            end.

            find espec_docto_financ
                where espec_docto_financ.cod_espec_docto = antecip_pef_pend.cod_espec_docto no-lock no-error.
            if  not avail espec_docto_financ then do:
                assign v_num_mensagem   = 1284
                       v_cod_parameters = "EspÇcie Documento Financeira" /*l_espec_docto_financ*/  + "," + "EspÇcies Documento Financeiras" /*l_especies_docto_financ*/ .
                run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + "cod_espec_docto",
                                                 Input antecip_pef_pend.cod_estab,
                                                 Input antecip_pef_pend.cod_refer,
                                                 Input 0,
                                                 Input "",
                                                 Input 0,
                                                 Input v_num_mensagem,
                                                 Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.                         
            end.

            else do:
                &if defined(BF_FIN_ALTERACOES_TITULO_APB) &then
                if espec_docto_financ.log_impl_online = no then do:
                    assign v_num_mensagem   = 20637
                           v_cod_parameters = "".
                    run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + "cod_espec_docto",
                                                     Input antecip_pef_pend.cod_estab,
                                                     Input antecip_pef_pend.cod_refer,
                                                     Input 0,
                                                     Input "",
                                                     Input 0,
                                                     Input v_num_mensagem,
                                                     Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.
                end.
                &endif
            end.

            if avail espec_docto_financ and espec_docto_financ.log_emis_bord = NO AND v_ind_modo_pagto = "Borderì" /*l_bordero*/  THEN DO:
               assign v_num_mensagem   = 12027
                      v_cod_parameters = espec_docto_financ.cod_espec_docto + "," + antecip_pef_pend.cod_estab  + "," + antecip_pef_pend.cod_refer.
               run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + "cod_espec_docto",
                                                Input antecip_pef_pend.cod_estab,
                                                Input antecip_pef_pend.cod_refer,
                                                Input 0,
                                                Input "",
                                                Input 0,
                                                Input v_num_mensagem,
                                                Input v_cod_parameters) /* pi_integr_apb_cria_msg_erro*/.
            end.
        end.
        /* End_Include: i_pi_vld_antecip_pef_pend */


        find fornecedor
            where fornecedor.cod_empresa    = antecip_pef_pend.cod_empresa
            and   fornecedor.cdn_fornecedor = antecip_pef_pend.cdn_fornecedor
            no-lock no-error.
        if  not avail fornecedor then do:
            assign v_num_mensagem   = 1284
                   v_cod_parameters = "Fornecedor" /*l_fornecedor*/  + "," + "Fornecedores" /*l_fornecedores*/ .
            run pi_integr_apb_cria_msg_erro (Input "v_cod_fornec_infor",
                                             Input antecip_pef_pend.cod_estab,
                                             Input antecip_pef_pend.cod_refer,
                                             Input 0,
                                             Input "",
                                             Input 0,
                                             Input v_num_mensagem,
                                             Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.                                             
        end.
        else do:
            find fornec_financ
                where fornec_financ.cod_empresa    = antecip_pef_pend.cod_empresa
                and   fornec_financ.cdn_fornecedor = antecip_pef_pend.cdn_fornecedor no-lock 
                no-error.
            if  not avail fornec_financ then do:
                assign v_num_mensagem   = 1284
                       v_cod_parameters = "Fornecedor Financeiro" /*l_fornecedor_financeiro*/  + "," + "Fornecedores Financeiros" /*l_fornecedores_financeiros*/ .
                run pi_integr_apb_cria_msg_erro (Input "v_cod_fornec_infor",
                                                 Input antecip_pef_pend.cod_estab,
                                                 Input antecip_pef_pend.cod_refer,
                                                 Input 0,
                                                 Input "",
                                                 Input 0,
                                                 Input v_num_mensagem,
                                                 Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.    
            end.
            else do:
                if fornec_financ.log_pagto_bloqdo = yes
                and antecip_pef_pend.cod_portador <> ""
                then do:
                    assign v_num_mensagem   = 794
                           v_cod_parameters = ''.
                    run pi_integr_apb_cria_msg_erro (Input "v_cod_fornec_infor",
                                                     Input antecip_pef_pend.cod_estab,
                                                     Input antecip_pef_pend.cod_refer,
                                                     Input 0,
                                                     Input "",
                                                     Input 0,
                                                     Input v_num_mensagem,
                                                     Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.  
                end.
            end.

            /* utiliza pais do fornecedor para encontrar dia util */
            assign v_cod_pais_fornec_clien = fornecedor.cod_pais.
            run pi_vld_praz_impl(input antecip_pef_pend.cod_estab, 
                                 input antecip_pef_pend.dat_vencto_tit_ap , 
                                 input yes, 
                                 input no, 
                                 output v_num_erro,
                                 output v_cod_erro_param).
            if return-value <> "OK" /*l_ok*/  then do:
                assign v_num_mensagem   = v_num_erro
                       v_cod_parameters = v_cod_erro_param.
                run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + "dat_vencto_tit_ap",
                                                 Input antecip_pef_pend.cod_estab,
                                                 Input antecip_pef_pend.cod_refer,
                                                 Input 0,
                                                 Input "",
                                                 Input 0,
                                                 Input v_num_mensagem,
                                                 Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.
            end.

        end.
        &IF DEFINED(BF_FIN_AUMENTO_DIGITO_NF) = 0 &THEN /* igual a 0 significa que n∆o tem a funá∆o definida */
            if  length(antecip_pef_pend.cod_tit_ap) > 10
            then do:
                assign v_num_mensagem   = 18509
                       v_cod_parameters = "T°tulo" + "," + '10'.                          
                run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + "cod_tit_ap",
                                                 Input antecip_pef_pend.cod_estab,
                                                 Input antecip_pef_pend.cod_refer,
                                                 Input 0,
                                                 Input "",
                                                 Input 0,
                                                 Input v_num_mensagem,
                                                 Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.
            end /* if */.
            if  length(antecip_pef_pend.cod_ser_docto) > 3
            then do:
                assign v_num_mensagem   = 18509
                       v_cod_parameters = "SÇrie Documento" + "," + '3'.
                run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + "cod_ser_docto",
                                                 Input antecip_pef_pend.cod_estab,
                                                 Input antecip_pef_pend.cod_refer,
                                                 Input 0,
                                                 Input "",
                                                 Input 0,
                                                 Input v_num_mensagem,
                                                 Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.
            end /* if */.
        &ENDIF
        if antecip_pef_pend.cod_tit_ap = "" then do:
           assign v_num_mensagem   = 10500.
           run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + "cod_tit_ap",
                                            Input antecip_pef_pend.cod_estab,
                                            Input antecip_pef_pend.cod_refer,
                                            Input 0,
                                            Input "",
                                            Input 0,
                                            Input v_num_mensagem,
                                            Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.        
        end. 

        IF VALID-HANDLE(v_hdl_funcao_mex) 

        AND v_ind_modo_pagto = "Dinheiro" /*l_dinheiro*/  

            THEN DO:

                assign v_val_cotac_indic_econ = 1
                       v_log_fornec_aux       = YES.

                /* Busca moeda corrente do estabelecimento */
                 run pi_retornar_indic_econ_corren_estab

                                                         (INPUT  antecip_pef_pend.cod_estab,
                                                          INPUT  antecip_pef_pend.dat_emis_docto,
                                                          OUTPUT v_cod_indic_econ).

                /* Verifica se a moeda do registro Ç a moeda corrente */
                if v_cod_indic_econ <> antecip_pef_pend.cod_indic_econ then do:
                     run pi_achar_cotac_indic_econ  

                                                   (INPUT  antecip_pef_pend.cod_indic_econ,
                                                    INPUT  v_cod_indic_econ,
                                                    INPUT  antecip_pef_pend.dat_emis_docto,
                                                    INPUT  "Real" /*l_real*/ ,
                                                    OUTPUT v_dat_cotac_indic_econ,
                                                    OUTPUT v_val_cotac_indic_econ,
                                                    OUTPUT v_cod_return).
                    if v_cod_return <> "OK" /*l_ok*/  then do:
                        run pi_cria_tt_erros_cotac_parid (Input antecip_pef_pend.cod_indic_econ,
                                                          Input v_cod_indic_econ,
                                                          Input v_cod_return) /*pi_cria_tt_erros_cotac_parid*/.
                        return "NOK" /*l_nok*/ .
                    end.
                end.

                RUN pi_identif_fornec_nacional IN v_hdl_funcao_mex (INPUT  antecip_pef_pend.cod_empresa,
                                                                    INPUT  antecip_pef_pend.cdn_fornecedor,
                                                                    OUTPUT v_log_fornec_aux).           


                /* Para pagamentos em moeda estrangeira, a validaá∆o do valor l°quido
                   de pagamento s¢ dever† ser efetuada caso o fornecedor seja nacional */
                IF v_log_fornec_aux THEN DO:

                    run 'prgfin/apb/apb794za.py' (Input antecip_pef_pend.cod_estab,
                                            Input antecip_pef_pend.cod_refer,
                                            Input "" /*l_*/ ,
                                            Input 0,
                                            Input 0,
                                            Input yes,
                                            Input antecip_pef_pend.dat_emis_docto,
                                            Input "Retido" /*l_retido*/ ,
                                            output v_log_impto_vincul_refer,
                                            output v_val_tot_impto,
                                            Input recid(bord_ap),
                                            Input recid(cheq_ap),
                                            Input recid(item_lote_pagto)) /* prg_fnc_verificar_impto_vincul_refer*/.



                    ASSIGN v_val_tot_liq = (antecip_pef_pend.val_tit_ap - v_val_tot_impto) / v_val_cotac_indic_econ.

                    RUN pi_validar_bloq_pagto_bord IN v_hdl_funcao_mex (Input antecip_pef_pend.cod_empresa,
                                                                        Input v_val_tot_liq,
                                                                        OUTPUT v_log_retorno,
                                                                        OUTPUT v_log_bloq_pagto).
                    /* Indica se a mensagem deverˇser mostrada ou n∆o.
                    este parÉmetro retorna que o valor≤ superior ao parametrizado */
                    IF v_log_retorno THEN DO:
                        &if '{&frame_aux}' <> "" &then
                            RUN pi_mensagens_bord IN v_hdl_funcao_mex (INPUT  antecip_pef_pend.cod_empresa,
                                                                       INPUT  v_val_tot_liq,
                                                                       INPUT  v_log_bloq_pagto,
                                                                       OUTPUT v_log_retorno).
                        &else
                            assign v_cod_parameters = String(v_val_tot_liq,"->>,>>>,>>>,>>9.99") + "," + antecip_pef_pend.cod_empresa + ",,,,,,,,".
                            run pi_integr_apb_cria_msg_erro (Input 'antecip_pef_pend':U + '.' + 'cod_estab',
                                                             Input antecip_pef_pend.cod_estab,
                                                             Input antecip_pef_pend.cod_refer,
                                                             Input 0,
                                                             Input "" /*l_*/  , 
                                                             Input 0,
                                                             Input 18139,
                                                             Input v_cod_parameters) /* pi_integr_apb_cria_msg_erro*/.

                            return error.
                        &endif                                                    
                        IF v_log_retorno THEN
                            RETURN "NOK" /*l_nok*/ .
                    END.
                END.

        END.

        /* ## Foi criada a pi abaixo para continuar as validaá‰es.  ##*/
        run pi_vld_antecip_pef_pend_more /*pi_vld_antecip_pef_pend_more*/.
    end /* do bloco1 */.
END PROCEDURE. /* pi_vld_antecip_pef_pend */
/*****************************************************************************
** Procedure Interna.....: pi_validar_indic_econ_movto
** Descricao.............: pi_validar_indic_econ_movto
** Criado por............: 
** Criado em.............: // 
** Alterado por..........: fut40574
** Alterado em...........: 28/01/2008 09:49:33
*****************************************************************************/
PROCEDURE pi_validar_indic_econ_movto:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_indic_econ
        as character
        format "x(8)"
        no-undo.
    def Input param p_dat_transacao
        as date
        format "99/99/9999"
        no-undo.
    def Input param p_cod_unid_organ
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def output param p_cod_return
        as character
        format "x(40)"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_cod_return
        as character
        format "x(40)":U
        no-undo.


    /************************** Variable Definition End *************************/

    run pi_validar_indic_econ_valid (Input p_cod_indic_econ,
                                     Input p_dat_transacao,
                                     output p_cod_return) /*pi_validar_indic_econ_valid*/.
    if  p_cod_return <> "OK" /*l_ok*/ 
    then do:
        return.
    end /* if */.

    find first histor_finalid_econ no-lock
         where histor_finalid_econ.cod_indic_econ = p_cod_indic_econ
           and histor_finalid_econ.dat_inic_valid_finalid <= p_dat_transacao
           and histor_finalid_econ.dat_fim_valid_finalid > p_dat_transacao /*cl_indic_econ_ativo of histor_finalid_econ*/ no-error.
    if  not avail histor_finalid_econ
    then do:
        assign p_cod_return = "336".
        return.
    end /* if */.

    find finalid_econ no-lock
         where finalid_econ.cod_finalid_econ = histor_finalid_econ.cod_finalid_econ

           and finalid_econ.log_infor_val = yes /*cl_log_infor_val of finalid_econ*/ no-error.
    if  not avail finalid_econ
    then do:
        assign p_cod_return = "337" + "," + histor_finalid_econ.cod_finalid_econ.
        return.
    end /* if */.
    run pi_validar_finalid_unid_organ (Input finalid_econ.cod_finalid_econ,
                                       Input p_cod_unid_organ,
                                       Input p_dat_transacao,
                                       output p_cod_return) /*pi_validar_finalid_unid_organ*/.
    if  p_cod_return = "338"
    then do:
       return.
    end /* if */.

    assign p_cod_return =  "OK" /*l_ok*/ .
END PROCEDURE. /* pi_validar_indic_econ_movto */
/*****************************************************************************
** Procedure Interna.....: pi_validar_cheque_apb
** Descricao.............: pi_validar_cheque_apb
** Criado por............: 
** Criado em.............: // 
** Alterado por..........: its0105
** Alterado em...........: 28/07/2005 18:57:37
*****************************************************************************/
PROCEDURE pi_validar_cheque_apb:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_estab
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def Input param p_cod_portador
        as character
        format "x(5)"
        no-undo.
    def Input param p_cod_cart_bcia
        as character
        format "x(3)"
        no-undo.
    def Input param p_cod_finalid_econ
        as character
        format "x(10)"
        no-undo.
    def Input param p_cod_cta_corren
        as character
        format "x(10)"
        no-undo.
    def Input param p_num_talon_cheq
        as integer
        format ">>>,>>>,>>9"
        no-undo.
    def Input param p_num_cheque
        as integer
        format ">>>>,>>>,>>9"
        no-undo.
    def Input param p_dat_emis_cheq
        as date
        format "99/99/9999"
        no-undo.
    def Input param p_nom_favorec_cheq
        as character
        format "x(40)"
        no-undo.
    def Input param p_rec_item_lote_pagto
        as recid
        format ">>>>>>9"
        no-undo.
    def Input param p_rec_antecip_pef_pend
        as recid
        format ">>>>>>9"
        no-undo.
    def output param p_cod_return
        as character
        format "x(40)"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************** Buffer Definition Begin *************************/

    &if "{&emsfin_version}" >= "5.01" &then
    def buffer b_antecip_pef_pend
        for antecip_pef_pend.
    &endif
    &if "{&emsfin_version}" >= "5.01" &then
    def buffer b_cheq_ap
        for cheq_ap.
    &endif
    &if "{&emsfin_version}" >= "5.01" &then
    def buffer b_item_lote_pagto
        for item_lote_pagto.
    &endif
    &if "{&emsfin_version}" >= "5.01" &then
    def buffer b_lote_pagto
        for lote_pagto.
    &endif
    &if "{&emsfin_version}" >= "5.01" &then
    def buffer b_portad_finalid_econ
        for portad_finalid_econ.
    &endif


    /*************************** Buffer Definition End **************************/

    /************************* Variable Definition Begin ************************/

    def var v_cod_return
        as character
        format "x(40)":U
        no-undo.


    /************************** Variable Definition End *************************/

    assign p_cod_return = "OK" /*l_ok*/ .

    /* --- Bancos Hist¢ricos --- */
    &if defined(BF_FIN_BCOS_HISTORICOS) &then
        if  v_log_utiliza_mbh
        and can-find(first his_cheq no-lock
                     where his_cheq.cod_cta_corren = p_cod_cta_corren
                       and his_cheq.num_talon_cheq = p_num_talon_cheq
                       and his_cheq.num_cheque     = p_num_cheque)
        then do:
            assign p_cod_return = "14008".
            return.
        end.
    &endif

    find talon_cheq no-lock
        where talon_cheq.cod_cta_corren = p_cod_cta_corren
          and talon_cheq.num_talon_cheq = p_num_talon_cheq no-error.
    if  avail talon_cheq then do:
        if  p_num_cheque > talon_cheq.num_fim_talon_cheq
        or  p_num_cheque < talon_cheq.num_inic_talon_cheq then do:
            assign p_cod_return = "1065".
            return.
        end.
    end.
    else do:
        assign p_cod_return = "1065".
        return.
    end.

    find cta_corren no-lock
         where cta_corren.cod_cta_corren = p_cod_cta_corren no-error.

    find b_cheq_ap no-lock
        where b_cheq_ap.cod_cta_corren = p_cod_cta_corren
        and   b_cheq_ap.num_talon_cheq = p_num_talon_cheq
        and   b_cheq_ap.num_cheque     = p_num_cheque no-error.
    if  not avail b_cheq_ap then do:
        run pi_validar_cheque (Input p_cod_cta_corren,
                               Input p_num_talon_cheq,
                               Input p_num_cheque,
                               Input "APB" /*l_apb*/,
                               output v_cod_return) /*pi_validar_cheque*/.
        if  v_cod_return = "NOK" /*l_nok*/  then do:
            assign p_cod_return = "12887".
            return.
        end.

        for each b_portad_finalid_econ no-lock use-index prtdfnld_cta_corren
            where b_portad_finalid_econ.cod_cta_corren   = p_cod_cta_corren
            and   b_portad_finalid_econ.cod_finalid_econ = p_cod_finalid_econ
            and   b_portad_finalid_econ.cod_cart_bcia    = p_cod_cart_bcia:


            /* Begin_Include: i_tratar_cheq_ap_via_tabela_livre */
            if  "Procurar" /* l_procurar*/ = "Incluir" /*l_incluir*/  then do:
                create tab_livre_emsfin.
                assign tab_livre_emsfin.cod_modul_dtsul      = "APB" /*l_apb*/ 
                       tab_livre_emsfin.cod_tab_dic_dtsul    = "Item do Lote de Pagamento"
                       tab_livre_emsfin.cod_compon_1_idx_tab = b_portad_finalid_econ.cod_cta_corren + "," + string( p_num_talon_cheq ) + "," + string( p_num_cheque )
                       tab_livre_emsfin.cod_compon_2_idx_tab = "" + "," + "" + "," + string( 0 ).
            end.

            if  "Procurar" /* l_procurar*/ = "Procurar" /*l_procurar*/  then do:
                find first tab_livre_emsfin no-lock
                     where tab_livre_emsfin.cod_modul_dtsul      = "APB" /*l_apb*/ 
                       and tab_livre_emsfin.cod_tab_dic_dtsul    = "Item do Lote de Pagamento"
                       and tab_livre_emsfin.cod_compon_1_idx_tab = b_portad_finalid_econ.cod_cta_corren + "," + string( p_num_talon_cheq ) + "," + string( p_num_cheque )
                     no-error.
                if  avail tab_livre_emsfin then do:
                    find b_item_lote_pagto no-lock
                         where b_item_lote_pagto.cod_estab_refer = entry( 1, tab_livre_emsfin.cod_compon_2_idx_tab, "," )
                           and b_item_lote_pagto.cod_refer       = entry( 2, tab_livre_emsfin.cod_compon_2_idx_tab, "," )
                           and b_item_lote_pagto.num_seq_refer   = integer( entry( 3, tab_livre_emsfin.cod_compon_2_idx_tab, "," ) )
                           and recid( b_item_lote_pagto )       <> p_rec_item_lote_pagto
                         no-error.
                    if  not avail b_item_lote_pagto then do:
                        find next tab_livre_emsfin no-lock
                             where tab_livre_emsfin.cod_modul_dtsul      = "APB" /*l_apb*/ 
                               and tab_livre_emsfin.cod_tab_dic_dtsul    = "Item do Lote de Pagamento"
                               and tab_livre_emsfin.cod_compon_1_idx_tab = b_portad_finalid_econ.cod_cta_corren + "," + string( p_num_talon_cheq ) + "," + string( p_num_cheque )
                              no-error.
                        if  avail tab_livre_emsfin then do:
                            find b_item_lote_pagto no-lock
                                 where b_item_lote_pagto.cod_estab_refer = entry( 1, tab_livre_emsfin.cod_compon_2_idx_tab, "," )
                                   and b_item_lote_pagto.cod_refer       = entry( 2, tab_livre_emsfin.cod_compon_2_idx_tab, "," )
                                   and b_item_lote_pagto.num_seq_refer   = integer( entry( 3, tab_livre_emsfin.cod_compon_2_idx_tab, "," ) )
                              no-error.
                        end.
                    end.
                end.
                else do:
                    if  avail b_item_lote_pagto then do:
                        release b_item_lote_pagto.
                    end.
                end.
            end.

            if  "Procurar" /* l_procurar*/ = "Pr¢ximo" /*l_proximo*/  then do:
                find next  tab_livre_emsfin no-lock
                     where tab_livre_emsfin.cod_modul_dtsul      = "APB" /*l_apb*/ 
                       and tab_livre_emsfin.cod_tab_dic_dtsul    = "Item do Lote de Pagamento"
                       and tab_livre_emsfin.cod_compon_1_idx_tab = b_portad_finalid_econ.cod_cta_corren + "," + string( p_num_talon_cheq ) + "," + string( p_num_cheque )
                      no-error.
                if  avail tab_livre_emsfin then do:
                    find b_item_lote_pagto no-lock
                         where b_item_lote_pagto.cod_estab_refer = entry( 1, tab_livre_emsfin.cod_compon_2_idx_tab, "," )
                           and b_item_lote_pagto.cod_refer       = entry( 2, tab_livre_emsfin.cod_compon_2_idx_tab, "," )
                           and b_item_lote_pagto.num_seq_refer   = integer( entry( 3, tab_livre_emsfin.cod_compon_2_idx_tab, "," ) )
                         no-error.
                end.
                else do:
                    if  avail b_item_lote_pagto then do:
                        release b_item_lote_pagto.
                    end.
                end.
            end.

            if  "Procurar" /* l_procurar*/ = "Excluir" /*l_excluir*/  then do:
                find tab_livre_emsfin exclusive-lock
                    where tab_livre_emsfin.cod_modul_dtsul      = "APB" /*l_apb*/ 
                      and tab_livre_emsfin.cod_tab_dic_dtsul    = "Item do Lote de Pagamento"
                      and tab_livre_emsfin.cod_compon_1_idx_tab = b_portad_finalid_econ.cod_cta_corren + "," + string( p_num_talon_cheq ) + "," + string( p_num_cheque )
                      and tab_livre_emsfin.cod_compon_2_idx_tab = "" + "," + "" + "," + string( 0 )
                    no-error.
                if  avail tab_livre_emsfin then do:
                    delete tab_livre_emsfin.
                end.
            end.
            /* End_Include: i_tratar_cheq_ap_via_tabela_livre */


            /* Este coment†rio deve ser retirado quando o indice for corrigido.
            /* Procura um ITEM DE LOTE DE PAGAMENTO com as mesmas especificacoes do cheque */
            find first b_item_lote_pagto no-lock use-index itmltpgt_portad_finalid_econ
                 where b_item_lote_pagto.cod_estab_refer  = b_portad_finalid_econ.cod_estab    
                 and   b_item_lote_pagto.cod_portador     = b_portad_finalid_econ.cod_portador 
                 and   b_item_lote_pagto.cod_cart_bcia    = p_cod_cart_bcia
                 and   b_item_lote_pagto.cod_finalid_econ = p_cod_finalid_econ
                 and   b_item_lote_pagto.num_talon_cheq   = p_num_talon_cheq
                 and   b_item_lote_pagto.num_cheque       = p_num_cheque
                 and recid(b_item_lote_pagto)          <> p_rec_item_lote_pagto
                  no-error.
            ------------------------------------------------------------------- */
            if  avail b_item_lote_pagto then do:
                find b_lote_pagto no-lock
                     where b_lote_pagto.cod_estab_refer = b_item_lote_pagto.cod_estab_refer
                       and b_lote_pagto.cod_refer       = b_item_lote_pagto.cod_refer no-error.
                if  p_dat_emis_cheq <> b_lote_pagto.dat_transacao then
                    assign p_cod_return = "1065".
                else do:
                    if  b_item_lote_pagto.nom_favorec_cheq <> p_nom_favorec_cheq then
                        assign p_cod_return = "1065".
                end.
            end.
        end.
    end.
    else do:
        if  p_dat_emis_cheq            <> b_cheq_ap.dat_emis_cheq
        or  b_cheq_ap.log_cheq_cancdo   = yes
        or  b_cheq_ap.nom_favorec_cheq <> p_nom_favorec_cheq then do:
            assign p_cod_return = "1065".
            return.
        end.
        if  b_cheq_ap.log_cheq_confdo = yes then do:
            assign p_cod_return = "4468".
            return.
        end.
        if  b_cheq_ap.log_impres_cheq_sist = yes then do:
            assign p_cod_return = "4470".
            return.
        end.
    end.
END PROCEDURE. /* pi_validar_cheque_apb */
/*****************************************************************************
** Procedure Interna.....: pi_validar_cheque
** Descricao.............: pi_validar_cheque
** Criado por............: Roberto
** Criado em.............: 23/12/1996 18:55:23
** Alterado por..........: Roberto
** Alterado em...........: 23/12/1996 17:04:53
*****************************************************************************/
PROCEDURE pi_validar_cheque:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_cta_corren
        as character
        format "x(10)"
        no-undo.
    def Input param p_num_talon_cheq
        as integer
        format ">>>,>>>,>>9"
        no-undo.
    def Input param p_num_cheque
        as integer
        format ">>>>,>>>,>>9"
        no-undo.
    def Input param p_cod_modul_dtsul
        as character
        format "x(3)"
        no-undo.
    def output param p_cod_return
        as character
        format "x(40)"
        no-undo.


    /************************* Parameter Definition End *************************/

    assign p_cod_return = "OK" /*l_ok*/ .

    find cheque no-lock
         where cheque.cod_cta_corren = p_cod_cta_corren
           and cheque.num_talon_cheq = p_num_talon_cheq
           and cheque.num_cheque     = p_num_cheque
         no-error.
    if  avail cheque and cheque.cod_modul_dtsul <> p_cod_modul_dtsul
    then do:
        assign p_cod_return = "NOK" /*l_nok*/ .
    end /* if */.
END PROCEDURE. /* pi_validar_cheque */
/*****************************************************************************
** Procedure Interna.....: pi_validar_estab
** Descricao.............: pi_validar_estab
** Criado por............: 
** Criado em.............: // 
** Alterado por..........: src12337
** Alterado em...........: 23/03/2001 08:01:00
*****************************************************************************/
PROCEDURE pi_validar_estab:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_empresa
        as character
        format "x(3)"
        no-undo.
    def Input param p_cod_estab
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def Input param p_dat_transacao
        as date
        format "99/99/9999"
        no-undo.
    def output param p_cod_return
        as character
        format "x(40)"
        no-undo.


    /************************* Parameter Definition End *************************/

    find unid_organ no-lock
         where unid_organ.cod_unid_organ = p_cod_estab /*cl_estab of unid_organ*/ no-error.
    if  avail unid_organ
    then do:
        if  p_dat_transacao <> ? and
           (p_dat_transacao < unid_organ.dat_inic_valid or
            p_dat_transacao > unid_organ.dat_fim_valid)
        then do:
            assign p_cod_return = "Unidade Organizacional" /*l_unid_organ*/ .
            return.
        end /* if */.
    end /* if */.
    else do:
        assign p_cod_return = "Unidade Organizacional" /*l_unid_organ*/ .
        return.
    end /* else */.
    if  p_cod_empresa <> ?
    then do:
        find estabelecimento no-lock
             where estabelecimento.cod_estab = p_cod_estab /*cl_param_estab of estabelecimento*/ no-error.
        if  avail estabelecimento and
            estabelecimento.cod_empresa <> p_cod_empresa
        then do:
            assign p_cod_return = "Empresa" /*l_empresa*/ .
            return.
        end /* if */.
    end /* if */.
    if  can-find(segur_unid_organ
            where segur_unid_organ.cod_unid_organ = p_cod_estab
              and segur_unid_organ.cod_grp_usuar = '*' /*cl_valid_estab_todos_usuarios of segur_unid_organ*/)
            then do:
        /* todos os usu†rio podem acessar */
       assign p_cod_return = "".
       return.
    end /* if */.
    contr_block:
    for
       each usuar_grp_usuar no-lock
       where usuar_grp_usuar.cod_usuario = v_cod_usuar_corren
    &if "{&emsbas_version}" >= "5.01" &then
       use-index srgrpsr_usuario
    &endif
        /*cl_grupos_do_usuario of usuar_grp_usuar*/:
       find first segur_unid_organ no-lock
            where segur_unid_organ.cod_unid_organ = p_cod_estab
              and segur_unid_organ.cod_grp_usuar = usuar_grp_usuar.cod_grp_usuar /*cl_valida_estab of segur_unid_organ*/ no-error.
       if  avail segur_unid_organ
       then do:
          assign p_cod_return = "".
          return.
       end /* if */.
    end /* for contr_block */.
    assign p_cod_return = "Usu†rio" /*l_usuario*/ .

END PROCEDURE. /* pi_validar_estab */
/*****************************************************************************
** Procedure Interna.....: pi_validar_portador
** Descricao.............: pi_validar_portador
** Criado por............: 
** Criado em.............: // 
** Alterado por..........: fut41061_4
** Alterado em...........: 10/12/2008 13:41:06
*****************************************************************************/
PROCEDURE pi_validar_portador:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_portador
        as character
        format "x(5)"
        no-undo.
    def Input param p_cod_estab
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def Input param p_cod_indic_econ
        as character
        format "x(8)"
        no-undo.
    def Input param p_dat_transacao
        as date
        format "99/99/9999"
        no-undo.
    def Input param p_log_verifica_cta_portad_ap
        as logical
        format "Sim/N∆o"
        no-undo.
    def Input param p_ind_espec_cta_portad
        as character
        format "X(20)"
        no-undo.
    def output param p_ind_finalid_ctbl_err
        as character
        format "X(30)"
        no-undo.
    def output param p_cod_finalid_econ
        as character
        format "x(10)"
        no-undo.
    def Input param p_cod_cart_bcia
        as character
        format "x(3)"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_num_seq
        as integer
        format ">>>,>>9":U
        label "SeqÅància"
        column-label "Seq"
        no-undo.


    /************************** Variable Definition End *************************/

    /* Esta pi tem uma grande lista de impacto, alguns dos programas utilizam as buscas de
    registros das tabelas. Por isso n∆o Ç aconselh†vel alterar os find's para cand-find's
    com a intená∆o de melhorar a performance*/

    find first portador no-lock
         where portador.cod_portador = p_cod_portador no-error.
    if  not avail portador then
        return "506".

    find first portad_estab no-lock
        where portad_estab.cod_estab    = p_cod_estab
          and portad_estab.cod_portador = p_cod_portador no-error.
    if  not avail portad_estab then
        return "775".

    run pi_retornar_finalid_indic_econ (input p_cod_indic_econ,
                                        input p_dat_transacao,
                                        output p_cod_finalid_econ) /* pi_retornar_finalid_indic_econ*/.

    find first portad_finalid_econ no-lock
        where portad_finalid_econ.cod_estab        = p_cod_estab
          and portad_finalid_econ.cod_portador     = p_cod_portador
          and portad_finalid_econ.cod_cart_bcia    = p_cod_cart_bcia
          and portad_finalid_econ.cod_finalid_econ = p_cod_finalid_econ no-error.
    if  not avail portad_finalid_econ then
        return '776'.

    if  p_log_verifica_cta_portad_ap = yes then do:
        especie_conta:
        do  v_num_seq = 1 to num-entries(p_ind_espec_cta_portad):
            find first cta_corren_cta_ctbl no-lock
                where cta_corren_cta_ctbl.cod_cta_corren               = portad_finalid_econ.cod_cta_corren
                  and cta_corren_cta_ctbl.ind_finalid_ctbl_cta_corren  = entry(v_num_seq, p_ind_espec_cta_portad)
                  and cta_corren_cta_ctbl.dat_inic_valid              <= p_dat_transacao
                  and cta_corren_cta_ctbl.dat_fim_valid               >= p_dat_transacao no-error.
            if  not avail cta_corren_cta_ctbl then do:
                assign p_ind_finalid_ctbl_err = entry(v_num_seq, p_ind_espec_cta_portad).
                return "777".
            end /* if */.
        end /* do especie_conta */.
    end /* if */. 

    return "OK" /*l_ok*/ .
END PROCEDURE. /* pi_validar_portador */
/*****************************************************************************
** Procedure Interna.....: pi_retornar_finalid_indic_econ
** Descricao.............: pi_retornar_finalid_indic_econ
** Criado por............: 
** Criado em.............: // 
** Alterado por..........: fut43117
** Alterado em...........: 05/12/2011 10:21:41
*****************************************************************************/
PROCEDURE pi_retornar_finalid_indic_econ:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_indic_econ
        as character
        format "x(8)"
        no-undo.
    def Input param p_dat_transacao
        as date
        format "99/99/9999"
        no-undo.
    def output param p_cod_finalid_econ
        as character
        format "x(10)"
        no-undo.


    /************************* Parameter Definition End *************************/

    /* alteracao sob demanda - atividade 195864*/
    find first histor_finalid_econ no-lock
        where histor_finalid_econ.cod_indic_econ          = p_cod_indic_econ
        and   histor_finalid_econ.dat_inic_valid_finalid <= p_dat_transacao
        and   histor_finalid_econ.dat_fim_valid_finalid  > p_dat_transacao no-error.
    if  avail histor_finalid_econ then 
        assign p_cod_finalid_econ = histor_finalid_econ.cod_finalid_econ.


    if  v_nom_prog_upc  <> ''    
    or  v_nom_prog_appc <> ''
    or  v_nom_prog_dpc  <> '' then do:

        run pi_limpa_retorno /*pi_limpa_retorno*/.


        /* Begin_Include: i_executa_pi_epc_fin */
        run pi_exec_program_epc_FIN (Input 'retornar_finalid_indic_econ',
                                     Input 'no',
                                     output v_log_return_epc) /*pi_exec_program_epc_FIN*/.
        if v_log_return_epc then /* epc retornou erro*/
            undo, retry.
        /* End_Include: i_executa_pi_epc_fin */


        /* Somente vai entrar se for o banrisul */
        if return-value = 'BRSL' then do:
            for first histor_finalid_econ fields (cod_finalid_econ) no-lock
                where histor_finalid_econ.cod_indic_econ          = p_cod_indic_econ
                and   histor_finalid_econ.dat_inic_valid_finalid <= p_dat_transacao
                and   histor_finalid_econ.dat_fim_valid_finalid   > p_dat_transacao:

                assign p_cod_finalid_econ = histor_finalid_econ.cod_finalid_econ.
            end.
        end.

        run pi_limpa_retorno /*pi_limpa_retorno*/.
    end.



END PROCEDURE. /* pi_retornar_finalid_indic_econ */
/*****************************************************************************
** Procedure Interna.....: pi_validar_usuar_estab_apb
** Descricao.............: pi_validar_usuar_estab_apb
** Criado por............: Diocalisto
** Criado em.............: // 
** Alterado por..........: Claudia
** Alterado em...........: 03/04/1998 08:26:37
*****************************************************************************/
PROCEDURE pi_validar_usuar_estab_apb:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_estab
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def Input param p_ind_tip_usuar
        as character
        format "X(08)"
        no-undo.
    def output param p_cod_return
        as character
        format "x(40)"
        no-undo.
    def output param p_val_lim_liber_usuar_movto
        as decimal
        format "->>>,>>>,>>9.99"
        decimals 2
        no-undo.
    def output param p_val_lim_liber_usuar_mes
        as decimal
        format "->>,>>>,>>>,>>9.99"
        decimals 2
        no-undo.
    def output param p_val_lim_pagto_usuar_movto
        as decimal
        format "->>>,>>>,>>9.99"
        decimals 2
        no-undo.
    def output param p_val_lim_pagto_usuar_mes
        as decimal
        format "->>,>>>,>>>,>>9.99"
        decimals 2
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_num_seq
        as integer
        format ">>>,>>9":U
        label "SeqÅància"
        column-label "Seq"
        no-undo.


    /************************** Variable Definition End *************************/

    assign p_cod_return = "".
    find usuar_financ_estab_apb no-lock
         where usuar_financ_estab_apb.cod_usuario = v_cod_usuar_corren
           and usuar_financ_estab_apb.cod_estab = p_cod_estab /*cl_validar_usuar_financ_estab_apb of usuar_financ_estab_apb*/ no-error.

    if  avail usuar_financ_estab_apb
    then do:
        assign p_val_lim_liber_usuar_movto = usuar_financ_estab_apb.val_lim_liber_usuar_movto
               p_val_lim_liber_usuar_mes   = usuar_financ_estab_apb.val_lim_liber_usuar_mes
               p_val_lim_pagto_usuar_movto = usuar_financ_estab_apb.val_lim_pagto_usuar_movto
               p_val_lim_pagto_usuar_mes   = usuar_financ_estab_apb.val_lim_pagto_usuar_mes.

        teste_usuar:
        do v_num_seq = 1 to num-entries(p_ind_tip_usuar):
            if  v_num_seq <> 1
            then do:
                assign p_cod_return = p_cod_return + ",".
            end /* if */.

            /* case_block: */
            case entry(v_num_seq, p_ind_tip_usuar):
                when "Implantador" /*l_implantador*/ then
                    if  usuar_financ_estab_apb.log_habilit_impl_tit_ap = no
                    then do:
                        assign p_cod_return = p_cod_return + "no" /*l_no*/ .
                    end /* if */.
                    else do:
                        assign p_cod_return = p_cod_return + "yes" /*l_yes*/ .
                    end /* else */.

                when "Preparador" /*l_preparador*/ then
                    if  usuar_financ_estab_apb.log_habilit_prepar_tit_ap = no
                    then do:
                        assign p_cod_return = p_cod_return + "no" /*l_no*/ .
                    end /* if */.
                    else do:
                        assign p_cod_return = p_cod_return + "yes" /*l_yes*/ .
                    end /* else */.

                when "Liberador" /*l_liberador*/ then
                    if  usuar_financ_estab_apb.log_habilit_liber_tit_ap = no
                    then do:
                        assign p_cod_return = p_cod_return + "no" /*l_no*/ .
                    end /* if */.
                    else do:
                        assign p_cod_return = p_cod_return + "yes" /*l_yes*/ .
                    end /* else */.

                when "Pagador" /*l_pagador*/ then
                    if  usuar_financ_estab_apb.log_habilit_pagto_tit_ap = no
                    then do:
                        assign p_cod_return = p_cod_return + "no" /*l_no*/ .
                    end /* if */.
                    else do:
                        assign p_cod_return = p_cod_return + "yes" /*l_yes*/ .
                    end /* else */.

                when "Confirmador" /*l_confirmador*/ then
                    if  usuar_financ_estab_apb.log_habilit_confir_tit_ap = no
                    then do:
                        assign p_cod_return = p_cod_return + "no" /*l_no*/ .
                    end /* if */.
                    else do:
                        assign p_cod_return = p_cod_return + "yes" /*l_yes*/ .
                    end /* else */.

                when "Impressor" /*l_impressor*/ then
                    if  usuar_financ_estab_apb.log_habilit_impr_docto = no
                    then do:
                        assign p_cod_return = p_cod_return + "no" /*l_no*/ .
                    end /* if */.
                    else do:
                        assign p_cod_return = p_cod_return + "yes" /*l_yes*/ .
                    end /* else */.
                when "Encontro de Contas" /*l_encontro_de_contas*/ then
                    if  usuar_financ_estab_apb.log_habilit_enctro_cta = no
                    then do:
                        assign p_cod_return = p_cod_return + "no" /*l_no*/ .
                    end /* if */.
                    else do:
                        assign p_cod_return = p_cod_return + "yes" /*l_yes*/ .
                    end /* else */.

            end /* case case_block */.
        end /* do teste_usuar */.
    end /* if */.
    else do:
        assign p_cod_return = "602".
    end /* else */.

END PROCEDURE. /* pi_validar_usuar_estab_apb */
/*****************************************************************************
** Procedure Interna.....: pi_validar_usuar_talon_cheq
** Descricao.............: pi_validar_usuar_talon_cheq
** Criado por............: Roberto
** Criado em.............: 11/11/1996 09:18:06
** Alterado por..........: Rafael
** Alterado em...........: 01/06/1998 17:56:47
*****************************************************************************/
PROCEDURE pi_validar_usuar_talon_cheq:

    /************************ Parameter Definition Begin ************************/

    def Input param p_num_talon_cheq
        as integer
        format ">>>,>>>,>>9"
        no-undo.
    def Input param p_cod_cta_corren
        as character
        format "x(10)"
        no-undo.


    /************************* Parameter Definition End *************************/

    talon_block:
    for each segur_talon_cheq no-lock
        where segur_talon_cheq.num_talon_cheq = p_num_talon_cheq
        and   segur_talon_cheq.cod_cta_corren = p_cod_cta_corren:
        find usuar_grp_usuar no-lock
            where usuar_grp_usuar.cod_usuario   = v_cod_usuar_corren
            and   usuar_grp_usuar.cod_grp_usuar = segur_talon_cheq.cod_grp_usuar 
            no-error.
        if  avail usuar_grp_usuar or segur_talon_cheq.cod_grp_usuar = "*" then
            return "OK" /*l_ok*/ .
    end.
    return "NOK" /*l_nok*/ .
END PROCEDURE. /* pi_validar_usuar_talon_cheq */
/*****************************************************************************
** Procedure Interna.....: pi_verifica_refer_unica_apb
** Descricao.............: pi_verifica_refer_unica_apb
** Criado por............: 
** Criado em.............: // 
** Alterado por..........: fut40711
** Alterado em...........: 05/07/2010 13:54:09
*****************************************************************************/
PROCEDURE pi_verifica_refer_unica_apb:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_estab
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def Input param p_cod_refer
        as character
        format "x(10)"
        no-undo.
    def Input param p_cod_table
        as character
        format "x(8)"
        no-undo.
    def Input param p_rec_movto_tit_ap
        as recid
        format ">>>>>>9"
        no-undo.
    def output param p_log_refer_uni
        as logical
        format "Sim/N∆o"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************** Buffer Definition Begin *************************/

    &if "{&emsfin_version}" >= "5.01" &then
    def buffer b_antecip_pef_pend
        for antecip_pef_pend.
    &endif
    &if "{&emsfin_version}" >= "5.01" &then
    def buffer b_lote_impl_tit_ap
        for lote_impl_tit_ap.
    &endif
    &if "{&emsfin_version}" >= "5.01" &then
    def buffer b_lote_pagto
        for lote_pagto.
    &endif
    &if "{&emsfin_version}" >= "5.01" &then
    def buffer b_movto_tit_ap
        for movto_tit_ap.
    &endif


    /*************************** Buffer Definition End **************************/

    assign p_log_refer_uni = yes.



    if  p_cod_table <> "antecip_pef_pend" /*l_antecip_pef_pend*/ 
    then do:
        find first b_antecip_pef_pend no-lock
             where b_antecip_pef_pend.cod_estab = p_cod_estab
               and b_antecip_pef_pend.cod_refer = p_cod_refer /*cl_verifica_refer_uni of b_antecip_pef_pend*/ no-error.
    end /* if */.
    if  avail b_antecip_pef_pend
    then do:
        assign p_log_refer_uni = no.
    end /* if */.
    else do:
        if  p_cod_table <> "lote_impl_tit_ap" /*l_lote_impl_tit_ap*/ 
        then do:
            find first b_lote_impl_tit_ap no-lock
                 where b_lote_impl_tit_ap.cod_estab = p_cod_estab
                   and b_lote_impl_tit_ap.cod_refer = p_cod_refer /*cl_verifica_refer_uni of b_lote_impl_tit_ap*/ no-error.
        end /* if */.
        if  avail b_lote_impl_tit_ap
        then do:
            assign p_log_refer_uni = no.
        end /* if */.
        else do:
            if  p_cod_table <> "lote_pagto" /*l_lote_pagto*/ 
            then do:
                find first b_lote_pagto no-lock
                     where b_lote_pagto.cod_estab_refer = p_cod_estab
                       and b_lote_pagto.cod_refer = p_cod_refer /*cl_verifica_refer_uni of b_lote_pagto*/ no-error.
            end /* if */.
            if  avail b_lote_pagto
            then do:
                assign p_log_refer_uni = no.
            end /* if */.
            else do:
                find first b_movto_tit_ap no-lock
                     where b_movto_tit_ap.cod_estab = p_cod_estab
                       and b_movto_tit_ap.cod_refer = p_cod_refer
                       and recid(b_movto_tit_ap) <> p_rec_movto_tit_ap /*cl_verifica_refer_uni_apb of b_movto_tit_ap*/ no-error.
                if  avail b_movto_tit_ap
                then do:
                    assign p_log_refer_uni = no.
                end /* if */.
            end /* else */.
        end /* else */.
    end /* else */.

    &if defined(BF_FIN_BCOS_HISTORICOS) &then
        if  v_log_utiliza_mbh
        and can-find(first his_movto_tit_ap_histor no-lock
                     where his_movto_tit_ap_histor.cod_estab = p_cod_estab
                       and his_movto_tit_ap_histor.cod_refer = p_cod_refer) then
            assign p_log_refer_uni = no.
    &endif
END PROCEDURE. /* pi_verifica_refer_unica_apb */
/*****************************************************************************
** Procedure Interna.....: pi_verifica_tit_unico_apb
** Descricao.............: pi_verifica_tit_unico_apb
** Criado por............: 
** Criado em.............: // 
** Alterado por..........: fut40711
** Alterado em...........: 05/07/2010 14:02:55
*****************************************************************************/
PROCEDURE pi_verifica_tit_unico_apb:

    /************************ Parameter Definition Begin ************************/

    def Input param p_num_pessoa
        as integer
        format ">>>,>>>,>>9"
        no-undo.
    def Input param p_cod_espec_docto
        as character
        format "x(3)"
        no-undo.
    def Input param p_cod_ser_docto
        as character
        format "x(3)"
        no-undo.
    def Input param p_cod_tit_ap
        as character
        format "x(10)"
        no-undo.
    def Input param p_cod_parcela
        as character
        format "x(02)"
        no-undo.
    def Input param p_rec_item_lote_impl_ap
        as recid
        format ">>>>>>9"
        no-undo.
    def Input param p_rec_antecip_pef_pend
        as recid
        format ">>>>>>9"
        no-undo.
    def Input param p_rec_impto_impl_pend_ap
        as recid
        format ">>>>>>9"
        no-undo.
    def Input param p_rec_nota_pend_cartcred
        as recid
        format ">>>>>>9"
        no-undo.
    def output param p_log_tit_ap_unico
        as logical
        format "Sim/N∆o"
        no-undo.
    def output param p_cod_empresa
        as character
        format "x(3)"
        no-undo.
    def output param p_cod_estab
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def output param p_des_movimento
        as character
        format "x(40)"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************** Buffer Definition Begin *************************/

    &if "{&emsfin_version}" >= "5.01" &then
    def buffer b_antecip_pef_pend
        for antecip_pef_pend.
    &endif
    &if "{&emsfin_version}" >= "5.01" &then
    def buffer b_impto_impl_pend_ap
        for impto_impl_pend_ap.
    &endif
    &if "{&emsfin_version}" >= "5.01" &then
    def buffer b_item_lote_impl_ap
        for item_lote_impl_ap.
    &endif
    &if "{&emsfin_version}" >= "5.01" &then
    def buffer b_nota_pend_cartcred
        for nota_pend_cartcred.
    &endif


    /*************************** Buffer Definition End **************************/

    /************************* Variable Definition Begin ************************/

    def var v_log_reg_corporat_2
        as logical
        format "Sim/N∆o"
        initial no
        view-as toggle-box
        label "Registro Corporativo"
        column-label "Registro Corporativo"
        no-undo.


    /************************** Variable Definition End *************************/

    assign p_log_tit_ap_unico = yes
           v_log_reg_corporat_2 = no.

    find first b_item_lote_impl_ap no-lock
        where b_item_lote_impl_ap.num_pessoa      = p_num_pessoa
          and b_item_lote_impl_ap.cod_espec_docto = p_cod_espec_docto
          and b_item_lote_impl_ap.cod_ser_docto   = p_cod_ser_docto
          and b_item_lote_impl_ap.cod_tit_ap      = p_cod_tit_ap
          and b_item_lote_impl_ap.cod_parcela     = p_cod_parcela
          and recid(b_item_lote_impl_ap)         <> p_rec_item_lote_impl_ap no-error.
    if avail b_item_lote_impl_ap then do:
        &if '{&emsfin_version}' >= '5.03' &then
            find last param_geral_apb no-lock no-error.
            if avail param_geral_apb then do:
                if param_geral_apb.log_reg_corporat then do:
                   assign p_log_tit_ap_unico = no
                          p_cod_empresa      = b_item_lote_impl_ap.cod_empresa
                          p_cod_estab        = b_item_lote_impl_ap.cod_estab_tit_ap
                          p_des_movimento    = 'Lote de Implantaá∆o Pendente'
                          v_log_reg_corporat_2 = yes.
                   return.
                end.
            end.
       &endif  
       if not v_log_reg_corporat_2 then do:
           assign p_log_tit_ap_unico = no
                  p_cod_empresa      = b_item_lote_impl_ap.cod_empresa
                  p_cod_estab        = b_item_lote_impl_ap.cod_estab
                  p_des_movimento    = 'Lote de Implantaá∆o Pendente'.
           return.
       end.
    end.

    find first b_antecip_pef_pend no-lock
         where b_antecip_pef_pend.num_pessoa      = p_num_pessoa
           and b_antecip_pef_pend.cod_espec_docto = p_cod_espec_docto
           and b_antecip_pef_pend.cod_ser_docto   = p_cod_ser_docto
           and b_antecip_pef_pend.cod_tit_ap      = p_cod_tit_ap
           and b_antecip_pef_pend.cod_parcela     = p_cod_parcela
           and recid(b_antecip_pef_pend)         <> p_rec_antecip_pef_pend no-error.
    if avail b_antecip_pef_pend then do:
        assign p_log_tit_ap_unico = no
               p_cod_empresa      = b_antecip_pef_pend.cod_empresa
               p_cod_estab        = b_antecip_pef_pend.cod_estab
               p_des_movimento    = 'Antecipaá∆o/PEF Pendente'.
        return.
    end.

    find first tit_ap no-lock
         where tit_ap.num_pessoa      = p_num_pessoa
           and tit_ap.cod_espec_docto = p_cod_espec_docto
           and tit_ap.cod_ser_docto   = p_cod_ser_docto
           and tit_ap.cod_tit_ap      = p_cod_tit_ap
           and tit_ap.cod_parcela     = p_cod_parcela no-error.
    if avail tit_ap then do:
        assign p_log_tit_ap_unico = no
               p_cod_empresa      = tit_ap.cod_empresa
               p_cod_estab        = tit_ap.cod_estab
               p_des_movimento    = 'T°tulo'.
        return.
    end.

    find first b_impto_impl_pend_ap no-lock
         where b_impto_impl_pend_ap.num_pessoa_impto = p_num_pessoa
           and b_impto_impl_pend_ap.cod_espec_docto  = p_cod_espec_docto
           and b_impto_impl_pend_ap.cod_ser_docto    = p_cod_ser_docto
           and b_impto_impl_pend_ap.cod_tit_ap       = p_cod_tit_ap
           and b_impto_impl_pend_ap.cod_parcela      = p_cod_parcela
           and recid(b_impto_impl_pend_ap)          <> p_rec_impto_impl_pend_ap no-error.
    if avail b_impto_impl_pend_ap then do:
        assign p_log_tit_ap_unico = no
               p_cod_empresa      = b_impto_impl_pend_ap.cod_empresa
               p_cod_estab        = b_impto_impl_pend_ap.cod_estab
               p_des_movimento    = 'Imposto Pendente'.
        return.
    end.

    find first b_nota_pend_cartcred no-lock
       where b_nota_pend_cartcred.num_pessoa      = p_num_pessoa
       and   b_nota_pend_cartcred.cod_espec_docto = p_cod_espec_docto
       and   b_nota_pend_cartcred.cod_ser_docto   = p_cod_ser_docto
       and   b_nota_pend_cartcred.cod_tit_ap      = p_cod_tit_ap
       and   b_nota_pend_cartcred.cod_parcela     = p_cod_parcela
       and   recid(b_nota_pend_cartcred)         <> p_rec_nota_pend_cartcred no-error.
    if avail b_nota_pend_cartcred then do:
        assign p_log_tit_ap_unico = no
               p_cod_empresa      = b_nota_pend_cartcred.cod_empresa
               p_cod_estab        = b_nota_pend_cartcred.cod_estab
               p_des_movimento    = 'Nota Pendente de Cart∆o de CrÇdito'.
        return.
    end.


    /* Begin_Include: i_pi_verifica_tit_unico_apb */
    &if defined (BF_FIN_BCOS_HISTORICOS) &then
        if  v_log_utiliza_mbh
        then do:

            def buffer bFornec for fornecedor.

            find first bFornec no-lock
                where bFornec.num_pessoa = p_num_pessoa no-error.
            if  avail bFornec then do:
                find first his_tit_ap_transf_histor no-lock
                    where his_tit_ap_transf_histor.cdn_fornecedor  = bFornec.cdn_fornecedor
                    and   his_tit_ap_transf_histor.cod_espec_docto = p_cod_espec_docto
                    and   his_tit_ap_transf_histor.cod_ser_docto   = p_cod_ser_docto
                    and   his_tit_ap_transf_histor.cod_tit_ap      = p_cod_tit_ap
                    and   his_tit_ap_transf_histor.cod_parcela     = p_cod_parcela no-error.
                if  avail his_tit_ap_transf_histor then do:
                    assign p_log_tit_ap_unico = no
                           p_cod_empresa      = v_cod_empres_usuar
                           p_cod_estab        = his_tit_ap_transf_histor.cod_estab.
                    return.
                end.
            end.
        end.
    &endif
    /* End_Include: i_pi_verifica_tit_unico_apb */

END PROCEDURE. /* pi_verifica_tit_unico_apb */
/*****************************************************************************
** Procedure Interna.....: pi_vld_antecip_pef_pend_more
** Descricao.............: pi_vld_antecip_pef_pend_more
** Criado por............: bre17230
** Criado em.............: 17/02/1999 16:10:44
** Alterado por..........: fut43112
** Alterado em...........: 22/04/2013 13:00:14
*****************************************************************************/
PROCEDURE pi_vld_antecip_pef_pend_more:

    /************************** Buffer Definition Begin *************************/

    &if "{&emsuni_version}" >= "1.00" &then
    def buffer b_fornecedor
        for fornecedor.
    &endif


    /*************************** Buffer Definition End **************************/

    /************************* Variable Definition Begin ************************/

    def var v_cod_empresa_uni
        as character
        format "x(3)":U
        label "Empresa"
        column-label "Empresa"
        no-undo.
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
    def var v_cod_estab_uni
        as character
        format "x(3)":U
        label "Est. Gera Lote Ènico"
        column-label "Estab"
        no-undo.
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
    def var v_cod_estab_uni
        as Character
        format "x(5)":U
        label "Est. Gera Lote Ènico"
        column-label "Estab"
        no-undo.
    &ENDIF
    def var v_cod_finalid_econ
        as character
        format "x(10)":U
        label "Finalidade Econìmica"
        column-label "Finalidade Econìmica"
        no-undo.
    def var v_cod_return
        as character
        format "x(40)":U
        no-undo.
    def var v_cod_val_barra
        as character
        format "x(50)":U
        no-undo.
    def var v_ind_finalid_ctbl_err
        as character
        format "X(30)":U
        label "Finalidade Cont†bil"
        column-label "Finalidade Cont†bil"
        no-undo.
    def var v_log_answer
        as logical
        format "Sim/N∆o"
        initial yes
        view-as toggle-box
        no-undo.
    def var v_log_impto_vincul_refer
        as logical
        format "Sim/N∆o"
        initial yes
        no-undo.
    def var v_log_permis_estab
        as logical
        format "Sim/N∆o"
        initial no
        view-as toggle-box
        no-undo.
    def var v_log_refer_uni
        as logical
        format "Sim/N∆o"
        initial yes
        no-undo.
    def var v_log_tit_ap_unico
        as logical
        format "Sim/N∆o"
        initial yes
        label "T°tulo Ènico"
        column-label "T°tulo Ènico"
        no-undo.
    def var v_nom_favorec_cheq
        as character
        format "x(40)":U
        label "Favorecido"
        column-label "Nome Favorecido"
        no-undo.
    def var v_val_barra
        as decimal
        format "->>,>>>,>>>,>>9.99":U
        decimals 2
        no-undo.
    def var v_val_sdo_rat_tit_ap
        as decimal
        format "->>>,>>>,>>9.99":U
        decimals 2
        label "Saldo a Ratear"
        column-label "Saldo a Ratear"
        no-undo.
    def var v_val_tot_impto
        as decimal
        format "->>>,>>>,>>9.99":U
        decimals 2
        label "Total a Ratear"
        column-label "Valor Total a Ratear"
        no-undo.


    /************************** Variable Definition End *************************/

    bloco2:
    do on error undo bloco2, return error:

        /* ## Continuaá∆o das validaá‰es iniciadas na pi-vld-antecip-pef-pend.  ##*/    
        find estabelecimento no-lock
            where estabelecimento.cod_estab = antecip_pef_pend.cod_estab no-error.
        find last param_empres_apb
            where param_empres_apb.cod_empresa = estabelecimento.cod_empresa no-error.
        if not avail param_empres_apb then do:
            assign v_num_mensagem   = 8744
                   v_cod_parameters = estabelecimento.cod_empresa.
            run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + &IF '{&emsfin_version}' >= '5.01' AND '{&emsfin_version}' <= '5.07' &THEN "cod_estab" &ELSE "cod_estab" &ENDIF,
                                             Input antecip_pef_pend.cod_estab,
                                             Input antecip_pef_pend.cod_refer,
                                             Input 0,
                                             Input "",
                                             Input 0,
                                             Input v_num_mensagem,
                                             Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.
        end.

        find indic_econ
            where indic_econ.cod_indic_econ = antecip_pef_pend.cod_indic_econ no-lock no-error.
        if  not avail indic_econ then do:
                assign v_num_mensagem   = 1284
                       v_cod_parameters = "Indicador Econìmico" /*l_indicador_economico*/  + "," + "Indicadores Econìmicos" /*l_indicadores_economicos*/ .
                run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + "cod_indic_econ",
                                                 Input antecip_pef_pend.cod_estab,
                                                 Input antecip_pef_pend.cod_refer,
                                                 Input 0,
                                                 Input "",
                                                 Input 0,
                                                 Input v_num_mensagem,
                                                 Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.    
        end.

        run pi_validar_indic_econ_movto (Input antecip_pef_pend.cod_indic_econ,
                                         Input antecip_pef_pend.dat_emis_docto,
                                         Input antecip_pef_pend.cod_empresa,
                                         output v_cod_return) /*pi_validar_indic_econ_movto*/.
        if  v_cod_return <> "OK" /*l_ok*/  then do:
            /* msg_block: */
            case entry(1, v_cod_return):    
                when "241" then assign v_num_mensagem  = 241.
                when "336" then assign v_num_mensagem  = 336.
                when "337" then assign v_num_mensagem  = 337.
                when "338" then assign v_num_mensagem  = 338.
                when "1199" then assign v_num_mensagem = 1199.
                otherwise assign v_num_mensagem = 1036.
            end /* case msg_block */.
            assign v_cod_parameters = ''.
            run pi_integr_apb_cria_msg_erro (Input "cod_empresa",
                                             Input antecip_pef_pend.cod_estab,
                                             Input antecip_pef_pend.cod_refer,
                                             Input 0,
                                             Input "",
                                             Input 0,
                                             Input v_num_mensagem,
                                             Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.
        end.

        run pi_verifica_tit_unico_apb (Input antecip_pef_pend.num_pessoa,
                                       Input antecip_pef_pend.cod_espec_docto,
                                       Input antecip_pef_pend.cod_ser_docto,
                                       Input antecip_pef_pend.cod_tit_ap,
                                       Input antecip_pef_pend.cod_parcela,
                                       Input ?,
                                       Input recid(antecip_pef_pend),
                                       Input ?,
                                       Input ?,
                                       output v_log_tit_ap_unico,
                                       output v_cod_empresa_uni,
                                       output v_cod_estab_uni,
                                       output v_des_movimento) /*pi_verifica_tit_unico_apb*/.

        if  v_log_tit_ap_unico = no then do:
            assign v_num_mensagem   = 754
                   v_cod_parameters = v_cod_estab_uni + "," + string(antecip_pef_pend.cdn_fornec) + "," + antecip_pef_pend.cod_espec_docto + "," + antecip_pef_pend.cod_ser_docto + "," + antecip_pef_pend.cod_tit_ap + "," + antecip_pef_pend.cod_parcela + "," + v_des_movimento.
            run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + &IF '{&emsfin_version}' >= '5.01' AND '{&emsfin_version}' <= '5.07' &THEN "cod_estab" &ELSE "cod_estab" &ENDIF,
                                             Input antecip_pef_pend.cod_estab,
                                             Input antecip_pef_pend.cod_refer,
                                             Input 0,
                                             Input "",
                                             Input 0,
                                             Input v_num_mensagem,
                                             Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.    
        end.

        if antecip_pef_pend.cod_portador <> "" then do:
            run pi_validar_portador (Input antecip_pef_pend.cod_portador,
                                     Input antecip_pef_pend.cod_estab,
                                     Input antecip_pef_pend.cod_indic_econ,
                                     Input antecip_pef_pend.dat_emis_docto,
                                     Input no,
                                     Input "",
                                     output v_ind_finalid_ctbl_err,
                                     output v_cod_finalid_econ,
                                     Input v_cod_cart_bcia) /*pi_validar_portador*/.
            if  return-value <> "OK" /*l_ok*/  then do:
                if  return-value = "506" then
                    assign v_num_mensagem   = 506.
                if  return-value = "775" then 
                    assign v_num_mensagem   = 775
                           v_cod_parameters = antecip_pef_pend.cod_portador + "," + antecip_pef_pend.cod_estab.
                if  return-value = "776" then
                    assign v_num_mensagem   = 776 
                           v_cod_parameters = v_cod_finalid_econ + "," + antecip_pef_pend.cod_portador + "," + antecip_pef_pend.cod_estab.

                run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + "cod_portador",
                                                 Input antecip_pef_pend.cod_estab,
                                                 Input antecip_pef_pend.cod_refer,
                                                 Input 0,
                                                 Input "",
                                                 Input 0,
                                                 Input v_num_mensagem,
                                                 Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.
              &if '{&frame_aux}' <> "" &then
                assign antecip_pef_pend.cod_portador:sensitive in frame f_adp_02_antecip_pef_pend = yes
                       v_log_habilit_portad = yes.
              &endif                                   
            end.
        end.
        else do:
            &if '{&frame_aux}' <> "" &then
                find first impto_impl_pend_ap no-lock
                    where impto_impl_pend_ap.cod_estab_refer = antecip_pef_pend.cod_estab
                      and impto_impl_pend_ap.cod_refer       = antecip_pef_pend.cod_refer no-error.
                if avail impto_impl_pend_ap then
                    /* N∆o foi informado portador para Antecipaá∆o. */
                    run pi_messages (input "show",
                                     input 13828,
                                     input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_13828*/.
            &endif
        end /* if */.


        assign v_val_sdo_rat_tit_ap = antecip_pef_pend.val_tit_ap.

        &if '{&frame_aux}' <> "" &then        
            calculo_valores:
            for each aprop_ctbl_pend_ap no-lock
                where aprop_ctbl_pend_ap.cod_estab = antecip_pef_pend.cod_estab
                  and aprop_ctbl_pend_ap.cod_refer = antecip_pef_pend.cod_refer:
                assign v_val_sdo_rat_tit_ap = v_val_sdo_rat_tit_ap - aprop_ctbl_pend_ap.val_aprop_ctbl.
            end.
        &else
            calculo_valores:
            for each tt_integr_apb_aprop_ctbl_pend no-lock
                where tt_integr_apb_aprop_ctbl_pend.ttv_rec_antecip_pef_pend = tt_integr_apb_antecip_pef_p1.ttv_rec_antecip_pef_pend:
                assign v_val_sdo_rat_tit_ap = v_val_sdo_rat_tit_ap - tt_integr_apb_aprop_ctbl_pend.tta_val_aprop_ctbl.
            end.
        &endif

        if  v_val_sdo_rat_tit_ap > 0 then do:
            assign v_num_mensagem   = 1001.
            run pi_integr_apb_cria_msg_erro (Input "cod_empresa",
                                             Input antecip_pef_pend.cod_estab,
                                             Input antecip_pef_pend.cod_refer,
                                             Input 0,
                                             Input "",
                                             Input 0,
                                             Input v_num_mensagem,
                                             Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.    
        end.

        if  search("prgfin/apb/apb794za.r") = ? and search("prgfin/apb/apb794za.py") = ? then do:
            if  v_cod_dwb_user begins 'es_' then
                return "Programa execut†vel n∆o foi encontrado:" /*l_programa_nao_encontrado*/  + "prgfin/apb/apb794za.py".
            else do:
                message getStrTrans("Programa execut†vel n∆o foi encontrado:", "APB") /*l_programa_nao_encontrado*/  "prgfin/apb/apb794za.py"
                       view-as alert-box error buttons ok.
                return.
            end.
        end.
        else
            run prgfin/apb/apb794za.py (Input antecip_pef_pend.cod_estab,
                                    Input antecip_pef_pend.cod_refer,
                                    Input "",
                                    Input 0,
                                    Input 0,
                                    Input yes,
                                    Input antecip_pef_pend.dat_emis_docto,
                                    Input "Retido" /*l_retido*/,
                                    output v_log_impto_vincul_refer,
                                    output v_val_tot_impto,
                                    Input recid(bord_ap),
                                    Input recid(cheq_ap),
                                    Input recid(item_lote_pagto)) /*prg_fnc_verificar_impto_vincul_refer*/.
        if  antecip_pef_pend.val_tit_ap - v_val_tot_impto <= 0 then do:
            assign v_num_mensagem   = 1113.
            run pi_integr_apb_cria_msg_erro (Input "cod_empresa",
                                             Input antecip_pef_pend.cod_estab,
                                             Input antecip_pef_pend.cod_refer,
                                             Input 0,
                                             Input "",
                                             Input 0,
                                             Input v_num_mensagem,
                                             Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.    
        end.

        assign v_val_barra = 0.
       &if '{&emsfin_version}' >= "5.05" &then
        if  antecip_pef_pend.cb4_tit_ap_bco_cobdor <> "" and
            antecip_pef_pend.cb4_tit_ap_bco_cobdor <> "00000000000000000000000000000000000000000000" then do:
            assign v_cod_val_barra = substring(antecip_pef_pend.cb4_tit_ap_bco_cobdor,38,8).
            if  dec(substring(antecip_pef_pend.cb4_tit_ap_bco_cobdor,46,2)) > 0 then do:
                assign v_cod_val_barra = v_cod_val_barra + "," +
                                         substring(antecip_pef_pend.cb4_tit_ap_bco_cobdor,46,2).
            end.
            assign v_val_barra = dec(v_cod_val_barra).
            if  v_log_funcao_cod_barra then do:
                if  length(antecip_pef_pend.cb4_tit_ap_bco_cobdor) = 48 then do:
                    assign v_cod_val_barra = substring(antecip_pef_pend.cb4_tit_ap_bco_cobdor,5,7) +
                                             substring(antecip_pef_pend.cb4_tit_ap_bco_cobdor,13,2).
                    if  dec(substring(antecip_pef_pend.cb4_tit_ap_bco_cobdor,15,2)) > 0 then do:
                        assign v_cod_val_barra = v_cod_val_barra + "," + 
                                                substring(antecip_pef_pend.cb4_tit_ap_bco_cobdor,15,2).
                    end.
                    assign v_val_barra = dec(v_cod_val_barra).
                end.
            end.
        end.
       &endif

        if  v_val_barra > 0
        and antecip_pef_pend.val_tit_ap - v_val_tot_impto <> v_val_barra then do:
            if  v_ind_modo_impl = "On-Line" /*l_online*/  then do:
                run pi_messages (input "show",
                                 input 12840,
                                 input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                   antecip_pef_pend.val_tit_ap - v_val_tot_impto, v_val_barra)).
                assign v_log_answer = (if   return-value = "yes" then yes
                                       else if return-value = "no" then no
                                       else ?) /*msg_12840*/.
                if  not v_log_answer or v_log_answer = ? then do:
                    return error.
                end.
            end.
        end.

        if  v_ind_modo_pagto = "Cheque" /*l_cheque*/  then do:
            if  antecip_pef_pend.ind_favorec_cheq = " " then do:
                assign v_num_mensagem   = 3703
                       v_cod_parameters = "Favorecido" /*l_favorecido*/ .
                run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + "ind_favorec_cheq",
                                                 Input antecip_pef_pend.cod_estab,
                                                 Input antecip_pef_pend.cod_refer,
                                                 Input 0,
                                                 Input "",
                                                 Input 0,
                                                 Input v_num_mensagem,
                                                 Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.        
            end.

            if  antecip_pef_pend.num_talon_cheq <> 0 and avail portad_finalid_econ then do:
                find talon_cheq no-lock
                    where talon_cheq.num_talon_cheq = antecip_pef_pend.num_talon_cheq
                      and talon_cheq.cod_cta_corren = portad_finalid_econ.cod_cta_corren no-error.
                if  not avail talon_cheq then do:
                    assign v_num_mensagem   = 3704
                           v_cod_parameters = portad_finalid_econ.cod_cta_corren.
                    run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + "num_talon_cheq",
                                                     Input antecip_pef_pend.cod_estab,
                                                     Input antecip_pef_pend.cod_refer,
                                                     Input 0,
                                                     Input "",
                                                     Input 0,
                                                     Input v_num_mensagem,
                                                     Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.
                end.
                else do:
                    if  talon_cheq.ind_sit_talon_cheq <> "Liberado" /*l_liberado*/  then do:
                        assign v_num_mensagem   = 3650.
                        run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + "ind_sit_talon_cheq",
                                                         Input antecip_pef_pend.cod_estab,
                                                         Input antecip_pef_pend.cod_refer,
                                                         Input 0,
                                                         Input "",
                                                         Input 0,
                                                         Input v_num_mensagem,
                                                         Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/. 
                    end.
                end.    
                    run pi_validar_usuar_talon_cheq (Input antecip_pef_pend.num_talon_cheq,
                                                     Input portad_finalid_econ.cod_cta_corren) /*pi_validar_usuar_talon_cheq*/.
                if  return-value = "NOK" /*l_nok*/  then do:
                    assign v_num_mensagem   = 4721
                           v_cod_parameters = v_cod_usuar_corren + "," + string(antecip_pef_pend.num_talon_cheq) + "," + portad_finalid_econ.cod_cta_corren.
                    run pi_integr_apb_cria_msg_erro (Input "cod_empresa",
                                                     Input antecip_pef_pend.cod_estab,
                                                     Input antecip_pef_pend.cod_refer,
                                                     Input 0,
                                                     Input "",
                                                     Input 0,
                                                     Input v_num_mensagem,
                                                     Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.    
                end.

                if avail fornecedor then do:
                   if  (antecip_pef_pend.ind_favorec_cheq = "Fornecedor" /*l_fornecedor*/ 
                   and fornecedor.nom_pessoa <> antecip_pef_pend.nom_favorec_cheq)
                   or  (v_log_agrup_cheq_cod_fornec
                   and antecip_pef_pend.ind_favorec_cheq = "Cod Fornecedor" /*l_cod_fornec*/ 
                   and antecip_pef_pend.nom_favorec_cheq <> CAPS("Fornecedor:" /*l_fornecedor:*/ ) + TRIM(string(fornecedor.cdn_fornecedor))) then do:
                       assign v_num_mensagem   = 1065.
                       run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + "nom_favorec_cheq",
                                                        Input antecip_pef_pend.cod_estab,
                                                        Input antecip_pef_pend.cod_refer,
                                                        Input 0,
                                                        Input "",
                                                        Input 0,
                                                        Input v_num_mensagem,
                                                        Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/. 
                   end.
                end.   
                do on error undo , return error:
                    run pi_validar_cheque_apb 

                                              (Input antecip_pef_pend.cod_estab,
                                               Input antecip_pef_pend.cod_portador,
                                               Input v_cod_cart_bcia,
                                               Input antecip_pef_pend.cod_finalid_econ,
                                               Input portad_finalid_econ.cod_cta_corren,
                                               Input antecip_pef_pend.num_talon_cheq,
                                               Input antecip_pef_pend.num_cheque,
                                               Input antecip_pef_pend.dat_emis_docto,
                                               Input antecip_pef_pend.nom_favorec_cheq,
                                               Input ?,
                                               Input recid( antecip_pef_pend ),
                                               output v_cod_return) /* pi_validar_cheque_apb*/.
                    if  v_cod_return <> "OK" /*l_ok*/  then do:
                        assign v_num_mensagem   = int(v_cod_return).
                        run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + "ind_favorec_cheq",
                                                         Input antecip_pef_pend.cod_estab,
                                                         Input antecip_pef_pend.cod_refer,
                                                         Input 0,
                                                         Input "",
                                                         Input 0,
                                                         Input v_num_mensagem,
                                                         Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.    
                    end.
                end.
                /* /* -- Valida se o registro est† na Base Hist¢rica */
                &if '{&emsfin_version}' > "5.05" &then
                    if  can-find(first his_cheq no-lock
                            where his_cheq.cod_cta_corren = portad_finalid_econ.cod_cta_corren
                              and his_cheq.num_talon_cheq = antecip_pef_pend.num_talon_cheq
                              and his_cheq.num_cheque = antecip_pef_pend.num_cheque)
                    then do:
                        assign v_num_mensagem   = 1065
                               v_cod_parameters = ''.
                        @run(pi_integr_apb_cria_msg_erro(@fx_tabpro( antecip_pef_pend, name ) + "." + @fx_objpro(cod_espec_docto,name),
                                                         antecip_pef_pend.cod_estab, antecip_pef_pend.cod_refer, 0, "", 0, v_num_mensagem, v_cod_parameters)).
                    end.
                &endif
                */
            end.
            if  antecip_pef_pend.ind_favorec_cheq = "Outros" /*l_outros*/ 
            and antecip_pef_pend.nom_favorec_cheq = ""        
        &if '{&frame_aux}' <> "" &then
            and antecip_pef_pend.ind_favorec_cheq:sensitive in frame f_adp_02_antecip_pef_pend = yes
        &endif                                           
            then do:
                assign v_num_mensagem   = 1985.
                run pi_integr_apb_cria_msg_erro (Input "cod_empresa",
                                                 Input antecip_pef_pend.cod_estab,
                                                 Input antecip_pef_pend.cod_refer,
                                                 Input 0,
                                                 Input "",
                                                 Input 0,
                                                 Input v_num_mensagem,
                                                 Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.    
            end.
        end.    
        run pi_verifica_impto_vincul_refer_informado (Input antecip_pef_pend.cdn_fornecedor,
                                                      Input antecip_pef_pend.cod_estab,
                                                      Input antecip_pef_pend.cod_refer,
                                                      Input "",
                                                      Input 0,
                                                      Input 0,
                                                      Input "Antecipaá∆o" /*l_antecipacao*/,
                                                      Input antecip_pef_pend.dat_emis_docto,
                                                      output v_cod_return) /*pi_verifica_impto_vincul_refer_informado*/.
        if  v_cod_return <> "OK" /*l_ok*/  then do:
            &if '{&frame_aux}' <> "" &then
                run pi_messages (input "show",
                                 input 4800,
                                 input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")).
                assign v_log_answer = (if   return-value = "yes" then yes
                                       else if return-value = "no" then no
                                       else ?) /*msg_4800*/.
                if  v_log_answer = no or v_log_answer = ? then
                    return error.
            &endif
        end.
        &if '{&frame_aux}' <> "" &then            
            /* *** Verifica se o fornecedor j† teve retená‰es de impostos em per°odos anteriores ***
              *** e n∆o teve retená‰es neste t°tulo - PA DIRF 2005 - EGER. *** */
            find first b_fornecedor no-lock
                where b_fornecedor.cod_empresa = antecip_pef_pend.cod_empresa
                and   b_fornecedor.cdn_fornecedor = antecip_pef_pend.cdn_fornecedor no-error.
            if avail b_fornecedor 
            and b_fornecedor.num_pessoa mod 2 = 0 then do:
                run prgfin/apb/apb928za.py (Input antecip_pef_pend.cdn_fornecedor,
                                           Input b_fornecedor.num_pessoa,
                                           Input antecip_pef_pend.cod_empresa,
                                           Input antecip_pef_pend.cod_estab,
                                           Input antecip_pef_pend.cod_refer,
                                           Input "",
                                           Input 0,
                                           Input 0,
                                           Input "IMPL" /*l_impl*/ ,
                                           output v_cod_return).
                if  v_cod_return <> "" then do:
                    run pi_messages (input "show",
                                     input 14357,
                                     input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                       entry(1,v_cod_return),entry(2,v_cod_return),entry(3,v_cod_return),entry(4,v_cod_return),entry(5,v_cod_return),entry(6,v_cod_return),entry(7,v_cod_return))).
                    assign v_log_answer = (if   return-value = "yes" then yes
                                           else if return-value = "no" then no
                                           else ?) /*msg_14357*/.
                    if  v_log_answer = no or v_log_answer = ? then do:
                        return error.
                    end.
                end.
            end.
        &endif

        if antecip_pef_pend.cod_forma_pagto <> "" then do:
           find forma_pagto
                where forma_pagto.cod_forma_pagto = antecip_pef_pend.cod_forma_pagto no-lock no-error.
           if not avail forma_pagto then do:
               assign v_num_mensagem   = 605.
               run pi_integr_apb_cria_msg_erro (Input "cod_empresa",
                                                Input antecip_pef_pend.cod_estab,
                                                Input antecip_pef_pend.cod_refer,
                                                Input 0,
                                                Input "",
                                                Input 0,
                                                Input v_num_mensagem,
                                                Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.
           end.   
        end.

        /* Valida se existe conta saldo para o grupo fornecedor */
        if avail fornecedor then  do:
           find first cta_grp_fornec no-lock
                where cta_grp_fornec.cod_empresa         = antecip_pef_pend.cod_empresa
                and   cta_grp_fornec.cod_espec_docto     = antecip_pef_pend.cod_espec_docto
                and   cta_grp_fornec.ind_tip_espec_docto = "Nenhum" /*l_nenhum*/ 
                and   cta_grp_fornec.cod_grp_fornec      = fornecedor.cod_grp_fornec
                and   cta_grp_fornec.cod_finalid_econ    = antecip_pef_pend.cod_finalid_econ
                and   cta_grp_fornec.ind_finalid_ctbl    = "Saldo" /*l_saldo*/ 
                and   cta_grp_fornec.dat_inic_valid     <= antecip_pef_pend.dat_emis_docto
                and   cta_grp_fornec.dat_fim_valid      >= antecip_pef_pend.dat_emis_docto no-error.
           if  not avail cta_grp_fornec then do:
               find first cta_grp_fornec no-lock
                    where cta_grp_fornec.cod_empresa         = antecip_pef_pend.cod_empresa
                    and   cta_grp_fornec.cod_espec_docto     = ""
                    and   cta_grp_fornec.ind_tip_espec_docto = "Antecipaá∆o" /*l_antecipacao*/ 
                    and   cta_grp_fornec.cod_grp_fornec      = fornecedor.cod_grp_fornec
                    and   cta_grp_fornec.cod_finalid_econ    = antecip_pef_pend.cod_finalid_econ
                    and   cta_grp_fornec.ind_finalid_ctbl    = "Saldo" /*l_saldo*/ 
                    and   cta_grp_fornec.dat_inic_valid     <= antecip_pef_pend.dat_emis_docto
                    and   cta_grp_fornec.dat_fim_valid      >= antecip_pef_pend.dat_emis_docto no-error.
               if  not avail cta_grp_fornec then do:
               &if '{&frame_aux}' = "" &then        
                   assign v_num_mensagem   = 4159
                          v_cod_parameters = "Saldo" /*l_saldo*/  + "," + antecip_pef_pend.cod_espec_docto + "," + fornecedor.cod_grp_fornec + "," + antecip_pef_pend.cod_finalid_econ + "," + string(antecip_pef_pend.dat_emis_docto).
                   run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + &IF '{&emsfin_version}' >= '5.01' AND '{&emsfin_version}' <= '5.07' &THEN "cod_estab" &ELSE "cod_estab" &ENDIF,
                                                    Input antecip_pef_pend.cod_estab,
                                                    Input antecip_pef_pend.cod_refer,
                                                    Input 0,
                                                    Input "",
                                                    Input 0,
                                                    Input v_num_mensagem,
                                                    Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.
               &else
                   /* Conta &1 inexistente para &2, &3, &4, &5, &6 ! */
                   run pi_messages (input "show",
                                    input 755,
                                    input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                       "Saldo" /*l_saldo*/  , v_cod_empres_usuar, antecip_pef_pend.cod_espec_docto, fornecedor.cod_grp_fornec, v_cod_finalid_econ, antecip_pef_pend.dat_emis_docto)) /*msg_755*/.
                   return error.
               &endif
               end.
           end.
           if avail cta_grp_fornec then do:
              for each  aprop_ctbl_pend_ap no-lock
                  where aprop_ctbl_pend_ap.cod_estab = antecip_pef_pend.cod_estab
                  and   aprop_ctbl_pend_ap.cod_refer = antecip_pef_pend.cod_refer:
                  if can-find(cta_restric_unid_negoc where
                              cta_restric_unid_negoc.cod_unid_organ     = aprop_ctbl_pend_ap.cod_empresa and
                              cta_restric_unid_negoc.cod_plano_cta_ctbl = cta_grp_fornec.cod_plano_cta_ctbl and
                              cta_restric_unid_negoc.cod_cta_ctbl       = cta_grp_fornec.cod_cta_ctbl and
                              cta_restric_unid_negoc.cod_unid_negoc     = aprop_ctbl_pend_ap.cod_unid_negoc) then do:
                     &if '{&frame_aux}' = "" &then        
                         assign v_num_mensagem   = 8489
                                v_cod_parameters = "Unidade de Neg¢cio" /*l_unidade_de_negocio*/  + ',' + cta_grp_fornec.cod_cta_ctbl + ',' + aprop_ctbl_pend_ap.cod_unid_negoc + ',' + "na" /*l_na*/ .
                         run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + &IF '{&emsfin_version}' >= '5.01' AND '{&emsfin_version}' <= '5.07' &THEN "cod_estab" &ELSE "cod_estab" &ENDIF,
                                                          Input antecip_pef_pend.cod_estab,
                                                          Input antecip_pef_pend.cod_refer,
                                                          Input 0,
                                                          Input "",
                                                          Input 0,
                                                          Input v_num_mensagem,
                                                          Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.
                     &else
                         /* Conta Cont†bil incorreta para &1 ! */
                         run pi_messages (input "show",
                                          input 8489,
                                          input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                             "Unidade de Neg¢cio" /*l_unidade_de_negocio*/ ,cta_grp_fornec.cod_cta_ctbl,aprop_ctbl_pend_ap.cod_unid_negoc,"na" /*l_na*/)) /*msg_8489*/.
                         return error.
                     &endif
                  end.
                  if  aprop_ctbl_pend_ap.cod_plano_cta_ctbl = cta_grp_fornec.cod_plano_cta_ctbl
                  and aprop_ctbl_pend_ap.cod_cta_ctbl       = cta_grp_fornec.cod_cta_ctbl then do:
                      &if '{&frame_aux}' = "" &then        
                          assign v_num_mensagem   = 13202
                                 v_cod_parameters = string(aprop_ctbl_pend_ap.cod_cta_ctbl).
                          run pi_integr_apb_cria_msg_erro (Input "antecip_pef_pend":U + "." + &IF '{&emsfin_version}' >= '5.01' AND '{&emsfin_version}' <= '5.07' &THEN "cod_estab" &ELSE "cod_estab" &ENDIF,
                                                           Input antecip_pef_pend.cod_estab,
                                                           Input antecip_pef_pend.cod_refer,
                                                           Input 0,
                                                           Input "",
                                                           Input 0,
                                                           Input v_num_mensagem,
                                                           Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.
                      &else
                         /* Conta cont†bil pertence ao fornecedor da antecipaá∆o ! */
                         run pi_messages (input "show",
                                          input 13202,
                                          input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                             string(aprop_ctbl_pend_ap.cod_cta_ctbl))) /*msg_13202*/.
                         return error.
                     &endif
                  end.
                  find first portad_finalid_econ no-lock
                       where portad_finalid_econ.cod_estab        = antecip_pef_pend.cod_estab       
                         and portad_finalid_econ.cod_portador     = antecip_pef_pend.cod_portador    
                         and portad_finalid_econ.cod_cart_bcia    = antecip_pef_pend.cod_cart_bcia   
                         and portad_finalid_econ.cod_finalid_econ = antecip_pef_pend.cod_finalid_econ no-error.
                  if avail portad_finalid_econ then do:
                      find first cta_corren no-lock
                          where cta_corren.cod_cta_corren = portad_finalid_econ.cod_cta_corren no-error.
                      if avail cta_corren then do:
                         find first cta_corren_cta_ctbl no-lock
                             where cta_corren_cta_ctbl.cod_cta_corren = cta_corren.cod_cta_corren
                               and cta_corren_cta_ctbl.dat_inic_valid <= antecip_pef_pend.dat_emis_docto
                               and cta_corren_cta_ctbl.dat_fim_valid  >= antecip_pef_pend.dat_emis_docto no-error.
                          if avail cta_corren_cta_ctbl then do:
                             if can-find(cta_restric_unid_negoc where
                                         cta_restric_unid_negoc.cod_unid_organ     = cta_corren.cod_empresa and
                                         cta_restric_unid_negoc.cod_plano_cta_ctbl = cta_corren_cta_ctbl.cod_plano_cta_ctbl and
                                         cta_restric_unid_negoc.cod_cta_ctbl       = cta_corren_cta_ctbl.cod_cta_ctbl and
                                         cta_restric_unid_negoc.cod_unid_negoc     = cta_corren.cod_unid_negoc) then do:
                                &if '{&frame_aux}' = "" &then        
                                    assign v_num_mensagem   = 13287
                                           v_cod_parameters = string(cta_corren_cta_ctbl.cod_cta_ctbl) + ","  + string(cta_corren.cod_unid_negoc).
                                    run pi_integr_apb_cria_msg_erro (Input 'antecip_pef_pend':U + "." + 'cod_estab',
                                                                     Input antecip_pef_pend.cod_estab,
                                                                     Input antecip_pef_pend.cod_refer,
                                                                     Input 0,
                                                                     Input "",
                                                                     Input 0,
                                                                     Input v_num_mensagem,
                                                                     Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.
                                &else
                                    /* Conta Cont†bil &1 incorreta para a Unidade de Neg¢cio ! */
                                    run pi_messages (input "show",
                                                     input 13287,
                                                     input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                                        string(cta_corren_cta_ctbl.cod_cta_ctbl), string (cta_corren.cod_unid_negoc))) /*msg_13287*/.
                                    return error.
                                &endif
                             end. 
                         end.
                      end.
                  end.
              end.
           end.
        end.   

        /* Valida situaá∆o do m¢dulo */
        run pi_retornar_sit_movimen_modul 

                                          (Input "APB" /*l_apb*/ ,
                                           Input antecip_pef_pend.cod_empresa,
                                           Input antecip_pef_pend.dat_emis_docto,
                                           Input "Habilitado" /*l_habilitado*/ ,
                                           output v_cod_return) /* pi_retornar_sit_movimen_modul*/.

        if  not can-do(v_cod_return, "Habilitado" /*l_habilitado*/ )
        then do:
            &if '{&frame_aux}' <> "" &then
                run pi_messages (input "show",
                                 input 7971,
                                 input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")).
                assign v_log_answer = (if   return-value = "yes" then yes
                                       else if return-value = "no" then no
                                       else ?) /*msg_7971*/.
                if  v_log_answer = no or v_log_answer = ? then do:
                   assign v_wgh_focus = bt_rat_val:handle in frame f_adp_02_antecip_pef_pend. 
                   return error.
                end.   
            &endif               
        end /* if */.  

        run pi_vld_antecip_pef_pend_more_aux /*pi_vld_antecip_pef_pend_more_aux*/.
    end /* do bloco2 */.
END PROCEDURE. /* pi_vld_antecip_pef_pend_more */
/*****************************************************************************
** Procedure Interna.....: pi_acha_fornecedor_informado
** Descricao.............: pi_acha_fornecedor_informado
** Criado por............: 
** Criado em.............: // 
** Alterado por..........: bre17191
** Alterado em...........: 04/08/1999 09:03:03
*****************************************************************************/
PROCEDURE pi_acha_fornecedor_informado:

    /************************ Parameter Definition Begin ************************/

    def output param p_cdn_fornecedor
        as Integer
        format ">>>,>>>,>>9"
        no-undo.
    def output param p_num_pessoa
        as integer
        format ">>>,>>>,>>9"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_cdn_fornecedor
        as Integer
        format ">>>,>>>,>>9":U
        label "Fornecedor"
        column-label "Fornecedor"
        no-undo.
    def var v_cod_pais
        as character
        format "x(3)":U
        label "Pa°s"
        column-label "Pa°s"
        no-undo.
    def var v_log_reg_corporat_1
        as logical
        format "Sim/N∆o"
        initial no
        view-as toggle-box
        label "Registro Corporativo"
        column-label "Registro Corporativo"
        no-undo.


    /************************** Variable Definition End *************************/

    assign v_log_reg_corporat_1 = no.
    if  v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend = ""
    or  v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend = ?
    then do:
        assign p_cdn_fornecedor = 0
               p_num_pessoa     = 0.
        return.
    end /* if */.

    assign v_cdn_fornecedor = integer(v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend) no-error.
    assign v_cod_fornec_infor
           v_cod_pais       = fornecedor.cod_pais:screen-value in frame f_adp_02_antecip_pef_pend.

    if 'add_antecip_pef_pend' = 'add_antecip_pef_pend'
    or 'add_antecip_pef_pend' = 'add_antecip_pef_pend_pef'
    or 'add_antecip_pef_pend' = 'add_item_lote_impl_ap'
    or 'add_antecip_pef_pend' = 'add_item_lote_impl_ap_previsao'
    or 'add_antecip_pef_pend' = 'add_lote_impl_tit_ap_fatura'
    or 'add_antecip_pef_pend' = 'mod_antecip_pef_pend_base'
    or 'add_antecip_pef_pend' = 'mod_antecip_pef_pend_pef'
    or 'add_antecip_pef_pend' = 'mod_item_lote_impl_ap_base'
    or 'add_antecip_pef_pend' = 'mod_item_lote_impl_ap_previsao_base'
    or 'add_antecip_pef_pend' = 'mod_item_lote_impl_ap_base' then do:
        &if '{&emsfin_version}' >= '5.03' &then
            find last param_geral_apb no-lock no-error.
            if avail param_geral_apb then do:
                if param_geral_apb.log_reg_corporat then do:
                    assign v_log_reg_corporat_1 = yes.
                    run pi_acha_fornecedor_informado_cor (Input v_cdn_fornecedor,
                                                          Input v_cod_fornec_infor,
                                                          Input v_cod_pais) /*pi_acha_fornecedor_informado_cor*/.
                end.
            end.
        &endif    
        if not v_log_reg_corporat_1 then do:
            run pi_acha_fornecedor_informado_error (Input v_cdn_fornecedor,
                                                    Input v_cod_fornec_infor,
                                                    Input v_cod_pais) /*pi_acha_fornecedor_informado_error*/.
        end.
    end.
    else do:
        run pi_acha_fornecedor_informado_error (Input v_cdn_fornecedor,
                                                Input v_cod_fornec_infor,
                                                Input v_cod_pais) /*pi_acha_fornecedor_informado_error*/.
    end.    

    if  avail fornecedor
    then do:
        assign p_cdn_fornecedor = fornecedor.cdn_fornecedor
               p_num_pessoa     = fornecedor.num_pessoa.
    end /* if */.
    else do:
        assign p_cdn_fornecedor = 0
               p_num_pessoa     = 0.
    end /* else */.
END PROCEDURE. /* pi_acha_fornecedor_informado */
/*****************************************************************************
** Procedure Interna.....: pi_acha_fornecedor_informado_cor
** Descricao.............: pi_acha_fornecedor_informado_cor
** Criado por............: bre17191
** Criado em.............: 25/06/1999 17:11:14
** Alterado por..........: bre17191
** Alterado em...........: 04/08/1999 09:00:41
*****************************************************************************/
PROCEDURE pi_acha_fornecedor_informado_cor:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cdn_fornecedor
        as Integer
        format ">>>,>>>,>>9"
        no-undo.
    def Input param p_cod_fornec_infor
        as character
        format "x(20)"
        no-undo.
    def Input param p_cod_pais
        as character
        format "x(3)"
        no-undo.


    /************************* Parameter Definition End *************************/

    if  error-status:get-number(1) = 0
    then do:
        find fornecedor no-lock
             where fornecedor.cod_empresa = estabelecimento.cod_empresa
               and fornecedor.cdn_fornecedor = p_cdn_fornecedor /* cl_acha_fornecedor_codigo of fornecedor*/ no-error.
        if  not avail fornecedor
        then do:
            find fornecedor no-lock
                 where fornecedor.cod_empresa = estabelecimento.cod_empresa
                   and fornecedor.nom_abrev = p_cod_fornec_infor /* cl_acha_fornecedor_nome_abrev of fornecedor*/ no-error.
            if  not avail fornecedor
            then do:
                find first fornecedor no-lock
                     where fornecedor.cod_empresa = estabelecimento.cod_empresa
                       and fornecedor.cod_pais = p_cod_pais
                       and fornecedor.cod_id_feder = p_cod_fornec_infor /* cl_acha_fornecedor_id_federal of fornecedor*/ no-error.
            end /* if */.
        end /* if */.
    end /* if */.
    else do:
        find fornecedor no-lock
             where fornecedor.cod_empresa = estabelecimento.cod_empresa
               and fornecedor.nom_abrev = p_cod_fornec_infor /* cl_acha_fornecedor_nome_abrev of fornecedor*/ no-error.
        if  not avail fornecedor
        then do:
            find first fornecedor no-lock
                 where fornecedor.cod_empresa = estabelecimento.cod_empresa
                   and fornecedor.cod_pais = p_cod_pais
                   and fornecedor.cod_id_feder = p_cod_fornec_infor /* cl_acha_fornecedor_id_federal of fornecedor*/ no-error.
        end /* if */.
    end /* else */.

END PROCEDURE. /* pi_acha_fornecedor_informado_cor */
/*****************************************************************************
** Procedure Interna.....: pi_acha_fornecedor_informado_error
** Descricao.............: pi_acha_fornecedor_informado_error
** Criado por............: bre17191
** Criado em.............: 25/06/1999 17:11:27
** Alterado por..........: bre17191
** Alterado em...........: 04/08/1999 09:01:06
*****************************************************************************/
PROCEDURE pi_acha_fornecedor_informado_error:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cdn_fornecedor
        as Integer
        format ">>>,>>>,>>9"
        no-undo.
    def Input param p_cod_fornec_infor
        as character
        format "x(20)"
        no-undo.
    def Input param p_cod_pais
        as character
        format "x(3)"
        no-undo.


    /************************* Parameter Definition End *************************/

    if  error-status:get-number(1) = 0
    then do:
        find fornecedor no-lock
             where fornecedor.cod_empresa = v_cod_empres_usuar
               and fornecedor.cdn_fornecedor = p_cdn_fornecedor /* cl_acha_fornecedor_codigo of fornecedor*/ no-error.
        if  not avail fornecedor
        then do:
            find fornecedor no-lock
                 where fornecedor.cod_empresa = v_cod_empres_usuar
                   and fornecedor.nom_abrev = p_cod_fornec_infor /* cl_acha_fornecedor_nome_abrev of fornecedor*/ no-error.
            if  not avail fornecedor
            then do:
                find first fornecedor no-lock
                     where fornecedor.cod_empresa = v_cod_empres_usuar
                       and fornecedor.cod_pais = p_cod_pais
                       and fornecedor.cod_id_feder = p_cod_fornec_infor /* cl_acha_fornecedor_id_federal of fornecedor*/ no-error.
            end /* if */.
        end /* if */.
    end /* if */.
    else do:
        find fornecedor no-lock
             where fornecedor.cod_empresa = v_cod_empres_usuar
               and fornecedor.nom_abrev = p_cod_fornec_infor /* cl_acha_fornecedor_nome_abrev of fornecedor*/ no-error.
        if  not avail fornecedor
        then do:
            find first fornecedor no-lock
                 where fornecedor.cod_empresa = v_cod_empres_usuar
                   and fornecedor.cod_pais = p_cod_pais
                   and fornecedor.cod_id_feder = p_cod_fornec_infor /* cl_acha_fornecedor_id_federal of fornecedor*/ no-error.
        end /* if */.
    end /* else */.

END PROCEDURE. /* pi_acha_fornecedor_informado_error */
/*****************************************************************************
** Procedure Interna.....: pi_verificar_val_usuar
** Descricao.............: pi_verificar_val_usuar
** Criado por............: 
** Criado em.............: // 
** Alterado por..........: fut43117
** Alterado em...........: 20/04/2011 16:18:29
*****************************************************************************/
PROCEDURE pi_verificar_val_usuar:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_estab
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def Input param p_dat_transacao
        as date
        format "99/99/9999"
        no-undo.
    def Input param p_ind_tip_verific
        as character
        format "X(08)"
        no-undo.
    def Input param p_val_pagto
        as decimal
        format "->>>,>>>,>>9.99"
        decimals 2
        no-undo.
    def Input param p_val_lim_liber_usuar_movto
        as decimal
        format "->>>,>>>,>>9.99"
        decimals 2
        no-undo.
    def Input param p_val_lim_liber_usuar_mes
        as decimal
        format "->>,>>>,>>>,>>9.99"
        decimals 2
        no-undo.
    def Input param p_val_lim_pagto_usuar_movto
        as decimal
        format "->>>,>>>,>>9.99"
        decimals 2
        no-undo.
    def Input param p_val_lim_pagto_usuar_mes
        as decimal
        format "->>,>>>,>>>,>>9.99"
        decimals 2
        no-undo.
    def Input param p_cod_finalid_econ
        as character
        format "x(10)"
        no-undo.
    def Input param p_cod_indic_econ
        as character
        format "x(8)"
        no-undo.
    def output param p_cod_return_liber_pagto
        as character
        format "x(8)"
        no-undo.
    def output param p_cod_return_pagto
        as character
        format "x(8)"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_cod_empres_usuar_8
        as character
        format "x(8)":U
        no-undo.
    def var v_cod_return
        as character
        format "x(40)":U
        no-undo.
    def var v_dat_pagto_fasb
        as date
        format "99/99/9999":U
        initial today
        no-undo.
    def var v_ind_calc_fasb
        as character
        format "X(10)":U
        no-undo.
    def var v_ind_tip_conver
        as character
        format "X(08)":U
        label "Tipo Convers∆o"
        column-label "Tipo Convers∆o"
        no-undo.
    def var v_log_calc_val_pres
        as logical
        format "Sim/N∆o"
        initial yes
        label "Calc Valor Presente"
        column-label "Calc Valor Presente"
        no-undo.
    def var v_log_calc_variac
        as logical
        format "Sim/N∆o"
        initial no
        label "Calcula Variaá∆o"
        column-label "Calcula Variaá∆o"
        no-undo.
    def var v_log_calc_variac_fasb
        as logical
        format "Sim/N∆o"
        initial no
        label "Calc Variaá∆o FASB"
        column-label "Calc Variaá∆o FASB"
        no-undo.
    def var v_val_sdo_orig_ult_correc_val
        as decimal
        format "->>,>>>,>>>,>>9.99":U
        decimals 2
        no-undo.
    def var v_val_tot_liber                  as decimal         no-undo. /*local*/
    def var v_val_tot_pagto                  as decimal         no-undo. /*local*/


    /************************** Variable Definition End *************************/

    assign v_cod_empres_usuar_8 = v_cod_empres_usuar.

    if 'add_antecip_pef_pend' = 'add_antecip_pef_pend_pef'
    or 'add_antecip_pef_pend' = 'mod_antecip_pef_pend_pef' 
    or 'add_antecip_pef_pend' = 'add_antecip_pef_pend'
    or 'add_antecip_pef_pend' = 'mod_antecip_pef_pend_base' then do:
       &if '{&emsfin_version}' >= '5.03' &then
            find last param_geral_apb no-lock no-error.
            if avail param_geral_apb then do:
                if param_geral_apb.log_reg_corporat then do:
                    find estabelecimento no-lock
                        where estabelecimento.cod_estab = p_cod_estab no-error.
                    if  avail estabelecimento
                    then do:
                        assign v_cod_empres_usuar_8 = estabelecimento.cod_empresa.
                    end /* if */.
                end.
           end.
        &endif 
    end.               

    assign p_cod_return_liber_pagto = "OK" /*l_ok*/ 
           p_cod_return_pagto       = "OK" /*l_ok*/ .

    find last param_empres_apb no-lock
        where param_empres_apb.cod_empresa = v_cod_empres_usuar_8 no-error.

    if  avail param_empres_apb then do:
        if  p_cod_finalid_econ <> param_empres_apb.cod_finalid_econ_val_usuar then do:
            run pi_converter_indic_econ_finalid (Input p_cod_indic_econ,
                                                 Input v_cod_empres_usuar_8,
                                                 Input p_dat_transacao,
                                                 Input p_val_pagto,
                                                 Input param_empres_apb.cod_finalid_econ_val_usuar,
                                                 output v_cod_return) /*pi_converter_indic_econ_finalid*/.
            if  v_cod_return = "OK" /*l_ok*/  or v_cod_return = "" then do:
                find first tt_converter_finalid_econ no-lock no-error.
                assign p_val_pagto = tt_converter_finalid_econ.tta_val_transacao.
            end.
            else do:
                assign p_cod_return_liber_pagto = v_cod_return
                       p_cod_return_pagto       = v_cod_return.
                return.
            end.
        end.

        assign p_dat_transacao = date(month(p_dat_transacao),01,year(p_dat_transacao)).
        find movto_usuar_financ no-lock use-index mvtsrfnn_id
             where movto_usuar_financ.cod_usuario = v_cod_usuar_corren
             and   movto_usuar_financ.cod_estab = p_cod_estab
             and   movto_usuar_financ.dat_movto_usuar_ap = p_dat_transacao no-error.
        if  avail movto_usuar_financ then
            assign v_val_tot_liber = movto_usuar_financ.val_tot_liber_pagto_mes
                   v_val_tot_pagto = movto_usuar_financ.val_tot_pagto_mes + movto_usuar_financ.val_tot_pagto_pend_mes.
        else
            assign v_val_tot_liber = 0
                   v_val_tot_pagto = 0.

        if  p_ind_tip_verific = "Liber" /*l_liber*/  or
            p_ind_tip_verific = "Ambos" /*l_ambos*/  then do:

                if  p_val_pagto > p_val_lim_liber_usuar_movto then 
                    assign p_cod_return_liber_pagto = '1054'.
                else do:
                    if  p_val_pagto + v_val_tot_liber > p_val_lim_liber_usuar_mes then
                        assign p_cod_return_liber_pagto = '1055'.
                    else
                        assign p_cod_return_liber_pagto = "OK" /*l_ok*/ .
                end.

        end.


        if  p_ind_tip_verific = "Pagamento" /*l_pagamento*/ 
        or  p_ind_tip_verific  = "Ambos" /*l_ambos*/  then do:
            if  p_val_pagto > p_val_lim_pagto_usuar_movto then
                assign p_cod_return_pagto = "1056".
            else do:
                if  p_val_pagto + v_val_tot_pagto > p_val_lim_pagto_usuar_mes then
                    assign p_cod_return_pagto = "1057".
                else
                    assign p_cod_return_pagto = "OK" /*l_ok*/ .
            end.
        end.
    end.
    else
        assign p_cod_return_liber_pagto = "1053"
               p_cod_return_pagto       = "1053".

END PROCEDURE. /* pi_verificar_val_usuar */
/*****************************************************************************
** Procedure Interna.....: pi_converter_indic_econ_finalid
** Descricao.............: pi_converter_indic_econ_finalid
** Criado por............: karla
** Criado em.............: // 
** Alterado por..........: fut12201
** Alterado em...........: 30/07/2008 10:08:19
*****************************************************************************/
PROCEDURE pi_converter_indic_econ_finalid:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_indic_econ
        as character
        format "x(8)"
        no-undo.
    def Input param p_cod_unid_organ
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def Input param p_dat_transacao
        as date
        format "99/99/9999"
        no-undo.
    def Input param p_val_transacao
        as decimal
        format "->>,>>>,>>>,>>9.99"
        decimals 2
        no-undo.
    def Input param p_cod_finalid_econ
        as character
        format "x(10)"
        no-undo.
    def output param p_cod_return
        as character
        format "x(40)"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_cod_return
        as character
        format "x(40)":U
        no-undo.
    def var v_dat_cotac_indic_econ
        as date
        format "99/99/9999":U
        initial today
        label "Data Cotaá∆o"
        column-label "Data Cotaá∆o"
        no-undo.
    def var v_val_cotac_indic_econ
        as decimal
        format "->>,>>>,>>>,>>9.9999999999":U
        decimals 10
        label "Cotaá∆o"
        column-label "Cotaá∆o"
        no-undo.


    /************************** Variable Definition End *************************/



    elimina:
    for each tt_converter_finalid_econ exclusive-lock: 
        delete tt_converter_finalid_econ. 
    end /* for elimina */. 

    run pi_validar_indic_econ_valid (Input p_cod_indic_econ,
                                     Input p_dat_transacao,
                                     output p_cod_return) /*pi_validar_indic_econ_valid*/. 
    if  p_cod_return <> "OK" /*l_ok*/ 
    then do:
        return. 
    end /* if */. 



    if  p_cod_finalid_econ <> ""
    then do: 
        /* OBS: Esta alteraá∆o deve permanecer no c¢digo fonte, pois esta sendo feita sob demanda. Conforme acordo com a equipe do Test Center, 
               devido lista de impacto muito extensa. Atividade 138100 */
        find first compos_finalid no-lock
             where compos_finalid.cod_indic_econ_base = p_cod_indic_econ
               and compos_finalid.cod_finalid_econ = p_cod_finalid_econ
               and compos_finalid.dat_inic_valid <= p_dat_transacao
               and compos_finalid.dat_fim_valid > p_dat_transacao
             use-index cmpsfnld_parid_indic_econ no-error.
        if  not avail compos_finalid
        then do:
            assign p_cod_return = "782" + "," + p_cod_finalid_econ + "," + p_cod_indic_econ + "," + string(p_dat_transacao).
            return. 
        end /* if */. 

        if  compos_finalid.cod_indic_econ_base <> compos_finalid.cod_indic_econ_idx
        then do: 
            find finalid_econ no-lock 
                 where finalid_econ.cod_finalid_econ = compos_finalid.cod_finalid_econ no-error. 
            if  /* finalid_econ.ind_armaz_val = "Contabilidade" /*l_contabilidade*/ 
            or */ finalid_econ.ind_armaz_val = "N∆o" /*l_nao*/ 
            then do:
                assign p_cod_return = "1389" + "," + finalid_econ.cod_finalid_econ. 
                return. 
            end /* if */. 
            run pi_validar_finalid_unid_organ (Input compos_finalid.cod_finalid_econ,
                                               Input p_cod_unid_organ,
                                               Input p_dat_transacao,
                                               output p_cod_return) /*pi_validar_finalid_unid_organ*/. 
            if  p_cod_return <> "OK" /*l_ok*/ 
            then do:
                return. 
            end /* if */. 

            find first compos_finalid_cmcmm no-lock 
                  where compos_finalid_cmcmm.cod_finalid_econ = compos_finalid.cod_finalid_econ 
                    and compos_finalid_cmcmm.dat_inic_valid_finalid = compos_finalid.dat_inic_valid_finalid 
                    and compos_finalid_cmcmm.cod_indic_econ_base = compos_finalid.cod_indic_econ_base 
                    and compos_finalid_cmcmm.cod_indic_econ_idx = compos_finalid.cod_indic_econ_idx 
                    and compos_finalid_cmcmm.dat_inic_valid_compos = compos_finalid.dat_inic_valid 
                    and compos_finalid_cmcmm.dat_inic_valid <= p_dat_transacao 
                    and compos_finalid_cmcmm.dat_fim_valid > p_dat_transacao no-error. 

             if  avail compos_finalid_cmcmm
             then do: 
                  run pi_achar_cotac_indic_econ 

                                                (Input compos_finalid.cod_indic_econ_base,
                                                 Input compos_finalid.cod_indic_econ_idx,
                                                 Input p_dat_transacao,
                                                 Input "Real" /*l_real*/ ,
                                                 output v_dat_cotac_indic_econ,
                                                 output v_val_cotac_indic_econ,
                                                 output v_cod_return) /* pi_achar_cotac_indic_econ*/.

                  if  entry(1,v_cod_return) = "358"
                  then do: 
                      elimina:
                      for each tt_converter_finalid_econ exclusive-lock: 
                          delete tt_converter_finalid_econ. 
                      end /* for elimina */. 
                      assign p_cod_return = v_cod_return. 
                      return. 
                  end /* if */. 
                  create tt_converter_finalid_econ. 
                  assign tt_converter_finalid_econ.tta_cod_finalid_econ     = compos_finalid.cod_finalid_econ 
                         tt_converter_finalid_econ.tta_dat_cotac_indic_econ = v_dat_cotac_indic_econ 
                         tt_converter_finalid_econ.tta_val_cotac_indic_econ = v_val_cotac_indic_econ 
                         tt_converter_finalid_econ.tta_val_transacao        = p_val_transacao / v_val_cotac_indic_econ

                         .
                  run pi_retornar_indic_econ_finalid 

                                                     (Input compos_finalid.cod_finalid_econ,
                                                      Input p_dat_transacao,
                                                      output tt_converter_finalid_econ.tta_cod_indic_econ) /* pi_retornar_indic_econ_finalid*/.
             end /* if */. 
             else do: 
                  elimina:
                  for each tt_converter_finalid_econ exclusive-lock: 
                      delete tt_converter_finalid_econ. 
                  end /* for elimina */. 
                  /* alteraá∆o por demanda, deve permanecer no fonte, atividade 159924 (fo 1345764) */   
                  assign p_cod_return = "1200" + "," + 
                                        compos_finalid.cod_indic_econ_base + "," + 
                                        compos_finalid.cod_indic_econ_idx + "," + 
                                        string(p_dat_transacao)  + "," + 
                                        compos_finalid.cod_finalid_econ + "," + 
                                        string(compos_finalid.dat_inic_valid_finalid) + "," +
                                        string(compos_finalid.dat_inic_valid).                                     
                  return. 
             end /* else */. 
        end /* if */. 
        else do: 
            create tt_converter_finalid_econ. 
            assign tt_converter_finalid_econ.tta_cod_finalid_econ      = compos_finalid.cod_finalid_econ 
                   tt_converter_finalid_econ.tta_dat_cotac_indic_econ  = p_dat_transacao 
                   tt_converter_finalid_econ.tta_val_cotac_indic_econ  = 1 
                   tt_converter_finalid_econ.tta_val_transacao         = p_val_transacao 
                   tt_converter_finalid_econ.tta_cod_indic_econ        = compos_finalid.cod_indic_econ_idx. 
        end /* else */. 
    end /* if */. 
    else do: 
        composicoes: 
        for each compos_finalid no-lock 
         where compos_finalid.cod_indic_econ_base = p_cod_indic_econ 
           and compos_finalid.dat_inic_valid <= p_dat_transacao 
           and compos_finalid.dat_fim_valid > p_dat_transacao 
         use-index cmpsfnld_parid_indic_econ : 
           if  compos_finalid.cod_indic_econ_base <> compos_finalid.cod_indic_econ_idx
           then do: 
               find finalid_econ no-lock 
                    where finalid_econ.cod_finalid_econ = compos_finalid.cod_finalid_econ no-error. 
               if  finalid_econ.ind_armaz_val = "Contabilidade" /*l_contabilidade*/ 
               or  finalid_econ.ind_armaz_val = "N∆o" /*l_nao*/ 
               then do:
                   next composicoes. 
               end /* if */. 
               run pi_validar_finalid_unid_organ (Input compos_finalid.cod_finalid_econ, 
                                                  Input p_cod_unid_organ, 
                                                  Input p_dat_transacao, 
                                                  output v_cod_return) . 
               if  v_cod_return = "338"
               then do: 
                   next composicoes. 
               end /* if */. 
                find first compos_finalid_cmcmm no-lock 
                     where compos_finalid_cmcmm.cod_finalid_econ = compos_finalid.cod_finalid_econ 
                       and compos_finalid_cmcmm.dat_inic_valid_finalid = compos_finalid.dat_inic_valid_finalid 
                       and compos_finalid_cmcmm.cod_indic_econ_base = compos_finalid.cod_indic_econ_base 
                       and compos_finalid_cmcmm.cod_indic_econ_idx = compos_finalid.cod_indic_econ_idx 
                       and compos_finalid_cmcmm.dat_inic_valid_compos = compos_finalid.dat_inic_valid 
                       and compos_finalid_cmcmm.dat_inic_valid <= p_dat_transacao 
                       and compos_finalid_cmcmm.dat_fim_valid > p_dat_transacao no-error. 

                if  avail compos_finalid_cmcmm
                then do: 
                     run pi_achar_cotac_indic_econ 

                                                   (Input compos_finalid.cod_indic_econ_base, 
                                                    Input compos_finalid.cod_indic_econ_idx, 
                                                    Input p_dat_transacao, 
                                                    Input "Real" /*l_real*/ ,
                                                    output v_dat_cotac_indic_econ, 
                                                    output v_val_cotac_indic_econ, 
                                                    output v_cod_return) . 
                     if  entry(1,v_cod_return) = "358"
                     then do:
                        elimina: 
                        for 
                            each tt_converter_finalid_econ exclusive-lock: 
                            delete tt_converter_finalid_econ. 
                        end . 
                        assign p_cod_return = v_cod_return. 
                        return. 
                     end /* if */. 
                     create tt_converter_finalid_econ. 
                     assign tt_converter_finalid_econ.tta_cod_finalid_econ     = compos_finalid.cod_finalid_econ 
                            tt_converter_finalid_econ.tta_dat_cotac_indic_econ = v_dat_cotac_indic_econ 
                            tt_converter_finalid_econ.tta_val_cotac_indic_econ = v_val_cotac_indic_econ 
                            tt_converter_finalid_econ.tta_val_transacao        = p_val_transacao / v_val_cotac_indic_econ

                            .
                     run pi_retornar_indic_econ_finalid

                                                        (Input compos_finalid.cod_finalid_econ, 
                                                         Input p_dat_transacao, 
                                                         output tt_converter_finalid_econ.tta_cod_indic_econ) . 

                end /* if */. 
                else do: 
                   elimina: 
                   for 
                       each tt_converter_finalid_econ exclusive-lock: 
                       delete tt_converter_finalid_econ. 
                   end . 
                   /* alteraá∆o por demanda, deve permanecer no fonte, atividade 159924 (fo 1345764) */   
                   assign p_cod_return = "1200" + "," + 
                                         compos_finalid.cod_indic_econ_base + "," + 
                                         compos_finalid.cod_indic_econ_idx + "," + 
                                         string(p_dat_transacao) + "," +
                                         compos_finalid.cod_finalid_econ + "," + 
                                         string(compos_finalid.dat_inic_valid_finalid) + "," +
                                         string(compos_finalid.dat_inic_valid).                                     
                   return. 
                end /* else */. 
           end /* if */. 
           else do: 
                create tt_converter_finalid_econ. 
                assign tt_converter_finalid_econ.tta_cod_finalid_econ      = compos_finalid.cod_finalid_econ 
                       tt_converter_finalid_econ.tta_dat_cotac_indic_econ  = p_dat_transacao 
                       tt_converter_finalid_econ.tta_val_cotac_indic_econ  = 1 
                       tt_converter_finalid_econ.tta_val_transacao         = p_val_transacao 
                       tt_converter_finalid_econ.tta_cod_indic_econ        = compos_finalid.cod_indic_econ_idx. 
           end /* else */. 
        end . 
        find first tt_converter_finalid_econ no-lock no-error. 
        if  not avail tt_converter_finalid_econ
        then do: 
            assign p_cod_return = "1568". 
            return. 
        end /* if */. 
    end /* else */. 

    assign p_cod_return = "OK" /*l_ok*/ .
END PROCEDURE. /* pi_converter_indic_econ_finalid */
/*****************************************************************************
** Procedure Interna.....: pi_validar_indic_econ_valid
** Descricao.............: pi_validar_indic_econ_valid
** Criado por............: 
** Criado em.............: // 
** Alterado por..........: 
** Alterado em...........: 26/09/1995 10:04:56
*****************************************************************************/
PROCEDURE pi_validar_indic_econ_valid:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_indic_econ
        as character
        format "x(8)"
        no-undo.
    def Input param p_dat_transacao
        as date
        format "99/99/9999"
        no-undo.
    def output param p_cod_return
        as character
        format "x(40)"
        no-undo.


    /************************* Parameter Definition End *************************/

    find indic_econ no-lock
         where indic_econ.cod_indic_econ = p_cod_indic_econ /*cl_indic_econ_valid of indic_econ*/ no-error.
    if  not avail indic_econ
    then do:
       assign p_cod_return = "241".
       return.
    end /* if */.

    if  p_dat_transacao <  indic_econ.dat_inic_valid or
       p_dat_transacao >= indic_econ.dat_fim_valid
    then do:
       assign p_cod_return = "1199".
       return.
    end /* if */.

    assign p_cod_return = "OK" /*l_ok*/ .

END PROCEDURE. /* pi_validar_indic_econ_valid */
/*****************************************************************************
** Procedure Interna.....: pi_retornar_indic_econ_finalid
** Descricao.............: pi_retornar_indic_econ_finalid
** Criado por............: vladimir
** Criado em.............: // 
** Alterado por..........: Menna
** Alterado em...........: 06/05/1999 10:21:29
*****************************************************************************/
PROCEDURE pi_retornar_indic_econ_finalid:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_finalid_econ
        as character
        format "x(10)"
        no-undo.
    def Input param p_dat_transacao
        as date
        format "99/99/9999"
        no-undo.
    def output param p_cod_indic_econ
        as character
        format "x(8)"
        no-undo.


    /************************* Parameter Definition End *************************/

    find first histor_finalid_econ no-lock
         where histor_finalid_econ.cod_finalid_econ = p_cod_finalid_econ
           and histor_finalid_econ.dat_inic_valid_finalid <= p_dat_transacao
           and histor_finalid_econ.dat_fim_valid_finalid > p_dat_transacao
    &if "{&emsuni_version}" >= "5.01" &then
         use-index hstrfnld_id
    &endif
          /*cl_finalid_ativa of histor_finalid_econ*/ no-error.
    if  avail histor_finalid_econ then
        assign p_cod_indic_econ = histor_finalid_econ.cod_indic_econ.

END PROCEDURE. /* pi_retornar_indic_econ_finalid */
/*****************************************************************************
** Procedure Interna.....: pi_validar_finalid_unid_organ
** Descricao.............: pi_validar_finalid_unid_organ
** Criado por............: 
** Criado em.............: // 
** Alterado por..........: fut1228
** Alterado em...........: 21/01/2004 19:31:53
*****************************************************************************/
PROCEDURE pi_validar_finalid_unid_organ:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_finalid_econ
        as character
        format "x(10)"
        no-undo.
    def Input param p_cod_unid_organ
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def Input param p_dat_transacao
        as date
        format "99/99/9999"
        no-undo.
    def output param p_cod_return
        as character
        format "x(40)"
        no-undo.


    /************************* Parameter Definition End *************************/

    /* Alterado para validar "finalid_unid_organ.dat_fim_valid >= p_dat_transacao", conforme Atividade 107753.
      Devido a lista de impacto desta PI ser muito extenáa, foi acordado que os demais 
      programas deveram ser alterados sobre demanda.*/

    find first finalid_unid_organ no-lock
         where finalid_unid_organ.cod_unid_organ = p_cod_unid_organ
           and finalid_unid_organ.cod_finalid_econ = p_cod_finalid_econ
           and finalid_unid_organ.dat_inic_valid <= p_dat_transacao
           and finalid_unid_organ.dat_fim_valid >= p_dat_transacao no-error.

    if  not avail finalid_unid_organ
    then do:
        assign p_cod_return = "338".
    end /* if */.
    else do:
        assign p_cod_return = "OK" /*l_ok*/ .
    end /* else */.
END PROCEDURE. /* pi_validar_finalid_unid_organ */
/*****************************************************************************
** Procedure Interna.....: pi_verificar_cheque_antecipacao
** Descricao.............: pi_verificar_cheque_antecipacao
** Criado por............: 
** Criado em.............: // 
** Alterado por..........: fut35183_5
** Alterado em...........: 15/08/2008 11:40:49
*****************************************************************************/
PROCEDURE pi_verificar_cheque_antecipacao:

    find portador no-lock
         where portador.cod_portador = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_portador
    &if "{&emsfin_version}" >= "5.01" &then
         use-index portador_id
    &endif
          /*cl_frame of portador*/ no-error.
    find last param_estab_apb no-lock
         where param_estab_apb.cod_estab = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab
    &if "{&emsfin_version}" >= "5.01" &then
         use-index prmstbpb_id
    &endif
          /*cl_frame of param_estab_apb*/ no-error.
    find usuar_financ_estab_apb no-lock
         where usuar_financ_estab_apb.cod_usuario = v_cod_usuar_corren
           and usuar_financ_estab_apb.cod_estab = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab /*cl_frame_usuar_corren of usuar_financ_estab_apb*/ no-error.
    if  avail portador
    and (portador.ind_tip_portad <> "Caixa" /*l_caixa*/ 
    and  portador.ind_tip_portad <> "M£tuo" /*l_mutuo*/ )
    and avail param_estab_apb
    and avail usuar_financ_estab_apb
    then do:
        run pi_retornar_finalid_indic_econ (Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_indic_econ,
                                            Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.dat_emis_docto,
                                            output v_cod_finalid_econ) /*pi_retornar_finalid_indic_econ*/.
        find portad_finalid_econ no-lock
             where portad_finalid_econ.cod_estab        = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab
               and portad_finalid_econ.cod_portador     = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_portador
               and portad_finalid_econ.cod_cart_bcia    = v_cod_cart_bcia
               and portad_finalid_econ.cod_finalid_econ = v_cod_finalid_econ
             use-index prtdfnld_id
              no-error.
        if  avail portad_finalid_econ
        then do:
            if  usuar_financ_estab_apb.log_habilit_impl_tit_ap   = yes
            and usuar_financ_estab_apb.log_habilit_prepar_tit_ap = yes
            and usuar_financ_estab_apb.log_habilit_liber_tit_ap  = yes
            then do:
                run pi_verificar_val_usuar (Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab,
                                            Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.dat_emis_docto,
                                            Input "Liberaá∆o" /*l_liberacao*/,
                                            Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.val_tit_ap,
                                            Input usuar_financ_estab_apb.val_lim_liber_usuar_movto,
                                            Input usuar_financ_estab_apb.val_lim_liber_usuar_mes,
                                            Input usuar_financ_estab_apb.val_lim_pagto_usuar_movto,
                                            Input usuar_financ_estab_apb.val_lim_pagto_usuar_mes,
                                            Input v_cod_finalid_econ,
                                            Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_indic_econ,
                                            output v_cod_return_liber_pagto,
                                            output v_cod_return_pagto) /*pi_verificar_val_usuar*/.
                if  v_cod_return_liber_pagto = "OK" /*l_ok*/ 
                then do:
                    enable v_ind_modo_pagto
                           antecip_pef_pend.cod_forma_pagto
                           bt_zoo_228185
                           with frame f_adp_02_antecip_pef_pend.

                    apply "value-changed" to v_ind_modo_pagto in frame f_adp_02_antecip_pef_pend.
                end /* if */.
                else do:
                    if  v_cod_return_liber_pagto = "2895"
                    then do:
                        /* Problema na verificaá∆o dos valores do usu†rio ! */
                        run pi_messages (input "show",
                                         input 2895,
                                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_2895*/.
                    end /* if */.
                    disable v_ind_modo_pagto
                            antecip_pef_pend.num_talon_cheq
                            antecip_pef_pend.num_cheque
                            antecip_pef_pend.ind_favorec_cheq
                            antecip_pef_pend.nom_favorec_cheq
                            bt_zoo_178527
                            antecip_pef_pend.cod_forma_pagto
                            bt_zoo_228185
                            with frame f_adp_02_antecip_pef_pend.
                    assign antecip_pef_pend.nom_favorec_cheq:screen-value in frame f_adp_02_antecip_pef_pend = ""
                           antecip_pef_pend.num_cheque:screen-value       in frame f_adp_02_antecip_pef_pend = ""
                           antecip_pef_pend.num_talon_cheq:screen-value   in frame f_adp_02_antecip_pef_pend = "".
                end /* else */.
            end /* if */.
            else do:
                if  input frame f_adp_02_antecip_pef_pend antecip_pef_pend.val_tit_ap < param_estab_apb.val_min_liber
                and usuar_financ_estab_apb.log_habilit_liber_tit_ap  = yes
                and usuar_financ_estab_apb.log_habilit_impl_tit_ap   = yes
                and usuar_financ_estab_apb.log_habilit_pagto_tit_ap  = yes
                then do:
                    run pi_verificar_val_usuar (Input antecip_pef_pend.cod_estab:screen-value in frame f_adp_02_antecip_pef_pend,
                                                Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.dat_emis_docto,
                                                Input "Pagamento" /*l_pagamento*/,
                                                Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.val_tit_ap,
                                                Input usuar_financ_estab_apb.val_lim_liber_usuar_movto,
                                                Input usuar_financ_estab_apb.val_lim_liber_usuar_mes,
                                                Input usuar_financ_estab_apb.val_lim_pagto_usuar_movto,
                                                Input usuar_financ_estab_apb.val_lim_pagto_usuar_mes,
                                                Input v_cod_finalid_econ,
                                                Input antecip_pef_pend.cod_indic_econ:screen-value in frame f_adp_02_antecip_pef_pend,
                                                output v_cod_return_liber_pagto,
                                                output v_cod_return_pagto) /*pi_verificar_val_usuar*/.
                    if  v_cod_return_pagto = "OK" /*l_ok*/ 
                    then do:
                        enable v_ind_modo_pagto
                               antecip_pef_pend.cod_forma_pagto
                               bt_zoo_228185
                               with frame f_adp_02_antecip_pef_pend.

                        apply "value-changed" to v_ind_modo_pagto in frame f_adp_02_antecip_pef_pend.
                    end /* if */.
                    else do:
                        disable v_ind_modo_pagto
                                antecip_pef_pend.num_talon_cheq
                                antecip_pef_pend.num_cheque
                                antecip_pef_pend.ind_favorec_cheq
                                antecip_pef_pend.nom_favorec_cheq
                                bt_zoo_178527
                                antecip_pef_pend.cod_forma_pagto
                                bt_zoo_228185
                                with frame f_adp_02_antecip_pef_pend.
                        assign antecip_pef_pend.nom_favorec_cheq:screen-value in frame f_adp_02_antecip_pef_pend = ""
                               antecip_pef_pend.num_cheque:screen-value       in frame f_adp_02_antecip_pef_pend = ""
                               antecip_pef_pend.num_talon_cheq:screen-value   in frame f_adp_02_antecip_pef_pend = "".
                    end /* else */.
                end /* if */.
                else do:
                    disable v_ind_modo_pagto
                            antecip_pef_pend.num_talon_cheq
                            antecip_pef_pend.num_cheque
                            antecip_pef_pend.ind_favorec_cheq
                            antecip_pef_pend.nom_favorec_cheq
                            bt_zoo_178527
                            antecip_pef_pend.cod_forma_pagto
                            bt_zoo_228185
                            with frame f_adp_02_antecip_pef_pend.
                    assign antecip_pef_pend.nom_favorec_cheq:screen-value in frame f_adp_02_antecip_pef_pend = ""
                           antecip_pef_pend.num_cheque:screen-value       in frame f_adp_02_antecip_pef_pend = ""
                           antecip_pef_pend.num_talon_cheq:screen-value   in frame f_adp_02_antecip_pef_pend = ""                                      
                           v_ind_modo_pagto:screen-value                  in frame f_adp_02_antecip_pef_pend = ""
                           antecip_pef_pend.cod_forma_pagto:screen-value  in frame f_adp_02_antecip_pef_pend = ""
                           antecip_pef_pend.ind_favorec_cheq:screen-value in frame f_adp_02_antecip_pef_pend = "".                       
                end /* else */.
            end /* else */.
        end /* if */.
        else do:
            disable v_ind_modo_pagto
                    antecip_pef_pend.num_talon_cheq
                    antecip_pef_pend.num_cheque
                    antecip_pef_pend.ind_favorec_cheq
                    antecip_pef_pend.nom_favorec_cheq
                    bt_zoo_178527
                    antecip_pef_pend.cod_forma_pagto
                    bt_zoo_228185
                    with frame f_adp_02_antecip_pef_pend.

            assign antecip_pef_pend.nom_favorec_cheq:screen-value in frame f_adp_02_antecip_pef_pend = ""
                   antecip_pef_pend.num_cheque:screen-value       in frame f_adp_02_antecip_pef_pend = ""
                   antecip_pef_pend.num_talon_cheq:screen-value   in frame f_adp_02_antecip_pef_pend = "".
        end /* else */.
    end /* if */.
    else do:
        disable v_ind_modo_pagto
                antecip_pef_pend.num_talon_cheq
                antecip_pef_pend.num_cheque
                antecip_pef_pend.ind_favorec_cheq
                antecip_pef_pend.nom_favorec_cheq
                bt_zoo_178527
                antecip_pef_pend.cod_forma_pagto
                bt_zoo_228185
                with frame f_adp_02_antecip_pef_pend.

        assign antecip_pef_pend.nom_favorec_cheq:screen-value in frame f_adp_02_antecip_pef_pend = ""
               antecip_pef_pend.num_cheque:screen-value       in frame f_adp_02_antecip_pef_pend = ""
               antecip_pef_pend.num_talon_cheq:screen-value   in frame f_adp_02_antecip_pef_pend = "".
    end /* else */.
END PROCEDURE. /* pi_verificar_cheque_antecipacao */
/*****************************************************************************
** Procedure Interna.....: pi_verifica_impto_vincul_fornec
** Descricao.............: pi_verifica_impto_vincul_fornec
** Criado por............: rafael
** Criado em.............: // 
** Alterado por..........: brf12302
** Alterado em...........: 08/10/2003 15:29:10
*****************************************************************************/
PROCEDURE pi_verifica_impto_vincul_fornec:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_estab
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def Input param p_cdn_fornecedor
        as Integer
        format ">>>,>>>,>>9"
        no-undo.
    def Input param p_dat_transacao
        as date
        format "99/99/9999"
        no-undo.
    def output param p_log_impto_vincul_fornec
        as logical
        format "Sim/N∆o"
        no-undo.


    /************************* Parameter Definition End *************************/

    assign v_cod_empres_usuar_2 = v_cod_empres_usuar.

    if 'add_antecip_pef_pend' = 'add_antecip_pef_pend'
    or 'add_antecip_pef_pend' = 'add_antecip_pef_pend_pef'
    or 'add_antecip_pef_pend' = 'add_item_lote_impl_ap'
    or 'add_antecip_pef_pend' = 'add_item_lote_impl_ap_previsao'
    or 'add_antecip_pef_pend' = 'add_lote_impl_tit_ap_fatura'
    or 'add_antecip_pef_pend' = 'mod_antecip_pef_pend_base'
    or 'add_antecip_pef_pend' = 'mod_antecip_pef_pend_pef'
    or 'add_antecip_pef_pend' = 'mod_item_lote_impl_ap_base'
    or 'add_antecip_pef_pend' = 'mod_item_lote_impl_ap_duplicata'
    or 'add_antecip_pef_pend' = 'mod_item_lote_impl_ap_previsao_base'
    or 'add_antecip_pef_pend' = 'mod_item_lote_impl_ap_base' then do:
        &if '{&emsfin_version}' >= '5.03' &then
            find last param_geral_apb no-lock no-error.
            if avail param_geral_apb then do:
                if param_geral_apb.log_reg_corporat then do:
                    find estabelecimento no-lock
                        where estabelecimento.cod_estab = p_cod_estab no-error.
                    if avail estabelecimento then do:
                        assign v_cod_empres_usuar_2 = estabelecimento.cod_empresa.
                    end.
                end.
            end.
        &endif
    end.

    assign p_log_impto_vincul_fornec = no.

    find first impto_vincul_fornec no-lock
        where impto_vincul_fornec.cod_empresa    = v_cod_empres_usuar_2
        and   impto_vincul_fornec.cdn_fornecedor = p_cdn_fornecedor no-error.
    if  avail impto_vincul_fornec then
        assign p_log_impto_vincul_fornec = yes.
END PROCEDURE. /* pi_verifica_impto_vincul_fornec */
/*****************************************************************************
** Procedure Interna.....: pi_atualiza_antecipacao_apb
** Descricao.............: pi_atualiza_antecipacao_apb
** Criado por............: rafael
** Criado em.............: // 
** Alterado por..........: 002565
** Alterado em...........: 01/08/2019 15:34:37
*****************************************************************************/
PROCEDURE pi_atualiza_antecipacao_apb:

    /************************** Buffer Definition Begin *************************/

    &if "{&emsfin_version}" >= "5.01" &then
    def buffer b_item_cheq_ap
        for item_cheq_ap.
    &endif


    /*************************** Buffer Definition End **************************/

    /************************* Variable Definition Begin ************************/

    def var v_cod_estab_cheq
        as character
        format "x(3)":U
        no-undo.
    def var v_cod_usuar_corren
        as character
        format "x(12)":U
        label "Usu†rio Corrente"
        column-label "Usu†rio Corrente"
        no-undo.
    def var v_nom_favorec_cheq
        as character
        format "x(40)":U
        label "Favorecido"
        column-label "Nome Favorecido"
        no-undo.
    def var v_num_id_cheq_ap
        as integer
        format "9999999999":U
        label "Token cheq_ap"
        column-label "Token cheq_ap"
        no-undo.
    def var v_ind_tip_trans                  as character       no-undo. /*local*/
    def var v_log_abat_antecip               as logical         no-undo. /*local*/
    def var v_log_impto_vincul_refer         as logical         no-undo. /*local*/
    def var v_log_verifica_apf               as logical         no-undo. /*local*/
    def var v_val_liq_antecip                as decimal         no-undo. /*local*/
    def var v_val_tot_abat_antecip           as decimal         no-undo. /*local*/
    def var v_val_tot_impto                  as decimal         no-undo. /*local*/


    /************************** Variable Definition End *************************/

    /* ************
       Essa PI Ç utilizada pelo programa de Integraá∆o Faturamento x APB,
       na  funá∆o   de Devoluá∆o  de  Mercadorias. Por isso n∆o deve ser 
       utilizada mensagens em tela diretamente.
       ************ */

    assign v_cod_empres_usuar_2 = v_cod_empres_usuar.

    &IF DEFINED(BF_FIN_CONSIST_APF) &THEN
        assign v_log_erro_apf = yes.
    &ENDIF

    &if '{&emsfin_version}' >= '5.03' &then
        find last param_geral_apb no-lock no-error.
        if  avail param_geral_apb and param_geral_apb.log_reg_corporat
        then do:
            find estabelecimento no-lock
                where estabelecimento.cod_estab = antecip_pef_pend.cod_estab no-error.
            if  avail estabelecimento then
                assign v_cod_empres_usuar_2 = estabelecimento.cod_empresa.
        end /* if */.
    &endif

    /* ** Elimina registros de erros anteriores. ***/
    for each tt_log_erros_tit_antecip exclusive-lock:
        delete tt_log_erros_tit_antecip.
    end.

    atualiz_block:
    do on error undo atualiz_block, return error:
        /* Verifica Impostos e Abatimentos */
        assign v_val_tot_impto        = 0
               v_val_tot_abat_antecip = 0.

        if  search("prgfin/apb/apb794za.r") = ? and search("prgfin/apb/apb794za.py") = ? then do:
            if  v_cod_dwb_user begins 'es_' then
                return "Programa execut†vel n∆o foi encontrado:" /*l_programa_nao_encontrado*/  + "prgfin/apb/apb794za.py".
            else do:
                message getStrTrans("Programa execut†vel n∆o foi encontrado:", "APB") /*l_programa_nao_encontrado*/  "prgfin/apb/apb794za.py"
                       view-as alert-box error buttons ok.
                return.
            end.
        end.
        else
            run prgfin/apb/apb794za.py (Input antecip_pef_pend.cod_estab,
                                    Input antecip_pef_pend.cod_refer,
                                    Input "",
                                    Input 0,
                                    Input 0,
                                    Input yes,
                                    Input antecip_pef_pend.dat_emis_docto,
                                    Input "Retido" /*l_retido*/,
                                    output v_log_impto_vincul_refer,
                                    output v_val_tot_impto,
                                    Input recid(bord_ap),
                                    Input recid(cheq_ap),
                                    Input recid(item_lote_pagto)) /*prg_fnc_verificar_impto_vincul_refer*/.

        /* fut38629 - Repasse alteraá‰es FDES Argentina */
        if v_log_localiz_arg then
            assign v_val_liq_antecip = antecip_pef_pend.val_tit_ap.
        else

            assign v_val_liq_antecip = antecip_pef_pend.val_tit_ap - v_val_tot_impto.

        run pi_validar_habilit_usuar_transac (Input antecip_pef_pend.cod_estab,
                                              Input antecip_pef_pend.cod_finalid_econ,
                                              Input antecip_pef_pend.cod_indic_econ,
                                              Input antecip_pef_pend.dat_emis_docto,
                                              Input antecip_pef_pend.val_tit_ap,
                                              output v_ind_tip_trans) /*pi_validar_habilit_usuar_transac*/.


        /* Begin_Include: i_especifico_antecip_pef_pend */
        /* Se na antecipaá∆o n∆o for informado portador a £nica permiss∆o que o usu†rio
        dever† ter Ç de implantar no estabelecimento da AN e se tiver a AN dever† ser
        gerada automaticamente.*/

        /* Chamada UPC Banrisul*/
        &if '{&frame_aux}' = "" &then
            create tt_epc.
            assign tt_epc.cod_event     = "Evento Cont†bil" /*l_event_ctbl*/ 
                       tt_epc.cod_parameter = "Validaá∆o" /*l_validacao*/ 
                       tt_epc.val_parameter = string(recid(antecip_pef_pend)).


            /* Begin_Include: i_exec_program_epc_custom */
            if  v_nom_prog_upc <> '' then
            do:
                run value(v_nom_prog_upc) (input "Evento Cont†bil" /* l_event_ctbl*/,
                                           input-output table tt_epc).
            end.

            if  v_nom_prog_appc <> '' then
            do:
                run value(v_nom_prog_appc) (input "Evento Cont†bil" /* l_event_ctbl*/,
                                            input-output table tt_epc).
            end.

            &if '{&emsbas_version}' > '5.00' &then
            if  v_nom_prog_dpc <> '' then
            do:
                run value(v_nom_prog_dpc) (input "Evento Cont†bil" /* l_event_ctbl*/,
                                            input-output table tt_epc).
            end.
            &endif
            /* End_Include: i_exec_program_epc_custom */


            for each tt_epc:
                delete tt_epc.
            end.
        &else
            &if '{&emsbas_version}' > '1.00' &then
                if  v_nom_prog_upc <> '' then
                do:
                    if recid(antecip_pef_pend) <> ? then
                        assign v_rec_table_epc = recid(antecip_pef_pend).
                    run value(v_nom_prog_upc) (input "Evento Cont†bil" /*l_event_ctbl*/ ,
                                               input "viewer" /*l_viewer*/ ,
                                               input this-procedure,
                                               input v_wgh_frame_epc,
                                               input v_nom_table_epc,
                                               input v_rec_table_epc).
                    if  "no" /*l_no*/  = "yes" /*l_yes*/ 
                    and return-value = "NOK" /*l_nok*/  then
                        undo, retry.

                   if can-find(first tt_log_erros_atualiz) then do:
                       undo atualiz_block, return error.
                   end.
                end.

                if  v_nom_prog_appc <> '' then
                do:
                    if recid(antecip_pef_pend) <> ? then
                        assign v_rec_table_epc = recid(antecip_pef_pend).
                    run value(v_nom_prog_appc) (input "Evento Cont†bil" /*l_event_ctbl*/ ,
                                                input "viewer" /*l_viewer*/ ,
                                                input this-procedure,
                                                input v_wgh_frame_epc,
                                                input v_nom_table_epc,
                                                input v_rec_table_epc).
                    if  "no" /*l_no*/  = "yes" /*l_yes*/ 
                    and return-value = "NOK" /*l_nok*/  then
                        undo, retry.

                   if can-find(first tt_log_erros_atualiz) then do:
                       undo atualiz_block, return error.
                   end.
                end.

                &if '{&emsbas_version}' > '5.00' &then
                if  v_nom_prog_dpc <> '' then
                do:
                    if recid(antecip_pef_pend) <> ? then
                        assign v_rec_table_epc = recid(antecip_pef_pend).
                    run value(v_nom_prog_dpc) (input "Evento Cont†bil" /*l_event_ctbl*/ ,
                                                input "viewer" /*l_viewer*/ ,
                                                input this-procedure,
                                                input v_wgh_frame_epc,
                                                input v_nom_table_epc,
                                                input v_rec_table_epc).
                    if  "no" /*l_no*/  = "yes" /*l_yes*/ 
                    and return-value = "NOK" /*l_nok*/  then
                        undo, retry.

                   if can-find(first tt_log_erros_atualiz) then do:
                       undo atualiz_block, return error.
                   end.
                end.
                &endif
                &endif
                /* End_Include: i_exec_program_epc */

        &endif

        /* Chamada EPC - Kepler */
        &if '{&frame_aux}' = "" &then
        /* Ponto EPC EstratÇgico */

            create tt_epc.
            assign tt_epc.cod_event     = 'Antecipaá∆o Pendente' /* l_antecipacao_pendente*/
                   tt_epc.cod_parameter = 'Tipo Transaá∆o' /* l_tipo_transacao*/
                   tt_epc.val_parameter = v_ind_tip_trans.

            run pi_i_exec_program_epc_custom (Input "Antecipaá∆o Pendente" /*l_antecipacao_pendente*/) /*pi_i_exec_program_epc_custom*/.

            find first tt_epc
                 where tt_epc.cod_event     = 'Antecipaá∆o Pendente' /* l_antecipacao_pendente*/
                 and   tt_epc.cod_parameter = 'Retorno' /* l_retorno*/ no-error.
            if  avail tt_epc then
                assign v_ind_tip_trans = tt_epc.val_parameter.

            for each tt_epc:
                delete tt_epc.
            end.
        &else
            /* Ponto EPC Tela */

            /* Begin_Include: i_exec_program_epc */
            &if '{&emsbas_version}' > '1.00' &then
            if  v_nom_prog_upc <> '' then
            do:
                assign v_rec_table_epc = recid(antecip_pef_pend).
                run value(v_nom_prog_upc) (input 'Antecipaá∆o Pendente' /* l_antecipacao_pendente*/,
                                           input 'viewer',
                                           input this-procedure,
                                           input v_wgh_frame_epc,
                                           input v_nom_table_epc,
                                           input v_rec_table_epc).
                if  'no' = 'yes'
                and return-value = 'NOK' then
                    undo, retry.
            end.

            if  v_nom_prog_appc <> '' then
            do:
                assign v_rec_table_epc = recid(antecip_pef_pend).
                run value(v_nom_prog_appc) (input 'Antecipaá∆o Pendente' /* l_antecipacao_pendente*/,
                                            input 'viewer',
                                            input this-procedure,
                                            input v_wgh_frame_epc,
                                            input v_nom_table_epc,
                                            input v_rec_table_epc).
                if  'no' = 'yes'
                and return-value = 'NOK' then
                    undo, retry.
            end.

            &if '{&emsbas_version}' > '5.00' &then
            if  v_nom_prog_dpc <> '' then
            do:
                assign v_rec_table_epc = recid(antecip_pef_pend).
                run value(v_nom_prog_dpc) (input 'Antecipaá∆o Pendente' /* l_antecipacao_pendente*/,
                                           input 'viewer',
                                           input this-procedure,
                                           input v_wgh_frame_epc,
                                           input v_nom_table_epc,
                                           input v_rec_table_epc).
                if  'no' = 'yes'
                and return-value = 'NOK' then
                    undo, retry.
            end.
            &endif
            &endif
            /* End_Include: i_exec_program_epc */

            if  return-value = 'Implantar' /* l_implantar*/ then
                assign v_ind_tip_trans = 'Implantar' /* l_implantar*/.

        &endif
        /* End_Include: i_exec_program_epc_custom */



        &IF DEFINED(BF_FIN_CONSIST_APF) &THEN
            if v_log_portad_cx then		
    	    assign v_ind_tip_trans = "Pagar" /*l_pagar*/ .
        &ENDIF


        if  v_ind_tip_trans = "Implantar" /*l_implantar*/  and antecip_pef_pend.cod_portador <> ""
        then do:
            assign antecip_pef_pend.ind_sit_pef_antecip = "Pend" /*l_pendente*/ .

            /* Begin_Include: i_valida_cotacao_antecip_pef_pend */
            &if '{&frame_aux}' <> "" &then
            run pi_retornar_indic_econ_corren_estab (input antecip_pef_pend.cod_estab,
                                                     Input antecip_pef_pend.dat_emis_docto,
                                                     output v_cod_indic_econ) /* pi_retornar_indic_econ_corren_estab*/.
            run pi_achar_cotac_indic_econ 

                                          (input antecip_pef_pend.cod_indic_econ,
                                           Input v_cod_indic_econ,
                                           input antecip_pef_pend.dat_emis_docto,
                                           Input "Real" /*l_real*/ ,
                                           output v_dat_cotac_indic_econ,
                                           output v_val_cotac_indic_econ,
                                           output v_cod_return) /* pi_achar_cotac_indic_econ*/.
            if  v_cod_return <> "OK" /*l_ok*/ 
            and antecip_pef_pend.val_cotac_indic_econ = 0 then do:

                run pi_i_return_msg_erro_conver (input-output v_cod_return) /* pi_i_return_msg_erro_conver*/.
                if  return-value <> "OK" /*l_ok*/  then
                    return error.
            end /* if */.
            &endif
            /* End_Include: i_valida_cotacao_antecip_pef_pend */

        end /* if */.
        else do:
            assign antecip_pef_pend.ind_sit_pef_antecip = "Em Pagamento" /*l_em_pagamento*/ .

            if  v_ind_tip_trans = "Pagar" /*l_pagar*/ 
            or (v_ind_tip_trans = "Implantar" /*l_implantar*/ and antecip_pef_pend.cod_portador = "")
            or (v_ind_tip_trans = "Liberar" /*l_liberar*/   and antecip_pef_pend.cod_portador = "")
            or (v_ind_tip_trans = "Preparar" /*l_preparar*/  and antecip_pef_pend.cod_portador = "")
            then do:
                /* #ifdef(alteracao_antecip_apf)  
                @if (v_log_verifica_apf = no) 
    #endif(alteracao_antecip_apf)
                */                
                    if  v_ind_modo_pagto = "Dinheiro" /*l_dinheiro*/  or antecip_pef_pend.cod_portador = ""
                    then do:

                        run pi_gerar_process_pagto_antecip_pef (Input v_val_liq_antecip,
                                                                Input "Pagar" /*l_pagar*/) /*pi_gerar_process_pagto_antecip_pef*/.

                        /* *** Esta vari†vel ir† definir a existància de algum erro encontrado dentro
                               da pi_criticar_geracao_antecip_pef que impessa a geraá∆o da antecipaá∆o. *** */
                        assign v_log_erro_valid = yes.

                        /* *** Esta vari†vel Ç controlada dentro da pi_criticar_geracao_antecip_pef
                                          como data da confirmaá∆o da antecipaá∆o. **** */
                         assign v_dat_confir_bxa_tit_ap = antecip_pef_pend.dat_emis_docto.

                        /* *** Verifica habilitaá∆o de movimentaá∆o
                           da empresa do usu†rio na data da confirmaá∆o. *** */

                        run pi_retornar_sit_movimen_modul

                                                          (Input "APB" /*l_apb*/ ,
                                                           Input v_cod_empres_usuar_2,
                                                           Input v_dat_confir_bxa_tit_ap,
                                                           Input ?,
                                                           output v_des_sit_movimen_ent) /* pi_retornar_sit_movimen_modul*/.

                        if  v_des_sit_movimen_ent <> "Habilitado" /*l_habilitado*/ 
                        then do:
                            assign v_des_msg_erro_1 = substitute(getStrTrans("M¢dulo &1 n∆o habilitado para movimentaá∆o em &2 !", "APB") /*4153*/, getStrTrans("APB", "APB") /*l_apb*/ , string(v_dat_confir_bxa_tit_ap)).
                            create tt_log_erros_tit_antecip.
                            assign tt_log_erros_tit_antecip.ttv_des_msg_erro_1  = v_des_msg_erro_1
                                   tt_log_erros_tit_antecip.tta_cod_estab_refer = " "
                                   tt_log_erros_tit_antecip.ttv_log_atlzdo      = yes.
                            assign v_log_erro_valid = no.
                        end /* if */.

                        run pi_criticar_geracao_antecip_pef (Input antecip_pef_pend.cod_estab,
                                                             Input antecip_pef_pend.cod_refer,
                                                             Input antecip_pef_pend.cod_refer,
                                                             Input antecip_pef_pend.cod_portador,
                                                             Input 0,
                                                             Input 0,
                                                             Input "Dinheiro" /*l_dinheiro*/,
                                                             Input antecip_pef_pend.cod_estab) /*pi_criticar_geracao_antecip_pef*/.

                        if  v_log_erro_valid
                        then do:
                            /* foi acrescentado um zero como parametro */
                            run prgfin/apb/apb795za.py (Input v_val_liq_antecip,
                                                        Input antecip_pef_pend.cod_estab,
                                                        Input antecip_pef_pend.dat_emis_docto,
                                                        Input 0,
                                                        Input 0,
                                                        Input 0,
                                                        Input 0,
                                                        Input ?,
                                                        Input ?,
                                                        Input v_val_tot_impto,
                                                        Input "",
                                                        Input "",
                                                        Input 0,
                                                        Input "" /* PAR∂METROS BANCO - VERS«O 5.02 */,
                                                        Input "",
                                                        Input "",
                                                        Input "",
                                                        Input "",
                                                        Input 'add_antecip_pef_pend',
                                                        Input recid(antecip_pef_pend),
                                                        Input recid(proces_pagto),
                                                        Input recid(bord_ap),
                                                        Input recid(cheq_ap),
                                                        Input recid(item_lote_pagto),
                                                        Input if v_log_localiz_equador then GetEntryField(8,antecip_pef_pend.cod_livre_1,CHR(10)) else "") /*prg_fnc_gerar_antecip_pef_apb*/.
                            &if '{&frame_aux}' = "" &then
                                find antecip_pef_pend exclusive-lock 
                                     where antecip_pef_pend.cod_estab = tt_integr_apb_antecip_pef_p1.tta_cod_estab 
                                     and   antecip_pef_pend.cod_refer = tt_integr_apb_antecip_pef_p1.tta_cod_refer no-error.
                            &endif

                            /* Chamada UPC Banrisul*/
                            &if '{&frame_aux}' <> "" &then 
                                /* Begin_Include: i_exec_program_epc */
                                &if '{&emsbas_version}' > '1.00' &then
                                    if  v_nom_prog_upc <> '' then
                                    do:
                                        assign v_rec_table_epc = recid(antecip_pef_pend).
                                        run value(v_nom_prog_upc) ("Atualiza BGC" /*l_atualiza_bgc*/ ,
                                                                   input "viewer" /*l_viewer*/ ,
                                                                   input this-procedure,
                                                                   input v_wgh_frame_epc,
                                                                   input v_nom_table_epc,
                                                                   input v_rec_table_epc).
                                        if  "yes" /*l_yes*/  = "yes" /*l_yes*/ 
                                            and return-value = "NOK" /*l_nok*/  then
                                            undo atualiz_block, return error.
                                    end.

                                    if  v_nom_prog_appc <> '' then
                                    do:
                                        assign v_rec_table_epc = recid(antecip_pef_pend).
                                        run value(v_nom_prog_appc) (input "Atualiza BGC" /*l_atualiza_bgc*/ ,
                                                                    input "viewer" /*l_viewer*/ ,
                                                                    input this-procedure,
                                                                    input v_wgh_frame_epc,
                                                                    input v_nom_table_epc,
                                                                    input v_rec_table_epc).
                                        if  "yes" /*l_yes*/  = "yes" /*l_yes*/ 
                                            and return-value = "NOK" /*l_nok*/  then
                                            undo atualiz_block, return error.
                                    end.

                                    &if '{&emsbas_version}' > '5.00' &then
                                        if  v_nom_prog_dpc <> '' then    
                                        do:
                                            assign v_rec_table_epc = recid(antecip_pef_pend).
                                            run value(v_nom_prog_dpc) (input "Atualiza BGC" /*l_atualiza_bgc*/ ,
                                                                       input "viewer" /*l_viewer*/ ,
                                                                       input this-procedure,
                                                                       input v_wgh_frame_epc,
                                                                       input v_nom_table_epc,
                                                                       input v_rec_table_epc).
                                            if  "yes" /*l_yes*/  = "yes" /*l_yes*/ 
                                                and return-value = "NOK" /*l_nok*/  then
                                                undo atualiz_block, return error.
                                        end.
                                    &endif
                                &endif /* End_Include: i_exec_program_epc */
                            &endif

                            /* ** BLOQUEIO INCONSIST“NCIAS DO T÷TULO ACR
                             *** CASO EXISTA ALGUM ERRO N«O IRµ PROCEGUIR COM A MOVIMENTAÄ«O
                             *** (NASS/BARTH)                      ****/
                            run pi_atualiz_confirmacao_bloqueio_apb (Input antecip_pef_pend.cod_estab,
                                                                     Input antecip_pef_pend.cod_espec_docto,
                                                                     Input antecip_pef_pend.cod_ser_docto,
                                                                     Input antecip_pef_pend.cod_tit_ap,
                                                                     Input antecip_pef_pend.cod_parcela,
                                                                     Input antecip_pef_pend.cdn_fornecedor,
                                                                     Input antecip_pef_pend.cod_refer,
                                                                     Input antecip_pef_pend.cod_estab,
                                                                     Input 0,
                                                                     Input 2,
                                                                     input "" /*l_*/) /*pi_atualiz_confirmacao_bloqueio_apb*/.
                            IF  RETURN-VALUE = "NOK" /*l_NOK*/  THEN do:
                                if  v_ind_modo_impl = "Batch" /*l_batch*/ 
                                then do:
                                   if  can-find(first tt_log_erros_tit_antecip) then do:
                                       for each tt_log_erros_tit_antecip :
                                           create tt_log_erros_atualiz.
                                           assign tt_log_erros_atualiz.tta_cod_estab       = antecip_pef_pend.cod_estab
                                                  tt_log_erros_atualiz.tta_cod_refer       = antecip_pef_pend.cod_refer
                                                  tt_log_erros_atualiz.tta_num_seq_refer   = 0
                                                  tt_log_erros_atualiz.ttv_ind_tip_relacto = ""
                                                  tt_log_erros_atualiz.ttv_num_relacto     = 0
                                                  tt_log_erros_atualiz.ttv_num_mensagem    = 9001
                                                  tt_log_erros_atualiz.ttv_des_msg_erro    = tt_log_erros_tit_antecip.ttv_des_msg_erro_1 
                                                  tt_log_erros_atualiz.ttv_des_msg_ajuda   = tt_log_erros_tit_antecip.ttv_des_msg_erro_1 .
                                       end.
                                       undo atualiz_block, return error.
                                   end.
                                end /* if */.
                                run prgfin/apb/apb715za.py (Input "Antecipaá∆o/PEF" /*l_antecipacaopef*/) /*prg_fnc_log_erros_tit_antecip_cheq*/.
                                undo atualiz_block, return error.
                            end.
                            /* ** N«O INCLUA NENHUMA L‡GICA DEPOIS DA VALIDAÄ«O DA INCONSIST“NCIA ***/
                            if ((v_log_param_apb_apf and v_log_aprov_impl_apf) or v_log_param_apb_apf = no)
                            and not v_log_portad_cx then do:
                                delete proces_pagto.
                                if avail antecip_pef_pend then do:
                                    &if '{&emsfin_dbtype}' <> 'progress' &then
                                    find current antecip_pef_pend exclusive-lock no-error.
                                    &endif
                                    delete antecip_pef_pend.
                                end.
                            end.

                            assign v_rec_antecip_pef_pend = ?.
                        end /* if */.
                        else do:
                            if  v_ind_modo_impl = "Batch" /*l_batch*/ 
                            then do:
                               find first tt_log_erros_tit_antecip no-lock no-error.
                               if  avail tt_log_erros_tit_antecip
                               then do:
                                   create tt_log_erros_atualiz.
                                   assign tt_log_erros_atualiz.tta_cod_estab       = antecip_pef_pend.cod_estab
                                          tt_log_erros_atualiz.tta_cod_refer       = antecip_pef_pend.cod_refer
                                          tt_log_erros_atualiz.tta_num_seq_refer   = 0
                                          tt_log_erros_atualiz.ttv_ind_tip_relacto = ""
                                          tt_log_erros_atualiz.ttv_num_relacto     = 0
                                          tt_log_erros_atualiz.ttv_num_mensagem    = 9001
                                          tt_log_erros_atualiz.ttv_des_msg_erro    = tt_log_erros_tit_antecip.ttv_des_msg_erro_1
                                          tt_log_erros_atualiz.ttv_des_msg_ajuda   = tt_log_erros_tit_antecip.ttv_des_msg_erro_1.
                                   undo atualiz_block, return error.
                               end /* if */.
                            end /* if */.
                            run prgfin/apb/apb715za.py (Input "Antecipaá∆o/PEF" /*l_antecipacaopef*/) /*prg_fnc_log_erros_tit_antecip_cheq*/.
                            if can-find (first tt_log_erros_tit_antecip
                                where not tt_log_erros_tit_antecip.ttv_des_msg_erro_1 begins "13114") then
                                    return error.
                        end /* else */.
                    end /* if */.
                    /* #ifdef(alteracao_antecip_apf)
                @end_if().
    #endif(alteracao_antecip_apf)
                    */
                else do:
                    if  v_ind_modo_pagto = "Cheque" /*l_cheque*/ 
                    then do:
                        run pi_gerar_process_pagto_antecip_pef (Input v_val_liq_antecip,
                                                                Input "Pagar" /*l_pagar*/) /*pi_gerar_process_pagto_antecip_pef*/.

                        assign proces_pagto.ind_sit_proces_pagto = "Em Pagamento" /*l_em_pagamento*/ .

                        run pi_gerar_cheque_apb (Input antecip_pef_pend.cod_portador,
                                                 Input v_cod_cart_bcia,
                                                 Input antecip_pef_pend.cod_estab,
                                                 Input antecip_pef_pend.cod_indic_econ,
                                                 Input antecip_pef_pend.dat_vencto_tit_ap,
                                                 Input antecip_pef_pend.nom_favorec_cheq,
                                                 Input antecip_pef_pend.ind_favorec_cheq,
                                                 Input antecip_pef_pend.num_talon_cheq,
                                                 Input antecip_pef_pend.num_cheque,
                                                 Input v_val_liq_antecip,
                                                 Input ?,
                                                 Input antecip_pef_pend.des_text_histor,
                                                 output v_cod_estab_cheq,
                                                 output v_num_id_cheq_ap) /*pi_gerar_cheque_apb*/.

                        find cheq_ap no-lock
                            where cheq_ap.cod_estab_cheq = v_cod_estab_cheq
                            and   cheq_ap.num_id_cheq_ap = v_num_id_cheq_ap no-error.

                        create item_cheq_ap.
                        assign item_cheq_ap.cod_empresa           = cheq_ap.cod_empresa
                               item_cheq_ap.cod_estab_cheq        = v_cod_estab_cheq
                               item_cheq_ap.cod_estab_refer       = antecip_pef_pend.cod_estab
                               item_cheq_ap.cod_refer_antecip_pef = antecip_pef_pend.cod_refer
                               item_cheq_ap.num_id_cheq_ap        = cheq_ap.num_id_cheq_ap
                               item_cheq_ap.cod_estab             = antecip_pef_pend.cod_estab
                               item_cheq_ap.cod_espec_docto       = antecip_pef_pend.cod_espec_docto
                               item_cheq_ap.cod_ser_docto         = antecip_pef_pend.cod_ser_docto
                               item_cheq_ap.cdn_fornecedor        = antecip_pef_pend.cdn_fornecedor
                               item_cheq_ap.cod_tit_ap            = antecip_pef_pend.cod_tit_ap
                               item_cheq_ap.cod_parcela           = antecip_pef_pend.cod_parcela
                               item_cheq_ap.cod_usuario           = ?
                               item_cheq_ap.cod_usuar_pagto       = v_cod_usuar_corren
                               item_cheq_ap.val_pagto             = v_val_liq_antecip
                               item_cheq_ap.log_cheq_cancdo       = no
                               item_cheq_ap.des_text_histor       = antecip_pef_pend.des_text_histor
                               item_cheq_ap.cod_refer             = antecip_pef_pend.cod_refer
                               item_cheq_ap.num_seq_refer         = 0
                               item_cheq_ap.ind_tip_refer         = antecip_pef_pend.ind_tip_refer.

                        find last b_item_cheq_ap no-lock
                             where b_item_cheq_ap.cod_estab_cheq  = cheq_ap.cod_estab_cheq
                             and   b_item_cheq_ap.num_id_cheq_ap  = v_num_id_cheq_ap no-error.
                        if  avail b_item_cheq_ap then
                            assign item_cheq_ap.num_seq_item_cheq  = b_item_cheq_ap.num_seq_item_cheq + 1.
                        else
                            assign item_cheq_ap.num_seq_item_cheq  = 1.
                    end /* if */.
                    else do:
                        assign antecip_pef_pend.ind_sit_pef_antecip = "Pend" /*l_pendente*/ .
                        find usuar_financ_estab_apb no-lock
                             where usuar_financ_estab_apb.cod_usuario = v_cod_usuar_corren_aux
                             and   usuar_financ_estab_apb.cod_estab = antecip_pef_pend.cod_estab no-error.
                        if usuar_financ_estab_apb.val_lim_pagto_usuar_movto < antecip_pef_pend.val_tit_ap then
                           run pi_gerar_process_pagto_antecip_pef (Input v_val_liq_antecip,
                                                                   Input "Preparar" /*l_preparar*/) /*pi_gerar_process_pagto_antecip_pef*/.
                        else
                           run pi_gerar_process_pagto_antecip_pef (Input v_val_liq_antecip,
                                                                   Input "Liberar" /*l_liberar*/) /*pi_gerar_process_pagto_antecip_pef*/.
                    end /* else */.

                end /* else */.

            end /* if */.
            else do:
                if v_ind_tip_trans = "Preparar" /*l_preparar*/  then do:
                   assign antecip_pef_pend.ind_sit_pef_antecip = "Pend" /*l_pendente*/ .
                   run pi_gerar_process_pagto_antecip_pef (Input v_val_liq_antecip,
                                                           Input v_ind_tip_trans) /*pi_gerar_process_pagto_antecip_pef*/.
                end.
                else do:
                     find usuar_financ_estab_apb no-lock
                          where usuar_financ_estab_apb.cod_usuario = v_cod_usuar_corren_aux
                          and   usuar_financ_estab_apb.cod_estab = antecip_pef_pend.cod_estab no-error.
                     if usuar_financ_estab_apb.val_lim_liber_usuar_movto < antecip_pef_pend.val_tit_ap then do:
                        assign antecip_pef_pend.ind_sit_pef_antecip = "Pend" /*l_pendente*/ .
                        run pi_gerar_process_pagto_antecip_pef (Input v_val_liq_antecip,
                                                                Input "Preparar" /*l_preparar*/) /*pi_gerar_process_pagto_antecip_pef*/.
                     end.
                     else
                        run pi_gerar_process_pagto_antecip_pef (Input v_val_liq_antecip,
                                                                Input v_ind_tip_trans) /*pi_gerar_process_pagto_antecip_pef*/. 
                end.
            end /* else */.
        end /* else */.

        &IF DEFINED(BF_FIN_CONSIST_APF) &THEN
            if v_log_portad_cx then do:
               assign v_log_erro_apf = no.
               undo atualiz_block, return error. 
            end.
        &ENDIF

    end /* do atualiz_block */.

    /* ## A vari†vel abaixo, impede que seja inicializado o portador com o portador do fornecedor.
         Utilizada para as implantaá‰es sem portador. ##*/
    assign v_log_portador = yes.

    /* ** Atualizaá∆o dos Saldos das Contas Correntes SPOOL ***/
    run pi_sdo_cta_corren_spool_modulos.
END PROCEDURE. /* pi_atualiza_antecipacao_apb */
/*****************************************************************************
** Procedure Interna.....: pi_validar_habilit_usuar_transac
** Descricao.............: pi_validar_habilit_usuar_transac
** Criado por............: 
** Criado em.............: // 
** Alterado por..........: fut40574_3
** Alterado em...........: 04/01/2007 17:29:34
*****************************************************************************/
PROCEDURE pi_validar_habilit_usuar_transac:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_estab
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def Input param p_cod_finalid_econ
        as character
        format "x(10)"
        no-undo.
    def Input param p_cod_indic_econ
        as character
        format "x(8)"
        no-undo.
    def Input param p_dat_transacao
        as date
        format "99/99/9999"
        no-undo.
    def Input param p_val_tit_ap
        as decimal
        format "->>>,>>>,>>9.99"
        decimals 2
        no-undo.
    def output param p_ind_tip_trans
        as character
        format "X(08)"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_cod_finalid_econ
        as character
        format "x(10)":U
        label "Finalidade Econìmica"
        column-label "Finalidade Econìmica"
        no-undo.
    def var v_cod_parameters
        as character
        format "x(256)":U
        no-undo.
    def var v_cod_return_liber_pagto
        as character
        format "x(8)":U
        no-undo.
    def var v_cod_return_pagto
        as character
        format "x(8)":U
        no-undo.
    def var v_num_mensagem
        as integer
        format ">>>>,>>9":U
        label "N£mero"
        column-label "N£mero Mensagem"
        no-undo.
    def var v_val_tot_liber
        as decimal
        format "->>,>>>,>>>,>>9.99":U
        decimals 2
        no-undo.


    /************************** Variable Definition End *************************/

    habilit_block:
    do on error undo habilit_block, return error:
        assign p_ind_tip_trans = "Implantar" /*l_implantar*/ .

        find last param_estab_apb no-lock
            where param_estab_apb.cod_estab = p_cod_estab no-error.
        if  not avail param_estab_apb
        then do:
            assign v_num_mensagem   = 2075
                   v_cod_parameters = p_cod_estab.
            run pi_integr_apb_cria_msg_erro (Input ?,
                                             Input antecip_pef_pend.cod_estab,
                                             Input antecip_pef_pend.cod_refer,
                                             Input 0,
                                             Input "",
                                             Input 0,
                                             Input v_num_mensagem,
                                             Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.
            return error.
        end /* if */.

        find usuar_financ_estab_apb no-lock
            where usuar_financ_estab_apb.cod_usuario = v_cod_usuar_corren
            and   usuar_financ_estab_apb.cod_estab   = p_cod_estab no-error.    
        if  not avail usuar_financ_estab_apb
        then do:
            assign v_num_mensagem   = 20
                   v_cod_parameters = v_cod_usuar_corren + "," + p_cod_estab.
            run pi_integr_apb_cria_msg_erro (Input ?,
                                             Input antecip_pef_pend.cod_estab,
                                             Input antecip_pef_pend.cod_refer,
                                             Input 0,
                                             Input "",
                                             Input 0,
                                             Input v_num_mensagem,
                                             Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.
            return error.
        end /* if */.

        if  antecip_pef_pend.val_tit_ap < param_estab_apb.val_min_liber
        then do:
            if  usuar_financ_estab_apb.log_habilit_pagto_tit_ap
            then do:
                if  param_estab_apb.log_lim_val_usuar
                then do:
                    run pi_retornar_finalid_indic_econ (Input p_cod_indic_econ,
                                                        Input p_dat_transacao,
                                                        output v_cod_finalid_econ) /*pi_retornar_finalid_indic_econ*/.
                    run pi_verificar_val_usuar (Input p_cod_estab,
                                                Input p_dat_transacao,
                                                Input "Pagamento" /*l_pagamento*/,
                                                Input p_val_tit_ap,
                                                Input usuar_financ_estab_apb.val_lim_liber_usuar_movto,
                                                Input usuar_financ_estab_apb.val_lim_liber_usuar_mes,
                                                Input usuar_financ_estab_apb.val_lim_pagto_usuar_movto,
                                                Input usuar_financ_estab_apb.val_lim_pagto_usuar_mes,
                                                Input v_cod_finalid_econ,
                                                Input p_cod_indic_econ,
                                                output v_cod_return_liber_pagto,
                                                output v_cod_return_pagto) /*pi_verificar_val_usuar*/.
                    if  v_cod_return_pagto = "OK" /*l_ok*/ 
                    then do:
                        assign p_ind_tip_trans = "Pagar" /*l_pagar*/ .
                    end /* if */.
                    else do:
                        if index(v_cod_return_pagto, ",") > 0 then
                            assign v_cod_parameters = substring(v_cod_return_pagto, index(v_cod_return_pagto, ",") + 1).

                        /* msg_block: */
                        case entry(1,v_cod_return_pagto):
                            when "1053" then msg:
                             do:
                                 assign v_num_mensagem = 1053.
                            end /* do msg */.
                            when "1056" then msg:
                             do:
                                 assign v_num_mensagem = 1056.
                            end /* do msg */.
                            when "1057" then msg:
                             do:
                                 assign v_num_mensagem = 1057.
                            end /* do msg */.
                            when "241" then msg:
                             do:
                                 assign v_num_mensagem = 241.
                            end /* do msg */.
                            when "338" then msg:
                             do:
                                 assign v_num_mensagem = 338.
                            end /* do msg */.
                            when "357" then msg:
                             do:
                                 assign v_num_mensagem = 357.
                            end /* do msg */.
                            when "358" then msg:
                             do:
                                 assign v_num_mensagem = 358.
                            end /* do msg */.
                            when "774" then msg:
                             do:
                                 assign v_num_mensagem = 774.
                            end /* do msg */.
                            when "782" then msg:
                             do:
                                 assign v_num_mensagem = 782.
                            end /* do msg */.
                            when "1199" then msg:
                             do:
                                 assign v_num_mensagem = 1199.
                            end /* do msg */.
                            when "1200" then msg:
                             do:
                                 assign v_num_mensagem = 1200
                                        v_cod_parameters = v_cod_parameters + "," + "Finalidade" /*l_finalidade*/  + "," + "In°cio Validade" /*l_inicio_validade*/  + "," + "Fim Validade" /*l_fim_validade*/ .
                            end /* do msg */.
                            when "1389" then msg:
                             do:
                                 assign v_num_mensagem = 1389.
                            end /* do msg */.
                            when "1568" then msg:
                             do:
                                 assign v_num_mensagem = 1568.
                            end /* do msg */.
                            when "2071" then msg:
                             do:
                                 assign v_num_mensagem = 2071.
                            end /* do msg */.
                            when "2072" then msg:
                             do:
                                 assign v_num_mensagem = 2072.
                            end /* do msg */.
                            when "2073" then msg:
                             do:
                                 assign v_num_mensagem = 2073.
                            end /* do msg */.
                            otherwise msg:
                                      do:
                                 assign v_num_mensagem = 1036.
                            end /* do msg */.
                        end /* case msg_block */.
                        run pi_integr_apb_cria_msg_erro (Input ?,
                                                         Input antecip_pef_pend.cod_estab,
                                                         Input antecip_pef_pend.cod_refer,
                                                         Input 0,
                                                         Input "",
                                                         Input 0,
                                                         Input v_num_mensagem,
                                                         Input v_cod_parameters) /*pi_integr_apb_cria_msg_erro*/.
                        return error.
                    end /* else */.
                end /* if */.
            end /* if */.
        end /* if */.
        else do:
            if  usuar_financ_estab_apb.log_habilit_prepar_tit_ap
            then do:
                assign p_ind_tip_trans = "Preparar" /*l_preparar*/ .
                if  usuar_financ_estab_apb.log_habilit_liber_tit_ap
                then do:
                    assign p_ind_tip_trans = "Liberar" /*l_liberar*/ .
                    if  usuar_financ_estab_apb.log_habilit_pagto_tit_ap
                    then do:
                        assign p_ind_tip_trans = "Pagar" /*l_pagar*/ .
                    end /* if */.
                end /* if */.
            end /* if */.
            if  (p_ind_tip_trans = "Pagar" /*l_pagar*/ 
            or   p_ind_tip_trans = "Liberar" /*l_liberar*/ )
            and  param_estab_apb.log_lim_val_usuar
            then do:
                run pi_retornar_finalid_indic_econ (Input p_cod_indic_econ,
                                                    Input p_dat_transacao,
                                                    output v_cod_finalid_econ) /*pi_retornar_finalid_indic_econ*/.

                run pi_verificar_val_usuar (Input p_cod_estab,
                                            Input p_dat_transacao,
                                            Input "Ambos" /*l_ambos*/,
                                            Input p_val_tit_ap,
                                            Input usuar_financ_estab_apb.val_lim_liber_usuar_movto,
                                            Input usuar_financ_estab_apb.val_lim_liber_usuar_mes,
                                            Input usuar_financ_estab_apb.val_lim_pagto_usuar_movto,
                                            Input usuar_financ_estab_apb.val_lim_pagto_usuar_mes,
                                            Input v_cod_finalid_econ,
                                            Input p_cod_indic_econ,
                                            output v_cod_return_liber_pagto,
                                            output v_cod_return_pagto) /*pi_verificar_val_usuar*/.
                if  v_cod_return_liber_pagto <> "OK" /*l_ok*/ 
                then do:
                    assign p_ind_tip_trans = "Preparar" /*l_preparar*/ .
                end /* if */.
                else do:
                    if  p_ind_tip_trans = "Pagar" /*l_pagar*/  and v_cod_return_pagto <> "OK" /*l_ok*/ 
                    then do:
                        assign p_ind_tip_trans = "Liberar" /*l_liberar*/ .
                    end /* if */.
                end /* else */.
            end /* if */.
        end /* else */.
    end.
END PROCEDURE. /* pi_validar_habilit_usuar_transac */
/*****************************************************************************
** Procedure Interna.....: pi_gerar_cheque_apb
** Descricao.............: pi_gerar_cheque_apb
** Criado por............: rafael
** Criado em.............: // 
** Alterado por..........: fut41675
** Alterado em...........: 26/08/2014 09:18:20
*****************************************************************************/
PROCEDURE pi_gerar_cheque_apb:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_portador
        as character
        format "x(5)"
        no-undo.
    def Input param p_cod_cart_bcia
        as character
        format "x(3)"
        no-undo.
    def Input param p_cod_estab_refer
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def Input param p_cod_indic_econ
        as character
        format "x(8)"
        no-undo.
    def Input param p_dat_transacao
        as date
        format "99/99/9999"
        no-undo.
    def Input param p_nom_favorec_cheq
        as character
        format "x(40)"
        no-undo.
    def Input param p_ind_favorec_cheq
        as character
        format "X(15)"
        no-undo.
    def Input param p_num_talon_cheq
        as integer
        format ">>>,>>>,>>9"
        no-undo.
    def Input param p_num_cheque
        as integer
        format ">>>>,>>>,>>9"
        no-undo.
    def Input param p_val_cheque
        as decimal
        format ">>>,>>>,>>9.99"
        decimals 2
        no-undo.
    def Input param p_rec_cheq_ap
        as recid
        format ">>>>>>9"
        no-undo.
    def Input param p_des_text_histor
        as character
        format "x(2000)"
        no-undo.
    def output param p_cod_estab_cheq
        as character
        format "x(3)"
        no-undo.
    def output param p_num_id_cheq_ap
        as integer
        format "9999999999"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************** Buffer Definition Begin *************************/

    &if "{&emsfin_version}" >= "5.01" &then
    def buffer b_cheq_ap
        for cheq_ap.
    &endif


    /*************************** Buffer Definition End **************************/

    /************************* Variable Definition Begin ************************/

    def var v_cod_empres_usuar_5
        as character
        format "x(8)":U
        no-undo.
    def var v_cod_finalid_econ
        as character
        format "x(10)":U
        label "Finalidade Econìmica"
        column-label "Finalidade Econìmica"
        no-undo.
    def var v_num_seq_cheq_ap
        as integer
        format ">9":U
        label "Seq"
        column-label "Seq"
        no-undo.
    def var v_rec_cheq_ap_atualiz
        as recid
        format ">>>>>>9":U
        no-undo.


    /************************** Variable Definition End *************************/


    /* fut38629 - Repasse alteraá‰es FDES Argentina */
    if v_log_localiz_arg then do:
        for each impto_impl_pend_ap no-lock
            where impto_impl_pend_ap.cod_estab_refer     = p_cod_estab_refer
              and impto_impl_pend_ap.cod_refer           = antecip_pef_pend.cod_refer:
            find first imposto OF impto_impl_pend_ap no-lock no-error.
            if avail imposto and imposto.ind_clas_impto = "Retido" /*l_retido*/  then
                assign p_val_cheque = p_val_cheque - impto_impl_pend_ap.val_imposto.
        end.
    end.

    assign v_cod_empres_usuar_5 = v_cod_empres_usuar.

    if 'add_antecip_pef_pend' = 'add_antecip_pef_pend_pef'
    or 'add_antecip_pef_pend' = 'mod_antecip_pef_pend_pef' 
    or 'add_antecip_pef_pend' = 'add_antecip_pef_pend'
    or 'add_antecip_pef_pend' = 'mod_antecip_pef_pend_base' then do:
        &if '{&emsfin_version}' >= '5.03' &then
            find last param_geral_apb no-lock no-error.
            if avail param_geral_apb then do:
                if param_geral_apb.log_reg_corporat then do:
                    find estabelecimento no-lock
                        where estabelecimento.cod_estab = p_cod_estab_refer no-error.
                    if  avail estabelecimento
                    then do:
                        assign v_cod_empres_usuar_5 = estabelecimento.cod_empresa.
                    end /* if */.
                end.
            end.        
        &endif  
    end.    

    /* **
     O parÉmetro p_rec_cheq_ap pode ter os seguintes valores:
     - ?: quando a atualizaá∆o da tabela cheq_ap e cheque for normal;
     - 0: quando se quer obrigatoriamente que seja criado um novo cheque ou
     - um recid v†lido: quando se quer que este cheq_ap e o respectivo cheque sejam os atualizados.
    ***/

    block3:
    do on error undo block3, return error:
        if recid(cheq_ap) <> ? then.
        find portador no-lock
             where portador.cod_portador = p_cod_portador no-error.
        find portad_estab no-lock
             where portad_estab.cod_estab    = p_cod_estab_refer
               and portad_estab.cod_portador = p_cod_portador no-error.

        run pi_retornar_finalid_indic_econ (Input p_cod_indic_econ,
                                            Input p_dat_transacao,
                                            output v_cod_finalid_econ) /*pi_retornar_finalid_indic_econ*/.

        find portad_finalid_econ no-lock
             where portad_finalid_econ.cod_estab        = p_cod_estab_refer
               and portad_finalid_econ.cod_portador     = p_cod_portador
               and portad_finalid_econ.cod_cart_bcia    = p_cod_cart_bcia
               and portad_finalid_econ.cod_finalid_econ = v_cod_finalid_econ
              no-error.
        find cta_corren no-lock
             where cta_corren.cod_cta_corren = portad_finalid_econ.cod_cta_corren no-error.

        if  p_rec_cheq_ap = ? then do:
            if  p_num_talon_cheq = 0 then do:
                find last cheq_ap exclusive-lock use-index cheqap_id
                    where cheq_ap.cod_estab_cheq         = cta_corren.cod_estab
                    and   cheq_ap.cod_estab_refer        = p_cod_estab_refer
                    and   cheq_ap.cod_portador           = p_cod_portador
                    and   cheq_ap.cod_cart_bcia          = p_cod_cart_bcia
                    and   cheq_ap.cod_finalid_econ       = v_cod_finalid_econ
                    and   cheq_ap.dat_emis_cheq          = p_dat_transacao
                    and   trim(cheq_ap.nom_favorec_cheq) = trim(p_nom_favorec_cheq)
                    and   cheq_ap.num_talon_cheq         = 0
                    and   cheq_ap.num_cheque             = 0
                    and   cheq_ap.log_cheq_cancdo        = no
                    and   cheq_ap.log_cheq_confdo        = no
                &if '{&emsfin_version}' < "5.02" &then 
                    and   (    cheq_ap.log_livre_1       = no
                            or cheq_ap.log_livre_1       = ? )
                &else
                    and   cheq_ap.log_cheq_parcte_atlzdo = no
                &endif
                    no-error.       
            end.        
            else do:
                find first cheq_ap exclusive-lock use-index cheqap_num_cheque
                    where cheq_ap.cod_banco          = cta_corren.cod_banco
                    and   cheq_ap.cod_agenc_bcia     = cta_corren.cod_agenc_bcia
                    and   cheq_ap.cod_cta_corren_bco = cta_corren.cod_cta_corren_BCO
                    and   cheq_ap.num_talon_cheq     = p_num_talon_cheq
                    and   cheq_ap.num_cheque         = p_num_cheque
                    and   cheq_ap.cod_estab_cheq     = cta_corren.cod_estab no-error. 
            end.
        end.
        else
            find cheq_ap where recid(cheq_ap) = p_rec_cheq_ap exclusive-lock no-error.

        if  not avail cheq_ap then do:
            find last cheq_ap no-lock use-index cheqap_id
                where cheq_ap.cod_estab_cheq         = cta_corren.cod_estab
                and   cheq_ap.cod_estab_refer        = p_cod_estab_refer
                and   cheq_ap.cod_portador           = p_cod_portador
                and   cheq_ap.cod_cart_bcia          = p_cod_cart_bcia
                and   cheq_ap.cod_finalid_econ       = v_cod_finalid_econ
                and   cheq_ap.dat_emis_cheq          = p_dat_transacao
                and   trim(cheq_ap.nom_favorec_cheq) = trim(p_nom_favorec_cheq)
                no-error.

            if  avail cheq_ap then
                assign v_num_seq_cheq_ap = cheq_ap.num_seq_cheq + 1.
            else 
                assign v_num_seq_cheq_ap = 1.

            create cheq_ap.
            assign cheq_ap.cod_empresa           = v_cod_empres_usuar_5
                   cheq_ap.cod_estab_cheq        = cta_corren.cod_estab
                   cheq_ap.cod_estab_refer       = p_cod_estab_refer
                   cheq_ap.cod_portador          = p_cod_portador
                   cheq_ap.cod_finalid_econ      = v_cod_finalid_econ
                   cheq_ap.cod_cart_bcia         = p_cod_cart_bcia
                   cheq_ap.dat_emis_cheq         = p_dat_transacao
                   cheq_ap.nom_favorec_cheq      = p_nom_favorec_cheq
                   cheq_ap.num_seq_cheq          = v_num_seq_cheq_ap
                   cheq_ap.cod_banco             = cta_corren.cod_banco
                   cheq_ap.cod_agenc_bcia        = cta_corren.cod_agenc_bcia
                   cheq_ap.cod_cta_corren_bco    = cta_corren.cod_cta_corren_bco
                   cheq_ap.cod_cta_corren        = portad_finalid_econ.cod_cta_corren
                   cheq_ap.num_talon_cheq        = p_num_talon_cheq
                   cheq_ap.num_cheque            = p_num_cheque
                   cheq_ap.val_cheque            = p_val_cheque
                   cheq_ap.ind_favorec_cheq      = p_ind_favorec_cheq
                   cheq_ap.log_cheq_cancdo       = no
                   cheq_ap.log_cheq_confdo       = no
                   cheq_ap.cod_usuar_emis_cheq   = v_cod_usuar_corren
                   cheq_ap.num_id_cheq_ap        = next-value(seq_cheq_ap)
                   p_num_id_cheq_ap              = cheq_ap.num_id_cheq_ap
                   p_cod_estab_cheq              = cheq_ap.cod_estab_cheq.

            &if  defined(BF_FIN_HISTOR_VERS_CHEQ) &then
                 assign cheq_ap.des_text_histor = p_des_text_histor.
            &else
                 find first histor_exec_especial
                     where histor_exec_especial.cod_modul_dtsul = 'UFN'
                     and   histor_exec_especial.cod_prog_dtsul  = 'spp_histor_vers_cheq':U
                     no-lock no-error.
                 if  avail histor_exec_especial then
                     assign cheq_ap.cod_livre_1 = p_des_text_histor + chr(10).
            &endif

            assign v_rec_cheq_ap_atualiz = recid(cheq_ap).
            &if '{&ems_dbtype}' <> 'progress' &then
            if recid(cheq_ap) <> ? then.
            &endif

            release cheq_ap.
            find cheq_ap exclusive-lock
                where recid(cheq_ap) = v_rec_cheq_ap_atualiz no-error.



            if  p_num_talon_cheq <> 0 then do:
                assign cheq_ap.cod_usuar_impres_cheq = v_cod_usuar_corren
                       cheq_ap.dat_impres_cheq       = today
                       cheq_ap.hra_impres_cheq       = replace(string(time,"hh:mm:ss" /*l_hh:mm:ss*/ ),":","")
                       cheq_ap.log_cheq_emitid       = yes
                       cheq_ap.log_impres_cheq_sist  = no.

                run pi_gerar_cheque (Input p_cod_estab_cheq,
                                     Input cta_corren.cod_cta_corren,
                                     Input p_num_talon_cheq,
                                     Input p_num_cheque,
                                     Input p_val_cheque,
                                     Input p_dat_transacao,
                                     Input p_ind_favorec_cheq,
                                     Input p_nom_favorec_cheq,
                                     Input v_cod_finalid_econ,
                                     Input "APB" /*l_apb*/,
                                     Input no,
                                     Input p_des_text_histor) /*pi_gerar_cheque*/.
            end.
            else
                assign cheq_ap.cod_usuar_impres_cheq = ""
                       cheq_ap.dat_impres_cheq       = ?
                       cheq_ap.hra_impres_cheq       = ?
                       cheq_ap.log_cheq_emitid       = no
                       cheq_ap.log_impres_cheq_sist  = yes.
        end.
        else do:
            assign cheq_ap.val_cheque = cheq_ap.val_cheque + p_val_cheque
                   p_num_id_cheq_ap   = cheq_ap.num_id_cheq_ap
                   p_cod_estab_cheq   = cheq_ap.cod_estab_cheq.
            if  p_num_talon_cheq <> 0 then do:
                run pi_gerar_cheque (Input p_cod_estab_cheq,
                                     Input cta_corren.cod_cta_corren,
                                     Input p_num_talon_cheq,
                                     Input p_num_cheque,
                                     Input p_val_cheque,
                                     Input p_dat_transacao,
                                     Input p_ind_favorec_cheq,
                                     Input p_nom_favorec_cheq,
                                     Input v_cod_finalid_econ,
                                     Input "APB" /*l_apb*/,
                                     Input no,
                                     Input p_des_text_histor) /*pi_gerar_cheque*/.
            end.
        end.

        assign v_rec_cheq_ap = recid(cheq_ap).


    end.
END PROCEDURE. /* pi_gerar_cheque_apb */
/*****************************************************************************
** Procedure Interna.....: pi_gerar_cheque
** Descricao.............: pi_gerar_cheque
** Criado por............: Roberto
** Criado em.............: 23/12/1996 18:48:08
** Alterado por..........: fut12214_2
** Alterado em...........: 28/10/2004 11:00:57
*****************************************************************************/
PROCEDURE pi_gerar_cheque:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_estab
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def Input param p_cod_cta_corren
        as character
        format "x(10)"
        no-undo.
    def Input param p_num_talon_cheq
        as integer
        format ">>>,>>>,>>9"
        no-undo.
    def Input param p_num_cheque
        as integer
        format ">>>>,>>>,>>9"
        no-undo.
    def Input param p_val_cheque
        as decimal
        format ">>>,>>>,>>9.99"
        decimals 2
        no-undo.
    def Input param p_dat_transacao
        as date
        format "99/99/9999"
        no-undo.
    def Input param p_ind_favorec_cheq
        as character
        format "X(15)"
        no-undo.
    def Input param p_nom_favorec_cheq
        as character
        format "x(40)"
        no-undo.
    def Input param p_cod_finalid_econ
        as character
        format "x(10)"
        no-undo.
    def Input param p_cod_modul_dtsul
        as character
        format "x(3)"
        no-undo.
    def Input param p_log_impres_cheq_sist
        as logical
        format "Sim/N∆o"
        no-undo.
    def Input param p_des_text_histor
        as character
        format "x(2000)"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_cod_empres_usuar_4
        as character
        format "x(8)":U
        no-undo.
    def var v_log_return
        as logical
        format "Sim/N∆o"
        initial no
        no-undo.


    /************************** Variable Definition End *************************/

    assign v_cod_empres_usuar_4 = v_cod_empres_usuar.

    if 'add_antecip_pef_pend' = 'add_antecip_pef_pend_pef'
    or 'add_antecip_pef_pend' = 'mod_antecip_pef_pend_pef' then do:
        &if '{&emsfin_version}' >= '5.03' &then
            find last param_geral_apb no-lock no-error.
            if avail param_geral_apb then do:
                if param_geral_apb.log_reg_corporat then do:
                    find estabelecimento no-lock
                        where estabelecimento.cod_estab = p_cod_estab no-error.
                    if  avail estabelecimento
                    then do:
                        assign v_cod_empres_usuar_4 = estabelecimento.cod_empresa.
                    end /* if */.
                end.
            end.        
        &endif            
    end.        

    run pi_monta_lista_modul_dtsul_empres /*pi_monta_lista_modul_dtsul_empres*/.

    run pi_verifica_utiliz_modulo (Input v_cod_empres_usuar_4,
                                   Input "CMG" /*l_cmg*/,
                                   output v_log_return) /*pi_verifica_utiliz_modulo*/.

    if  v_log_return = yes then do:
        find estabelecimento no-lock
            where estabelecimento.cod_estab = p_cod_estab
            no-error.
        find pessoa_jurid no-lock
            where pessoa_jurid.num_pessoa_jurid = estabelecimento.num_pessoa_jurid
            no-error.

        find talon_cheq no-lock
            where talon_cheq.cod_cta_corren = p_cod_cta_corren
            and   talon_cheq.num_talon_cheq = p_num_talon_cheq
            no-error.

        find cheque exclusive-lock
             where cheque.cod_cta_corren = p_cod_cta_corren
             and   cheque.num_talon_cheq = p_num_talon_cheq
             and   cheque.num_cheque     = p_num_cheque
             no-error.
        if  not avail cheque then do:
            /* Atividade 106482 - 01/12/2003.*/
            create cheque.
            assign cheque.cod_empresa           = v_cod_empres_usuar_4
                   cheque.cod_cta_corren        = p_cod_cta_corren
                   cheque.num_talon_cheq        = p_num_talon_cheq
                   cheque.num_cheque            = p_num_cheque
                   cheque.num_id_cheq           = next-value(seq_cheque)
                   cheque.cod_tip_cheq          = talon_cheq.cod_tip_cheq
                   cheque.cod_modul_dtsul       = p_cod_modul_dtsul
                   cheque.val_cheque            = p_val_cheque
                   cheque.dat_emis_cheq         = p_dat_transacao
                   cheque.ind_favorec_cheq      = p_ind_favorec_cheq
                   cheque.nom_favorec_cheq      = p_nom_favorec_cheq
                   cheque.nom_cidad_emit_cheq   = substring(pessoa_jurid.nom_cidade, 1, 30)
                   cheque.cod_finalid_econ      = p_cod_finalid_econ
                   cheque.num_cop_cheq          = 0
                   cheque.log_impres_cheq_sist  = p_log_impres_cheq_sist
                   cheque.ind_sit_cheq          = "Impresso" /*l_impresso*/ 
                   cheque.cod_usuar_impres_cheq = v_cod_usuar_corren
                   cheque.dat_impres_cheq       = today
                   cheque.hra_impres_cheq       = replace(string(time,"hh:mm:ss" /*l_hh:mm:ss*/ ),":","").

            &if  defined(BF_FIN_HISTOR_VERS_CHEQ) &then
                 assign cheque.des_text_histor = p_des_text_histor.
            &else
                 find first histor_exec_especial
                     where histor_exec_especial.cod_modul_dtsul = 'UFN'
                     and   histor_exec_especial.cod_prog_dtsul  = 'spp_histor_vers_cheq':U
                     no-lock no-error.
                 if  avail histor_exec_especial then
                     assign cheque.cod_livre_1 = p_des_text_histor + chr(10).
            &endif
        end.
        else
            assign cheque.val_cheque = cheque.val_cheque + p_val_cheque.
    end.
END PROCEDURE. /* pi_gerar_cheque */
/*****************************************************************************
** Procedure Interna.....: pi_verifica_utiliz_modulo
** Descricao.............: pi_verifica_utiliz_modulo
** Criado por............: 
** Criado em.............: // 
** Alterado por..........: Menna
** Alterado em...........: 06/05/1999 10:32:29
*****************************************************************************/
PROCEDURE pi_verifica_utiliz_modulo:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_empresa
        as character
        format "x(3)"
        no-undo.
    def Input param p_cod_modul_dtsul
        as character
        format "x(3)"
        no-undo.
    def output param p_log_param_utiliz_produt_val
        as logical
        format "Sim/N∆o"
        no-undo.


    /************************* Parameter Definition End *************************/

    if  p_cod_empresa = "" then
        assign p_log_param_utiliz_produt_val = can-find(first param_utiliz_produt
                                                       where param_utiliz_produt.cod_modul_dtsul = p_cod_modul_dtsul /*cl_verifica_modulo of param_utiliz_produt*/).
    else do:
       if  p_cod_empresa = v_cod_empres_usuar then
           assign p_log_param_utiliz_produt_val = can-do(v_cod_modul_dtsul_empres,p_cod_modul_dtsul).
       else
           assign p_log_param_utiliz_produt_val = can-find(first param_utiliz_produt
                                                          where param_utiliz_produt.cod_empresa = p_cod_empresa
                                                            and param_utiliz_produt.cod_modul_dtsul = p_cod_modul_dtsul
    &if "{&emsuni_version}" >= "5.01" &then
                                                          use-index prmtlzcm_modulo
    &endif
                                                           /*cl_verifica_utiliz_modul of param_utiliz_produt*/).
    end.

END PROCEDURE. /* pi_verifica_utiliz_modulo */
/*****************************************************************************
** Procedure Interna.....: pi_gerar_process_pagto_antecip_pef
** Descricao.............: pi_gerar_process_pagto_antecip_pef
** Criado por............: rafael
** Criado em.............: // 
** Alterado por..........: fut12143
** Alterado em...........: 17/08/2016 08:22:03
*****************************************************************************/
PROCEDURE pi_gerar_process_pagto_antecip_pef:

    /************************ Parameter Definition Begin ************************/

    def Input param p_val_liq_antecip
        as decimal
        format "->>,>>>,>>>,>>9.99"
        decimals 2
        no-undo.
    def Input param p_ind_tip_trans
        as character
        format "X(08)"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_cod_empres_usuar_7
        as character
        format "x(8)":U
        no-undo.
    def var v_cod_indic_econ_cor
        as character
        format "x(8)":U
        label "Moeda"
        column-label "Moeda"
        no-undo.
    def var v_cod_return
        as character
        format "x(40)":U
        no-undo.
    def var v_log_verifica_apf               as logical         no-undo. /*local*/
    def var v_num_seq                        as integer         no-undo. /*local*/


    /************************** Variable Definition End *************************/

    assign v_cod_empres_usuar_7 = v_cod_empres_usuar.
    if 'add_antecip_pef_pend' = 'add_antecip_pef_pend_pef'
    or 'add_antecip_pef_pend' = 'mod_antecip_pef_pend_pef' 
    or 'add_antecip_pef_pend' = 'add_antecip_pef_pend'
    or 'add_antecip_pef_pend' = 'mod_antecip_pef_pend_base' then do:
        &if '{&emsfin_version}' >= '5.03' &then
            find last param_geral_apb no-lock no-error.
            if avail param_geral_apb then do:
                if param_geral_apb.log_reg_corporat then do:
                    find estabelecimento no-lock
                        where estabelecimento.cod_estab = antecip_pef_pend.cod_estab no-error.
                    if  avail estabelecimento
                    then do:
                        assign v_cod_empres_usuar_7 = estabelecimento.cod_empresa.
                    end /* if */.
                end.
           end.
        &endif  
    end.

    block5:
    do on error undo block5, return error:
        if antecip_pef_pend.ind_tip_refer   = "Antecipaá∆o" /*l_antecipacao*/ 
        or antecip_pef_pend.ind_tip_refer   = "Pagto Extra Fornecedor" /*l_pagto_extra_fornecedor*/  then
            assign v_cod_espec_docto        = antecip_pef_pend.cod_espec_docto
                   v_cod_ser_docto          = antecip_pef_pend.cod_ser_docto
                   v_cod_tit_ap             = antecip_pef_pend.cod_tit_ap
                   v_cod_parcela            = antecip_pef_pend.cod_parcela.
        else
            assign v_cod_espec_docto        = ""
                   v_cod_ser_docto          = ""
                   v_cod_tit_ap             = ""
                   v_cod_parcela            = "".




        assign v_rec_proces_pagto = ?.
        find first proces_pagto exclusive-lock
            where proces_pagto.cod_estab             = antecip_pef_pend.cod_estab
              and proces_pagto.cod_refer_antecip_pef = antecip_pef_pend.cod_refer no-error.


        if  not avail proces_pagto
        then do:
            create proces_pagto.
            assign proces_pagto.cod_empresa            = antecip_pef_pend.cod_empresa
                   proces_pagto.cod_estab              = antecip_pef_pend.cod_estab

                   proces_pagto.cod_refer_antecip_pef  = antecip_pef_pend.cod_refer

                   proces_pagto.cod_espec_docto        = v_cod_espec_docto
                   proces_pagto.cod_ser_docto          = v_cod_ser_docto
                   proces_pagto.cod_tit_ap             = v_cod_tit_ap
                   proces_pagto.cod_parcela            = v_cod_parcela
                   proces_pagto.cdn_fornecedor         = antecip_pef_pend.cdn_fornecedor
                   proces_pagto.num_seq_pagto_tit_ap   = 1.


            assign v_rec_proces_pagto = recid(proces_pagto).
            if  recid(proces_pagto) <> ? then.


        end /* if */.


        if  v_rec_proces_pagto <> ? then
            find first proces_pagto exclusive-lock
                 where recid(proces_pagto) = v_rec_proces_pagto no-error.


        assign proces_pagto.cod_portador           = antecip_pef_pend.cod_portador
               proces_pagto.dat_vencto_tit_ap      = antecip_pef_pend.dat_vencto_tit_ap
               proces_pagto.dat_prev_pagto         = antecip_pef_pend.dat_vencto_tit_ap
               proces_pagto.ind_sit_proces_pagto   = "Preparado" /*l_preparado*/  
               proces_pagto.cod_usuar_prepar_pagto = antecip_pef_pend.cod_usuar_gerac_movto
               proces_pagto.dat_prepar_pagto       = antecip_pef_pend.dat_emis_docto
               proces_pagto.cod_indic_econ         = antecip_pef_pend.cod_indic_econ
               proces_pagto.ind_modo_pagto         = v_ind_modo_pagto

               .

        find last param_empres_apb no-lock
           where param_empres_apb.cod_empresa = v_cod_empres_usuar_7 /* cl_empres_usuar of param_empres_apb*/ no-error.

        run pi_retornar_indic_econ_corren_estab (Input antecip_pef_pend.cod_estab,
                                                 Input antecip_pef_pend.dat_emis_docto,
                                                 output v_cod_indic_econ_cor) /* pi_retornar_indic_econ_corren_estab*/.        
        run prgfin/apb/apb901zb.py (Input "Implantaá∆o Antecip" /*l_implantacao_antecip*/,
                                    Input "",
                                    Input 0,
                                    Input antecip_pef_pend.dat_emis_docto,
                                    Input antecip_pef_pend.dat_vencto_tit_ap,
                                    Input antecip_pef_pend.dat_emis_docto,
                                    Input "",
                                    Input "",
                                    output v_log_calc_val_pres,
                                    output v_log_calc_variac,
                                    output v_ind_calc_fasb,
                                    output v_log_calc_variac_fasb,
                                    output v_dat_pagto_fasb,
                                    output v_val_sdo_orig_ult_correc_val,
                                    output v_ind_tip_conver) /*prg_fnc_param_conver_val*/.
        run prgint/utb/utb904za.py (Input "APB" /*l_apb*/,
                                    Input antecip_pef_pend.cod_empresa,
                                    Input p_val_liq_antecip,
                                    Input antecip_pef_pend.dat_emis_docto,
                                    Input v_ind_tip_conver,
                                    Input antecip_pef_pend.cod_indic_econ,
                                    Input "",
                                    Input "",
                                    Input param_empres_apb.cod_finalid_econ_val_usuar,
                                    Input antecip_pef_pend.dat_vencto_tit_ap,
                                    Input v_dat_pagto_fasb,
                                    Input antecip_pef_pend.dat_emis_docto,
                                    Input 0,
                                    Input 0,
                                    Input 0,
                                    Input 0,
                                    Input 0,
                                    Input 0,
                                    Input v_log_calc_val_pres,
                                    Input v_log_calc_variac,
                                    Input v_ind_calc_fasb,
                                    Input v_log_calc_variac_fasb,
                                    Input v_val_sdo_orig_ult_correc_val,
                                    Input v_cod_indic_econ_cor,
                                    Input antecip_pef_pend.val_cotac_indic_econ,
                                    output v_cod_return) /*prg_fnc_conver_ie_fe*/.

        run pi_i_return_msg_erro_conver (input-output v_cod_return) /*pi_i_return_msg_erro_conver*/.
        if  return-value <> "OK" /*l_ok*/  then
            return error.

        if  p_ind_tip_trans = "Liberar" /*l_liberar*/ 
        or  p_ind_tip_trans = "Pagar" /*l_pagar*/ 
        then do:


            assign v_log_verifica_apf = no.

            if  v_log_mod_apf and v_cod_mod <> "" /*l_*/  then do:
                if  v_log_apf_portad = yes then do:

                    if antecip_pef_pend.ind_tip_refer = "Antecipaá∆o" /*l_antecipacao*/  then
                        run pi_verifica_param_aprov_apf (input  v_cod_empres_usuar,
                                                         input  antecip_pef_pend.cod_espec_docto,
                                                         input  no,
                                                         output v_log_param_apb_apf,
                                                         output v_ind_param_aprov_docto,
                                                         output v_log_aprov_impl_apf,
                                                         output v_log_aprov_pagto_apf).
                    else
                        run pi_verifica_param_aprov_apf (input  v_cod_empres_usuar,
                                                         input  "",
                                                         input  yes,
                                                         output v_log_param_apb_apf,
                                                         output v_ind_param_aprov_docto,
                                                         output v_log_aprov_impl_apf,
                                                         output v_log_aprov_pagto_apf).

                    if  v_log_param_apb_apf and (v_log_aprov_impl_apf or v_log_aprov_pagto_apf) then
                        assign v_log_verifica_apf = yes.
                end.
            end.


            assign proces_pagto.cod_usuar_liber_pagto = antecip_pef_pend.cod_usuar_gerac_movto
                   proces_pagto.dat_liber_pagto       = antecip_pef_pend.dat_emis_docto
                   proces_pagto.ind_sit_proces_pagto  = "Liberado" /*l_liberado*/ 
                   proces_pagto.val_liberd_pagto      = p_val_liq_antecip.


            if v_log_verifica_apf = yes then do:
                assign proces_pagto.ind_sit_proces_pagto  = "Preparado" /*l_preparado*/ .
            end.
            else do:
                assign proces_pagto.ind_sit_proces_pagto  = "Liberado" /*l_liberado*/ .
            end.


            if v_log_atualiz_hora_liber = yes then do:
                &if '{&emsfin_version}' < '5.05' &then
                    assign proces_pagto.cod_livre_1 = string(time,'hh:mm:ss').
                &else
                    assign proces_pagto.hra_liber_proces_pagto = replace(string(time,'HH:MM:SS'),":","").
                &endif
            end.    
        end.               

        find first tt_converter_finalid_econ no-lock no-error.

        if avail antecip_pef_pend then
            find current antecip_pef_pend exclusive-lock no-error.

        if  p_ind_tip_trans = "Pagar" /*l_pagar*/ 
        then do:
            run pi_atualizar_valor_usuar_apb (Input antecip_pef_pend.cod_estab,
                                              Input antecip_pef_pend.cod_estab,
                                              Input antecip_pef_pend.dat_emis_docto,
                                              Input "Ambos" /*l_ambos*/,
                                              Input tt_converter_finalid_econ.tta_val_transacao,
                                              Input antecip_pef_pend.cod_usuar_gerac_movto) /*pi_atualizar_valor_usuar_apb*/.
        end /* if */.
        else do:
            if  p_ind_tip_trans = "Liberar" /*l_liberar*/ 
            then do:
                run pi_atualizar_valor_usuar_apb (Input antecip_pef_pend.cod_estab,
                                                  Input antecip_pef_pend.cod_estab,
                                                  Input antecip_pef_pend.dat_emis_docto,
                                                  Input "Liber" /*l_liber*/,
                                                  Input tt_converter_finalid_econ.tta_val_transacao,
                                                  Input antecip_pef_pend.cod_usuar_gerac_movto) /*pi_atualizar_valor_usuar_apb*/.
            end /* if */.
        end /* else */.
    end /* do block5 */.

END PROCEDURE. /* pi_gerar_process_pagto_antecip_pef */
/*****************************************************************************
** Procedure Interna.....: pi_atualizar_valor_usuar_apb
** Descricao.............: pi_atualizar_valor_usuar_apb
** Criado por............: 
** Criado em.............: // 
** Alterado por..........: fut35183
** Alterado em...........: 21/03/2007 11:42:20
*****************************************************************************/
PROCEDURE pi_atualizar_valor_usuar_apb:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_estab_bord
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def Input param p_cod_estab
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def Input param p_dat_transacao
        as date
        format "99/99/9999"
        no-undo.
    def Input param p_ind_tip_verific
        as character
        format "X(08)"
        no-undo.
    def Input param p_val_finalid_econ
        as decimal
        format "->>,>>>,>>>,>>9.99"
        decimals 2
        no-undo.
    def Input param p_cod_usuar_corren
        as character
        format "x(12)"
        no-undo.


    /************************* Parameter Definition End *************************/

    assign_block:
    do on error undo assign_block, return error:

        assign p_dat_transacao = date(month(p_dat_transacao),01,year(p_dat_transacao)).

        /* -- Atualiza valor total de liberaá∆o feito pelo usu†rio no màs --*/
        if  p_ind_tip_verific = "Liber" /*l_liber*/  or  p_ind_tip_verific = "Ambos" /*l_ambos*/  then do:
            find movto_usuar_financ exclusive-lock use-index mvtsrfnn_id
                where movto_usuar_financ.cod_estab          = p_cod_estab
                and   movto_usuar_financ.cod_usuario        = p_cod_usuar_corren
                and   movto_usuar_financ.dat_movto_usuar_ap = p_dat_transacao no-error.

            if  not avail movto_usuar_financ then do:
                create movto_usuar_financ.
                assign movto_usuar_financ.cod_usuario             = p_cod_usuar_corren
                       movto_usuar_financ.cod_estab               = p_cod_estab
                       movto_usuar_financ.dat_movto_usuar_ap      = p_dat_transacao
                       movto_usuar_financ.val_tot_liber_pagto_mes = 0
                       movto_usuar_financ.val_tot_pagto_mes       = 0
                       movto_usuar_financ.val_tot_pagto_pend_mes  = 0.
            end.

            assign movto_usuar_financ.val_tot_liber_pagto_mes =
                   movto_usuar_financ.val_tot_liber_pagto_mes + p_val_finalid_econ.
        end.

        /* -- Atualiza valor total de pagto feito pelo usu†rio no màs--*/
        if  p_ind_tip_verific = "Pagto" /*l_pagto*/  or p_ind_tip_verific = "Ambos" /*l_ambos*/  then do:
            find movto_usuar_financ exclusive-lock use-index mvtsrfnn_id
                where movto_usuar_financ.cod_usuario = p_cod_usuar_corren
                and   movto_usuar_financ.cod_estab   = p_cod_estab_bord
                and   movto_usuar_financ.dat_movto_usuar_ap = p_dat_transacao no-error.

            if  not avail movto_usuar_financ then do:
                create movto_usuar_financ.
                assign movto_usuar_financ.cod_usuario             = p_cod_usuar_corren
                       movto_usuar_financ.cod_estab               = p_cod_estab_bord
                       movto_usuar_financ.dat_movto_usuar_ap      = p_dat_transacao
                       movto_usuar_financ.val_tot_liber_pagto_mes = 0
                       movto_usuar_financ.val_tot_pagto_mes       = 0
                       movto_usuar_financ.val_tot_pagto_pend_mes  = 0.
            end.

            assign movto_usuar_financ.val_tot_pagto_pend_mes =
                   movto_usuar_financ.val_tot_pagto_pend_mes + p_val_finalid_econ.

            /* ** Ser† atualizado o valor dos limites de pagamento do usu†rio junto ao item de pagamento
                 para caso o lote venha a ser estornado, atualize os valores do usu†rio que fez o pagamento
                 e n∆o o que est† fazendo a movimentaá∆o de estorno.
            ***/
            &if '{&emsbas_version}' >= '5.03' &then
                if avail item_bord_ap then
                    assign item_bord_ap.cod_usuar_pagto = movto_usuar_financ.cod_usuario.

                if avail antecip_pef_pend then do:
                    /* Alteracao por demanda - 175894 */
                    find current antecip_pef_pend exclusive-lock no-error.
                    assign antecip_pef_pend.cod_usuar_pagto = movto_usuar_financ.cod_usuario.
                end.

                if avail item_lote_pagto then
                    assign item_lote_pagto.cod_usuar_pagto = movto_usuar_financ.cod_usuario.
            &endif

        end.

        /* -- Atualiza valor total de pagto feito pelo usu†rio no màs e o limite do valor que ainda pode usar --*/
        if  p_ind_tip_verific = "Confirm" /*l_confirm*/  then do:
            find movto_usuar_financ exclusive-lock use-index mvtsrfnn_id
                where movto_usuar_financ.cod_usuario = p_cod_usuar_corren
                and   movto_usuar_financ.cod_estab   = p_cod_estab_bord
                and   movto_usuar_financ.dat_movto_usuar_ap = p_dat_transacao no-error.

            if  not avail movto_usuar_financ then do:
                create movto_usuar_financ.
                assign movto_usuar_financ.cod_usuario             = p_cod_usuar_corren
                       movto_usuar_financ.cod_estab               = p_cod_estab_bord
                       movto_usuar_financ.dat_movto_usuar_ap      = p_dat_transacao
                       movto_usuar_financ.val_tot_liber_pagto_mes = 0
                       movto_usuar_financ.val_tot_pagto_mes       = 0
                       movto_usuar_financ.val_tot_pagto_pend_mes  = 0.
            end.

            assign movto_usuar_financ.val_tot_pagto_mes =
                   movto_usuar_financ.val_tot_pagto_mes + p_val_finalid_econ.
            if  movto_usuar_financ.val_tot_pagto_pend_mes > 0 then
                assign movto_usuar_financ.val_tot_pagto_pend_mes = movto_usuar_financ.val_tot_pagto_pend_mes - p_val_finalid_econ.
        end.
        find current movto_usuar_financ no-lock no-error.
    end.
END PROCEDURE. /* pi_atualizar_valor_usuar_apb */
/*****************************************************************************
** Procedure Interna.....: pi_retornar_indic_econ_corren_estab
** Descricao.............: pi_retornar_indic_econ_corren_estab
** Criado por............: vladimir
** Criado em.............: // 
** Alterado por..........: fut12234_2
** Alterado em...........: 06/09/2006 16:43:16
*****************************************************************************/
PROCEDURE pi_retornar_indic_econ_corren_estab:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_estab
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def Input param p_dat_transacao
        as date
        format "99/99/9999"
        no-undo.
    def output param p_cod_indic_econ
        as character
        format "x(8)"
        no-undo.


    /************************* Parameter Definition End *************************/

    find estabelecimento no-lock
         where estabelecimento.cod_estab = p_cod_estab
         use-index stblcmnt_id no-error.
    if  avail estabelecimento
    then do:
       find pais no-lock
            where pais.cod_pais = estabelecimento.cod_pais
             no-error.
       run pi_retornar_indic_econ_finalid 

             (Input pais.cod_finalid_econ_pais,
              Input p_dat_transacao,
              output p_cod_indic_econ) /* pi_retornar_indic_econ_finalid*/.
    end /* if */.

END PROCEDURE. /* pi_retornar_indic_econ_corren_estab */
/*****************************************************************************
** Procedure Interna.....: pi_sdo_cta_corren_spool_modulos
** Descricao.............: pi_sdo_cta_corren_spool_modulos
** Criado por............: dalpra
** Criado em.............: 20/07/1998 15:15:28
** Alterado por..........: fut40574_2
** Alterado em...........: 20/02/2008 10:21:54
*****************************************************************************/
PROCEDURE pi_sdo_cta_corren_spool_modulos:

    /************************* Variable Definition Begin ************************/

    def var v_log_param_utiliz_produt_val
        as logical
        format "Sim/N∆o"
        initial yes
        no-undo.


    /************************** Variable Definition End *************************/

    /* --- API para Atualizaá∆o dos Saldos das Contas Correntes SPOOL ---*/
    DO ON ERROR UNDO, RETURN ERROR:
    run prgfin/cmg/cmg709za.py (Input 1) /*prg_api_sdo_cta_corren_spool*/.

    if  return-value = '2782' then do:
        /* Vers∆o de integraá∆o incorreta ! */
        run pi_messages (input "show",
                         input 2782,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_2782*/.
        return error.
    end.

    run pi_monta_lista_modul_dtsul_empres /*pi_monta_lista_modul_dtsul_empres*/.

    run pi_verifica_utiliz_modulo (Input v_cod_empres_usuar,
                                   Input 'CFL',
                                   output v_log_param_utiliz_produt_val) /* pi_verifica_utiliz_modulo*/.
    if v_log_param_utiliz_produt_val = yes then
       run pi_sdo_fluxo_cx_spool_modulos /*pi_sdo_fluxo_cx_spool_modulos*/.
    END.
END PROCEDURE. /* pi_sdo_cta_corren_spool_modulos */
/*****************************************************************************
** Procedure Interna.....: pi_sdo_fluxo_cx_spool_modulos
** Descricao.............: pi_sdo_fluxo_cx_spool_modulos
** Criado por............: dalpra
** Criado em.............: 18/01/1999 13:50:37
** Alterado por..........: fut12197_2
** Alterado em...........: 15/06/2005 13:29:29
*****************************************************************************/
PROCEDURE pi_sdo_fluxo_cx_spool_modulos:

    /* --- API para Atualizaá∆o dos Saldos do Fluxo de Caixa SPOOL ---*/

    DO ON ERROR UNDO, RETURN ERROR:
    /* Manter esta alteraá∆o - Lista de Impacto gerada conforme alteraá∆o nos programas 
       ref. FO 1139356 */

    &if '{&emsfin_version}' >= "5.02" &then
        run prgfin/cfl/cfl704za.py (Input 1) /*prg_api_sdo_fluxo_cx_spool*/.
    &else
        run prgfin/cfl/cfl704zb.py (Input 1) /*prg_api_tab_livre_emsfin_spool_fluxo_cx*/.
    &endif

    if  return-value = '2782' then do:
        /* Vers∆o de integraá∆o incorreta ! */
        run pi_messages (input "show",
                         input 2782,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_2782*/.
        return error.
    end.

    END.
END PROCEDURE. /* pi_sdo_fluxo_cx_spool_modulos */
/*****************************************************************************
** Procedure Interna.....: pi_controlar_estab_apb
** Descricao.............: pi_controlar_estab_apb
** Criado por............: rafael
** Criado em.............: // 
** Alterado por..........: Vanei
** Alterado em...........: 09/05/1997 15:19:51
*****************************************************************************/
PROCEDURE pi_controlar_estab_apb:


    /* Begin_Include: i_controlar_estab_apb */
    find last param_geral_apb no-lock no-error.
    if  avail param_geral_apb
    then do:
        assign antecip_pef_pend.cod_estab:screen-value in frame f_adp_02_antecip_pef_pend = v_cod_estab_usuar.
        apply "leave" to antecip_pef_pend.cod_estab in frame f_adp_02_antecip_pef_pend.
        if  param_geral_apb.ind_control_estab = "Assumido Direto" /*l_assumido_direto*/ 
        then do:
            disable antecip_pef_pend.cod_estab
                    bt_zoo_66395
                    with frame f_adp_02_antecip_pef_pend.
        end /* if */.
        else do:
            enable antecip_pef_pend.cod_estab
                   bt_zoo_66395
                   with frame f_adp_02_antecip_pef_pend.
        end /* else */.
    end /* if */.
    else do:
        /* ParÉmetro Geral do Contas a Pagar Inexistente ! */
        run pi_messages (input "show",
                         input 700,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_700*/.
        enable antecip_pef_pend.cod_estab
               bt_zoo_66395
               with frame f_adp_02_antecip_pef_pend.
    end /* else */.
    /* End_Include: i_controlar_estab_apb */



END PROCEDURE. /* pi_controlar_estab_apb */
/*****************************************************************************
** Procedure Interna.....: pi_executar_abat_prev_provis_apb_antecip
** Descricao.............: pi_executar_abat_prev_provis_apb_antecip
** Criado por............: rafael
** Criado em.............: // 
** Alterado por..........: rafaelposse
** Alterado em...........: 04/08/2016 17:48:24
*****************************************************************************/
PROCEDURE pi_executar_abat_prev_provis_apb_antecip:

    /************************ Parameter Definition Begin ************************/

    def Input param p_ind_tip_abat
        as character
        format "X(08)"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_cdn_fornecedor
        as Integer
        format ">>>,>>>,>>9":U
        label "Fornecedor"
        column-label "Fornecedor"
        no-undo.
    def var v_cod_cta_ctbl
        as character
        format "x(20)":U
        label "Conta Cont†bil"
        column-label "Conta Cont†bil"
        no-undo.
    def var v_cod_empresa_uni
        as character
        format "x(3)":U
        label "Empresa"
        column-label "Empresa"
        no-undo.
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
    def var v_cod_estab_uni
        as character
        format "x(3)":U
        label "Est. Gera Lote Ènico"
        column-label "Estab"
        no-undo.
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
    def var v_cod_estab_uni
        as Character
        format "x(5)":U
        label "Est. Gera Lote Ènico"
        column-label "Estab"
        no-undo.
    &ENDIF
    def var v_cod_finalid_econ
        as character
        format "x(10)":U
        label "Finalidade Econìmica"
        column-label "Finalidade Econìmica"
        no-undo.
    def var v_cod_plano_cta_ctbl
        as character
        format "x(8)":U
        label "Plano Contas"
        column-label "Plano Contas"
        no-undo.
    def var v_cod_return
        as character
        format "x(40)":U
        no-undo.
    def var v_ind_control_ctbl
        as character
        format "X(18)":U
        view-as combo-box
        &if "{&FNC_MULTI_IDIOMA}" = "YES" &then
        list-item-pairs "Controla Todas FE","Controla Todas FE","Controla na FE","Controla na FE","Nao Controla","Nao Controla"
        &else
        list-items "Controla Todas FE","Controla na FE","Nao Controla"
        &endif
         /*l_controla_todas_fe*/ /*l_controla_na_fe*/ /*l_nao_controla*/
        inner-lines 4
        bgcolor 15 font 2
        label "Controle Cont†bil"
        column-label "Controle Cont†bil"
        no-undo.
    def var v_ind_finalid_ctbl_err
        as character
        format "X(30)":U
        label "Finalidade Cont†bil"
        column-label "Finalidade Cont†bil"
        no-undo.
    def var v_log_refer_uni
        as logical
        format "Sim/N∆o"
        initial yes
        no-undo.
    def var v_log_tit_ap_unico
        as logical
        format "Sim/N∆o"
        initial yes
        label "T°tulo Ènico"
        column-label "T°tulo Ènico"
        no-undo.
    def var v_num_pessoa
        as integer
        format ">>>,>>>,>>9":U
        label "Pessoa"
        column-label "Pessoa"
        no-undo.
    def var v_val_lim_liber_usuar_mes
        as decimal
        format "->>,>>>,>>>,>>9.99":U
        decimals 2
        label "Limite Màs"
        column-label "Limite Màs"
        no-undo.
    def var v_val_lim_liber_usuar_movto
        as decimal
        format "->>>,>>>,>>9.99":U
        decimals 2
        label "Limite Movimento"
        column-label "Limite Movimento"
        no-undo.
    def var v_val_lim_pagto_usuar_mes
        as decimal
        format "->>,>>>,>>>,>>9.99":U
        decimals 2
        label "Limite Màs"
        column-label "Limite Màs"
        no-undo.
    def var v_val_lim_pagto_usuar_movto
        as decimal
        format "->>>,>>>,>>9.99":U
        decimals 2
        label "Limite Movimento"
        column-label "Limite Movimento"
        no-undo.


    /************************** Variable Definition End *************************/

    assign input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_indic_econ
           input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_espec_docto
           input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_tit_ap
           input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_parcela
           input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_ser_docto 
           input frame f_adp_02_antecip_pef_pend antecip_pef_pend.val_tit_ap
           input frame f_adp_02_antecip_pef_pend antecip_pef_pend.dat_emis_docto
           input frame f_adp_02_antecip_pef_pend antecip_pef_pend.val_cotac_indic_econ
           input frame f_adp_02_antecip_pef_pend v_cod_fornec_infor
           antecip_pef_pend.cod_empresa = v_cod_empres_usuar_2.

    if not avail estabelecimento then
       find estabelecimento no-lock
            where estabelecimento.cod_estab = antecip_pef_pend.cod_estab no-error.

    run pi_acha_fornecedor_informado (output v_cdn_fornecedor,
                                      output v_num_pessoa) /*pi_acha_fornecedor_informado*/.
    assign antecip_pef_pend.cdn_fornecedor = v_cdn_fornecedor
           antecip_pef_pend.num_pessoa     = v_num_pessoa.

    def buffer bcx_stblcmnt_antcppfp for estabelecimento.
    if  not (can-find(first bcx_stblcmnt_antcppfp
                      where bcx_stblcmnt_antcppfp.cod_estab = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab)) then do:
        /* &1 inexistente ! */
        run pi_messages (input "show",
                         input 1284,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                           input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab)) /*msg_1284*/.
        return error.
    end.


    run pi_validar_estab (Input v_cod_empres_usuar_2,
                          Input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab,
                          Input frame f_adp_02_antecip_pef_pend antecip_pef_pend.dat_emis_docto,
                          output v_cod_return) /*pi_validar_estab*/.
    if  v_cod_return = "Unidade Organizacional" /*l_unid_organ*/ 
    then do:
        /* Estabelecimento n∆o habilitado como Unidade Organizacional ! */
        run pi_messages (input "show",
                         input 347,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_347*/.
        if  antecip_pef_pend.cod_estab:sensitive in frame f_adp_02_antecip_pef_pend = yes
        then do:
            assign v_wgh_focus = antecip_pef_pend.cod_estab:handle in frame f_adp_02_antecip_pef_pend.
        end /* if */.
        else do:
            assign v_wgh_focus = ?.
        end /* else */.
        return error.
    end /* if */.
    if  v_cod_return = "Empresa" /*l_empresa*/ 
    then do:
        /* Empresa do Estabelecimento Diferente da Empresa do Usu†rio ! */
        run pi_messages (input "show",
                         input 512,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_512*/.
        if  antecip_pef_pend.cod_estab:sensitive in frame f_adp_02_antecip_pef_pend = yes
        then do:
            assign v_wgh_focus = antecip_pef_pend.cod_estab:handle in frame f_adp_02_antecip_pef_pend.
        end /* if */.
        else do:
            assign v_wgh_focus = ?.
        end /* else */.
        return error.
    end /* if */.
    if  v_cod_return = "Usu†rio" /*l_usuario*/ 
    then do:
        /* Usu†rio sem permiss∆o para acessar o estabelecimento &1 ! */
        run pi_messages (input "show",
                         input 348,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_348*/.
        if  antecip_pef_pend.cod_estab:sensitive in frame f_adp_02_antecip_pef_pend = yes
        then do:
            assign v_wgh_focus = antecip_pef_pend.cod_estab:handle in frame f_adp_02_antecip_pef_pend.
        end /* if */.
        else do:
            assign v_wgh_focus = ?.
        end /* else */.
        return error.
    end /* if */.

    run pi_validar_usuar_estab_apb (Input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab,
                                    Input "Implantador" /*l_implantador*/,
                                    output v_cod_return,
                                    output v_val_lim_liber_usuar_movto,
                                    output v_val_lim_liber_usuar_mes,
                                    output v_val_lim_pagto_usuar_movto,
                                    output v_val_lim_pagto_usuar_mes) /*pi_validar_usuar_estab_apb*/.
    /* case_block: */
    case v_cod_return:
        when "no" /*l_no*/ then
            no_block:
            do:
                /* Usu†rio &1 n∆o possui permiss∆o para &2 ! */
                run pi_messages (input "show",
                                 input 701,
                                 input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                   v_cod_usuar_corren, "Implantar" /*l_implantar*/)) /*msg_701*/.
                if  antecip_pef_pend.cod_estab:sensitive in frame f_adp_02_antecip_pef_pend = yes
                then do:
                    assign v_wgh_focus = antecip_pef_pend.cod_estab:handle in frame f_adp_02_antecip_pef_pend.
                end /* if */.
                else do:
                    assign v_wgh_focus = ?.
                end /* else */.
                return error.
            end /* do no_block */.
        when "602" then
            602_block:
            do:
                /* Usu†rio Financeiro Inexistente ! */
                run pi_messages (input "show",
                                 input 602,
                                 input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_602*/.
                if  antecip_pef_pend.cod_estab:sensitive in frame f_adp_02_antecip_pef_pend = yes
                then do:
                    assign v_wgh_focus = antecip_pef_pend.cod_estab:handle in frame f_adp_02_antecip_pef_pend.
                end /* if */.
                else do:
                    assign v_wgh_focus = ?.
                end /* else */.
                return error.
            end /* do 602_block */.
    end /* case case_block */.

    /* Valida referencia unica */

    run pi_verifica_refer_unica_apb (Input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab,
                                     Input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_refer,
                                     Input "antecip_pef_pend" /*l_antecip_pef_pend*/,
                                     Input ?,
                                     output v_log_refer_uni) /*pi_verifica_refer_unica_apb*/.
    if  v_log_refer_uni = no
    then do:
        /* Referància deve ser £nica ! */
        run pi_messages (input "show",
                         input 742,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_742*/.
        assign v_wgh_focus = antecip_pef_pend.cod_refer:handle in frame f_adp_02_antecip_pef_pend.
        return error.
    end /* if */.

    /* Valida especie de documento */
    &if "{&emsuni_dbinst}" = "yes" &then
        def buffer bcx_espcdct_antcppfp for espec_docto.
        if  not ((antecip_pef_pend.cod_espec_docto = "") or
                  can-find(first bcx_espcdct_antcppfp
                          where bcx_espcdct_antcppfp.cod_espec_docto = antecip_pef_pend.cod_espec_docto
        )) then do:
            run pi_messages (input "show",
                             input 1284,
                             input "EspÇcie Documento~~EspÇcies Documento"). /*msg_1284*/
            return error.
        end
    &endif.
    &if "{&emsfin_dbinst}" = "yes" &then
        def buffer bcx_spcdctfa_antcppfp for espec_docto_financ.
        if  not ((antecip_pef_pend.cod_espec_docto = "") or
                  can-find(first bcx_spcdctfa_antcppfp
                          where bcx_spcdctfa_antcppfp.cod_espec_docto = antecip_pef_pend.cod_espec_docto
        )) then do:
            run pi_messages (input "show",
                             input 1284,
                             input "EspÇcie Docto Financeiro~~EspÇcies Docto Financeiro"). /*msg_1284*/
            return error.
        end
    &endif.

    find espec_docto no-lock
         where espec_docto.cod_espec_docto = antecip_pef_pend.cod_espec_docto
          no-error.
    if  espec_docto.ind_tip_espec_docto <> "Antecipaá∆o" /*l_antecipacao*/ 
    then do:
        /* EspÇcie de Documento deve ser do tipo Antecipaá∆o ! */
        run pi_messages (input "show",
                         input 985,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_985*/.
        assign v_wgh_focus = antecip_pef_pend.cod_espec_docto:handle in frame f_adp_02_antecip_pef_pend.
        return error.
    end /* if */.

    /* valida Fornecedor */
    &if "{&emsuni_dbinst}" = "yes" &then
        def buffer bcx_frncdr_antcppfp for fornecedor.
        if  not ((antecip_pef_pend.cod_empresa = "" or
                  antecip_pef_pend.cdn_fornecedor = 0) or
                  can-find(first bcx_frncdr_antcppfp
                          where bcx_frncdr_antcppfp.cdn_fornecedor = antecip_pef_pend.cdn_fornecedor
                            and bcx_frncdr_antcppfp.cod_empresa = antecip_pef_pend.cod_empresa
        )) then do:
            run pi_messages (input "show",
                             input 1284,
                             input "Fornecedor~~Fornecedores"). /*msg_1284*/
            return error.
        end
    &endif.
    &if "{&emsfin_dbinst}" = "yes" &then
        def buffer bcx_frncfnnc_antcppfp for fornec_financ.
        if  not ((antecip_pef_pend.cod_empresa = "" or
                  antecip_pef_pend.cdn_fornecedor = 0) or
                  can-find(first bcx_frncfnnc_antcppfp
                          where bcx_frncfnnc_antcppfp.cdn_fornecedor = antecip_pef_pend.cdn_fornecedor
                            and bcx_frncfnnc_antcppfp.cod_empresa = antecip_pef_pend.cod_empresa
        )) then do:
            run pi_messages (input "show",
                             input 1284,
                             input "Fornecedor Financeiro~~Fornecedores Financeiro"). /*msg_1284*/
            return error.
        end
    &endif.

    /* valida Indicador Econìmico */
    run pi_validar_indic_econ_movto (Input antecip_pef_pend.cod_indic_econ,
                                     Input antecip_pef_pend.dat_emis_docto,
                                     Input antecip_pef_pend.cod_empresa,
                                     output v_cod_return) /*pi_validar_indic_econ_movto*/.
    if  v_cod_return <> "OK" /*l_ok*/ 
    then do:
        /* error_block: */
        case entry(1, v_cod_return):
            when "335" then
                /* Indicador Econìmico Inexistente ! */
                run pi_messages (input "show",
                                 input 335,
                                 input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_335*/.
            when "336" then
                /* Hist¢rico Finalidade inexistente para o indicador econìmico ! */
                run pi_messages (input "show",
                                 input 336,
                                 input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_336*/.
            when "337" then
                /* Finalidade econìmica n∆o permite informar valores ! */
                run pi_messages (input "show",
                                 input 337,
                                 input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                    entry(2, v_cod_return))) /*msg_337*/.
            when "338" then
                /* Finalidade n∆o liberada para a Unidade Organizacional ! */
                run pi_messages (input "show",
                                 input 338,
                                 input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_338*/.
        end /* case error_block */.

        assign v_wgh_focus = antecip_pef_pend.cod_indic_econ:handle in frame f_adp_02_antecip_pef_pend.
        return error.
    end /* if */.

    /* valida Contas do Grupo de Fornecedor */
    find fornecedor no-lock
         where fornecedor.cdn_fornecedor = antecip_pef_pend.cdn_fornecedor
           and fornecedor.cod_empresa = antecip_pef_pend.cod_empresa
          no-error.

    run pi_verifica_ctas_grp_fornec (Input antecip_pef_pend.cod_empresa,
                                     Input antecip_pef_pend.cod_espec_docto,
                                     Input "Antecipaá∆o" /*l_antecipacao*/,
                                     Input fornecedor.cod_grp_fornec,
                                     Input "Saldo" /*l_saldo*/,
                                     Input antecip_pef_pend.cod_indic_econ,
                                     Input antecip_pef_pend.dat_emis_docto,
                                     output v_cod_finalid_econ,
                                     output v_ind_finalid_ctbl_err,
                                     output v_cod_plano_cta_ctbl,
                                     output v_cod_cta_ctbl,
                                     output v_ind_control_ctbl) /*pi_verifica_ctas_grp_fornec*/.
    if  return-value = "NOK" /*l_nok*/ 
    then do:
        /* Conta &1 inexistente para &2, &3, &4, &5, &6 ! */
        run pi_messages (input "show",
                         input 755,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                            "Saldo" /*l_saldo*/ ,                     v_cod_empres_usuar_2,                     antecip_pef_pend.cod_espec_docto,                     fornecedor.cod_grp_fornec,                     v_cod_finalid_econ,                     antecip_pef_pend.dat_emis_docto)) /*msg_755*/.
        assign v_wgh_focus = v_cod_fornec_infor:handle in frame f_adp_02_antecip_pef_pend.
        return error.
    end /* if */.

    /* valida Documento Ènico */
    run pi_verifica_tit_unico_apb (Input antecip_pef_pend.num_pessoa,
                                   Input antecip_pef_pend.cod_espec_docto,
                                   Input antecip_pef_pend.cod_ser_docto,
                                   Input antecip_pef_pend.cod_tit_ap,
                                   Input antecip_pef_pend.cod_parcela,
                                   Input ?,
                                   Input recid(antecip_pef_pend),
                                   Input ?,
                                   Input ?,
                                   output v_log_tit_ap_unico,
                                   output v_cod_empresa_uni,
                                   output v_cod_estab_uni,
                                   output v_des_movimento) /*pi_verifica_tit_unico_apb*/.

    if  v_log_tit_ap_unico = no
    then do:
        /* Ocorrància j† existente no Contas a Pagar ! */
        run pi_messages (input "show",
                         input 754,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                            v_cod_estab_uni, antecip_pef_pend.cdn_fornec, antecip_pef_pend.cod_espec_docto, antecip_pef_pend.cod_ser_docto, antecip_pef_pend.cod_tit_ap, antecip_pef_pend.cod_parcela, v_des_movimento)) /*msg_754*/.
        assign v_wgh_focus = antecip_pef_pend.cod_tit_ap:handle in frame f_adp_02_antecip_pef_pend.
        return error.
    end /* if */.

    assign antecip_pef_pend.cod_estab:sensitive in frame f_adp_02_antecip_pef_pend = no
           antecip_pef_pend.cod_refer:sensitive in frame f_adp_02_antecip_pef_pend = no.

    if  search("prgfin/apb/apb737za.r") = ? and search("prgfin/apb/apb737za.p") = ? then do:
        if  v_cod_dwb_user begins 'es_' then
            return "Programa execut†vel n∆o foi encontrado:" /*l_programa_nao_encontrado*/  + "prgfin/apb/apb737za.p".
        else do:
            message getStrTrans("Programa execut†vel n∆o foi encontrado:", "APB") /*l_programa_nao_encontrado*/  "prgfin/apb/apb737za.p"
                   view-as alert-box error buttons ok.
            return.
        end.
    end.
    else
        run prgfin/apb/apb737za.p (Input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab,
                               Input antecip_pef_pend.cod_refer,
                               Input 0,
                               Input p_ind_tip_abat,
                               Input v_num_pessoa,
                               Input antecip_pef_pend.dat_emis_docto,
                               Input antecip_pef_pend.cod_indic_econ,
                               Input antecip_pef_pend.cod_indic_econ,
                               Input antecip_pef_pend.cod_seguradora,
                               Input antecip_pef_pend.cod_apol_segur,
                               Input antecip_pef_pend.cod_arrendador,
                               Input antecip_pef_pend.cod_contrat_leas,
                               Input antecip_pef_pend.val_tit_ap,
                               Input "",
                               Input 0,
                               Input yes) /*prg_fnc_abat_prev_provis_ap*/.
END PROCEDURE. /* pi_executar_abat_prev_provis_apb_antecip */
/*****************************************************************************
** Procedure Interna.....: pi_acha_estab_apb
** Descricao.............: pi_acha_estab_apb
** Criado por............: Ganzen
** Criado em.............: 09/02/1996 10:11:11
** Alterado por..........: Ganzen
** Alterado em...........: 09/02/1996 10:13:26
*****************************************************************************/
PROCEDURE pi_acha_estab_apb:

    /************************* Variable Definition Begin ************************/

    def var v_cdn_estab
        as Integer
        format ">>9":U
        label "N£mero Estabelec"
        column-label "N£mero Estab"
        no-undo.


    /************************** Variable Definition End *************************/

    find estabelecimento no-lock
         where estabelecimento.cod_estab = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab
    &if "{&emsuni_version}" >= "5.01" &then
         use-index stblcmnt_id
    &endif
          /*cl_frame of estabelecimento*/ no-error.
    if  not avail estabelecimento
    then do:
        run pi_converter_para_inteiro (Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab,
                                       output v_cdn_estab) /*pi_converter_para_inteiro*/.
        if  v_cdn_estab <> 0
        then do:
            find estabelecimento no-lock
                 where estabelecimento.cdn_estab = v_cdn_estab /*cl_cdn_estab of estabelecimento*/ no-error.
            if  avail estabelecimento
            then do:
                assign antecip_pef_pend.cod_estab:screen-value in frame f_adp_02_antecip_pef_pend = estabelecimento.cod_estab.
            end /* if */.
        end /* if */.
    end /* if */.
    display estabelecimento.nom_pessoa when avail estabelecimento
            "" when not avail estabelecimento @ estabelecimento.nom_pessoa
            with frame f_adp_02_antecip_pef_pend.
END PROCEDURE. /* pi_acha_estab_apb */
/*****************************************************************************
** Procedure Interna.....: pi_converter_para_inteiro
** Descricao.............: pi_converter_para_inteiro
** Criado por............: vanei
** Criado em.............: 24/11/1995 14:34:38
** Alterado por..........: fut1236
** Alterado em...........: 23/06/2005 15:25:06
*****************************************************************************/
PROCEDURE pi_converter_para_inteiro:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_initial
        as character
        format "x(8)"
        no-undo.
    def output param p_num_return
        as integer
        format ">>>>,>>9"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_cod_count                      as character       no-undo. /*local*/
    def var v_num_count                      as integer         no-undo. /*local*/


    /************************** Variable Definition End *************************/

    assign p_num_return = 0.
    if  p_cod_initial = ""
    then do:
        return.
    end /* if */.

    verifica_block:
    do v_num_count = 1 to length(p_cod_initial):
        assign v_cod_count = substring(p_cod_initial, v_num_count, 1).
        if  index("0123456789", v_cod_count) = 0
        then do:
            return.
        end /* if */.
    end /* do verifica_block */.
    /* * PI Alterada sob demanda n∆o retirar o "no-error" * **/
    assign p_num_return = integer(p_cod_initial) no-error.
END PROCEDURE. /* pi_converter_para_inteiro */
/*****************************************************************************
** Procedure Interna.....: pi_retornar_favorec_cheque
** Descricao.............: pi_retornar_favorec_cheque
** Criado por............: 
** Criado em.............: // 
** Alterado por..........: Roberto
** Alterado em...........: 09/06/1998 11:31:01
*****************************************************************************/
PROCEDURE pi_retornar_favorec_cheque:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_estab
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def Input param p_cod_portador
        as character
        format "x(5)"
        no-undo.
    def Input param p_cod_finalid_econ
        as character
        format "x(10)"
        no-undo.
    def Input param p_cod_cta_corren
        as character
        format "x(10)"
        no-undo.
    def Input param p_num_talon_cheq
        as integer
        format ">>>,>>>,>>9"
        no-undo.
    def Input param p_num_cheque
        as integer
        format ">>>>,>>>,>>9"
        no-undo.
    def output param p_log_cheq_ap_existen
        as logical
        format "Sim/N∆o"
        no-undo.
    def output param p_ind_favorec_cheq
        as character
        format "X(15)"
        no-undo.
    def output param p_nom_favorec_cheq
        as character
        format "x(40)"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************** Buffer Definition Begin *************************/

    &if "{&emsuni_version}" >= "5.01" &then
    def buffer b_cheque
        for cheque.
    &endif
    &if "{&emsfin_version}" >= "5.01" &then
    def buffer b_item_lote_pagto
        for item_lote_pagto.
    &endif
    &if "{&emsfin_version}" >= "5.01" &then
    def buffer b_portad_finalid_econ
        for portad_finalid_econ.
    &endif


    /*************************** Buffer Definition End **************************/

    if p_num_cheque <> 0 then do:
        find b_cheque no-lock
             where b_cheque.cod_cta_corren = p_cod_cta_corren
               and b_cheque.num_talon_cheq = p_num_talon_cheq
               and b_cheque.num_cheque     = p_num_cheque
             use-index cheque_id
              no-error.
        if  not avail b_cheque
        then do:
            assign p_log_cheq_ap_existen = no
                   p_ind_favorec_cheq    = ""
                   p_nom_favorec_cheq    = "".

            item_block:
            for each b_portad_finalid_econ no-lock
                where b_portad_finalid_econ.cod_cta_corren   = p_cod_cta_corren
                and   b_portad_finalid_econ.cod_finalid_econ = p_cod_finalid_econ
                use-index prtdfnld_cta_corren:


                /* Begin_Include: i_tratar_cheq_ap_via_tabela_livre */
                if  "Procurar" /* l_procurar*/ = "Incluir" /*l_incluir*/  then do:
                    create tab_livre_emsfin.
                    assign tab_livre_emsfin.cod_modul_dtsul      = "APB" /*l_apb*/ 
                           tab_livre_emsfin.cod_tab_dic_dtsul    = "Item do Lote de Pagamento"
                           tab_livre_emsfin.cod_compon_1_idx_tab = b_portad_finalid_econ.cod_cta_corren + "," + string( p_num_talon_cheq ) + "," + string( p_num_cheque )
                           tab_livre_emsfin.cod_compon_2_idx_tab = "" + "," + "" + "," + string( 0 ).
                end.

                if  "Procurar" /* l_procurar*/ = "Procurar" /*l_procurar*/  then do:
                    find first tab_livre_emsfin no-lock
                         where tab_livre_emsfin.cod_modul_dtsul      = "APB" /*l_apb*/ 
                           and tab_livre_emsfin.cod_tab_dic_dtsul    = "Item do Lote de Pagamento"
                           and tab_livre_emsfin.cod_compon_1_idx_tab = b_portad_finalid_econ.cod_cta_corren + "," + string( p_num_talon_cheq ) + "," + string( p_num_cheque )
                         no-error.
                    if  avail tab_livre_emsfin then do:
                        find b_item_lote_pagto no-lock
                             where b_item_lote_pagto.cod_estab_refer = entry( 1, tab_livre_emsfin.cod_compon_2_idx_tab, "," )
                               and b_item_lote_pagto.cod_refer       = entry( 2, tab_livre_emsfin.cod_compon_2_idx_tab, "," )
                               and b_item_lote_pagto.num_seq_refer   = integer( entry( 3, tab_livre_emsfin.cod_compon_2_idx_tab, "," ) )
                               and recid( b_item_lote_pagto )       <> ?
                             no-error.
                        if  not avail b_item_lote_pagto then do:
                            find next tab_livre_emsfin no-lock
                                 where tab_livre_emsfin.cod_modul_dtsul      = "APB" /*l_apb*/ 
                                   and tab_livre_emsfin.cod_tab_dic_dtsul    = "Item do Lote de Pagamento"
                                   and tab_livre_emsfin.cod_compon_1_idx_tab = b_portad_finalid_econ.cod_cta_corren + "," + string( p_num_talon_cheq ) + "," + string( p_num_cheque )
                                  no-error.
                            if  avail tab_livre_emsfin then do:
                                find b_item_lote_pagto no-lock
                                     where b_item_lote_pagto.cod_estab_refer = entry( 1, tab_livre_emsfin.cod_compon_2_idx_tab, "," )
                                       and b_item_lote_pagto.cod_refer       = entry( 2, tab_livre_emsfin.cod_compon_2_idx_tab, "," )
                                       and b_item_lote_pagto.num_seq_refer   = integer( entry( 3, tab_livre_emsfin.cod_compon_2_idx_tab, "," ) )
                                  no-error.
                            end.
                        end.
                    end.
                    else do:
                        if  avail b_item_lote_pagto then do:
                            release b_item_lote_pagto.
                        end.
                    end.
                end.

                if  "Procurar" /* l_procurar*/ = "Pr¢ximo" /*l_proximo*/  then do:
                    find next  tab_livre_emsfin no-lock
                         where tab_livre_emsfin.cod_modul_dtsul      = "APB" /*l_apb*/ 
                           and tab_livre_emsfin.cod_tab_dic_dtsul    = "Item do Lote de Pagamento"
                           and tab_livre_emsfin.cod_compon_1_idx_tab = b_portad_finalid_econ.cod_cta_corren + "," + string( p_num_talon_cheq ) + "," + string( p_num_cheque )
                          no-error.
                    if  avail tab_livre_emsfin then do:
                        find b_item_lote_pagto no-lock
                             where b_item_lote_pagto.cod_estab_refer = entry( 1, tab_livre_emsfin.cod_compon_2_idx_tab, "," )
                               and b_item_lote_pagto.cod_refer       = entry( 2, tab_livre_emsfin.cod_compon_2_idx_tab, "," )
                               and b_item_lote_pagto.num_seq_refer   = integer( entry( 3, tab_livre_emsfin.cod_compon_2_idx_tab, "," ) )
                             no-error.
                    end.
                    else do:
                        if  avail b_item_lote_pagto then do:
                            release b_item_lote_pagto.
                        end.
                    end.
                end.

                if  "Procurar" /* l_procurar*/ = "Excluir" /*l_excluir*/  then do:
                    find tab_livre_emsfin exclusive-lock
                        where tab_livre_emsfin.cod_modul_dtsul      = "APB" /*l_apb*/ 
                          and tab_livre_emsfin.cod_tab_dic_dtsul    = "Item do Lote de Pagamento"
                          and tab_livre_emsfin.cod_compon_1_idx_tab = b_portad_finalid_econ.cod_cta_corren + "," + string( p_num_talon_cheq ) + "," + string( p_num_cheque )
                          and tab_livre_emsfin.cod_compon_2_idx_tab = "" + "," + "" + "," + string( 0 )
                        no-error.
                    if  avail tab_livre_emsfin then do:
                        delete tab_livre_emsfin.
                    end.
                end.
                /* End_Include: i_tratar_cheq_ap_via_tabela_livre */


    /* find first b_item_lote_pagto no-lock 
                    where b_item_lote_pagto.cod_estab_refer  = b_portad_finalid_econ.cod_estab
                      and b_item_lote_pagto.cod_portador     = b_portad_finalid_econ.cod_portador
                      and b_item_lote_pagto.cod_cart_bcia    = b_portad_finalid_econ.cod_cart_bcia
                      and b_item_lote_pagto.cod_finalid_econ = b_portad_finalid_econ.cod_finalid_econ
                      and b_item_lote_pagto.num_talon_cheq   = p_num_talon_cheq
                      and b_item_lote_pagto.num_cheque       = p_num_cheque use-index itmltpgt_portad_finalid_econ
                    no-error.
    */
                if  avail b_item_lote_pagto then do:
                    assign p_log_cheq_ap_existen = yes
                           p_ind_favorec_cheq    = b_item_lote_pagto.ind_favorec_cheq
                           p_nom_favorec_cheq    = b_item_lote_pagto.nom_favorec_cheq.
                    leave item_block.
                end.
            end.
        end /* if */.
        else do:
            assign p_log_cheq_ap_existen = yes
                   p_ind_favorec_cheq    = b_cheque.ind_favorec_cheq
                   p_nom_favorec_cheq    = b_cheque.nom_favorec_cheq.
        end /* else */.
    end.
    else do:
        assign p_log_cheq_ap_existen = no
               p_ind_favorec_cheq    = ""
               p_nom_favorec_cheq    = "".
    end.
END PROCEDURE. /* pi_retornar_favorec_cheque */
/*****************************************************************************
** Procedure Interna.....: pi_verificar_impto_taxado
** Descricao.............: pi_verificar_impto_taxado
** Criado por............: rafael
** Criado em.............: // 
** Alterado por..........: fut36242_2
** Alterado em...........: 01/02/2006 16:00:03
*****************************************************************************/
PROCEDURE pi_verificar_impto_taxado:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_estab
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def Input param p_dat_transacao
        as date
        format "99/99/9999"
        no-undo.
    def output param p_log_impto_taxado
        as logical
        format "Sim/N∆o"
        no-undo.


    /************************* Parameter Definition End *************************/

    assign p_log_impto_taxado = no.

    find estabelecimento no-lock
         where estabelecimento.cod_estab = p_cod_estab
          no-error.

    if  avail estabelecimento
    then do:
        find pessoa_jurid no-lock
             where pessoa_jurid.num_pessoa_jurid = estabelecimento.num_pessoa_jurid
             no-error.


        verifica_impostos:
        for
            each histor_impto_empres no-lock
            where histor_impto_empres.cod_empresa = estabelecimento.cod_empresa
            and   histor_impto_empres.cod_pais    = pessoa_jurid.cod_pais
            and   histor_impto_empres.dat_inic_valid <= p_dat_transacao
            and   histor_impto_empres.dat_fim_valid  >  p_dat_transacao:

            if  histor_impto_empres.cod_unid_federac <> ""
            and histor_impto_empres.cod_unid_federac <> ?
            and histor_impto_empres.cod_unid_federac <> pessoa_jurid.cod_unid_federac
            then do:
                next verifica_impostos.
            end /* if */.

            find first imposto no-lock
                where imposto.cod_pais         = histor_impto_empres.cod_pais
                and   imposto.cod_unid_federac = histor_impto_empres.cod_unid_federac
                and   imposto.cod_imposto      = histor_impto_empres.cod_imposto no-error.

            if not avail imposto THEN
                next verifica_impostos.

            if  avail imposto
            and imposto.ind_clas_impto <> "Taxado" /*l_taxado*/ 
            then do:
                next verifica_impostos.
            end /* if */.
            else do:
                assign p_log_impto_taxado = yes.
                leave verifica_impostos.
            end /* else */.
        end /* for verifica_impostos */.
    end /* if */.

END PROCEDURE. /* pi_verificar_impto_taxado */
/*****************************************************************************
** Procedure Interna.....: pi_criticar_geracao_antecip_pef
** Descricao.............: pi_criticar_geracao_antecip_pef
** Criado por............: Roberto
** Criado em.............: 05/02/1997 18:03:59
** Alterado por..........: fut41061
** Alterado em...........: 08/07/2014 10:15:26
*****************************************************************************/
PROCEDURE pi_criticar_geracao_antecip_pef:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_estab
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def Input param p_cod_refer_antecip_pef
        as character
        format "x(10)"
        no-undo.
    def Input param p_cod_refer
        as character
        format "x(10)"
        no-undo.
    def Input param p_cod_portador
        as character
        format "x(5)"
        no-undo.
    def Input param p_num_bord_ap
        as integer
        format ">>>>>9"
        no-undo.
    def Input param p_num_seq
        as integer
        format ">>>,>>9"
        no-undo.
    def Input param p_ind_modo_pagto
        as character
        format "X(10)"
        no-undo.
    def Input param p_cod_estab_pagto
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_cod_cta_corren_aux
        as character
        format "x(20)":U
        label "Conta Corrente"
        column-label "Conta Corrente"
        no-undo.
    def var v_cod_finalid_econ
        as character
        format "x(10)":U
        label "Finalidade Econìmica"
        column-label "Finalidade Econìmica"
        no-undo.
    def var v_cod_portador
        as character
        format "x(5)":U
        label "Portador"
        column-label "Portador"
        no-undo.
    def var v_cod_return
        as character
        format "x(40)":U
        no-undo.
    def var v_ind_finalid_ctbl
        as character
        format "X(30)":U
        label "Finalidade Cont†bil"
        column-label "Finalidade Cont†bil"
        no-undo.
    def var v_log_func_dat_inic_movto_cmg
        as logical
        format "Sim/N∆o"
        initial no
        no-undo.
    def var v_log_impto_vincul_refer
        as logical
        format "Sim/N∆o"
        initial yes
        no-undo.
    def var v_val_tot_impto
        as decimal
        format "->>>,>>>,>>9.99":U
        decimals 2
        label "Total a Ratear"
        column-label "Valor Total a Ratear"
        no-undo.
    def var v_ind_modo_aux                   as character       no-undo. /*local*/


    /************************** Variable Definition End *************************/

    /* * Valida a geraá∆o de antecipaá‰es e pagamentos extra fornecedores apartir de quatro
        cituaá‰es diferentes:
        1 - Implantaá∆o de AN/PEF com portador tipo "Caixa" por usu†rios que podem pagar;
        2 - Lote de Pagamento, para pagamentos em dinheiro;
        3 - Confirmaá∆o de Cheque e
        4 - Confirmaá∆o de Borderì.
        A vari†vel "v_dat_confir_bxa_tit_ap" Ç preparada na chamada desta PI, e pode ser a
        data de Emiss∆o da Antecipaá∆o, da Transaá∆o do Lote ou de confirmaá∆o dos Cheques
        ou Itens do Borderì.
    **************************************************************************************/
    assign v_log_impto_vincul_refer = no.
    find antecip_pef_pend no-lock
        where antecip_pef_pend.cod_estab = p_cod_estab
        and   antecip_pef_pend.cod_refer = p_cod_refer_antecip_pef no-error.
    if  avail antecip_pef_pend
    then do:

        /* A vari†vel v_cod_indic_econ_antecip foi preparada para o caso da antecipaá∆o
        ser paga em outra moeda e se a funá∆o estiver liberada - Barth */
        if v_log_pagto_ant_outras_moed = yes 
        and antecip_pef_pend.ind_tip_refer = "Antecipaá∆o" /*l_antecipacao*/  then do:
            if avail item_lote_pagto then
                assign v_cod_indic_econ_antecip = item_lote_pagto.cod_indic_econ.
            if avail item_bord_ap 
            and avail bord_ap then
                assign v_cod_indic_econ_antecip = bord_ap.cod_indic_econ.
            if not avail item_lote_pagto
            and not avail item_bord_ap then
                assign v_cod_indic_econ_antecip = antecip_pef_pend.cod_indic_econ.
        end.
        else
             assign v_cod_indic_econ_antecip = antecip_pef_pend.cod_indic_econ.

        run pi_retornar_finalid_indic_econ (Input v_cod_indic_econ_antecip,
                                            Input v_dat_confir_bxa_tit_ap,
                                            output v_cod_finalid_econ_antecip) /*pi_retornar_finalid_indic_econ*/.
    /* --- Verifica se o modo de pagamento est† vinculdo a um Tipo de Transaá∆o
          Caixa, para integraá∆o com o CMG. ---*/

        if  (p_ind_modo_pagto = ""
        and antecip_pef_pend.cod_estab_portad_mutuo <> "")
        or  p_ind_modo_pagto <> "" then do:

            if  antecip_pef_pend.cod_estab_portad_mutuo <> "" then
                assign v_ind_modo_aux = "M£tuo" /*l_mutuo*/ .
            else do:
                if  p_ind_modo_pagto <> "" then
                    assign v_ind_modo_aux = p_ind_modo_pagto.    
                else
                    assign v_ind_modo_aux = "M£tuo" /*l_mutuo*/ .
            end.


            /* Begin_Include: i_retorna_funcao_dat_inic_valid_movto_cta_corren_hab */
            assign v_log_func_dat_inic_movto_cmg = no.

            &if '{&emsfin_version}' >= '5.02' &then
                &if defined(BF_FIN_DAT_INIC_MOVTO_CTA_CORREN) &then
                    assign v_log_func_dat_inic_movto_cmg = yes.
                &else
                    find histor_exec_especial no-lock
                        where histor_exec_especial.cod_modul_dtsul = 'CMG'
                          and histor_exec_especial.cod_prog_dtsul = "FNC_DAT_INIC_MOVTO_CTA_CORREN" /*L_FNC_DAT_INIC_MOVTO_CTA_CORREN*/ 
                        no-error.
                    if  avail histor_exec_especial then do:
                        assign v_log_func_dat_inic_movto_cmg = yes.
                    end.

                    /* Begin_Include: i_funcao_extract */
                    if  v_cod_arq <> '' and v_cod_arq <> ?
                    then do:

                        output stream s-arq to value(v_cod_arq) append.

                        put stream s-arq unformatted
                            "FNC_DAT_INIC_MOVTO_CTA_CORREN" /* L_FNC_DAT_INIC_MOVTO_CTA_CORREN*/      at 1 
                            v_log_func_dat_inic_movto_cmg  at 43 skip.

                        output stream s-arq close.

                    end /* if */.
                    /* End_Include: i_funcao_extract */

                &endif
            &endif
            /* End_Include: i_funcao_extract */


            if  v_log_func_dat_inic_movto_cmg = no then do:
                find portad_finalid_econ no-lock
                     where portad_finalid_econ.cod_estab        = p_cod_estab_pagto
                       and portad_finalid_econ.cod_portador     = p_cod_portador
                       and portad_finalid_econ.cod_cart_bcia    = antecip_pef_pend.cod_cart_bcia
                       and portad_finalid_econ.cod_finalid_econ = v_cod_finalid_econ_antecip no-error.
                if  avail portad_finalid_econ then
                    assign v_cod_cta_corren_aux = portad_finalid_econ.cod_cta_corren.
                else
                    assign v_cod_cta_corren_aux = "" /*l_null*/ .
                run prgfin/cmg/cmg723za.py (Input 1,
                                            Input "APB" /*l_apb*/,
                                            Input v_ind_modo_aux,
                                            Input "RE" /*l_re*/,
                                            Input antecip_pef_pend.cod_empresa,
                                            Input v_dat_confir_bxa_tit_ap,
                                            Input antecip_pef_pend.cod_estab,
                                            output v_cod_return,
                                            Input v_cod_cta_corren_aux) /*prg_api_validar_tip_trans_cx_cmg*/.
            end.
            else do:
                find portad_finalid_econ no-lock
                    where portad_finalid_econ.cod_estab        = p_cod_estab_pagto
                      and portad_finalid_econ.cod_portador     = p_cod_portador
                      and portad_finalid_econ.cod_cart_bcia    = antecip_pef_pend.cod_cart_bcia
                      and portad_finalid_econ.cod_finalid_econ = v_cod_finalid_econ_antecip
                    no-error.
                if  avail portad_finalid_econ then do:
                    assign v_cod_cta_corren = portad_finalid_econ.cod_cta_corren.
                end.
                else do:
                    assign v_cod_cta_corren = "".
                end.

                /* se nao foi informado portador na implantacao da AN nao consiste CMG*/
                if p_cod_portador   <> "" then            
                    run prgfin/cmg/cmg723zb.py (Input 1,
                                                Input "APB" /*l_apb*/,
                                                Input v_ind_modo_aux,
                                                Input "RE" /*l_re*/,
                                                Input antecip_pef_pend.cod_empresa,
                                                Input v_dat_confir_bxa_tit_ap,
                                                Input antecip_pef_pend.cod_estab,
                                                Input v_cod_cta_corren,
                                                output v_cod_return) /*prg_api_validar_integracao_cmg*/.
                else
                    assign v_cod_return = "OK" /*l_ok*/ .
            end.
            if  v_cod_return <> "OK" /*l_ok*/ 
            then do:

                run pi_messages (input "Msg" /*l_msg*/ ,
                                 input int(entry(1,v_cod_return)),
                                 input substitute("&1~&2~&3~&4~&5~&6~&7~&8~&9")).

                assign v_des_msg_erro_1 = substitute(return-value, 
                                          entry(2,v_cod_return), entry(3,v_cod_return) ,
                                          entry(4,v_cod_return), entry(5,v_cod_return) ,
                                          entry(6,v_cod_return), entry(7,v_cod_return) ,
                                          entry(8,v_cod_return), entry(9,v_cod_return) ,
                                          entry(10,v_cod_return)).

                run pi_verifica_msg_erro (Input antecip_pef_pend.cod_estab,
                                          Input antecip_pef_pend.cod_espec_docto,
                                          Input antecip_pef_pend.cod_ser_docto,
                                          Input antecip_pef_pend.cdn_fornecedor,
                                          Input antecip_pef_pend.cod_tit_ap,
                                          Input antecip_pef_pend.cod_parcela,
                                          Input p_cod_refer,
                                          Input v_des_msg_erro_1,
                                          Input antecip_pef_pend.cod_estab,
                                          Input p_num_seq) /*pi_verifica_msg_erro*/.
                if int(entry(1,v_cod_return)) = 13114
                then do:

                    assign tt_log_erros_tit_antecip.ttv_des_msg_erro_1   = '13114' + tt_log_erros_tit_antecip.ttv_des_msg_erro_1.
                    if avail cheq_ap then
                        assign tt_log_erros_tit_antecip.tta_cod_portador     = cheq_ap.cod_portador
                               tt_log_erros_tit_antecip.tta_cod_finalid_econ = cheq_ap.cod_finalid_econ
                               tt_log_erros_tit_antecip.tta_dat_emis_cheq    = cheq_ap.dat_emis_cheq
                               tt_log_erros_tit_antecip.tta_nom_favorec_cheq = cheq_ap.nom_favorec_cheq
                               tt_log_erros_tit_antecip.ttv_cod_seq_cheq     = string(cheq_ap.num_seq_cheq).
                   else
                       assign v_log_erro_valid = no.    
                end.
                else
                    assign v_log_erro_valid = no.
            end /* if */.
        end /* if */.

        find first espec_docto_financ no-lock
            where espec_docto_financ.cod_espec_docto = antecip_pef_pend.cod_espec_docto no-error.
        if  avail espec_docto_financ 
        and espec_docto_financ.log_atualiz_fluxo_cx = yes then do:
            /* * Valida param_geral_cfl e Cotacao para integraáao com o FLUXO DE CAIXA **/
            if  search("prgfin/cfl/cfl706za.r") = ? and search("prgfin/cfl/cfl706za.py") = ? then do:
                if  v_cod_dwb_user begins 'es_' then
                    return "Programa execut†vel n∆o foi encontrado:" /*l_programa_nao_encontrado*/  + "prgfin/cfl/cfl706za.py".
                else do:
                    message getStrTrans("Programa execut†vel n∆o foi encontrado:", "APB") /*l_programa_nao_encontrado*/  "prgfin/cfl/cfl706za.py"
                           view-as alert-box error buttons ok.
                    stop.
                end.
            end.
            else
                run prgfin/cfl/cfl706za.py (Input 1,
                                        Input "APB" /*l_apb*/,
                                        Input antecip_pef_pend.cod_empresa,
                                        Input v_cod_indic_econ_antecip,
                                        Input v_dat_confir_bxa_tit_ap,
                                        output v_cod_return,
                                        Input "RE" /*l_re*/) /*prg_api_criticar_fluxo_cx*/.  

            if  v_cod_return <> "OK" /*l_ok*/  then do:
                if  entry(1,v_cod_return) = '2782' then do:
                    assign v_des_msg_erro_1 = substitute(getStrTrans("Vers∆o de integraá∆o incorreta !", "APB") /*2782*/).
                end.
                else do:
                    if  entry(1,v_cod_return) = '4686' then do:
                        assign v_des_msg_erro_1 = substitute(getStrTrans("ParÉmetros Gerais do Fluxo de Caixa n∆o encontrado !", "APB") /*4686*/).
                    end.
                    else do:
                        if  entry(1,v_cod_return) = '4818' then do:
                            assign v_des_msg_erro_1 = substitute(getStrTrans("ParÉmetro de Integraá∆o do Fluxo de Caixa inexistente !", "APB") /*4818*/).
                        end.
                        else do:
                            if  entry(1,v_cod_return) = '358' then do:
                                assign v_des_msg_erro_1 = substitute(getStrTrans("Verifique se existe cotaá∆o do tipo &4 , entre os Indicadores Econìmicos &1 e &2, em &3.", "APB") /*358*/,(entry(2,v_cod_return)),
                                                                                       (entry(3,v_cod_return)),
                                                                                       (entry(4,v_cod_return)),
                                                                                       (entry(5,v_cod_return))).
                            end.
                            else do:
                                assign v_des_msg_erro_1 = substitute(getStrTrans("A data &1 est† fora do per°odo de validade dos ParÉmetros Gerais do Fluxo de Caixa.", "APB") /*5134*/,(entry(2,v_cod_return))).
                            end.
                        end.
                    end.
                end.    
                run pi_verifica_msg_erro (Input antecip_pef_pend.cod_estab,
                                          Input antecip_pef_pend.cod_espec_docto,
                                          Input antecip_pef_pend.cod_ser_docto,
                                          Input antecip_pef_pend.cdn_fornecedor,
                                          Input antecip_pef_pend.cod_tit_ap,
                                          Input antecip_pef_pend.cod_parcela,
                                          Input p_cod_refer,
                                          Input v_des_msg_erro_1,
                                          Input antecip_pef_pend.cod_estab,
                                          Input p_num_seq) /*pi_verifica_msg_erro*/.
                assign v_log_erro_valid = no.
            end.
        end.    
        end /* if */.
        /* --- Prepara vari†vel para verificar v°nculos de impostos a AN/PEF ---*/

        if  p_num_bord_ap > 0
        then do:
            assign v_cod_portador = p_cod_portador.
        end /* if */.
        else do:
            assign v_cod_portador = "".
        end /* else */.

        /* --- Validaá∆o do Indicador Econìmico ---*/
        if  avail antecip_pef_pend
        then do:        
            run pi_validar_indic_econ_movto (Input v_cod_indic_econ_antecip,
                                             Input v_dat_confir_bxa_tit_ap,
                                             Input antecip_pef_pend.cod_empresa,
                                             output v_cod_return) /*pi_validar_indic_econ_movto*/.

        if  v_cod_return <> "OK" /*l_ok*/ 
        then do:
            /* case_block: */
            case entry(1, v_cod_return):
                when "241" then assign v_des_msg_erro_1 = getStrTrans("Indicador Econìmico Inexistente !", "APB") /*241*/.
                when "1199" then assign v_des_msg_erro_1 = "Indicador Econìmico fora da faixa de validade" /*l_indic_econ_fora_faixa_valid*/ .
                when "336" then assign v_des_msg_erro_1 = getStrTrans("Hist¢rico Finalidade inexistente para o indicador economico !", "APB") /*336*/.
                when "337" then assign v_des_msg_erro_1 = getStrTrans("Finalidade econìmica n∆o permite informar valores !", "APB") /*337*/.
                when "338" then assign v_des_msg_erro_1 = getStrTrans("Finalidade n∆o liberada para a Unidade Organizacional !", "APB") /*338*/.
            end /* case case_block */.

                run pi_verifica_msg_erro (Input antecip_pef_pend.cod_estab,
                                          Input antecip_pef_pend.cod_espec_docto,
                                          Input antecip_pef_pend.cod_ser_docto,
                                          Input antecip_pef_pend.cdn_fornecedor,
                                          Input antecip_pef_pend.cod_tit_ap,
                                          Input antecip_pef_pend.cod_parcela,
                                          Input p_cod_refer,
                                          Input v_des_msg_erro_1,
                                          Input antecip_pef_pend.cod_estab,
                                          Input p_num_seq) /*pi_verifica_msg_erro*/.
            assign v_log_erro_valid = no.
        end /* if */.

        /* ---  Validaá∆o das Cotaá‰es ---*/
        run pi_verifica_cotac_parid (Input antecip_pef_pend.cod_empresa,
                                     Input v_cod_indic_econ_antecip,
                                     Input no,
                                     Input no,
                                     Input "Pagto" /*l_pagto*/,
                                     Input v_dat_confir_bxa_tit_ap,
                                     Input v_dat_confir_bxa_tit_ap,
                                     Input string(v_dat_confir_bxa_tit_ap),
                                     Input "",
                                     Input no,
                                     output v_cod_return) /*pi_verifica_cotac_parid*/.
        if  v_cod_return <> "OK" /*l_ok*/ 
        then do:
            erro_cotac_block:
            for each tt_erros_cotac_parid no-lock:
                 assign v_des_msg_erro_1 = substitute(getStrTrans("Cotaá∆o inexistente: base &1, indice &2, data &3 !", "APB") /*4145*/,
                                                      tt_erros_cotac_parid.tta_cod_indic_econ_base,
                                                      tt_erros_cotac_parid.tta_cod_indic_econ_idx,
                                                      string( tt_erros_cotac_parid.tta_dat_cotac_indic_econ)).
                 run pi_verifica_msg_erro (Input antecip_pef_pend.cod_estab,
                                           Input antecip_pef_pend.cod_espec_docto,
                                           Input antecip_pef_pend.cod_ser_docto,
                                           Input antecip_pef_pend.cdn_fornecedor,
                                           Input antecip_pef_pend.cod_tit_ap,
                                           Input antecip_pef_pend.cod_parcela,
                                           Input p_cod_refer,
                                           Input v_des_msg_erro_1,
                                           Input antecip_pef_pend.cod_estab,
                                           Input p_num_seq) /*pi_verifica_msg_erro*/.
                 assign v_log_erro_valid = no.
            end /* for erro_cotac_block */.
        end /* if */.
        if  antecip_pef_pend.cdn_fornecedor > 0
        then do:
            find fornecedor no-lock
                where fornecedor.cod_empresa    = antecip_pef_pend.cod_empresa
                and   fornecedor.cdn_fornecedor = antecip_pef_pend.cdn_fornecedor no-error.
            if  antecip_pef_pend.cdn_fornecedor <> 0 then do:
                find fornec_financ no-lock 
                    where fornec_financ.cod_empresa    = antecip_pef_pend.cod_empresa
                    and   fornec_financ.cdn_fornecedor = antecip_pef_pend.cdn_fornecedor.   
                if  avail fornec_financ then do:
                    if  fornec_financ.log_pagto_bloqdo = yes
                    and antecip_pef_pend.cod_portador <> "" then do:
                         assign v_des_msg_erro_1 = substitute(getStrTrans("Pagamento Bloqueado !", "APB") /*7838*/, antecip_pef_pend.cdn_fornecedor).
                         run pi_verifica_msg_erro (Input antecip_pef_pend.cod_estab,
                                                   Input antecip_pef_pend.cod_espec_docto,
                                                   Input antecip_pef_pend.cod_ser_docto,
                                                   Input antecip_pef_pend.cdn_fornecedor,
                                                   Input antecip_pef_pend.cod_tit_ap,
                                                   Input antecip_pef_pend.cod_parcela,
                                                   Input p_cod_refer,
                                                   Input v_des_msg_erro_1,
                                                   Input antecip_pef_pend.cod_estab,
                                                   Input p_num_seq) /*pi_verifica_msg_erro*/.
                     assign v_log_erro_valid = no.
                    end.
                end.    
            end.  
            /* --- Verifica impostos vinculados a AN/PF ---*/
            if  search("prgfin/apb/apb794za.r") = ? and search("prgfin/apb/apb794za.py") = ? then do:
                if  v_cod_dwb_user begins 'es_' then
                    return "Programa execut†vel n∆o foi encontrado:" /*l_programa_nao_encontrado*/  + "prgfin/apb/apb794za.py".
                else do:
                    message getStrTrans("Programa execut†vel n∆o foi encontrado:", "APB") /*l_programa_nao_encontrado*/  "prgfin/apb/apb794za.py"
                           view-as alert-box error buttons ok.
                    return.
                end.
            end.
            else
                run prgfin/apb/apb794za.py (Input antecip_pef_pend.cod_estab,
                                        Input p_cod_refer_antecip_pef,
                                        Input v_cod_portador,
                                        Input p_num_bord_ap,
                                        Input p_num_seq,
                                        Input yes,
                                        Input v_dat_confir_bxa_tit_ap,
                                        Input "Retido" /*l_retido*/,
                                        output v_log_impto_vincul_refer,
                                        output v_val_tot_impto,
                                        Input recid(bord_ap),
                                        Input recid(cheq_ap),
                                        Input recid(item_lote_pagto)) /*prg_fnc_verificar_impto_vincul_refer*/.

            if v_log_sul_america then do:
                for each impto_impl_pend_ap no-lock use-index imptmplp_id
                   where impto_impl_pend_ap.cod_estab_refer = antecip_pef_pend.cod_estab
                     and impto_impl_pend_ap.cod_refer       = p_cod_refer_antecip_pef
                     and impto_impl_pend_ap.cod_portador    = v_cod_portador
                     and impto_impl_pend_ap.num_bord_ap     = p_num_bord_ap
                     and impto_impl_pend_ap.num_seq_refer   = p_num_seq
                     and impto_impl_pend_ap.ind_clas_impto  = "Retido" /*l_retido*/ :
                     find first imposto of impto_impl_pend_ap no-lock
                          where imposto.ind_tip_impto = "Imposto Sobre Valor Agregado" /*l_imposto_sobre_valor_agregado*/  no-error.
                     if avail imposto then
                        assign v_log_impto_vincul_refer = no
                         v_val_tot_impto = v_val_tot_impto - impto_impl_pend_ap.val_imposto.
                end.
            end.

            /* --- Prepara as contas do fornecedor que dever∆o ser validadas ---*/
            assign v_ind_finalid_ctbl = "Saldo" /*l_saldo*/ .
        end /* if */.
        find espec_docto no-lock
             where espec_docto.cod_espec_docto = antecip_pef_pend.cod_espec_docto
              no-error.

        if not avail cta_corren then do:
           find portad_finalid_econ no-lock
                where portad_finalid_econ.cod_estab        = p_cod_estab_pagto
                and   portad_finalid_econ.cod_portador     = p_cod_portador
                and   portad_finalid_econ.cod_cart_bcia    = antecip_pef_pend.cod_cart_bcia
                and   portad_finalid_econ.cod_finalid_econ = v_cod_finalid_econ_antecip no-error.
           if avail portad_finalid_econ then
              find cta_corren no-lock where cta_corren.cod_cta_corren = portad_finalid_econ.cod_cta_corren no-error.
        end.
        assign v_log_valid = yes.
        if avail cta_corren then do:

            /* Begin_Include: i_verify_security_grp_usuar */
            assign v_log_valid = no.

            if  can-find(first segur_cta_corren
                    where segur_cta_corren.cod_cta_corren = cta_corren.cod_cta_corren
                      and segur_cta_corren.cod_grp_usuar = '*' /*cl_verify_security_cta_corren_impto_aux of segur_cta_corren*/)
                    then do:
                assign v_log_valid = yes.
            end /* if */.
            else do:
                segur_block:
                for each segur_cta_corren no-lock
                 where segur_cta_corren.cod_cta_corren = cta_corren.cod_cta_corren /*cl_verify_security_cta_corren_impto of segur_cta_corren*/:
                    if  lookup(segur_cta_corren.cod_grp_usuar, v_cod_grp_usuar_lst) <> 0
                    then do:
                        assign v_log_valid = yes.
                        leave segur_block.
                    end /* if */.
                end /* for segur_block */.
            end /* else */.

            /* End_Include: i_verify_security_grp_usuar */

        end.

        if v_log_valid = no then do:
           assign v_des_msg_erro_1 = substitute(getStrTrans("Usu†rio &2 n∆o possui permiss∆o para acessar as informaá‰es do(a) &1 &3 selecionado." + chr(10) +
    "Verificar com o respons†vel pela manutená∆o dos controles de seguranáa do sistema a possibilidade de inclus∆o desta permiss∆o." + chr(10) +
    "", "APB") /*3187*/, getStrTrans("Conta Corrente", "APB") /*l_conta_corrente*/  + "(" + cta_corren.cod_cta_corren + ")" , v_cod_usuar_corren).
           run pi_verifica_msg_erro (Input antecip_pef_pend.cod_estab,
                                     Input antecip_pef_pend.cod_espec_docto,
                                     Input antecip_pef_pend.cod_ser_docto,
                                     Input antecip_pef_pend.cdn_fornecedor,
                                     Input antecip_pef_pend.cod_tit_ap,
                                     Input antecip_pef_pend.cod_parcela,
                                     Input p_cod_refer,
                                     Input v_des_msg_erro_1,
                                     Input antecip_pef_pend.cod_estab,
                                     Input p_num_seq) /*pi_verifica_msg_erro*/.
           assign v_log_erro_valid = no.
        end.

        run pi_criticar_geracao_antecip_pef_1 (Input p_cod_refer,
                                               Input p_num_seq,
                                               Input p_cod_portador,
                                               Input v_ind_finalid_ctbl,
                                               Input v_dat_confir_bxa_tit_ap,
                                               Input v_cod_finalid_econ_antecip,
                                               Input v_log_impto_vincul_refer,
                                               Input p_cod_estab_pagto) /*pi_criticar_geracao_antecip_pef_1*/.
    end /* if */.

END PROCEDURE. /* pi_criticar_geracao_antecip_pef */
/*****************************************************************************
** Procedure Interna.....: pi_verifica_msg_erro
** Descricao.............: pi_verifica_msg_erro
** Criado por............: Roberto
** Criado em.............: 04/02/1997 18:48:54
** Alterado por..........: fut41061
** Alterado em...........: 08/07/2014 11:26:04
*****************************************************************************/
PROCEDURE pi_verifica_msg_erro:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_estab
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def Input param p_cod_espec_docto
        as character
        format "x(3)"
        no-undo.
    def Input param p_cod_ser_docto
        as character
        format "x(3)"
        no-undo.
    def Input param p_cdn_fornecedor
        as Integer
        format ">>>,>>>,>>9"
        no-undo.
    def Input param p_cod_tit_ap
        as character
        format "x(10)"
        no-undo.
    def Input param p_cod_parcela
        as character
        format "x(02)"
        no-undo.
    def Input param p_cod_refer
        as character
        format "x(10)"
        no-undo.
    def Input param p_des_msg_erro_1
        as character
        format "x(80)"
        no-undo.
    def Input param p_cod_estab_pagto
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def Input param p_num_seq
        as integer
        format ">>>,>>9"
        no-undo.


    /************************* Parameter Definition End *************************/

    create tt_log_erros_tit_antecip.
    assign tt_log_erros_tit_antecip.tta_cod_estab       = p_cod_estab
           tt_log_erros_tit_antecip.tta_cod_espec_docto = p_cod_espec_docto
           tt_log_erros_tit_antecip.tta_cod_ser_docto   = p_cod_ser_docto
           tt_log_erros_tit_antecip.tta_cdn_fornecedor  = p_cdn_fornecedor
           tt_log_erros_tit_antecip.tta_cod_tit_ap      = p_cod_tit_ap
           tt_log_erros_tit_antecip.tta_cod_parcela     = p_cod_parcela
           tt_log_erros_tit_antecip.tta_cod_refer       = p_cod_refer
           tt_log_erros_tit_antecip.ttv_des_msg_erro_1  = p_des_msg_erro_1
           tt_log_erros_tit_antecip.tta_cod_estab_refer = p_cod_estab_pagto
           tt_log_erros_tit_antecip.tta_num_seq_refer   = p_num_seq
           tt_log_erros_tit_antecip.ttv_log_atlzdo      = no.


END PROCEDURE. /* pi_verifica_msg_erro */
/*****************************************************************************
** Procedure Interna.....: pi_criticar_geracao_antecip_pef_1
** Descricao.............: pi_criticar_geracao_antecip_pef_1
** Criado por............: Marlize
** Criado em.............: 04/04/1998 12:34:54
** Alterado por..........: fut41675
** Alterado em...........: 27/08/2018 14:27:53
*****************************************************************************/
PROCEDURE pi_criticar_geracao_antecip_pef_1:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_refer
        as character
        format "x(10)"
        no-undo.
    def Input param p_num_seq
        as integer
        format ">>>,>>9"
        no-undo.
    def Input param p_cod_portador
        as character
        format "x(5)"
        no-undo.
    def Input param p_ind_finalid_ctbl
        as character
        format "X(30)"
        no-undo.
    def Input param p_dat_confir_bxa_tit_ap
        as date
        format "99/99/9999"
        no-undo.
    def Input param p_cod_finalid_econ
        as character
        format "x(10)"
        no-undo.
    def Input param p_log_impto_vincul_refer
        as logical
        format "Sim/N∆o"
        no-undo.
    def Input param p_cod_estab_pagto_pef
        as character
        format "x(3)"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_cod_cta_ctbl
        as character
        format "x(20)":U
        label "Conta Cont†bil"
        column-label "Conta Cont†bil"
        no-undo.
    def var v_cod_plano_cta_ctbl
        as character
        format "x(8)":U
        label "Plano Contas"
        column-label "Plano Contas"
        no-undo.
    def var v_cod_return
        as character
        format "x(40)":U
        no-undo.
    def var v_des_msg_erro_1
        as character
        format "x(80)":U
        label "Mensagem de Erro"
        column-label "Mensagem de Erro"
        no-undo.
    def var v_ind_control_ctbl
        as character
        format "X(18)":U
        view-as combo-box
        &if "{&FNC_MULTI_IDIOMA}" = "YES" &then
        list-item-pairs "Controla Todas FE","Controla Todas FE","Controla na FE","Controla na FE","Nao Controla","Nao Controla"
        &else
        list-items "Controla Todas FE","Controla na FE","Nao Controla"
        &endif
         /*l_controla_todas_fe*/ /*l_controla_na_fe*/ /*l_nao_controla*/
        inner-lines 4
        bgcolor 15 font 2
        label "Controle Cont†bil"
        column-label "Controle Cont†bil"
        no-undo.
    def var v_ind_finalid_ctbl_err
        as character
        format "X(30)":U
        label "Finalidade Cont†bil"
        column-label "Finalidade Cont†bil"
        no-undo.
    def var v_log_return
        as logical
        format "Sim/N∆o"
        initial no
        no-undo.
    def var v_log_val_cta
        as logical
        format "Sim/N∆o"
        initial no
        no-undo.
    def var v_num_seq
        as integer
        format ">>>,>>9":U
        label "SeqÅància"
        column-label "Seq"
        no-undo.


    /************************** Variable Definition End *************************/

    /* Alterada para chamar programa ao invÇs de pi - Marisa  */
    /* --- Validaá‰es espec°ficas para Antecipaá∆o e Pagto Extra Fornecedor ---*/
    if  avail antecip_pef_pend
    then do:
        if  antecip_pef_pend.ind_tip_refer = "Antecipaá∆o" /*l_antecipacao*/ 
        then do:
            /* A variavel v_cod_indic_econ_antecip foi preparada para o caso da antecipa    „o
            ser paga em outra moeda e se a fun    „o estiver liberada - Barth */                
            if v_log_pagto_ant_outras_moed = yes 
            and antecip_pef_pend.ind_tip_refer = "Antecipaá∆o" /*l_antecipacao*/  then do:
                if avail item_lote_pagto then
                    assign v_cod_indic_econ_antecip = item_lote_pagto.cod_indic_econ.
                if avail bord_ap then
                    assign v_cod_indic_econ_antecip = bord_ap.cod_indic_econ.
                if  not avail item_lote_pagto
                and not avail bord_ap then
                    assign v_cod_indic_econ_antecip = antecip_pef_pend.cod_indic_econ.
            end.
            else
                assign v_cod_indic_econ_antecip = antecip_pef_pend.cod_indic_econ.

            if  avail fornecedor then do:
                run pi_verifica_ctas_grp_fornec (Input antecip_pef_pend.cod_empresa,
                                                 Input antecip_pef_pend.cod_espec_docto,
                                                 Input "Antecipaá∆o" /*l_antecipacao*/,
                                                 Input fornecedor.cod_grp_fornec,
                                                 Input p_ind_finalid_ctbl,
                                                 Input antecip_pef_pend.cod_indic_econ,
                                                 Input p_dat_confir_bxa_tit_ap,
                                                 output p_cod_finalid_econ,
                                                 output v_ind_finalid_ctbl_err,
                                                 output v_cod_plano_cta_ctbl,
                                                 output v_cod_cta_ctbl,
                                                 output v_ind_control_ctbl) /*pi_verifica_ctas_grp_fornec*/.
                if  v_ind_finalid_ctbl_err <> "OK" /*l_ok*/ 
                then do:
                    erro_bock:
                    do v_num_seq = 1 to num-entries( v_ind_finalid_ctbl_err ):
                        assign v_des_msg_erro_1 = substitute( getStrTrans("Cta &1 Fornec inexistente p/: esp &2, grp &3, FE &4, em &5 !", "APB") /*4159*/,
                                                              entry( v_num_seq, v_ind_finalid_ctbl_err ),
                                                              antecip_pef_pend.cod_espec_docto,
                                                              fornecedor.cod_grp_fornec,
                                                              p_cod_finalid_econ,
                                                              string( p_dat_confir_bxa_tit_ap ) ).
                        run pi_verifica_msg_erro (Input antecip_pef_pend.cod_estab,
                                                  Input antecip_pef_pend.cod_espec_docto,
                                                  Input antecip_pef_pend.cod_ser_docto,
                                                  Input antecip_pef_pend.cdn_fornecedor,
                                                  Input antecip_pef_pend.cod_tit_ap,
                                                  Input antecip_pef_pend.cod_parcela,
                                                  Input p_cod_refer,
                                                  Input v_des_msg_erro_1,
                                                  Input antecip_pef_pend.cod_estab,
                                                  Input p_num_seq) /*pi_verifica_msg_erro*/.
                        assign v_log_erro_valid = no.
                    end /* do erro_bock */.
                end /* if */.
            end.    
            /* --- Verifica se todos os Hist¢ricos dos Imp¢stos Vinculados a Empresa tàm Conta de
            DÇbito informada. ---*/
        end /* if */.
        else do:
            if  antecip_pef_pend.cod_espec_docto <> ""
            and antecip_pef_pend.cod_espec_docto <> ?
            then do:
                find tit_ap no-lock
                     where tit_ap.cod_estab = antecip_pef_pend.cod_estab
                       and tit_ap.cdn_fornecedor = antecip_pef_pend.cdn_fornecedor
                       and tit_ap.cod_espec_docto = antecip_pef_pend.cod_espec_docto
                       and tit_ap.cod_ser_docto = antecip_pef_pend.cod_ser_docto
                       and tit_ap.cod_tit_ap = antecip_pef_pend.cod_tit_ap
                       and tit_ap.cod_parcela = antecip_pef_pend.cod_parcela
    &if "{&emsfin_version}" >= "5.01" &then
                     use-index titap_id
    &endif
                      /*cl_tit_ap_antecip_pef_pend of tit_ap*/ no-error.
                if  tit_ap.ind_tip_espec_docto = "Antecipaá∆o" /*l_antecipacao*/ 
                or  tit_ap.ind_tip_espec_docto = "Provis∆o" /*l_provisao*/ 
                then do:
                    /* --- Caso esta condiá∆o seja satisfeita, haver† a necessidade da
                          Conta Transit¢ria de Provis∆o para a contabilizaá∆o da baixa da Provis∆o. ---*/
                    if  tit_ap.ind_tip_espec_docto = "Provis∆o" /*l_provisao*/ 
                    then do:
                        assign p_ind_finalid_ctbl = p_ind_finalid_ctbl + "," + "Transit¢ria de Provis∆o" /*l_transitoria_provisao*/ .
                    end /* if */.

                    if  avail espec_docto and avail fornecedor then do:
                        run pi_verifica_ctas_grp_fornec (Input antecip_pef_pend.cod_empresa,
                                                         Input antecip_pef_pend.cod_espec_docto,
                                                         Input espec_docto.ind_tip_espec_docto,
                                                         Input fornecedor.cod_grp_fornec,
                                                         Input p_ind_finalid_ctbl,
                                                         Input antecip_pef_pend.cod_indic_econ,
                                                         Input p_dat_confir_bxa_tit_ap,
                                                         output p_cod_finalid_econ,
                                                         output v_ind_finalid_ctbl_err,
                                                         output v_cod_plano_cta_ctbl,
                                                         output v_cod_cta_ctbl,
                                                         output v_ind_control_ctbl) /*pi_verifica_ctas_grp_fornec*/.
                        if  v_ind_finalid_ctbl_err <> "OK" /*l_ok*/ 
                        then do:
                            erro_bock:
                            do v_num_seq = 1 to num-entries( v_ind_finalid_ctbl_err ):
                                assign v_des_msg_erro_1 = substitute( getStrTrans("Cta &1 Fornec inexistente p/: esp &2, grp &3, FE &4, em &5 !", "APB") /*4159*/,
                                                                      entry( v_num_seq, v_ind_finalid_ctbl_err ),
                                                                      antecip_pef_pend.cod_espec_docto,
                                                                      fornecedor.cod_grp_fornec,
                                                                      p_cod_finalid_econ,
                                                                      string( p_dat_confir_bxa_tit_ap ) ).
                                run pi_verifica_msg_erro (Input antecip_pef_pend.cod_estab,
                                                          Input antecip_pef_pend.cod_espec_docto,
                                                          Input antecip_pef_pend.cod_ser_docto,
                                                          Input antecip_pef_pend.cdn_fornecedor,
                                                          Input antecip_pef_pend.cod_tit_ap,
                                                          Input antecip_pef_pend.cod_parcela,
                                                          Input p_cod_refer,
                                                          Input v_des_msg_erro_1,
                                                          Input antecip_pef_pend.cod_estab,
                                                          Input p_num_seq) /*pi_verifica_msg_erro*/.
                                assign v_log_erro_valid = no.
                            end /* do erro_bock */.
                        end /* if */.
                    end.    
                end /* if */.
                /* --- Validaá∆o do Rateio das Apropriaá‰es Cont†beis ---*/
                blk_aprop:
                for each aprop_ctbl_pend_ap no-lock
                 where aprop_ctbl_pend_ap.cod_estab = antecip_pef_pend.cod_estab
                   and aprop_ctbl_pend_ap.cod_refer = antecip_pef_pend.cod_refer
                 :
                    if  search("prgint/utb/utb719za.r") = ? and search("prgint/utb/utb719za.py") = ? then do:
                        if  v_cod_dwb_user begins 'es_' then
                            return "Programa execut†vel n∆o foi encontrado:" /*l_programa_nao_encontrado*/  + "prgint/utb/utb719za.py".
                        else do:
                            message getStrTrans("Programa execut†vel n∆o foi encontrado:", "APB") /*l_programa_nao_encontrado*/  "prgint/utb/utb719za.py"
                                   view-as alert-box error buttons ok.
                            return.
                        end.
                    end.
                    else
                        run prgint/utb/utb719za.py (Input aprop_ctbl_pend_ap.cod_plano_cta_ctbl,
                                                Input aprop_ctbl_pend_ap.cod_cta_ctbl,
                                                Input "APB" /*l_apb*/,
                                                Input "Conta Movimento" /*l_conta_movimento*/,
                                                Input p_dat_confir_bxa_tit_ap,
                                                Input p_dat_confir_bxa_tit_ap,
                                                Input antecip_pef_pend.cod_empresa,
                                                output v_log_return) /*prg_fnc_cta_ctbl_integr*/.
                    if  v_log_return = no
                    then do:
                        assign v_des_msg_erro_1 = substitute( getStrTrans("Conta Cont†bil de Integraá∆o &1/&2 inv†lida em &3 !", "APB") /*4166*/,
                                                              aprop_ctbl_pend_ap.cod_plano_cta_ctbl,
                                                              aprop_ctbl_pend_ap.cod_cta_ctbl,
                                                              p_dat_confir_bxa_tit_ap ).

                        case GetEntryField(1,v_cod_param_msg_erro_valid,chr(10)):
                              when '954' then do:
                                  assign v_des_msg_erro_1 = substitute( getStrTrans("Conta &1 n∆o cadastrada para m¢dulo &2 finalidade ctbl &3 !", "APB") /*954*/, GetEntryField(2,v_cod_param_msg_erro_valid,chr(10)), getStrTrans("APB", "APB"), GetEntryField(3,v_cod_param_msg_erro_valid,chr(10))).
                              end.
                              when '18544' then do:    
                                  assign v_des_msg_erro_1 = substitute( getStrTrans("Plano de Contas &1 est† fora da Validade !", "APB") /*18544*/, GetEntryField(2,v_cod_param_msg_erro_valid,chr(10))).
                              end.
                              when '18545' then do:   
                                  assign v_des_msg_erro_1 = substitute( getStrTrans("Conta Cont†bil &1 est† fora da Validade !", "APB") /*18545*/, GetEntryField(2,v_cod_param_msg_erro_valid,chr(10))).
                              end.
                              when '18546' then do:                                                                           
                                  assign v_des_msg_erro_1 = substitute( getStrTrans("O Plano de Contas da Unidade Organizacional &1 informado possui per°odo de validade que n∆o pode ser utilizado.", "APB") /*18546*/, GetEntryField(2,v_cod_param_msg_erro_valid,chr(10))).
                              end.
                              when '18547' then do:                                                                            
                                  assign v_des_msg_erro_1 = substitute( getStrTrans("Verifique se existe o relacionamento do Plano de Contas &1 informado com a Unidade Organizacional &2 no cadastro de Plano de Contas.", "APB") /*18547*/, GetEntryField(2,v_cod_param_msg_erro_valid,chr(10)),GetEntryField(3,v_cod_param_msg_erro_valid,chr(10))).
                              end.
                        end.

                        run pi_verifica_msg_erro (Input antecip_pef_pend.cod_estab,
                                                  Input antecip_pef_pend.cod_espec_docto,
                                                  Input antecip_pef_pend.cod_ser_docto,
                                                  Input antecip_pef_pend.cdn_fornecedor,
                                                  Input antecip_pef_pend.cod_tit_ap,
                                                  Input antecip_pef_pend.cod_parcela,
                                                  Input p_cod_refer,
                                                  Input v_des_msg_erro_1,
                                                  Input antecip_pef_pend.cod_estab,
                                                  Input p_num_seq) /*pi_verifica_msg_erro*/.
                        assign v_log_erro_valid = no.
                    end /* if */.
                end /* for blk_aprop */.
            end /* if */.
            run pi_valida_contas_principal_ativo_mutuo (Input p_cod_refer,
                                                        Input p_num_seq) /*pi_valida_contas_principal_ativo_mutuo*/.        
            run pi_valida_cta_imposto /*pi_valida_cta_imposto*/.
        end /* else */.

        if  p_cod_portador <> "" then do:
            /* --- Validaá∆o das Contas Cont†beis do Portador ---*/
            run pi_validar_portador (Input p_cod_portador,
                                     Input p_cod_estab_pagto_pef,
                                     Input v_cod_indic_econ_antecip,
                                     Input p_dat_confir_bxa_tit_ap,
                                     Input yes,
                                     Input "Principal Ativo" /*l_principal_ativo*/,
                                     output v_ind_finalid_ctbl_err,
                                     output p_cod_finalid_econ,
                                     Input antecip_pef_pend.cod_cart_bcia) /*pi_validar_portador*/.
            if  return-value = "777"
            then do:
                assign v_des_msg_erro_1 = substitute( getStrTrans("Conta de &1 Inexistente para a Conta Corrente do Portador !", "APB") /*777*/, getStrTrans("Principal Ativo", "APB") /*l_principal_ativo*/  ).
                run pi_verifica_msg_erro (Input antecip_pef_pend.cod_estab,
                                          Input antecip_pef_pend.cod_espec_docto,
                                          Input antecip_pef_pend.cod_ser_docto,
                                          Input antecip_pef_pend.cdn_fornecedor,
                                          Input antecip_pef_pend.cod_tit_ap,
                                          Input antecip_pef_pend.cod_parcela,
                                          Input p_cod_refer,
                                          Input v_des_msg_erro_1,
                                          Input antecip_pef_pend.cod_estab,
                                          Input p_num_seq) /*pi_verifica_msg_erro*/.
                assign v_log_erro_valid = no.
            end /* if */.
            else do:
                /* ** SE MOEDA PAGTO N«O ARMAZENA NOS M‡DULOS, APROPRIA CONTRA TRANSIT‡RIA MMOEDA. ***/
                if  can-find( finalid_econ
                        where finalid_econ.cod_finalid_econ = p_cod_finalid_econ
                          and finalid_econ.ind_armaz_val   <> "M¢dulos" /*l_modulos*/   
                          and finalid_econ.ind_armaz_val   <> "Contabilidade" /*l_contabilidade*/  
                          and finalid_econ.ind_armaz_val   <> "Controladoria" /*l_controladoria*/ ) then do:

                    /* Acessa transit¢ria de Mmoeda da Cta principal ativo do portador */
                    find cta_ctbl_cmcmm no-lock
                         where cta_ctbl_cmcmm.cod_plano_cta_ctbl  = cta_corren_cta_ctbl.cod_plano_cta_ctbl
                           and cta_ctbl_cmcmm.cod_cta_ctbl        = cta_corren_cta_ctbl.cod_cta_ctbl
                           and cta_ctbl_cmcmm.cod_indic_econ_base = v_cod_indic_econ_antecip
                           and cta_ctbl_cmcmm.cod_indic_econ_idx  = v_cod_indic_econ_antecip
                         no-error.

                    if  not avail cta_ctbl_cmcmm
                    then do:
                        assign v_des_msg_erro_1 = substitute(getStrTrans("Conta Transit¢ria CMCMM inexistente p/ Portador/Moeda Pagto !", "APB") /*3672*/ + chr(10) + getStrTrans("Conta Transit¢ria &1, n∆o cadastrada para o indicador indice &2, base &2.", "APB") /*3672*/,
                                                  cta_corren_cta_ctbl.cod_cta_ctbl, v_cod_indic_econ_antecip).
                        run pi_verifica_msg_erro (Input antecip_pef_pend.cod_estab,
                                                  Input antecip_pef_pend.cod_espec_docto,
                                                  Input antecip_pef_pend.cod_ser_docto,
                                                  Input antecip_pef_pend.cdn_fornecedor,
                                                  Input antecip_pef_pend.cod_tit_ap,
                                                  Input antecip_pef_pend.cod_parcela,
                                                  Input p_cod_refer,
                                                  Input v_des_msg_erro_1,
                                                  Input antecip_pef_pend.cod_estab,
                                                  Input p_num_seq) /*pi_verifica_msg_erro*/.
                        assign v_log_erro_valid = no.
                    end /* if */.
                end /* if */.
            end /* else */.
        end.

        /* --- Verifica as contas de saldo dos fornecedores dos impostos ---*/
        if  p_log_impto_vincul_refer = yes
        then do:
            run pi_verifica_contas_impto_retido_pagto (Input antecip_pef_pend.cod_estab,
                                                       Input antecip_pef_pend.cod_refer,
                                                       Input p_num_seq,
                                                       Input p_dat_confir_bxa_tit_ap,
                                                       output v_cod_return) /*pi_verifica_contas_impto_retido_pagto*/.
            if  v_cod_return <> "OK" /*l_ok*/ 
            then do:
                if entry(1, v_cod_return) = '8489' then do:
                   assign v_des_msg_erro_1 = substitute(getStrTrans("Conta Cont†bil incorreta para &1 !", "APB") /*8489*/ + chr(10),
                                                        entry(2, v_cod_return)).
                   run pi_verifica_msg_erro (Input antecip_pef_pend.cod_estab,
                                             Input antecip_pef_pend.cod_espec_docto,
                                             Input antecip_pef_pend.cod_ser_docto,
                                             Input antecip_pef_pend.cdn_fornecedor,
                                             Input antecip_pef_pend.cod_tit_ap,
                                             Input antecip_pef_pend.cod_parcela,
                                             Input p_cod_refer,
                                             Input v_des_msg_erro_1,
                                             Input antecip_pef_pend.cod_estab,
                                             Input p_num_seq) /*pi_verifica_msg_erro*/.
                   assign v_log_erro_valid = no.
                end.
                else do:
                   erro_cta_ir:
                   do v_num_seq = 1 to num-entries(v_cod_return) by 4:
                       assign v_des_msg_erro_1 = substitute( getStrTrans("Cta &1 IR inexistente p/: esp &2, grp &3, FE &4, em &5.", "APB") /*4158*/ + chr(10),
                                                             entry( v_num_seq    , v_cod_return ),
                                                             entry( v_num_seq + 1, v_cod_return ),
                                                             entry( v_num_seq + 2, v_cod_return ),
                                                             entry( v_num_seq + 3, v_cod_return ),
                                                             string( p_dat_confir_bxa_tit_ap )).
                       run pi_verifica_msg_erro (Input antecip_pef_pend.cod_estab,
                                                 Input antecip_pef_pend.cod_espec_docto,
                                                 Input antecip_pef_pend.cod_ser_docto,
                                                 Input antecip_pef_pend.cdn_fornecedor,
                                                 Input antecip_pef_pend.cod_tit_ap,
                                                 Input antecip_pef_pend.cod_parcela,
                                                 Input p_cod_refer,
                                                 Input v_des_msg_erro_1,
                                                 Input antecip_pef_pend.cod_estab,
                                                 Input p_num_seq) /*pi_verifica_msg_erro*/.
                       assign v_log_erro_valid = no.
                   end /* do erro_cta_ir */.
                end.
            end /* if */.
        end /* if */.
    end /* if */.
END PROCEDURE. /* pi_criticar_geracao_antecip_pef_1 */
/*****************************************************************************
** Procedure Interna.....: pi_valida_contas_principal_ativo_mutuo
** Descricao.............: pi_valida_contas_principal_ativo_mutuo
** Criado por............: bre17191
** Criado em.............: 27/01/2000 14:05:51
** Alterado por..........: src370
** Alterado em...........: 09/06/2004 12:19:28
*****************************************************************************/
PROCEDURE pi_valida_contas_principal_ativo_mutuo:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_refer
        as character
        format "x(10)"
        no-undo.
    def Input param p_num_seq
        as integer
        format ">>>,>>9"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************** Buffer Definition Begin *************************/

    &if "{&emsuni_version}" >= "5.01" &then
    def buffer b_cta_corren
        for cta_corren.
    &endif
    &if "{&emsfin_version}" >= "5.01" &then
    def buffer b_portad_finalid_econ
        for portad_finalid_econ.
    &endif


    /*************************** Buffer Definition End **************************/

    /************************* Variable Definition Begin ************************/

    def var v_cod_cart_bcia
        as character
        format "x(3)":U
        label "Carteira"
        column-label "Carteira"
        no-undo.
    def var v_cod_finalid_econ
        as character
        format "x(10)":U
        label "Finalidade Econìmica"
        column-label "Finalidade Econìmica"
        no-undo.
    def var v_ind_finalid_ctbl_err
        as character
        format "X(30)":U
        label "Finalidade Cont†bil"
        column-label "Finalidade Cont†bil"
        no-undo.


    /************************** Variable Definition End *************************/

    if avail antecip_pef_pend then do:
     if antecip_pef_pend.cod_portad_mutuo <> "" and antecip_pef_pend.cod_estab_portad_mutuo <> "" then do:
            find cart_bcia
               where cart_bcia.ind_tip_cart_bcia = "Contas a Pagar" /*l_contas_a_pagar*/ 
               no-lock no-error.

            /* Valida Portador */
            run pi_validar_portador (Input antecip_pef_pend.cod_portad_mutuo,
                                     Input antecip_pef_pend.cod_estab_portad_mutuo,
                                     Input antecip_pef_pend.cod_indic_econ,
                                     Input antecip_pef_pend.dat_emis_docto,
                                     Input yes,
                                     Input "Principal Ativo" /*l_principal_ativo*/,
                                     output v_ind_finalid_ctbl_err,
                                     output v_cod_finalid_econ,
                                     Input cart_bcia.cod_cart_bcia) /*pi_validar_portador*/.
            if  return-value <> "OK" /*l_ok*/  then do:
                /* erro_block: */
                case return-value:
                    when "506" then assign v_des_msg_erro_1 = substitute( getStrTrans("Portador Inexistente !", "APB") /*506*/).
                    when "775" then assign v_des_msg_erro_1 = substitute( getStrTrans("Portador &1 n∆o vinculado ao estabelecimento &2 !", "APB") /*775*/,antecip_pef_pend.cod_portad_mutuo,antecip_pef_pend.cod_estab_portad_mutuo).
                    when "776" then assign v_des_msg_erro_1 = substitute( getStrTrans("Finalidade ou Indicador Econìmico Incorreto para Portador !", "APB") /*776*/,antecip_pef_pend.cod_finalid_econ,antecip_pef_pend.cod_portad_mutuo,antecip_pef_pend.cod_estab_portad_mutuo).
                    when "777" then assign v_des_msg_erro_1 = substitute( getStrTrans("Conta de &1 Inexistente para a Conta Corrente do Portador !", "APB") /*777*/,v_ind_finalid_ctbl_err).
                end /* case erro_block */.
                run pi_verifica_msg_erro (Input antecip_pef_pend.cod_estab,
                                          Input antecip_pef_pend.cod_espec_docto,
                                          Input antecip_pef_pend.cod_ser_docto,
                                          Input antecip_pef_pend.cdn_fornecedor,
                                          Input antecip_pef_pend.cod_tit_ap,
                                          Input antecip_pef_pend.cod_parcela,
                                          Input p_cod_refer,
                                          Input v_des_msg_erro_1,
                                          Input antecip_pef_pend.cod_estab,
                                          Input p_num_seq) /*pi_verifica_msg_erro*/.
               assign v_log_erro_valid = no.
            end.

            find b_portad_finalid_econ
                where b_portad_finalid_econ.cod_estab        = antecip_pef_pend.cod_estab
                and   b_portad_finalid_econ.cod_portador     = antecip_pef_pend.cod_portador
                and   b_portad_finalid_econ.cod_cart_bcia    = cart_bcia.cod_cart_bcia
                and   b_portad_finalid_econ.cod_finalid_econ = antecip_pef_pend.cod_finalid_econ
                no-lock no-error.
            if  not avail b_portad_finalid_econ then do:
                assign v_des_msg_erro_1 = substitute( getStrTrans("Finalidade ou Indicador Econìmico Incorreto para Portador !", "APB") /*776*/, antecip_pef_pend.cod_finalid_econ,antecip_pef_pend.cod_portador,antecip_pef_pend.cod_estab).
                run pi_verifica_msg_erro (Input antecip_pef_pend.cod_estab,
                                          Input antecip_pef_pend.cod_espec_docto,
                                          Input antecip_pef_pend.cod_ser_docto,
                                          Input antecip_pef_pend.cdn_fornecedor,
                                          Input antecip_pef_pend.cod_tit_ap,
                                          Input antecip_pef_pend.cod_parcela,
                                          Input p_cod_refer,
                                          Input v_des_msg_erro_1,
                                          Input antecip_pef_pend.cod_estab,
                                          Input p_num_seq) /*pi_verifica_msg_erro*/.
                assign v_log_erro_valid = no.
            end.
            find cta_corren
                where cta_corren.cod_cta_corren = portad_finalid_econ.cod_cta_corren
                no-lock no-error.
            if  not avail cta_corren then do:
                assign v_des_msg_erro_1 = substitute( getStrTrans("Conta Corrente n∆o encontrada !", "APB") /*4764*/, antecip_pef_pend.cod_estab_portad_mutuo, antecip_pef_pend.cod_portad_mutuo,cart_bcia.cod_cart_bcia, antecip_pef_pend.cod_finalid_econ).
                run pi_verifica_msg_erro (Input antecip_pef_pend.cod_estab,
                                          Input antecip_pef_pend.cod_espec_docto,
                                          Input antecip_pef_pend.cod_ser_docto,
                                          Input antecip_pef_pend.cdn_fornecedor,
                                          Input antecip_pef_pend.cod_tit_ap,
                                          Input antecip_pef_pend.cod_parcela,
                                          Input p_cod_refer,
                                          Input v_des_msg_erro_1,
                                          Input antecip_pef_pend.cod_estab,
                                          Input p_num_seq) /*pi_verifica_msg_erro*/.
                assign v_log_erro_valid = no.
            end.

            find b_cta_corren
                where b_cta_corren.cod_cta_corren = b_portad_finalid_econ.cod_cta_corren
                no-lock no-error.
            if  not avail b_cta_corren then do:
                assign v_des_msg_erro_1 = substitute( getStrTrans("Conta Corrente n∆o encontrada !", "APB") /*4764*/, antecip_pef_pend.cod_estab, antecip_pef_pend.cod_portador,cart_bcia.cod_cart_bcia, antecip_pef_pend.cod_finalid_econ).
                run pi_verifica_msg_erro (Input antecip_pef_pend.cod_estab,
                                          Input antecip_pef_pend.cod_espec_docto,
                                          Input antecip_pef_pend.cod_ser_docto,
                                          Input antecip_pef_pend.cdn_fornecedor,
                                          Input antecip_pef_pend.cod_tit_ap,
                                          Input antecip_pef_pend.cod_parcela,
                                          Input p_cod_refer,
                                          Input v_des_msg_erro_1,
                                          Input antecip_pef_pend.cod_estab,
                                          Input p_num_seq) /*pi_verifica_msg_erro*/.
                assign v_log_erro_valid = no.
            end.

            /* --- Verifica se existe alguma conta_corrente_compos_mutuo para as contas correntes
                  informadas. Se o tipo de transaá∆o de caixa for Mutuo(Ativo/Passivo), deve existir. Se o tipo
                  de transacao de caixa for Transferencia n∆o deve existir ---*/

            /* Caso a funá∆o do M£tuo esteja ativa desconsiderar a tabela cta_corren_compos_mutuo*/

            if v_log_funcao_mutuo = no then do:
                find first cta_corren_compos_mutuo no-lock
                    where  cta_corren_compos_mutuo.cod_empres_orig     = cta_corren.cod_empresa
                    and    cta_corren_compos_mutuo.cod_unid_negoc_orig = cta_corren.cod_unid_negoc
                    and    cta_corren_compos_mutuo.cod_empres_dest     = b_cta_corren.cod_empresa
                    and    cta_corren_compos_mutuo.cod_unid_negoc_dest = b_cta_corren.cod_unid_negoc no-error.
                if  not avail cta_corren_compos_mutuo
                then do:
                    assign v_des_msg_erro_1 = substitute( getStrTrans("Deve existir um registro de Conta Corrente M£tuo !", "APB") /*4090*/, cta_corren.cod_empresa, cta_corren.cod_unid_negoc, b_cta_corren.cod_empresa, b_cta_corren.cod_unid_negoc).
                    run pi_verifica_msg_erro (Input antecip_pef_pend.cod_estab,
                                              Input antecip_pef_pend.cod_espec_docto,
                                              Input antecip_pef_pend.cod_ser_docto,
                                              Input antecip_pef_pend.cdn_fornecedor,
                                              Input antecip_pef_pend.cod_tit_ap,
                                              Input antecip_pef_pend.cod_parcela,
                                              Input p_cod_refer,
                                              Input v_des_msg_erro_1,
                                              Input antecip_pef_pend.cod_estab,
                                              Input p_num_seq) /*pi_verifica_msg_erro*/.
                    assign v_log_erro_valid = no.
                end.
                else do:
                    find first cta_corren_cta_ctbl no-lock
                         where cta_corren_cta_ctbl.cod_cta_corren               = cta_corren_compos_mutuo.cod_cta_corren_mutuo
                           and cta_corren_cta_ctbl.ind_finalid_ctbl_cta_corren  = "Principal Ativo" /*l_principal_ativo*/ 
                           and cta_corren_cta_ctbl.dat_inic_valid              <= antecip_pef_pend.dat_emis_docto
                           and cta_corren_cta_ctbl.dat_fim_valid               >= antecip_pef_pend.dat_emis_docto
                          no-error.
                    if  not avail cta_corren_cta_ctbl
                    then do:
                        assign v_des_msg_erro_1 = substitute( getStrTrans("Conta de &1 Inexistente para a Conta Corrente &2 !", "APB") /*9463*/, getStrTrans("Principal Ativo", "APB") /*l_principal_ativo*/ , cta_corren_compos_mutuo.cod_cta_corren_mutuo).
                        run pi_verifica_msg_erro (Input antecip_pef_pend.cod_estab,
                                                  Input antecip_pef_pend.cod_espec_docto,
                                                  Input antecip_pef_pend.cod_ser_docto,
                                                  Input antecip_pef_pend.cdn_fornecedor,
                                                  Input antecip_pef_pend.cod_tit_ap,
                                                  Input antecip_pef_pend.cod_parcela,
                                                  Input p_cod_refer,
                                                  Input v_des_msg_erro_1,
                                                  Input antecip_pef_pend.cod_estab,
                                                  Input p_num_seq) /*pi_verifica_msg_erro*/.
                        assign v_log_erro_valid = no.
                   end /* if */.
                end.

                find first cta_corren_compos_mutuo no-lock
                    where  cta_corren_compos_mutuo.cod_empres_orig     = b_cta_corren.cod_empresa
                    and    cta_corren_compos_mutuo.cod_unid_negoc_orig = b_cta_corren.cod_unid_negoc
                    and    cta_corren_compos_mutuo.cod_empres_dest     = cta_corren.cod_empresa
                    and    cta_corren_compos_mutuo.cod_unid_negoc_dest = cta_corren.cod_unid_negoc no-error.
                if  not avail cta_corren_compos_mutuo
                then do:
                    assign v_des_msg_erro_1 = substitute( getStrTrans("Deve existir um registro de Conta Corrente M£tuo !", "APB") /*4090*/, b_cta_corren.cod_empresa, b_cta_corren.cod_unid_negoc, cta_corren.cod_empresa, cta_corren.cod_unid_negoc).
                    run pi_verifica_msg_erro (Input antecip_pef_pend.cod_estab,
                                              Input antecip_pef_pend.cod_espec_docto,
                                              Input antecip_pef_pend.cod_ser_docto,
                                              Input antecip_pef_pend.cdn_fornecedor,
                                              Input antecip_pef_pend.cod_tit_ap,
                                              Input antecip_pef_pend.cod_parcela,
                                              Input p_cod_refer,
                                              Input v_des_msg_erro_1,
                                              Input antecip_pef_pend.cod_estab,
                                              Input p_num_seq) /*pi_verifica_msg_erro*/.
                    assign v_log_erro_valid = no.
                end.
                else do:
                    find first cta_corren_cta_ctbl no-lock
                         where cta_corren_cta_ctbl.cod_cta_corren               = cta_corren_compos_mutuo.cod_cta_corren_mutuo
                           and cta_corren_cta_ctbl.ind_finalid_ctbl_cta_corren  = "Principal Ativo" /*l_principal_ativo*/ 
                           and cta_corren_cta_ctbl.dat_inic_valid              <= antecip_pef_pend.dat_emis_docto
                           and cta_corren_cta_ctbl.dat_fim_valid               >= antecip_pef_pend.dat_emis_docto
                          no-error.
                    if  not avail cta_corren_cta_ctbl
                    then do:
                        assign v_des_msg_erro_1 = substitute( getStrTrans("Conta de &1 Inexistente para a Conta Corrente &2 !", "APB") /*9463*/, getStrTrans("Principal Ativo", "APB") /*l_principal_ativo*/ , cta_corren_compos_mutuo.cod_cta_corren_mutuo).
                        run pi_verifica_msg_erro (Input antecip_pef_pend.cod_estab,
                                                  Input antecip_pef_pend.cod_espec_docto,
                                                  Input antecip_pef_pend.cod_ser_docto,
                                                  Input antecip_pef_pend.cdn_fornecedor,
                                                  Input antecip_pef_pend.cod_tit_ap,
                                                  Input antecip_pef_pend.cod_parcela,
                                                  Input p_cod_refer,
                                                  Input v_des_msg_erro_1,
                                                  Input antecip_pef_pend.cod_estab,
                                                  Input p_num_seq) /*pi_verifica_msg_erro*/.
                        assign v_log_erro_valid = no.
                    end.
                end.
            end.
            else do:
                &if '{&emsfin_version}' <= '5.05' &then
                    find first cta_corren_cta_ctbl no-lock
                         where cta_corren_cta_ctbl.cod_cta_corren               = entry(6,antecip_pef_pend.cod_livre_1,chr(10))
                           and cta_corren_cta_ctbl.ind_finalid_ctbl_cta_corren  = "Principal Ativo" /*l_principal_ativo*/ 
                           and cta_corren_cta_ctbl.dat_inic_valid              <= antecip_pef_pend.dat_emis_docto
                           and cta_corren_cta_ctbl.dat_fim_valid               >= antecip_pef_pend.dat_emis_docto
                          no-error.
                &endif.
                &if '{&emsfin_version}' >= '5.06' &then
                    find first cta_corren_cta_ctbl no-lock
                         where cta_corren_cta_ctbl.cod_cta_corren               = antecip_pef_pend.cod_cta_corren_mutuo
                           and cta_corren_cta_ctbl.ind_finalid_ctbl_cta_corren  = "Principal Ativo" /*l_principal_ativo*/ 
                           and cta_corren_cta_ctbl.dat_inic_valid              <= antecip_pef_pend.dat_emis_docto
                           and cta_corren_cta_ctbl.dat_fim_valid               >= antecip_pef_pend.dat_emis_docto
                          no-error.
                &endif.
                if  not avail cta_corren_cta_ctbl
                then do:
                    &if '{&emsfin_version}' <= '5.05' &then
                        assign v_des_msg_erro_1 = substitute( getStrTrans("Conta de &1 Inexistente para a Conta Corrente &2 !", "APB") /*9463*/, getStrTrans("Principal Ativo", "APB") /*l_principal_ativo*/ , entry(6,antecip_pef_pend.cod_livre_1,chr(10))).
                    &endif.
                    &if '{&emsfin_version}' >= '5.06' &then
                        assign v_des_msg_erro_1 = substitute( getStrTrans("Conta de &1 Inexistente para a Conta Corrente &2 !", "APB") /*9463*/, getStrTrans("Principal Ativo", "APB") /*l_principal_ativo*/ , antecip_pef_pend.cod_cta_corren_mutuo).
                    &endif.
                    run pi_verifica_msg_erro (Input antecip_pef_pend.cod_estab,
                                              Input antecip_pef_pend.cod_espec_docto,
                                              Input antecip_pef_pend.cod_ser_docto,
                                              Input antecip_pef_pend.cdn_fornecedor,
                                              Input antecip_pef_pend.cod_tit_ap,
                                              Input antecip_pef_pend.cod_parcela,
                                              Input p_cod_refer,
                                              Input v_des_msg_erro_1,
                                              Input antecip_pef_pend.cod_estab,
                                              Input p_num_seq) /*pi_verifica_msg_erro*/.
                    assign v_log_erro_valid = no.
                end /* if */.
                &if '{&emsfin_version}' <= '5.05' &then
                    find first cta_corren_cta_ctbl no-lock
                         where cta_corren_cta_ctbl.cod_cta_corren               = entry(6,antecip_pef_pend.cod_livre_1,chr(10))
                           and cta_corren_cta_ctbl.ind_finalid_ctbl_cta_corren  = "Principal Ativo" /*l_principal_ativo*/ 
                           and cta_corren_cta_ctbl.dat_inic_valid              <= antecip_pef_pend.dat_emis_docto
                           and cta_corren_cta_ctbl.dat_fim_valid               >= antecip_pef_pend.dat_emis_docto
                          no-error.
                &endif.
                &if '{&emsfin_version}' >= '5.06' &then
                    find first cta_corren_cta_ctbl no-lock
                         where cta_corren_cta_ctbl.cod_cta_corren               = antecip_pef_pend.cod_cta_corren_mutuo
                           and cta_corren_cta_ctbl.ind_finalid_ctbl_cta_corren  = "Principal Ativo" /*l_principal_ativo*/ 
                           and cta_corren_cta_ctbl.dat_inic_valid              <= antecip_pef_pend.dat_emis_docto
                           and cta_corren_cta_ctbl.dat_fim_valid               >= antecip_pef_pend.dat_emis_docto
                          no-error.
                &endif.
                if  not avail cta_corren_cta_ctbl
                then do:
                    &if '{&emsfin_version}' <= '5.05' &then
                        assign v_des_msg_erro_1 = substitute( getStrTrans("Conta de &1 Inexistente para a Conta Corrente &2 !", "APB") /*9463*/, getStrTrans("Principal Ativo", "APB") /*l_principal_ativo*/ , entry(6,antecip_pef_pend.cod_livre_1,chr(10))).
                    &endif.
                    &if '{&emsfin_version}' >= '5.06' &then
                        assign v_des_msg_erro_1 = substitute( getStrTrans("Conta de &1 Inexistente para a Conta Corrente &2 !", "APB") /*9463*/, getStrTrans("Principal Ativo", "APB") /*l_principal_ativo*/ , antecip_pef_pend.cod_cta_corren_mutuo).
                    &endif.
                    run pi_verifica_msg_erro (Input antecip_pef_pend.cod_estab,
                                              Input antecip_pef_pend.cod_espec_docto,
                                              Input antecip_pef_pend.cod_ser_docto,
                                              Input antecip_pef_pend.cdn_fornecedor,
                                              Input antecip_pef_pend.cod_tit_ap,
                                              Input antecip_pef_pend.cod_parcela,
                                              Input p_cod_refer,
                                              Input v_des_msg_erro_1,
                                              Input antecip_pef_pend.cod_estab,
                                              Input p_num_seq) /*pi_verifica_msg_erro*/.
                    assign v_log_erro_valid = no.
                end.
            end.
        end.
    end.
END PROCEDURE. /* pi_valida_contas_principal_ativo_mutuo */
/*****************************************************************************
** Procedure Interna.....: pi_verifica_contas_impto_retido_pagto
** Descricao.............: pi_verifica_contas_impto_retido_pagto
** Criado por............: rafael
** Criado em.............: 08/11/1996 17:31:25
** Alterado por..........: fut43120
** Alterado em...........: 27/01/2009 10:34:44
*****************************************************************************/
PROCEDURE pi_verifica_contas_impto_retido_pagto:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_estab_refer
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def Input param p_cod_refer
        as character
        format "x(10)"
        no-undo.
    def Input param p_num_seq_refer
        as integer
        format ">>>9"
        no-undo.
    def Input param p_dat_transacao
        as date
        format "99/99/9999"
        no-undo.
    def output param p_cod_return
        as character
        format "x(40)"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_cod_finalid_econ
        as character
        format "x(10)":U
        label "Finalidade Econìmica"
        column-label "Finalidade Econìmica"
        no-undo.


    /************************** Variable Definition End *************************/

    assign p_cod_return = "OK" /*l_ok*/ .

    impostos:
    for each impto_impl_pend_ap
        where impto_impl_pend_ap.cod_estab_refer = p_cod_estab_refer
        and   impto_impl_pend_ap.cod_refer       = p_cod_refer
        and   impto_impl_pend_ap.num_seq_refer   = p_num_seq_refer no-lock
        use-index imptmplp_lote:
        find fornecedor
            where fornecedor.cod_empresa    = impto_impl_pend_ap.cod_empresa
            and   fornecedor.cdn_fornecedor = impto_impl_pend_ap.cdn_fornec_favorec no-lock no-error.
        run pi_retornar_finalid_indic_econ (Input impto_impl_pend_ap.cod_indic_econ,
                                            Input p_dat_transacao,
                                            output v_cod_finalid_econ) /*pi_retornar_finalid_indic_econ*/.
        find first cta_grp_fornec
            where cta_grp_fornec.cod_empresa         = impto_impl_pend_ap.cod_empresa
            and   cta_grp_fornec.cod_espec_docto     = impto_impl_pend_ap.cod_espec_docto
            and   cta_grp_fornec.ind_tip_espec_docto = "Nenhum" /*l_nenhum*/ 
            and   cta_grp_fornec.cod_grp_fornec      = fornecedor.cod_grp_fornec
            and   cta_grp_fornec.cod_finalid_econ    = v_cod_finalid_econ
            and   cta_grp_fornec.ind_finalid_ctbl    = "Saldo" /*l_saldo*/ 
            and   cta_grp_fornec.dat_inic_valid     <= p_dat_transacao
            and   cta_grp_fornec.dat_fim_valid      >= p_dat_transacao no-lock no-error.
        if  not avail cta_grp_fornec
        then do:
            find first cta_grp_fornec
                where cta_grp_fornec.cod_empresa         = impto_impl_pend_ap.cod_empresa
                and   cta_grp_fornec.cod_espec_docto     = ""
                and   cta_grp_fornec.ind_tip_espec_docto = "Imposto Retido" /*l_imposto_retido*/ 
                and   cta_grp_fornec.cod_grp_fornec      = fornecedor.cod_grp_fornec
                and   cta_grp_fornec.cod_finalid_econ    = v_cod_finalid_econ
                and   cta_grp_fornec.ind_finalid_ctbl    = "Saldo" /*l_saldo*/ 
                and   cta_grp_fornec.dat_inic_valid     <= p_dat_transacao
                and   cta_grp_fornec.dat_fim_valid      >= p_dat_transacao no-lock no-error.
            if  not avail cta_grp_fornec
            then do:
                if  p_cod_return = "OK" /*l_ok*/ 
                then do:
                    assign p_cod_return = "Saldo" /*l_saldo*/                         + "," +
                                          impto_impl_pend_ap.cod_espec_docto + "," +
                                          fornecedor.cod_grp_fornec          + "," +
                                          v_cod_finalid_econ.
                end /* if */.
                else do:
                    assign p_cod_return = p_cod_return                       + "," +
                                          "Saldo" /*l_saldo*/                         + "," +
                                          impto_impl_pend_ap.cod_espec_docto + "," +
                                          fornecedor.cod_grp_fornec          + "," +
                                          v_cod_finalid_econ.
                end /* else */.
            end /* if */.
        end /* if */.

        if avail cta_grp_fornec then do:
           for each  aprop_ctbl_pend_ap no-lock
               where aprop_ctbl_pend_ap.cod_estab = antecip_pef_pend.cod_estab
               and   aprop_ctbl_pend_ap.cod_refer = antecip_pef_pend.cod_refer:
               if can-find(cta_restric_unid_negoc where
                           cta_restric_unid_negoc.cod_unid_organ     = aprop_ctbl_pend_ap.cod_empresa and
                           cta_restric_unid_negoc.cod_plano_cta_ctbl = cta_grp_fornec.cod_plano_cta_ctbl and
                           cta_restric_unid_negoc.cod_cta_ctbl       = cta_grp_fornec.cod_cta_ctbl and
                           cta_restric_unid_negoc.cod_unid_negoc     = aprop_ctbl_pend_ap.cod_unid_negoc) then do:
                  if  p_cod_return = "OK" /*l_ok*/ 
                  then do:
                      assign p_cod_return = '8489'                   + "," +
                                            "Unidade de Neg¢cio" /*l_unidade_de_negocio*/  + "," +
                                            cta_grp_fornec.cod_cta_ctbl + "," +
                                            aprop_ctbl_pend_ap.cod_unid_negoc + "," +
                                            "na" /*l_na*/ .
                  end /* if */.
                  else do:
                      assign p_cod_return = p_cod_return             + "," +
                                            '8489'                   + "," +
                                            "Unidade de Neg¢cio" /*l_unidade_de_negocio*/  + "," +
                                            cta_grp_fornec.cod_cta_ctbl + "," +
                                            aprop_ctbl_pend_ap.cod_unid_negoc + "," +
                                            "na" /*l_na*/ .
                  end /* else */.
               end.
           end.
        end.

        find first cta_grp_fornec
            where cta_grp_fornec.cod_empresa         = impto_impl_pend_ap.cod_empresa
            and   cta_grp_fornec.cod_espec_docto     = impto_impl_pend_ap.cod_espec_docto
            and   cta_grp_fornec.ind_tip_espec_docto = "Nenhum" /*l_nenhum*/ 
            and   cta_grp_fornec.cod_grp_fornec      = fornecedor.cod_grp_fornec
            and   cta_grp_fornec.cod_finalid_econ    = v_cod_finalid_econ
            and   cta_grp_fornec.ind_finalid_ctbl    = "Transit¢ria de IR" /*l_transitoria_de_ir*/ 
            and   cta_grp_fornec.dat_inic_valid     <= p_dat_transacao
            and   cta_grp_fornec.dat_fim_valid      >= p_dat_transacao no-lock no-error.
        if  not avail cta_grp_fornec
        then do:
            find first cta_grp_fornec
                where cta_grp_fornec.cod_empresa         = impto_impl_pend_ap.cod_empresa
                and   cta_grp_fornec.cod_espec_docto     = ""
                and   cta_grp_fornec.ind_tip_espec_docto = "Imposto Retido" /*l_imposto_retido*/ 
                and   cta_grp_fornec.cod_grp_fornec      = fornecedor.cod_grp_fornec
                and   cta_grp_fornec.cod_finalid_econ    = v_cod_finalid_econ
                and   cta_grp_fornec.ind_finalid_ctbl    = "Transit¢ria de IR" /*l_transitoria_de_ir*/ 
                and   cta_grp_fornec.dat_inic_valid     <= p_dat_transacao
                and   cta_grp_fornec.dat_fim_valid      >= p_dat_transacao no-lock no-error.
            if  not avail cta_grp_fornec
            then do:
                if  p_cod_return = "OK" /*l_ok*/ 
                then do:
                    assign p_cod_return = "Transit¢ria de IR" /*l_transitoria_de_ir*/             + "," +
                                          impto_impl_pend_ap.cod_espec_docto + "," +
                                          fornecedor.cod_grp_fornec          + "," +
                                          v_cod_finalid_econ.
                end /* if */.
                else do:
                    assign p_cod_return = p_cod_return                       + "," +
                                          "Transit¢ria de IR" /*l_transitoria_de_ir*/             + "," +
                                          impto_impl_pend_ap.cod_espec_docto + "," +
                                          fornecedor.cod_grp_fornec          + "," +
                                          v_cod_finalid_econ.
                end /* else */.
            end /* if */.
        end /* if */.
    end /* for impostos */.
END PROCEDURE. /* pi_verifica_contas_impto_retido_pagto */
/*****************************************************************************
** Procedure Interna.....: pi_verifica_cotac_parid
** Descricao.............: pi_verifica_cotac_parid
** Criado por............: Ganzen
** Criado em.............: 08/02/1996 17:54:22
** Alterado por..........: fut40574
** Alterado em...........: 06/06/2008 09:41:37
*****************************************************************************/
PROCEDURE pi_verifica_cotac_parid:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_unid_organ
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def Input param p_cod_indic_econ
        as character
        format "x(8)"
        no-undo.
    def Input param p_log_calc_val_pres
        as logical
        format "Sim/N∆o"
        no-undo.
    def Input param p_log_calc_variac_fasb
        as logical
        format "Sim/N∆o"
        no-undo.
    def Input param p_ind_calc_fasb
        as character
        format "X(10)"
        no-undo.
    def Input param p_dat_transacao
        as date
        format "99/99/9999"
        no-undo.
    def Input param p_dat_emis
        as date
        format "99/99/9999"
        no-undo.
    def Input param p_des_dat_vencto_tit
        as character
        format "x(550)"
        no-undo.
    def Input param p_des_dat_vencto_dupl
        as character
        format "x(550)"
        no-undo.
    def Input param p_log_view
        as logical
        format "Sim/N∆o"
        no-undo.
    def output param p_cod_return
        as character
        format "x(40)"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_cod_return
        as character
        format "x(40)":U
        no-undo.
    def var v_dat_cotac_indic_econ
        as date
        format "99/99/9999":U
        initial today
        label "Data Cotaá∆o"
        column-label "Data Cotaá∆o"
        no-undo.
    def var v_log_erro
        as logical
        format "Sim/N∆o"
        initial yes
        no-undo.
    def var v_log_utiliz_ccc
        as logical
        format "Sim/N∆o"
        initial yes
        no-undo.
    def var v_log_utiliz_mc
        as logical
        format "Sim/N∆o"
        initial yes
        no-undo.
    def var v_num_count
        as integer
        format ">>>>,>>9":U
        no-undo.
    def var v_val_cotac_indic_econ
        as decimal
        format "->>,>>>,>>>,>>9.9999999999":U
        decimals 10
        label "Cotaá∆o"
        column-label "Cotaá∆o"
        no-undo.


    /************************** Variable Definition End *************************/



    assign p_cod_return = "OK" /*l_ok*/ .

    for each tt_erros_cotac_parid:
        delete tt_erros_cotac_parid.
    end.

    assign v_log_utiliz_mc  = yes
           v_log_utiliz_ccc = yes.

    unid_organ_block:
    for each finalid_unid_organ no-lock
     where finalid_unid_organ.cod_unid_organ = p_cod_unid_organ
       and finalid_unid_organ.dat_inic_valid <= p_dat_transacao
       and finalid_unid_organ.dat_fim_valid > p_dat_transacao /*cl_finalid_conver_val of finalid_unid_organ*/:
        find first histor_finalid_econ no-lock
         where histor_finalid_econ.cod_finalid_econ        = finalid_unid_organ.cod_finalid_econ
           and histor_finalid_econ.dat_inic_valid_finalid <= p_dat_transacao
           and histor_finalid_econ.dat_fim_valid_finalid  >  p_dat_transacao no-error.
        find compos_finalid no-lock use-index cmpsfnld_id
         where compos_finalid.cod_finalid_econ       = finalid_unid_organ.cod_finalid_econ
           and compos_finalid.dat_inic_valid_finalid = histor_finalid_econ.dat_inic_valid_finalid
           and compos_finalid.cod_indic_econ_base    = p_cod_indic_econ
           and compos_finalid.cod_indic_econ_idx     = histor_finalid_econ.cod_indic_econ
           and compos_finalid.dat_inic_valid        <= p_dat_transacao
           and compos_finalid.dat_fim_valid         >  p_dat_transacao no-error.
        if  avail compos_finalid
        then do:
            if  compos_finalid.cod_indic_econ_base = p_cod_indic_econ
            then do:
                find finalid_econ no-lock
                     where finalid_econ.cod_finalid_econ = compos_finalid.cod_finalid_econ
                      no-error.
                if  not avail finalid_econ
                or  finalid_econ.ind_armaz_val <> "M¢dulos" /*l_modulos*/  then do:
                    next unid_organ_block.
                end.
                find first compos_finalid_cmcmm no-lock
                     where compos_finalid_cmcmm.cod_finalid_econ = compos_finalid.cod_finalid_econ
                       and compos_finalid_cmcmm.cod_indic_econ_base = compos_finalid.cod_indic_econ_base
                       and compos_finalid_cmcmm.cod_indic_econ_idx = compos_finalid.cod_indic_econ_idx
                       and compos_finalid_cmcmm.dat_inic_valid_compos = compos_finalid.dat_inic_valid
                       and compos_finalid_cmcmm.dat_inic_valid_finalid = compos_finalid.dat_inic_valid_finalid

                       and compos_finalid_cmcmm.dat_inic_valid <= p_dat_transacao
                       and compos_finalid_cmcmm.dat_fim_valid > p_dat_transacao /*cl_param_ativo_compos of compos_finalid_cmcmm*/ no-error.
                if  avail compos_finalid_cmcmm
                then do:
                    /* forma_conver: */
                    case compos_finalid_cmcmm.ind_forma_conver:
                        when "Multimoeda" /*l_multimoeda*/ then multimoeda_block:
                         do:
                            if v_log_utiliz_mc = yes then do:
                                run pi_achar_cotac_indic_econ

                                (Input compos_finalid_cmcmm.cod_indic_econ_base,
                                                               Input compos_finalid_cmcmm.cod_indic_econ_idx,
                                                               Input p_dat_transacao,
                                                               Input "Real" /*l_real*/ ,
                                                               output v_dat_cotac_indic_econ,
                                                               output v_val_cotac_indic_econ,
                                                               output v_cod_return) /* pi_achar_cotac_indic_econ*/.
                                if  v_cod_return <> "OK" /*l_ok*/ 
                                then do:
                                    run pi_cria_tt_erros_cotac_parid (Input compos_finalid_cmcmm.cod_indic_econ_base,
                                                                      Input compos_finalid_cmcmm.cod_indic_econ_idx,
                                                                      Input v_cod_return) /*pi_cria_tt_erros_cotac_parid*/.
                                end.
                            end.
                        end /* do multimoeda_block */.

                        when "CMCAC" /*l_cmcac*/ then cmcac_block:
                         do:
                            if  v_log_utiliz_ccc = yes then do:
                                if  p_log_calc_val_pres = yes and date(p_des_dat_vencto_tit) > p_dat_transacao
                                then do:

                                    run pi_achar_cotac_indic_econ 

                                                                  (Input compos_finalid_cmcmm.cod_indic_econ_juros_base,
                                                                   Input compos_finalid_cmcmm.cod_indic_econ_juros_idx,
                                                                   Input p_dat_transacao,
                                                                   Input "Real" /*l_real*/ ,
                                                                   output v_dat_cotac_indic_econ,
                                                                   output v_val_cotac_indic_econ,
                                                                   output v_cod_return) /* pi_achar_cotac_indic_econ*/.

                                    if  v_cod_return <> "OK" /*l_ok*/ 
                                    then do:
                                        run pi_cria_tt_erros_cotac_parid (Input compos_finalid_cmcmm.cod_indic_econ_juros_base,
                                                                          Input compos_finalid_cmcmm.cod_indic_econ_juros_idx,
                                                                          Input v_cod_return) /*pi_cria_tt_erros_cotac_parid*/.
                                    end.
                                end.
                                run pi_achar_cotac_indic_econ

                                                              (Input compos_finalid_cmcmm.cod_indic_econ_base,
                                                               Input compos_finalid_cmcmm.cod_indic_econ_idx,
                                                               Input p_dat_transacao,
                                                               Input "Real" /*l_real*/ ,
                                                               output v_dat_cotac_indic_econ,
                                                               output v_val_cotac_indic_econ,
                                                               output v_cod_return) /* pi_achar_cotac_indic_econ*/.

                                if  v_cod_return <> "OK" /*l_ok*/ 
                                then do:
                                    run pi_cria_tt_erros_cotac_parid (Input compos_finalid_cmcmm.cod_indic_econ_base,
                                                                      Input compos_finalid_cmcmm.cod_indic_econ_idx,
                                                                      Input v_cod_return) /*pi_cria_tt_erros_cotac_parid*/.
                                end.
                            end.
                        end /* do cmcac_block */.

                        when "FASB" /*l_fasb*/ then fasb_block:
                         do:
                            if  v_log_utiliz_ccc = yes then do:
                                if  p_ind_calc_fasb = "Emiss∆o" /*l_emissao*/  or
                                    p_ind_calc_fasb = "Ambos" /*l_ambos*/ 
                                then do:
                                    run pi_achar_cotac_indic_econ 

                                                                  (Input compos_finalid_cmcmm.cod_indic_econ_base,
                                                                   Input compos_finalid_cmcmm.cod_indic_econ_idx,
                                                                   Input p_dat_emis,
                                                                   Input "Real" /*l_real*/ ,
                                                                   output v_dat_cotac_indic_econ,
                                                                   output v_val_cotac_indic_econ,
                                                                   output v_cod_return) /* pi_achar_cotac_indic_econ*/.                                
                                    if  v_cod_return <> "OK" /*l_ok*/ 
                                    then do:
                                        run pi_cria_tt_erros_cotac_parid (Input compos_finalid_cmcmm.cod_indic_econ_base,
                                                                          Input compos_finalid_cmcmm.cod_indic_econ_idx,
                                                                          Input v_cod_return) /*pi_cria_tt_erros_cotac_parid*/.
                                    end.

                                    run pi_achar_cotac_indic_econ 

                                                                  (Input compos_finalid_cmcmm.cod_indic_econ_cm_base,
                                                                   Input compos_finalid_cmcmm.cod_indic_econ_cm_idx,
                                                                   Input p_dat_emis,
                                                                   Input "Real" /*l_real*/ ,
                                                                   output v_dat_cotac_indic_econ,
                                                                   output v_val_cotac_indic_econ,
                                                                   output v_cod_return) /* pi_achar_cotac_indic_econ*/.
                                    if  v_cod_return <> "OK" /*l_ok*/ 
                                    then do:
                                        run pi_cria_tt_erros_cotac_parid (Input compos_finalid_cmcmm.cod_indic_econ_cm_base,
                                                                          Input compos_finalid_cmcmm.cod_indic_econ_cm_idx,
                                                                          Input v_cod_return) /*pi_cria_tt_erros_cotac_parid*/.
                                    end.

                                    if  compos_finalid_cmcmm.ind_orig_cotac_projtd = "Cotaá∆o Projetada" /*l_cotacao_projetada*/ 
                                    then do:
                                        if  p_ind_calc_fasb <> "Ambos" /*l_ambos*/ 
                                        then do:
                                            if  p_dat_emis <> date(p_des_dat_vencto_tit)
                                            then do:
                                                run pi_achar_cotac_indic_econ 

                                                                              (Input compos_finalid_cmcmm.cod_indic_econ_base,
                                                                               Input compos_finalid_cmcmm.cod_indic_econ_idx,
                                                                               Input date(p_des_dat_vencto_tit),
                                                                               Input "Projetada" /*l_projetada*/ ,
                                                                               output v_dat_cotac_indic_econ,
                                                                               output v_val_cotac_indic_econ,
                                                                               output v_cod_return) /* pi_achar_cotac_indic_econ*/.
                                                if  v_cod_return <> "OK" /*l_ok*/ 
                                                then do:
                                                    run pi_cria_tt_erros_cotac_parid (Input compos_finalid_cmcmm.cod_indic_econ_base,
                                                                                      Input compos_finalid_cmcmm.cod_indic_econ_idx,
                                                                                      Input v_cod_return) /*pi_cria_tt_erros_cotac_parid*/.
                                                end.
                                            end.
                                        end.
                                        else do:
                                            datdupl_block:
                                            do v_num_count = 1 to num-entries(p_des_dat_vencto_dupl):

                                                run pi_achar_cotac_indic_econ 

                                                                              (Input compos_finalid_cmcmm.cod_indic_econ_base,
                                                                               Input compos_finalid_cmcmm.cod_indic_econ_idx,
                                                                               Input date(entry(v_num_count,p_des_dat_vencto_dupl)),
                                                                               Input "Projetada" /*l_projetada*/ ,
                                                                               output v_dat_cotac_indic_econ,
                                                                               output v_val_cotac_indic_econ,
                                                                               output v_cod_return) /* pi_achar_cotac_indic_econ*/.

                                                if  v_cod_return <> "OK" /*l_ok*/ 
                                                then do:
                                                    run pi_cria_tt_erros_cotac_parid (Input compos_finalid_cmcmm.cod_indic_econ_base,
                                                                                      Input compos_finalid_cmcmm.cod_indic_econ_idx,
                                                                                      Input v_cod_return) /*pi_cria_tt_erros_cotac_parid*/.
                                                end.
                                            end /* do datdupl_block */.
                                        end.
                                    end.
                                    else do:
                                        run pi_achar_cotac_indic_econ 

                                                                      (Input compos_finalid_cmcmm.cod_indic_econ_projec_base,
                                                                       Input compos_finalid_cmcmm.cod_indic_econ_projec_idx,
                                                                       Input p_dat_emis,
                                                                       Input "Projetada" /*l_projetada*/ ,
                                                                       output v_dat_cotac_indic_econ,
                                                                       output v_val_cotac_indic_econ,
                                                                       output v_cod_return) /* pi_achar_cotac_indic_econ*/.

                                        if  v_cod_return <> "OK" /*l_ok*/ 
                                        then do:
                                            run pi_cria_tt_erros_cotac_parid (Input compos_finalid_cmcmm.cod_indic_econ_projec_base,
                                                                              Input compos_finalid_cmcmm.cod_indic_econ_projec_idx,
                                                                              Input v_cod_return) /*pi_cria_tt_erros_cotac_parid*/.
                                        end.
                                        if  p_ind_calc_fasb <> "Ambos" /*l_ambos*/ 
                                        then do:
                                            run pi_achar_cotac_indic_econ 

                                                                          (Input compos_finalid_cmcmm.cod_indic_econ_projec_base,
                                                                           Input compos_finalid_cmcmm.cod_indic_econ_projec_idx,
                                                                           Input date(p_des_dat_vencto_tit),
                                                                           Input "Projetada" /*l_projetada*/ ,
                                                                           output v_dat_cotac_indic_econ,
                                                                           output v_val_cotac_indic_econ,
                                                                           output v_cod_return) /* pi_achar_cotac_indic_econ*/.
                                            if  v_cod_return <> "OK" /*l_ok*/ 
                                            then do:
                                                run pi_cria_tt_erros_cotac_parid (Input compos_finalid_cmcmm.cod_indic_econ_projec_base,
                                                                                  Input compos_finalid_cmcmm.cod_indic_econ_projec_idx,
                                                                                  Input v_cod_return) /*pi_cria_tt_erros_cotac_parid*/.
                                            end.
                                         end.
                                         else do:
                                             datdupl_block:
                                             do v_num_count = 1 to num-entries(p_des_dat_vencto_dupl):
                                                 run pi_achar_cotac_indic_econ 

                                                                               (Input compos_finalid_cmcmm.cod_indic_econ_projec_base,
                                                                                Input compos_finalid_cmcmm.cod_indic_econ_projec_idx,
                                                                                Input date(entry(v_num_count,p_des_dat_vencto_dupl)),
                                                                                Input "Projetada" /*l_projetada*/ ,
                                                                                output v_dat_cotac_indic_econ,
                                                                                output v_val_cotac_indic_econ,
                                                                                output v_cod_return) /* pi_achar_cotac_indic_econ*/.
                                                 if  v_cod_return <> "OK" /*l_ok*/ 
                                                 then do:
                                                     run pi_cria_tt_erros_cotac_parid (Input compos_finalid_cmcmm.cod_indic_econ_projec_base,
                                                                                       Input compos_finalid_cmcmm.cod_indic_econ_projec_idx,
                                                                                       Input v_cod_return) /*pi_cria_tt_erros_cotac_parid*/.
                                                 end.
                                             end /* do datdupl_block */.
                                         end.
                                    end.
                                end.
                                if  p_ind_calc_fasb = "Pagto" /*l_pagto*/  or
                                    p_ind_calc_fasb = "Ambos" /*l_ambos*/ 
                                then do:
                                    run pi_achar_cotac_indic_econ 

                                                                  (Input compos_finalid_cmcmm.cod_indic_econ_base,
                                                                   Input compos_finalid_cmcmm.cod_indic_econ_idx,
                                                                   Input p_dat_transacao,
                                                                   Input "Real" /*l_real*/ ,
                                                                   output v_dat_cotac_indic_econ,
                                                                   output v_val_cotac_indic_econ,
                                                                   output v_cod_return) /* pi_achar_cotac_indic_econ*/.
                                    if  v_cod_return <> "OK" /*l_ok*/ 
                                    then do:
                                        run pi_cria_tt_erros_cotac_parid (Input compos_finalid_cmcmm.cod_indic_econ_base,
                                                                          Input compos_finalid_cmcmm.cod_indic_econ_idx,
                                                                          Input v_cod_return) /*pi_cria_tt_erros_cotac_parid*/.
                                    end.
                                end.
                                if  p_log_calc_variac_fasb = yes
                                then do:
                                    if  p_ind_calc_fasb = "Ambos" /*l_ambos*/ 
                                    then do:
                                        dat_block:
                                        do v_num_count = 1 to num-entries(p_des_dat_vencto_tit):
                                            run pi_achar_cotac_indic_econ 

                                                                          (Input compos_finalid_cmcmm.cod_indic_econ_base,
                                                                           Input compos_finalid_cmcmm.cod_indic_econ_idx,
                                                                           Input date(entry(v_num_count,p_des_dat_vencto_tit)),
                                                                           Input "Real" /*l_real*/ ,
                                                                           output v_dat_cotac_indic_econ,
                                                                           output v_val_cotac_indic_econ,
                                                                           output v_cod_return) /* pi_achar_cotac_indic_econ*/.                                    
                                            if  v_cod_return <> "OK" /*l_ok*/ 
                                            then do:
                                                run pi_cria_tt_erros_cotac_parid (Input compos_finalid_cmcmm.cod_indic_econ_base,
                                                                                  Input compos_finalid_cmcmm.cod_indic_econ_idx,
                                                                                  Input v_cod_return) /*pi_cria_tt_erros_cotac_parid*/.
                                            end.
                                        end /* do dat_block */.
                                    end.
                                    else do:
                                        run pi_achar_cotac_indic_econ

                                                                      (Input compos_finalid_cmcmm.cod_indic_econ_base,
                                                                       Input compos_finalid_cmcmm.cod_indic_econ_idx,
                                                                       Input date(p_des_dat_vencto_tit),
                                                                       Input "Real" /*l_real*/ ,
                                                                       output v_dat_cotac_indic_econ,
                                                                       output v_val_cotac_indic_econ,
                                                                       output v_cod_return) /* pi_achar_cotac_indic_econ*/.
                                        if  v_cod_return <> "OK" /*l_ok*/ 
                                        then do:
                                            run pi_cria_tt_erros_cotac_parid (Input compos_finalid_cmcmm.cod_indic_econ_base,
                                                                              Input compos_finalid_cmcmm.cod_indic_econ_idx,
                                                                              Input v_cod_return) /*pi_cria_tt_erros_cotac_parid*/.
                                        end.
                                    end.
                                    run pi_achar_cotac_indic_econ

                                                                  (Input compos_finalid_cmcmm.cod_indic_econ_base,
                                                                   Input compos_finalid_cmcmm.cod_indic_econ_idx,
                                                                   Input p_dat_transacao,
                                                                   Input "Real" /*l_real*/ ,
                                                                   output v_dat_cotac_indic_econ,
                                                                   output v_val_cotac_indic_econ,
                                                                   output v_cod_return) /* pi_achar_cotac_indic_econ*/.
                                    if  v_cod_return <> "OK" /*l_ok*/ 
                                    then do:
                                        run pi_cria_tt_erros_cotac_parid (Input compos_finalid_cmcmm.cod_indic_econ_base,
                                                                          Input compos_finalid_cmcmm.cod_indic_econ_idx,
                                                                          Input v_cod_return) /*pi_cria_tt_erros_cotac_parid*/.
                                    end.
                                end.
                            end.
                        end /* do fasb_block */.
                    end /* case forma_conver */.
                end.
                else do:
                    assign v_log_method = session:set-wait-state("")
                           p_cod_return = "1745," +
                                          compos_finalid.cod_indic_econ_base + "," +
                                          compos_finalid.cod_indic_econ_idx.
                end.
            end.
        end /* for composicao */.
    end /* for unid_organ_block */.



    find first tt_erros_cotac_parid no-lock no-error.
    if  avail tt_erros_cotac_parid
    then do:
       assign v_log_method = session:set-wait-state("")
              p_cod_return = "NOK" /*l_nok*/ .

       if  p_log_view then do:
           run pi_mostra_erros_cotac_parid /*pi_mostra_erros_cotac_parid*/.
       end.
    end.

END PROCEDURE. /* pi_verifica_cotac_parid */
/*****************************************************************************
** Procedure Interna.....: pi_achar_cotac_indic_econ
** Descricao.............: pi_achar_cotac_indic_econ
** Criado por............: vladimir
** Criado em.............: // 
** Alterado por..........: fut1309_4
** Alterado em...........: 08/02/2006 16:12:34
*****************************************************************************/
PROCEDURE pi_achar_cotac_indic_econ:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_indic_econ_base
        as character
        format "x(8)"
        no-undo.
    def Input param p_cod_indic_econ_idx
        as character
        format "x(8)"
        no-undo.
    def Input param p_dat_transacao
        as date
        format "99/99/9999"
        no-undo.
    def Input param p_ind_tip_cotac_parid
        as character
        format "X(09)"
        no-undo.
    def output param p_dat_cotac_indic_econ
        as date
        format "99/99/9999"
        no-undo.
    def output param p_val_cotac_indic_econ
        as decimal
        format ">>>>,>>9.9999999999"
        decimals 10
        no-undo.
    def output param p_cod_return
        as character
        format "x(40)"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_dat_cotac_mes
        as date
        format "99/99/9999":U
        no-undo.
    def var v_log_indic
        as logical
        format "Sim/N∆o"
        initial no
        no-undo.
    def var v_cod_indic_econ_orig            as character       no-undo. /*local*/
    def var v_val_cotac_indic_econ_base      as decimal         no-undo. /*local*/
    def var v_val_cotac_indic_econ_idx       as decimal         no-undo. /*local*/


    /************************** Variable Definition End *************************/

    /* alteraá∆o sob demanda da atividade 148.681*/
    release cotac_parid.

    if  p_cod_indic_econ_base = p_cod_indic_econ_idx
    then do:
        /* **
         Quando a Base e o ÷ndice forem iguais, significa que a cotaá∆o pode ser percentual,
         portanto n∆o basta apenas retornar 1 e deve ser feita toda a pesquisa abaixo para
         encontrar a taxa da moeda no dia informado.
         Exemplo: D¢lar - D¢lar, poder°amos retornar 1
                  ANBID - ANBID, devemos retornar a taxa do dia.
        ***/
        find indic_econ no-lock
             where indic_econ.cod_indic_econ  = p_cod_indic_econ_base
               and indic_econ.dat_inic_valid <= p_dat_transacao
               and indic_econ.dat_fim_valid  >  p_dat_transacao
             no-error.
        if  avail indic_econ then do:
            if  indic_econ.ind_tip_cotac = "Valor" /*l_valor*/  then do:
                assign p_dat_cotac_indic_econ = p_dat_transacao
                       p_val_cotac_indic_econ = 1
                       p_cod_return           = "OK" /*l_ok*/ .
            end.
            else do:
                find cotac_parid no-lock
                     where cotac_parid.cod_indic_econ_base = p_cod_indic_econ_base
                       and cotac_parid.cod_indic_econ_idx = p_cod_indic_econ_idx
                       and cotac_parid.dat_cotac_indic_econ = p_dat_transacao
                       and cotac_parid.ind_tip_cotac_parid = p_ind_tip_cotac_parid
    &if "{&emsuni_version}" >= "5.01" &then
                     use-index ctcprd_id
    &endif
                      /*cl_acha_cotac of cotac_parid*/ no-error.
                if  not avail cotac_parid
                then do:
                    find parid_indic_econ no-lock
                         where parid_indic_econ.cod_indic_econ_base = p_cod_indic_econ_base
                           and parid_indic_econ.cod_indic_econ_idx = p_cod_indic_econ_idx
    &if "{&emsuni_version}" >= "5.01" &then
                         use-index prdndccn_id
    &endif
                          /*cl_acha_parid_param of parid_indic_econ*/ no-error.
                    /* block: */
                    case parid_indic_econ.ind_criter_busca:
                        when "Anterior" /*l_anterior*/ then find prev cotac_parid no-lock
                              where cotac_parid.cod_indic_econ_base = p_cod_indic_econ_base
                                and cotac_parid.cod_indic_econ_idx = p_cod_indic_econ_idx
                                and cotac_parid.dat_cotac_indic_econ < p_dat_transacao
                                and cotac_parid.ind_tip_cotac_parid = p_ind_tip_cotac_parid
                                and cotac_parid.val_cotac_indic_econ <> 0.0
    &if "{&emsuni_version}" >= "5.01" &then
                              use-index ctcprd_id
    &endif
                               /*cl_acha_cotac_anterior of cotac_parid*/ no-error.
                        when "Pr¢ximo" /*l_proximo*/ then  find next cotac_parid no-lock
                               where cotac_parid.cod_indic_econ_base = p_cod_indic_econ_base
                                 and cotac_parid.cod_indic_econ_idx = p_cod_indic_econ_idx
                                 and cotac_parid.dat_cotac_indic_econ > p_dat_transacao
                                 and cotac_parid.ind_tip_cotac_parid = p_ind_tip_cotac_parid
                                 and cotac_parid.val_cotac_indic_econ <> 0.0
    &if "{&emsuni_version}" >= "5.01" &then
                               use-index ctcprd_id
    &endif
                                /*cl_acha_cotac_posterior of cotac_parid*/ no-error.
                    end /* case block */.
                    if  not avail cotac_parid
                    then do:
                        assign p_cod_return = "358"                   + "," +
                                              p_cod_indic_econ_base   + "," +
                                              p_cod_indic_econ_idx    + "," +
                                              string(p_dat_transacao) + "," +
                                              p_ind_tip_cotac_parid.
                    end /* if */.
                    else do:
                        assign p_dat_cotac_indic_econ = cotac_parid.dat_cotac_indic_econ
                               p_val_cotac_indic_econ = cotac_parid.val_cotac_indic_econ
                               p_cod_return           = "OK" /*l_ok*/ .
                    end /* else */.
                end /* if */.
                else do:
                    assign p_dat_cotac_indic_econ = cotac_parid.dat_cotac_indic_econ
                           p_val_cotac_indic_econ = cotac_parid.val_cotac_indic_econ
                           p_cod_return           = "OK" /*l_ok*/ .
                end /* else */.
            end.
        end.
        else do:
            assign p_cod_return = "335".
        end.
    end /* if */.
    else do:
        find parid_indic_econ no-lock
             where parid_indic_econ.cod_indic_econ_base = p_cod_indic_econ_base
               and parid_indic_econ.cod_indic_econ_idx = p_cod_indic_econ_idx
             use-index prdndccn_id no-error.
        if  avail parid_indic_econ
        then do:


            /* Begin_Include: i_verifica_cotac_parid */
            /* verifica as cotacoes da moeda p_cod_indic_econ_base para p_cod_indic_econ_idx 
              cadastrada na base, de acordo com a periodicidade da cotacao (obtida na 
              parid_indic_econ, que deve estar avail)*/

            /* period_block: */
            case parid_indic_econ.ind_periodic_cotac:
                when "Di†ria" /*l_diaria*/ then
                    diaria_block:
                    do:
                        find cotac_parid no-lock
                            where cotac_parid.cod_indic_econ_base  = p_cod_indic_econ_base
                              and cotac_parid.cod_indic_econ_idx   = p_cod_indic_econ_idx
                              and cotac_parid.dat_cotac_indic_econ = p_dat_transacao
                              and cotac_parid.ind_tip_cotac_parid  = p_ind_tip_cotac_parid
                            use-index ctcprd_id no-error.
                        if  not avail cotac_parid or cotac_parid.val_cotac_indic_econ = 0
                        then do:
                            find parid_indic_econ no-lock
                                where parid_indic_econ.cod_indic_econ_base = p_cod_indic_econ_base
                                  and parid_indic_econ.cod_indic_econ_idx  = p_cod_indic_econ_idx
                                use-index prdndccn_id no-error.
                            /* block: */
                            case parid_indic_econ.ind_criter_busca:
                                when "Anterior" /*l_anterior*/ then 

                                    find prev cotac_parid no-lock
                                        where cotac_parid.cod_indic_econ_base  = p_cod_indic_econ_base
                                          and cotac_parid.cod_indic_econ_idx   = p_cod_indic_econ_idx
                                          and cotac_parid.dat_cotac_indic_econ < p_dat_transacao
                                          and cotac_parid.ind_tip_cotac_parid  = p_ind_tip_cotac_parid
                                          and cotac_parid.val_cotac_indic_econ <> 0.0
                                          &if '{&emsuni_version}' >= '5.01' &then
                                          use-index ctcprd_id
                                          &endif
                                          no-error.


                                when "Pr¢ximo" /*l_proximo*/ then  
                                    find next cotac_parid no-lock
                                        where cotac_parid.cod_indic_econ_base  = p_cod_indic_econ_base
                                          and cotac_parid.cod_indic_econ_idx   = p_cod_indic_econ_idx
                                          and cotac_parid.dat_cotac_indic_econ > p_dat_transacao
                                          and cotac_parid.ind_tip_cotac_parid  = p_ind_tip_cotac_parid
                                          and cotac_parid.val_cotac_indic_econ <> 0.0
                                          &if '{&emsuni_version}' >= '5.01' &then
                                          use-index ctcprd_id
                                          &endif
                                          no-error.
                            end /* case block */.
                        end /* if */.
                    end /* do diaria_block */.
                when "Mensal" /*l_mensal*/ then
                    mensal_block:
                    do:
                        assign v_dat_cotac_mes = date(month(p_dat_transacao), 1, year(p_dat_transacao))
                               &if yes = yes &then 
                               v_log_indic     = yes
                               &endif .
                        find cotac_parid no-lock
                            where cotac_parid.cod_indic_econ_base  = p_cod_indic_econ_base
                              and cotac_parid.cod_indic_econ_idx   = p_cod_indic_econ_idx
                              and cotac_parid.dat_cotac_indic_econ = v_dat_cotac_mes
                              and cotac_parid.ind_tip_cotac_parid  = p_ind_tip_cotac_parid
                            use-index ctcprd_id no-error.
                        if  not avail cotac_parid or cotac_parid.val_cotac_indic_econ = 0
                        then do:
                            /* block: */
                            case parid_indic_econ.ind_criter_busca:
                                when "Anterior" /*l_anterior*/ then
                                    find prev cotac_parid no-lock
                                        where cotac_parid.cod_indic_econ_base  = p_cod_indic_econ_base
                                          and cotac_parid.cod_indic_econ_idx   = p_cod_indic_econ_idx
                                          and cotac_parid.dat_cotac_indic_econ < v_dat_cotac_mes
                                          and cotac_parid.ind_tip_cotac_parid  = p_ind_tip_cotac_parid
                                          and cotac_parid.val_cotac_indic_econ <> 0.0
                                        use-index ctcprd_id no-error.
                                when "Pr¢ximo" /*l_proximo*/ then
                                    find next cotac_parid no-lock
                                        where cotac_parid.cod_indic_econ_base  = p_cod_indic_econ_base
                                          and cotac_parid.cod_indic_econ_idx   = p_cod_indic_econ_idx
                                          and cotac_parid.dat_cotac_indic_econ > v_dat_cotac_mes
                                          and cotac_parid.ind_tip_cotac_parid  = p_ind_tip_cotac_parid
                                          and cotac_parid.val_cotac_indic_econ <> 0.0
                                        use-index ctcprd_id no-error.
                            end /* case block */.
                        end /* if */.
                    end /* do mensal_block */.
                when "Bimestral" /*l_bimestral*/ then
                    bimestral_block:
                    do:
                    end /* do bimestral_block */.
                when "Trimestral" /*l_trimestral*/ then
                    trimestral_block:
                    do:
                    end /* do trimestral_block */.
                when "Quadrimestral" /*l_quadrimestral*/ then
                    quadrimestral_block:
                    do:
                    end /* do quadrimestral_block */.
                when "Semestral" /*l_semestral*/ then
                    semestral_block:
                    do:
                    end /* do semestral_block */.
                when "Anual" /*l_anual*/ then
                    anual_block:
                    do:
                    end /* do anual_block */.
            end /* case period_block */.
            /* End_Include: i_verifica_cotac_parid */


            if  parid_indic_econ.ind_orig_cotac_parid = "Outra Moeda" /*l_outra_moeda*/  and
                 parid_indic_econ.cod_finalid_econ_orig_cotac <> "" and
                 (not avail cotac_parid or cotac_parid.val_cotac_indic_econ = 0)
            then do:
                /* Cotaá∆o Ponte */
                run pi_retornar_indic_econ_finalid (Input parid_indic_econ.cod_finalid_econ_orig_cotac,
                                                    Input p_dat_transacao,
                                                    output v_cod_indic_econ_orig) /*pi_retornar_indic_econ_finalid*/.
                find parid_indic_econ no-lock
                    where parid_indic_econ.cod_indic_econ_base = v_cod_indic_econ_orig
                    and parid_indic_econ.cod_indic_econ_idx = p_cod_indic_econ_base
                    use-index prdndccn_id no-error.
                run pi_achar_cotac_indic_econ_2 (Input v_cod_indic_econ_orig,
                                                 Input p_cod_indic_econ_base,
                                                 Input p_dat_transacao,
                                                 Input p_ind_tip_cotac_parid,
                                                 Input p_cod_indic_econ_base,
                                                 Input p_cod_indic_econ_idx) /*pi_achar_cotac_indic_econ_2*/.

                if  avail cotac_parid and cotac_parid.val_cotac_indic_econ <> 0
                then do:
                    assign v_val_cotac_indic_econ_base = cotac_parid.val_cotac_indic_econ.
                    find parid_indic_econ no-lock
                        where parid_indic_econ.cod_indic_econ_base = v_cod_indic_econ_orig
                        and parid_indic_econ.cod_indic_econ_idx = p_cod_indic_econ_idx
                        use-index prdndccn_id no-error.
                    run pi_achar_cotac_indic_econ_2 (Input v_cod_indic_econ_orig,
                                                     Input p_cod_indic_econ_idx,
                                                     Input p_dat_transacao,
                                                     Input p_ind_tip_cotac_parid,
                                                     Input p_cod_indic_econ_base,
                                                     Input p_cod_indic_econ_idx) /*pi_achar_cotac_indic_econ_2*/.

                    if  avail cotac_parid and cotac_parid.val_cotac_indic_econ <> 0
                    then do:
                        assign v_val_cotac_indic_econ_idx = cotac_parid.val_cotac_indic_econ
                               p_val_cotac_indic_econ = v_val_cotac_indic_econ_idx / v_val_cotac_indic_econ_base
                               p_dat_cotac_indic_econ = cotac_parid.dat_cotac_indic_econ
                               p_cod_return = "OK" /*l_ok*/ .
                        return.
                    end /* if */.
                end /* if */.
            end /* if */.
            if  parid_indic_econ.ind_orig_cotac_parid = "Inversa" /*l_inversa*/  and
                 (not avail cotac_parid or cotac_parid.val_cotac_indic_econ = 0)
            then do:
                find parid_indic_econ no-lock
                    where parid_indic_econ.cod_indic_econ_base = p_cod_indic_econ_idx
                    and parid_indic_econ.cod_indic_econ_idx = p_cod_indic_econ_base
                    use-index prdndccn_id no-error.
                run pi_achar_cotac_indic_econ_2 (Input p_cod_indic_econ_idx,
                                                 Input p_cod_indic_econ_base,
                                                 Input p_dat_transacao,
                                                 Input p_ind_tip_cotac_parid,
                                                 Input p_cod_indic_econ_base,
                                                 Input p_cod_indic_econ_idx) /*pi_achar_cotac_indic_econ_2*/.

                if  avail cotac_parid and cotac_parid.val_cotac_indic_econ <> 0
                then do:
                    assign p_dat_cotac_indic_econ = cotac_parid.dat_cotac_indic_econ
                           p_val_cotac_indic_econ = 1 / cotac_parid.val_cotac_indic_econ
                           p_cod_return = "OK" /*l_ok*/ .
                    return.
                end /* if */.
            end /* if */.
        end /* if */.
        if v_log_indic = yes then do:
           if  not avail cotac_parid or cotac_parid.val_cotac_indic_econ = 0
           then do:
               assign p_cod_return = "358"                 + "," +
                      p_cod_indic_econ_base   + "," +
                      p_cod_indic_econ_idx    + "," +
                      string(v_dat_cotac_mes) + "," +
                      p_ind_tip_cotac_parid.
           end /* if */.
           else do:
               assign p_dat_cotac_indic_econ = cotac_parid.dat_cotac_indic_econ
                      p_val_cotac_indic_econ = cotac_parid.val_cotac_indic_econ
                      p_cod_return           = "OK" /*l_ok*/ .
           end /* else */.
        end.
        else do:   
           if  not avail cotac_parid or cotac_parid.val_cotac_indic_econ = 0
           then do:
               assign p_cod_return = "358"                 + "," +
                      p_cod_indic_econ_base   + "," +
                      p_cod_indic_econ_idx    + "," +
                      string(p_dat_transacao) + "," +
                      p_ind_tip_cotac_parid.
           end /* if */.
           else do:
               assign p_dat_cotac_indic_econ = cotac_parid.dat_cotac_indic_econ
                      p_val_cotac_indic_econ = cotac_parid.val_cotac_indic_econ
                      p_cod_return           = "OK" /*l_ok*/ .
           end /* else */.
        end.
        assign v_log_indic = no.
    end /* else */.
END PROCEDURE. /* pi_achar_cotac_indic_econ */
/*****************************************************************************
** Procedure Interna.....: pi_achar_cotac_indic_econ_2
** Descricao.............: pi_achar_cotac_indic_econ_2
** Criado por............: src531
** Criado em.............: 29/07/2003 11:10:10
** Alterado por..........: fut41061
** Alterado em...........: 21/07/2015 13:39:24
*****************************************************************************/
PROCEDURE pi_achar_cotac_indic_econ_2:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_param_1
        as character
        format "x(8)"
        no-undo.
    def Input param p_cod_param_2
        as character
        format "x(50)"
        no-undo.
    def Input param p_dat_transacao
        as date
        format "99/99/9999"
        no-undo.
    def Input param p_ind_tip_cotac_parid
        as character
        format "X(09)"
        no-undo.
    def Input param p_cod_indic_econ_base
        as character
        format "x(8)"
        no-undo.
    def Input param p_cod_indic_econ_idx
        as character
        format "x(8)"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_dat_cotac_mes                  as date            no-undo. /*local*/


    /************************** Variable Definition End *************************/

    /* period_block: */
    case parid_indic_econ.ind_periodic_cotac:
        when "Di†ria" /*l_diaria*/ then
            diaria_block:
            do:
                find cotac_parid no-lock
                     where cotac_parid.cod_indic_econ_base = p_cod_param_1
                       and cotac_parid.cod_indic_econ_idx = p_cod_param_2
                       and cotac_parid.dat_cotac_indic_econ = p_dat_transacao
                       and cotac_parid.ind_tip_cotac_parid = p_ind_tip_cotac_parid
                     use-index ctcprd_id no-error.
                if  not avail cotac_parid or cotac_parid.val_cotac_indic_econ = 0
                then do:
                    find parid_indic_econ no-lock
                         where parid_indic_econ.cod_indic_econ_base = p_cod_param_1
                           and parid_indic_econ.cod_indic_econ_idx = p_cod_param_2
                         use-index prdndccn_id no-error.
                    /* block: */
                    case parid_indic_econ.ind_criter_busca:
                        when "Anterior" /*l_anterior*/  then
                            find prev cotac_parid no-lock
                                where cotac_parid.cod_indic_econ_base   = p_cod_param_1
                                  and cotac_parid.cod_indic_econ_idx    = p_cod_param_2
                                  and cotac_parid.dat_cotac_indic_econ  < p_dat_transacao
                                  and cotac_parid.ind_tip_cotac_parid   = p_ind_tip_cotac_parid
                                  and cotac_parid.val_cotac_indic_econ <> 0.0 use-index ctcprd_id no-error.
                        when "Pr¢ximo" /*l_proximo*/  then
                            find next cotac_parid no-lock
                                where cotac_parid.cod_indic_econ_base   = p_cod_param_1
                                  and cotac_parid.cod_indic_econ_idx    = p_cod_param_2
                                  and cotac_parid.dat_cotac_indic_econ  > p_dat_transacao
                                  and cotac_parid.ind_tip_cotac_parid   = p_ind_tip_cotac_parid
                                  and cotac_parid.val_cotac_indic_econ <> 0.0 use-index ctcprd_id no-error.
                    end /* case block */.
                end /* if */.
            end /* do diaria_block */.
        when "Mensal" /*l_mensal*/ then
            mensal_block:
            do:
                assign v_dat_cotac_mes = date(month(p_dat_transacao), 1, year(p_dat_transacao)).
                find cotac_parid no-lock
                     where cotac_parid.cod_indic_econ_base = p_cod_param_1
                       and cotac_parid.cod_indic_econ_idx = p_cod_param_2
                       and cotac_parid.dat_cotac_indic_econ = v_dat_cotac_mes
                       and cotac_parid.ind_tip_cotac_parid = p_ind_tip_cotac_parid
                     use-index ctcprd_id no-error.
                if  not avail cotac_parid or cotac_parid.val_cotac_indic_econ = 0
                then do:
                    /* block: */
                    case parid_indic_econ.ind_criter_busca:
                        when "Anterior" /*l_anterior*/ then
                        find prev cotac_parid no-lock
                                           where cotac_parid.cod_indic_econ_base = p_cod_param_1
                                             and cotac_parid.cod_indic_econ_idx = p_cod_param_2
                                             and cotac_parid.dat_cotac_indic_econ < v_dat_cotac_mes
                                             and cotac_parid.ind_tip_cotac_parid = p_ind_tip_cotac_parid
                                             and cotac_parid.val_cotac_indic_econ <> 0.0
                                           use-index ctcprd_id no-error.
                        when "Pr¢ximo" /*l_proximo*/ then
                        find next cotac_parid no-lock
                                           where cotac_parid.cod_indic_econ_base = p_cod_param_1
                                             and cotac_parid.cod_indic_econ_idx = p_cod_param_2
                                             and cotac_parid.dat_cotac_indic_econ > v_dat_cotac_mes
                                             and cotac_parid.ind_tip_cotac_parid = p_ind_tip_cotac_parid
                                             and cotac_parid.val_cotac_indic_econ <> 0.0
                                           use-index ctcprd_id no-error.
                    end /* case block */.
                end /* if */.
            end /* do mensal_block */.
        when "Bimestral" /*l_bimestral*/ then
            bimestral_block:
            do:
            end /* do bimestral_block */.
        when "Trimestral" /*l_trimestral*/ then
            trimestral_block:
            do:
            end /* do trimestral_block */.
        when "Quadrimestral" /*l_quadrimestral*/ then
            quadrimestral_block:
            do:
            end /* do quadrimestral_block */.
        when "Semestral" /*l_semestral*/ then
            semestral_block:
            do:
            end /* do semestral_block */.
        when "Anual" /*l_anual*/ then
            anual_block:
            do:
            end /* do anual_block */.
    end /* case period_block */.
END PROCEDURE. /* pi_achar_cotac_indic_econ_2 */
/*****************************************************************************
** Procedure Interna.....: pi_cria_tt_erros_cotac_parid
** Descricao.............: pi_cria_tt_erros_cotac_parid
** Criado por............: Ganzen
** Criado em.............: 09/02/1996 18:38:03
** Alterado por..........: Ganzen
** Alterado em...........: 13/02/1996 08:01:03
*****************************************************************************/
PROCEDURE pi_cria_tt_erros_cotac_parid:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_indic_econ_base
        as character
        format "x(8)"
        no-undo.
    def Input param p_cod_indic_econ_idx
        as character
        format "x(8)"
        no-undo.
    def Input param p_cod_return
        as character
        format "x(40)"
        no-undo.


    /************************* Parameter Definition End *************************/

    find tt_erros_cotac_parid no-lock
         where tt_erros_cotac_parid.tta_cod_indic_econ_base = p_cod_indic_econ_base
           and tt_erros_cotac_parid.tta_cod_indic_econ_idx = p_cod_indic_econ_idx
           and tt_erros_cotac_parid.tta_dat_cotac_indic_econ = date(entry(4,p_cod_return))
           and tt_erros_cotac_parid.tta_ind_tip_cotac_parid = entry(5,p_cod_return)

         use-index tt_id_erros
          /*cl_acha_tt_erros of tt_erros_cotac_parid*/ no-error.
    if  not avail tt_erros_cotac_parid
    then do:
        create tt_erros_cotac_parid.
        assign tt_erros_cotac_parid.tta_cod_indic_econ_base  = p_cod_indic_econ_base
               tt_erros_cotac_parid.tta_cod_indic_econ_idx   = p_cod_indic_econ_idx
               tt_erros_cotac_parid.tta_dat_cotac_indic_econ = date(entry(4,p_cod_return))
               tt_erros_cotac_parid.tta_ind_tip_cotac_parid  = entry(5,p_cod_return).
    end /* if */.
END PROCEDURE. /* pi_cria_tt_erros_cotac_parid */
/*****************************************************************************
** Procedure Interna.....: pi_verifica_ctas_grp_fornec
** Descricao.............: pi_verifica_ctas_grp_fornec
** Criado por............: rafael
** Criado em.............: // 
** Alterado por..........: bre18791
** Alterado em...........: 06/01/2000 10:33:41
*****************************************************************************/
PROCEDURE pi_verifica_ctas_grp_fornec:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_empresa
        as character
        format "x(3)"
        no-undo.
    def Input param p_cod_espec_docto
        as character
        format "x(3)"
        no-undo.
    def Input param p_ind_tip_espec_docto
        as character
        format "X(17)"
        no-undo.
    def Input param p_cod_grp_fornec
        as character
        format "x(4)"
        no-undo.
    def Input param p_ind_espec_cta_fornec
        as character
        format "X(19)"
        no-undo.
    def Input param p_cod_indic_econ
        as character
        format "x(8)"
        no-undo.
    def Input param p_dat_transacao
        as date
        format "99/99/9999"
        no-undo.
    def output param p_cod_finalid_econ
        as character
        format "x(10)"
        no-undo.
    def output param p_ind_finalid_ctbl_err
        as character
        format "X(30)"
        no-undo.
    def output param p_cod_plano_cta_ctbl
        as character
        format "x(8)"
        no-undo.
    def output param p_cod_cta_ctbl
        as character
        format "x(20)"
        no-undo.
    def output param p_ind_control_ctbl
        as character
        format "X(18)"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_num_seq
        as integer
        format ">>>,>>9":U
        label "SeqÅància"
        column-label "Seq"
        no-undo.


    /************************** Variable Definition End *************************/

    run pi_retornar_finalid_indic_econ (Input p_cod_indic_econ,
                                        Input p_dat_transacao,
                                        output p_cod_finalid_econ) /*pi_retornar_finalid_indic_econ*/.

    assign p_ind_finalid_ctbl_err = "OK" /*l_ok*/ 
           p_cod_plano_cta_ctbl   = ""
           p_cod_cta_ctbl         = ""
           p_ind_control_ctbl     = "".

    especies_conta:
    do v_num_seq = 1 to num-entries(p_ind_espec_cta_fornec):
        find first cta_grp_fornec no-lock
             where cta_grp_fornec.cod_empresa         = p_cod_empresa
               and cta_grp_fornec.cod_espec_docto     = p_cod_espec_docto
               and cta_grp_fornec.ind_tip_espec_docto = "Nenhum" /*l_nenhum*/ 
               and cta_grp_fornec.cod_grp_fornec      = p_cod_grp_fornec
               and cta_grp_fornec.cod_finalid_econ    = p_cod_finalid_econ
               and cta_grp_fornec.ind_finalid_ctbl    = entry(v_num_seq, p_ind_espec_cta_fornec)
               and cta_grp_fornec.dat_inic_valid     <= p_dat_transacao
               and cta_grp_fornec.dat_fim_valid      >= p_dat_transacao
             use-index ctgrpfrn_inicio_validade
              no-error.
        if  not avail cta_grp_fornec
        then do:
            find first cta_grp_fornec no-lock
                 where cta_grp_fornec.cod_empresa         = p_cod_empresa
                   and cta_grp_fornec.cod_espec_docto     = ""
                   and cta_grp_fornec.ind_tip_espec_docto = p_ind_tip_espec_docto
                   and cta_grp_fornec.cod_grp_fornec      = p_cod_grp_fornec
                   and cta_grp_fornec.cod_finalid_econ    = p_cod_finalid_econ
                   and cta_grp_fornec.ind_finalid_ctbl    = entry(v_num_seq, p_ind_espec_cta_fornec)
                   and cta_grp_fornec.dat_inic_valid     <= p_dat_transacao
                   and cta_grp_fornec.dat_fim_valid      >= p_dat_transacao
                 use-index ctgrpfrn_inicio_validade
                  no-error.
            if  not avail cta_grp_fornec
            then do:
                if  p_ind_finalid_ctbl_err = "OK" /*l_ok*/ 
                then do:
                    assign p_ind_finalid_ctbl_err = entry(v_num_seq, p_ind_espec_cta_fornec).
                end /* if */.
                else do:
                    assign p_ind_finalid_ctbl_err = p_ind_finalid_ctbl_err + "," + entry(v_num_seq, p_ind_espec_cta_fornec).
                end /* else */.
            end /* if */.
        end /* if */.
        if  entry(v_num_seq, p_ind_espec_cta_fornec) = "Saldo" /*l_saldo*/ 
        and avail cta_grp_fornec
        then do:
            assign p_cod_plano_cta_ctbl = cta_grp_fornec.cod_plano_cta_ctbl
                   p_cod_cta_ctbl       = cta_grp_fornec.cod_cta_ctbl
                   p_ind_control_ctbl   = cta_grp_fornec.ind_control_ctbl.
        end /* if */.
    end /* do especies_conta */.
    if  p_ind_finalid_ctbl_err = "OK" /*l_ok*/ 
    then do:
        return "OK" /*l_ok*/ .
    end /* if */.
    else do:
        return "NOK" /*l_nok*/ .
    end /* else */.
END PROCEDURE. /* pi_verifica_ctas_grp_fornec */
/*****************************************************************************
** Procedure Interna.....: pi_retornar_sit_movimen_modul
** Descricao.............: pi_retornar_sit_movimen_modul
** Criado por............: Rovina
** Criado em.............: // 
** Alterado por..........: 
** Alterado em...........: 28/09/1995 13:58:38
*****************************************************************************/
PROCEDURE pi_retornar_sit_movimen_modul:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_modul_dtsul
        as character
        format "x(3)"
        no-undo.
    def Input param p_cod_unid_organ
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def Input param p_dat_refer_sit
        as date
        format "99/99/9999"
        no-undo.
    def Input param p_des_sit_movimen_ent
        as character
        format "x(40)"
        no-undo.
    def output param p_des_sit_movimen_mod
        as character
        format "x(40)"
        no-undo.


    /************************* Parameter Definition End *************************/

    assign p_des_sit_movimen_mod = "".
    situacao:
    for each sit_movimen_modul no-lock
     where sit_movimen_modul.cod_modul_dtsul = p_cod_modul_dtsul
       and sit_movimen_modul.cod_unid_organ = p_cod_unid_organ
       and sit_movimen_modul.dat_inic_sit_movimen <= p_dat_refer_sit
       and sit_movimen_modul.dat_fim_sit_movimen >= p_dat_refer_sit /*cl_retornar_sit_movimen_modul of sit_movimen_modul*/:
        if  p_des_sit_movimen_mod = ""
        then do:
            assign p_des_sit_movimen_mod = sit_movimen_modul.ind_sit_movimen.
        end /* if */.
        else do:
            assign p_des_sit_movimen_mod = p_des_sit_movimen_mod + "," + sit_movimen_modul.ind_sit_movimen.
        end /* else */.
    end /* for situacao */.

END PROCEDURE. /* pi_retornar_sit_movimen_modul */
/*****************************************************************************
** Procedure Interna.....: pi_verifica_relacoes_antecip_pef_pend
** Descricao.............: pi_verifica_relacoes_antecip_pef_pend
** Criado por............: Roberto
** Criado em.............: 11/02/1997 15:18:04
** Alterado por..........: fut41061
** Alterado em...........: 15/08/2014 14:04:40
*****************************************************************************/
PROCEDURE pi_verifica_relacoes_antecip_pef_pend:

    /* ** NASS - CORREÄ«O COTAÄ«O INFORMADA - 05/2003 
         Ir† desabilitar os campos de indicador econìmico, o valor do t°tulo e os  valores da cotaá∆o informada
         quando for vinculado uma previs∆o/imposto  para n∆o gerar distorá‰es na atulizaá∆o de t°tulos ****/

    if avail param_geral_apb then do:
        if  param_geral_apb.ind_control_estab = "Default" /*l_default*/  then do:
            enable antecip_pef_pend.cod_estab
                   bt_zoo_66395
                   with frame f_adp_02_antecip_pef_pend.
        end.
    end.

    enable v_cod_fornec_infor
           antecip_pef_pend.cod_refer
           bt_zoo_fornec
           antecip_pef_pend.cod_espec_docto
           bt_zoo_66405
           antecip_pef_pend.cod_ser_docto
           antecip_pef_pend.cod_tit_ap
           antecip_pef_pend.cod_parcela
           antecip_pef_pend.cod_portador
           bt_zoo_66406
           antecip_pef_pend.dat_emis_docto
           antecip_pef_pend.val_tit_ap
           with frame f_adp_02_antecip_pef_pend.

    assign v_log_tit_vincul = no.
    /* Habilita/Desabilita atributos relacionados com os impostos vinculados. */
    find first impto_impl_pend_ap no-lock
         where impto_impl_pend_ap.cod_estab_refer = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab
           and impto_impl_pend_ap.cod_refer       = antecip_pef_pend.cod_refer
           and impto_impl_pend_ap.cod_portador    = ""
           and impto_impl_pend_ap.num_bord_ap     = 0
           and impto_impl_pend_ap.num_seq_refer   = 0
         no-error.
    if  avail impto_impl_pend_ap
    then do:
        assign v_log_tit_vincul = yes.
        disable antecip_pef_pend.cod_estab
                bt_zoo_66395
                with frame f_adp_02_antecip_pef_pend.
        if  impto_impl_pend_ap.ind_clas_impto = "Taxado" /*l_taxado*/  then do:
            disable fornecedor.cod_pais
                    bt_zoo_66402
                    antecip_pef_pend.cod_refer
                    antecip_pef_pend.dat_emis_docto
                    with frame f_adp_02_antecip_pef_pend.
        end.
        else do:
            disable v_cod_fornec_infor
                    bt_zoo_fornec
                    fornecedor.nom_abrev
                    fornecedor.cod_pais
                    bt_zoo_66402
                    antecip_pef_pend.cod_refer
                    antecip_pef_pend.dat_emis_docto
                    with frame f_adp_02_antecip_pef_pend.

        end.
        if v_log_sul_america 
        and can-find(first impto_impl_pend_ap
            where impto_impl_pend_ap.cod_estab_refer = antecip_pef_pend.cod_estab
              and impto_impl_pend_ap.cod_refer = antecip_pef_pend.cod_refer
              and impto_impl_pend_ap.ind_clas_impto = "Valor Agregado" /*l_valor_agregado*/ ) then

            disable antecip_pef_pend.val_tit_ap
                with frame f_adp_02_antecip_pef_pend.

    end /* if */.

    if v_log_sul_america then do:
        run pi_verificar_iva (Input antecip_pef_pend.cod_estab,
                              Input antecip_pef_pend.dat_emis_docto,
                              output v_log_impto_val_agreg) /*pi_verificar_iva*/.
        if v_log_impto_val_agreg then
            enable bt_impto_val_agreg
                with frame f_adp_02_antecip_pef_pend.
        else
            disable bt_impto_val_agreg
                with frame f_adp_02_antecip_pef_pend.
    end.

    /* Habilita/Desabilita atributos relacionados com o rateio de valores.
    */
    find first aprop_ctbl_pend_ap no-lock
         where aprop_ctbl_pend_ap.cod_estab = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab
           and aprop_ctbl_pend_ap.cod_refer = antecip_pef_pend.cod_refer 
           no-error.
    if  avail aprop_ctbl_pend_ap
    then do:
        disable antecip_pef_pend.cod_estab
                bt_zoo_66395
                antecip_pef_pend.cod_refer
                antecip_pef_pend.cod_portador
                bt_zoo_66406
                antecip_pef_pend.dat_emis_docto
                antecip_pef_pend.cod_refer
                bt_impto_val_agreg
                with frame f_adp_02_antecip_pef_pend.
        if  v_cod_pais_empres_usuar = "BRA" /*l_bra*/  then do:
            &if defined(BF_FIN_ESOCIAL) &then
                if antecip_pef_pend.cod_num_docto_esoc <> "" then do:
                    disable antecip_pef_pend.dat_emis_docto
                            antecip_pef_pend.cod_estab
                            antecip_pef_pend.cod_tit_ap
                            v_cod_fornec_infor
                            bt_zoo_fornec
                            antecip_pef_pend.cod_ser_docto
                            antecip_pef_pend.cod_espec_docto
                            bt_zoo_66405
                            antecip_pef_pend.cod_parcela
                            antecip_pef_pend.val_tit_ap
                            with frame f_adp_02_antecip_pef_pend.
                end.
                else do:
                    enable antecip_pef_pend.cod_tit_ap
                           v_cod_fornec_infor
                           bt_zoo_fornec
                           antecip_pef_pend.cod_ser_docto
                           antecip_pef_pend.cod_parcela
                           antecip_pef_pend.val_tit_ap
                           with frame f_adp_02_antecip_pef_pend.
                end.
            &else
                if num-entries(antecip_pef_pend.cod_livre_1, chr(10)) >= 7 then do:
                    if GetEntryField(7,antecip_pef_pend.cod_livre_1,chr(10)) <> "" then do:
                        disable antecip_pef_pend.dat_emis_docto
                                antecip_pef_pend.cod_estab
                                antecip_pef_pend.cod_tit_ap
                                v_cod_fornec_infor
                                bt_zoo_fornec
                                antecip_pef_pend.cod_ser_docto
                                antecip_pef_pend.cod_espec_docto
                                bt_zoo_66405
                                antecip_pef_pend.cod_parcela
                                antecip_pef_pend.val_tit_ap
                                with frame f_adp_02_antecip_pef_pend.
                    end.
                    else do:
                        enable antecip_pef_pend.cod_tit_ap
                               v_cod_fornec_infor
                               bt_zoo_fornec
                               antecip_pef_pend.cod_ser_docto
                               antecip_pef_pend.cod_parcela
                               antecip_pef_pend.val_tit_ap
                               with frame f_adp_02_antecip_pef_pend.
                    end.
                end.
            &endif
        end.
    end /* if */.
    else do:
        if  v_cod_pais_empres_usuar = "BRA" /*l_bra*/  then do:
            &if defined(BF_FIN_ESOCIAL) &then
                if antecip_pef_pend.cod_num_docto_esoc <> "" then do:
                    disable antecip_pef_pend.dat_emis_docto
                            antecip_pef_pend.cod_estab
                            antecip_pef_pend.cod_tit_ap
                            v_cod_fornec_infor
                            bt_zoo_fornec
                            antecip_pef_pend.cod_ser_docto
                            antecip_pef_pend.cod_espec_docto
                            bt_zoo_66405
                            antecip_pef_pend.cod_parcela
                            antecip_pef_pend.val_tit_ap
                            with frame f_adp_02_antecip_pef_pend.
                end.
                else do:
                    enable antecip_pef_pend.dat_emis_docto
                           antecip_pef_pend.cod_estab
                           antecip_pef_pend.cod_tit_ap
                           v_cod_fornec_infor
                           bt_zoo_fornec
                           antecip_pef_pend.cod_ser_docto
                           antecip_pef_pend.cod_espec_docto
                           bt_zoo_66405
                           antecip_pef_pend.cod_parcela
                           antecip_pef_pend.val_tit_ap
                           with frame f_adp_02_antecip_pef_pend.
                end.
            &else
                if num-entries(antecip_pef_pend.cod_livre_1, chr(10)) >= 7 then do:
                    if GetEntryField(7,antecip_pef_pend.cod_livre_1,chr(10)) <> "" then do:
                        disable antecip_pef_pend.dat_emis_docto
                                antecip_pef_pend.cod_estab
                                antecip_pef_pend.cod_tit_ap
                                v_cod_fornec_infor
                                bt_zoo_fornec
                                antecip_pef_pend.cod_ser_docto
                                antecip_pef_pend.cod_espec_docto
                                bt_zoo_66405
                                antecip_pef_pend.cod_parcela
                                antecip_pef_pend.val_tit_ap
                                with frame f_adp_02_antecip_pef_pend.
                    end.
                    else do:
                        enable antecip_pef_pend.dat_emis_docto
                               antecip_pef_pend.cod_estab
                               antecip_pef_pend.cod_tit_ap
                               v_cod_fornec_infor
                               bt_zoo_fornec
                               antecip_pef_pend.cod_ser_docto
                               antecip_pef_pend.cod_espec_docto
                               bt_zoo_66405
                               antecip_pef_pend.cod_parcela
                               antecip_pef_pend.val_tit_ap
                               with frame f_adp_02_antecip_pef_pend.
                    end.
                end.
            &endif
        end.
    end.

    /* Habilita/Desabilita atributos relacionados com o Abatimento previs∆o e provis∆o.
    */
    find first abat_prev_provis_ap no-lock
        where abat_prev_provis_ap.cod_estab_refer = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab
        and   abat_prev_provis_ap.cod_refer       = antecip_pef_pend.cod_refer 
        and   abat_prev_provis_ap.num_seq_refer   = 0
        no-error.
    if  avail abat_prev_provis_ap then do:
        assign v_log_tit_vincul = yes.
        disable antecip_pef_pend.cod_estab
                bt_zoo_66395
                antecip_pef_pend.cod_refer
                v_cod_fornec_infor
                bt_zoo_fornec
                fornecedor.nom_abrev
                fornecedor.cod_pais
                bt_zoo_66402
                antecip_pef_pend.cod_espec_docto
                bt_zoo_66405
                bt_impto_val_agreg
                antecip_pef_pend.cod_refer
                antecip_pef_pend.dat_emis_docto
                with frame f_adp_02_antecip_pef_pend.
    end.

    /* ******** (NASS - C‡DIGO A SER IMPLEMENTADO)
    if  v_log_tit_vincul = yes then do:
        @disable(@&(frame),antecip_pef_pend.cod_indic_econ,
                           bt_zoo19,
                           antecip_pef_pend.val_tit_ap,
                           antecip_pef_pend.val_cotac_indic_econ,
                           v_val_cotac_indic_econ_inv).
    end.
    else do:
        @enable(@&(frame),antecip_pef_pend.cod_indic_econ,
                          bt_zoo19,
                          antecip_pef_pend.val_tit_ap).
        @run (pi_retornar_indic_econ_corren_estab (input frame @&(frame) @&(table).cod_estab,input frame @&(frame) @&(table).dat_emis_docto,v_cod_indic_econ)).
        if  v_cod_indic_econ <> input frame @&(frame) antecip_pef_pend.cod_indic_econ then do:
            @enable(@&(frame),antecip_pef_pend.val_cotac_indic_econ,
                              v_val_cotac_indic_econ_inv).
        end.
    end.
    **********************************************/
END PROCEDURE. /* pi_verifica_relacoes_antecip_pef_pend */
/*****************************************************************************
** Procedure Interna.....: pi_mostra_imagem_cta_corren
** Descricao.............: pi_mostra_imagem_cta_corren
** Criado por............: Roberto
** Criado em.............: 16/07/1997 17:01:49
** Alterado por..........: fut1090
** Alterado em...........: 09/01/2007 08:20:56
*****************************************************************************/
PROCEDURE pi_mostra_imagem_cta_corren:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_cta_corren
        as character
        format "x(10)"
        no-undo.
    def Input param p_cod_estab
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def Input param p_cod_portador
        as character
        format "x(5)"
        no-undo.
    def Input param p_cod_cart_bcia
        as character
        format "x(3)"
        no-undo.
    def Input param p_cod_finalid_econ
        as character
        format "x(10)"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************** Buffer Definition Begin *************************/

    &if "{&emsuni_version}" >= "5.01" &then
    def buffer b_cta_corren
        for cta_corren.
    &endif
    &if "{&emsfin_version}" >= "5.01" &then
    def buffer b_portad_finalid_econ
        for portad_finalid_econ.
    &endif


    /*************************** Buffer Definition End **************************/

    /************************* Variable Definition Begin ************************/

    def var v_img_image_file
        as Character
        format "x(40)":U
        no-undo.
    def var v_log_method
        as logical
        format "Sim/N∆o"
        initial yes
        no-undo.


    /************************** Variable Definition End *************************/

    if  p_cod_cta_corren = ""
    or  p_cod_cta_corren = ? then do:
        find b_portad_finalid_econ no-lock
             where b_portad_finalid_econ.cod_estab = p_cod_estab
               and b_portad_finalid_econ.cod_portador = p_cod_portador
               and b_portad_finalid_econ.cod_cart_bcia = p_cod_cart_bcia
               and b_portad_finalid_econ.cod_finalid_econ = p_cod_finalid_econ
             no-error.
        if  avail b_portad_finalid_econ then do:
            assign p_cod_cta_corren = b_portad_finalid_econ.cod_cta_corren.
        end.
    end.

    find b_cta_corren no-lock
         where b_cta_corren.cod_cta_corren = p_cod_cta_corren
         no-error.
    if  avail b_cta_corren then do:
        find imagem
            where imagem.cod_imagem = b_cta_corren.cod_imagem
            no-lock no-error.
        if  avail imagem then do:
            find catal_img
                where catal_img.cod_catal_img = imagem.cod_catal_img no-lock no-error.
            assign im_cta_corren:visible in frame f_adp_02_antecip_pef_pend = yes.
            assign v_img_image_file = catal_img.cod_path_catal + "~\" + imagem.img_imagem.
            if search(v_img_image_file) <> ? then
                assign v_log_method = im_cta_corren:load-image(v_img_image_file) in frame f_adp_02_antecip_pef_pend no-error.
            else
                assign im_cta_corren:visible in frame f_adp_02_antecip_pef_pend = no.        
        end.
        else do:
            assign im_cta_corren:visible in frame f_adp_02_antecip_pef_pend = no.
        end.
    end.
    else do:
        assign im_cta_corren:visible in frame f_adp_02_antecip_pef_pend = no.
    end.
END PROCEDURE. /* pi_mostra_imagem_cta_corren */
/*****************************************************************************
** Procedure Interna.....: pi_verifica_impto_vincul_refer_informado
** Descricao.............: pi_verifica_impto_vincul_refer_informado
** Criado por............: Rafael
** Criado em.............: 21/07/1997 14:12:50
** Alterado por..........: fut1090
** Alterado em...........: 21/07/2008 09:20:15
*****************************************************************************/
PROCEDURE pi_verifica_impto_vincul_refer_informado:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cdn_fornecedor
        as Integer
        format ">>>,>>>,>>9"
        no-undo.
    def Input param p_cod_estab
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def Input param p_cod_refer
        as character
        format "x(10)"
        no-undo.
    def Input param p_cod_portador
        as character
        format "x(5)"
        no-undo.
    def Input param p_num_bord_ap
        as integer
        format ">>>>>9"
        no-undo.
    def Input param p_num_seq_refer
        as integer
        format ">>>9"
        no-undo.
    def Input param p_ind_tip_refer
        as character
        format "X(22)"
        no-undo.
    def Input param p_dat_transacao
        as date
        format "99/99/9999"
        no-undo.
    def output param p_cod_return
        as character
        format "x(40)"
        no-undo.


    /************************* Parameter Definition End *************************/

    assign v_cod_empres_usuar_2 = v_cod_empres_usuar.

    if 'add_antecip_pef_pend' = 'add_antecip_pef_pend'
    or 'add_antecip_pef_pend' = 'add_antecip_pef_pend_pef'
    or 'add_antecip_pef_pend' = 'add_item_lote_impl_ap'
    or 'add_antecip_pef_pend' = 'add_item_lote_impl_ap_previsao'
    or 'add_antecip_pef_pend' = 'add_lote_impl_tit_ap_fatura'
    or 'add_antecip_pef_pend' = 'mod_antecip_pef_pend_base'
    or 'add_antecip_pef_pend' = 'mod_antecip_pef_pend_pef'
    or 'add_antecip_pef_pend' = 'mod_item_lote_impl_ap_base'
    or 'add_antecip_pef_pend' = 'mod_item_lote_impl_ap_previsao_base'
    or 'add_antecip_pef_pend' = 'mod_item_lote_impl_ap_base' then do:
        &if '{&emsfin_version}' >= '5.03' &then
            find last param_geral_apb no-lock no-error.
            if avail param_geral_apb then do:
                if param_geral_apb.log_reg_corporat then do:
                    find estabelecimento no-lock
                        where estabelecimento.cod_estab = p_cod_estab no-error.
                    if avail estabelecimento then do:
                        assign v_cod_empres_usuar_2 = estabelecimento.cod_empresa.
                    end.
                end.
            end.
        &endif
    end.

    for each impto_vincul_fornec use-index imptvncl_id
        where impto_vincul_fornec.cod_empresa      = v_cod_empres_usuar_2
        and   impto_vincul_fornec.cdn_fornecedor   = p_cdn_fornecedor
        and   impto_vincul_fornec.log_impto_opcnal = no no-lock:
        find first impto_impl_pend_ap
            where impto_impl_pend_ap.cod_estab_refer   = p_cod_estab 
            and   impto_impl_pend_ap.cod_refer         = p_cod_refer
            and   impto_impl_pend_ap.cod_portador      = p_cod_portador
            and   impto_impl_pend_ap.num_bord_ap       = p_num_bord_ap
            and   impto_impl_pend_ap.num_seq_refer     = p_num_seq_refer
            and   impto_impl_pend_ap.cod_pais          = impto_vincul_fornec.cod_pais
            and   impto_impl_pend_ap.cod_unid_federac  = impto_vincul_fornec.cod_unid_federac
            and   impto_impl_pend_ap.cod_imposto       = impto_vincul_fornec.cod_imposto
            and   impto_impl_pend_ap.cod_classif_impto = impto_vincul_fornec.cod_classif_impto
            no-lock no-error.
        if  not avail impto_impl_pend_ap then do:
            find first histor_impto_empres
                where histor_impto_empres.cod_pais         = impto_vincul_fornec.cod_pais
                and   histor_impto_empres.cod_unid_federac = impto_vincul_fornec.cod_unid_federac
                and   histor_impto_empres.cod_imposto      = impto_vincul_fornec.cod_imposto
                and   histor_impto_empres.cod_empresa      = v_cod_empres_usuar_2
                and   histor_impto_empres.dat_inic_valid  <= p_dat_transacao 
                and   histor_impto_empres.dat_fim_valid    > p_dat_transacao
                and   histor_impto_empres.cdn_fornec_favorec > 0
                no-lock no-error.
            if  avail histor_impto_empres
            then do:
                find first imposto 
                    where imposto.cod_pais         = impto_vincul_fornec.cod_pais
                    and   imposto.cod_unid_federac = impto_vincul_fornec.cod_unid_federac
                    and   imposto.cod_imposto      = impto_vincul_fornec.cod_imposto
                    no-lock no-error.
                case p_ind_tip_refer:
                    when ("Implantaá∆o" /*l_implantacao*/ ) then do:
                        if avail imposto and imposto.ind_base_vencto_impto <> "Pagto" /*l_pagto*/  then do:
                            assign p_cod_return = "NOK" /*l_nok*/ .
                            if v_log_dat_vencto_impto = yes then do:
                               &if '{&emsuni_version}' >= '5.06' &then
                                   if  imposto.ind_base_vencto_impto = "Vencto" /*l_vencto*/  
                                   and imposto.log_habilit_vincul_impl <> yes then
                                       assign p_cod_return = "OK" /*l_ok*/ .
                               &else
                                   if  imposto.ind_base_vencto_impto = "Vencto" /*l_vencto*/  
                                   and imposto.log_livre_1 <> yes then 
                                       assign p_cod_return = "OK" /*l_ok*/ .
                               &endif        
                            end.
                            else do:
                                 if imposto.ind_base_vencto_impto = "Vencto" /*l_vencto*/  then
                                    assign p_cod_return = "OK" /*l_ok*/ .
                            end.
                            if p_cod_return = "NOK" /*l_nok*/  then
                               return.
                        end.    
                    end.
                    when ("Antecipaá∆o" /*l_antecipacao*/ ) then do:
                        assign p_cod_return = "NOK" /*l_nok*/ .
                        if v_log_dat_vencto_impto = yes then do:
                           &if '{&emsuni_version}' >= '5.06' &then
                               if avail imposto
                               and imposto.ind_base_vencto_impto = "Vencto" /*l_vencto*/  
                               and imposto.log_habilit_vincul_impl <> yes then
                                   assign p_cod_return = "OK" /*l_ok*/ .
                           &else
                               if avail imposto
                               and imposto.ind_base_vencto_impto = "Vencto" /*l_vencto*/  
                               and imposto.log_livre_1 <> yes then 
                                   assign p_cod_return = "OK" /*l_ok*/ .
                           &endif        
                        end.
                        if p_cod_return = "NOK" /*l_nok*/  then
                           return.
                    end.
                    when ("Pagto Extra Fornecedor" /*l_pagto_extra_fornecedor*/ ) then do:
                        assign p_cod_return = "NOK" /*l_nok*/ .
                        return.
                    end.
                    when ("Baixa" /*l_baixa*/ ) then do:
                        if avail imposto
                        and (imposto.ind_base_vencto_impto = "Pagto" /*l_pagto*/ 
                        or  imposto.ind_base_vencto_impto = "Transaá∆o" /*l_transacao*/ 
                        or  imposto.ind_base_vencto_impto = "Vencto" /*l_vencto*/ ) then do:
                            assign p_cod_return = "NOK" /*l_nok*/ .
                            return.
                        end.
                    end.
                end.
            end.    
        end.
    end.
    assign p_cod_return = "OK" /*l_ok*/ .

END PROCEDURE. /* pi_verifica_impto_vincul_refer_informado */
/*****************************************************************************
** Procedure Interna.....: pi_executa_histor_padr_antecip_apb
** Descricao.............: pi_executa_histor_padr_antecip_apb
** Criado por............: Rafael
** Criado em.............: 22/07/1997 16:38:12
** Alterado por..........: Marciop
** Alterado em...........: 25/02/1998 16:41:10
*****************************************************************************/
PROCEDURE pi_executa_histor_padr_antecip_apb:

    elimina:
    for each tt_compl_histor_padr_valor exclusive-lock:
        delete tt_compl_histor_padr_valor.
    end /* for elimina */.

    /* --- Cria valores para gerar hist¢rico ---*/
    create tt_compl_histor_padr_valor.
    assign tt_compl_histor_padr_valor.tta_cod_compl_padr = "EspÇcie" /*l_especie*/ 
           tt_compl_histor_padr_valor.tta_cod_format_compl_padr = "x(3)":U
           tt_compl_histor_padr_valor.ttv_des_val_compl_padr = antecip_pef_pend.cod_espec_docto:screen-value in frame f_adp_02_antecip_pef_pend.
    create tt_compl_histor_padr_valor.
    assign tt_compl_histor_padr_valor.tta_cod_compl_padr = "SÇrie" /*l_serie*/ 
           tt_compl_histor_padr_valor.tta_cod_format_compl_padr = "x(3)":U
           tt_compl_histor_padr_valor.ttv_des_val_compl_padr = antecip_pef_pend.cod_ser_docto:screen-value in frame f_adp_02_antecip_pef_pend.
    create tt_compl_histor_padr_valor.
    assign tt_compl_histor_padr_valor.tta_cod_compl_padr = "T°tulo" /*l_titulo*/ 
           tt_compl_histor_padr_valor.tta_cod_format_compl_padr = "x(10)":U
           tt_compl_histor_padr_valor.ttv_des_val_compl_padr = antecip_pef_pend.cod_tit_ap:screen-value in frame f_adp_02_antecip_pef_pend.
    create tt_compl_histor_padr_valor.
    assign tt_compl_histor_padr_valor.tta_cod_compl_padr = "Parcela" /*l_parcela*/ 
           tt_compl_histor_padr_valor.tta_cod_format_compl_padr = "x(02)":U
           tt_compl_histor_padr_valor.ttv_des_val_compl_padr = antecip_pef_pend.cod_parcela:screen-value in frame f_adp_02_antecip_pef_pend.
    create tt_compl_histor_padr_valor.
    assign tt_compl_histor_padr_valor.tta_cod_compl_padr = "Moeda" /*l_moeda*/ 
           tt_compl_histor_padr_valor.tta_cod_format_compl_padr = "x(8)":U
           tt_compl_histor_padr_valor.ttv_des_val_compl_padr = antecip_pef_pend.cod_indic_econ:screen-value in frame f_adp_02_antecip_pef_pend.
    create tt_compl_histor_padr_valor.
    assign tt_compl_histor_padr_valor.tta_cod_compl_padr = "Valor" /*l_valor*/ 
           tt_compl_histor_padr_valor.tta_cod_format_compl_padr = "->>>,>>>,>>9.99":U
           tt_compl_histor_padr_valor.ttv_des_val_compl_padr = antecip_pef_pend.val_tit_ap:screen-value in frame f_adp_02_antecip_pef_pend.
    create tt_compl_histor_padr_valor.
    assign tt_compl_histor_padr_valor.tta_cod_compl_padr = "Portador" /*l_portador*/ 
           tt_compl_histor_padr_valor.tta_cod_format_compl_padr = "x(5)":U
           tt_compl_histor_padr_valor.ttv_des_val_compl_padr = antecip_pef_pend.cod_portador:screen-value in frame f_adp_02_antecip_pef_pend.
    create tt_compl_histor_padr_valor.
    assign tt_compl_histor_padr_valor.tta_cod_compl_padr = "Emiss∆o" /*l_emissao*/ 
           tt_compl_histor_padr_valor.tta_cod_format_compl_padr = "99/99/9999":U
           tt_compl_histor_padr_valor.ttv_des_val_compl_padr = antecip_pef_pend.dat_emis_docto:screen-value in frame f_adp_02_antecip_pef_pend.
    create tt_compl_histor_padr_valor.
    assign tt_compl_histor_padr_valor.tta_cod_compl_padr = "FornAbrv" /*l_fornabrv*/ 
           tt_compl_histor_padr_valor.tta_cod_format_compl_padr = "x(15)":U
           tt_compl_histor_padr_valor.ttv_des_val_compl_padr = fornecedor.nom_abrev:screen-value in frame f_adp_02_antecip_pef_pend.

    if  search("prgfin/apb/apb013ta.r") = ? and search("prgfin/apb/apb013ta.p") = ? then do:
        if  v_cod_dwb_user begins 'es_' then
            return "Programa execut†vel n∆o foi encontrado:" /*l_programa_nao_encontrado*/  + "prgfin/apb/apb013ta.p".
        else do:
            message getStrTrans("Programa execut†vel n∆o foi encontrado:", "APB") /*l_programa_nao_encontrado*/  "prgfin/apb/apb013ta.p"
                   view-as alert-box error buttons ok.
            return.
        end.
    end.
    else
        run prgfin/apb/apb013ta.p (input-output antecip_pef_pend.cod_histor_padr,
                               input-output antecip_pef_pend.des_text_histor,
                               Input "Antecip" /*l_antecip*/) /*prg_dlg_histor_tit_movto_ap_informa*/.
END PROCEDURE. /* pi_executa_histor_padr_antecip_apb */
/*****************************************************************************
** Procedure Interna.....: pi_informar_chave_tab_relac_pessoa_fisic_jurid
** Descricao.............: pi_informar_chave_tab_relac_pessoa_fisic_jurid
** Criado por............: Marciop
** Criado em.............: 15/04/1998 14:41:01
** Alterado por..........: fut302
** Alterado em...........: 24/04/2003 16:04:30
*****************************************************************************/
PROCEDURE pi_informar_chave_tab_relac_pessoa_fisic_jurid:

    assign v_log_reg_corporat = no.
    &if '{&emsfin_version}' >= '5.03' &then
        find last param_geral_apb no-lock no-error.
        if avail param_geral_apb then do:
            if param_geral_apb.log_reg_corporat then do:
                assign v_log_reg_corporat = yes.
            end.
        end.
    &endif
    if v_log_reg_corporat then do:
        if avail estabelecimento then do:

            /* Begin_Include: i_informar_chave_tab_relac_pessoa_fisic_jurid_cor */
            if  v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend <> ""
            and v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend <> ?
            then do:

            /* find pais 
                    where pais.cod_pais = estabelecimento.cod_pais no-lock no-error.
                if  not avail pais then do:
                    find pais 
                        where recid(pais) = v_rec_pais no-lock no-error.
                end.
                @if(available pais)
                   assign v_cod_pais = pais.cod_pais.
                @end_if().

                assign v_cod_fornec_infor. */

                assign input frame f_adp_02_antecip_pef_pend v_cod_fornec_infor
                             v_cod_pais = input frame f_adp_02_antecip_pef_pend fornecedor.cod_pais.

                assign v_cdn_fornecedor = integer(v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend) no-error.

                if  error-status:get-number(1) = 0
                then do:
                   find fornecedor no-lock
                        where fornecedor.cod_empresa = estabelecimento.cod_empresa
                          and fornecedor.cdn_fornecedor = v_cdn_fornecedor /*cl_sea_fornecedor_variable_cor of fornecedor*/ no-error.
                   if  not available fornecedor
                   then do:
                      find first fornecedor no-lock
                           where fornecedor.cod_empresa = estabelecimento.cod_empresa
                             and fornecedor.nom_abrev = v_cod_fornec_infor /*cl_sea_fornecedor_infor_cor of fornecedor*/ no-error.
                      if  not available fornecedor
                      then do:
                         find fornecedor no-lock
                              where fornecedor.cod_empresa = estabelecimento.cod_empresa
                                and fornecedor.cod_pais = v_cod_pais
                                and fornecedor.cod_id_feder = v_cod_fornec_infor /*cl_sea_fornecedor_pais_id_federal_cor of fornecedor*/ no-error.
                         if  not available fornecedor
                         then do:
                            find first fornecedor no-lock
                                 where fornecedor.cod_empresa = estabelecimento.cod_empresa
                                   and fornecedor.cod_pais = v_cod_pais
                                   and fornecedor.cod_id_feder = v_cod_fornec_infor /*cl_sea_fornecedor_pais_id_federal_cor of fornecedor*/ no-error.
                            if  available fornecedor
                            then do:
                               view frame f_dlg_01_fornecedor_id_feder.
                               enable all with frame f_dlg_01_fornecedor_id_feder.
                               open query qr_fornecedor_id_feder for
                                  each fornecedor no-lock
                                  where fornecedor.cod_empresa = estabelecimento.cod_empresa
                                    and fornecedor.cod_pais = v_cod_pais
                                    and fornecedor.cod_id_feder = v_cod_fornec_infor /*cl_sea_fornecedor_pais_id_federal_cor of fornecedor*/.
                               do  on endkey undo,leave:
                                   wait-for window-close of current-window 
                                         or choose       of bt_ok
                                         or mouse-select-dblclick of br_fornecedor_id_feder.
                               end.
                               hide frame f_dlg_01_fornecedor_id_feder.
                               assign v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend = string(fornecedor.cdn_fornecedor).
                            end /* if */.
                         end /* if */.  
                         else do:
                            assign v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend = string(fornecedor.cdn_fornecedor).
                         end /* else */.   
                      end /* if */.
                   end /* if */.
                   else do:
                      assign v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend = string(fornecedor.cdn_fornecedor).
                   end /* else */.
                end /* if */.
                else do:
                   find fornecedor no-lock
                        where fornecedor.cod_empresa = estabelecimento.cod_empresa
                          and fornecedor.nom_abrev = v_cod_fornec_infor /*cl_sea_fornecedor_infor_cor of fornecedor*/ no-error.
                   if  not available fornecedor
                   then do:
                      find fornecedor no-lock
                           where fornecedor.cod_empresa = estabelecimento.cod_empresa
                             and fornecedor.cod_pais = v_cod_pais
                             and fornecedor.cod_id_feder = v_cod_fornec_infor /*cl_sea_fornecedor_pais_id_federal_cor of fornecedor*/ no-error.
                      if  not available fornecedor
                      then do:
                         find first fornecedor no-lock
                              where fornecedor.cod_empresa = estabelecimento.cod_empresa
                                and fornecedor.cod_pais = v_cod_pais
                                and fornecedor.cod_id_feder = v_cod_fornec_infor /*cl_sea_fornecedor_pais_id_federal_cor of fornecedor*/ no-error.
                         if  available fornecedor
                         then do:
                            view frame f_dlg_01_fornecedor_id_feder.
                            enable all with frame f_dlg_01_fornecedor_id_feder.
                            open query qr_fornecedor_id_feder for
                               each fornecedor no-lock
                               where fornecedor.cod_empresa = estabelecimento.cod_empresa
                                 and fornecedor.cod_pais = v_cod_pais
                                 and fornecedor.cod_id_feder = v_cod_fornec_infor /*cl_sea_fornecedor_pais_id_federal_cor of fornecedor*/.
                            do  on endkey undo,leave:
                                wait-for window-close of current-window 
                                      or choose       of bt_ok
                                      or mouse-select-dblclick of br_fornecedor_id_feder.
                            end.
                            hide frame f_dlg_01_fornecedor_id_feder.
                            assign v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend = string(fornecedor.cdn_fornecedor).
                         end /* if */.
                      end /* if */.   
                      else do:
                          assign v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend = string(fornecedor.cdn_fornecedor).
                      end /* else */.       
                   end /* if */.
                   else do:
                      assign v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend = string(fornecedor.cdn_fornecedor).
                   end /* else */.
                end /* else */.
                if  available fornecedor
                then do:
                    assign fornecedor.cod_pais:screen-value in frame f_adp_02_antecip_pef_pend = fornecedor.cod_pais
                          fornecedor.nom_abrev:screen-value in frame f_adp_02_antecip_pef_pend = fornecedor.nom_abrev.
                    disable fornecedor.cod_pais
                            bt_zoo_66402
                            with frame f_adp_02_antecip_pef_pend.
                end /* if */.
                else do:
                    enable fornecedor.cod_pais
                           bt_zoo_66402
                           with frame f_adp_02_antecip_pef_pend.
                    assign fornecedor.cod_pais:screen-value  in frame f_adp_02_antecip_pef_pend = ""
                           fornecedor.nom_abrev:screen-value in frame f_adp_02_antecip_pef_pend = "".
                end /* else */.
            end /* if */.
            else do:
                enable fornecedor.cod_pais
                       bt_zoo_66402
                       with frame f_adp_02_antecip_pef_pend.
                assign fornecedor.cod_pais:screen-value  in frame f_adp_02_antecip_pef_pend = ""
                       fornecedor.nom_abrev:screen-value in frame f_adp_02_antecip_pef_pend = "".
            end /* else */.
            /* End_Include: i_informar_chave_tab_relac_pessoa_fisic_jurid_cor */

        end.
        else
            run pi_informar_chave_tab_relac_pessoa_fisic_jurid_aux /*pi_informar_chave_tab_relac_pessoa_fisic_jurid_aux*/.
    end.                                                        
    else
        run pi_informar_chave_tab_relac_pessoa_fisic_jurid_aux /*pi_informar_chave_tab_relac_pessoa_fisic_jurid_aux*/.
END PROCEDURE. /* pi_informar_chave_tab_relac_pessoa_fisic_jurid */
/*****************************************************************************
** Procedure Interna.....: pi_version_extract
** Descricao.............: pi_version_extract
** Criado por............: jaison
** Criado em.............: 31/07/1998 09:33:22
** Alterado por..........: tech14020
** Alterado em...........: 12/06/2006 09:09:21
*****************************************************************************/
PROCEDURE pi_version_extract:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_program
        as character
        format "x(08)"
        no-undo.
    def Input param p_cod_program_ext
        as character
        format "x(8)"
        no-undo.
    def Input param p_cod_version
        as character
        format "x(8)"
        no-undo.
    def Input param p_cod_program_type
        as character
        format "x(8)"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_cod_event_dic
        as character
        format "x(20)":U
        label "Evento"
        column-label "Evento"
        no-undo.
    def var v_cod_tabela
        as character
        format "x(28)":U
        label "Tabela"
        column-label "Tabela"
        no-undo.


    /************************** Variable Definition End *************************/

    if  can-do(v_cod_tip_prog, p_cod_program_type)
    then do:
        if p_cod_program_type = 'dic' then 
           assign p_cod_program_ext = replace(p_cod_program_ext, 'database/', '').

        output stream s-arq to value(v_cod_arq) append.

        put stream s-arq unformatted
            p_cod_program            at 1 
            p_cod_program_ext        at 43 
            p_cod_version            at 69 
            today                    at 84 format "99/99/99"
            string(time, 'HH:MM:SS') at 94 skip.

        if  p_cod_program_type = 'pro' then do:
            &if '{&emsbas_version}' > '1.00' &then
            find prog_dtsul 
                where prog_dtsul.cod_prog_dtsul = p_cod_program 
                no-lock no-error.
            if  avail prog_dtsul
            then do:
                &if '{&emsbas_version}' > '5.00' &then
                    if  prog_dtsul.nom_prog_dpc <> '' then
                        put stream s-arq 'DPC : ' at 5 prog_dtsul.nom_prog_dpc  at 15 skip.
                &endif
                if  prog_dtsul.nom_prog_appc <> '' then
                    put stream s-arq 'APPC: ' at 5 prog_dtsul.nom_prog_appc at 15 skip.
                if  prog_dtsul.nom_prog_upc <> '' then
                    put stream s-arq 'UPC : ' at 5 prog_dtsul.nom_prog_upc  at 15 skip.
            end /* if */.
            &endif
        end.

        if  p_cod_program_type = 'dic' then do:
            &if '{&emsbas_version}' > '1.00' &then
            assign v_cod_event_dic = ENTRY(1,p_cod_program ,'/':U)
                   v_cod_tabela    = ENTRY(2,p_cod_program ,'/':U). /* FO 1100.980 */
            find tab_dic_dtsul 
                where tab_dic_dtsul.cod_tab_dic_dtsul = v_cod_tabela 
                no-lock no-error.
            if  avail tab_dic_dtsul
            then do:
                &if '{&emsbas_version}' > '5.00' &then
                    if  tab_dic_dtsul.nom_prog_dpc_gat_delete <> '' and v_cod_event_dic = 'Delete':U then
                        put stream s-arq 'DPC-DELETE : ' at 5 tab_dic_dtsul.nom_prog_dpc_gat_delete  at 25 skip.
                &endif
                if  tab_dic_dtsul.nom_prog_appc_gat_delete <> '' and v_cod_event_dic = 'Delete':U then
                    put stream s-arq 'APPC-DELETE: ' at 5 tab_dic_dtsul.nom_prog_appc_gat_delete at 25 skip.
                if  tab_dic_dtsul.nom_prog_upc_gat_delete <> '' and v_cod_event_dic = 'Delete':U then
                    put stream s-arq 'UPC-DELETE : ' at 5 tab_dic_dtsul.nom_prog_upc_gat_delete  at 25 skip.
                &if '{&emsbas_version}' > '5.00' &then
                    if  tab_dic_dtsul.nom_prog_dpc_gat_write <> '' and v_cod_event_dic = 'Write':U then
                        put stream s-arq 'DPC-WRITE : ' at 5 tab_dic_dtsul.nom_prog_dpc_gat_write  at 25 skip.
                &endif
                if  tab_dic_dtsul.nom_prog_appc_gat_write <> '' and v_cod_event_dic = 'Write':U then
                    put stream s-arq 'APPC-WRITE: ' at 5 tab_dic_dtsul.nom_prog_appc_gat_write at 25 skip.
                if  tab_dic_dtsul.nom_prog_upc_gat_write <> '' and v_cod_event_dic = 'Write':U  then
                    put stream s-arq 'UPC-WRITE : ' at 5 tab_dic_dtsul.nom_prog_upc_gat_write  at 25 skip.
            end /* if */.
            &endif
        end.

        output stream s-arq close.
    end /* if */.

END PROCEDURE. /* pi_version_extract */
/*****************************************************************************
** Procedure Interna.....: pi_antecip_pef_pend_impto_retido_taxado
** Descricao.............: pi_antecip_pef_pend_impto_retido_taxado
** Criado por............: Roberto
** Criado em.............: 01/08/1998 13:42:16
** Alterado por..........: fut12163
** Alterado em...........: 17/06/2019 08:21:02
*****************************************************************************/
PROCEDURE pi_antecip_pef_pend_impto_retido_taxado:

    /************************ Parameter Definition Begin ************************/

    def Input param p_ind_tip_impto
        as character
        format "X(35)"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_cdn_fornecedor
        as Integer
        format ">>>,>>>,>>9":U
        label "Fornecedor"
        column-label "Fornecedor"
        no-undo.
    def var v_cod_finalid_econ
        as character
        format "x(10)":U
        label "Finalidade Econìmica"
        column-label "Finalidade Econìmica"
        no-undo.
    def var v_cod_return
        as character
        format "x(40)":U
        no-undo.
    def var v_ind_finalid_ctbl_err
        as character
        format "X(30)":U
        label "Finalidade Cont†bil"
        column-label "Finalidade Cont†bil"
        no-undo.
    def var v_log_refer_uni
        as logical
        format "Sim/N∆o"
        initial yes
        no-undo.
    def var v_num_pessoa
        as integer
        format ">>>,>>>,>>9":U
        label "Pessoa"
        column-label "Pessoa"
        no-undo.
    def var v_val_lim_liber_usuar_mes
        as decimal
        format "->>,>>>,>>>,>>9.99":U
        decimals 2
        label "Limite Màs"
        column-label "Limite Màs"
        no-undo.
    def var v_val_lim_liber_usuar_movto
        as decimal
        format "->>>,>>>,>>9.99":U
        decimals 2
        label "Limite Movimento"
        column-label "Limite Movimento"
        no-undo.
    def var v_val_lim_pagto_usuar_mes
        as decimal
        format "->>,>>>,>>>,>>9.99":U
        decimals 2
        label "Limite Màs"
        column-label "Limite Màs"
        no-undo.
    def var v_val_lim_pagto_usuar_movto
        as decimal
        format "->>>,>>>,>>9.99":U
        decimals 2
        label "Limite Movimento"
        column-label "Limite Movimento"
        no-undo.


    /************************** Variable Definition End *************************/

    run pi_save_key /*pi_save_key*/.

    assign input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab
           input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_refer
           input frame f_adp_02_antecip_pef_pend antecip_pef_pend.val_tit_ap
           input frame f_adp_02_antecip_pef_pend antecip_pef_pend.dat_emis_docto
           input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_indic_econ
           input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_ser_docto
           input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_tit_ap
           input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_parcela.

    if  v_log_localiz_arg then
        assign input frame f_adp_02_antecip_pef_pend antecip_pef_pend.val_cotac_indic_econ.

    if v_log_dat_vencto_impto = yes then do:
       assign input frame f_adp_02_antecip_pef_pend antecip_pef_pend.dat_vencto_tit_ap.
    end.

    assign antecip_pef_pend.cod_empresa           = v_cod_empres_usuar_2
           antecip_pef_pend.cod_usuar_gerac_movto = v_cod_usuar_corren
           antecip_pef_pend.ind_tip_refer         = "Antecipaá∆o" /*l_antecipacao*/ 
           antecip_pef_pend.ind_sit_pef_antecip   = "Em Digitaá∆o" /*l_em_digitacao*/ .

    if not avail estabelecimento then 
       find estabelecimento no-lock
            where estabelecimento.cod_estab = antecip_pef_pend.cod_estab no-error.

    run pi_acha_fornecedor_informado (output v_cdn_fornecedor,
                                      output v_num_pessoa) /*pi_acha_fornecedor_informado*/.
    assign antecip_pef_pend.cdn_fornecedor = v_cdn_fornecedor
           antecip_pef_pend.num_pessoa     = v_num_pessoa.
    /* Valida Estabelecimento/Empresa
    */
    &if "{&emsuni_dbinst}" = "yes" &then
        def buffer bcx_stblcmnt_antcppfp for estabelecimento.
        if  not (can-find(first bcx_stblcmnt_antcppfp
                          where bcx_stblcmnt_antcppfp.cod_estab = antecip_pef_pend.cod_estab
        )) then do:
            run pi_messages (input "show",
                             input 1284,
                             input "Estabelecimento~~Estabelecimentos"). /*msg_1284*/
            return error.
        end
    &endif.

    run pi_validar_estab (Input v_cod_empres_usuar_2,
                          Input antecip_pef_pend.cod_estab,
                          Input antecip_pef_pend.dat_emis_docto,
                          output v_cod_return) /*pi_validar_estab*/.
    if  v_cod_return <> "" then do:
        /* case_block: */
        case v_cod_return:
            when "Unidade Organizacional" /*l_unid_organ*/ then /* Estabelecimento n∆o habilitado como Unidade Organizacional ! */
             run pi_messages (input "show",
                              input 347,
                              input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_347*/.
            when "Empresa" /*l_empresa*/ then /* Empresa do Estabelecimento Diferente da Empresa do Usu†rio ! */
             run pi_messages (input "show",
                              input 512,
                              input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_512*/.
            when "Usu†rio" /*l_usuario*/ then /* Usu†rio sem permiss∆o para acessar o estabelecimento &1 ! */
             run pi_messages (input "show",
                              input 348,
                              input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_348*/.
        end.
        return no-apply.
    end.

    run pi_validar_usuar_estab_apb (Input antecip_pef_pend.cod_estab,
                                    Input "Implantador" /*l_implantador*/,
                                    output v_cod_return,
                                    output v_val_lim_liber_usuar_movto,
                                    output v_val_lim_liber_usuar_mes,
                                    output v_val_lim_pagto_usuar_movto,
                                    output v_val_lim_pagto_usuar_mes) /*pi_validar_usuar_estab_apb*/.
    /* case_block: */
    case v_cod_return:
        when "no" /*l_no*/ then
            no_block:
            do:
                /* Usu†rio &1 n∆o possui permiss∆o para &2 ! */
                run pi_messages (input "show",
                                 input 701,
                                 input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                   v_cod_usuar_corren, "Implantar" /*l_implantar*/)) /*msg_701*/.
                return no-apply.
            end.
        when "602" then
            602_block:
            do:
                /* Usu†rio Financeiro Inexistente ! */
                run pi_messages (input "show",
                                 input 602,
                                 input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_602*/.
                return no-apply.
            end.
    end.

    /* Valida referencia unica
    */
    run pi_verifica_refer_unica_apb (Input antecip_pef_pend.cod_estab,
                                     Input antecip_pef_pend.cod_refer,
                                     Input "antecip_pef_pend" /*l_antecip_pef_pend*/,
                                     Input ?,
                                     output v_log_refer_uni) /*pi_verifica_refer_unica_apb*/.
    if  v_log_refer_uni = no then do:
        /* Referància deve ser £nica ! */
        run pi_messages (input "show",
                         input 742,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_742*/.
        return no-apply.
    end.

    /* Valida Fornecedor
    */
    &if "{&emsuni_dbinst}" = "yes" &then
        def buffer bcx_frncdr_antcppfp for fornecedor.
        if  not ((antecip_pef_pend.cod_empresa = "" or
                  antecip_pef_pend.cdn_fornecedor = 0) or
                  can-find(first bcx_frncdr_antcppfp
                          where bcx_frncdr_antcppfp.cdn_fornecedor = antecip_pef_pend.cdn_fornecedor
                            and bcx_frncdr_antcppfp.cod_empresa = antecip_pef_pend.cod_empresa
        )) then do:
            run pi_messages (input "show",
                             input 1284,
                             input "Fornecedor~~Fornecedores"). /*msg_1284*/
            return error.
        end
    &endif.
    &if "{&emsfin_dbinst}" = "yes" &then
        def buffer bcx_frncfnnc_antcppfp for fornec_financ.
        if  not ((antecip_pef_pend.cod_empresa = "" or
                  antecip_pef_pend.cdn_fornecedor = 0) or
                  can-find(first bcx_frncfnnc_antcppfp
                          where bcx_frncfnnc_antcppfp.cdn_fornecedor = antecip_pef_pend.cdn_fornecedor
                            and bcx_frncfnnc_antcppfp.cod_empresa = antecip_pef_pend.cod_empresa
        )) then do:
            run pi_messages (input "show",
                             input 1284,
                             input "Fornecedor Financeiro~~Fornecedores Financeiro"). /*msg_1284*/
            return error.
        end
    &endif.

    /* Valida Indicador Econìmico
    */
    run pi_validar_indic_econ_movto (Input antecip_pef_pend.cod_indic_econ,
                                     Input antecip_pef_pend.dat_emis_docto,
                                     Input antecip_pef_pend.cod_empresa,
                                     output v_cod_return) /*pi_validar_indic_econ_movto*/.
    if  v_cod_return <> "OK" /*l_ok*/  then do:
        if  entry(1, v_cod_return) = "335" then do:
            /* Indicador Econìmico Inexistente ! */
            run pi_messages (input "show",
                             input 335,
                             input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_335*/.
        end.
        if  entry(1, v_cod_return) = "336" then do:
            /* Hist¢rico Finalidade inexistente para o indicador econìmico ! */
            run pi_messages (input "show",
                             input 336,
                             input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_336*/.
        end.
        if  entry(1, v_cod_return) = "337" then do:
            /* Finalidade econìmica n∆o permite informar valores ! */
            run pi_messages (input "show",
                             input 337,
                             input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                entry(2, v_cod_return))) /*msg_337*/.
        end.
        if  entry(1, v_cod_return) = "338" then do:
            /* Finalidade n∆o liberada para a Unidade Organizacional ! */
            run pi_messages (input "show",
                             input 338,
                             input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_338*/.
        end.
        return no-apply.
    end.

    if  p_ind_tip_impto = "Retido" /*l_retido*/  then do:
        if v_log_sul_america
        and antecip_pef_pend.val_tit_ap = 0 then do:
            /* Valor da Antecipaá∆o/PEF deve ser diferente de Zero ! */
            run pi_messages (input "show",
                             input 6862,
                             input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_6862*/.
            return error.
        end.
        run prgfin/apb/apb740za.p (Input antecip_pef_pend.cod_estab,
                                   Input antecip_pef_pend.cod_refer,
                                   Input "",
                                   Input 0,
                                   Input 0,
                                   Input antecip_pef_pend.cdn_fornecedor,
                                   Input antecip_pef_pend.val_tit_ap,
                                   Input antecip_pef_pend.dat_emis_docto,
                                   Input antecip_pef_pend.dat_emis_docto,
                                   Input antecip_pef_pend.dat_vencto_tit_ap,
                                   Input antecip_pef_pend.dat_emis_docto,
                                   Input antecip_pef_pend.cod_indic_econ,
                                   Input antecip_pef_pend.cod_estab,
                                   Input antecip_pef_pend.num_pessoa,
                                   Input antecip_pef_pend.cod_ser_docto,
                                   Input antecip_pef_pend.cod_tit_ap,
                                   Input antecip_pef_pend.cod_parcela,
                                   Input "Implantaá∆o" /*l_implantacao*/,
                                   Input yes) /*prg_fnc_impto_impl_pend_ap_retidos*/.
    end.
    else do:
        if p_ind_tip_impto = "IVA" /*l_iva*/  then do:
            for each impto_impl_pend_ap no-lock
               where impto_impl_pend_ap.cod_estab_refer = antecip_pef_pend.cod_estab
                 and impto_impl_pend_ap.cod_refer = antecip_pef_pend.cod_refer
                 and impto_impl_pend_ap.ind_clas_impto = "Valor Agregado" /*l_valor_agregado*/ :

                assign antecip_pef_pend.val_tit_ap:screen-value in frame f_adp_02_antecip_pef_pend = string(antecip_pef_pend.val_tit_ap - impto_impl_pend_ap.val_imposto)
                       antecip_pef_pend.val_tit_ap = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.val_tit_ap.
            end.

            run prgfin/apb/apb759za.p (Input antecip_pef_pend.cod_estab,
                                       Input antecip_pef_pend.cod_refer,
                                       Input 0,
                                       Input antecip_pef_pend.cod_indic_econ,
                                       Input antecip_pef_pend.val_tit_ap,
                                       Input antecip_pef_pend.dat_emis_docto,
                                       Input yes) /*prg_fnc_impto_impl_pend_ap_iva*/.

            for each impto_impl_pend_ap no-lock
               where impto_impl_pend_ap.cod_estab_refer = antecip_pef_pend.cod_estab
                 and impto_impl_pend_ap.cod_refer = antecip_pef_pend.cod_refer
                 and impto_impl_pend_ap.ind_clas_impto = "Valor Agregado" /*l_valor_agregado*/ :

                assign antecip_pef_pend.val_tit_ap:screen-value in frame f_adp_02_antecip_pef_pend = string(antecip_pef_pend.val_tit_ap + impto_impl_pend_ap.val_imposto)
                       antecip_pef_pend.val_tit_ap = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.val_tit_ap.
            end.
        end.
        else
            run prgfin/apb/apb744za.p (Input antecip_pef_pend.cod_estab,
                                       Input antecip_pef_pend.cod_refer,
                                       Input 0,
                                       Input antecip_pef_pend.num_pessoa,
                                       Input antecip_pef_pend.cod_tit_ap,
                                       Input antecip_pef_pend.cod_parcela,
                                       Input antecip_pef_pend.dat_emis_docto,
                                       Input antecip_pef_pend.dat_emis_docto,
                                       Input antecip_pef_pend.dat_emis_docto,
                                       Input antecip_pef_pend.dat_emis_docto,
                                       Input antecip_pef_pend.cod_indic_econ,
                                       Input antecip_pef_pend.val_tit_ap,
                                       Input yes) /*prg_fnc_impto_impl_pend_ap_taxados*/.
    end.

    run pi_verifica_relacoes_antecip_pef_pend /*pi_verifica_relacoes_antecip_pef_pend*/.
END PROCEDURE. /* pi_antecip_pef_pend_impto_retido_taxado */
/*****************************************************************************
** Procedure Interna.....: pi_vincul_impto_retido_fornec_fin
** Descricao.............: pi_vincul_impto_retido_fornec_fin
** Criado por............: Marcelo
** Criado em.............: 01/12/1998 14:51:50
** Alterado por..........: bre18805
** Alterado em...........: 02/08/1999 17:54:42
*****************************************************************************/
PROCEDURE pi_vincul_impto_retido_fornec_fin:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_empresa
        as character
        format "x(3)"
        no-undo.
    def Input param p_cdn_fornecedor
        as Integer
        format ">>>,>>>,>>9"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_log_answer                     as logical         no-undo. /*local*/


    /************************** Variable Definition End *************************/

    find first fornec_financ no-lock
        where fornec_financ.cod_empresa = p_cod_empresa
        and   fornec_financ.cdn_fornecedor = p_cdn_fornecedor no-error.
    if  not avail fornec_financ
    then do:
        /* Fornecedor Financeiro Inexistente ! */
        run pi_messages (input "show",
                         input 537,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_537*/.
        return.
    end /* if */.    
    if avail fornec_financ then do:
        assign v_rec_fornec_financ = recid(fornec_financ).
        if  fornec_financ.log_retenc_impto = no
        then do:
            run pi_messages (input "show",
                             input 7183,
                             input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                               p_cdn_fornecedor)).
            assign v_log_answer = (if   return-value = "yes" then yes
                                   else if return-value = "no" then no
                                   else ?) /*msg_7183*/.
            if  v_log_answer = yes
            then do:
                if  search("prgint/ufn/ufn003ea.r") = ? and search("prgint/ufn/ufn003ea.p") = ? then do:
                    if  v_cod_dwb_user begins 'es_' then
                        return "Programa execut†vel n∆o foi encontrado:" /*l_programa_nao_encontrado*/  + "prgint/ufn/ufn003ea.p".
                    else do:
                        message getStrTrans("Programa execut†vel n∆o foi encontrado:", "APB") /*l_programa_nao_encontrado*/  "prgint/ufn/ufn003ea.p"
                               view-as alert-box error buttons ok.
                        return.
                    end.
                end.
                else
                    run prgint/ufn/ufn003ea.p /*prg_mod_fornec_financ*/.
            end /* if */.
        end /* if */.
        if  fornec_financ.log_retenc_impto = no
        then do:
            /* N∆o pode vincular imposto ao fornecedor ! */
            run pi_messages (input "show",
                             input 7185,
                             input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                p_cdn_fornecedor)) /*msg_7185*/.
            return.
        end /* if */.
        if  search("prgint/ufn/ufn003ma.r") = ? and search("prgint/ufn/ufn003ma.p") = ? then do:
            if  v_cod_dwb_user begins 'es_' then
                return "Programa execut†vel n∆o foi encontrado:" /*l_programa_nao_encontrado*/  + "prgint/ufn/ufn003ma.p".
            else do:
                message getStrTrans("Programa execut†vel n∆o foi encontrado:", "APB") /*l_programa_nao_encontrado*/  "prgint/ufn/ufn003ma.p"
                       view-as alert-box error buttons ok.
                return.
            end.
        end.
        else
            run prgint/ufn/ufn003ma.p /*prg_frm_impto_vincul_fornec_fin*/.
    end.    



END PROCEDURE. /* pi_vincul_impto_retido_fornec_fin */
/*****************************************************************************
** Procedure Interna.....: pi_retorna_sugestao_referencia
** Descricao.............: pi_retorna_sugestao_referencia
** Criado por............: Barth
** Criado em.............: 21/10/1998 09:14:30
** Alterado por..........: Souza
** Alterado em...........: 18/05/1999 10:12:58
*****************************************************************************/
PROCEDURE pi_retorna_sugestao_referencia:

    /************************ Parameter Definition Begin ************************/

    def Input param p_ind_tip_atualiz
        as character
        format "X(08)"
        no-undo.
    def Input param p_dat_refer
        as date
        format "99/99/9999"
        no-undo.
    def output param p_cod_refer
        as character
        format "x(10)"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_des_dat                        as character       no-undo. /*local*/
    def var v_num_aux                        as integer         no-undo. /*local*/
    def var v_num_aux_2                      as integer         no-undo. /*local*/
    def var v_num_cont                       as integer         no-undo. /*local*/


    /************************** Variable Definition End *************************/

    assign v_des_dat   = string(p_dat_refer,"99999999")
           p_cod_refer = substring(v_des_dat,7,2)
                       + substring(v_des_dat,3,2)
                       + substring(v_des_dat,1,2)
                       + substring(p_ind_tip_atualiz,1,1)
           v_num_aux_2 = integer(this-procedure:handle).

    do  v_num_cont = 1 to 3:
        assign v_num_aux   = (random(0,v_num_aux_2) mod 26) + 97
               p_cod_refer = p_cod_refer + chr(v_num_aux).
    end.
END PROCEDURE. /* pi_retorna_sugestao_referencia */
/*****************************************************************************
** Procedure Interna.....: pi_integr_apb_cria_msg_erro
** Descricao.............: pi_integr_apb_cria_msg_erro
** Criado por............: Roberto
** Criado em.............: 07/05/1997 08:13:38
** Alterado por..........: fut41061
** Alterado em...........: 28/04/2015 15:33:17
*****************************************************************************/
PROCEDURE pi_integr_apb_cria_msg_erro:

    /************************ Parameter Definition Begin ************************/

    def Input param p_nom_attrib
        as character
        format "x(30)"
        no-undo.
    def Input param p_cod_estab
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def Input param p_cod_refer
        as character
        format "x(10)"
        no-undo.
    def Input param p_num_seq_refer
        as integer
        format ">>>9"
        no-undo.
    def Input param p_ind_tip_relacto
        as character
        format "X(15)"
        no-undo.
    def Input param p_num_relacto
        as integer
        format ">>>>,>>9"
        no-undo.
    def Input param p_num_mensagem
        as integer
        format ">>>>,>>9"
        no-undo.
    def Input param p_cod_parameters
        as character
        format "x(256)"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_des_ajuda
        as character
        format "x(50)":U
        view-as editor max-chars 2000 scrollbar-vertical
        size 50 by 3
        bgcolor 15 font 2
        label "Ajuda"
        column-label "Ajuda"
        no-undo.
    def var v_des_mensagem
        as character
        format "x(50)":U
        view-as editor max-chars 2000 scrollbar-vertical
        size 50 by 4
        bgcolor 15 font 2
        label "Mensagem"
        column-label "Mensagem"
        no-undo.
    def var v_num_mensagem
        as integer
        format ">>>>,>>9":U
        label "N£mero"
        column-label "N£mero Mensagem"
        no-undo.
    def var v_wgh_attrib
        as widget-handle
        format ">>>>>>9":U
        no-undo.
    def var v_num_count                      as integer         no-undo. /*local*/


    /************************** Variable Definition End *************************/

    assign v_num_mensagem = p_num_mensagem. 

    if valid-handle( v_wgh_frame ) then do: 
        assign v_wgh_attrib = v_wgh_frame:first-child 
               v_wgh_attrib = v_wgh_attrib:first-child. 

        proc_atrib_block: 
        do while valid-handle( v_wgh_attrib ): 
            if  v_wgh_attrib:table <> ? then do:
                if  v_wgh_attrib:table + "." + v_wgh_attrib:name = p_nom_attrib then do: 
                    leave proc_atrib_block. 
                end. 
            end.
            else do:
                if  v_wgh_attrib:name = p_nom_attrib then do: 
                    leave proc_atrib_block. 
                end.
            end.     
            assign v_wgh_attrib = v_wgh_attrib:next-sibling. 
        end /* do proc_atrib_block */. 
    end. 

    do  v_num_count = num-entries( p_cod_parameters ) to 9: 
        assign p_cod_parameters = p_cod_parameters + ",". 
    end. 

    if  v_ind_modo_impl = "On-Line" /*l_online*/   then do: 
        run pi_messages (input "show",
                         input v_num_mensagem,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                            entry( 1, p_cod_parameters ),                                  entry( 2, p_cod_parameters ),                                  entry( 3, p_cod_parameters ),                                  entry( 4, p_cod_parameters ),                                  entry( 5, p_cod_parameters ),                                  entry( 6, p_cod_parameters ),                                  entry( 7, p_cod_parameters ),                                  entry( 8, p_cod_parameters ),                                  entry( 9, p_cod_parameters ))). 
        assign v_wgh_focus = v_wgh_attrib. 
        return error. 
    end. 
    else do: 
        assign v_log_erro_lote = yes. 
        run pi_messages (input "msg",
                         input v_num_mensagem,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")).
        assign v_des_mensagem = return-value /*msg_v_num_mensagem*/.  
        run pi_messages (input "help",
                         input v_num_mensagem,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")).
        assign v_des_ajuda = return-value /*msg_v_num_mensagem*/.   
        create tt_log_erros_atualiz. 
        assign tt_log_erros_atualiz.tta_cod_estab       = p_cod_estab 
               tt_log_erros_atualiz.tta_cod_refer       = p_cod_refer 
               tt_log_erros_atualiz.tta_num_seq_refer   = p_num_seq_refer 
               tt_log_erros_atualiz.ttv_ind_tip_relacto = p_ind_tip_relacto 
               tt_log_erros_atualiz.ttv_num_relacto     = p_num_relacto 
               tt_log_erros_atualiz.ttv_num_mensagem    = p_num_mensagem 
               tt_log_erros_atualiz.ttv_des_msg_erro    = substitute( v_des_mensagem, entry( 1, p_cod_parameters ), entry( 2, p_cod_parameters ), entry( 3, p_cod_parameters ), entry( 4, p_cod_parameters ), entry( 5, p_cod_parameters ), entry( 6, p_cod_parameters ), entry( 7, p_cod_parameters ), entry( 8, p_cod_parameters ), entry( 9, p_cod_parameters ) ) 
               tt_log_erros_atualiz.ttv_des_msg_ajuda   = substitute( v_des_ajuda   , entry( 1, p_cod_parameters ), entry( 2, p_cod_parameters ), entry( 3, p_cod_parameters ), entry( 4, p_cod_parameters ), entry( 5, p_cod_parameters ), entry( 6, p_cod_parameters ), entry( 7, p_cod_parameters ), entry( 8, p_cod_parameters ), entry( 9, p_cod_parameters ) ). 
    end. 

END PROCEDURE. /* pi_integr_apb_cria_msg_erro */
/*****************************************************************************
** Procedure Interna.....: pi_ix_p25_add_antecip_pef_pend
** Descricao.............: pi_ix_p25_add_antecip_pef_pend
** Criado por............: bre17752
** Criado em.............: 23/06/1999 09:17:02
** Alterado por..........: bre17752
** Alterado em...........: 23/06/1999 09:19:08
*****************************************************************************/
PROCEDURE pi_ix_p25_add_antecip_pef_pend:

    if antecip_pef_pend.cod_empresa = "" then
        assign antecip_pef_pend.cod_empresa = fornecedor.cod_empresa.

    if antecip_pef_pend.cod_estab = "" then
        assign antecip_pef_pend.cod_estab = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab. 

    assign antecip_pef_pend.cod_usuar_gerac_movto = v_cod_usuar_corren
           antecip_pef_pend.ind_tip_refer         = "Antecipaá∆o" /*l_antecipacao*/ 
           antecip_pef_pend.ind_sit_pef_antecip   = "Em Digitaá∆o" /*l_em_digitacao*/ 
           antecip_pef_pend.cod_cart_bcia         = v_cod_cart_bcia
        &if '{&emsfin_version}' >= '5.03' &then
           antecip_pef_pend.ind_origin_tit_ap     = "APB" /*l_apb*/ 
        &endif.       

    run pi_acha_fornecedor_informado (output v_cdn_fornecedor,
                                      output v_num_pessoa) /*pi_acha_fornecedor_informado*/.
    assign antecip_pef_pend.cdn_fornecedor = v_cdn_fornecedor
           antecip_pef_pend.num_pessoa     = v_num_pessoa.

    /* **
     Esta vari†vel recebe valor no leave do indicador economico.
    ***/
    assign antecip_pef_pend.cod_finalid_econ = v_cod_finalid_econ.

    find proces_pagto no-lock
         where proces_pagto.cod_estab = antecip_pef_pend.cod_estab
           and proces_pagto.cod_refer_antecip_pef = antecip_pef_pend.cod_refer
          no-error.
    if  avail proces_pagto
    then do:
        assign v_ind_modo_pagto = proces_pagto.ind_modo_pagto.
    end /* if */.

    /* Esta vari†vel Ç testada na PI de validaá∆o para que n∆o sejam feitas consistàncias
     desnecess†rias na alteraá∆o de antecipaá‰es.
    */
    assign v_cod_tip_valid = "Inclus∆o" /*l_inclusao*/ .

    /* ## Se encontrar erro na validaá∆o do portador, habilita o bot∆o de zoom ##*/

    if v_log_habilit_portad = yes then do:
        enable bt_zoo_66406
               with frame f_adp_02_antecip_pef_pend.
    end.
END PROCEDURE. /* pi_ix_p25_add_antecip_pef_pend */
/*****************************************************************************
** Procedure Interna.....: pi_leave_cod_indic_econ_antecip_pef_pend_add
** Descricao.............: pi_leave_cod_indic_econ_antecip_pef_pend_add
** Criado por............: bre17752
** Criado em.............: 23/06/1999 11:06:17
** Alterado por..........: fut40574
** Alterado em...........: 29/09/2009 10:37:53
*****************************************************************************/
PROCEDURE pi_leave_cod_indic_econ_antecip_pef_pend_add:


    run pi_verificar_cheque_antecipacao /*pi_verificar_cheque_antecipacao*/.
    assign v_val_sdo = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.val_tit_ap.

    /* **
     Mostra imagem Cta Corrente
    ***/
    run pi_mostra_imagem_cta_corren (Input "",
                                     Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab,
                                     Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_portador,
                                     Input v_cod_cart_bcia,
                                     Input v_cod_finalid_econ) /*pi_mostra_imagem_cta_corren*/.
    find portad_finalid_econ
        where portad_finalid_econ.cod_estab   = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab
        and   portad_finalid_econ.cod_portador = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_portador
        and   portad_finalid_econ.cod_cart_bcia = v_cod_cart_bcia
        and   portad_finalid_econ.cod_finalid_econ = v_cod_finalid_econ no-lock no-error.
    if  avail portad_finalid_econ then
        assign v_cod_cta_corren = portad_finalid_econ.cod_cta_corren.
    else
        assign v_cod_cta_corren = "".

    /* incluido para buscar inicializar a cotacao */
    enable antecip_pef_pend.val_cotac_indic_econ
           v_val_cotac_indic_econ_inv
           with frame f_adp_02_antecip_pef_pend.
    run pi_retornar_indic_econ_corren_estab (Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab,
                                             Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.dat_emis_docto,
                                             output v_cod_indic_econ) /*pi_retornar_indic_econ_corren_estab*/.
    run pi_achar_cotac_indic_econ (Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_indic_econ,
                                   Input v_cod_indic_econ,
                                   Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.dat_emis_docto,
                                   Input "Real" /*l_real*/,
                                   output v_dat_cotac_indic_econ,
                                   output v_val_cotac_indic_econ,
                                   output v_cod_return) /*pi_achar_cotac_indic_econ*/.
    if  v_cod_return <> "OK" /*l_ok*/ 
    then do:

        if v_cod_indic_econ_ant <> input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_indic_econ then
            assign antecip_pef_pend.val_cotac_indic_econ:screen-value in frame f_adp_02_antecip_pef_pend = string(0).

        assign antecip_pef_pend.val_tit_ap:screen-value in frame f_adp_02_antecip_pef_pend = string(v_val_sdo).
    end /* if */.                                   
    else do:
       if v_cod_indic_econ_ant <> input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_indic_econ then do:
           if v_cod_indic_econ = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_indic_econ then do:
               disable antecip_pef_pend.val_cotac_indic_econ
                       v_val_cotac_indic_econ_inv
                       with frame f_adp_02_antecip_pef_pend.
               assign antecip_pef_pend.val_cotac_indic_econ:screen-value in frame f_adp_02_antecip_pef_pend = string(1)
                      antecip_pef_pend.val_tit_ap:screen-value in frame f_adp_02_antecip_pef_pend = string(v_val_sdo).
           end.
           else do:
               /* ******** (NASS - C‡DIGO A SER IMPLEMENTADO)
               @enable(@&(frame),antecip_pef_pend.val_cotac_indic_econ,
                                 v_val_cotac_indic_econ_inv).
               *********************************************/
               assign antecip_pef_pend.val_cotac_indic_econ:screen-value in frame f_adp_02_antecip_pef_pend = string(v_val_cotac_indic_econ).
           end.
       end.        
    end /* else */.

    assign v_cod_indic_econ_ant = antecip_pef_pend.cod_indic_econ:screen-value in frame f_adp_02_antecip_pef_pend.

END PROCEDURE. /* pi_leave_cod_indic_econ_antecip_pef_pend_add */
/*****************************************************************************
** Procedure Interna.....: pi_leave_cod_portador_antecip_pef_pend_add
** Descricao.............: pi_leave_cod_portador_antecip_pef_pend_add
** Criado por............: bre17752
** Criado em.............: 23/06/1999 11:06:52
** Alterado por..........: src531
** Alterado em...........: 30/07/2003 10:52:50
*****************************************************************************/
PROCEDURE pi_leave_cod_portador_antecip_pef_pend_add:

    /************************* Variable Definition Begin ************************/

    def var v_log_method
        as logical
        format "Sim/N∆o"
        initial yes
        no-undo.


    /************************** Variable Definition End *************************/


    if input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_portador = ""
    or input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_portador = ? then do:
        assign v_ind_modo_pagto:screen-value in frame f_adp_02_antecip_pef_pend = " "
               antecip_pef_pend.ind_favorec_cheq:screen-value in frame f_adp_02_antecip_pef_pend = " ".

        assign antecip_pef_pend.cod_forma_pagto:screen-value  in frame f_adp_02_antecip_pef_pend = ""
               antecip_pef_pend.nom_favorec_cheq:screen-value in frame f_adp_02_antecip_pef_pend = ""
               antecip_pef_pend.num_cheque:screen-value       in frame f_adp_02_antecip_pef_pend = ""
               antecip_pef_pend.num_talon_cheq:screen-value   in frame f_adp_02_antecip_pef_pend = "".

        disable antecip_pef_pend.ind_favorec_cheq
                v_ind_modo_pagto
                antecip_pef_pend.cod_forma_pagto
                antecip_pef_pend.nom_favorec_cheq
                antecip_pef_pend.num_talon_cheq
                antecip_pef_pend.num_cheque
                bt_zoo_178527
                with frame f_adp_02_antecip_pef_pend.    
    end.    
    else do:
        find portador no-lock
             where portador.cod_portador = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_portador
    &if "{&emsfin_version}" >= "5.01" &then
             use-index portador_id
    &endif
              /*cl_frame of portador*/ no-error.
        if (avail portador
        and (portador.ind_tip_portad = "Caixa" /*l_caixa*/  
        or   portador.ind_tip_portad = "M£tuo" /*l_mutuo*/ )) then do:
            assign v_ind_modo_pagto:{&UI_LIST_ITEM_PAIRS} = getLstItTrans(yes, ("Dinheiro" /*l_dinheiro*/  + ","), "APB")
                   v_ind_modo_pagto:screen-value in frame f_adp_02_antecip_pef_pend = ("Dinheiro" /*l_dinheiro*/ ).    
            assign antecip_pef_pend.ind_favorec_cheq:screen-value in frame f_adp_02_antecip_pef_pend = " ".
            enable v_ind_modo_pagto
                   antecip_pef_pend.cod_forma_pagto
                   bt_zoo_228185
                   with frame f_adp_02_antecip_pef_pend.
            if input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_portador <> "" then
                apply "value-changed" to v_ind_modo_pagto in frame f_adp_02_antecip_pef_pend.
            disable antecip_pef_pend.ind_favorec_cheq
                    v_ind_modo_pagto
                    antecip_pef_pend.nom_favorec_cheq
                    antecip_pef_pend.num_talon_cheq
                    antecip_pef_pend.num_cheque
                    bt_zoo_178527
                    with frame f_adp_02_antecip_pef_pend.
            assign antecip_pef_pend.cod_forma_pagto:screen-value  in frame f_adp_02_antecip_pef_pend = ""
                   antecip_pef_pend.nom_favorec_cheq:screen-value in frame f_adp_02_antecip_pef_pend = ""
                   antecip_pef_pend.num_cheque:screen-value       in frame f_adp_02_antecip_pef_pend = ""
                   antecip_pef_pend.num_talon_cheq:screen-value   in frame f_adp_02_antecip_pef_pend = "".
        end.
        else do:
            if (avail portador and portador.ind_tip_portad = "Banco" /*l_banco*/ ) then do:
               if getLstItUndoTrans(yes, v_ind_modo_pagto:{&UI_LIST_ITEM_PAIRS}) <> "Cheque,Borderì," /*l_cheq_bord*/  then
                  assign v_ind_modo_pagto:{&UI_LIST_ITEM_PAIRS} = getLstItTrans(yes, ("Cheque" /*l_cheque*/  + "," + "Borderì" /*l_bordero*/  + "," + " "), "APB").
               if  v_ind_modo_pagto:screen-value in frame f_adp_02_antecip_pef_pend = " " then
                  assign v_ind_modo_pagto:screen-value = " ". 

               if v_cod_portador_old <> input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_portador then do:
                   if  portador.ind_tip_portad = "Banco" /*l_banco*/ 
                   and v_ind_modo_pagto = "Borderì" /*l_bordero*/  then
                       assign v_ind_modo_pagto:screen-value = "Borderì" /*l_bordero*/ .

                   assign antecip_pef_pend.nom_favorec_cheq:screen-value in frame f_adp_02_antecip_pef_pend = ""
                          antecip_pef_pend.num_cheque:screen-value       in frame f_adp_02_antecip_pef_pend = ""
                          antecip_pef_pend.num_talon_cheq:screen-value   in frame f_adp_02_antecip_pef_pend = "".
               end.                                       

               run pi_verificar_cheque_antecipacao /*pi_verificar_cheque_antecipacao*/.
            end.
        end.
        apply "leave" to antecip_pef_pend.cod_indic_econ in frame f_adp_02_antecip_pef_pend.
    end.
    if v_ind_modo_pagto = "Cheque" /*l_cheque*/  then do:
        if v_cod_portador_old <> input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_portador then do:
             assign antecip_pef_pend.num_cheque:screen-value     in frame f_adp_02_antecip_pef_pend = " "
                    antecip_pef_pend.num_talon_cheq:screen-value in frame f_adp_02_antecip_pef_pend = " ".
        end.
    end.
END PROCEDURE. /* pi_leave_cod_portador_antecip_pef_pend_add */
/*****************************************************************************
** Procedure Interna.....: pi_leave_dat_emis_docto_antecip_pef_pend_add
** Descricao.............: pi_leave_dat_emis_docto_antecip_pef_pend_add
** Criado por............: bre17752
** Criado em.............: 23/06/1999 11:07:16
** Alterado por..........: bre18732
** Alterado em...........: 01/12/2000 11:46:04
*****************************************************************************/
PROCEDURE pi_leave_dat_emis_docto_antecip_pef_pend_add:

    /************************* Variable Definition Begin ************************/

    def var v_cod_indic_econ
        as character
        format "x(8)":U
        label "Moeda"
        column-label "Moeda"
        no-undo.


    /************************** Variable Definition End *************************/

    run pi_acha_fornecedor_informado (output v_cdn_fornecedor,
                                      output v_num_pessoa) /*pi_acha_fornecedor_informado*/.

    run pi_verifica_impto_vincul_fornec (Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab,
                                         Input v_cdn_fornecedor,
                                         Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.dat_emis_docto,
                                         output v_log_impto_vincul_fornec) /*pi_verifica_impto_vincul_fornec*/.

    if  v_log_impto_vincul_fornec = yes then
        enable bt_impto_retido2
               with frame f_adp_02_antecip_pef_pend.
    else
        disable bt_impto_retido2
                with frame f_adp_02_antecip_pef_pend.

    if  antecip_pef_pend.cod_indic_econ:screen-value in frame f_adp_02_antecip_pef_pend = ""
    or  antecip_pef_pend.cod_indic_econ:screen-value in frame f_adp_02_antecip_pef_pend = ? then do:
        run pi_retornar_indic_econ_corren_estab (Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab,
                                                 Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.dat_emis_docto,
                                                 output v_cod_indic_econ) /*pi_retornar_indic_econ_corren_estab*/.
        assign antecip_pef_pend.cod_indic_econ:screen-value in frame f_adp_02_antecip_pef_pend = v_cod_indic_econ.
    end.
    run pi_verificar_cheque_antecipacao /*pi_verificar_cheque_antecipacao*/.

    run pi_verificar_impto_taxado (Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab,
                                   Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.dat_emis_docto,
                                   output v_log_impto_taxado) /*pi_verificar_impto_taxado*/.

    if  v_log_impto_taxado = yes then
        enable bt_impto_taxado
               with frame f_adp_02_antecip_pef_pend.
    else
        disable bt_impto_taxado
                with frame f_adp_02_antecip_pef_pend.

    apply "leave" to antecip_pef_pend.cod_indic_econ in frame f_adp_02_antecip_pef_pend.

    assign antecip_pef_pend.dat_vencto_tit_ap = date(antecip_pef_pend.dat_emis_docto:screen-value in frame f_adp_02_antecip_pef_pend).
END PROCEDURE. /* pi_leave_dat_emis_docto_antecip_pef_pend_add */
/*****************************************************************************
** Procedure Interna.....: pi_leave_v_cod_fornec_infor_antecip_pef_pend_add
** Descricao.............: pi_leave_v_cod_fornec_infor_antecip_pef_pend_add
** Criado por............: bre17752
** Criado em.............: 23/06/1999 11:08:08
** Alterado por..........: carinah
** Alterado em...........: 12/12/2017 15:48:28
*****************************************************************************/
PROCEDURE pi_leave_v_cod_fornec_infor_antecip_pef_pend_add:

    assign v_cod_fornec_infor_ant = v_cod_fornec_infor
           v_log_reg_corporat = no.
    &if '{&emsfin_version}' >= '5.03' &then
        find last param_geral_apb no-lock no-error.
        if avail param_geral_apb then do:
            if param_geral_apb.log_reg_corporat then do:
                assign v_log_reg_corporat = yes.
            end.
        end.
    &endif
    if v_log_reg_corporat then do:

         /* Begin_Include: i_informar_chave_tab_relac_pessoa_fisic_jurid_cor */
         if  v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend <> ""
         and v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend <> ?
         then do:

         /* find pais 
                 where pais.cod_pais = estabelecimento.cod_pais no-lock no-error.
             if  not avail pais then do:
                 find pais 
                     where recid(pais) = v_rec_pais no-lock no-error.
             end.
             @if(available pais)
                assign v_cod_pais = pais.cod_pais.
             @end_if().

             assign v_cod_fornec_infor. */

             assign input frame f_adp_02_antecip_pef_pend v_cod_fornec_infor
                          v_cod_pais = input frame f_adp_02_antecip_pef_pend fornecedor.cod_pais.

             assign v_cdn_fornecedor = integer(v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend) no-error.

             if  error-status:get-number(1) = 0
             then do:
                find fornecedor no-lock
                     where fornecedor.cod_empresa = estabelecimento.cod_empresa
                       and fornecedor.cdn_fornecedor = v_cdn_fornecedor /*cl_sea_fornecedor_variable_cor of fornecedor*/ no-error.
                if  not available fornecedor
                then do:
                   find first fornecedor no-lock
                        where fornecedor.cod_empresa = estabelecimento.cod_empresa
                          and fornecedor.nom_abrev = v_cod_fornec_infor /*cl_sea_fornecedor_infor_cor of fornecedor*/ no-error.
                   if  not available fornecedor
                   then do:
                      find fornecedor no-lock
                           where fornecedor.cod_empresa = estabelecimento.cod_empresa
                             and fornecedor.cod_pais = v_cod_pais
                             and fornecedor.cod_id_feder = v_cod_fornec_infor /*cl_sea_fornecedor_pais_id_federal_cor of fornecedor*/ no-error.
                      if  not available fornecedor
                      then do:
                         find first fornecedor no-lock
                              where fornecedor.cod_empresa = estabelecimento.cod_empresa
                                and fornecedor.cod_pais = v_cod_pais
                                and fornecedor.cod_id_feder = v_cod_fornec_infor /*cl_sea_fornecedor_pais_id_federal_cor of fornecedor*/ no-error.
                         if  available fornecedor
                         then do:
                            view frame f_dlg_01_fornecedor_id_feder.
                            enable all with frame f_dlg_01_fornecedor_id_feder.
                            open query qr_fornecedor_id_feder for
                               each fornecedor no-lock
                               where fornecedor.cod_empresa = estabelecimento.cod_empresa
                                 and fornecedor.cod_pais = v_cod_pais
                                 and fornecedor.cod_id_feder = v_cod_fornec_infor /*cl_sea_fornecedor_pais_id_federal_cor of fornecedor*/.
                            do  on endkey undo,leave:
                                wait-for window-close of current-window 
                                      or choose       of bt_ok
                                      or mouse-select-dblclick of br_fornecedor_id_feder.
                            end.
                            hide frame f_dlg_01_fornecedor_id_feder.
                            assign v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend = string(fornecedor.cdn_fornecedor).
                         end /* if */.
                      end /* if */.  
                      else do:
                         assign v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend = string(fornecedor.cdn_fornecedor).
                      end /* else */.   
                   end /* if */.
                end /* if */.
                else do:
                   assign v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend = string(fornecedor.cdn_fornecedor).
                end /* else */.
             end /* if */.
             else do:
                find fornecedor no-lock
                     where fornecedor.cod_empresa = estabelecimento.cod_empresa
                       and fornecedor.nom_abrev = v_cod_fornec_infor /*cl_sea_fornecedor_infor_cor of fornecedor*/ no-error.
                if  not available fornecedor
                then do:
                   find fornecedor no-lock
                        where fornecedor.cod_empresa = estabelecimento.cod_empresa
                          and fornecedor.cod_pais = v_cod_pais
                          and fornecedor.cod_id_feder = v_cod_fornec_infor /*cl_sea_fornecedor_pais_id_federal_cor of fornecedor*/ no-error.
                   if  not available fornecedor
                   then do:
                      find first fornecedor no-lock
                           where fornecedor.cod_empresa = estabelecimento.cod_empresa
                             and fornecedor.cod_pais = v_cod_pais
                             and fornecedor.cod_id_feder = v_cod_fornec_infor /*cl_sea_fornecedor_pais_id_federal_cor of fornecedor*/ no-error.
                      if  available fornecedor
                      then do:
                         view frame f_dlg_01_fornecedor_id_feder.
                         enable all with frame f_dlg_01_fornecedor_id_feder.
                         open query qr_fornecedor_id_feder for
                            each fornecedor no-lock
                            where fornecedor.cod_empresa = estabelecimento.cod_empresa
                              and fornecedor.cod_pais = v_cod_pais
                              and fornecedor.cod_id_feder = v_cod_fornec_infor /*cl_sea_fornecedor_pais_id_federal_cor of fornecedor*/.
                         do  on endkey undo,leave:
                             wait-for window-close of current-window 
                                   or choose       of bt_ok
                                   or mouse-select-dblclick of br_fornecedor_id_feder.
                         end.
                         hide frame f_dlg_01_fornecedor_id_feder.
                         assign v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend = string(fornecedor.cdn_fornecedor).
                      end /* if */.
                   end /* if */.   
                   else do:
                       assign v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend = string(fornecedor.cdn_fornecedor).
                   end /* else */.       
                end /* if */.
                else do:
                   assign v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend = string(fornecedor.cdn_fornecedor).
                end /* else */.
             end /* else */.
             if  available fornecedor
             then do:
                 assign fornecedor.cod_pais:screen-value in frame f_adp_02_antecip_pef_pend = fornecedor.cod_pais
                       fornecedor.nom_abrev:screen-value in frame f_adp_02_antecip_pef_pend = fornecedor.nom_abrev.
                 disable fornecedor.cod_pais
                         bt_zoo_66402
                         with frame f_adp_02_antecip_pef_pend.
             end /* if */.
             else do:
                 enable fornecedor.cod_pais
                        bt_zoo_66402
                        with frame f_adp_02_antecip_pef_pend.
                 assign fornecedor.cod_pais:screen-value  in frame f_adp_02_antecip_pef_pend = ""
                        fornecedor.nom_abrev:screen-value in frame f_adp_02_antecip_pef_pend = "".
             end /* else */.
         end /* if */.
         else do:
             enable fornecedor.cod_pais
                    bt_zoo_66402
                    with frame f_adp_02_antecip_pef_pend.
             assign fornecedor.cod_pais:screen-value  in frame f_adp_02_antecip_pef_pend = ""
                    fornecedor.nom_abrev:screen-value in frame f_adp_02_antecip_pef_pend = "".
         end /* else */.
         /* End_Include: i_informar_chave_tab_relac_pessoa_fisic_jurid_cor */

    end.
    else do:

        /* Begin_Include: i_informar_chave_tab_relac_pessoa_fisic_jurid */
        if  v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend <> ""
        and v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend <> ?
        then do:

        /* find pais 
                where pais.cod_pais = estabelecimento.cod_pais no-lock no-error.
            if  not avail pais then do:
                find pais 
                    where recid(pais) = v_rec_pais no-lock no-error.
            end.
            @if(available pais)
               assign v_cod_pais = pais.cod_pais.
            @end_if().

            assign v_cod_fornec_infor. */

            assign input frame f_adp_02_antecip_pef_pend v_cod_fornec_infor
                         v_cod_pais = input frame f_adp_02_antecip_pef_pend fornecedor.cod_pais.

            assign v_cdn_fornecedor = integer(v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend) no-error.

            if  error-status:get-number(1) = 0
            then do:
               find fornecedor no-lock
                    where fornecedor.cod_empresa = v_cod_empres_usuar
                      and fornecedor.cdn_fornecedor = v_cdn_fornecedor /*cl_sea_fornecedor_variable of fornecedor*/ no-error.
               if  not available fornecedor
               then do:
                  find first fornecedor no-lock
                       where fornecedor.cod_empresa = v_cod_empres_usuar
                         and fornecedor.nom_abrev = v_cod_fornec_infor /*cl_sea_fornecedor_infor of fornecedor*/ no-error.
                  if  not available fornecedor
                  then do:
                     assign v_cod_fornec_infor = replace(v_cod_fornec_infor, '.', '')
                            v_cod_fornec_infor = replace(v_cod_fornec_infor, '/', '')
                            v_cod_fornec_infor = replace(v_cod_fornec_infor, '-', '').
                     find fornecedor no-lock
                          where fornecedor.cod_empresa = v_cod_empres_usuar
                            and fornecedor.cod_pais = v_cod_pais
                            and fornecedor.cod_id_feder = v_cod_fornec_infor /*cl_sea_fornecedor_pais_id_federal of fornecedor*/ no-error.
                     if  not available fornecedor
                     then do:
                        find first fornecedor no-lock
                             where fornecedor.cod_empresa = v_cod_empres_usuar
                               and fornecedor.cod_pais = v_cod_pais
                               and fornecedor.cod_id_feder = v_cod_fornec_infor /*cl_sea_fornecedor_pais_id_federal of fornecedor*/ no-error.
                        if  available fornecedor
                        then do:
                           view frame f_dlg_01_fornecedor_id_feder.
                           enable all with frame f_dlg_01_fornecedor_id_feder.
                           open query qr_fornecedor_id_feder for
                              each fornecedor no-lock
                              where fornecedor.cod_empresa = v_cod_empres_usuar
                                and fornecedor.cod_pais = v_cod_pais
                                and fornecedor.cod_id_feder = v_cod_fornec_infor /*cl_sea_fornecedor_pais_id_federal of fornecedor*/.
                           do  on endkey undo,leave:
                               wait-for window-close of current-window 
                                     or choose       of bt_ok
                                     or mouse-select-dblclick of br_fornecedor_id_feder.
                           end.
                           hide frame f_dlg_01_fornecedor_id_feder.
                           assign v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend = string(fornecedor.cdn_fornecedor).
                        end /* if */.
                     end /* if */.  
                     else do:
                        assign v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend = string(fornecedor.cdn_fornecedor).
                     end /* else */.   
                  end /* if */.
               end /* if */.
               else do:
                  assign v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend = string(fornecedor.cdn_fornecedor).
               end /* else */.
            end /* if */.
            else do:
               find fornecedor no-lock
                    where fornecedor.cod_empresa = v_cod_empres_usuar
                      and fornecedor.nom_abrev = v_cod_fornec_infor /*cl_sea_fornecedor_infor of fornecedor*/ no-error.
               if  not available fornecedor
               then do:
                  assign v_cod_fornec_infor = replace(v_cod_fornec_infor, '.', '')
                         v_cod_fornec_infor = replace(v_cod_fornec_infor, '/', '')
                         v_cod_fornec_infor = replace(v_cod_fornec_infor, '-', '').
                  find fornecedor no-lock
                       where fornecedor.cod_empresa = v_cod_empres_usuar
                         and fornecedor.cod_pais = v_cod_pais
                         and fornecedor.cod_id_feder = v_cod_fornec_infor /*cl_sea_fornecedor_pais_id_federal of fornecedor*/ no-error.
                  if  not available fornecedor
                  then do:
                     find first fornecedor no-lock
                          where fornecedor.cod_empresa = v_cod_empres_usuar
                            and fornecedor.cod_pais = v_cod_pais
                            and fornecedor.cod_id_feder = v_cod_fornec_infor /*cl_sea_fornecedor_pais_id_federal of fornecedor*/ no-error.
                     if  available fornecedor
                     then do:
                        view frame f_dlg_01_fornecedor_id_feder.
                        enable all with frame f_dlg_01_fornecedor_id_feder.
                        open query qr_fornecedor_id_feder for
                           each fornecedor no-lock
                           where fornecedor.cod_empresa = v_cod_empres_usuar
                             and fornecedor.cod_pais = v_cod_pais
                             and fornecedor.cod_id_feder = v_cod_fornec_infor /*cl_sea_fornecedor_pais_id_federal of fornecedor*/.
                        do  on endkey undo,leave:
                            wait-for window-close of current-window 
                                  or choose       of bt_ok
                                  or mouse-select-dblclick of br_fornecedor_id_feder.
                        end.
                        hide frame f_dlg_01_fornecedor_id_feder.
                        assign v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend = string(fornecedor.cdn_fornecedor).
                     end /* if */.

                  end /* if */.   
                  else do:
                      assign v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend = string(fornecedor.cdn_fornecedor).
                  end /* else */.       
               end /* if */.
               else do:
                  assign v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend = string(fornecedor.cdn_fornecedor).
               end /* else */.
            end /* else */.
            if  available fornecedor
            then do:
                assign fornecedor.cod_pais:screen-value in frame f_adp_02_antecip_pef_pend = fornecedor.cod_pais
                      fornecedor.nom_abrev:screen-value in frame f_adp_02_antecip_pef_pend = fornecedor.nom_abrev.
                disable fornecedor.cod_pais
                        bt_zoo_66402
                        with frame f_adp_02_antecip_pef_pend.
            end /* if */.
            else do:
                enable fornecedor.cod_pais
                       bt_zoo_66402
                       with frame f_adp_02_antecip_pef_pend.
                assign fornecedor.cod_pais:screen-value  in frame f_adp_02_antecip_pef_pend = ""
                       fornecedor.nom_abrev:screen-value in frame f_adp_02_antecip_pef_pend = "".
            end /* else */.
        end /* if */.
        else do:
            enable fornecedor.cod_pais
                   bt_zoo_66402
                   with frame f_adp_02_antecip_pef_pend.
            assign fornecedor.cod_pais:screen-value  in frame f_adp_02_antecip_pef_pend = ""
                   fornecedor.nom_abrev:screen-value in frame f_adp_02_antecip_pef_pend = "".
        end /* else */.
        /* End_Include: i_informar_chave_tab_relac_pessoa_fisic_jurid */

    end.
    assign v_cod_pais = input frame f_adp_02_antecip_pef_pend fornecedor.cod_pais.
    enable fornecedor.cod_pais
           bt_zoo_66402
           with frame f_adp_02_antecip_pef_pend.

    if v_cod_pais = "" then return.

    if  v_cod_pais_empres_usuar = "BRA" /*l_bra*/  then do:
        /* eSocial - Iteraá∆o 01*/
        assign v_cod_tip_fornecto = "".
        find first fornec_financ
            where fornec_financ.cod_empresa    = v_cod_empres_usuar
            and   fornec_financ.cdn_fornecedor = integer(v_cod_fornec_infor) no-lock no-error.
        if avail fornec_financ then do:
            if fornec_financ.ind_tip_fornecto = "Prod/Ser" /*l_prod_ser*/ 
            or fornec_financ.ind_tip_fornecto = "Serviáos" /*l_servicos*/ 
            or fornec_financ.ind_tip_fornecto = "Ambos" /*l_ambos*/  
            or fornec_financ.ind_tip_fornecto = "PR Rural" /*l_pr_rural*/  then do:
                assign v_cod_tip_fornecto = fornec_financ.ind_tip_fornecto.
                &if defined(BF_FIN_ESOCIAL) &then
                    assign v_log_cop_aux     = fornec_financ.log_cooperat
                           v_log_assoc_despr = fornec_financ.log_assoc_desport.
                &else
                    assign v_log_cop_aux     = fornec_financ.log_livre_1
                           v_log_assoc_despr = fornec_financ.log_livre_2.
                &endif
            end.
        end.
        /* eSocial - Iteraá∆o 01*/
    end.

    assign v_cod_portador_old = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_portador.
    assign antecip_pef_pend.cdn_fornecedor = int(input frame f_adp_02_antecip_pef_pend v_cod_fornec_infor)
           antecip_pef_pend.cod_empresa    = v_cod_empres_usuar_2.

    if antecip_pef_pend.cod_portador:sensitive in frame f_adp_02_antecip_pef_pend = yes then do:
        if v_cod_fornec_infor_ant <> v_cod_fornec_infor:screen-value then do:
            assign v_log_portador = yes.
        end.          
    end.    

    run pi_informar_chave_tab_relac_pessoa_fisic_jurid /*pi_informar_chave_tab_relac_pessoa_fisic_jurid*/.

    run pi_verifica_impto_vincul_fornec (Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab,
                                         Input v_cdn_fornecedor,
                                         Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.dat_emis_docto,
                                         output v_log_impto_vincul_fornec) /*pi_verifica_impto_vincul_fornec*/.
    if  v_log_impto_vincul_fornec = yes then
        enable bt_impto_retido2
               with frame f_adp_02_antecip_pef_pend.
    else
        disable bt_impto_retido2
                with frame f_adp_02_antecip_pef_pend.

    if v_log_portador = yes then do:
        if  avail fornecedor then do:
            find first fornec_financ no-lock
                 where fornec_financ.cdn_fornecedor = fornecedor.cdn_fornecedor
                   and fornec_financ.cod_empresa = fornecedor.cod_empresa
                  no-error.
            if  avail fornec_financ then
                assign antecip_pef_pend.cod_portador:screen-value in frame f_adp_02_antecip_pef_pend = fornec_financ.cod_portador.
                assign v_ind_modo_pagto = input frame f_adp_02_antecip_pef_pend v_ind_modo_pagto.
        end.
        assign v_log_portador = no.    
    end.        


    /* Begin_Include: i_pi_leave_v_cod_fornec_infor_antecip_pef_pend_add */
    IF  v_log_localiz_equador
    AND AVAIL fornec_financ THEN DO:

       ASSIGN v_cod_forma_pagto_equador:VISIBLE IN FRAME f_adp_02_antecip_pef_pend  = YES.

       CASE  GetEntryField(1,fornec_financ.cod_livre_2,CHR(10)):
           WHEN "01" THEN ASSIGN v_cod_forma_pagto_equador:screen-value in frame f_adp_02_antecip_pef_pend = "01-Sem sist fin" /*l_01sem_sist_fin*/ .   
           WHEN "02" THEN ASSIGN v_cod_forma_pagto_equador:screen-value in frame f_adp_02_antecip_pef_pend = "02-Cheque pr¢p" /*l_02cheque_prop*/ .    
           WHEN "03" THEN ASSIGN v_cod_forma_pagto_equador:screen-value in frame f_adp_02_antecip_pef_pend = "03-Cheque adm" /*l_03cheque_adm*/ .     
           WHEN "04" THEN ASSIGN v_cod_forma_pagto_equador:screen-value in frame f_adp_02_antecip_pef_pend = "04-Cheq geren" /*l_04cheq_geren*/ .     
           WHEN "05" THEN ASSIGN v_cod_forma_pagto_equador:screen-value in frame f_adp_02_antecip_pef_pend = "05-Cheq do ext" /*l_05cheq_do_ext*/ .    
           WHEN "06" THEN ASSIGN v_cod_forma_pagto_equador:screen-value in frame f_adp_02_antecip_pef_pend = "06-DÇbito em cta" /*l_06debito_em_cta*/ .  
           WHEN "07" THEN ASSIGN v_cod_forma_pagto_equador:screen-value in frame f_adp_02_antecip_pef_pend = "07-Trf msm bco" /*l_07trf_msm_bco*/ .    
           WHEN "08" THEN ASSIGN v_cod_forma_pagto_equador:screen-value in frame f_adp_02_antecip_pef_pend = "08-Trf outro bco" /*l_08trf_outro_bco*/ .  
           WHEN "09" THEN ASSIGN v_cod_forma_pagto_equador:screen-value in frame f_adp_02_antecip_pef_pend = "09-Trf bco ext" /*l_09trf_bco_ext*/ .    
           WHEN "10" THEN ASSIGN v_cod_forma_pagto_equador:screen-value in frame f_adp_02_antecip_pef_pend = "10-Cart crÇd nac" /*l_10cart_cred_nac*/ .  
           WHEN "11" THEN ASSIGN v_cod_forma_pagto_equador:screen-value in frame f_adp_02_antecip_pef_pend = "11-Cart crÇd int" /*l_11cart_cred_int*/ .  
           WHEN "12" THEN ASSIGN v_cod_forma_pagto_equador:screen-value in frame f_adp_02_antecip_pef_pend = "12-Cheque bcio" /*l_12cheque_bcio*/ .    
           WHEN "13" THEN ASSIGN v_cod_forma_pagto_equador:screen-value in frame f_adp_02_antecip_pef_pend = "13-Dep¢sito" /*l_13deposito*/ .  
           WHEN "14" THEN ASSIGN v_cod_forma_pagto_equador:screen-value in frame f_adp_02_antecip_pef_pend = "14-Endosso Invest" /*l_14endosso_invest*/ .
           WHEN "15" THEN ASSIGN v_cod_forma_pagto_equador:screen-value in frame f_adp_02_antecip_pef_pend = "15-Compens d°vida" /*l_15compens_divida*/ .

       END CASE.

       enable v_cod_forma_pagto_equador
           with frame f_adp_02_antecip_pef_pend.
    END.
    /* End_Include: i_pi_leave_v_cod_fornec_infor_antecip_pef_pend_add */


    apply "leave" to antecip_pef_pend.dat_emis_docto in frame f_adp_02_antecip_pef_pend.
    apply "leave" to antecip_pef_pend.cod_portador in frame f_adp_02_antecip_pef_pend.
END PROCEDURE. /* pi_leave_v_cod_fornec_infor_antecip_pef_pend_add */
/*****************************************************************************
** Procedure Interna.....: pi_leave_num_cheque_antecip_pef_pend_add
** Descricao.............: pi_leave_num_cheque_antecip_pef_pend_add
** Criado por............: bre17752
** Criado em.............: 23/06/1999 11:07:34
** Alterado por..........: bre19062
** Alterado em...........: 13/03/2003 09:21:52
*****************************************************************************/
PROCEDURE pi_leave_num_cheque_antecip_pef_pend_add:

    /************************* Variable Definition Begin ************************/

    def var v_cod_finalid_econ
        as character
        format "x(10)":U
        label "Finalidade Econìmica"
        column-label "Finalidade Econìmica"
        no-undo.
    def var v_ind_favorec_cheq
        as character
        format "X(15)":U
        view-as combo-box
        &if "{&FNC_MULTI_IDIOMA}" = "YES" &then
        list-item-pairs "","","Portador","Portador","Fornecedor","Fornecedor","Transferància","Transferància","Outros","Outros","Cod Fornecedor","Cod Fornecedor"
        &else
        list-items "","Portador","Fornecedor","Transferància","Outros","Cod Fornecedor"
        &endif
         /*l_null*/ /*l_portador*/ /*l_fornecedor*/ /*l_transferencia*/ /*l_outros*/ /*l_cod_fornec*/
        inner-lines 6
        bgcolor 15 font 2
        label "Favorecido"
        column-label "Favorecido"
        no-undo.
    def var v_log_cheq_ap_existen
        as logical
        format "Sim/N∆o"
        initial yes
        no-undo.
    def var v_nom_favorec_cheq
        as character
        format "x(40)":U
        label "Favorecido"
        column-label "Nome Favorecido"
        no-undo.


    /************************** Variable Definition End *************************/

    assign v_num_cheq = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.num_cheque.
    run pi_retornar_finalid_indic_econ (Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_indic_econ,
                                        Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.dat_emis_docto,
                                        output v_cod_finalid_econ) /*pi_retornar_finalid_indic_econ*/.
    find portad_finalid_econ no-lock
         where portad_finalid_econ.cod_estab = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab
           and portad_finalid_econ.cod_portador = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_portador
           and portad_finalid_econ.cod_cart_bcia = v_cod_cart_bcia
           and portad_finalid_econ.cod_finalid_econ = v_cod_finalid_econ
    &if "{&emsfin_version}" >= "5.01" &then
         use-index prtdfnld_id
    &endif
          /*cl_vrf_cheque_antecipacao of portad_finalid_econ*/ no-error.

    if  avail portad_finalid_econ then do:
        find cta_corren no-lock
             where cta_corren.cod_cta_corren = portad_finalid_econ.cod_cta_corren
              no-error.
        run pi_retornar_favorec_cheque (Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab,
                                        Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_portador,
                                        Input v_cod_finalid_econ,
                                        Input portad_finalid_econ.cod_cta_corren,
                                        Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.num_talon_cheq,
                                        Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.num_cheque,
                                        output v_log_cheq_ap_existen,
                                        output v_ind_favorec_cheq,
                                        output v_nom_favorec_cheq) /*pi_retornar_favorec_cheque*/.
        if  v_log_cheq_ap_existen = yes then
            assign antecip_pef_pend.ind_favorec_cheq:screen-value in frame f_adp_02_antecip_pef_pend = v_ind_favorec_cheq
                   antecip_pef_pend.nom_favorec_cheq:screen-value in frame f_adp_02_antecip_pef_pend = v_nom_favorec_cheq
                   antecip_pef_pend.ind_favorec_cheq:sensitive in frame f_adp_02_antecip_pef_pend    = no
                   antecip_pef_pend.nom_favorec_cheq:sensitive in frame f_adp_02_antecip_pef_pend    = no.
        else do:
            enable antecip_pef_pend.ind_favorec_cheq
                   with frame f_adp_02_antecip_pef_pend.
            apply "value-changed" to antecip_pef_pend.ind_favorec_cheq in frame f_adp_02_antecip_pef_pend.
        end.
    end.
    else do:
        enable antecip_pef_pend.ind_favorec_cheq
               with frame f_adp_02_antecip_pef_pend.
        apply "value-changed" to antecip_pef_pend.ind_favorec_cheq in frame f_adp_02_antecip_pef_pend.
    end.
END PROCEDURE. /* pi_leave_num_cheque_antecip_pef_pend_add */
/*****************************************************************************
** Procedure Interna.....: pi_vl_changed_ind_favorec_cheq_antecip_pef_pend_add
** Descricao.............: pi_vl_changed_ind_favorec_cheq_antecip_pef_pend_add
** Criado por............: bre17752
** Criado em.............: 23/06/1999 11:26:03
** Alterado por..........: fut42929
** Alterado em...........: 28/06/2011 09:14:55
*****************************************************************************/
PROCEDURE pi_vl_changed_ind_favorec_cheq_antecip_pef_pend_add:

    assign v_cod_empres_usuar_2 = v_cod_empres_usuar.
    &if '{&emsfin_version}' >= '5.03' &then
        find last param_geral_apb no-lock no-error.
        if avail param_geral_apb then do:
            if param_geral_apb.log_reg_corporat then do:
                find estabelecimento no-lock
                    where estabelecimento.cod_estab = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab no-error.
                if  avail estabelecimento
                then do:
                    assign v_cod_empres_usuar_2 = estabelecimento.cod_empresa.
                end /* if */.
            end.
       end.
    &endif  
    if  input frame f_adp_02_antecip_pef_pend antecip_pef_pend.ind_favorec_cheq = "Outros" /*l_outros*/  then do:
        enable antecip_pef_pend.nom_favorec_cheq
               with frame f_adp_02_antecip_pef_pend.
        if v_num_cheq = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.num_cheque and
             v_num_talon_cheq = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.num_talon_cheq then do:
             assign antecip_pef_pend.nom_favorec_cheq:screen-value in frame f_adp_02_antecip_pef_pend = v_nom_favorec.
        end.
        else do:
             assign antecip_pef_pend.nom_favorec_cheq:screen-value in frame f_adp_02_antecip_pef_pend = " ".
        end.
        assign antecip_pef_pend.nom_favorec_cheq:read-only in frame f_adp_02_antecip_pef_pend = no.
    end.
    else do:
        assign antecip_pef_pend.nom_favorec_cheq:screen-value in frame f_adp_02_antecip_pef_pend = "".
        if  input frame f_adp_02_antecip_pef_pend antecip_pef_pend.ind_favorec_cheq = "Portador" /*l_portador*/  then do:
            find portador no-lock
                 where portador.cod_portador = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_portador
                 no-error.
            if  avail portador then
                assign antecip_pef_pend.nom_favorec_cheq:screen-value in frame f_adp_02_antecip_pef_pend = portador.nom_pessoa.
        end.
        if  input frame f_adp_02_antecip_pef_pend antecip_pef_pend.ind_favorec_cheq = "Fornecedor" /*l_fornecedor*/ 
        or  (v_log_agrup_cheq_cod_fornec 
        and  input frame f_adp_02_antecip_pef_pend antecip_pef_pend.ind_favorec_cheq = "Cod Fornecedor" /*l_cod_fornec*/ )then do:
            find fornecedor no-lock
                 where fornecedor.cdn_fornecedor = integer( input frame f_adp_02_antecip_pef_pend v_cod_fornec_infor )
                   and fornecedor.cod_empresa    = v_cod_empres_usuar_2
                 no-error.
            if  avail fornecedor then do:
                if  input frame f_adp_02_antecip_pef_pend antecip_pef_pend.ind_favorec_cheq = "Fornecedor" /*l_fornecedor*/  then 
                    assign antecip_pef_pend.nom_favorec_cheq:screen-value in frame f_adp_02_antecip_pef_pend = fornecedor.nom_pessoa.
                else 
                    assign antecip_pef_pend.nom_favorec_cheq:screen-value in frame f_adp_02_antecip_pef_pend = CAPS("Fornecedor:" /*l_fornecedor:*/ ) + TRIM(string(fornecedor.cdn_fornecedor)).
            end.
        end.
        disable antecip_pef_pend.nom_favorec_cheq
                with frame f_adp_02_antecip_pef_pend.
        if  input frame f_adp_02_antecip_pef_pend antecip_pef_pend.ind_favorec_cheq = "Fornecedor" /*l_fornecedor*/  then
            assign antecip_pef_pend.nom_favorec_cheq:sensitive in frame f_adp_02_antecip_pef_pend = yes
                   antecip_pef_pend.nom_favorec_cheq:read-only in frame f_adp_02_antecip_pef_pend = yes.
    end.
END PROCEDURE. /* pi_vl_changed_ind_favorec_cheq_antecip_pef_pend_add */
/*****************************************************************************
** Procedure Interna.....: pi_ix_p30_add_antecip_pef_pend
** Descricao.............: pi_ix_p30_add_antecip_pef_pend
** Criado por............: src12151
** Criado em.............: 04/09/2001 16:18:03
** Alterado por..........: fut42929_1
** Alterado em...........: 13/12/2012 16:52:48
*****************************************************************************/
PROCEDURE pi_ix_p30_add_antecip_pef_pend:

    /************************ Parameter Definition Begin ************************/

    def param buffer p_antecip_pef_pend
        for antecip_pef_pend.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_cod_empres_dest                as character       no-undo. /*local*/
    def var v_cod_moed                       as character       no-undo. /*local*/
    def var v_des_erro                       as character       no-undo. /*local*/
    def var v_log_aux                        as logical         no-undo. /*local*/
    def var v_num_empres_dest                as integer         no-undo. /*local*/
    def var v_num_natur                      as integer         no-undo. /*local*/


    /************************** Variable Definition End *************************/

    /* Integraá∆o Apb Ems5 X Investimentos Ems2.
       Verificar se a ordem de investimento Ç v†lida e se existe verba para
       Antecipaá∆o e impostos no m¢dulo de controle de investimentos ems2.
    */

    if  v_log_control_invest 
    and (v_num_ped_compra > 0
    or  v_num_ord_compra  > 0
    or  v_num_event       > 0) then do:
        &IF '{&emsfin_version}' < '5.07A' &THEN
        run pi_consistir_ordem_invest (output v_num_empres_dest) /* pi_consistir_ordem_invest*/.
        &ELSE
        run pi_consistir_ordem_invest (output v_cod_empres_dest) /* pi_consistir_ordem_invest*/.
        &ENDIF
        if return-value = "NOK" /*l_nok*/  then return "NOK" /*l_nok*/ .

        if v_num_ord_invest <= 0 then do:
            &IF '{&emsfin_version}' < '5.07A' &THEN
            run pi_messages (input 'show',
                                         input 11319,
                                         input substitute ('&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9',
                                                           v_num_empres_dest,v_num_ped_compra,v_num_ord_compra)) /* msg_11319*/.
            &ELSE
            run pi_messages (input 'show',
                                         input 11319,
                                         input substitute ('&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9',
                                                           v_cod_empres_dest,v_num_ped_compra,v_num_ord_compra)) /* msg_11319*/.
            &ENDIF
            return "NOK" /*l_nok*/ .
        end.

        for each   tt_log_erros_atualiz exclusive-lock:
            delete tt_log_erros_atualiz.
        end.
        for each   tt_integra_movto_apr exclusive-lock:
            delete tt_integra_movto_apr.
        end.

        create tt_integra_movto_apr.
        assign tt_integra_movto_apr.ttv_num_tip_movto         = 1
               tt_integra_movto_apr.ttv_cod_tip_docto         = "AN" /*l_an*/ 
               tt_integra_movto_apr.ttv_num_trans             = 2
               tt_integra_movto_apr.ttv_num_consist           = 1
               tt_integra_movto_apr.ttv_num_ord_invest_integr = v_num_ord_invest
               tt_integra_movto_apr.ttv_num_ped_integr        = v_num_ped_compra
               tt_integra_movto_apr.ttv_num_ord_compra_integr = v_num_ord_compra
               tt_integra_movto_apr.ttv_num_event_integr      = v_num_event
               tt_integra_movto_apr.ttv_dat_emis              = p_antecip_pef_pend.dat_emis_docto
               tt_integra_movto_apr.ttv_dat_vencto            = p_antecip_pef_pend.dat_vencto_tit_ap
               tt_integra_movto_apr.ttv_dat_trans             = p_antecip_pef_pend.dat_emis_docto
               tt_integra_movto_apr.ttv_num_emit_ems          = p_antecip_pef_pend.cdn_fornecedor
               tt_integra_movto_apr.ttv_cod_estab             = p_antecip_pef_pend.cod_estab
               tt_integra_movto_apr.ttv_cod_refer             = p_antecip_pef_pend.cod_refer
               tt_integra_movto_apr.ttv_cod_espec_docto       = p_antecip_pef_pend.cod_espec_docto
               tt_integra_movto_apr.ttv_cod_ser_docto         = p_antecip_pef_pend.cod_ser_docto
               tt_integra_movto_apr.ttv_cod_docto_integr      = p_antecip_pef_pend.cod_tit_ap
               tt_integra_movto_apr.ttv_cod_parcela           = p_antecip_pef_pend.cod_parcela
               tt_integra_movto_apr.ttv_val_docto_integr      = p_antecip_pef_pend.val_tit_ap
               tt_integra_movto_apr.ttv_cod_usuar             = v_cod_usuar_corren.

        if  search('prgfin/apb/apb789zb.r') = ? and search('prgfin/apb/apb789zb.py') = ? then do:
            if  v_cod_dwb_user begins 'es_' then
                return "Programa execut†vel n∆o foi encontrado:" /*l_programa_nao_encontrado*/  + 'prgfin/apb/apb789zb.py'.
            else do:
                message getStrTrans("Programa execut†vel n∆o foi encontrado:", "APB") /*l_programa_nao_encontrado*/  "prgfin/apb/apb789zb.py"
                       view-as alert-box error buttons ok.
                return.
            end.
        end.
        else
            run prgfin/apb/apb789zb.py (input table tt_integra_movto_apr,
                                    Input v_cod_empres_usuar,
                                    Input p_antecip_pef_pend.cod_indic_econ) /* prg_fnc_integr_apb_inv*/.
        find first tt_log_erros_atualiz no-lock no-error.
        if avail tt_log_erros_atualiz then do:
            assign v_des_erro = ''.
            if tt_log_erros_atualiz.ttv_des_msg_erro <> '' then
                assign v_des_erro = tt_log_erros_atualiz.ttv_des_msg_erro + chr(10).
            assign v_des_erro = v_des_erro + tt_log_erros_atualiz.ttv_des_msg_ajuda.
            /* Erro Integraá∆o Controle Investimentos EMS2 (&1) ! */
            run pi_messages (input "show",
                             input 11341,
                             input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                tt_log_erros_atualiz.ttv_num_mensagem,v_des_erro)) /*msg_11341*/.
            return "NOK" /*l_nok*/ .
        end.

        &if '{&emsfin_version}' >= '5.06' &then
            assign p_antecip_pef_pend.num_ord_invest   = v_num_ord_invest
                   p_antecip_pef_pend.num_ped_compra   = v_num_ped_compra
                   p_antecip_pef_pend.num_ord_compra   = v_num_ord_compra
                   p_antecip_pef_pend.num_event_invest = v_num_event.
        &else   
            if (num-entries(p_antecip_pef_pend.cod_livre_1,chr(10))) < 2 then
                assign p_antecip_pef_pend.cod_livre_1 = p_antecip_pef_pend.cod_livre_1 + chr(10) +
                                                        string(v_num_ord_invest)     + chr(10) +
                                                        string(v_num_ped_compra)     + chr(10) +
                                                        string(v_num_ord_compra)     + chr(10) +
                                                        string(v_num_event)          + chr(10).
            else
                assign p_antecip_pef_pend.cod_livre_1 = p_antecip_pef_pend.cod_livre_1 +
                                                        string(v_num_ord_invest)     + chr(10) +
                                                        string(v_num_ped_compra)     + chr(10) +
                                                        string(v_num_ord_compra)     + chr(10) +
                                                        string(v_num_event)          + chr(10).
        &endif 

    end.
    if antecip_pef_pend.ind_origin_tit_ap = "MEC" /*l_mec*/  then do: 
        find first param_integr_ems no-lock
           where param_integr_ems.ind_param_integr_ems = "CÉmbio 2.00 X FIN EMS 5" /*l_cambio_2.00_x_fin_ems_5*/  no-error.
        if  avail param_integr_ems THEN DO:
            run pi_verificar_fornec_estrangeiro (input p_antecip_pef_pend.cod_empresa,
                                                 input p_antecip_pef_pend.cdn_fornecedor, 
                                                 input p_antecip_pef_pend.cod_estab,
                                                 input p_antecip_pef_pend.cod_indic_econ,
                                                 input p_antecip_pef_pend.dat_emis_docto,
                                                 output v_cod_moed,
                                                 output v_num_natur).
            if  v_num_natur = 3 and
                v_cod_moed = "Estrangeiro" /*l_estrangeiro*/  then do:
                /* Antecipaá∆o n∆o poder† ser inclu°da/modificada/exclu°da ! */
                run pi_messages (input "show",
                                 input 12402,
                                 input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_12402*/.
                return "NOK" /*l_nok*/ .
            end.
        end.
    end.
    /* AGRONEGOCIO - PROXIMA */
    if  v_log_funcao_agro_negoc
    then do:
        find first portador no-lock
            where portador.cod_portador = antecip_pef_pend.cod_portador no-error.
        if avail portador and portador.ind_tip_portad = "Caixa" /*l_caixa*/  then do:
            find first fornecedor no-lock
                where fornecedor.cod_empresa = antecip_pef_pend.cod_empresa
                  and fornecedor.cdn_fornecedor = antecip_pef_pend.cdn_fornecedor no-error.
            if avail fornecedor then do:    
                find first grp_fornec no-lock
                   where grp_fornec.cod_grp_fornec = fornecedor.cod_grp_fornec no-error.
                if avail grp_fornec then do:
                    &if '{&emsbas_version}' >= '5.08' &then
                        assign v_log_envia_xml = grp_fornec.log_xml_apb.
                    &else
                        assign v_log_envia_xml = grp_fornec.log_livre_1.
                    &endif
                    if  v_log_envia_xml
                    then do:            
                        &if '{&emsbas_version}' >= '5.05' &then
                            if v_log_eai_habilit then do:
                                /* coloca o programa na memoria */
                                run prgfin/apb/apb426za.p PERSISTENT SET v_hdl_prog /*prg_fnc__executa_adapter_agro_apb*/.
                                if valid-handle(v_hdl_prog) then do:

                                    run pi_gera_mensagem_xml_antecipacao in v_hdl_prog (Input recid(antecip_pef_pend),
                                                                          output table tt_log_erros_atualiz,
                                                                          Input 1) /*pi_gera_mensagem_xml_antecipacao*/.



                                    delete procedure v_hdl_prog.
                                    find first tt_log_erros_atualiz
                                        where tt_log_erros_atualiz.ttv_num_mensagem = 60 no-error.
                                    if  avail tt_log_erros_atualiz then
                                        delete tt_log_erros_atualiz.
                                    if can-find(first tt_log_erros_atualiz) then
                                       return "NOK" /*l_nok*/ .
                                end.                            
                            end.
                        &endif
                    end /* if */.
                end.
            end.
        end.
    end /* if */.
END PROCEDURE. /* pi_ix_p30_add_antecip_pef_pend */
/*****************************************************************************
** Procedure Interna.....: pi_consistir_ordem_invest
** Descricao.............: pi_consistir_ordem_invest
** Criado por............: src12151
** Criado em.............: 16/09/2001 15:27:32
** Alterado por..........: fut43120_3
** Alterado em...........: 24/03/2009 10:21:06
*****************************************************************************/
PROCEDURE pi_consistir_ordem_invest:

    &IF '{&emsfin_version}' < '5.07A' &THEN
    def output param p_num_empresa
        as integer
        format '999'
        no-undo.
    &ELSE
    def output param p_cod_empresa
        as char
        format 'x(3)'
        no-undo.
    &ENDIF

    &if '{&ems_dbtype}' <> 'progress' &then
        if  connected("shmginv" /*l_shmginv*/ ) = no or connected("shmgind" /*l_shmgind*/ )  = no
        or  connected("shmgadm" /*l_shmgadm*/ ) = no or connected("shmovind" /*l_shmovind*/ ) = no 
        or  connected("shmguni" /*l_shmguni*/ ) = no then do:
    &else
        if  connected("mginv" /*l_mginv*/ ) = no or connected("mgind" /*l_mgind*/ )  = no
        or  connected("mgadm" /*l_mgadm*/ ) = no or connected("movind" /*l_movind*/ ) = no 
        or  connected("mguni" /*l_mguni*/ ) = no then do:
    &endif
        /* Base de dados mgadm n∆o esta conectada ! */
        run pi_messages (input "show",
                         input 4188,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_4188*/.
        return "NOK" /*l_nok*/ .
    end /* if */.

    assign v_num_ord_invest = 0.

    if  search('inp/inapi051.r') = ? and search('inp/inapi051.p') = ? then do:
        if  v_cod_dwb_user begins 'es_' then  do:
            return "Programa execut†vel n∆o foi encontrado:" /*l_programa_nao_encontrado*/  + 'inp/inapi051.p'.
        end.
        else do:
            message getStrTrans("Programa execut†vel n∆o foi encontrado:", "APB") /*l_programa_nao_encontrado*/  getStrTrans("inp/inapi051.p", "APB")
                   view-as alert-box error buttons ok.
            return "NOK" /*l_nok*/ .
        end.
    end.

    run pi_busca_empres_dest_integr_apb_inv (input  v_cod_empres_usuar,
                                             &IF '{&emsfin_version}' < '5.07A' &THEN
                                             output p_num_empresa).
                                             &ELSE
                                             output p_cod_empresa).
                                             &ENDIF

    run inp/inapi051.p (&IF '{&emsfin_version}' < '5.07A' &THEN
                        input  p_num_empresa,
                        &ELSE
                        input  p_cod_empresa,
                        &ENDIF
                        input  v_num_ped_compra,
                        input  v_num_ord_compra,
                        output v_num_ord_invest).
END PROCEDURE. /* pi_consistir_ordem_invest */
/*****************************************************************************
** Procedure Interna.....: pi_busca_empres_dest_integr_apb_inv
** Descricao.............: pi_busca_empres_dest_integr_apb_inv
** Criado por............: src12151
** Criado em.............: 27/08/2001 15:51:07
** Alterado por..........: fut35118
** Alterado em...........: 24/01/2011 15:42:52
*****************************************************************************/
PROCEDURE pi_busca_empres_dest_integr_apb_inv:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_empres_usuar
        as character
        format "x(3)"
        no-undo.


    /************************* Parameter Definition End *************************/

    &IF '{&emsfin_version}' < '5.07A' &THEN
    def output param p_num_empresa
        as integer
        format '999'
        no-undo.
    &ELSE
    def output param p_cod_empresa
        as char
        format 'x(3)'
        no-undo.
    &ENDIF

    find first param_integr_ems no-lock  
         where param_integr_ems.ind_param_integr_ems = "Controle Investimentos 2.00" /*l_controle_invest*/  no-error.
    if avail param_integr_ems then do:
        if param_integr_ems.des_contdo_param_integr_ems = "" then do:

             /* Matriz traduá∆o UO externa n∆o informada nos parametros ! */
             run pi_messages (input "show",
                              input 8803,
                              input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_8803*/.

            return "NOK" /*l_nok*/ .
        end.

        find first trad_org_ext
             where trad_org_ext.cod_matriz_trad_org_ext = param_integr_ems.des_contdo_param_integr_ems
               and trad_org_ext.cod_tip_unid_organ      = '998'
               and trad_org_ext.cod_unid_organ          = p_cod_empres_usuar no-lock no-error.
        if not avail trad_org_ext then do:

             /* Matriz de Traduá∆o da Organizaá∆o Externa &1 inv†lida ! */
             run pi_messages (input "show",
                              input 8856,
                              input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                 param_integr_ems.des_contdo_param_integr_ems)) /*msg_8856*/.

            return "NOK" /*l_nok*/ .
        end.

        &IF '{&emsfin_version}' < '5.07A' &THEN
        assign p_num_empresa = int(trad_org_ext.cod_unid_organ_ext).
        &ELSE
        assign p_cod_empresa = trad_org_ext.cod_unid_organ_ext.
        &ENDIF
    end.

    return.
END PROCEDURE. /* pi_busca_empres_dest_integr_apb_inv */
/*****************************************************************************
** Procedure Interna.....: pi_verificar_fornec_estrangeiro
** Descricao.............: pi_verificar_fornec_estrangeiro
** Criado por............: fut12178
** Criado em.............: 17/09/2002 09:04:50
** Alterado por..........: fut12178
** Alterado em...........: 11/10/2002 10:07:24
*****************************************************************************/
PROCEDURE pi_verificar_fornec_estrangeiro:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_empres_usuar
        as character
        format "x(3)"
        no-undo.
    def Input param p_cdn_fornec
        as Integer
        format ">>9"
        no-undo.
    def Input param p_cod_estab_usuar
        as character
        format "x(3)"
        no-undo.
    def Input param p_cod_indic_econ
        as character
        format "x(8)"
        no-undo.
    def Input param p_dat_emis
        as date
        format "99/99/9999"
        no-undo.
    def output param p_cod_moeda
        as character
        format "x(8)"
        no-undo.
    def output param p_num_natur
        as integer
        format ">>>>,>>9"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_cod_indic_econ
        as character
        format "x(8)":U
        label "Moeda"
        column-label "Moeda"
        no-undo.


    /************************** Variable Definition End *************************/

    find fornecedor no-lock
        where fornecedor.cod_empresa = p_cod_empres_usuar
        and   fornecedor.cdn_fornecedor = p_cdn_fornec no-error.
    if  avail fornecedor then do:
        if  fornecedor.num_pessoa modulo 2 = 0 then do:
            find first pessoa_fisic no-lock
                where pessoa_fisic.num_pessoa_fisic = fornecedor.num_pessoa no-error.
            if  avail pessoa_fisic then do:
                find estabelecimento no-lock
                    where estabelecimento.cod_estab = p_cod_estab_usuar no-error.
                if  avail estabelecimento then do:
                    if  estabelecimento.cod_pais <> pessoa_fisic.cod_pais then do:
                        assign p_num_natur = 3.
                        find pais no-lock
                            where pais.cod_pais = estabelecimento.cod_pais no-error.
                        if  avail pais then do:
                            find first histor_finalid_econ NO-LOCK
                                where histor_finalid_econ.cod_finalid_econ = pais.cod_finalid_econ_pais
                                and   histor_finalid_econ.dat_inic_valid_finalid <= p_dat_emis
                                and   histor_finalid_econ.dat_fim_valid_finalid  >  p_dat_emis
                                &if '{&emsuni_version}' >= '5.01' &then
                                     use-index hstrfnld_id
                                &endif
                                no-error.
                            if  avail histor_finalid_econ then do:
                                assign v_cod_indic_econ = histor_finalid_econ.cod_indic_econ.              
                                if  v_cod_indic_econ <> p_cod_indic_econ then
                                    assign p_cod_moeda = "Estrangeiro" /*l_estrangeiro*/  .
                            end.
                        end.
                    end.
                end.
            end.
        end.
        else do:
            find first pessoa_jurid no-lock
                where pessoa_jurid.num_pessoa_jurid = fornecedor.num_pessoa no-error.
            if  avail pessoa_jurid then do:
                find estabelecimento no-lock
                    where estabelecimento.cod_estab = p_cod_estab_usuar no-error.
                if  avail estabelecimento then do:
                    if  estabelecimento.cod_pais <> pessoa_jurid.cod_pais then do:
                        assign p_num_natur = 3.
                        find pais where pais.cod_pais = estabelecimento.cod_pais no-lock no-error.
                        if  avail pais then do:
                            find first histor_finalid_econ NO-LOCK
                                where histor_finalid_econ.cod_finalid_econ = pais.cod_finalid_econ_pais
                                and   histor_finalid_econ.dat_inic_valid_finalid <= p_dat_emis
                                and   histor_finalid_econ.dat_fim_valid_finalid  >  p_dat_emis
                                &if '{&emsuni_version}' >= '5.01' &then
                                     use-index hstrfnld_id
                                &endif
                                no-error.
                            if  avail histor_finalid_econ then do:
                                assign v_cod_indic_econ = histor_finalid_econ.cod_indic_econ.              
                                if  v_cod_indic_econ <> p_cod_indic_econ then
                                    assign p_cod_moeda = "Estrangeiro" /*l_estrangeiro*/  .
                            end.
                        end.
                    end.
                end.
            end.
        end.
    end.
END PROCEDURE. /* pi_verificar_fornec_estrangeiro */
/*****************************************************************************
** Procedure Interna.....: pi_bt_cop_add_antecip_pef_pend
** Descricao.............: pi_bt_cop_add_antecip_pef_pend
** Criado por............: src12151
** Criado em.............: 05/09/2001 16:22:21
** Alterado por..........: 
** Alterado em...........: 14/02/2003 10:24:41
*****************************************************************************/
PROCEDURE pi_bt_cop_add_antecip_pef_pend:

    assign v_rec_table_sav = v_rec_antecip_pef_pend.
    if  search("prgfin/apb/apb701ka.r") = ? and search("prgfin/apb/apb701ka.p") = ? then do:
        if  v_cod_dwb_user begins 'es_' then
            return "Programa execut†vel n∆o foi encontrado:" /*l_programa_nao_encontrado*/  + "prgfin/apb/apb701ka.p".
        else do:
            message getStrTrans("Programa execut†vel n∆o foi encontrado:", "APB") /*l_programa_nao_encontrado*/  "prgfin/apb/apb701ka.p"
                   view-as alert-box error buttons ok.
            return.
        end.
    end.
    else
        run prgfin/apb/apb701ka.p /*prg_sea_antecip_pef_pend*/.
    if  v_rec_antecip_pef_pend <> ?
    then do:
        assign v_rec_table = v_rec_antecip_pef_pend.
        run pi_copy_disp_fields /*pi_copy_disp_fields*/.

        /* ix_g10_add_antecip_pef_pend */
        assign v_rec_antecip_pef_pend = v_rec_table_sav.

        run pi_controlar_estab_apb /*pi_controlar_estab_apb*/.

        run pi_acha_estab_apb /*pi_acha_estab_apb*/.

        assign v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend = string(b_antecip_pef_pend_copy.cdn_fornecedor).
        assign v_cod_fornec_infor.

        apply "leave" to v_cod_fornec_infor in frame f_adp_02_antecip_pef_pend.

        find proces_pagto no-lock
             where proces_pagto.cod_estab = b_antecip_pef_pend_copy.cod_estab
               and proces_pagto.cod_refer_antecip_pef = b_antecip_pef_pend_copy.cod_refer
              no-error.
        if  avail proces_pagto
        then do:
            assign v_ind_modo_pagto = proces_pagto.ind_modo_pagto.
        end /* if */.
        else do:
            assign v_ind_modo_pagto = "".
        end /* else */.
        /* @i(i_informar_chave_tab_relac_pessoa_fisic_jurid &table=fornecedor
                                                       &table_abrev=fornec
                                                       &atrib=cdn_fornecedor
                                                       &frame=@&(frame)
                                                       &field_reference=nom_abrev)

        @run (pi_verifica_impto_vincul_fornec(input frame @&(frame) antecip_pef_pend.cod_estab,
                                            v_cdn_fornecedor,
                                            input frame @&(frame) antecip_pef_pend.dat_emis_docto,
                                            v_log_impto_vincul_fornec)).
        @if(v_log_impto_vincul_fornec = yes)
            @enable(@&(frame), bt_impto_retido2).
        @end_if().
        @else()
            @disable(@&(frame), bt_impto_retido2).
        @end_else().

        @if(avail fornecedor)
            @find(first, fornec_financ, fornecedor, null, null, no_lock, wait, no_error).
            @if(avail fornec_financ)
                assign antecip_pef_pend.cod_portad:screen-value in frame @&(frame) = fornec_financ.cod_portador.
            @end_if().
        @end_if().*/
    end /* if */.
END PROCEDURE. /* pi_bt_cop_add_antecip_pef_pend */
/*****************************************************************************
** Procedure Interna.....: pi_bt_zoo_ord_compra_ped_fornec
** Descricao.............: pi_bt_zoo_ord_compra_ped_fornec
** Criado por............: src12151
** Criado em.............: 11/09/2001 14:56:01
** Alterado por..........: fut41421
** Alterado em...........: 22/04/2010 11:35:15
*****************************************************************************/
PROCEDURE pi_bt_zoo_ord_compra_ped_fornec:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_estab
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************** Buffer Definition Begin *************************/

    &if "{&emsuni_version}" >= "1.00" &then
    def buffer b_estabelecimento
        for estabelecimento.
    &endif


    /*************************** Buffer Definition End **************************/

    find first b_estabelecimento no-lock
            where b_estabelecimento.cod_estab = p_cod_estab no-error.
        if avail b_estabelecimento then
            assign v_cod_empres_usuar_aux = b_estabelecimento.cod_empresa.
        else 
            assign v_cod_empres_usuar_aux = v_cod_empres_usuar.
    if  search("prgfin/apb/apb789za.r") = ? and search("prgfin/apb/apb789za.p") = ? then do:
        if  v_cod_dwb_user begins 'es_' then
            return "Programa execut†vel n∆o foi encontrado:" /*l_programa_nao_encontrado*/  + "prgfin/apb/apb789za.p".
        else do:
            message getStrTrans("Programa execut†vel n∆o foi encontrado:", "APB") /*l_programa_nao_encontrado*/  "prgfin/apb/apb789za.p"
                   view-as alert-box error buttons ok.
            return.
        end.
    end.
    else
        run prgfin/apb/apb789za.p (input-output table tt_ordem_compra,
                               input-output v_num_ord_invest,
                               input-output v_num_ped_compra,
                               input-output v_num_ord_compra) /*prg_fnc_ordem_compra_integr*/.
    if v_num_ord_invest > 0 
    or v_num_ped_compra > 0 
    or v_num_ord_compra > 0 then do:
        find first tt_ordem_compra no-lock
             where tt_ordem_compra.ttv_num_ord_invest_integr = v_num_ord_invest 
               and tt_ordem_compra.ttv_num_ped_integr        = v_num_ped_compra
               and tt_ordem_compra.ttv_num_oc_integr         = v_num_ord_compra no-error.
        if avail tt_ordem_compra then do:
            assign v_num_ped_compra:screen-value in frame f_adp_02_antecip_pef_pend = string(tt_ordem_compra.ttv_num_ped_integr)
                   v_num_ord_compra:screen-value in frame f_adp_02_antecip_pef_pend = string(tt_ordem_compra.ttv_num_oc_integr)               
                   v_num_ped_compra = tt_ordem_compra.ttv_num_ped_integr
                   v_num_ord_compra = tt_ordem_compra.ttv_num_oc_integr.
            assign input frame f_adp_02_antecip_pef_pend v_num_ped_compra
                   input frame f_adp_02_antecip_pef_pend v_num_ord_compra.
            apply "entry" to v_num_ped_compra in frame f_adp_02_antecip_pef_pend.
    /* @enable(@&(frame),bt_zoo3,v_num_event).*/
        end.
    end /* if */.
END PROCEDURE. /* pi_bt_zoo_ord_compra_ped_fornec */
/*****************************************************************************
** Procedure Interna.....: pi_bt_vinc_imp_fornec2_adp_antecip_pef_pend
** Descricao.............: pi_bt_vinc_imp_fornec2_adp_antecip_pef_pend
** Criado por............: src12151
** Criado em.............: 18/09/2001 08:57:29
** Alterado por..........: src12151
** Alterado em...........: 18/09/2001 08:58:39
*****************************************************************************/
PROCEDURE pi_bt_vinc_imp_fornec2_adp_antecip_pef_pend:

    run pi_vincul_impto_retido_fornec_fin (Input v_cod_empres_usuar_2,
                                           Input v_cdn_fornecedor) /*pi_vincul_impto_retido_fornec_fin*/.
    run pi_verifica_impto_vincul_fornec (Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab,
                                         Input v_cdn_fornecedor,
                                         Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.dat_emis_docto,
                                         output v_log_impto_vincul_fornec) /*pi_verifica_impto_vincul_fornec*/.
    if v_log_impto_vincul_fornec = yes then
        enable bt_impto_retido2
               with frame f_adp_02_antecip_pef_pend.
    else do:
        del_block:
        for each impto_impl_pend_ap exclusive-lock
            where impto_impl_pend_ap.cod_estab_refer = antecip_pef_pend.cod_estab
            and   impto_impl_pend_ap.cod_refer       = antecip_pef_pend.cod_refer
            and   impto_impl_pend_ap.cod_portador    = ""
            and   impto_impl_pend_ap.num_bord_ap     = 0
            and   impto_impl_pend_ap.num_seq_refer   = 0:
            delete impto_impl_pend_ap.
        end /* for del_block */.
        disable bt_impto_retido2
                with frame f_adp_02_antecip_pef_pend.
    end.
END PROCEDURE. /* pi_bt_vinc_imp_fornec2_adp_antecip_pef_pend */
/*****************************************************************************
** Procedure Interna.....: pi_valida_cta_imposto
** Descricao.............: pi_valida_cta_imposto
** Criado por............: bre18732
** Criado em.............: 23/07/2002 11:11:38
** Alterado por..........: bre18732
** Alterado em...........: 23/07/2002 11:32:21
*****************************************************************************/
PROCEDURE pi_valida_cta_imposto:

    for each impto_impl_pend_ap exclusive-lock
        where impto_impl_pend_ap.cod_estab_refer = antecip_pef_pend.cod_estab
        and   impto_impl_pend_ap.cod_refer       = antecip_pef_pend.cod_refer:
        /* validaá∆o do parÉmetros de utilizaá∆o de centro de custo para a conta de imposto*/
        find first histor_impto_empres no-lock
             where histor_impto_empres.cod_empresa      = antecip_pef_pend.cod_empresa
             and   histor_impto_empres.cod_pais         = impto_impl_pend_ap.cod_pais
             and   histor_impto_empres.cod_unid_federac = impto_impl_pend_ap.cod_unid_federac
             and   histor_impto_empres.cod_imposto      = impto_impl_pend_ap.cod_imposto
             and   histor_impto_empres.dat_inic_valid  <= antecip_pef_pend.dat_emis_docto
             and   histor_impto_empres.dat_fim_valid   >= antecip_pef_pend.dat_emis_docto no-error.
        if  histor_impto_empres.cod_cta_ctbl_db <> "" /*l_*/  
        and histor_impto_empres.cod_cta_ctbl_db <> ? then do:
            find first criter_distrib_cta_ctbl no-lock
                 where criter_distrib_cta_ctbl.cod_estab      =  antecip_pef_pend.cod_estab
                 and   criter_distrib_cta_ctbl.cod_cta_ctbl   =  histor_impto_empres.cod_cta_ctbl_db
                 and   criter_distrib_cta_ctbl.dat_inic_valid <= antecip_pef_pend.dat_emis_docto
                 and   criter_distrib_cta_ctbl.dat_fim_valid  >= antecip_pef_pend.dat_emis_docto no-error.
            if avail criter_distrib_cta_ctbl then do:
               if criter_distrib_cta_ctbl.ind_criter_distrib_ccusto = "Definidos" /*l_definidos*/  then do:
                  find first mapa_distrib_ccusto no-lock
                       where mapa_distrib_ccusto.cod_estab               = criter_distrib_cta_ctbl.cod_estab
                       and   mapa_distrib_ccusto.cod_mapa_distrib_ccusto = criter_distrib_cta_ctbl.cod_mapa_distrib_ccusto no-error.
                  if avail mapa_distrib_ccusto then do:
                     for each  aprop_ctbl_pend_ap no-lock
                         where aprop_ctbl_pend_ap.cod_estab = antecip_pef_pend.cod_estab
                         and   aprop_ctbl_pend_ap.cod_refer = antecip_pef_pend.cod_refer:
                         if  aprop_ctbl_pend_ap.cod_plano_ccusto = "" /*l_*/ 
                         and aprop_ctbl_pend_ap.cod_ccusto       = "" /*l_*/  then do:
                             assign v_des_msg_erro_1 = getStrTrans("A conta cont†bil informada para o imposto utiliza centro de custo e a conta cont†bil informada para o t°tulo n∆o utiliza centro de custo. ", "APB") /*11855*/.
                             run pi_verifica_msg_erro (Input antecip_pef_pend.cod_estab,
                                                       Input antecip_pef_pend.cod_espec_docto,
                                                       Input antecip_pef_pend.cod_ser_docto,
                                                       Input antecip_pef_pend.cdn_fornecedor,
                                                       Input antecip_pef_pend.cod_tit_ap,
                                                       Input antecip_pef_pend.cod_parcela,
                                                       Input antecip_pef_pend.cod_refer,
                                                       Input v_des_msg_erro_1,
                                                       Input antecip_pef_pend.cod_estab,
                                                       Input 0) /* pi_verifica_msg_erro*/.
                             assign v_log_erro_valid = no.
                         end.
                         else do:
                              find first item_lista_ccusto no-lock
                                   where item_lista_ccusto.cod_estab               = mapa_distrib_ccusto.cod_estab
                                   and   item_lista_ccusto.cod_mapa_distrib_ccusto = mapa_distrib_ccusto.cod_mapa_distrib_ccusto
                                   and   item_lista_ccusto.cod_plano_ccusto        = aprop_ctbl_pend_ap.cod_plano_ccusto
                                   and   item_lista_ccusto.cod_ccusto              = aprop_ctbl_pend_ap.cod_ccusto no-error.
                              if not avail item_lista_ccusto then do:
                                 assign v_des_msg_erro_1 = getStrTrans("O centro de custo informado na apropriaá∆o do t°tulo n∆o pertence ao mapa de distribuiá∆o de centro de custo parametrizado para a conta de imposto.", "APB") /*11854*/.
                                 run pi_verifica_msg_erro (Input antecip_pef_pend.cod_estab,
                                                           Input antecip_pef_pend.cod_espec_docto,
                                                           Input antecip_pef_pend.cod_ser_docto,
                                                           Input antecip_pef_pend.cdn_fornecedor,
                                                           Input antecip_pef_pend.cod_tit_ap,
                                                           Input antecip_pef_pend.cod_parcela,
                                                           Input antecip_pef_pend.cod_refer,
                                                           Input v_des_msg_erro_1,
                                                           Input antecip_pef_pend.cod_estab,
                                                           Input 0) /* pi_verifica_msg_erro*/.
                                 assign v_log_erro_valid = no.
                              end.
                         end.
                     end.    
                  end.
               end.
               if criter_distrib_cta_ctbl.ind_criter_distrib_ccusto = "Utiliza Todos" /*l_utiliza_todos*/  then do:
                  for each  aprop_ctbl_pend_ap no-lock
                      where aprop_ctbl_pend_ap.cod_estab = antecip_pef_pend.cod_estab
                      and   aprop_ctbl_pend_ap.cod_refer = antecip_pef_pend.cod_refer:
                      if  aprop_ctbl_pend_ap.cod_plano_ccusto = "" /*l_*/ 
                      and aprop_ctbl_pend_ap.cod_ccusto       = "" /*l_*/  then do:
                          assign v_des_msg_erro_1 = getStrTrans("A conta cont†bil informada para o imposto utiliza centro de custo e a conta cont†bil informada para o t°tulo n∆o utiliza centro de custo. ", "APB") /*11855*/.
                          run pi_verifica_msg_erro (Input antecip_pef_pend.cod_estab,
                                                    Input antecip_pef_pend.cod_espec_docto,
                                                    Input antecip_pef_pend.cod_ser_docto,
                                                    Input antecip_pef_pend.cdn_fornecedor,
                                                    Input antecip_pef_pend.cod_tit_ap,
                                                    Input antecip_pef_pend.cod_parcela,
                                                    Input antecip_pef_pend.cod_refer,
                                                    Input v_des_msg_erro_1,
                                                    Input antecip_pef_pend.cod_estab,
                                                    Input 0) /* pi_verifica_msg_erro*/.
                          assign v_log_erro_valid = no.
                      end.
                  end.
               end.
            end.
        end.
    end.

END PROCEDURE. /* pi_valida_cta_imposto */
/*****************************************************************************
** Procedure Interna.....: pi_mostra_erros_cotac_parid
** Descricao.............: pi_mostra_erros_cotac_parid
** Criado por............: Ganzen
** Criado em.............: 09/02/1996 19:12:12
** Alterado por..........: Ganzen
** Alterado em...........: 01/02/1996 10:38:25
*****************************************************************************/
PROCEDURE pi_mostra_erros_cotac_parid:

    /************************** Query Definition Begin **************************/

    def query qr_tt_erros_cotac_parid
        for tt_erros_cotac_parid
        scrolling.


    /*************************** Query Definition End ***************************/

    /************************** Browse Definition Begin *************************/

    def browse br_tt_erros_cotac_parid query qr_tt_erros_cotac_parid display 
        tt_erros_cotac_parid.tta_cod_indic_econ_base
        width-chars 08.57
            column-label "Moeda Base"
        tt_erros_cotac_parid.tta_cod_indic_econ_idx
        width-chars 09.29
            column-label "Moeda ÷ndice"
        tt_erros_cotac_parid.tta_dat_cotac_indic_econ
        width-chars 10.00
            column-label "Data Cotaá∆o"
        getStrTrans(tt_erros_cotac_parid.tta_ind_tip_cotac_parid, "APB") @ tt_erros_cotac_parid.tta_ind_tip_cotac_parid
        width-chars 10.00
            column-label "Tipo Cotaá∆o"
        with separators single 
             size 54.00 by 11.00
             font 1
             bgcolor 15
             title "N∆o ha cotaá∆o para as Paridades:".


    /*************************** Browse Definition End **************************/

    /************************ Rectangle Definition Begin ************************/

    def rectangle rt_cxcf
        size 1 by 1
        fgcolor 1 edge-pixels 2.
    def rectangle rt_mold
        size 1 by 1
        edge-pixels 2.


    /************************* Rectangle Definition End *************************/

    /************************** Button Definition Begin *************************/

    def button bt_can
        label "Cancela"
        tooltip "Cancela"
        size 1 by 1
        auto-endkey.
    def button bt_hel2
        label "Ajuda"
        tooltip "Ajuda"
        size 1 by 1.
    def button bt_imprimir
        label "Imprimir"
        tooltip ""
        size 1 by 1.
    def button bt_ok
        label "OK"
        tooltip "OK"
        size 1 by 1
        auto-go.
    /****************************** Function Button *****************************/


    /*************************** Button Definition End **************************/

    /************************** Frame Definition Begin **************************/

    def frame f_dlg_01_cotac_parid_erros_cotacao
        rt_mold
             at row 01.21 col 02.00
        rt_cxcf
             at row 14.58 col 02.00 bgcolor 7 
        br_tt_erros_cotac_parid
             at row 01.58 col 03.00
             help "Cotaá‰es inexistentes"
        bt_imprimir
             at row 12.92 col 03.43 font ?
        bt_ok
             at row 14.79 col 03.00 font ?
             help "OK"
        bt_can
             at row 14.79 col 14.00 font ?
             help "Cancela"
        bt_hel2
             at row 14.79 col 47.00 font ?
             help "Ajuda"
        with 1 down side-labels no-validate keep-tab-order three-d
             size-char 59.43 by 16.42 default-button bt_ok
             view-as dialog-box
             font 1 fgcolor ? bgcolor 8
             title "Verificaá∆o das Cotaá‰es".
        /* adjust size of objects in this frame */
        assign bt_can:width-chars       in frame f_dlg_01_cotac_parid_erros_cotacao = 10.00
               bt_can:height-chars      in frame f_dlg_01_cotac_parid_erros_cotacao = 01.00
               bt_hel2:width-chars      in frame f_dlg_01_cotac_parid_erros_cotacao = 10.00
               bt_hel2:height-chars     in frame f_dlg_01_cotac_parid_erros_cotacao = 01.00
               bt_imprimir:width-chars  in frame f_dlg_01_cotac_parid_erros_cotacao = 10.00
               bt_imprimir:height-chars in frame f_dlg_01_cotac_parid_erros_cotacao = 01.00
               bt_ok:width-chars        in frame f_dlg_01_cotac_parid_erros_cotacao = 10.00
               bt_ok:height-chars       in frame f_dlg_01_cotac_parid_erros_cotacao = 01.00
               rt_cxcf:width-chars      in frame f_dlg_01_cotac_parid_erros_cotacao = 56.00
               rt_cxcf:height-chars     in frame f_dlg_01_cotac_parid_erros_cotacao = 01.42
               rt_mold:width-chars      in frame f_dlg_01_cotac_parid_erros_cotacao = 56.00
               rt_mold:height-chars     in frame f_dlg_01_cotac_parid_erros_cotacao = 13.00.
    &if '{&emsbas_version}' >= '5.06' &then
    if OPSYS = 'WIN32':U then do:
    assign br_tt_erros_cotac_parid:ALLOW-COLUMN-SEARCHING in frame f_dlg_01_cotac_parid_erros_cotacao = no
           br_tt_erros_cotac_parid:COLUMN-MOVABLE in frame f_dlg_01_cotac_parid_erros_cotacao = no.
    end.
    &endif
        /* set private-data for the help system */
        assign br_tt_erros_cotac_parid:private-data in frame f_dlg_01_cotac_parid_erros_cotacao = "HLP=000019171":U
               bt_imprimir:private-data             in frame f_dlg_01_cotac_parid_erros_cotacao = "HLP=000019222":U
               bt_ok:private-data                   in frame f_dlg_01_cotac_parid_erros_cotacao = "HLP=000010721":U
               bt_can:private-data                  in frame f_dlg_01_cotac_parid_erros_cotacao = "HLP=000011050":U
               bt_hel2:private-data                 in frame f_dlg_01_cotac_parid_erros_cotacao = "HLP=000011326":U
               frame f_dlg_01_cotac_parid_erros_cotacao:private-data                            = "HLP=000019171".



{include/i_fclfrm.i f_dlg_01_cotac_parid_erros_cotacao }
    /*************************** Frame Definition End ***************************/

    /*********************** User Interface Trigger Begin ***********************/


    ON CHOOSE OF bt_hel2 IN FRAME f_dlg_01_cotac_parid_erros_cotacao
    DO:


        /* Begin_Include: i_context_help_frame */
        run prgtec/men/men900za.py (Input self:frame,
                                    Input this-procedure:handle) /*prg_fnc_chamar_help_context*/.


        /* End_Include: i_context_help_frame */

    END. /* ON CHOOSE OF bt_hel2 IN FRAME f_dlg_01_cotac_parid_erros_cotacao */


    /************************ User Interface Trigger End ************************/

    /**************************** Frame Trigger Begin ***************************/


    ON HELP OF FRAME f_dlg_01_cotac_parid_erros_cotacao ANYWHERE
    DO:


        /* Begin_Include: i_context_help */
        run prgtec/men/men900za.py (Input self:handle,
                                    Input this-procedure:handle) /*prg_fnc_chamar_help_context*/.
        /* End_Include: i_context_help */

    END. /* ON HELP OF FRAME f_dlg_01_cotac_parid_erros_cotacao */

    ON RIGHT-MOUSE-DOWN OF FRAME f_dlg_01_cotac_parid_erros_cotacao ANYWHERE
    DO:

        /************************* Variable Definition Begin ************************/

        def var v_wgh_frame
            as widget-handle
            format ">>>>>>9":U
            no-undo.


        /************************** Variable Definition End *************************/


        /* Begin_Include: i_right_mouse_down_dialog_box */
        if  (self:type <> "DIALOG-BOX" /*l_dialog_box*/ )
        and (self:type <> "FRAME" /*l_frame*/      )
        and (self:type <> "text" /*l_text*/       )
        and (self:type <> "IMAGE" /*l_image*/      )
        and (self:type <> "RECTANGLE" /*l_rectangle*/  )
        then do:

            assign v_wgh_frame = self:parent.

            if  self:type        = "fill-in" /*l_fillin*/ 
            and v_wgh_frame:type = "Browse" /*l_browse*/  then
                return no-apply.

            if  valid-handle(self:popup-menu) = yes then
                return no-apply.

            assign v_wgh_frame = self:frame.

            if  (v_wgh_frame:type <> "DIALOG-BOX" /*l_dialog_box*/ ) and (v_wgh_frame:frame <> ?)
            then do:
                   assign v_wgh_frame     = v_wgh_frame:frame.
            end /* if */.
            assign v_nom_title_aux    = v_wgh_frame:title
                   v_wgh_frame:title  = self:help.
        end /* if */.
        /* End_Include: i_right_mouse_down_dialog_box */

    END. /* ON RIGHT-MOUSE-DOWN OF FRAME f_dlg_01_cotac_parid_erros_cotacao */

    ON RIGHT-MOUSE-UP OF FRAME f_dlg_01_cotac_parid_erros_cotacao ANYWHERE
    DO:

        /************************* Variable Definition Begin ************************/

        def var v_wgh_frame
            as widget-handle
            format ">>>>>>9":U
            no-undo.


        /************************** Variable Definition End *************************/


        /* Begin_Include: i_right_mouse_up_dialog_box */
        if  (self:type <> "DIALOG-BOX" /*l_dialog_box*/ )
        and (self:type <> "FRAME" /*l_frame*/      )
        and (self:type <> "text" /*l_text*/       )
        and (self:type <> "IMAGE" /*l_image*/      )
        and (self:type <> "RECTANGLE" /*l_rectangle*/  )
        then do:

            assign v_wgh_frame = self:parent.

            if  self:type        = "fill-in" /*l_fillin*/ 
            and v_wgh_frame:type = "Browse" /*l_browse*/  then
                return no-apply.

            if  valid-handle(self:popup-menu) = yes then
                return no-apply.

            assign v_wgh_frame        = self:frame.
            if  (v_wgh_frame:type <> "DIALOG-BOX" /*l_dialog_box*/ ) and (v_wgh_frame:frame <> ?)
            then do:
                   assign v_wgh_frame     = v_wgh_frame:frame.
            end /* if */.
            assign v_wgh_frame:title  = v_nom_title_aux.
        end /* if */.

        /* End_Include: i_right_mouse_up_dialog_box */

    END. /* ON RIGHT-MOUSE-UP OF FRAME f_dlg_01_cotac_parid_erros_cotacao */

    ON WINDOW-CLOSE OF FRAME f_dlg_01_cotac_parid_erros_cotacao
    DO:

        apply "end-error" to self.
    END. /* ON WINDOW-CLOSE OF FRAME f_dlg_01_cotac_parid_erros_cotacao */


    /***************************** Frame Trigger End ****************************/

    view frame f_dlg_01_cotac_parid_erros_cotacao.
    enable all with frame f_dlg_01_cotac_parid_erros_cotacao.

    open query qr_tt_erros_cotac_parid for
        each tt_erros_cotac_parid no-lock.


    main_block:
    do on endkey undo main_block, leave main_block:
        wait-for go of frame f_dlg_01_cotac_parid_erros_cotacao.
    end /* do main_block */.

    hide frame f_dlg_01_cotac_parid_erros_cotacao.

END PROCEDURE. /* pi_mostra_erros_cotac_parid */
/*****************************************************************************
** Procedure Interna.....: pi_right_mouse_down_02
** Descricao.............: pi_right_mouse_down_02
** Criado por............: bre18490
** Criado em.............: 07/07/1999 13:41:07
** Alterado por..........: bre18490
** Alterado em...........: 07/07/1999 14:13:07
*****************************************************************************/
PROCEDURE pi_right_mouse_down_02:

    /************************* Variable Definition Begin ************************/

    def var v_wgh_frame
        as widget-handle
        format ">>>>>>9":U
        no-undo.


    /************************** Variable Definition End *************************/


    /* Begin_Include: i_right_mouse_down_dialog_box */
    if  (self:type <> "DIALOG-BOX" /*l_dialog_box*/ )
    and (self:type <> "FRAME" /*l_frame*/      )
    and (self:type <> "text" /*l_text*/       )
    and (self:type <> "IMAGE" /*l_image*/      )
    and (self:type <> "RECTANGLE" /*l_rectangle*/  )
    then do:

        assign v_wgh_frame = self:parent.

        if  self:type        = "fill-in" /*l_fillin*/ 
        and v_wgh_frame:type = "Browse" /*l_browse*/  then
            return no-apply.

        if  valid-handle(self:popup-menu) = yes then
            return no-apply.

        assign v_wgh_frame = self:frame.

        if  (v_wgh_frame:type <> "DIALOG-BOX" /*l_dialog_box*/ ) and (v_wgh_frame:frame <> ?)
        then do:
               assign v_wgh_frame     = v_wgh_frame:frame.
        end /* if */.
        assign v_nom_title_aux    = v_wgh_frame:title
               v_wgh_frame:title  = self:help.
    end /* if */.
    /* End_Include: i_right_mouse_down_dialog_box */

END PROCEDURE. /* pi_right_mouse_down_02 */
/*****************************************************************************
** Procedure Interna.....: pi_right_mouse_up_02
** Descricao.............: pi_right_mouse_up_02
** Criado por............: bre18490
** Criado em.............: 07/07/1999 13:40:16
** Alterado por..........: bre18490
** Alterado em...........: 07/07/1999 14:13:32
*****************************************************************************/
PROCEDURE pi_right_mouse_up_02:

    /************************* Variable Definition Begin ************************/

    def var v_wgh_frame
        as widget-handle
        format ">>>>>>9":U
        no-undo.


    /************************** Variable Definition End *************************/


    /* Begin_Include: i_right_mouse_up_dialog_box */
    if  (self:type <> "DIALOG-BOX" /*l_dialog_box*/ )
    and (self:type <> "FRAME" /*l_frame*/      )
    and (self:type <> "text" /*l_text*/       )
    and (self:type <> "IMAGE" /*l_image*/      )
    and (self:type <> "RECTANGLE" /*l_rectangle*/  )
    then do:

        assign v_wgh_frame = self:parent.

        if  self:type        = "fill-in" /*l_fillin*/ 
        and v_wgh_frame:type = "Browse" /*l_browse*/  then
            return no-apply.

        if  valid-handle(self:popup-menu) = yes then
            return no-apply.

        assign v_wgh_frame        = self:frame.
        if  (v_wgh_frame:type <> "DIALOG-BOX" /*l_dialog_box*/ ) and (v_wgh_frame:frame <> ?)
        then do:
               assign v_wgh_frame     = v_wgh_frame:frame.
        end /* if */.
        assign v_wgh_frame:title  = v_nom_title_aux.
    end /* if */.

    /* End_Include: i_right_mouse_up_dialog_box */

END PROCEDURE. /* pi_right_mouse_up_02 */
/*****************************************************************************
** Procedure Interna.....: pi_verifica_valores_aprop_ctbl_movto_apb
** Descricao.............: pi_verifica_valores_aprop_ctbl_movto_apb
** Criado por............: Rafael
** Criado em.............: 01/07/1998 11:24:46
** Alterado por..........: Rafael
** Alterado em...........: 01/07/1998 11:38:03
*****************************************************************************/
PROCEDURE pi_verifica_valores_aprop_ctbl_movto_apb:

    /************************ Parameter Definition Begin ************************/

    def param buffer p_movto_tit_ap
        for movto_tit_ap.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_val_dif                        as decimal         no-undo. /*local*/


    /************************** Variable Definition End *************************/

    for each tt_acerto_aprop_bxa_ap:
        delete tt_acerto_aprop_bxa_ap.
    end.

    for each aprop_ctbl_ap
        where aprop_ctbl_ap.cod_estab           = p_movto_tit_ap.cod_estab
        and   aprop_ctbl_ap.num_id_movto_tit_ap = p_movto_tit_ap.num_id_movto_tit_ap
        no-lock:

        for each val_aprop_ctbl_ap
            where val_aprop_ctbl_ap.cod_estab            = aprop_ctbl_ap.cod_estab
            and   val_aprop_ctbl_ap.num_id_aprop_ctbl_ap = aprop_ctbl_ap.num_id_aprop_ctbl_ap
            no-lock:

            find  first tt_acerto_aprop_bxa_ap
                where tt_acerto_aprop_bxa_ap.tta_cod_finalid_econ = val_aprop_ctbl_ap.cod_finalid_econ
                exclusive-lock no-error.

            if  not avail tt_acerto_aprop_bxa_ap then do:
                create tt_acerto_aprop_bxa_ap.
                assign tt_acerto_aprop_bxa_ap.tta_cod_finalid_econ = val_aprop_ctbl_ap.cod_finalid_econ.
            end.

            if  aprop_ctbl_ap.ind_natur_lancto_ctbl = "CR" /*l_cr*/  then do:
                assign tt_acerto_aprop_bxa_ap.ttv_val_tot_cr =  tt_acerto_aprop_bxa_ap.ttv_val_tot_cr 
                                                             + val_aprop_ctbl_ap.val_aprop_ctbl.

                if  val_aprop_ctbl_ap.val_aprop_ctbl > tt_acerto_aprop_bxa_ap.ttv_val_maior_val_cr then 
                    assign tt_acerto_aprop_bxa_ap.ttv_rec_val_aprop_ctbl_ap_cr = recid(val_aprop_ctbl_ap)
                           tt_acerto_aprop_bxa_ap.ttv_val_maior_val_cr         = val_aprop_ctbl_ap.val_aprop_ctbl.
            end.
            else do:
                assign tt_acerto_aprop_bxa_ap.ttv_val_tot_db = tt_acerto_aprop_bxa_ap.ttv_val_tot_db 
                                                             + val_aprop_ctbl_ap.val_aprop_ctbl.

                if  val_aprop_ctbl_ap.val_aprop_ctbl > tt_acerto_aprop_bxa_ap.ttv_val_maior_val_db then 
                    assign tt_acerto_aprop_bxa_ap.ttv_rec_val_aprop_ctbl_ap_db = recid(val_aprop_ctbl_ap)
                           tt_acerto_aprop_bxa_ap.ttv_val_maior_val_db         = val_aprop_ctbl_ap.val_aprop_ctbl.

            end.
        end.
    end.

    for each tt_acerto_aprop_bxa_ap:
        if  tt_acerto_aprop_bxa_ap.ttv_val_tot_cr < tt_acerto_aprop_bxa_ap.ttv_val_tot_db then do:
            assign v_val_dif = tt_acerto_aprop_bxa_ap.ttv_val_tot_db - tt_acerto_aprop_bxa_ap.ttv_val_tot_cr.
            find val_aprop_ctbl_ap exclusive-lock
                where recid(val_aprop_ctbl_ap) = tt_acerto_aprop_bxa_ap.ttv_rec_val_aprop_ctbl_ap_cr no-error.
            if  avail val_aprop_ctbl_ap then
                assign val_aprop_ctbl_ap.val_aprop_ctbl = val_aprop_ctbl_ap.val_aprop_ctbl + v_val_dif.
        end.
        if  tt_acerto_aprop_bxa_ap.ttv_val_tot_db < tt_acerto_aprop_bxa_ap.ttv_val_tot_cr then do:
            assign v_val_dif = tt_acerto_aprop_bxa_ap.ttv_val_tot_cr - tt_acerto_aprop_bxa_ap.ttv_val_tot_db.
            find val_aprop_ctbl_ap exclusive-lock
                where recid(val_aprop_ctbl_ap) = tt_acerto_aprop_bxa_ap.ttv_rec_val_aprop_ctbl_ap_db no-error.
            if  avail val_aprop_ctbl_ap then
                assign val_aprop_ctbl_ap.val_aprop_ctbl = val_aprop_ctbl_ap.val_aprop_ctbl + v_val_dif.
        end.
    end.


END PROCEDURE. /* pi_verifica_valores_aprop_ctbl_movto_apb */
/*****************************************************************************
** Procedure Interna.....: pi_valida_antecip_pef_pend
** Descricao.............: pi_valida_antecip_pef_pend
** Criado por............: fut12183
** Criado em.............: 12/03/2003 18:01:41
** Alterado por..........: fut12183
** Alterado em...........: 30/04/2003 13:52:27
*****************************************************************************/
PROCEDURE pi_valida_antecip_pef_pend:

    &if '{&emsfin_version}' >= '5.03' &then
    find last param_geral_apb no-lock no-error.
    if  avail param_geral_apb then do:
        if  param_geral_apb.log_reg_corporat then do:
            find estabelecimento
                where estabelecimento.cod_estab = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab
                no-lock no-error.
            if  not avail estabelecimento then do:
                /* Estabelecimento do t°tulo inv†lido ! */
                run pi_messages (input "show",
                                 input 6099,
                                 input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_6099*/.
                return "NOK" /*l_nok*/ .
            end.

            find fornec_financ
                where fornec_financ.cod_empresa    = estabelecimento.cod_empresa
                and   fornec_financ.cdn_fornecedor = int(v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend)
                no-lock no-error.
            if  not avail fornec_financ then do:
                /* Fornecedor Financeiro Inexistente ! */
                run pi_messages (input "show",
                                 input 8658,
                                 input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                   estabelecimento.cod_empresa, input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab)) /*msg_8658*/.
                return "NOK" /*l_nok*/ .
            end.
        end.
    end.
    &endif
END PROCEDURE. /* pi_valida_antecip_pef_pend */
/*****************************************************************************
** Procedure Interna.....: pi_on_choose_bt_ordem_compra_antecip
** Descricao.............: pi_on_choose_bt_ordem_compra_antecip
** Criado por............: fut12183
** Criado em.............: 16/04/2003 11:46:02
** Alterado por..........: fut40574_2
** Alterado em...........: 23/03/2007 14:03:34
*****************************************************************************/
PROCEDURE pi_on_choose_bt_ordem_compra_antecip:

    if  antecip_pef_pend.cod_espec:screen-value  in frame f_adp_02_antecip_pef_pend <> ""
    and antecip_pef_pend.cod_tit_ap:screen-value in frame f_adp_02_antecip_pef_pend <> ""
    and v_cod_fornec_infor:screen-value          in frame f_adp_02_antecip_pef_pend <> "0"
    and antecip_pef_pend.val_tit_ap:screen-value in frame f_adp_02_antecip_pef_pend <> "0" then do:
        run pi_valida_antecip_pef_pend /*pi_valida_antecip_pef_pend*/.
        if return-value = "NOK" /*l_nok*/  then
           return "NOK" /*l_nok*/ .
        run pi_save_key /*pi_save_key*/.

        run pi_verifica_indic_favorec_cheque.

        if return-value = "NOK" /*l_nok*/  then do:
            apply "Entry" /*l_entry*/    to antecip_pef_pend.ind_favorec_cheq in frame f_adp_02_antecip_pef_pend.
            return "NOK" /*l_nok*/  .
        end.

        run pi_save_fields /*pi_save_fields*/.
        assign v_rec_antecip_pef_pend = recid(antecip_pef_pend).
        if  search("prgfin/apb/apb791za.r") = ? and search("prgfin/apb/apb791za.p") = ? then do:
            if  v_cod_dwb_user begins 'es_' then
                return "Programa execut†vel n∆o foi encontrado:" /*l_programa_nao_encontrado*/  + "prgfin/apb/apb791za.p".
            else do:
                message getStrTrans("Programa execut†vel n∆o foi encontrado:", "APB") /*l_programa_nao_encontrado*/  "prgfin/apb/apb791za.p"
                       view-as alert-box error buttons ok.
                return.
            end.
        end.
        else
            run prgfin/apb/apb791za.p (Input antecip_pef_pend.cod_estab,
                                   Input antecip_pef_pend.cod_refer,
                                   Input 0,
                                   Input v_cod_fornec_infor,
                                   Input antecip_pef_pend.cod_espec_docto,
                                   Input antecip_pef_pend.cod_ser_docto,
                                   Input antecip_pef_pend.cod_tit_ap,
                                   Input antecip_pef_pend.cod_parcela,
                                   Input yes) /*prg_fnc_ord_compra_tit_ap_pend*/.
    end.
    else do:
        /* Dados Insuficientes ! */
        run pi_messages (input "show",
                         input 752,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_752*/.
        return "NOK" /*l_nok*/ .
    end.

    return "OK" /*l_ok*/ .
END PROCEDURE. /* pi_on_choose_bt_ordem_compra_antecip */
/*****************************************************************************
** Procedure Interna.....: pi_informar_chave_tab_relac_pessoa_fisic_jurid_aux
** Descricao.............: pi_informar_chave_tab_relac_pessoa_fisic_jurid_aux
** Criado por............: fut302
** Criado em.............: 24/04/2003 15:52:30
** Alterado por..........: fut302
** Alterado em...........: 24/04/2003 15:54:19
*****************************************************************************/
PROCEDURE pi_informar_chave_tab_relac_pessoa_fisic_jurid_aux:


    /* Begin_Include: i_informar_chave_tab_relac_pessoa_fisic_jurid */
    if  v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend <> ""
    and v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend <> ?
    then do:

    /* find pais 
            where pais.cod_pais = estabelecimento.cod_pais no-lock no-error.
        if  not avail pais then do:
            find pais 
                where recid(pais) = v_rec_pais no-lock no-error.
        end.
        @if(available pais)
           assign v_cod_pais = pais.cod_pais.
        @end_if().

        assign v_cod_fornec_infor. */

        assign input frame f_adp_02_antecip_pef_pend v_cod_fornec_infor
                     v_cod_pais = input frame f_adp_02_antecip_pef_pend fornecedor.cod_pais.

        assign v_cdn_fornecedor = integer(v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend) no-error.

        if  error-status:get-number(1) = 0
        then do:
           find fornecedor no-lock
                where fornecedor.cod_empresa = v_cod_empres_usuar
                  and fornecedor.cdn_fornecedor = v_cdn_fornecedor /*cl_sea_fornecedor_variable of fornecedor*/ no-error.
           if  not available fornecedor
           then do:
              find first fornecedor no-lock
                   where fornecedor.cod_empresa = v_cod_empres_usuar
                     and fornecedor.nom_abrev = v_cod_fornec_infor /*cl_sea_fornecedor_infor of fornecedor*/ no-error.
              if  not available fornecedor
              then do:
                 assign v_cod_fornec_infor = replace(v_cod_fornec_infor, '.', '')
                        v_cod_fornec_infor = replace(v_cod_fornec_infor, '/', '')
                        v_cod_fornec_infor = replace(v_cod_fornec_infor, '-', '').
                 find fornecedor no-lock
                      where fornecedor.cod_empresa = v_cod_empres_usuar
                        and fornecedor.cod_pais = v_cod_pais
                        and fornecedor.cod_id_feder = v_cod_fornec_infor /*cl_sea_fornecedor_pais_id_federal of fornecedor*/ no-error.
                 if  not available fornecedor
                 then do:
                    find first fornecedor no-lock
                         where fornecedor.cod_empresa = v_cod_empres_usuar
                           and fornecedor.cod_pais = v_cod_pais
                           and fornecedor.cod_id_feder = v_cod_fornec_infor /*cl_sea_fornecedor_pais_id_federal of fornecedor*/ no-error.
                    if  available fornecedor
                    then do:
                       view frame f_dlg_01_fornecedor_id_feder.
                       enable all with frame f_dlg_01_fornecedor_id_feder.
                       open query qr_fornecedor_id_feder for
                          each fornecedor no-lock
                          where fornecedor.cod_empresa = v_cod_empres_usuar
                            and fornecedor.cod_pais = v_cod_pais
                            and fornecedor.cod_id_feder = v_cod_fornec_infor /*cl_sea_fornecedor_pais_id_federal of fornecedor*/.
                       do  on endkey undo,leave:
                           wait-for window-close of current-window 
                                 or choose       of bt_ok
                                 or mouse-select-dblclick of br_fornecedor_id_feder.
                       end.
                       hide frame f_dlg_01_fornecedor_id_feder.
                       assign v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend = string(fornecedor.cdn_fornecedor).
                    end /* if */.
                 end /* if */.  
                 else do:
                    assign v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend = string(fornecedor.cdn_fornecedor).
                 end /* else */.   
              end /* if */.
           end /* if */.
           else do:
              assign v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend = string(fornecedor.cdn_fornecedor).
           end /* else */.
        end /* if */.
        else do:
           find fornecedor no-lock
                where fornecedor.cod_empresa = v_cod_empres_usuar
                  and fornecedor.nom_abrev = v_cod_fornec_infor /*cl_sea_fornecedor_infor of fornecedor*/ no-error.
           if  not available fornecedor
           then do:
              assign v_cod_fornec_infor = replace(v_cod_fornec_infor, '.', '')
                     v_cod_fornec_infor = replace(v_cod_fornec_infor, '/', '')
                     v_cod_fornec_infor = replace(v_cod_fornec_infor, '-', '').
              find fornecedor no-lock
                   where fornecedor.cod_empresa = v_cod_empres_usuar
                     and fornecedor.cod_pais = v_cod_pais
                     and fornecedor.cod_id_feder = v_cod_fornec_infor /*cl_sea_fornecedor_pais_id_federal of fornecedor*/ no-error.
              if  not available fornecedor
              then do:
                 find first fornecedor no-lock
                      where fornecedor.cod_empresa = v_cod_empres_usuar
                        and fornecedor.cod_pais = v_cod_pais
                        and fornecedor.cod_id_feder = v_cod_fornec_infor /*cl_sea_fornecedor_pais_id_federal of fornecedor*/ no-error.
                 if  available fornecedor
                 then do:
                    view frame f_dlg_01_fornecedor_id_feder.
                    enable all with frame f_dlg_01_fornecedor_id_feder.
                    open query qr_fornecedor_id_feder for
                       each fornecedor no-lock
                       where fornecedor.cod_empresa = v_cod_empres_usuar
                         and fornecedor.cod_pais = v_cod_pais
                         and fornecedor.cod_id_feder = v_cod_fornec_infor /*cl_sea_fornecedor_pais_id_federal of fornecedor*/.
                    do  on endkey undo,leave:
                        wait-for window-close of current-window 
                              or choose       of bt_ok
                              or mouse-select-dblclick of br_fornecedor_id_feder.
                    end.
                    hide frame f_dlg_01_fornecedor_id_feder.
                    assign v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend = string(fornecedor.cdn_fornecedor).
                 end /* if */.

              end /* if */.   
              else do:
                  assign v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend = string(fornecedor.cdn_fornecedor).
              end /* else */.       
           end /* if */.
           else do:
              assign v_cod_fornec_infor:screen-value in frame f_adp_02_antecip_pef_pend = string(fornecedor.cdn_fornecedor).
           end /* else */.
        end /* else */.
        if  available fornecedor
        then do:
            assign fornecedor.cod_pais:screen-value in frame f_adp_02_antecip_pef_pend = fornecedor.cod_pais
                  fornecedor.nom_abrev:screen-value in frame f_adp_02_antecip_pef_pend = fornecedor.nom_abrev.
            disable fornecedor.cod_pais
                    bt_zoo_66402
                    with frame f_adp_02_antecip_pef_pend.
        end /* if */.
        else do:
            enable fornecedor.cod_pais
                   bt_zoo_66402
                   with frame f_adp_02_antecip_pef_pend.
            assign fornecedor.cod_pais:screen-value  in frame f_adp_02_antecip_pef_pend = ""
                   fornecedor.nom_abrev:screen-value in frame f_adp_02_antecip_pef_pend = "".
        end /* else */.
    end /* if */.
    else do:
        enable fornecedor.cod_pais
               bt_zoo_66402
               with frame f_adp_02_antecip_pef_pend.
        assign fornecedor.cod_pais:screen-value  in frame f_adp_02_antecip_pef_pend = ""
               fornecedor.nom_abrev:screen-value in frame f_adp_02_antecip_pef_pend = "".
    end /* else */.
    /* End_Include: i_informar_chave_tab_relac_pessoa_fisic_jurid */

END PROCEDURE. /* pi_informar_chave_tab_relac_pessoa_fisic_jurid_aux */
/*****************************************************************************
** Procedure Interna.....: pi_bt_zoo3_add_antecip_pef_pend
** Descricao.............: pi_bt_zoo3_add_antecip_pef_pend
** Criado por............: fut12183
** Criado em.............: 29/04/2003 09:01:59
** Alterado por..........: bre17752
** Alterado em...........: 23/06/2003 17:47:35
*****************************************************************************/
PROCEDURE pi_bt_zoo3_add_antecip_pef_pend:

    assign v_num_ord_invest = ?.
    if  search("prgfin/apb/apb789zc.r") = ? and search("prgfin/apb/apb789zc.p") = ? then do:
        if  v_cod_dwb_user begins 'es_' then
            return "Programa execut†vel n∆o foi encontrado:" /*l_programa_nao_encontrado*/  + "prgfin/apb/apb789zc.p".
        else do:
            message getStrTrans("Programa execut†vel n∆o foi encontrado:", "APB") /*l_programa_nao_encontrado*/  "prgfin/apb/apb789zc.p"
                   view-as alert-box error buttons ok.
            return.
        end.
    end.
    else
        run prgfin/apb/apb789zc.p (input-output table tt_ordem_eve,
                               input-output v_num_ord_invest,
                               Input v_num_ord_compra) /*prg_fnc_ordem_eve_integr*/.
    if v_num_ord_invest > 0 then do:
        find first tt_ordem_eve no-lock
            where  tt_ordem_eve.ttv_num_ord_invest_integr = v_num_ord_invest no-error.
        if avail tt_ordem_eve then do:
            assign v_num_ped_compra:screen-value in frame f_adp_02_antecip_pef_pend = string(tt_ordem_eve.ttv_num_ped_integr)
                   v_num_ord_compra:screen-value in frame f_adp_02_antecip_pef_pend = string(tt_ordem_eve.ttv_num_oc_integr)
    /* v_num_event:screen-value      in frame @&(frame) = string(tt_ordem_eve.ttv_num_event_integr)*/ .
            assign input frame f_adp_02_antecip_pef_pend v_num_ped_compra
                   input frame f_adp_02_antecip_pef_pend v_num_ord_compra. /* v_num_event*/
    /* @apply(entry) v_num_event in frame @&(frame).*/
        end.
    end /* if */.
END PROCEDURE. /* pi_bt_zoo3_add_antecip_pef_pend */
/*****************************************************************************
** Procedure Interna.....: pi_value_changed_ind_modo_pagto_antecip
** Descricao.............: pi_value_changed_ind_modo_pagto_antecip
** Criado por............: fut12183
** Criado em.............: 29/04/2003 09:10:26
** Alterado por..........: src531
** Alterado em...........: 30/07/2003 10:52:13
*****************************************************************************/
PROCEDURE pi_value_changed_ind_modo_pagto_antecip:

    if  v_ind_modo_pagto:screen-value in frame f_adp_02_antecip_pef_pend = "Cheque" /*l_cheque*/  then do:
        run pi_retornar_finalid_indic_econ (Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_indic_econ,
                                            Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.dat_emis_docto,
                                            output v_cod_finalid_econ) /*pi_retornar_finalid_indic_econ*/.

        find usuar_financ_estab_apb no-lock
             where usuar_financ_estab_apb.cod_usuario = v_cod_usuar_corren
               and usuar_financ_estab_apb.cod_estab = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab /*cl_frame_usuar_corren of usuar_financ_estab_apb*/ no-error.
        find portad_finalid_econ no-lock
             where portad_finalid_econ.cod_estab = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab
               and portad_finalid_econ.cod_portador = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_portador
               and portad_finalid_econ.cod_cart_bcia = v_cod_cart_bcia
               and portad_finalid_econ.cod_finalid_econ = v_cod_finalid_econ
    &if "{&emsfin_version}" >= "5.01" &then
             use-index prtdfnld_id
    &endif
              /*cl_vrf_cheque_antecipacao of portad_finalid_econ*/ no-error.
        find last param_estab_apb no-lock
             where param_estab_apb.cod_estab = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab
    &if "{&emsfin_version}" >= "5.01" &then
             use-index prmstbpb_id
    &endif
              /*cl_frame of param_estab_apb*/ no-error.

        if  avail usuar_financ_estab_apb 
        and avail portad_finalid_econ
        and (usuar_financ_estab_apb.log_habilit_liber_tit_ap = yes
        or   input frame f_adp_02_antecip_pef_pend antecip_pef_pend.val_tit_ap < param_estab_apb.val_min_liber) then do:

            enable antecip_pef_pend.ind_favorec_cheq
                   antecip_pef_pend.num_talon_cheq
                   bt_zoo_178527
                   with frame f_adp_02_antecip_pef_pend.
            apply "value-changed" to antecip_pef_pend.ind_favorec_cheq in frame f_adp_02_antecip_pef_pend.
            apply "leave" to         antecip_pef_pend.num_talon_cheq   in frame f_adp_02_antecip_pef_pend.
        end.
        else do:
            disable antecip_pef_pend.num_cheque
                    antecip_pef_pend.ind_favorec_cheq
                    antecip_pef_pend.nom_favorec_cheq
                    antecip_pef_pend.num_talon_cheq
                    bt_zoo_178527
                    with frame f_adp_02_antecip_pef_pend.
            assign antecip_pef_pend.nom_favorec_cheq:screen-value in frame f_adp_02_antecip_pef_pend = ""
                   antecip_pef_pend.num_cheque:screen-value       in frame f_adp_02_antecip_pef_pend = ""
                   antecip_pef_pend.num_talon_cheq:screen-value   in frame f_adp_02_antecip_pef_pend = "".
        end.
        disable antecip_pef_pend.cod_forma_pagto
                bt_zoo_228185
                with frame f_adp_02_antecip_pef_pend.
        assign antecip_pef_pend.cod_forma_pagto:screen-value in frame f_adp_02_antecip_pef_pend = "".


    end.

    if  v_ind_modo_pagto:screen-value in frame f_adp_02_antecip_pef_pend = "Borderì" /*l_bordero*/  then do:

        assign antecip_pef_pend.ind_favorec_cheq:screen-value in frame f_adp_02_antecip_pef_pend = " ".

        assign antecip_pef_pend.nom_favorec_cheq:screen-value in frame f_adp_02_antecip_pef_pend = ""
               antecip_pef_pend.num_cheque:screen-value       in frame f_adp_02_antecip_pef_pend = ""
               antecip_pef_pend.num_talon_cheq:screen-value   in frame f_adp_02_antecip_pef_pend = "".

        disable antecip_pef_pend.num_cheque
                antecip_pef_pend.ind_favorec_cheq
                antecip_pef_pend.nom_favorec_cheq
                antecip_pef_pend.num_talon_cheq
                bt_zoo_178527
                with frame f_adp_02_antecip_pef_pend.                          

        enable antecip_pef_pend.cod_forma_pagto
               bt_zoo_228185
               with frame f_adp_02_antecip_pef_pend.

        if avail fornec_financ and antecip_pef_pend.cod_forma_pagto:screen-value in frame f_adp_02_antecip_pef_pend = " " then
              disp fornec_financ.cod_forma_pagto @ antecip_pef_pend.cod_forma_pagto with frame f_adp_02_antecip_pef_pend.                       

    end.

    if  v_ind_modo_pagto:screen-value in frame f_adp_02_antecip_pef_pend = ""
    or  v_ind_modo_pagto:screen-value in frame f_adp_02_antecip_pef_pend = ?
    then do:
        assign antecip_pef_pend.ind_favorec_cheq:screen-value in frame f_adp_02_antecip_pef_pend = " ".

        assign antecip_pef_pend.cod_forma_pagto:screen-value  in frame f_adp_02_antecip_pef_pend = ""
               antecip_pef_pend.nom_favorec_cheq:screen-value in frame f_adp_02_antecip_pef_pend = ""
               antecip_pef_pend.num_cheque:screen-value       in frame f_adp_02_antecip_pef_pend = ""
               antecip_pef_pend.num_talon_cheq:screen-value   in frame f_adp_02_antecip_pef_pend = "".

        disable antecip_pef_pend.num_talon_cheq
                antecip_pef_pend.num_cheque
                antecip_pef_pend.ind_favorec_cheq
                antecip_pef_pend.nom_favorec_cheq
                bt_zoo_178527
                antecip_pef_pend.cod_forma_pagto
                bt_zoo_228185
                with frame f_adp_02_antecip_pef_pend.

        displ "" @ antecip_pef_pend.cod_forma_pagto with frame f_adp_02_antecip_pef_pend.                        
    end /* if */.

    run pi_executa_epc_fornecedor /*pi_executa_epc_fornecedor*/.
END PROCEDURE. /* pi_value_changed_ind_modo_pagto_antecip */
/*****************************************************************************
** Procedure Interna.....: pi_atualiz_confirmacao_bloqueio_apb
** Descricao.............: pi_atualiz_confirmacao_bloqueio_apb
** Criado por............: barth
** Criado em.............: 12/06/2003 18:26:29
** Alterado por..........: src370
** Alterado em...........: 08/10/2003 14:00:18
*****************************************************************************/
PROCEDURE pi_atualiz_confirmacao_bloqueio_apb:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_estab
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def Input param p_cod_espec_docto
        as character
        format "x(3)"
        no-undo.
    def Input param p_cod_ser_docto
        as character
        format "x(3)"
        no-undo.
    def Input param p_cod_tit_ap
        as character
        format "x(10)"
        no-undo.
    def Input param p_cod_parcela
        as character
        format "x(02)"
        no-undo.
    def Input param p_cdn_fornecedor
        as Integer
        format ">>>,>>>,>>9"
        no-undo.
    def Input param p_cod_refer
        as character
        format "x(10)"
        no-undo.
    def Input param p_cod_estab_dest
        as character
        format "x(3)"
        no-undo.
    def Input param p_num_seq_refer
        as integer
        format ">>>9"
        no-undo.
    def Input param p_num_action
        as integer
        format ">>>>,>>9"
        no-undo.
    def input param p_cod_livre_1
        as character
        format "x(8)"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************** Buffer Definition Begin *************************/

    &if "{&emsfin_version}" >= "5.01" &then
    def buffer b_tit_ap_bloqueio
        for tit_ap.
    &endif


    /*************************** Buffer Definition End **************************/

    /************************* Variable Definition Begin ************************/

    def var v_des_help_erro
        as character
        format "x(200)":U
        no-undo.
    def var v_des_msg_erro
        as character
        format "x(60)":U
        view-as editor max-chars 2000 scrollbar-vertical
        size 60 by 2
        bgcolor 15 font 2
        label "Mensagem Erro"
        column-label "Inconsistància"
        no-undo.
    def var v_des_param
        as character
        format "x(50)":U
        label "Param"
        column-label "Param"
        no-undo.
    def var v_des_param_msg_bloq
        as character
        format "x(225)":U
        no-undo.
    def var v_num_cont_bloq
        as integer
        format ">>>>,>>9":U
        no-undo.
    def var v_num_msg_erro_bloq
        as integer
        format ">>>>,>>9":U
        no-undo.


    /************************** Variable Definition End *************************/

    /* ******************************************************************
    *** ParÉmetros passados para a API 
    ***   => p_num_action  = 1 Mostra erro em tela
    ***                    = 2 Cria Temp-Table de erros 
    ***                    = 3 Cria Temp-Table de erros usado somente o Programa APB739za
    ***
    ***   => p_cod_livre_1 =  ParÉmetro livre INPUT, Ainda n∆o utilizado 
    ***                       Que pode ser utilizado para a passagem de mais parÉmetros
    ********************************************************************/

    /* ** BLOQUEIO INCONSIST“NCIAS DO T÷TULO ACR 
     *** CASO EXISTA ALGUM ERRO N«O IRµ PROCEGUIR COM A MOVIMENTAÄ«O
     *** (NASS/BARTH)                      ****/
    bloqueio_block:
    do on error undo bloqueio_block, return error:

        /* ** N∆o Ç necess†rio tratar se o movimento ou o T°tulo est† dispon°vel ***/
        find b_tit_ap_bloqueio
             where b_tit_ap_bloqueio.cod_estab       = p_cod_estab
             and   b_tit_ap_bloqueio.cod_espec_docto = p_cod_espec_docto
             and   b_tit_ap_bloqueio.cod_ser_docto   = p_cod_ser_docto
             and   b_tit_ap_bloqueio.cdn_fornecedor  = p_cdn_fornecedor
             and   b_tit_ap_bloqueio.cod_tit_ap      = p_cod_tit_ap
             and   b_tit_ap_bloqueio.cod_parcela     = p_cod_parcela
             no-lock no-error.

        if  avail b_tit_ap_bloqueio then do:
            find last  movto_tit_ap use-index mvtttp_id no-lock
                 where movto_tit_ap.cod_estab     = b_tit_ap_bloqueio.cod_estab
                 and   movto_tit_ap.num_id_tit_ap = b_tit_ap_bloqueio.num_id_tit_ap
                 and   movto_tit_ap.cod_refer     = p_cod_refer no-error.
        end.
        else do:
            /* Essa alteraªío ≤ para testar o PEF*/
            find first movto_tit_ap
                where movto_tit_ap.cod_estab = p_cod_estab
                and   movto_tit_ap.cod_refer = p_cod_refer no-lock no-error.
            if  avail movto_tit_ap
            and movto_tit_ap.ind_trans_ap_abrev <> "PGEF" /*l_PGEF*/  then return 'OK'.
            if  not avail movto_tit_ap then
                return 'OK'.
        end.
        run prgfin/apb/apb923za.py (buffer b_tit_ap_bloqueio,
                                    buffer movto_tit_ap,
                                    output v_num_msg_erro_bloq,
                                    output v_des_param_msg_bloq) /*prg_fnc_valida_diferenca_titulo_apb*/.
        if  v_num_msg_erro_bloq <> 0 then do:
            /* ** Traduz os parametros para o formato da API ***/
            do v_num_cont_bloq = 1 to  9: 
               if v_num_cont_bloq = 1 then 
                   assign v_des_param = entry(v_num_cont_bloq, v_des_param_msg_bloq, chr(10)). 
               else do:
                   if  v_num_cont_bloq <= num-entries(v_des_param_msg_bloq, chr(10)) then 
                       assign v_des_param =  v_des_param +  '~~' +  entry(v_num_cont_bloq, v_des_param_msg_bloq, chr(10)).
                   else /* ** Adiciona os EntryÔs Faltantes ***/
                      assign v_des_param =  v_des_param +  '~~'.
               end.
            end.
            case p_num_action :
                when 1 then do:
                    run pi_messages (input "show" /*l_show*/ ,
                                     input v_num_msg_erro_bloq,
                                     input v_des_param).
                end.
                when 2 then do:
                    run  pi_messages (input "Help" /*l_help*/ ,
                                      input v_num_msg_erro_bloq,
                                      input v_des_param). 
                    assign v_des_help_erro = return-value.
                    assign v_des_help_erro =  substitute(v_des_help_erro,
                                                  entry(1, v_des_param, "~~"),
                                                  entry(2, v_des_param , "~~"), 
                                                  entry(3, v_des_param , "~~"), 
                                                  entry(4,v_des_param, "~~"), 
                                                  entry(5, v_des_param, "~~"), 
                                                  entry(6, v_des_param, "~~"), 
                                                  entry(7,v_des_param , "~~"), 
                                                  entry(8, v_des_param , "~~"), 
                                                  entry(9, v_des_param , "~~")).
                    run pi_verifica_msg_erro (Input p_cod_estab,
                                              Input p_cod_espec_docto,
                                              Input p_cod_ser_docto,
                                              Input p_cdn_fornecedor,
                                              Input p_cod_tit_ap,
                                              Input p_cod_parcela,
                                              Input p_cod_refer,
                                              Input v_des_help_erro,
                                              Input p_cod_estab_dest,
                                              Input p_num_seq_refer) /*pi_verifica_msg_erro*/.
                end.
                when 3 then do:
                    run  pi_messages (input "Msg" /*l_msg*/ ,
                                      input v_num_msg_erro_bloq,
                                      input v_des_param).                      
                    assign v_des_msg_erro = return-value.
                    assign v_des_msg_erro =  substitute(v_des_msg_erro,
                                                  entry(1, v_des_param, "~~"),
                                                  entry(2, v_des_param , "~~"),
                                                  entry(3, v_des_param , "~~"),
                                                  entry(4,v_des_param, "~~"),
                                                  entry(5, v_des_param, "~~"),
                                                  entry(6, v_des_param, "~~"),
                                                  entry(7,v_des_param , "~~"),
                                                  entry(8, v_des_param , "~~"),
                                                  entry(9, v_des_param , "~~")).

                    run  pi_messages (input "Help" /*l_help*/ ,
                                      input v_num_msg_erro_bloq,
                                      input v_des_param).
                    assign v_des_help_erro = return-value.
                    assign v_des_help_erro =  substitute(v_des_help_erro,
                                                  entry(1, v_des_param, "~~"),
                                                  entry(2, v_des_param , "~~"),
                                                  entry(3, v_des_param , "~~"),
                                                  entry(4,v_des_param, "~~"),
                                                  entry(5, v_des_param, "~~"),
                                                  entry(6, v_des_param, "~~"),
                                                  entry(7,v_des_param , "~~"),
                                                  entry(8, v_des_param , "~~"),
                                                  entry(9, v_des_param , "~~")).
                    run pi_cria_tt_log_erros_atualiz (Input p_cod_estab,
                                                      Input p_cod_refer,
                                                      Input p_num_seq_refer,
                                                      Input v_num_msg_erro_bloq,
                                                      Input v_des_msg_erro,
                                                      Input v_des_help_erro) /*pi_cria_tt_log_erros_atualiz*/.
                end.
            end case.
            RETURN "NOK" /*l_NOK*/ .
        end.
        RETURN "OK" /*l_OK*/ .
    end.
END PROCEDURE. /* pi_atualiz_confirmacao_bloqueio_apb */
/*****************************************************************************
** Procedure Interna.....: pi_executa_epc_fornecedor
** Descricao.............: pi_executa_epc_fornecedor
** Criado por............: src531
** Criado em.............: 16/07/2003 09:33:11
** Alterado por..........: src531
** Alterado em...........: 24/07/2003 17:32:30
*****************************************************************************/
PROCEDURE pi_executa_epc_fornecedor:


    /* Begin_Include: i_exec_program_epc */
    &if '{&emsbas_version}' > '1.00' &then
    if  v_nom_prog_upc <> '' then
    do:
        assign v_rec_table_epc = recid(antecip_pef_pend).    
        run value(v_nom_prog_upc) (input 'Favorecido',
                                   input 'viewer',
                                   input this-procedure,
                                   input v_wgh_frame_epc,
                                   input v_nom_table_epc,
                                   input v_rec_table_epc).
        if  'no' = 'yes'
        and return-value = 'NOK' then
            undo, retry.
    end.

    if  v_nom_prog_appc <> '' then
    do:
        assign v_rec_table_epc = recid(antecip_pef_pend).    
        run value(v_nom_prog_appc) (input 'Favorecido',
                                    input 'viewer',
                                    input this-procedure,
                                    input v_wgh_frame_epc,
                                    input v_nom_table_epc,
                                    input v_rec_table_epc).
        if  'no' = 'yes'
        and return-value = 'NOK' then
            undo, retry.
    end.

    &if '{&emsbas_version}' > '5.00' &then
    if  v_nom_prog_dpc <> '' then
    do:
        assign v_rec_table_epc = recid(antecip_pef_pend).    
        run value(v_nom_prog_dpc) (input 'Favorecido',
                                    input 'viewer',
                                    input this-procedure,
                                    input v_wgh_frame_epc,
                                    input v_nom_table_epc,
                                    input v_rec_table_epc).
        if  'no' = 'yes'
        and return-value = 'NOK' then
            undo, retry.
    end.
    &endif
    &endif
    /* End_Include: i_exec_program_epc */

END PROCEDURE. /* pi_executa_epc_fornecedor */
/*****************************************************************************
** Procedure Interna.....: pi_on_leave_cod_estab_antecip_pef_pend
** Descricao.............: pi_on_leave_cod_estab_antecip_pef_pend
** Criado por............: fut12183
** Criado em.............: 21/07/2003 15:46:29
** Alterado por..........: fut1236_2
** Alterado em...........: 15/08/2006 11:18:05
*****************************************************************************/
PROCEDURE pi_on_leave_cod_estab_antecip_pef_pend:

    run pi_acha_estab_apb /*pi_acha_estab_apb*/.
    assign v_cod_empres_usuar_2 = v_cod_empres_usuar.
    &if '{&emsfin_version}' >= '5.03' &then
        find last param_geral_apb no-lock no-error.
        if avail param_geral_apb then do:
            if param_geral_apb.log_reg_corporat then do:
                if  avail estabelecimento
                then do:
                    assign v_cod_empres_usuar_2 = estabelecimento.cod_empresa.
                end /* if */.
            end.
        end.
    &endif
    run pi_acha_fornecedor_informado (output v_cdn_fornecedor,
                                      output v_num_pessoa) /*pi_acha_fornecedor_informado*/.
    display fornecedor.nom_abrev when avail fornecedor
            "" when not avail fornecedor @ fornecedor.nom_abrev
            fornecedor.cod_pais when avail fornecedor
            "" when not avail fornecedor @ fornecedor.cod_pais
            with frame f_adp_02_antecip_pef_pend.
    run pi_verifica_impto_vincul_fornec (Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab,
                                         Input v_cdn_fornecedor,
                                         Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.dat_emis_docto,
                                         output v_log_impto_vincul_fornec) /*pi_verifica_impto_vincul_fornec*/.

    if  v_log_impto_vincul_fornec = yes then
        enable bt_impto_retido2
               with frame f_adp_02_antecip_pef_pend.
    else
        disable bt_impto_retido2
                with frame f_adp_02_antecip_pef_pend.

    run pi_verificar_cheque_antecipacao /*pi_verificar_cheque_antecipacao*/.
    run pi_verificar_impto_taxado (Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab,
                                   Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.dat_emis_docto,
                                   output v_log_impto_taxado) /*pi_verificar_impto_taxado*/.
    if  v_log_impto_taxado = yes then
        enable bt_impto_taxado
               with frame f_adp_02_antecip_pef_pend.
    else
        disable bt_impto_taxado
                with frame f_adp_02_antecip_pef_pend.

    if v_log_sul_america then do:
        run pi_verificar_iva (Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab,
                              Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.dat_emis_docto,
                              output v_log_impto_val_agreg) /*pi_verificar_iva*/.
        if v_log_impto_val_agreg then
            enable bt_impto_val_agreg
                with frame f_adp_02_antecip_pef_pend.
        else
            disable bt_impto_val_agreg
                with frame f_adp_02_antecip_pef_pend.
    end.

    /* **
     Mostra imagem Cta Corrente
    ***/
    run pi_mostra_imagem_cta_corren (Input "",
                                     Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab,
                                     Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_portador,
                                     Input v_cod_cart_bcia,
                                     Input v_cod_finalid_econ) /*pi_mostra_imagem_cta_corren*/.
END PROCEDURE. /* pi_on_leave_cod_estab_antecip_pef_pend */
/*****************************************************************************
** Procedure Interna.....: pi_bt_rat_val_antecip_pef_pend
** Descricao.............: pi_bt_rat_val_antecip_pef_pend
** Criado por............: fut12183
** Criado em.............: 21/07/2003 16:49:23
** Alterado por..........: fut41675
** Alterado em...........: 18/05/2010 11:50:09
*****************************************************************************/
PROCEDURE pi_bt_rat_val_antecip_pef_pend:

    run pi_save_key /*pi_save_key*/.

    assign input frame f_adp_02_antecip_pef_pend antecip_pef_pend.val_tit_ap
           input frame f_adp_02_antecip_pef_pend antecip_pef_pend.dat_emis_docto.

    /* Valida Estabelecimento-Empresa */
    &if "{&emsuni_dbinst}" = "yes" &then
        def buffer bcx_stblcmnt_antcppfp for estabelecimento.
        if  not (can-find(first bcx_stblcmnt_antcppfp
                          where bcx_stblcmnt_antcppfp.cod_estab = antecip_pef_pend.cod_estab
        )) then do:
            run pi_messages (input "show",
                             input 1284,
                             input "Estabelecimento~~Estabelecimentos"). /*msg_1284*/
            return error.
        end
    &endif.

    apply "leave" to antecip_pef_pend.cod_estab in frame f_adp_02_antecip_pef_pend.
    run pi_validar_estab (Input v_cod_empres_usuar_2,
                          Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab,
                          Input antecip_pef_pend.dat_emis_docto,
                          output v_cod_return) /*pi_validar_estab*/.
    if  v_cod_return = "Unidade Organizacional" /*l_unid_organ*/  then do:
        /* Estabelecimento n∆o habilitado como Unidade Organizacional ! */
        run pi_messages (input "show",
                         input 347,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_347*/.
        return error.
    end.
    if  v_cod_return = "Empresa" /*l_empresa*/  then do:
        /* Empresa do Estabelecimento Diferente da Empresa do Usu†rio ! */
        run pi_messages (input "show",
                         input 512,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_512*/.
        return error.
    end.
    if  v_cod_return = "Usu†rio" /*l_usuario*/  then do:
        /* Usu†rio sem permiss∆o para acessar o estabelecimento &1 ! */
        run pi_messages (input "show",
                         input 348,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_348*/.

        return error.
    end.

    run pi_validar_usuar_estab_apb (Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab,
                                    Input "Implantador" /*l_implantador*/,
                                    output v_cod_return,
                                    output v_val_lim_liber_usuar_movto,
                                    output v_val_lim_liber_usuar_mes,
                                    output v_val_lim_pagto_usuar_movto,
                                    output v_val_lim_pagto_usuar_mes) /*pi_validar_usuar_estab_apb*/.
    /* case_block: */
    case v_cod_return:
        when "no" /*l_no*/ then
            no_block:
            do:
                /* Usu†rio &1 n∆o possui permiss∆o para &2 ! */
                run pi_messages (input "show",
                                 input 701,
                                 input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                   v_cod_usuar_corren, "Implantar" /*l_implantar*/)) /*msg_701*/.
                return error.
            end.
        when "602" then
            602_block:
            do:
                /* Usu†rio Financeiro Inexistente ! */
                run pi_messages (input "show",
                                 input 602,
                                 input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_602*/.
                return error.
            end.
    end.

    /* Valida referencia unica */
    run pi_verifica_refer_unica_apb (Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab,
                                     Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_refer,
                                     Input "antecip_pef_pend" /*l_antecip_pef_pend*/,
                                     Input ?,
                                     output v_log_refer_uni) /*pi_verifica_refer_unica_apb*/.
    if  v_log_refer_uni = no then do:
        /* Referància deve ser £nica ! */
        run pi_messages (input "show",
                         input 742,
                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_742*/.
        return error.
    end.

    if input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_portador <> "" 
    then do:
        run pi_validar_portador (Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_portador,
                                 Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab,
                                 Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_indic_econ,
                                 Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.dat_emis_docto,
                                 Input no,
                                 Input "",
                                 output v_ind_finalid_ctbl_err,
                                 output v_cod_finalid_econ,
                                 Input v_cod_cart_bcia) /*pi_validar_portador*/.

        if  return-value <> "OK" /*l_ok*/  then do:
            if  return-value = "506" then
                /* Portador Inexistente ! */
                run pi_messages (input "show",
                                 input 506,
                                 input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_506*/.
            if  return-value = "775" then 
                /* Portador &1 n∆o vinculado ao estabelecimento &2 ! */
                run pi_messages (input "show",
                                 input 775,
                                 input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                    input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_portador, input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab)) /*msg_775*/.
            if  return-value = "776" then 
                /* Finalidade ou Indicador Econìmico Incorreto para Portador ! */
                run pi_messages (input "show",
                                 input 776,
                                 input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                    v_cod_finalid_econ, input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_portador, input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab)) /*msg_776*/.
            apply "entry" to antecip_pef_pend.cod_portador in frame f_adp_02_antecip_pef_pend.
            assign antecip_pef_pend.cod_portador:sensitive in frame f_adp_02_antecip_pef_pend = yes.
            enable bt_zoo_66406
                   with frame f_adp_02_antecip_pef_pend.
            return error.
        end.
    end.      

    disable bt_zoo_66395
            with frame f_adp_02_antecip_pef_pend.

    assign antecip_pef_pend.cod_espec_docto = input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_espec_docto.

    if v_log_sul_america then
        run prgfin/apb/apb935ze.py (Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab,
                                    Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_refer,
                                    Input antecip_pef_pend.dat_emis_docto,
                                    Input 1,
                                    Input "On-Line" /*l_online*/ ,
                                    Input 0).

    if input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_portador <> "" 
    then do:
        run prgfin/apb/apb731za.p (Input yes,
                                   Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab,
                                   Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_refer,
                                   Input 0,
                                   Input "Antecipaá∆o" /*l_antecipacao*/,
                                   Input antecip_pef_pend.dat_emis_docto,
                                   Input antecip_pef_pend.val_tit_ap,
                                   Input yes) /*prg_fnc_rateio_valor_ap*/.
    end.
    else do:
        run prgfin/apb/apb731za.p (Input yes,
                                   Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab,
                                   Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_refer,
                                   Input 0,
                                   Input "Antecip_s_portador" /*l_antecip_s_portador*/,
                                   Input antecip_pef_pend.dat_emis_docto,
                                   Input antecip_pef_pend.val_tit_ap,
                                   Input yes) /*prg_fnc_rateio_valor_ap*/.
    end.

    if v_log_sul_america then
        run prgfin/apb/apb935ze.py (Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_estab,
                                    Input input frame f_adp_02_antecip_pef_pend antecip_pef_pend.cod_refer,
                                    Input antecip_pef_pend.dat_emis_docto,
                                    Input 2,
                                    Input "On-Line" /*l_online*/ ,
                                    Input 0).                                

    run pi_verifica_relacoes_antecip_pef_pend /*pi_verifica_relacoes_antecip_pef_pend*/.
END PROCEDURE. /* pi_bt_rat_val_antecip_pef_pend */
/*****************************************************************************
** Procedure Interna.....: pi_monta_lista_modul_dtsul_empres
** Descricao.............: pi_monta_lista_modul_dtsul_empres
** Criado por............: vladimir
** Criado em.............: 02/01/1996 11:48:09
** Alterado por..........: karla
** Alterado em...........: 17/12/1996 16:15:04
*****************************************************************************/
PROCEDURE pi_monta_lista_modul_dtsul_empres:

    assign v_cod_modul_dtsul_empres = "".

    block_modul_dtsul:
    for
       each param_utiliz_produt no-lock
       where param_utiliz_produt.cod_empresa = v_cod_empres_usuar
         and param_utiliz_produt.cod_modul_dtsul <> "" /*cl_modulos_empresa of param_utiliz_produt*/:
       assign v_cod_modul_dtsul_empres = v_cod_modul_dtsul_empres + "," + param_utiliz_produt.cod_modul_dtsul.
    end /* for block_modul_dtsul */.

    assign v_cod_modul_dtsul_empres = substr(v_cod_modul_dtsul_empres,2,200).


END PROCEDURE. /* pi_monta_lista_modul_dtsul_empres */
/*****************************************************************************
** Procedure Interna.....: pi_right_mouse_down_dialog_box
** Descricao.............: pi_right_mouse_down_dialog_box
** Criado por............: bre19062
** Criado em.............: 29/10/2002 15:55:42
** Alterado por..........: bre19062
** Alterado em...........: 29/10/2002 16:03:59
*****************************************************************************/
PROCEDURE pi_right_mouse_down_dialog_box:

    /************************* Variable Definition Begin ************************/

    def var v_wgh_frame
        as widget-handle
        format ">>>>>>9":U
        no-undo.


    /************************** Variable Definition End *************************/


    /* Begin_Include: i_right_mouse_down_dialog_box */
    if  (self:type <> "DIALOG-BOX" /*l_dialog_box*/ )
    and (self:type <> "FRAME" /*l_frame*/      )
    and (self:type <> "text" /*l_text*/       )
    and (self:type <> "IMAGE" /*l_image*/      )
    and (self:type <> "RECTANGLE" /*l_rectangle*/  )
    then do:

        assign v_wgh_frame = self:parent.

        if  self:type        = "fill-in" /*l_fillin*/ 
        and v_wgh_frame:type = "Browse" /*l_browse*/  then
            return no-apply.

        if  valid-handle(self:popup-menu) = yes then
            return no-apply.

        assign v_wgh_frame = self:frame.

        if  (v_wgh_frame:type <> "DIALOG-BOX" /*l_dialog_box*/ ) and (v_wgh_frame:frame <> ?)
        then do:
               assign v_wgh_frame     = v_wgh_frame:frame.
        end /* if */.
        assign v_nom_title_aux    = v_wgh_frame:title
               v_wgh_frame:title  = self:help.
    end /* if */.
    /* End_Include: i_right_mouse_down_dialog_box */

END PROCEDURE. /* pi_right_mouse_down_dialog_box */
/*****************************************************************************
** Procedure Interna.....: pi_right_mouse_up_dialog_box
** Descricao.............: pi_right_mouse_up_dialog_box
** Criado por............: bre16039
** Criado em.............: 16/04/2001 11:53:59
** Alterado por..........: bre16039
** Alterado em...........: 16/04/2001 14:30:06
*****************************************************************************/
PROCEDURE pi_right_mouse_up_dialog_box:

    /************************* Variable Definition Begin ************************/

    def var v_wgh_frame
        as widget-handle
        format ">>>>>>9":U
        no-undo.


    /************************** Variable Definition End *************************/


    /* Begin_Include: i_right_mouse_up_dialog_box */
    if  (self:type <> "DIALOG-BOX" /*l_dialog_box*/ )
    and (self:type <> "FRAME" /*l_frame*/      )
    and (self:type <> "text" /*l_text*/       )
    and (self:type <> "IMAGE" /*l_image*/      )
    and (self:type <> "RECTANGLE" /*l_rectangle*/  )
    then do:

        assign v_wgh_frame = self:parent.

        if  self:type        = "fill-in" /*l_fillin*/ 
        and v_wgh_frame:type = "Browse" /*l_browse*/  then
            return no-apply.

        if  valid-handle(self:popup-menu) = yes then
            return no-apply.

        assign v_wgh_frame        = self:frame.
        if  (v_wgh_frame:type <> "DIALOG-BOX" /*l_dialog_box*/ ) and (v_wgh_frame:frame <> ?)
        then do:
               assign v_wgh_frame     = v_wgh_frame:frame.
        end /* if */.
        assign v_wgh_frame:title  = v_nom_title_aux.
    end /* if */.

    /* End_Include: i_right_mouse_up_dialog_box */

END PROCEDURE. /* pi_right_mouse_up_dialog_box */
/*****************************************************************************
** Procedure Interna.....: pi_choose_antecip_pef_pend
** Descricao.............: pi_choose_antecip_pef_pend
** Criado por............: its0098
** Criado em.............: 31/03/2004 16:40:53
** Alterado por..........: its0098
** Alterado em...........: 01/04/2004 11:11:26
*****************************************************************************/
PROCEDURE pi_choose_antecip_pef_pend:

    CASE v_wgh_current_button:
        WHEN bt_segur_leas:HANDLE IN FRAME f_adp_02_antecip_pef_pend THEN DO:
            bloco:
            do on error undo bloco, leave bloco:
                run pi_save_key /*pi_save_key*/.

                /* Valida Estabelecimento-Empresa */
                &if "{&emsuni_dbinst}" = "yes" &then
                    def buffer bcx_stblcmnt_antcppfp for estabelecimento.
                    if  not (can-find(first bcx_stblcmnt_antcppfp
                                      where bcx_stblcmnt_antcppfp.cod_estab = antecip_pef_pend.cod_estab
                    )) then do:
                        run pi_messages (input "show",
                                         input 1284,
                                         input "Estabelecimento~~Estabelecimentos"). /*msg_1284*/
                        return error.
                    end
                &endif.

                run pi_validar_estab (Input v_cod_empres_usuar_2,
                                      Input antecip_pef_pend.cod_estab,
                                      Input antecip_pef_pend.dat_emis_docto,
                                      output v_cod_return) /*pi_validar_estab*/.
                if  v_cod_return = "Unidade Organizacional" /*l_unid_organ*/  then do:
                    /* Estabelecimento n∆o habilitado como Unidade Organizacional ! */
                    run pi_messages (input "show",
                                     input 347,
                                     input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_347*/.
                    return no-apply.
                end.
                if  v_cod_return = "Empresa" /*l_empresa*/  then do:
                    /* Empresa do Estabelecimento Diferente da Empresa do Usu†rio ! */
                    run pi_messages (input "show",
                                     input 512,
                                     input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_512*/.
                    return no-apply.
                end.
                if  v_cod_return = "Usu†rio" /*l_usuario*/  then do:
                    /* Usu†rio sem permiss∆o para acessar o estabelecimento &1 ! */
                    run pi_messages (input "show",
                                     input 348,
                                     input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_348*/.
                    if  antecip_pef_pend.cod_estab:sensitive in frame f_adp_02_antecip_pef_pend = yes then
                        assign v_wgh_focus = antecip_pef_pend.cod_estab:handle in frame f_adp_02_antecip_pef_pend.
                    else
                        assign v_wgh_focus = ?.
                    return no-apply.
                end.

                run pi_validar_usuar_estab_apb (Input antecip_pef_pend.cod_estab,
                                                Input "Implantador" /*l_implantador*/,
                                                output v_cod_return,
                                                output v_val_lim_liber_usuar_movto,
                                                output v_val_lim_liber_usuar_mes,
                                                output v_val_lim_pagto_usuar_movto,
                                                output v_val_lim_pagto_usuar_mes) /*pi_validar_usuar_estab_apb*/.
                /* case_block: */
                case v_cod_return:
                    when "no" /*l_no*/ then
                        no_block:
                        do:
                            /* Usu†rio &1 n∆o possui permiss∆o para &2 ! */
                            run pi_messages (input "show",
                                             input 701,
                                             input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                               v_cod_usuar_corren, "Implantar" /*l_implantar*/)) /*msg_701*/.
                            return no-apply.
                        end.
                    when "602" then
                        602_block:
                        do:
                            /* Usu†rio Financeiro Inexistente ! */
                            run pi_messages (input "show",
                                             input 602,
                                             input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_602*/.
                            return no-apply.
                        end.
                end.

                /* Valida referencia unica */
                run pi_verifica_refer_unica_apb (Input antecip_pef_pend.cod_estab,
                                                 Input antecip_pef_pend.cod_refer,
                                                 Input "antecip_pef_pend" /*l_antecip_pef_pend*/,
                                                 Input ?,
                                                 output v_log_refer_uni) /*pi_verifica_refer_unica_apb*/.
                if  v_log_refer_uni = no then do:
                    /* Referància deve ser £nica ! */
                    run pi_messages (input "show",
                                     input 742,
                                     input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_742*/.
                    return no-apply.
                end.

                assign v_rec_antecip_pef_pend = recid(antecip_pef_pend).

                run pi_verifica_relacoes_antecip_pef_pend.

                run prgfin/apb/apb701cb.p /*prg_add_antecip_pef_pend_segur*/.
            end.
        END.
    END.
END PROCEDURE. /* pi_choose_antecip_pef_pend */
/*****************************************************************************
** Procedure Interna.....: pi_exec_program_epc_FIN
** Descricao.............: pi_exec_program_epc_FIN
** Criado por............: src388
** Criado em.............: 09/09/2003 10:48:55
** Alterado por..........: fut1309
** Alterado em...........: 15/02/2006 09:44:03
*****************************************************************************/
PROCEDURE pi_exec_program_epc_FIN:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_event
        as character
        format "x(100)"
        no-undo.
    def Input param p_cod_return
        as character
        format "x(40)"
        no-undo.
    def output param p_log_return_epc
        as logical
        format "Sim/N∆o"
        no-undo.


    /************************* Parameter Definition End *************************/

    /* *******************************************************************************************
    ** Objetivo..............: Substituir o c¢digo gerado pela include i_exec_program_epc,
    **                         muitas vezes repetido, com o intuito de evitar estouro de segmento.
    **
    ** Utilizaá∆o............: A utilizaá∆o desta procedure funciona exatamente como a include
    **                         anteriormente utilizada para este fim, para chamar ela deve ser 
    **                         includa a include i_executa_pi_epc_fin no programa, que ira executar 
    **                         esta pi e fazer tratamento para os retornos. Deve ser declarada a 
    **                         variavel v_log_return_epc (caso o parametro ela seja verdade, Ç 
    **                         porque a EPC retornou "NOK". 
    **
    **                         @i(i_executa_pi_epc_fin &event='INITIALIZE' &return='NO')
    **
    **                         Para se ter uma idÇia de como se usa, favor olhar o fonte do apb008za.p
    **
    **
    *********************************************************************************************/

    assign p_log_return_epc = no.
    /* ix_iz1_add_antecip_pef_pend */


    /* Begin_Include: i_exec_program_epc_pi_fin */
    if  v_nom_prog_upc <> ''    
    or  v_nom_prog_appc <> ''
    or  v_nom_prog_dpc <> '' then do:
        &if 'antecip_pef_pend' <> '' &then
            assign v_rec_table_epc = recid(antecip_pef_pend)
                   v_nom_table_epc = 'antecip_pef_pend'.
        &else
            assign v_rec_table_epc = ?
                   v_nom_table_epc = "".
        &endif
    end.
    &if '{&emsbas_version}' > '1.00' &then
    if  v_nom_prog_upc <> '' and not p_log_return_epc
    then do:
        run value(v_nom_prog_upc) (input p_cod_event,
                                   input 'viewer',
                                   input this-procedure,
                                   input v_wgh_frame_epc,
                                   input v_nom_table_epc,
                                   input v_rec_table_epc).
        if  p_cod_return = "yes" /*l_yes*/ 
        and return-value = "NOK" /*l_nok*/  then
            assign p_log_return_epc = yes.
    end /* if */.

    if  v_nom_prog_appc <> '' and not p_log_return_epc
    then do:
        run value(v_nom_prog_appc) (input p_cod_event,
                                    input 'viewer',
                                    input this-procedure,
                                    input v_wgh_frame_epc,
                                    input v_nom_table_epc,
                                    input v_rec_table_epc).
        if  p_cod_return = "yes" /*l_yes*/ 
        and return-value = "NOK" /*l_nok*/  then
            assign p_log_return_epc = yes.
    end /* if */.

    &if '{&emsbas_version}' > '5.00' &then
    if  v_nom_prog_dpc <> '' and not p_log_return_epc
    then do:
        run value(v_nom_prog_dpc) (input p_cod_event,
                                    input 'viewer',
                                    input this-procedure,
                                    input v_wgh_frame_epc,
                                    input v_nom_table_epc,
                                    input v_rec_table_epc).
        if  p_cod_return = "yes" /*l_yes*/ 
        and return-value = "NOK" /*l_nok*/  then
            assign p_log_return_epc = yes.
    end /* if */.
    &endif
    &endif

    /* End_Include: i_exec_program_epc_pi_fin */



    /* Begin_Include: ix_iz2_add_antecip_pef_pend */

    /* End_Include: ix_iz2_add_antecip_pef_pend */

END PROCEDURE. /* pi_exec_program_epc_FIN */
/*****************************************************************************
** Procedure Interna.....: pi_i_return_msg_erro_conver
** Descricao.............: pi_i_return_msg_erro_conver
** Criado por............: its0105
** Criado em.............: 07/01/2005 09:09:50
** Alterado por..........: its0105
** Alterado em...........: 21/01/2005 09:52:18
*****************************************************************************/
PROCEDURE pi_i_return_msg_erro_conver:

    /************************ Parameter Definition Begin ************************/

    def input-output param p_cod_return
        as character
        format "x(40)"
        no-undo.


    /************************* Parameter Definition End *************************/

    assign v_cod_return = p_cod_return.

    /* Begin_Include: i_return_msg_erro_conver */
    /* *************************************************************
    * ATENÄ«O: AS INCLUDES ABAIXO DEVEM ESTAR EM SINCRONIA (Barth)
    *
    *          i_return_msg_erro_conver
    *          i_return_msg_erro_conver_api
    *          i_return_msg_erro_conver_api_impl
    *          i_rnl_tit_acr_corrigir
    *
    ***************************************************************/
    /* Manter as alteraá‰es desta include por demanda. Atividade 174046 */
    if  v_cod_return <> "" and v_cod_return <> "OK" /*l_ok*/ 
    then do:
        assign v_cod_return = v_cod_return + ",,,,,,,,,".
        run pi_messages(input "show" /*l_show*/ ,
                        input integer(entry(1,v_cod_return)),
                        input substitute("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                         entry(2, v_cod_return), entry(3, v_cod_return),
                                         entry(4, v_cod_return), entry(5, v_cod_return),
                                         entry(6, v_cod_return), entry(7, v_cod_return),
                                         entry(8, v_cod_return), entry(9, v_cod_return),
                                         entry(10, v_cod_return))).
        return "NOK" /* l_nok*/.
    end /* if */.


    /* End_Include: i_return_msg_erro_conver */

    assign p_cod_return = v_cod_return.

    return "OK" /*l_ok*/ .
END PROCEDURE. /* pi_i_return_msg_erro_conver */
/*****************************************************************************
** Procedure Interna.....: pi_choose_bt_cod_barra_antecip
** Descricao.............: pi_choose_bt_cod_barra_antecip
** Criado por............: its0042
** Criado em.............: 23/05/2005 16:49:00
** Alterado por..........: fut12163
** Alterado em...........: 13/10/2005 09:11:35
*****************************************************************************/
PROCEDURE pi_choose_bt_cod_barra_antecip:

    /************************** Buffer Definition Begin *************************/

    &if "{&emsfin_version}" >= "5.01" &then
    def buffer b_antecip_pef_pend_aux
        for antecip_pef_pend.
    &endif


    /*************************** Buffer Definition End **************************/

    if  avail antecip_pef_pend
    then do:
        &if '{&emsfin_version}' >= "5.05" &then
            assign v_cod_barra    = antecip_pef_pend.cb4_tit_ap_bco_cobdor
                   v_cod_num_bcio = antecip_pef_pend.cod_tit_ap_bco_cobdor.
        &else
            assign v_cod_barra    = ""
                   v_cod_num_bcio = "".
        &endif.    
    end /* if */.

    if  search("prgfin/apb/apb008za.r") = ? and search("prgfin/apb/apb008za.p") = ? then do:
        if  v_cod_dwb_user begins 'es_' then
            return "Programa execut†vel n∆o foi encontrado:" /*l_programa_nao_encontrado*/  + "prgfin/apb/apb008za.p".
        else do:
            message getStrTrans("Programa execut†vel n∆o foi encontrado:", "APB") /*l_programa_nao_encontrado*/  "prgfin/apb/apb008za.p"
                   view-as alert-box error buttons ok.
            return.
        end.
    end.
    else
        run prgfin/apb/apb008za.p (input-output v_cod_barra,
                               input-output v_cod_num_bcio) /*prg_fnc_codigo_barra*/.

    &if '{&emsfin_version}' >= "5.05" &then
        assign antecip_pef_pend.cb4_tit_ap_bco_cobdor = v_cod_barra
               antecip_pef_pend.cod_tit_ap_bco_cobdor = v_cod_num_bcio.
    &endif.
END PROCEDURE. /* pi_choose_bt_cod_barra_antecip */
/*****************************************************************************
** Procedure Interna.....: pi_verificar_iva
** Descricao.............: pi_verificar_iva
** Criado por............: rafael
** Criado em.............: 29/08/1996 15:40:32
** Alterado por..........: fut36242_2
** Alterado em...........: 30/01/2006 10:13:40
*****************************************************************************/
PROCEDURE pi_verificar_iva:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_estab
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def Input param p_dat_transacao
        as date
        format "99/99/9999"
        no-undo.
    def output param p_log_impto_val_agreg
        as logical
        format "Sim/N∆o"
        no-undo.


    /************************* Parameter Definition End *************************/

    assign p_log_impto_val_agreg = no.

    find estabelecimento no-lock
         where estabelecimento.cod_estab = p_cod_estab no-error.

    if  avail estabelecimento
    then do:
        find pessoa_jurid no-lock
             where pessoa_jurid.num_pessoa_jurid = estabelecimento.num_pessoa_jurid no-error.

        verifica_impostos:
        for
            each histor_impto_empres no-lock
            where histor_impto_empres.cod_empresa = estabelecimento.cod_empresa
            and   histor_impto_empres.cod_pais = pessoa_jurid.cod_pais
            and   histor_impto_empres.dat_inic_valid <= p_dat_transacao
            and   histor_impto_empres.dat_fim_valid  >  p_dat_transacao:

            if  histor_impto_empres.cod_unid_federac <> ""
            and histor_impto_empres.cod_unid_federac <> ?
            and histor_impto_empres.cod_unid_federac <> pessoa_jurid.cod_unid_federac
            then do:
                next verifica_impostos.
            end /* if */.

            find first imposto
                where imposto.cod_pais = histor_impto_empres.cod_pais
                and   imposto.cod_unid_federac = histor_impto_empres.cod_unid_federac
                and   imposto.cod_imposto = histor_impto_empres.cod_imposto
                no-lock no-error.

            if  NOT AVAIL imposto THEN
                next verifica_impostos.

            if avail imposto
            and imposto.ind_clas_impto <> "Valor Agregado" /*l_valor_agregado*/ 
            then do:
                next verifica_impostos.
            end /* if */.
            else do:
                assign p_log_impto_val_agreg = yes.
                leave verifica_impostos.
            end /* else */.
        end /* for verifica_impostos */.
    end /* if */.

END PROCEDURE. /* pi_verificar_iva */
/*****************************************************************************
** Procedure Interna.....: pi_verifica_indic_favorec_cheque
** Descricao.............: pi_verifica_indic_favorec_cheque
** Criado por............: fut40574_2
** Criado em.............: 30/11/2006 10:19:12
** Alterado por..........: fut40574_2
** Alterado em...........: 13/06/2007 14:08:24
*****************************************************************************/
PROCEDURE pi_verifica_indic_favorec_cheque:

    do with frame f_adp_02_antecip_pef_pend:
        if  antecip_pef_pend.ind_favorec_cheq:visible       
        and antecip_pef_pend.ind_favorec_cheq:sensitive     
        and not (can-do('Portador,Fornecedor,Transferància,Outros,Cod Fornecedor', input antecip_pef_pend.ind_favorec_cheq)) then do:

            /* Indicador do Favorecido do Cheque inv†lido ! */
            run pi_messages (input "show",
                             input 8655,
                             input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                antecip_pef_pend.cod_portador:screen-value in frame f_adp_02_antecip_pef_pend, "Portador" /*l_portador*/ , "Fornecedor" /*l_fornecedor*/ , "Outros" /*l_outros*/ , '/Cod Fornecedor')) /*msg_8655*/.

            return "NOK" /*l_nok*/ .
        end.
    end.
    return "OK" /*l_ok*/ .
END PROCEDURE. /* pi_verifica_indic_favorec_cheque */
/*****************************************************************************
** Procedure Interna.....: pi_i_exec_program_epc_custom
** Descricao.............: pi_i_exec_program_epc_custom
** Criado por............: its37043_2
** Criado em.............: 28/07/2005 16:41:19
** Alterado por..........: fut12201
** Alterado em...........: 25/08/2005 11:36:53
*****************************************************************************/
PROCEDURE pi_i_exec_program_epc_custom:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_event
        as character
        format "x(100)"
        no-undo.


    /************************* Parameter Definition End *************************/

    /* *******************************************************************************************
    ** Objetivo..............: Substituir o c¢digo gerado pela include i_exec_program_epc_custom,
    **                         muitas vezes repetido, com o intuito de evitar estouro de segmento.
    **
    ** Utilizaá∆o............: A utilizaá∆o desta procedure funciona exatamente como a include
    **                         anteriormente utilizada para este fim, bastando apenas passar como
    **                         parÉmetro o Evento que ser† executado, conforme exemplo:
    **
    **                         RUN pi_i_exec_program_epc_custom(INPUT 'INITIALIZE').
    *********************************************************************************************/

    /* ix_ix1_add_antecip_pef_pend */


    /* Begin_Include: i_exec_program_epc_custom */
    if  v_nom_prog_upc <> '' then
    do:
        run value(v_nom_prog_upc) (input p_cod_event,
                                   input-output table tt_epc).
    end.

    if  v_nom_prog_appc <> '' then
    do:
        run value(v_nom_prog_appc) (input p_cod_event,
                                    input-output table tt_epc).
    end.

    &if '{&emsbas_version}' > '5.00' &then
    if  v_nom_prog_dpc <> '' then
    do:
        run value(v_nom_prog_dpc) (input p_cod_event,
                                    input-output table tt_epc).
    end.
    &endif
    /* End_Include: i_exec_program_epc_custom */


    /* ix_ix2_add_antecip_pef_pend */
END PROCEDURE. /* pi_i_exec_program_epc_custom */
/*****************************************************************************
** Procedure Interna.....: pi_ix_p30_add_antecip_pef_pend_aux
** Descricao.............: pi_ix_p30_add_antecip_pef_pend_aux
** Criado por............: fut31947
** Criado em.............: 29/10/2008 14:27:02
** Alterado por..........: carinah
** Alterado em...........: 22/02/2018 09:39:11
*****************************************************************************/
PROCEDURE pi_ix_p30_add_antecip_pef_pend_aux:

    /************************* Variable Definition Begin ************************/

    def var v_log_aux_epc                    as logical         no-undo. /*local*/


    /************************** Variable Definition End *************************/

    find fornec_financ no-lock
        where fornec_financ.cod_empresa    = antecip_pef_pend.cod_empresa
          and fornec_financ.cdn_fornecedor = antecip_pef_pend.cdn_fornecedor
        no-error.
    atualizar_acum:
    do on error undo atualizar_acum, return error:
        run prgfin/apb/apb012za.py (Input antecip_pef_pend.cod_estab,
                                    Input antecip_pef_pend.cod_refer,
                                    Input 0,
                                    Input "",
                                    Input 0,
                                    Input antecip_pef_pend.dat_emis_docto,
                                    Input antecip_pef_pend.num_pessoa,
                                    Input antecip_pef_pend.cod_indic_econ,
                                    Input antecip_pef_pend.cod_estab,
                                    Input antecip_pef_pend.val_tit_ap) /*prg_fnc_atualiza_acumulados_pessoa*/.
    end.                                         

    if  v_cod_pais_empres_usuar = "BRA" /*l_bra*/ 
    and (antecip_pef_pend.cdn_fornecedor <> 0 and antecip_pef_pend.cdn_fornecedor <> ?) then do:
        find fornecedor no-lock
            where fornecedor.cod_empresa    = v_cod_empres_usuar
              and fornecedor.cdn_fornecedor = antecip_pef_pend.cdn_fornecedor
            no-error.

        assign v_log_aux_epc = no.

        if  v_nom_prog_upc  <> ''    
        or  v_nom_prog_appc <> ''
        or  v_nom_prog_dpc  <> '' then do:

            run pi_limpa_retorno /*pi_limpa_retorno*/.


            /* Begin_Include: i_executa_pi_epc_fin */
            run pi_exec_program_epc_FIN (Input 'banrisul_epc',
                                         Input 'no',
                                         output v_log_return_epc) /*pi_exec_program_epc_FIN*/.
            if v_log_return_epc then /* epc retornou erro*/
                undo, retry.
            /* End_Include: i_executa_pi_epc_fin */


            /* Somente vai entrar se for o banrisul */
            if return-value = 'BRSL' then do:
                assign v_log_aux_epc = yes.
            end.

            run pi_limpa_retorno /*pi_limpa_retorno*/.
        end.

        if v_log_aux_epc = no then
            assign v_log_retenc_impto_pagto = no.
        if v_log_aux_epc = no and v_log_acum_matriz then do:
            if  search("prgfin/apb/apb511za.r") = ? and search("prgfin/apb/apb511za.py") = ? then do:
                if  v_cod_dwb_user begins 'es_' then
                    return "Programa execut†vel n∆o foi encontrado:" /*l_programa_nao_encontrado*/  + "prgfin/apb/apb511za.py".
                else do:
                    message getStrTrans("Programa execut†vel n∆o foi encontrado:", "APB") /*l_programa_nao_encontrado*/  "prgfin/apb/apb511za.py"
                           view-as alert-box error buttons ok.
                    return.
                end.
            end.
            else
                run prgfin/apb/apb511za.py (Input v_cod_empres_usuar,
                                        Input antecip_pef_pend.cdn_fornecedor,
                                        output v_cdn_fornecedor_mat,
                                        output v_log_retenc_impto_pagto_1) /*prg_api_busca_matriz_fornec*/.
            if  v_cdn_fornecedor_mat = antecip_pef_pend.cdn_fornecedor and
                avail fornecedor then do:
                &if '{&emsfin_version}' > '5.05' &then
                if  fornecedor.log_retenc_impto_pagto
                &else
                if (num-entries (fornecedor.cod_livre_1, chr(10)) >= 2 and
                    entry(2, fornecedor.cod_livre_1, chr(10))      = "yes" /*l_yes*/ )
                &endif
                then
                assign v_log_retenc_impto_pagto = yes.
            end.
            else
                assign v_log_retenc_impto_pagto = v_log_retenc_impto_pagto_1.
            if  v_log_retenc_impto_pagto then    
                run prgfin/apb/apb409za.py (Input antecip_pef_pend.cod_estab,
                                            Input antecip_pef_pend.cod_refer,
                                            Input "",
                                            Input 0,
                                            Input 0,
                                            Input antecip_pef_pend.dat_emis_docto,
                                            Input v_cdn_fornecedor_mat,
                                            Input antecip_pef_pend.cod_indic_econ) /*prg_fnc_acum_impto_pagto*/.
        end.
        else do:
            if  avail fornecedor then do:
                &if '{&emsfin_version}' > '5.05' &then
                    if  fornecedor.log_retenc_impto_pagto
                &else
                    if (num-entries (fornecedor.cod_livre_1, chr(10)) >= 2 and
                        entry(2, fornecedor.cod_livre_1, chr(10))      = "yes" /*l_yes*/ )
                &endif
                    then
                run prgfin/apb/apb409za.py (Input antecip_pef_pend.cod_estab,
                                            Input antecip_pef_pend.cod_refer,
                                            Input "",
                                            Input 0,
                                            Input 0,
                                            Input antecip_pef_pend.dat_emis_docto,
                                            Input antecip_pef_pend.cdn_fornecedor,
                                            Input antecip_pef_pend.cod_indic_econ) /*prg_fnc_acum_impto_pagto*/.
            end.                                
        end.
    end.

    assign v_log_portad_cx = no.

    &IF DEFINED(BF_FIN_CONSIST_APF) &THEN
        if (v_log_mod_apf and v_cod_mod <> "" /*l_*/ ) then do:
            run pi_verifica_param_aprov_apf (input  v_cod_empres_usuar,
                                             input  antecip_pef_pend.cod_espec_docto,
                                             input  no,
                                             output v_log_param_apb_apf,
                                             output v_ind_param_aprov_docto,
                                             output v_log_aprov_impl_apf,
                                             output v_log_aprov_pagto_apf).
            if  v_log_param_apb_apf and v_log_aprov_impl_apf then do:
                find first portador no-lock
                     where portador.cod_portador = antecip_pef_pend.cod_portador no-error.
                if avail portador and portador.ind_tip_portad = "Caixa" /*l_caixa*/  then
                    assign v_log_portad_cx = yes.
            end.
        end.
    &ENDIF

    if v_log_portad_cx then do:
        Atualiza_AN:
        do trans on error undo Atualiza_AN , leave :
            run pi_atualiza_antecipacao_apb /*pi_atualiza_antecipacao_apb*/.
        end.
    end.
    else do:
        Atualiza_AN:
        do trans on error undo Atualiza_AN , return error :
            run pi_atualiza_antecipacao_apb /*pi_atualiza_antecipacao_apb*/.
        end.
    end.

    &IF DEFINED(BF_FIN_CONSIST_APF) = 0 &THEN

        /* Begin_Include: i_eliminar_api_centraliza_apb_apf */
        /* Retira o API da Mem¢ria */
        if  valid-handle(v_hdl_api_centraliz_apb_apf)
        then do:
            delete procedure v_hdl_api_centraliz_apb_apf.
            assign v_hdl_api_centraliz_apb_apf = ?.
        end.
        /* End_Include: i_eliminar_api_centraliza_apb_apf */

    &ENDIF

    return "OK" /*l_ok*/ .
END PROCEDURE. /* pi_ix_p30_add_antecip_pef_pend_aux */
/*****************************************************************************
** Procedure Interna.....: pi_vld_antecip_pef_pend_more_aux
** Descricao.............: pi_vld_antecip_pef_pend_more_aux
** Criado por............: fut41675_4
** Criado em.............: 18/01/2010 09:49:24
** Alterado por..........: olbermann
** Alterado em...........: 18/05/2018 13:39:13
*****************************************************************************/
PROCEDURE pi_vld_antecip_pef_pend_more_aux:

    /************************* Variable Definition Begin ************************/

    def var v_cod_esp_docto                  as character       no-undo. /*local*/


    /************************** Variable Definition End *************************/

    if v_log_integr_safra_graos then do:
        &IF '{&emsfin_version}' >= '5.06' AND '{&emsfin_version}' < '5.09' &THEN
        for each tab_livre_emsfin no-lock
            where tab_livre_emsfin.cod_modul_dtsul       = "APB" /*l_apb*/ 
            and   tab_livre_emsfin.cod_tab_dic_dtsul     = 'antecip_pef_pend'
            and   tab_livre_emsfin.cod_compon_2_idx_tab  = antecip_pef_pend.cod_estab + chr(10) + antecip_pef_pend.cod_refer:

            find first b_tab_livre_emsfin exclusive-lock                                                                       
                 where recid(b_tab_livre_emsfin) = recid(tab_livre_emsfin) no-error.
            if avail b_tab_livre_emsfin then 
                delete b_tab_livre_emsfin.
        end.
        create tab_livre_emsfin.
        assign tab_livre_emsfin.cod_modul_dtsul       = "APB" /*l_apb*/  
               tab_livre_emsfin.cod_tab_dic_dtsul     = 'antecip_pef_pend'
               tab_livre_emsfin.cod_compon_1_idx_tab  = string(antecip_pef_pend.cdn_fornecedor) + chr(10) + antecip_pef_pend.cod_livre_2
               tab_livre_emsfin.cod_compon_2_idx_tab  = antecip_pef_pend.cod_estab + chr(10) + antecip_pef_pend.cod_refer.

        release tab_livre_emsfin.      

        &endif
    end.
    &IF '{&emsfin_version}' >= '5.06' &THEN
    if v_log_integr_safra_graos then do:
        for each tt_log_erro exclusive-lock:
            delete tt_log_erro.
        end.
        if v_cod_safra_graos <> "" then do:
            &IF '{&emsfin_version}' >= '5.06' AND '{&emsfin_version}' < '5.09' &THEN
                if search('cdp/cdapi825.r') <> ?
                or search('cdp/cdapi825.p') <> ? then do:
                    run cdp/cdapi825.p (input antecip_pef_pend.cdn_fornecedor,
                                        input antecip_pef_pend.cod_livre_2,
                                        output v_val_limit_credito_safra,
                                        output v_log_liberd_antecip_cr,
                                        output table tt_log_erro).
                end.
            &ENDIF
            &IF '{&emsfin_version}' >= '5.09' &THEN
                if search('cdp/cdapi825.r') <> ?
                or search('cdp/cdapi825.p') <> ? then do:
                    run cdp/cdapi825.p (input antecip_pef_pend.cdn_fornecedor,
                                        input antecip_pef_pend.cod_safra,
                                        output v_val_limit_credito_safra,
                                        output v_log_liberd_antecip_cr,
                                        output table tt_log_erro).
                end.
            &ENDIF

            &if '{&frame_aux}' = "" &then 
                for each tt_log_erro:
                    create tt_log_erros_atualiz.
                    assign tt_log_erros_atualiz.ttv_num_mensagem  = tt_log_erro.ttv_num_cod_erro
                           tt_log_erros_atualiz.ttv_des_msg_erro  = tt_log_erro.ttv_des_msg_erro
                           tt_log_erros_atualiz.ttv_des_msg_ajuda = tt_log_erro.ttv_des_msg_ajuda.
                end.
            &else
                if  can-find(first tt_log_erro no-lock) then do:
                    for each tt_log_erro no-lock:
                        /* &1 ! */
                        run pi_messages (input "show",
                                         input 11717,
                                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                           tt_log_erro.ttv_des_msg_ajuda, tt_log_erro.ttv_des_msg_erro, tt_log_erro.ttv_num_cod_erro)) /*msg_11717*/.
                    end.
                    return error.
                end.
            &endif

            find first tt_log_erro no-lock no-error.
            if not avail tt_log_erro then do:
                if not v_log_liberd_antecip_cr then do:
                    find first cliente no-lock
                        where cliente.cod_empresa = fornecedor.cod_empresa
                        and   cliente.num_pessoa  = fornecedor.num_pessoa no-error.
                    if avail cliente then do:
                        for each empresa no-lock:
                            for each estabelecimento no-lock
                                where estabelecimento.cod_empresa = empresa.cod_empresa:
                                find first tit_acr no-lock
                                    where tit_acr.cod_estab            = estabelecimento.cod_estab
                                    and   tit_acr.cdn_cliente          = cliente.cdn_cliente
                                    and   tit_acr.dat_liquidac_tit_acr = 12/31/9999
                                    and   tit_acr.dat_vencto_tit_acr   < antecip_pef_pend.dat_emis_docto
                                    and   tit_acr.ind_tip_espec_docto  = "Normal" /*l_normal*/  no-error.
                                if avail tit_acr then do:
                                    &if '{&frame_aux}' = "" &then 
                                        create tt_log_erros_atualiz.
                                        assign tt_log_erros_atualiz.ttv_num_mensagem  = 20305
                                               .
                                        assign tt_log_erros_atualiz.ttv_des_msg_erro  = getStrTrans("Existe(m) T°tulo(s) a receber vencido(s) !", "APB") /*20305*/
                                               .
                                        assign tt_log_erros_atualiz.ttv_des_msg_ajuda = getStrTrans("O adiantamento n∆o ser† permitido em funá∆o de que o fornecedor/cliente possui t°tulo(s) vencido(s) no m¢dulo de Contas a Receber", "APB") /*20305*/.
                                    &else
                                        /* Existe(m) T°tulo(s) a receber vencido(s) ! */
                                        run pi_messages (input "show",
                                                         input 20305,
                                                         input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_20305*/.
                                        return error.
                                    &endif
                                end.
                            end.
                        end.
                    end.
                end.
                find estabelecimento no-lock
                    where estabelecimento.cod_empresa = v_cod_empres_usuar
                    and   estabelecimento.log_estab_princ = yes no-error.
                if avail estabelecimento then do:
                    find pais no-lock
                        where pais.cod_pais = estabelecimento.cod_pais no-error.
                    if avail pais then do:
                        run pi_retornar_indic_econ_finalid (input pais.cod_finalid_econ_pais,
                                                            input antecip_pef_pend.dat_emis_docto,
                                                            output v_cod_indic_econ).
                        if v_cod_indic_econ = "" or v_cod_indic_econ = ? then do:
                            &if '{&frame_aux}' = "" &then
                                assign v_num_mensagem   = 19995
                                       v_cod_parameters = string(antecip_pef_pend.cod_estab) + ","  + string(antecip_pef_pend.dat_emis_docto).
                                run pi_integr_apb_cria_msg_erro (Input 'antecip_pef_pend':U + "." + 'cod_estab',
                                                                 Input antecip_pef_pend.cod_estab,
                                                                 Input antecip_pef_pend.cod_refer,
                                                                 Input 0,
                                                                 Input "",
                                                                 Input 0,
                                                                 Input v_num_mensagem,
                                                                 Input v_cod_parameters) /* pi_integr_apb_cria_msg_erro*/.
                            &else
                                /* Moeda corrente do estabelecimento n∆o encontrada ! */
                                run pi_messages (input "show",
                                                 input 19995,
                                                 input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                                   string(antecip_pef_pend.cod_estab), string (antecip_pef_pend.dat_emis_docto))) /*msg_19995*/.
                                return error.
                            &endif
                        end.
                        run ggp/ggapi106.p persistent set v_hdl_api_graos.
                        run piRetornaEspDesconsiderar in v_hdl_api_graos (output v_cod_esp_docto).
                        run piRetornaMatrizEmit in v_hdl_api_graos (input antecip_pef_pend.cdn_fornecedor,
                                                                    output table tt_emitente).
                        delete procedure v_hdl_api_graos.                                                                
                        assign v_val_pagto = 0.
                        if antecip_pef_pend.cod_indic_econ <> v_cod_indic_econ then do:
                            run pi_converter_indic_econ_finalid (Input antecip_pef_pend.cod_indic_econ,
                                                                 Input v_cod_empres_usuar,
                                                                 Input antecip_pef_pend.dat_emis_docto,
                                                                 Input antecip_pef_pend.val_tit_ap,
                                                                 Input pais.cod_finalid_econ_pais,
                                                                 output v_cod_return) /* pi_converter_indic_econ_finalid*/.
                            if  v_cod_return = "OK" /*l_ok*/  or v_cod_return = "" then do:
                                find first tt_converter_finalid_econ no-lock no-error.
                                assign v_val_pagto = v_val_pagto + tt_converter_finalid_econ.tta_val_transacao.
                            end.
                            else do:

                                /* Begin_Include: i_pi_vld_antecip_pef_pend_more_aux_1 */
                                &if '{&frame_aux}' = "" &then
                                    /* case_block: */
                                    case GetEntryField(1, v_cod_return,chr(10)):
                                        when "782" then do:
                                            assign v_num_mensagem   = 782
                                                   v_cod_parameters = "".
                                            run pi_integr_apb_cria_msg_erro (Input 'antecip_pef_pend':U + "." + 'cod_estab',
                                                                             Input antecip_pef_pend.cod_estab,
                                                                             Input antecip_pef_pend.cod_refer,
                                                                             Input 0,
                                                                             Input "",
                                                                             Input 0,
                                                                             Input v_num_mensagem,
                                                                             Input v_cod_parameters) /* pi_integr_apb_cria_msg_erro*/.
                                        end.
                                        when "1389" then do:
                                            assign v_num_mensagem   = 1389
                                                   v_cod_parameters = string(GetEntryField(2, v_cod_return,chr(10))).
                                            run pi_integr_apb_cria_msg_erro (Input 'antecip_pef_pend':U + "." + 'cod_estab',
                                                                             Input antecip_pef_pend.cod_estab,
                                                                             Input antecip_pef_pend.cod_refer,
                                                                             Input 0,
                                                                             Input "",
                                                                             Input 0,
                                                                             Input v_num_mensagem,
                                                                             Input v_cod_parameters) /* pi_integr_apb_cria_msg_erro*/.
                                        end.
                                        when "338" then do: 
                                            assign v_num_mensagem   = 338
                                                   v_cod_parameters = "".
                                            run pi_integr_apb_cria_msg_erro (Input 'antecip_pef_pend':U + "." + 'cod_estab',
                                                                             Input antecip_pef_pend.cod_estab,
                                                                             Input antecip_pef_pend.cod_refer,
                                                                             Input 0,
                                                                             Input "",
                                                                             Input 0,
                                                                             Input v_num_mensagem,
                                                                             Input v_cod_parameters) /* pi_integr_apb_cria_msg_erro*/.
                                        end.
                                        when "358" then do:
                                            assign v_num_mensagem   = 358
                                                   v_cod_parameters = string(GetEntryField(2,v_cod_return,chr(10))) + ","  + string(GetEntryField(3,v_cod_return,chr(10))) + ","  + string(GetEntryField(4,v_cod_return,chr(10))) + ","  + "Real" /*l_real*/ .
                                            run pi_integr_apb_cria_msg_erro (Input 'antecip_pef_pend':U + "." + 'cod_estab',
                                                                             Input antecip_pef_pend.cod_estab,
                                                                             Input antecip_pef_pend.cod_refer,
                                                                             Input 0,
                                                                             Input "",
                                                                             Input 0,
                                                                             Input v_num_mensagem,
                                                                             Input v_cod_parameters) /* pi_integr_apb_cria_msg_erro*/.
                                        end.
                                        when "1200" then do:
                                            assign v_num_mensagem   = 1200
                                                   v_cod_parameters = string(GetEntryField(2,v_cod_return,chr(10))) + "," + string(GetEntryField(3,v_cod_return,chr(10))) + "," + string(GetEntryField(4,v_cod_return,chr(10))) + "," + string(GetEntryField(5,v_cod_return,chr(10))) + "," + string(GetEntryField(6,v_cod_return,chr(10))) + "," + string(GetEntryField(7,v_cod_return,chr(10))) + "," + "Finalidade" /*l_finalidade*/  + "," + "In°cio Validade" /*l_inicio_validade*/  + "," + "Fim Validade" /*l_fim_validade*/ .
                                            run pi_integr_apb_cria_msg_erro (Input 'antecip_pef_pend':U + "." + 'cod_estab',
                                                                             Input antecip_pef_pend.cod_estab,
                                                                             Input antecip_pef_pend.cod_refer,
                                                                             Input 0,
                                                                             Input "",
                                                                             Input 0,
                                                                             Input v_num_mensagem,
                                                                             Input v_cod_parameters) /* pi_integr_apb_cria_msg_erro*/.
                                        end.
                                    end /* case case_block */.
                                &else
                                    /* case_block: */
                                    case GetEntryField(1, v_cod_return,chr(10)):
                                        when "782" then
                                            /* Finalidade econìmica n∆o relacionada para o Indic Econìmico ! */
                                            run pi_messages (input "show",
                                                             input 782,
                                                             input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_782*/.
                                        when "1389" then
                                            /* Finalidade Econìmica n∆o armazena valores no M¢dulo ! */
                                            run pi_messages (input "show",
                                                             input 1389,
                                                             input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                                                GetEntryField(2, v_cod_return,chr(10)))) /*msg_1389*/.
                                        when "338" then
                                            /* Finalidade n∆o liberada para a Unidade Organizacional ! */
                                            run pi_messages (input "show",
                                                             input 338,
                                                             input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_338*/.
                                        when "358" then
                                            /* Cotaá∆o entre Indicadores Econìmicos n∆o encontrada ! */
                                            run pi_messages (input "show",
                                                             input 358,
                                                             input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                                                GetEntryField(2,v_cod_return,chr(10)), GetEntryField(3, v_cod_return,chr(10)), GetEntryField(4, v_cod_return,chr(10)), "Real" /*l_real*/)) /*msg_358*/.
                                        when "1200" then
                                            /* ParÉmetros de convers∆o da composiá∆o inexistentes ! */
                                            run pi_messages (input "show",
                                                             input 1200,
                                                             input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                                               GetEntryField(2, v_cod_return,chr(10)), GetEntryField(3, v_cod_return,chr(10)), GetEntryField(4, v_cod_return,chr(10)), GetEntryField(5, v_cod_return,chr(10)), GetEntryField(6, v_cod_return,chr(10)), GetEntryField(7, v_cod_return,chr(10)), "Finalidade" /*l_finalidade*/ , "In°cio Validade" /*l_inicio_validade*/ , "Fim Validade" /*l_fim_validade*/)) /*msg_1200*/.
                                    end /* case case_block */.
                                    return error.
                                &endif
                                /* End_Include: i_pi_vld_antecip_pef_pend_more_aux_1 */

                            end.
                        end.
                        else do:
                            assign v_val_pagto = v_val_pagto + antecip_pef_pend.val_tit_ap.
                        end.
                        for each tt_emitente no-lock:
                            &IF '{&emsfin_version}' >= '5.06' AND '{&emsfin_version}' < '5.09' &THEN
                            for each tab_livre_emsfin no-lock
                                where tab_livre_emsfin.cod_modul_dtsul      = "APB" /*l_apb*/  
                                and   tab_livre_emsfin.cod_tab_dic_dtsul    = 'antecip_pef_pend'
                                and   tab_livre_emsfin.cod_compon_1_idx_tab = string(tt_emitente.tta_cdn_emit) + chr(10) + antecip_pef_pend.cod_livre_2:
                                find first b_antecip_pef_pend no-lock
                                    where b_antecip_pef_pend.cod_estab = entry(1,tab_livre_emsfin.cod_compon_2_idx_tab,chr(10))
                                    and   b_antecip_pef_pend.cod_refer = entry(2,tab_livre_emsfin.cod_compon_2_idx_tab,chr(10))
                                    and  (b_antecip_pef_pend.ind_sit_pef_antecip = "Pend" /*l_pendente*/  or 
                                          b_antecip_pef_pend.ind_sit_pef_antecip = "Em Pagamento" /*l_em_pagamento*/ ) 
                                    and   b_antecip_pef_pend.cod_espec_docto <> v_cod_esp_docto no-error.
                                if not avail b_antecip_pef_pend then
                                    next.
                            &ENDIF
                            &IF '{&emsfin_version}' >= '5.09' &THEN
                            for each b_antecip_pef_pend no-lock
                                where b_antecip_pef_pend.cdn_fornecedor = tt_emitente.tta_cdn_emit
                                and   b_antecip_pef_pend.cod_safra      = antecip_pef_pend.cod_safra
                                and  (b_antecip_pef_pend.ind_sit_pef_antecip = "Pend" /*l_pendente*/  or 
                                      b_antecip_pef_pend.ind_sit_pef_antecip = "Em Pagamento" /*l_em_pagamento*/ )
                                and   b_antecip_pef_pend.cod_espec_docto <> v_cod_esp_docto:
                            &ENDIF
                                if b_antecip_pef_pend.cod_indic_econ <> v_cod_indic_econ then do:
                                    run pi_converter_indic_econ_finalid (Input b_antecip_pef_pend.cod_indic_econ,
                                                                         Input v_cod_empres_usuar,
                                                                         Input b_antecip_pef_pend.dat_emis_docto,
                                                                         Input b_antecip_pef_pend.val_tit_ap,
                                                                         Input pais.cod_finalid_econ_pais,
                                                                         output v_cod_return) /* pi_converter_indic_econ_finalid*/.
                                    if  v_cod_return = "OK" /*l_ok*/  or v_cod_return = "" then do:
                                        find first tt_converter_finalid_econ no-lock no-error.
                                        assign v_val_pagto = v_val_pagto + tt_converter_finalid_econ.tta_val_transacao.
                                    end.
                                    else do:

                                        /* Begin_Include: i_pi_vld_antecip_pef_pend_more_aux */
                                        &if '{&frame_aux}' = "" &then
                                            /* case_block: */
                                            case GetEntryField(1, v_cod_return,chr(10)):
                                                when "782" then do:
                                                    assign v_num_mensagem   = 782
                                                           v_cod_parameters = "".
                                                    run pi_integr_apb_cria_msg_erro (Input 'antecip_pef_pend':U + "." + 'cod_estab',
                                                                                     Input b_antecip_pef_pend.cod_estab,
                                                                                     Input b_antecip_pef_pend.cod_refer,
                                                                                     Input 0,
                                                                                     Input "",
                                                                                     Input 0,
                                                                                     Input v_num_mensagem,
                                                                                     Input v_cod_parameters) /* pi_integr_apb_cria_msg_erro*/.
                                                end.
                                                when "1389" then do:
                                                    assign v_num_mensagem   = 1389
                                                           v_cod_parameters = string(GetEntryField(2, v_cod_return,chr(10))).
                                                    run pi_integr_apb_cria_msg_erro (Input 'antecip_pef_pend':U + "." + 'cod_estab',
                                                                                     Input b_antecip_pef_pend.cod_estab,
                                                                                     Input b_antecip_pef_pend.cod_refer,
                                                                                     Input 0,
                                                                                     Input "",
                                                                                     Input 0,
                                                                                     Input v_num_mensagem,
                                                                                     Input v_cod_parameters) /* pi_integr_apb_cria_msg_erro*/.
                                                end.
                                                when "338" then do: 
                                                    assign v_num_mensagem   = 338
                                                           v_cod_parameters = "".
                                                    run pi_integr_apb_cria_msg_erro (Input 'antecip_pef_pend':U + "." + 'cod_estab',
                                                                                     Input b_antecip_pef_pend.cod_estab,
                                                                                     Input b_antecip_pef_pend.cod_refer,
                                                                                     Input 0,
                                                                                     Input "",
                                                                                     Input 0,
                                                                                     Input v_num_mensagem,
                                                                                     Input v_cod_parameters) /* pi_integr_apb_cria_msg_erro*/.
                                                end.
                                                when "358" then do:
                                                    assign v_num_mensagem   = 358
                                                           v_cod_parameters = string(GetEntryField(2,v_cod_return,chr(10))) + ","  + string(GetEntryField(3,v_cod_return,chr(10))) + ","  + string(GetEntryField(4,v_cod_return,chr(10))) + ","  + "Real" /*l_real*/ .
                                                    run pi_integr_apb_cria_msg_erro (Input 'antecip_pef_pend':U + "." + 'cod_estab',
                                                                                     Input b_antecip_pef_pend.cod_estab,
                                                                                     Input b_antecip_pef_pend.cod_refer,
                                                                                     Input 0,
                                                                                     Input "",
                                                                                     Input 0,
                                                                                     Input v_num_mensagem,
                                                                                     Input v_cod_parameters) /* pi_integr_apb_cria_msg_erro*/.
                                                end.
                                                when "1200" then do:
                                                    assign v_num_mensagem   = 1200
                                                           v_cod_parameters = string(GetEntryField(2,v_cod_return,chr(10))) + "," + string(GetEntryField(3,v_cod_return,chr(10))) + "," + string(GetEntryField(4,v_cod_return,chr(10))) + "," + string(GetEntryField(5,v_cod_return,chr(10))) + "," + string(GetEntryField(6,v_cod_return,chr(10))) + "," + string(GetEntryField(7,v_cod_return,chr(10))) + "," + "Finalidade" /*l_finalidade*/  + "," + "In°cio Validade" /*l_inicio_validade*/  + "," + "Fim Validade" /*l_fim_validade*/ .
                                                    run pi_integr_apb_cria_msg_erro (Input 'antecip_pef_pend':U + "." + 'cod_estab',
                                                                                     Input b_antecip_pef_pend.cod_estab,
                                                                                     Input b_antecip_pef_pend.cod_refer,
                                                                                     Input 0,
                                                                                     Input "",
                                                                                     Input 0,
                                                                                     Input v_num_mensagem,
                                                                                     Input v_cod_parameters) /* pi_integr_apb_cria_msg_erro*/.
                                                end.
                                            end /* case case_block */.
                                        &else
                                            /* case_block: */
                                            case GetEntryField(1, v_cod_return,chr(10)):
                                                when "782" then
                                                    /* Finalidade econìmica n∆o relacionada para o Indic Econìmico ! */
                                                    run pi_messages (input "show",
                                                                     input 782,
                                                                     input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_782*/.
                                                when "1389" then
                                                    /* Finalidade Econìmica n∆o armazena valores no M¢dulo ! */
                                                    run pi_messages (input "show",
                                                                     input 1389,
                                                                     input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                                                        GetEntryField(2, v_cod_return,chr(10)))) /*msg_1389*/.
                                                when "338" then
                                                    /* Finalidade n∆o liberada para a Unidade Organizacional ! */
                                                    run pi_messages (input "show",
                                                                     input 338,
                                                                     input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_338*/.
                                                when "358" then
                                                    /* Cotaá∆o entre Indicadores Econìmicos n∆o encontrada ! */
                                                    run pi_messages (input "show",
                                                                     input 358,
                                                                     input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                                                        GetEntryField(2,v_cod_return,chr(10)), GetEntryField(3, v_cod_return,chr(10)), GetEntryField(4, v_cod_return,chr(10)), "Real" /*l_real*/)) /*msg_358*/.
                                                when "1200" then
                                                    /* ParÉmetros de convers∆o da composiá∆o inexistentes ! */
                                                    run pi_messages (input "show",
                                                                     input 1200,
                                                                     input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                                                       GetEntryField(2, v_cod_return,chr(10)), GetEntryField(3, v_cod_return,chr(10)), GetEntryField(4, v_cod_return,chr(10)), GetEntryField(5, v_cod_return,chr(10)), GetEntryField(6, v_cod_return,chr(10)), GetEntryField(7, v_cod_return,chr(10)), "Finalidade" /*l_finalidade*/ , "In°cio Validade" /*l_inicio_validade*/ , "Fim Validade" /*l_fim_validade*/)) /*msg_1200*/.
                                            end /* case case_block */.
                                            return error.
                                        &endif
                                        /* End_Include: i_pi_vld_antecip_pef_pend_more_aux */

                                    end.
                                end.
                                else do:
                                    assign v_val_pagto = v_val_pagto + b_antecip_pef_pend.val_tit_ap.
                                end.
                            end.
                            assign v_val_orig_tit_ap = 0.
                            &IF '{&emsfin_version}' >= '5.06' AND '{&emsfin_version}' < '5.09' &THEN
                            for each b_tab_livre_emsfin no-lock
                                where b_tab_livre_emsfin.cod_modul_dtsul      = "APB" /*l_apb*/ 
                                and   b_tab_livre_emsfin.cod_tab_dic_dtsul    = 'tit_ap'
                                and   b_tab_livre_emsfin.cod_compon_1_idx_tab = string(tt_emitente.tta_cdn_emit) + chr(10) + antecip_pef_pend.cod_livre_2 + chr(10) + "Antecipaá∆o" /*l_antecipacao*/ :
                                find first tit_ap no-lock
                                    where tit_ap.cod_estab     = entry(1,b_tab_livre_emsfin.cod_compon_2_idx_tab,chr(10))
                                    and   tit_ap.num_id_tit_ap = int(entry(2,b_tab_livre_emsfin.cod_compon_2_idx_tab,chr(10)))
                                    and   tit_ap.ind_tip_espec_docto = "Antecipaá∆o" /*l_antecipacao*/ 
                                    and   tit_ap.log_tit_ap_estordo  = no no-error.
                                if not avail tit_ap then
                                    next.
                            &ENDIF
                            &IF '{&emsfin_version}' >= '5.09' &THEN
                            for each tit_ap no-lock
                                where tit_ap.cdn_fornecedor      = antecip_pef_pend.cdn_fornecedor
                                and   tit_ap.cod_safra           = antecip_pef_pend.cod_safra
                                and   tit_ap.ind_tip_espec_docto = "Antecipaá∆o" /*l_antecipacao*/ 
                                and   tit_ap.log_tit_ap_estordo  = no:
                            &ENDIF

                                assign v_val_orig_tit_ap = tit_ap.val_origin_tit_ap.

                                for each movto_tit_ap no-lock
                                    where movto_tit_ap.cod_estab          = tit_ap.cod_estab
                                    and   movto_tit_ap.num_id_tit_ap      = tit_ap.num_id_tit_ap
                                    and   movto_tit_ap.ind_trans_ap_abrev = "AVMN" /*l_avmn*/ :
                                    assign v_val_orig_tit_ap = v_val_orig_tit_ap - movto_tit_ap.val_movto_ap.
                                end.
                                if tit_ap.cod_indic_econ <> v_cod_indic_econ then do:
                                    run pi_converter_indic_econ_finalid (Input tit_ap.cod_indic_econ,
                                                                         Input v_cod_empres_usuar,
                                                                         Input tit_ap.dat_emis_docto,
                                                                         Input v_val_orig_tit_ap,
                                                                         Input pais.cod_finalid_econ_pais,
                                                                         output v_cod_return) /* pi_converter_indic_econ_finalid*/.
                                    if  v_cod_return = "OK" /*l_ok*/  or v_cod_return = "" then do:
                                        find first tt_converter_finalid_econ no-lock no-error.
                                        assign v_val_pagto = v_val_pagto + tt_converter_finalid_econ.tta_val_transacao.
                                    end.
                                    else do:

                                        /* Begin_Include: i_pi_vld_antecip_pef_pend_more_aux_1 */
                                        &if '{&frame_aux}' = "" &then
                                            /* case_block: */
                                            case GetEntryField(1, v_cod_return,chr(10)):
                                                when "782" then do:
                                                    assign v_num_mensagem   = 782
                                                           v_cod_parameters = "".
                                                    run pi_integr_apb_cria_msg_erro (Input 'antecip_pef_pend':U + "." + 'cod_estab',
                                                                                     Input antecip_pef_pend.cod_estab,
                                                                                     Input antecip_pef_pend.cod_refer,
                                                                                     Input 0,
                                                                                     Input "",
                                                                                     Input 0,
                                                                                     Input v_num_mensagem,
                                                                                     Input v_cod_parameters) /* pi_integr_apb_cria_msg_erro*/.
                                                end.
                                                when "1389" then do:
                                                    assign v_num_mensagem   = 1389
                                                           v_cod_parameters = string(GetEntryField(2, v_cod_return,chr(10))).
                                                    run pi_integr_apb_cria_msg_erro (Input 'antecip_pef_pend':U + "." + 'cod_estab',
                                                                                     Input antecip_pef_pend.cod_estab,
                                                                                     Input antecip_pef_pend.cod_refer,
                                                                                     Input 0,
                                                                                     Input "",
                                                                                     Input 0,
                                                                                     Input v_num_mensagem,
                                                                                     Input v_cod_parameters) /* pi_integr_apb_cria_msg_erro*/.
                                                end.
                                                when "338" then do: 
                                                    assign v_num_mensagem   = 338
                                                           v_cod_parameters = "".
                                                    run pi_integr_apb_cria_msg_erro (Input 'antecip_pef_pend':U + "." + 'cod_estab',
                                                                                     Input antecip_pef_pend.cod_estab,
                                                                                     Input antecip_pef_pend.cod_refer,
                                                                                     Input 0,
                                                                                     Input "",
                                                                                     Input 0,
                                                                                     Input v_num_mensagem,
                                                                                     Input v_cod_parameters) /* pi_integr_apb_cria_msg_erro*/.
                                                end.
                                                when "358" then do:
                                                    assign v_num_mensagem   = 358
                                                           v_cod_parameters = string(GetEntryField(2,v_cod_return,chr(10))) + ","  + string(GetEntryField(3,v_cod_return,chr(10))) + ","  + string(GetEntryField(4,v_cod_return,chr(10))) + ","  + "Real" /*l_real*/ .
                                                    run pi_integr_apb_cria_msg_erro (Input 'antecip_pef_pend':U + "." + 'cod_estab',
                                                                                     Input antecip_pef_pend.cod_estab,
                                                                                     Input antecip_pef_pend.cod_refer,
                                                                                     Input 0,
                                                                                     Input "",
                                                                                     Input 0,
                                                                                     Input v_num_mensagem,
                                                                                     Input v_cod_parameters) /* pi_integr_apb_cria_msg_erro*/.
                                                end.
                                                when "1200" then do:
                                                    assign v_num_mensagem   = 1200
                                                           v_cod_parameters = string(GetEntryField(2,v_cod_return,chr(10))) + "," + string(GetEntryField(3,v_cod_return,chr(10))) + "," + string(GetEntryField(4,v_cod_return,chr(10))) + "," + string(GetEntryField(5,v_cod_return,chr(10))) + "," + string(GetEntryField(6,v_cod_return,chr(10))) + "," + string(GetEntryField(7,v_cod_return,chr(10))) + "," + "Finalidade" /*l_finalidade*/  + "," + "In°cio Validade" /*l_inicio_validade*/  + "," + "Fim Validade" /*l_fim_validade*/ .
                                                    run pi_integr_apb_cria_msg_erro (Input 'antecip_pef_pend':U + "." + 'cod_estab',
                                                                                     Input antecip_pef_pend.cod_estab,
                                                                                     Input antecip_pef_pend.cod_refer,
                                                                                     Input 0,
                                                                                     Input "",
                                                                                     Input 0,
                                                                                     Input v_num_mensagem,
                                                                                     Input v_cod_parameters) /* pi_integr_apb_cria_msg_erro*/.
                                                end.
                                            end /* case case_block */.
                                        &else
                                            /* case_block: */
                                            case GetEntryField(1, v_cod_return,chr(10)):
                                                when "782" then
                                                    /* Finalidade econìmica n∆o relacionada para o Indic Econìmico ! */
                                                    run pi_messages (input "show",
                                                                     input 782,
                                                                     input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_782*/.
                                                when "1389" then
                                                    /* Finalidade Econìmica n∆o armazena valores no M¢dulo ! */
                                                    run pi_messages (input "show",
                                                                     input 1389,
                                                                     input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                                                        GetEntryField(2, v_cod_return,chr(10)))) /*msg_1389*/.
                                                when "338" then
                                                    /* Finalidade n∆o liberada para a Unidade Organizacional ! */
                                                    run pi_messages (input "show",
                                                                     input 338,
                                                                     input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_338*/.
                                                when "358" then
                                                    /* Cotaá∆o entre Indicadores Econìmicos n∆o encontrada ! */
                                                    run pi_messages (input "show",
                                                                     input 358,
                                                                     input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                                                        GetEntryField(2,v_cod_return,chr(10)), GetEntryField(3, v_cod_return,chr(10)), GetEntryField(4, v_cod_return,chr(10)), "Real" /*l_real*/)) /*msg_358*/.
                                                when "1200" then
                                                    /* ParÉmetros de convers∆o da composiá∆o inexistentes ! */
                                                    run pi_messages (input "show",
                                                                     input 1200,
                                                                     input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                                                       GetEntryField(2, v_cod_return,chr(10)), GetEntryField(3, v_cod_return,chr(10)), GetEntryField(4, v_cod_return,chr(10)), GetEntryField(5, v_cod_return,chr(10)), GetEntryField(6, v_cod_return,chr(10)), GetEntryField(7, v_cod_return,chr(10)), "Finalidade" /*l_finalidade*/ , "In°cio Validade" /*l_inicio_validade*/ , "Fim Validade" /*l_fim_validade*/)) /*msg_1200*/.
                                            end /* case case_block */.
                                            return error.
                                        &endif
                                        /* End_Include: i_pi_vld_antecip_pef_pend_more_aux_1 */

                                    end.
                                end.
                                else assign v_val_pagto = v_val_pagto + v_val_orig_tit_ap.
                            end.
                        end.
                        if v_val_pagto > v_val_limit_credito_safra then do:
                            &if '{&frame_aux}' = "" &then 
                                create tt_log_erros_atualiz.
                                assign tt_log_erros_atualiz.ttv_num_mensagem  = 20306
                                       .
                                assign tt_log_erros_atualiz.ttv_des_msg_erro  = getStrTrans("Total de adiantamentos excede ao limite da safra !", "APB") /*20306*/
                                       .
                                assign tt_log_erros_atualiz.ttv_des_msg_ajuda = getStrTrans("O adiantamento correspondente aos dados selecionados n∆o ser† permitido em funá∆o de que o limite est† totalmente tomado. Favor avaliar o valor informado para o adiantamento ou o limite determinado para a safra no m¢dulo de gr∆os.", "APB") /*20306*/.
                            &else
                                /* Total de adiantamentos excede ao limite da safra ! */
                                run pi_messages (input "show",
                                                 input 20306,
                                                 input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_20306*/.
                                return error.
                            &endif
                        end.
                    end.
                end.
            end.
        end.
    end.
    &ENDIF
END PROCEDURE. /* pi_vld_antecip_pef_pend_more_aux */
/*****************************************************************************
** Procedure Interna.....: pi_retorna_sugestao_referencia_epc
** Descricao.............: pi_retorna_sugestao_referencia_epc
** Criado por............: fut43117
** Criado em.............: 11/04/2011 15:06:11
** Alterado por..........: fut43117
** Alterado em...........: 11/04/2011 15:15:07
*****************************************************************************/
PROCEDURE pi_retorna_sugestao_referencia_epc:

    /************************ Parameter Definition Begin ************************/

    def Input param p_ind_tip_atualiz
        as character
        format "X(08)"
        no-undo.
    def Input param p_dat_refer
        as date
        format "99/99/9999"
        no-undo.
    def output param p_cod_refer
        as character
        format "x(10)"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_des_dat                        as character       no-undo. /*local*/
    def var v_num_aux                        as integer         no-undo. /*local*/
    def var v_num_aux_2                      as integer         no-undo. /*local*/
    def var v_num_cont                       as integer         no-undo. /*local*/
    def var v_num_resultado                  as integer         no-undo. /*local*/
    def var v_num_tamanho                    as integer         no-undo. /*local*/


    /************************** Variable Definition End *************************/

    do v_num_tamanho = 1 to length(v_cod_usuar_corren):
       assign v_num_resultado = v_num_resultado + asc(substring(v_cod_usuar_corren, v_num_tamanho, 1)).
    end.

    assign v_des_dat   = string(p_dat_refer,"99999999")
           p_cod_refer = substring(v_des_dat,7,2)
                       + substring(v_des_dat,3,2)
                       + substring(v_des_dat,1,2)
                       + substring(p_ind_tip_atualiz,1,1)
           v_num_aux_2 = integer(this-procedure:handle) + integer(today) + time + v_num_resultado.

    do  v_num_cont = 1 to 4:
        assign v_num_aux   = (random(0,v_num_aux_2) mod 26) + 97
               p_cod_refer = p_cod_refer + chr(v_num_aux).
    end.
END PROCEDURE. /* pi_retorna_sugestao_referencia_epc */
/*****************************************************************************
** Procedure Interna.....: pi_limpa_retorno
** Descricao.............: pi_limpa_retorno
** Criado por............: bre18015
** Criado em.............: 22/01/2001 17:54:29
** Alterado por..........: bre18015
** Alterado em...........: 22/01/2001 17:55:22
*****************************************************************************/
PROCEDURE pi_limpa_retorno:

    return ''.
END PROCEDURE. /* pi_limpa_retorno */
/*****************************************************************************
** Procedure Interna.....: pi_retorna_empresa_ems2
** Descricao.............: pi_retorna_empresa_ems2
** Criado por............: fut41675
** Criado em.............: 22/02/2011 08:52:18
** Alterado por..........: fut41675
** Alterado em...........: 22/02/2011 09:04:45
*****************************************************************************/
PROCEDURE pi_retorna_empresa_ems2:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_empres_usuar
        as character
        format "x(3)"
        no-undo.
    def Input param p_cod_matriz_trad_org
        as character
        format "x(8)"
        no-undo.
    def output param p_cod_empres_ems_2
        as character
        format "x(3)"
        no-undo.


    /************************* Parameter Definition End *************************/

    assign p_cod_empres_ems_2 = "".
    find first trad_org_ext
         where trad_org_ext.cod_matriz_trad_org_ext = p_cod_matriz_trad_org
           and trad_org_ext.cod_tip_unid_organ      = '998'
           and trad_org_ext.cod_unid_organ          = p_cod_empres_usuar no-lock no-error.
    if avail trad_org_ext then do:
        assign p_cod_empres_ems_2 = trad_org_ext.cod_unid_organ_ext.
    end.
END PROCEDURE. /* pi_retorna_empresa_ems2 */
/*****************************************************************************
** Procedure Interna.....: pi_conecta_base_ems2
** Descricao.............: pi_conecta_base_ems2
** Criado por............: src388
** Criado em.............: 19/03/2002 10:54:36
** Alterado por..........: fut36015_2
** Alterado em...........: 12/02/2008 11:11:36
*****************************************************************************/
PROCEDURE pi_conecta_base_ems2:

    /************************ Parameter Definition Begin ************************/

    def Input param p_num_opc
        as integer
        format ">>>>,>>9"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_hdl_btb_connect                as handle          no-undo. /*local*/
    def var v_log_sucesso                    as logical         no-undo. /*local*/


    /************************** Variable Definition End *************************/

    /* Ateracao sobre demanda - A partir da 5.07 o banco do EMS2 sempre estara conectado */

    assign v_log_connect_ems2_ok = YES.


    if not valid-handle(v_hdl_btb_connect) then 
        if  search("prgtec/btb/btb009za.r") = ? and search("prgtec/btb/btb009za.py") = ? then do:
            if  v_cod_dwb_user begins 'es_' then
                return "Programa execut†vel n∆o foi encontrado:" /*l_programa_nao_encontrado*/  + "prgtec/btb/btb009za.py".
            else do:
                message getStrTrans("Programa execut†vel n∆o foi encontrado:", "APB") /*l_programa_nao_encontrado*/  "prgtec/btb/btb009za.py"
                       view-as alert-box error buttons ok.
                return.
            end.
        end.
        else
            run prgtec/btb/btb009za.py persistent set v_hdl_btb_connect (Input 1,
                                    Input 1,
                                    Input "",
                                    Input "",
                                    output v_log_sucesso,
                                    output table tt_erros_conexao) /*prg_fnc_bco_ext*/.

    if  valid-handle(v_hdl_btb_connect)
    then do:
        &IF integer(entry(1,proversion,".")) >= 9 &THEN
            empty temp-table tt_erros_conexao no-error.
        &ELSE
            for each tt_erros_conexao:
                delete tt_erros_conexao.
            end.
        &ENDIF

        run pi_conecta_persistent in v_hdl_btb_connect (input 1,
                                                        input p_num_opc, /* 1- Conecta  2- Desconecta */
                                                        input v_cod_empres_usuar,
                                                        input "all" /*l_all_2*/ ,
                                                        output v_log_sucesso,
                                                        output table tt_erros_conexao).
    end /* if */.

    if valid-handle(v_hdl_btb_connect) then
        delete procedure v_hdl_btb_connect.

    if  can-find(first tt_erros_conexao)
    then do:
        find first tt_erros_conexao no-error.
            /* ** Indica que a base j† est† conectada ***/
            if  tt_erros_conexao.ttv_cdn_erro = 9588 or 
                tt_erros_conexao.ttv_cdn_erro = 9597 then do:
                if p_num_opc = 1 then
                assign v_log_connect_ems2_ok = yes.
                delete tt_erros_conexao.
                return "NOK" /*l_nok*/ .    
            end.
            else do:
                /* Problemas com a conex∆o de bases do EMS 2 ! */
                run pi_messages (input "show",
                                 input 11476,
                                 input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                   tt_erros_conexao.ttv_cdn_erro,tt_erros_conexao.ttv_des_erro)) /*msg_11476*/.
                return no-apply.
            end.
    end /* if */.

    if p_num_opc = 1 then
        assign v_log_connect_ems2_ok = yes.
END PROCEDURE. /* pi_conecta_base_ems2 */
/*****************************************************************************
** Procedure Interna.....: pi_elimina_docum_est_esoc_impl_antecip
** Descricao.............: pi_elimina_docum_est_esoc_impl_antecip
** Criado por............: fut41675_2
** Criado em.............: 05/02/2014 17:56:23
** Alterado por..........: fut41675_2
** Alterado em...........: 09/04/2014 13:33:49
*****************************************************************************/
PROCEDURE pi_elimina_docum_est_esoc_impl_antecip:

    if v_log_legal_sem_integr = yes then do:
        /* TRATAMENTO ESOCIAL 5.06*/
        /*if v_cdd_num_docto_esoc_aux <> 0 then do:
            run pi_delete_esocial (input v_cdd_num_docto_esoc_aux).
        end.*/
    end.
    else do:
        /* salva a empresa do ems5 para voltar depois da integraá∆o*/
        assign v_cod_empresa_aux = v_cod_empres_usuar.

        /* salva o pais do ems5 para voltar depois da integraá∆o*/
        assign v_cod_pais_empres_usuar_ant = v_cod_pais_empres_usuar.

        if v-nro-docto-esoc <> 0 then do:
            /* Verifica se tem o Banco MGUNI conectado */
            assign v_log_ligac_integr = no.
            &if '{&ems_dbtype}' <> 'progress' &then
                if connected("shmguni" /*l_shmguni*/ ) then do:
            &else
                if connected("mguni" /*l_mguni*/ ) then do:
            &endif
                assign v_log_ligac_integr = yes.
            end.

            /* Conecta bases EMS 2 */
            if  v_log_connect_ems2_ok = no then do:
                run pi_limpa_retorno.
                run pi_conecta_base_ems2 (Input 1) /* pi_conecta_base_ems2*/.
                if  v_log_connect_ems2_ok = no and return-value <> "OK" /*l_ok*/  then do:
                    run pi_conecta_base_ems2 (Input 2) /* pi_conecta_base_ems2*/.
                    return no-apply.
                end /* if */.
            end /* if */.

            if  not valid-handle(h-boad00463) then do:
                run adbo/boad00463.p persistent set h-boad00463.
                run openqueryStatic in h-boad00463('Main':U).
            end.

            run repositionRecord in h-boad00463 (input rDocumEstEsoc).
            if return-value = "NOK" /*l_nok*/  then return.
            run getKey in h-boad00463 (output v-nro-docto-esoc).

            if valid-handle(h-boad00463) then do:
                run goToKey in h-boad00463 (input v-nro-docto-esoc).
                if return-value = "NOK" /*l_nok*/  then return.
                run deleteRecord in h-boad00463.
            end.

            if  valid-handle(h-boad00463) then do:
                delete procedure h-boad00463.
                assign h-boad00463 = ?.
            end.

            if v_log_ligac_integr = no then do:
                /* Desconecta os bancos externos*/
                if v_log_connect_ems2_ok then
                    run pi_conecta_base_ems2(Input 2) /* pi_conecta_base_ems2*/.
            end.
        end.

        /* retorna a empresa do ems5 depois da integraá∆o*/
        assign v_cod_empres_usuar = v_cod_empresa_aux.

        /* retorna o pais do ems5 depois da integraá∆o*/
        assign v_cod_pais_empres_usuar = v_cod_pais_empres_usuar_ant.
    end.
END PROCEDURE. /* pi_elimina_docum_est_esoc_impl_antecip */
/*****************************************************************************
** Procedure Interna.....: pi_desabilita_campos_antecip_esocial_add
** Descricao.............: pi_desabilita_campos_antecip_esocial_add
** Criado por............: fut41675_2
** Criado em.............: 20/02/2014 10:29:48
** Alterado por..........: fut41675_2
** Alterado em...........: 28/02/2014 09:34:35
*****************************************************************************/
PROCEDURE pi_desabilita_campos_antecip_esocial_add:

    if avail antecip_pef_pend then do:
        run pi_verifica_relacoes_antecip_pef_pend /* pi_verifica_relacoes_antecip_pef_pend*/.
    end.
END PROCEDURE. /* pi_desabilita_campos_antecip_esocial_add */
/*****************************************************************************
** Procedure Interna.....: pi_verifica_integracao_legado
** Descricao.............: pi_verifica_integracao_legado
** Criado por............: fut41675_2
** Criado em.............: 12/03/2014 15:33:55
** Alterado por..........: fut41675_2
** Alterado em...........: 13/03/2014 10:25:34
*****************************************************************************/
PROCEDURE pi_verifica_integracao_legado:

    /************************ Parameter Definition Begin ************************/

    def output param p_log_legal_sem_integr
        as logical
        format "Sim/N∆o"
        no-undo.


    /************************* Parameter Definition End *************************/

    assign p_log_legal_sem_integr = yes.

    /* Verifica a vers∆o do Banco */
    &if '{&emsfin_version}' > '5.06' &then
        assign p_log_legal_sem_integr = no.
    &else
        /* Verifica se tem o programa cd0101 no ambiente */
        if search('rep/re1001u.r') <> ? or search('rep/re1001u.w') <> ? then do:
            assign p_log_legal_sem_integr = no.
        end.
        else do:
            /* Verifica se tem o Banco MGUNI conectado */
            &if '{&ems_dbtype}' <> 'progress' &then
                if connected("shmguni" /*l_shmguni*/ ) then do:
            &else
                if connected("mguni" /*l_mguni*/ ) then do:
            &endif
                assign p_log_legal_sem_integr = no.
            end.
            else do:
                /* Verifica se tem o Banco Externo conectado */
                find first bco_ext no-lock
                    where bco_ext.cod_empresa = v_cod_empres_usuar
                      and bco_ext.cod_bco_ext = 'ems2uni' no-error.
                if not avail bco_ext then do:
                    for each bco_ext no-lock
                        where bco_ext.cod_empresa = v_cod_empres_usuar
                          and bco_ext.num_livre_1 = 1 /* * 1 = flag banco unificado **/:
                        if bco_ext.cod_livre_1 <> "" /* * cod_livre_1 = campo Conjunto Alias da tela **/ then do:
                            if lookup('mguni', bco_ext.cod_livre_1, ',') <> 0 then do:
                                assign p_log_legal_sem_integr = no.
                            end.
                            else do:
                                assign p_log_legal_sem_integr = yes.
                            end.
                        end.
                        else do:
                            assign p_log_legal_sem_integr = no.
                        end.
                    end.
                end.
                else do:
                    assign p_log_legal_sem_integr = no.
                end.
            end.
        end.
    &endif.

END PROCEDURE. /* pi_verifica_integracao_legado */
/*****************************************************************************
** Procedure Interna.....: pi_ix_p30_add_antecip_pef_gera_apf
** Descricao.............: pi_ix_p30_add_antecip_pef_gera_apf
** Criado por............: fut12143
** Criado em.............: 16/08/2016 15:03:02
** Alterado por..........: carinah
** Alterado em...........: 22/02/2018 09:40:10
*****************************************************************************/
PROCEDURE pi_ix_p30_add_antecip_pef_gera_apf:

    if (v_log_mod_apf = no or v_cod_mod = "" /*l_*/ ) then
        return "OK" /*l_ok*/ .

    run pi_verifica_param_aprov_apf (input  v_cod_empres_usuar,
                                     input  antecip_pef_pend.cod_espec_docto,
                                     input  no,
                                     output v_log_param_apb_apf,
                                     output v_ind_param_aprov_docto,
                                     output v_log_aprov_impl_apf,
                                     output v_log_aprov_pagto_apf).
    if v_log_param_apb_apf = no then
        return "OK" /*l_ok*/ .

    find first portador no-lock
    where portador.cod_portador = antecip_pef_pend.cod_portador no-error.
    if avail portador then do:
        if (v_log_aprov_impl_apf and portador.ind_tip_portad = "Caixa" /*l_caixa*/ ) then do:
            if v_log_erro_apf then
                return "NOK" /*l_nok*/ .

            if valid-handle(v_hdl_api_centraliz_apb_apf) then do:
                run pi_valida_informacoes_apf in v_hdl_api_centraliz_apb_apf (Input recid(antecip_pef_pend)) /*pi_valida_informacoes_apf*/.
                if return-value <> "OK" /*l_ok*/  then
                    return "NOK" /*l_nok*/ .
            end /* if */.
        end.
    end.

    run pi_gerar_liberacao_antecip_pef_add.
    if return-value <> "OK" /*l_ok*/  then
        return "NOK" /*l_nok*/ .

    return "OK" /*l_ok*/ .

END PROCEDURE. /* pi_ix_p30_add_antecip_pef_gera_apf */
/*****************************************************************************
** Procedure Interna.....: pi_gerar_liberacao_antecip_pef_add
** Descricao.............: pi_gerar_liberacao_antecip_pef_add
** Criado por............: fut12143
** Criado em.............: 05/08/2016 08:17:04
** Alterado por..........: fut12143
** Alterado em...........: 16/08/2016 18:20:25
*****************************************************************************/
PROCEDURE pi_gerar_liberacao_antecip_pef_add:

    if  v_ind_param_aprov_docto = "Por EspÇcie" /*l_por_espÇcie*/ 
    and (v_log_aprov_impl_apf = no and v_log_aprov_pagto_apf = no) 
    and valid-handle(v_hdl_api_centraliz_apb_apf) then do:

        run pi_gerar_liberacao_antecip_pef in v_hdl_api_centraliz_apb_apf (Input recid(antecip_pef_pend),
                                            Input v_ind_modo_pagto,
                                            Input v_ind_param_aprov_docto) /*pi_gerar_liberacao_antecip_pef*/.
        if return-value = "OK" /*l_ok*/  then
           return "OK" /*l_ok*/ .

        case GetEntryField(1, v_cod_return, ","):
            when "22298" then /* Situaá∆o AN/PEF Inv†lida */
               return "OK" /*l_ok*/ .
            when "1348" then /* Pagamento do Fornecedor Bloqueado */
               return "OK" /*l_ok*/ .
            when "1053" then
               /* ParÉmetro para Empresa do Usu†rio no APB Inexistente ! */
               run pi_messages (input "show",
                                input 1053,
                                input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_1053*/.
            when "1199" then
               /* Indicador Econìmico n∆o habilitado na Data Transaá∆o &1 ! */
               run pi_messages (input "show",
                                input 1199,
                                input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_1199*/.
            when "782" then
               /* Finalidade econìmica n∆o relacionada para o Indic Econìmico ! */
               run pi_messages (input "show",
                                input 782,
                                input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_782*/.
            when "1389" then
               /* Finalidade Econìmica n∆o armazena valores no M¢dulo ! */
               run pi_messages (input "show",
                                input 1389,
                                input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                   GetEntryField(2, v_cod_return, ","))) /*msg_1389*/.
            when "338" then
               /* Finalidade n∆o liberada para a Unidade Organizacional ! */
               run pi_messages (input "show",
                                input 338,
                                input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9")) /*msg_338*/.
            when "358" then
               /* Cotaá∆o entre Indicadores Econìmicos n∆o encontrada ! */
               run pi_messages (input "show",
                                input 358,
                                input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                   GetEntryField(2,v_cod_return, ","), GetEntryField(3, v_cod_return, ","), GetEntryField(4, v_cod_return, ","), "Real" /*l_real*/)) /*msg_358*/.
            when "1200" then
               /* ParÉmetros de convers∆o da composiá∆o inexistentes ! */
               run pi_messages (input "show",
                                input 1200,
                                input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                   GetEntryField(2, v_cod_return, ","), GetEntryField(3, v_cod_return, ","), GetEntryField(4, v_cod_return, ","), GetEntryField(5, v_cod_return, ","), GetEntryField(6, v_cod_return, ","), GetEntryField(7, v_cod_return, ","), "Finalidade" /*l_finalidade*/ , "In°cio Validade" /*l_inicio_validade*/ , "Fim Validade" /*l_fim_validade*/)) /*msg_1200*/.
        end /* case case_block */.

        return "NOK" /*l_nok*/ .
    end.

    return "OK" /*l_ok*/ .

END PROCEDURE. /* pi_gerar_liberacao_antecip_pef_add */
/*****************************************************************************
** Procedure Interna.....: pi_verifica_param_aprov_apf
** Descricao.............: pi_verifica_param_aprov_apf
** Criado por............: fut12143
** Criado em.............: 09/06/2016 12:54:36
** Alterado por..........: fut12143
** Alterado em...........: 29/08/2016 10:03:38
*****************************************************************************/
PROCEDURE pi_verifica_param_aprov_apf:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_empresa
        as character
        format "x(3)"
        no-undo.
    def Input param p_cod_espec_docto
        as character
        format "x(3)"
        no-undo.
    def Input param p_log_docto_pef
        as logical
        format "Sim/N∆o"
        no-undo.
    def output param p_log_param_apb_apf
        as logical
        format "Sim/N∆o"
        no-undo.
    def output param p_ind_param_aprov_docto
        as character
        format "X(12)"
        no-undo.
    def output param p_log_aprov_impl_apf
        as logical
        format "Sim/N∆o"
        no-undo.
    def output param p_log_aprov_pagto_apf
        as logical
        format "Sim/N∆o"
        no-undo.


    /************************* Parameter Definition End *************************/

    assign p_log_param_apb_apf     = no
           p_ind_param_aprov_docto = "Geral" /*l_geral*/ 
           p_log_aprov_impl_apf    = no
           p_log_aprov_pagto_apf   = no.

    find last param_apb_apf where 
              param_apb_apf.cod_empresa = p_cod_empresa no-lock no-error.
    if not avail param_apb_apf then
       return "OK" /*l_ok*/ .

    assign p_log_param_apb_apf     = yes
           p_ind_param_aprov_docto = "Geral" /*l_geral*/ 
           p_log_aprov_impl_apf    = param_apb_apf.log_aprov_impl_apf
           p_log_aprov_pagto_apf   = param_apb_apf.log_aprov_pagto_apf.

    &IF DEFINED(BF_FIN_PARAM_APROV_DOCTO) &THEN

        assign p_ind_param_aprov_docto = param_apb_apf.ind_param_aprov_docto.

        if param_apb_apf.ind_param_aprov_docto <> "Por EspÇcie" /*l_por_especie*/  then 
           return "OK" /*l_ok*/ .

        if p_log_docto_pef then do:
           assign p_log_aprov_impl_apf  = param_apb_apf.log_aprov_impl_apf_pef
                  p_log_aprov_pagto_apf = param_apb_apf.log_aprov_impl_apf_pef.
           return "OK" /*l_ok*/ .              
        end.

        assign p_log_aprov_impl_apf  = no
               p_log_aprov_pagto_apf = no.

        if p_cod_espec_docto = "" then
           return "OK" /*l_ok*/ .

        find espec_docto_financ_apf where
             espec_docto_financ_apf.cod_espec_docto = p_cod_espec_docto and
             espec_docto_financ_apf.cod_empresa     = p_cod_empresa no-lock no-error.
        if not avail espec_docto_financ_apf then
           return "OK" /*l_ok*/ .

        assign p_log_aprov_impl_apf  = espec_docto_financ_apf.log_aprov_impl_apf 
               p_log_aprov_pagto_apf = espec_docto_financ_apf.log_aprov_pagto_apf.

        if can-find(first espec_docto where 
                          espec_docto.cod_espec_docto     = espec_docto_financ_apf.cod_espec_docto and
                          espec_docto.ind_tip_espec_docto = "Antecipaá∆o" /*l_antecipacao*/ ) then
           assign p_log_aprov_pagto_apf = p_log_aprov_impl_apf.

    &ENDIF

    return "OK" /*l_ok*/ .

END PROCEDURE. /* pi_verifica_param_aprov_apf */
/*/*****************************************************************************
** Procedure Interna.....: pi_delete_esocial
** Descricao.............: pi_delete_esocial
** Criado por............: fut41675_2
** Criado em.............: 10/03/2014 16:26:03
** Alterado por..........: fut41675_2
** Alterado em...........: 10/03/2014 16:26:59
*****************************************************************************/
PROCEDURE pi_delete_esocial:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cdd_num_docto_esoc
        as Decimal
        format ">>>,>>>,>>>,>>>,>>9"
        decimals 0
        no-undo.


    /************************* Parameter Definition End *************************/

    find first docto_estoq_esoc where docto_estoq_esoc.cdd_num_docto_esoc = p_cdd_num_docto_esoc exclusive-lock no-error.
    if avail docto_estoq_esoc then do:

       for each item_docto_estoq_esoc exclusive-lock
          where item_docto_estoq_esoc.cdd_num_docto_esoc = docto_estoq_esoc.cdd_num_docto_esoc:

          delete item_docto_estoq_esoc.
       end.

       delete docto_estoq_esoc.
    end.
END PROCEDURE. /* pi_delete_esocial */*/
/*****************************************************************************
** Procedure Interna.....: pi_vld_praz_impl
** Descricao.............: pi_vld_praz_impl
** Criado por............: jeffersonsil
** Criado em.............: 03/02/2017 13:22:02
** Alterado por..........: jeffersonsil
** Alterado em...........: 03/05/2017 16:49:32
*****************************************************************************/
PROCEDURE pi_vld_praz_impl:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_estab
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def Input param p_dat_vencto
        as date
        format "99/99/9999"
        no-undo.
    def Input param p_log_valid_antecip_pef
        as logical
        format "Sim/N∆o"
        no-undo.
    def Input param p_log_valid_tela
        as logical
        format "Sim/N∆o"
        no-undo.
    def output param p_num_erro
        as integer
        format ">>>>,>>9"
        no-undo.
    def output param p_cod_erro_param
        as character
        format "x(50)"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************** Buffer Definition Begin *************************/

    &if "{&emsuni_version}" >= "5.00" &then
    def buffer b_calend_glob_praz_impl
        for calend_glob.
    &endif
    &if "{&emsuni_version}" >= "5.00" &then
    def buffer b_dia_calend_glob_praz_impl
        for dia_calend_glob.
    &endif
    &if "{&emsuni_version}" >= "1.00" &then
    def buffer b_estabelecimento_praz_impl
        for estabelecimento.
    &endif
    &if "{&emsfin_version}" >= "5.01" &then
    def buffer b_param_estab_apb_praz_impl
        for param_estab_apb.
    &endif


    /*************************** Buffer Definition End **************************/

    /************************* Variable Definition Begin ************************/

    def var v_cod_return
        as character
        format "x(40)":U
        no-undo.
    def var v_dat_limite
        as date
        format "99/99/9999":U
        no-undo.
    def var v_dat_return
        as date
        format "99/99/9999":U
        no-undo.


    /************************** Variable Definition End *************************/

    &IF DEFINED(BF_FIN_PRAZ_IMPL) &THEN
    assign p_num_erro = 0
           p_cod_erro_param = "".
    find first b_estabelecimento_praz_impl
         where b_estabelecimento_praz_impl.cod_estab = p_cod_estab no-lock no-error.
    if not avail b_estabelecimento_praz_impl then do:
        assign p_num_erro = 10465
               p_cod_erro_param = p_cod_estab.
        if p_log_valid_tela then do:
            /* Estabelecimento &1 Inexistente ! */
            run pi_messages (input "show",
                             input 10465,
                             input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                               p_cod_estab)) /*msg_10465*/.
        end.
        return "NOK" /*l_nok*/ .
    end.

    find last b_param_estab_apb_praz_impl
        where b_param_estab_apb_praz_impl.cod_estab = b_estabelecimento_praz_impl.cod_estab no-lock no-error.
    if not avail b_param_estab_apb_praz_impl then do:
        assign p_num_erro = 2075
               p_cod_erro_param = p_cod_estab.
        if p_log_valid_tela then do:
            /* ParÉmetros Estabelecimento APB n∆o encontrados ! */
            run pi_messages (input "show",
                             input 2075,
                             input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                               p_cod_estab)) /*msg_2075*/.
        end.
        return "NOK" /*l_nok*/ .
    end.

    /* verifica se parametro est† marcado */
    if b_param_estab_apb_praz_impl.log_praz_impl then do:

        /* se est† validando uma an ou pef, mas parametro est† desmarcado, retorna ok e n∆o valida nada. */
        if p_log_valid_antecip_pef and not b_param_estab_apb_praz_impl.log_praz_antecip_pef then
            return "OK" /*l_ok*/ .

        /* Agora mais as horas informadas, se nao for dia util, acha o proximo dia util*/
        assign v_dat_limite =  date(Add-interval(Now, b_param_estab_apb_praz_impl.num_hora_praz_impl, 'hours':U)).
        run pi_retornar_dia_util (Input p_cod_estab,
                                  Input "Respons†vel Financeiro" /*l_financeiro*/,
                                  Input 0,
                                  Input v_dat_limite,
                                  output v_dat_return,
                                  output v_cod_return) /*pi_retornar_dia_util*/.
        if v_cod_return <> "OK" /*l_ok*/  then do:
            assign p_num_erro = int(entry(1, v_cod_return)) no-error.
            assign p_cod_erro_param = If index(v_cod_return, ",") > 0 Then substring(v_cod_return, index(v_cod_return, ",") + 1)
                                                                      Else "".

            return "NOK" /*l_nok*/ .
        end.
        If p_dat_vencto < v_dat_return Then do:
            assign p_num_erro = 22454
                   p_cod_erro_param = string(v_dat_return - 1).
            if p_log_valid_tela then do:
                /* Data de vencimento deve ser maior que &1 ! */
                run pi_messages (input "show",
                                 input 22454,
                                 input substitute ("&1~~&2~~&3~~&4~~&5~~&6~~&7~~&8~~&9",
                                                   v_dat_return - 1)) /*msg_22454*/.
            end.
            return "NOK" /*l_nok*/ .
        end.
    end.
    &ENDIF

    return "OK" /*l_ok*/ .
END PROCEDURE. /* pi_vld_praz_impl */
/*****************************************************************************
** Procedure Interna.....: pi_retornar_dia_util
** Descricao.............: pi_retornar_dia_util
** Criado por............: rafael
** Criado em.............: 09/12/1996 11:48:46
** Alterado por..........: fut1279
** Alterado em...........: 01/09/2006 08:32:55
*****************************************************************************/
PROCEDURE pi_retornar_dia_util:

    /************************ Parameter Definition Begin ************************/

    def Input param p_cod_estab
    &IF "{&emsfin_version}" >= "" AND "{&emsfin_version}" < "5.07A" &THEN
        as character
        format "x(3)"
    &ENDIF
    &IF "{&emsfin_version}" >= "5.07A" AND "{&emsfin_version}" < "9.99" &THEN
        as Character
        format "x(5)"
    &ENDIF
        no-undo.
    def Input param p_ind_tip_calend
        as character
        format "X(08)"
        no-undo.
    def Input param p_num_dias
        as integer
        format ">>>>,>>9"
        no-undo.
    def Input param p_dat_base
        as date
        format "99/99/9999"
        no-undo.
    def output param p_dat_return
        as date
        format "99/99/9999"
        no-undo.
    def output param p_cod_return
        as character
        format "x(40)"
        no-undo.


    /************************* Parameter Definition End *************************/

    /************************* Variable Definition Begin ************************/

    def var v_log_fer
        as logical
        format "Sim/N∆o"
        initial no
        no-undo.
    def var v_num_seq
        as integer
        format ">>>,>>9":U
        label "SeqÅància"
        column-label "Seq"
        no-undo.


    /************************** Variable Definition End *************************/

    assign p_cod_return = "OK" /*l_ok*/ .

    find estabelecimento
        where estabelecimento.cod_estab = p_cod_estab no-lock no-error.
    /* case_block: */
    case p_ind_tip_calend:
        when "Respons†vel Financeiro" /*l_financeiro*/ then
            find calend_glob
                where calend_glob.cod_calend = estabelecimento.cod_calend_financ
                no-lock no-error.
        when "Materiais" /*l_materiais*/ then
            find calend_glob
                where calend_glob.cod_calend = estabelecimento.cod_calend_mater
                no-lock no-error.
        when "R.H." /*l_rh*/ then
            find calend_glob
                where calend_glob.cod_calend = estabelecimento.cod_calend_rh
                no-lock no-error.
        when "Manufatura" /*l_manufatura*/ then
            find calend_glob
                where calend_glob.cod_calend = estabelecimento.cod_calend_manuf
                no-lock no-error.
        when "Distribuiá∆o" /*l_distribuicao*/ then
            find calend_glob
                where calend_glob.cod_calend = estabelecimento.cod_calend_distrib
                no-lock no-error.
    end /* case case_block */.
    if  not avail calend_glob
    then do:
        assign p_cod_return = "3896".
        return.
    end /* if */.

    assign p_dat_return = p_dat_base.

    if  p_num_dias = 0
    then do:
        acha_dia_util:
        repeat:
            find dia_calend_glob
                where dia_calend_glob.cod_calend = calend_glob.cod_calend
                and   dia_calend_glob.dat_calend = p_dat_return
                no-lock no-error.
            if  not avail dia_calend_glob
            then do:
                assign p_cod_return = "3897" + "," + string(p_dat_return) + "," + calend_glob.cod_calend.
                return.
            end /* if */.

            if  dia_calend_glob.log_dia_util = yes then do:
                assign v_log_fer = no.
                for each fer_nac no-lock
                    where fer_nac.cod_pais     = v_cod_pais_fornec_clien
                      and fer_nac.dat_fer_nac  = p_dat_return:
                      assign v_log_fer = yes.
                end.
                if not v_log_fer then
                    leave acha_dia_util.
                else assign p_dat_return = p_dat_return + 1.
            end.

            else do:
                assign p_dat_return = p_dat_return + 1.
            end /* else */.
        end /* repeat acha_dia_util */.
    end /* if */.
    else do:
        dias_block:
        do v_num_seq = 1 to p_num_dias:
            assign p_dat_return = p_dat_return + 1.
            acha_dia_util:
            repeat:
                find dia_calend_glob
                    where dia_calend_glob.cod_calend = calend_glob.cod_calend
                    and   dia_calend_glob.dat_calend = p_dat_return
                    no-lock no-error.
                if  not avail dia_calend_glob
                then do:
                    assign p_cod_return = "3897" + "," + string(p_dat_return) + "," + calend_glob.cod_calend.
                    return.
                end /* if */.

                if  dia_calend_glob.log_dia_util = yes then do:
                    assign v_log_fer = no.
                    for each fer_nac no-lock
                        where fer_nac.cod_pais     = v_cod_pais_fornec_clien
                          and fer_nac.dat_fer_nac  = p_dat_return:
                          assign v_log_fer = yes.
                    end.
                    if not v_log_fer then
                        leave acha_dia_util.
                    else assign p_dat_return = p_dat_return + 1.
                end.

                else do:
                    assign p_dat_return = p_dat_return + 1.
                end /* else */.
            end /* repeat acha_dia_util */.
        end /* do dias_block */.
    end /* else */.

END PROCEDURE. /* pi_retornar_dia_util */


/************************** Internal Procedure End **************************/

/************************* External Procedure Begin *************************/



/************************** External Procedure End **************************/
&endif

/*************************************  *************************************/
/*****************************************************************************
**  Procedure Interna: pi_messages
**  Descricao........: Mostra Mensagem com Ajuda
*****************************************************************************/
PROCEDURE pi_messages:

    def input param c_action    as char    no-undo.
    def input param i_msg       as integer no-undo.
    def input param c_param     as char    no-undo.

    def var c_prg_msg           as char    no-undo.

    assign c_prg_msg = "messages/":U
                     + string(trunc(i_msg / 1000,0),"99":U)
                     + "/msg":U
                     + string(i_msg, "99999":U).

    if search(c_prg_msg + ".r":U) = ? and search(c_prg_msg + ".p":U) = ? then do:
        message getStrTrans("Mensagem nr. ", "APB") i_msg "!!!":U skip
                getStrTrans("Programa Mensagem", "APB") c_prg_msg getStrTrans("n∆o encontrado.", "APB")
                view-as alert-box error.
        return error.
    end.

    run value(c_prg_msg + ".p":U) (input c_action, input c_param).
    return return-value.
END PROCEDURE.  /* pi_messages */
/***********************  End of add_antecip_pef_pend ***********************/
